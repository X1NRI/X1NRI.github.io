<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>8.Portable Executable Format 可移植可执行格式 | X1NRI&#39;s trash</title>
  <meta name="author" content="X1NRI">
  
  <meta name="description" content="介绍Portable Executable (PE) 是 Windows 系统上可执行文件的文件格式。PE 文件扩展名的几个示例包括 .exe、.dll、.sys 和 .scr。本模块讨论 PE 文件的结构，这对于构建或逆向工程恶意软件非常重要。
请注意，本模块及未来的模块将经常互换使用“可执行文件”（例如 EXE、DLL）和“镜像”（Images）来指代这些文件。
PE结构下图展示了一个简化的 Portable Executable (PE) 结构。图中显示的每个头部都被定义为一个数据结构，该结构包含关于 PE 文件的信息。本模块将详细解释每个数据结构。

DOS 头 (IMAGE_DOS_HEADER)）PE 文件的第一个头部总是以两个字节开头，分别是 0x4D 和 0x5A，通常称为 **MZ**。这两个字节代表 DOS 头部的签名，用于确认正在解析或检查的文件是一个有效的 PE 文件。
DOS 头部 是一个数据结构，其定义如下：
typedef struct _IMAGE_DOS_HEADER &amp;#123;      // DOS .EXE header
    WORD   e_magic;                     // Magic number
    WORD   e_cblp;                      // Bytes on last page of file
    WORD   e_cp;                        // Pages in file
    WORD   e_crlc;                      // Relocations
    WORD   e_cparhdr;                   // Size of header in paragraphs
    WORD   e_minalloc;                  // Minimum extra paragraphs needed
    WORD   e_maxalloc;                  // Maximum extra paragraphs needed
    WORD   e_ss;                        // Initial (relative) SS value
    WORD   e_sp;                        // Initial SP value
    WORD   e_csum;                      // Checksum
    WORD   e_ip;                        // Initial IP value
    WORD   e_cs;                        // Initial (relative) CS value
    WORD   e_lfarlc;                    // File address of relocation table
    WORD   e_ovno;                      // Overlay number
    WORD   e_res[4];                    // Reserved words
    WORD   e_oemid;                     // OEM identifier (for e_oeminfo)
    WORD   e_oeminfo;                   // OEM information; e_oemid specific
    WORD   e_res2[10];                  // Reserved words
    LONG   e_lfanew;                    // Offset to the NT header
  &amp;#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="8.Portable Executable Format 可移植可执行格式"/>
  <meta property="og:site_name" content="X1NRI&#39;s trash"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="X1NRI&#39;s trash" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">X1NRI&#39;s trash</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/links" title="Subscribe me.">
			  <i class="fa fa-chain"></i>Links
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> 8.Portable Executable Format 可移植可执行格式</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><strong>Portable Executable (PE)</strong> 是 Windows 系统上可执行文件的文件格式。PE 文件扩展名的几个示例包括 <code>.exe</code>、<code>.dll</code>、<code>.sys</code> 和 <code>.scr</code>。本模块讨论 PE 文件的结构，这对于构建或逆向工程恶意软件非常重要。</p>
<p>请注意，本模块及未来的模块将经常互换使用“可执行文件”（例如 EXE、DLL）和“镜像”（Images）来指代这些文件。</p>
<h1 id="PE结构"><a href="#PE结构" class="headerlink" title="PE结构"></a>PE结构</h1><p>下图展示了一个简化的 <strong>Portable Executable (PE)</strong> 结构。图中显示的每个头部都被定义为一个数据结构，该结构包含关于 PE 文件的信息。本模块将详细解释每个数据结构。<br><img src="/Rxi134_FILE/4671b85da7b3108123c5f23d8748a504_MD5.jpeg"></p>
<p><img src="/Rxi134_FILE/07427b54f2cd6658fb90b65947539444_MD5.jpeg"></p>
<h2 id="DOS-头-IMAGE-DOS-HEADER-）"><a href="#DOS-头-IMAGE-DOS-HEADER-）" class="headerlink" title="DOS 头 (IMAGE_DOS_HEADER)）"></a>DOS 头 (IMAGE_DOS_HEADER)）</h2><p>PE 文件的第一个头部总是以两个字节开头，分别是 <code>0x4D</code> 和 <code>0x5A</code>，通常称为 **<code>MZ</code>**。这两个字节代表 DOS 头部的签名，用于确认正在解析或检查的文件是一个有效的 PE 文件。<br><img src="/Rxi134_FILE/bdd280e07e2ab3e4ea79f3a64f88be18_MD5.jpeg"></p>
<p><strong>DOS 头部</strong> 是一个数据结构，其定义如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_DOS_HEADER</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// DOS .EXE header</span>
    WORD   e_magic<span class="token punctuation">;</span>                     <span class="token comment">// Magic number</span>
    WORD   e_cblp<span class="token punctuation">;</span>                      <span class="token comment">// Bytes on last page of file</span>
    WORD   e_cp<span class="token punctuation">;</span>                        <span class="token comment">// Pages in file</span>
    WORD   e_crlc<span class="token punctuation">;</span>                      <span class="token comment">// Relocations</span>
    WORD   e_cparhdr<span class="token punctuation">;</span>                   <span class="token comment">// Size of header in paragraphs</span>
    WORD   e_minalloc<span class="token punctuation">;</span>                  <span class="token comment">// Minimum extra paragraphs needed</span>
    WORD   e_maxalloc<span class="token punctuation">;</span>                  <span class="token comment">// Maximum extra paragraphs needed</span>
    WORD   e_ss<span class="token punctuation">;</span>                        <span class="token comment">// Initial (relative) SS value</span>
    WORD   e_sp<span class="token punctuation">;</span>                        <span class="token comment">// Initial SP value</span>
    WORD   e_csum<span class="token punctuation">;</span>                      <span class="token comment">// Checksum</span>
    WORD   e_ip<span class="token punctuation">;</span>                        <span class="token comment">// Initial IP value</span>
    WORD   e_cs<span class="token punctuation">;</span>                        <span class="token comment">// Initial (relative) CS value</span>
    WORD   e_lfarlc<span class="token punctuation">;</span>                    <span class="token comment">// File address of relocation table</span>
    WORD   e_ovno<span class="token punctuation">;</span>                      <span class="token comment">// Overlay number</span>
    WORD   e_res<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    <span class="token comment">// Reserved words</span>
    WORD   e_oemid<span class="token punctuation">;</span>                     <span class="token comment">// OEM identifier (for e_oeminfo)</span>
    WORD   e_oeminfo<span class="token punctuation">;</span>                   <span class="token comment">// OEM information; e_oemid specific</span>
    WORD   e_res2<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                  <span class="token comment">// Reserved words</span>
    LONG   e_lfanew<span class="token punctuation">;</span>                    <span class="token comment">// Offset to the NT header</span>
  <span class="token punctuation">&#125;</span> IMAGE_DOS_HEADER<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_DOS_HEADER<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结构体中最重要的成员是 <strong><code>e_magic</code></strong> 和 **<code>e_lfanew</code>**。</p>
<ul>
<li><strong><code>e_magic</code></strong> 是一个 2 字节的值，固定值为 <code>0x5A4D</code> 或 <strong>MZ</strong>。</li>
<li><strong><code>e_lfanew</code></strong> 是一个 4 字节的值，保存 NT 头部的起始偏移量。注意，**<code>e_lfanew</code>** 总是位于偏移量 <code>0x3C</code> 处。</li>
</ul>
<h2 id="DOS-存根"><a href="#DOS-存根" class="headerlink" title="DOS 存根"></a>DOS 存根</h2><p>在进入 NT 头部结构之前，有一个 <strong>DOS stub</strong>，这是一个错误消息，打印内容为 “<code>This program cannot be run in DOS mode</code>“（该程序无法在 DOS 模式下运行），当程序在 DOS 模式或 “磁盘操作模式” 下加载时会显示此消息。<br><img src="/Rxi134_FILE/9ee4b3e681f049fd506307b7241a8f30_MD5.jpeg"></p>
<p>值得注意的是，这个错误消息可以由程序员在编译时更改。虽然这不是 PE 头部的一部分，但了解它是有益的。</p>
<h2 id="NT-头-IMAGE-NT-HEADERS"><a href="#NT-头-IMAGE-NT-HEADERS" class="headerlink" title="NT 头 (IMAGE_NT_HEADERS)"></a>NT 头 (IMAGE_NT_HEADERS)</h2><p>NT 头部非常重要，因为它包含了另外两个镜像头部：<strong>FileHeader</strong> 和 <strong>OptionalHeader</strong>，这两个头部包含了关于 PE 文件的大量信息。</p>
<p>与 DOS 头部类似，NT 头部也包含一个用于验证的签名成员。通常，签名元素等于字符串 “PE”，其由 <code>0x50</code> 和 <code>0x45</code> 字节表示。但由于签名是 <code>DWORD</code> 数据类型，签名会表示为 <code>0x50450000</code>，虽然被填充了两个空字节，仍然表示为 “PE”。<br><img src="/Rxi134_FILE/944b333c6cedabdb55da4a43db439843_MD5.jpeg"></p>
<p>NT 头部可以通过 DOS 头部中的成员 <strong><code>e_lfanew</code></strong> 来访问，如图，0xf0 正是 NT头 的偏移<br><img src="/Rxi134_FILE/33058c354ba66ad27a5820d995f0e148_MD5.jpeg"></p>
<p>NT 头部的结构会根据机器的架构而有所不同。</p>
<ul>
<li>32 位版本：<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_NT_HEADERS</span> <span class="token punctuation">&#123;</span>
  DWORD                   Signature<span class="token punctuation">;</span>
  IMAGE_FILE_HEADER       FileHeader<span class="token punctuation">;</span>
  IMAGE_OPTIONAL_HEADER32 OptionalHeader<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> IMAGE_NT_HEADERS32<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_NT_HEADERS32<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>64 位版本：<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_NT_HEADERS64</span> <span class="token punctuation">&#123;</span>
    DWORD                   Signature<span class="token punctuation">;</span>
    IMAGE_FILE_HEADER       FileHeader<span class="token punctuation">;</span>
    IMAGE_OPTIONAL_HEADER64 OptionalHeader<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> IMAGE_NT_HEADERS64<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_NT_HEADERS64<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<p>唯一的区别在于数据结构 <strong><code>OptionalHeader</code></strong> ，是 <strong><code>IMAGE_OPTIONAL_HEADER32</code></strong> 或 **<code>IMAGE_OPTIONAL_HEADER64</code>**，分别用于 32 位和 64 位架构。</p>
<h3 id="文件头-IMAGE-FILE-HEADER"><a href="#文件头-IMAGE-FILE-HEADER" class="headerlink" title="文件头 (IMAGE_FILE_HEADER)"></a>文件头 (IMAGE_FILE_HEADER)</h3><p>接下来是可以从之前的 NT 头部数据结构访问的头部：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_FILE_HEADER</span> <span class="token punctuation">&#123;</span>
  WORD  Machine<span class="token punctuation">;</span>
  WORD  NumberOfSections<span class="token punctuation">;</span>
  DWORD TimeDateStamp<span class="token punctuation">;</span>
  DWORD PointerToSymbolTable<span class="token punctuation">;</span>
  DWORD NumberOfSymbols<span class="token punctuation">;</span>
  WORD  SizeOfOptionalHeader<span class="token punctuation">;</span>
  WORD  Characteristics<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> IMAGE_FILE_HEADER<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_FILE_HEADER<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最重要的结构体成员是：</p>
<ul>
<li><strong><code>NumberOfSections</code></strong> - PE 文件中的段数量（稍后讨论）。</li>
<li><strong><code>Characteristics</code></strong> - 指定可执行文件某些属性的标志，比如它是否是动态链接库（DLL）或控制台应用程序。</li>
<li><strong><code>SizeOfOptionalHeader</code></strong> - 后续可选头部的大小。<br>关于文件头部的更多信息可以在官方文档页面中找到。<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_file_header">official documentation page</a>.</li>
</ul>
<h3 id="可选头部-IMAGE-OPTIONAL-HEADER"><a href="#可选头部-IMAGE-OPTIONAL-HEADER" class="headerlink" title="可选头部 (IMAGE_OPTIONAL_HEADER)"></a>可选头部 (IMAGE_OPTIONAL_HEADER)</h3><p>可选头部非常重要，尽管它被称为 “可选” ，但对 PE 文件的执行至关重要。之所以称它为“可选”，是因为某些文件类型没有这个头部。</p>
<p>可选头部有两个版本，分别用于 32 位和 64 位系统。两个版本的数据结构几乎相同，主要区别在于某些成员的大小。**<code>ULONGLONG</code>** 用于 64 位版本，**<code>DWORD</code>** 用于 32 位版本。此外，32 位版本中有一些在 64 位版本中不存在的成员。</p>
<ul>
<li><p>32 位版本</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_OPTIONAL_HEADER</span> <span class="token punctuation">&#123;</span>
  WORD                 Magic<span class="token punctuation">;</span>
  BYTE                 MajorLinkerVersion<span class="token punctuation">;</span>
  BYTE                 MinorLinkerVersion<span class="token punctuation">;</span>
  DWORD                SizeOfCode<span class="token punctuation">;</span>
  DWORD                SizeOfInitializedData<span class="token punctuation">;</span>
  DWORD                SizeOfUninitializedData<span class="token punctuation">;</span>
  DWORD                AddressOfEntryPoint<span class="token punctuation">;</span>
  DWORD                BaseOfCode<span class="token punctuation">;</span>
  DWORD                BaseOfData<span class="token punctuation">;</span>
  DWORD                ImageBase<span class="token punctuation">;</span>
  DWORD                SectionAlignment<span class="token punctuation">;</span>
  DWORD                FileAlignment<span class="token punctuation">;</span>
  WORD                 MajorOperatingSystemVersion<span class="token punctuation">;</span>
  WORD                 MinorOperatingSystemVersion<span class="token punctuation">;</span>
  WORD                 MajorImageVersion<span class="token punctuation">;</span>
  WORD                 MinorImageVersion<span class="token punctuation">;</span>
  WORD                 MajorSubsystemVersion<span class="token punctuation">;</span>
  WORD                 MinorSubsystemVersion<span class="token punctuation">;</span>
  DWORD                Win32VersionValue<span class="token punctuation">;</span>
  DWORD                SizeOfImage<span class="token punctuation">;</span>
  DWORD                SizeOfHeaders<span class="token punctuation">;</span>
  DWORD                CheckSum<span class="token punctuation">;</span>
  WORD                 Subsystem<span class="token punctuation">;</span>
  WORD                 DllCharacteristics<span class="token punctuation">;</span>
  DWORD                SizeOfStackReserve<span class="token punctuation">;</span>
  DWORD                SizeOfStackCommit<span class="token punctuation">;</span>
  DWORD                SizeOfHeapReserve<span class="token punctuation">;</span>
  DWORD                SizeOfHeapCommit<span class="token punctuation">;</span>
  DWORD                LoaderFlags<span class="token punctuation">;</span>
  DWORD                NumberOfRvaAndSizes<span class="token punctuation">;</span>
  IMAGE_DATA_DIRECTORY DataDirectory<span class="token punctuation">[</span>IMAGE_NUMBEROF_DIRECTORY_ENTRIES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> IMAGE_OPTIONAL_HEADER32<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_OPTIONAL_HEADER32<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>64位版本</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_OPTIONAL_HEADER64</span> <span class="token punctuation">&#123;</span>
  WORD                 Magic<span class="token punctuation">;</span>
  BYTE                 MajorLinkerVersion<span class="token punctuation">;</span>
  BYTE                 MinorLinkerVersion<span class="token punctuation">;</span>
  DWORD                SizeOfCode<span class="token punctuation">;</span>
  DWORD                SizeOfInitializedData<span class="token punctuation">;</span>
  DWORD                SizeOfUninitializedData<span class="token punctuation">;</span>
  DWORD                AddressOfEntryPoint<span class="token punctuation">;</span>
  DWORD                BaseOfCode<span class="token punctuation">;</span>
  ULONGLONG            ImageBase<span class="token punctuation">;</span>
  DWORD                SectionAlignment<span class="token punctuation">;</span>
  DWORD                FileAlignment<span class="token punctuation">;</span>
  WORD                 MajorOperatingSystemVersion<span class="token punctuation">;</span>
  WORD                 MinorOperatingSystemVersion<span class="token punctuation">;</span>
  WORD                 MajorImageVersion<span class="token punctuation">;</span>
  WORD                 MinorImageVersion<span class="token punctuation">;</span>
  WORD                 MajorSubsystemVersion<span class="token punctuation">;</span>
  WORD                 MinorSubsystemVersion<span class="token punctuation">;</span>
  DWORD                Win32VersionValue<span class="token punctuation">;</span>
  DWORD                SizeOfImage<span class="token punctuation">;</span>
  DWORD                SizeOfHeaders<span class="token punctuation">;</span>
  DWORD                CheckSum<span class="token punctuation">;</span>
  WORD                 Subsystem<span class="token punctuation">;</span>
  WORD                 DllCharacteristics<span class="token punctuation">;</span>
  ULONGLONG            SizeOfStackReserve<span class="token punctuation">;</span>
  ULONGLONG            SizeOfStackCommit<span class="token punctuation">;</span>
  ULONGLONG            SizeOfHeapReserve<span class="token punctuation">;</span>
  ULONGLONG            SizeOfHeapCommit<span class="token punctuation">;</span>
  DWORD                LoaderFlags<span class="token punctuation">;</span>
  DWORD                NumberOfRvaAndSizes<span class="token punctuation">;</span>
  IMAGE_DATA_DIRECTORY DataDirectory<span class="token punctuation">[</span>IMAGE_NUMBEROF_DIRECTORY_ENTRIES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> IMAGE_OPTIONAL_HEADER64<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_OPTIONAL_HEADER64<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<p>可选头部包含了大量有用的信息。以下是一些常用的结构体成员：</p>
<ul>
<li><strong><code>Magic</code></strong> - 描述镜像文件的状态（32 位或 64 位镜像）。</li>
<li><strong><code>MajorOperatingSystemVersion</code></strong> - 所需操作系统的主要版本号（例如 11, 10）。</li>
<li><strong><code>MinorOperatingSystemVersion</code></strong> - 所需操作系统的次要版本号（例如 1511, 1507, 1607）。</li>
<li><strong><code>SizeOfCode</code></strong> - 代码段的大小（稍后讨论）。</li>
<li><strong><code>AddressOfEntryPoint</code></strong> - 文件的入口点偏移量（通常为 <code>main</code> 函数的偏移）。</li>
<li><strong><code>BaseOfCode</code></strong> - 代码段起始位置的偏移量。</li>
<li><strong><code>SizeOfImage</code></strong> - 镜像文件的大小，以字节为单位。</li>
<li><strong><code>ImageBase</code></strong> - 指定应用程序在执行时要加载到内存中的首选地址。然而，由于 Windows 的内存保护机制（例如地址空间布局随机化，ASLR），很少见到镜像映射到其首选地址，因为 Windows PE 加载器会将文件映射到不同的地址。Windows PE 加载器进行的这种随机分配会在实现未来技术时导致问题，因为某些被认为是常量的地址发生了变化。之后，Windows PE 加载器会通过 PE 重定位来修复这些地址。</li>
<li><strong><code>DataDirectory</code></strong> - 可选头部中最重要的成员之一。它是一个 <strong><code>IMAGE_DATA_DIRECTORY</code></strong> 的数组，包含 PE 文件中的目录（稍后讨论）。</li>
</ul>
<h4 id="数据目录-Data-Directory"><a href="#数据目录-Data-Directory" class="headerlink" title="数据目录 Data Directory"></a>数据目录 Data Directory</h4><p>可以通过可选头的最后一个成员来访问数据目录（Data Directory）。该成员是一个 <code>IMAGE_DATA_DIRECTORY</code> 数据类型的数组，其数据结构如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_DATA_DIRECTORY</span> <span class="token punctuation">&#123;</span>
    DWORD   VirtualAddress<span class="token punctuation">;</span>  <span class="token comment">// 虚拟地址</span>
    DWORD   Size<span class="token punctuation">;</span>            <span class="token comment">// 大小</span>
<span class="token punctuation">&#125;</span> IMAGE_DATA_DIRECTORY<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_DATA_DIRECTORY<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>数据目录数组的大小由常量 <code>IMAGE_NUMBEROF_DIRECTORY_ENTRIES</code> 决定，其值为 16。数组中的每个元素表示一个特定的数据目录，包含了某个 PE 节（section）或数据表（Data Table）的一些数据（即存储 PE 具体信息的地方）。</p>
<p>可以通过数组的索引来访问特定的数据目录：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_EXPORT</span>          <span class="token expression"><span class="token number">0</span>   </span><span class="token comment">// Export Directory</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_IMPORT</span>          <span class="token expression"><span class="token number">1</span>   </span><span class="token comment">// Import Directory</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_RESOURCE</span>        <span class="token expression"><span class="token number">2</span>   </span><span class="token comment">// Resource Directory</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_EXCEPTION</span>       <span class="token expression"><span class="token number">3</span>   </span><span class="token comment">// Exception Directory</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_SECURITY</span>        <span class="token expression"><span class="token number">4</span>   </span><span class="token comment">// Security Directory</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_BASERELOC</span>       <span class="token expression"><span class="token number">5</span>   </span><span class="token comment">// Base Relocation Table</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_DEBUG</span>           <span class="token expression"><span class="token number">6</span>   </span><span class="token comment">// Debug Directory</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_ARCHITECTURE</span>    <span class="token expression"><span class="token number">7</span>   </span><span class="token comment">// Architecture Specific Data</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_GLOBALPTR</span>       <span class="token expression"><span class="token number">8</span>   </span><span class="token comment">// RVA of GP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_TLS</span>             <span class="token expression"><span class="token number">9</span>   </span><span class="token comment">// TLS Directory</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG</span>    <span class="token expression"><span class="token number">10</span>   </span><span class="token comment">// Load Configuration Directory</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT</span>   <span class="token expression"><span class="token number">11</span>   </span><span class="token comment">// Bound Import Directory in headers</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_IAT</span>            <span class="token expression"><span class="token number">12</span>   </span><span class="token comment">// Import Address Table</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT</span>   <span class="token expression"><span class="token number">13</span>   </span><span class="token comment">// Delay Load Import Descriptors</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR</span> <span class="token expression"><span class="token number">14</span>   </span><span class="token comment">// COM Runtime descriptor</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/Rxi134_FILE/4cf8bf30b17a1e800995163d25868ac0_MD5.jpeg"></p>
<p>下面的两节将简要提到两个重要的数据目录：<strong>导出目录</strong>（Export Directory）和<strong>导入地址表</strong>（Import Address Table）。</p>
<h5 id="导出目录-Export-Directory"><a href="#导出目录-Export-Directory" class="headerlink" title="导出目录 Export Directory"></a>导出目录 Export Directory</h5><p><img src="/Rxi134_FILE/026f1d5122663a7d45c2801a475d563e_MD5.jpeg"><br>PE 文件的导出目录是一个数据结构，包含关于从可执行文件中导出函数和变量的信息。它包含导出函数和变量的地址，其他可执行文件可以使用这些地址来访问这些函数和数据。导出目录通常存在于导出函数的 DLL 中（例如从 <strong><code>kernel32.dll</code></strong> 中导出 **<code>CreateFileA</code>**）。</p>
<h5 id="导入地址表-Import-Address-Table"><a href="#导入地址表-Import-Address-Table" class="headerlink" title="导入地址表 Import Address Table"></a>导入地址表 Import Address Table</h5><p><img src="/Rxi134_FILE/9ea33c8f5d1827a9caaab901a53cd8c0_MD5.jpeg"></p>
<p>导入地址表是 PE 文件中的一个数据结构，包含关于从其他可执行文件导入的函数地址的信息。这些地址用于访问其他可执行文件中的函数和数据（例如从 <strong><code>kernel32.dll</code></strong> 中导入 <strong><code>CreateFileA</code></strong> 到 **<code>Application.exe</code>**）。</p>
<h2 id="PE-Sections"><a href="#PE-Sections" class="headerlink" title="PE Sections"></a>PE Sections</h2><p>PE 段包含了用于创建可执行程序的代码和数据。每个 PE 段都有一个唯一的名称，通常包含可执行代码、数据或资源信息。PE 段的数量不是固定的，因为不同的编译器可以根据配置添加、删除或合并段。有些段也可以手动添加，因此这个数量是动态的，<code>IMAGE_FILE_HEADER.NumberOfSections</code> 用于确定段的数量。<br><img src="/Rxi134_FILE/7c3ea14466fc67f80d7394551252c0f7_MD5.jpeg"></p>
<p>以下是最重要的 PE 段，几乎每个 PE 文件中都有这些段：</p>
<ul>
<li><strong><code>.text</code></strong> - 包含可执行代码，即编写的代码。</li>
<li><strong><code>.data</code></strong> - 包含已初始化的数据，即代码中已初始化的变量。</li>
<li><strong><code>.rdata</code></strong> - 包含只读数据。这些是以 <strong><code>.const</code></strong> 为前缀的常量变量。</li>
<li><strong><code>.idata</code></strong> - 包含导入表。这些是与代码中调用的函数相关的信息表。Windows PE 加载器使用这些表来确定需要加载到进程中的 DLL 文件，以及每个 DLL 中使用的函数。</li>
<li><strong><code>.reloc</code></strong> - 包含关于如何修正内存地址的信息，以便程序可以无误地加载到内存中。</li>
<li><strong><code>.rsrc</code></strong> - 用于存储资源，如图标和位图。<br>每个 PE 段都有一个 <strong><code>IMAGE_SECTION_HEADER</code></strong> 数据结构，包含有关该段的有价值信息。这些结构保存在 PE 文件的 NT 头部下，并且彼此堆叠，每个结构代表一个段。</li>
</ul>
<p>回想一下，**<code>IMAGE_SECTION_HEADER</code>** 结构如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_SECTION_HEADER</span> <span class="token punctuation">&#123;</span>
  BYTE  Name<span class="token punctuation">[</span>IMAGE_SIZEOF_SHORT_NAME<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
    DWORD PhysicalAddress<span class="token punctuation">;</span>
    DWORD VirtualSize<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> Misc<span class="token punctuation">;</span>
  DWORD VirtualAddress<span class="token punctuation">;</span>
  DWORD SizeOfRawData<span class="token punctuation">;</span>
  DWORD PointerToRawData<span class="token punctuation">;</span>
  DWORD PointerToRelocations<span class="token punctuation">;</span>
  DWORD PointerToLinenumbers<span class="token punctuation">;</span>
  WORD  NumberOfRelocations<span class="token punctuation">;</span>
  WORD  NumberOfLinenumbers<span class="token punctuation">;</span>
  DWORD Characteristics<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> IMAGE_SECTION_HEADER<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_SECTION_HEADER<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>每个元素都非常有价值和重要：</p>
<ul>
<li><strong><code>Name</code></strong> - 段的名称（例如 <code>.text</code>, <code>.data</code>, <code>.rdata</code>）。</li>
<li><strong><code>PhysicalAddress</code></strong> 或 <strong><code>VirtualSize</code></strong> - 段在内存中的大小。</li>
<li><strong><code>VirtualAddress</code></strong> - 段在内存中起始位置的偏移量。</li>
</ul>
<h1 id="其它参考资料"><a href="#其它参考资料" class="headerlink" title="其它参考资料"></a>其它参考资料</h1><p>如果需要对某些段进行进一步的澄清，强烈推荐阅读 0xRick’s Blog 上的以下博客文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://0xrick.github.io/win-internals/pe2/">PE 概述</a></li>
<li><a target="_blank" rel="noopener" href="https://0xrick.github.io/win-internals/pe3/">DOS 头部、DOS Stub 和 Rich 头部</a></li>
<li><a target="_blank" rel="noopener" href="https://0xrick.github.io/win-internals/pe4/">NT 头部</a></li>
<li><a target="_blank" rel="noopener" href="https://0xrick.github.io/win-internals/pe5/">数据目录、段头部和段</a></li>
<li><a target="_blank" rel="noopener" href="https://0xrick.github.io/win-internals/pe6/">PE 导入（导入目录表，ILT，IAT）</a></li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>第一次接触 PE 头时，理解它可能会比较困难。幸运的是，基本模块中并不需要深入了解 PE 结构。然而，如果想让恶意软件执行更复杂的技术，就需要更深入的理解，因为某些代码需要解析 PE 文件的头和各个节。这部分内容可能会出现在中级和高级模块中。</p>

	  <div class="article-footer-copyright">

    本博客采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议(CC BY-NC-SA 4.0) 发布.</a>
</div>

	</div>

	
	<span id="/2024/10/05/8.Portable%20Executable%20Format%20%E5%8F%AF%E7%A7%BB%E6%A4%8D%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%A0%BC%E5%BC%8F/" class="leancloud-visitors view" data-flag-title="8.Portable Executable Format 可移植可执行格式">
		<em class="post-meta-item-text"> Page View </em> <i class="leancloud-visitors-count"></i>
	</span>
	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2024/10/06/W Easy-Bastion/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/10/05/ATT&CK红队评估实战靶场-3/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
		<section id="comments" class="comments">
			<style>
			.comments{margin:30px;padding:10px;background:rgb(0, 0, 0)}
			@media screen and (max-width:800px){.comments{margin:auto;padding:10px;background:#000}}
			</style>
			<div id="vcomment" class="comment"></div>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script src="https://cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
var valineConfig = {"enable":true,"appId":"QrmzEeS3e4xvmJxO1dSPlkW4-gzGzoHsz","appKey":"ov6uvwKnDQmJxtpeS0wvBIwL","placeholder":"","visitor":true,"avatar":"monsterid","requiredFields":["nick","mail"],"pageView":true}
valineConfig.el='#vcomment';
new Valine(valineConfig);
    // new Valine({
    //     el: '#vcomment',
    //     appId: "",
    //     appKey: "",
    //     placeholder: "",
    //     avatar:"monsterid",
    //     visitor: "true",
    //     requiredFields: "nick,mail".split(','),
    // });
</script>

		</section>
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-10-05 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/逆向工程/">逆向工程<span>6</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/AV规避/">AV规避<span>6</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-article-text">介绍</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#PE%E7%BB%93%E6%9E%84"><span class="toc-article-text">PE结构</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#DOS-%E5%A4%B4-IMAGE-DOS-HEADER-%EF%BC%89"><span class="toc-article-text">DOS 头 (IMAGE_DOS_HEADER)）</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#DOS-%E5%AD%98%E6%A0%B9"><span class="toc-article-text">DOS 存根</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#NT-%E5%A4%B4-IMAGE-NT-HEADERS"><span class="toc-article-text">NT 头 (IMAGE_NT_HEADERS)</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%96%87%E4%BB%B6%E5%A4%B4-IMAGE-FILE-HEADER"><span class="toc-article-text">文件头 (IMAGE_FILE_HEADER)</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%8F%AF%E9%80%89%E5%A4%B4%E9%83%A8-IMAGE-OPTIONAL-HEADER"><span class="toc-article-text">可选头部 (IMAGE_OPTIONAL_HEADER)</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95-Data-Directory"><span class="toc-article-text">数据目录 Data Directory</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-5"><a class="toc-article-link" href="#%E5%AF%BC%E5%87%BA%E7%9B%AE%E5%BD%95-Export-Directory"><span class="toc-article-text">导出目录 Export Directory</span></a></li><li class="toc-article-item toc-article-level-5"><a class="toc-article-link" href="#%E5%AF%BC%E5%85%A5%E5%9C%B0%E5%9D%80%E8%A1%A8-Import-Address-Table"><span class="toc-article-text">导入地址表 Import Address Table</span></a></li></ol></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#PE-Sections"><span class="toc-article-text">PE Sections</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E5%85%B6%E5%AE%83%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-article-text">其它参考资料</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-article-text">总结</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2025 X1NRI's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
